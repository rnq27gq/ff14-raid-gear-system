<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://api.github.com https://github.com; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';">
    <title>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ  (GitHubé€£æºç‰ˆ)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        /* GitHubé€£æºç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .github-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 10px 20px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .github-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .connection-indicator.online {
            background-color: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        
        .connection-indicator.offline {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-input {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            width: 200px;
        }
        
        .auth-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4a9d6b;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #3e8a57;
        }
        
        .auth-btn.logout {
            background-color: #d86a5a;
        }
        
        .auth-btn.logout:hover {
            background-color: #b85a4a;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tier-item.active {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .tier-item h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .tier-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .player-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        .position-badge {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .job-select {
            width: 100%;
            margin: 5px 0;
        }
        .equipment-policy {
            margin: 10px 0;
        }
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }
        .policy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .policy-item label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .policy-item select {
            width: 100%;
            padding: 6px;
            font-size: 0.8rem;
            margin: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* è£…å‚™æ–¹é‡ã®èƒŒæ™¯è‰² */
        .policy-item select option[value="é›¶å¼"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        
        .policy-item select option[value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        
        .policy-item select[value="é›¶å¼"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        
        .policy-item select[value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .nav-button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        .nav-button:hover {
            background-color: #4a8bb8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        .nav-button.active {
            background-color: #4a9d6b;
        }
        .nav-button.secondary {
            background-color: #95a5a6;
        }
        .nav-button.secondary:hover {
            background-color: #7f8c8d;
        }
        .layer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .layer-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .layer-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .layer-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .layer-content {
            padding: 15px;
        }
        .drop-item {
            background-color: #f8f9fa;
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-size: 0.9rem;
        }
        .allocation-section {
            margin: 20px 0;
        }
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .allocation-card {
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .allocation-header {
            background-color: #3498db;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .allocation-body {
            padding: 15px;
        }
        .need-list, .greed-list, .pass-list {
            margin: 8px 0;
        }
        .need-list h5 {
            color: #e74c3c;
            margin: 5px 0;
            font-size: 0.85rem;
        }
        .greed-list h5 {
            color: #f39c12;
            margin: 5px 0;
            font-size: 0.85rem;
        }
        .pass-list h5 {
            color: #95a5a6;
            margin: 5px 0;
            font-size: 0.85rem;
        }
        .player-list {
            list-style: none;
            padding: 0;
            margin: 5px 0;
        }
        .player-list li {
            background-color: #f8f9fa;
            margin: 2px 0;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .confirm-section {
            background-color: #d5f4e6;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #27ae60;
            margin: 20px 0;
            text-align: center;
        }
        .confirm-button {
            background-color: #4a9d6b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .confirm-button:hover {
            background-color: #3e8a57;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        .history-section {
            margin: 20px 0;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-controls label {
            font-weight: 500;
            color: #2c3e50;
        }
        .filter-controls select {
            width: 150px;
            padding: 8px;
            margin: 0;
        }
        .allocation-history-header {
            display: grid;
            grid-template-columns: 1fr 0.8fr 2fr 1fr 1.5fr 1fr;
            gap: 10px;
            padding: 12px 15px;
            background-color: #3498db;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 6px 6px 0 0;
        }
        .allocation-history-row {
            display: grid;
            grid-template-columns: 1fr 0.8fr 2fr 1fr 1.5fr 1fr;
            gap: 10px;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
            background-color: #ffffff;
        }
        .allocation-history-row:nth-child(even) {
            background-color: #f8f9fa;
        }
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1rem;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3498db;
            margin: 5px 0;
        }
        .export-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .export-button {
            background-color: #8e7cc3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
            transition: all 0.2s ease;
        }
        .export-button:hover {
            background-color: #7a6bb0;
            transform: translateY(-1px);
        }
        .hidden {
            display: none;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .github-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .auth-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .auth-input {
                width: 100%;
            }
            
            .player-grid {
                grid-template-columns: 1fr;
            }
            
            .layer-section {
                grid-template-columns: 1fr;
            }
            
            .allocation-grid {
                grid-template-columns: 1fr;
            }
            
            .allocation-history-header,
            .allocation-history-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-controls select {
                width: 100%;
            }
            
            .navigation {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <!-- GitHubé€£æºãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="github-header">
        <div class="github-status">
            <h2 style="margin: 0; font-size: 1.2rem;">FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h2>
            <div class="connection-indicator" id="connection-status">
                <span>ğŸ”„</span> æ¥ç¶šç¢ºèªä¸­...
            </div>
        </div>
        <div class="auth-controls" id="auth-controls">
            <input type="password" class="auth-input" id="github-token" placeholder="GitHub Personal Access Token" style="display: none;">
            <button class="auth-btn" id="auth-button" onclick="toggleAuth()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>

    <div class="container">
        <div id="content">
            <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentRaidTier = null;
        let allocationResults = [];
        let currentDropItems = [];
        let isOnlineMode = false;
        let githubToken = null;
        let userInfo = null;

        // GitHub APIè¨­å®š
        const GITHUB_OWNER = 'rnq27gq';
        const GITHUB_REPO = 'ff14-raid-gear-system';
        const GITHUB_API_BASE = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
        });

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        async function initializeApp() {
            updateConnectionStatus('connecting');
            
            // ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                githubToken = savedToken;
                const isValid = await validateGitHubToken();
                if (isValid) {
                    isOnlineMode = true;
                    await getUserInfo();
                    updateAuthUI(true);
                    updateConnectionStatus('online');
                } else {
                    localStorage.removeItem('github_token');
                    githubToken = null;
                    updateConnectionStatus('offline');
                }
            } else {
                updateConnectionStatus('offline');
            }
            
            // ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
            showRaidTierSelection();
        }

        // GitHubèªè¨¼ãƒˆã‚°ãƒ«
        async function toggleAuth() {
            if (githubToken) {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                await logout();
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³
                await login();
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function login() {
            const tokenInput = document.getElementById('github-token');
            const token = tokenInput.value.trim();
            
            if (!token) {
                tokenInput.style.display = 'inline-block';
                tokenInput.focus();
                return;
            }
            
            githubToken = token;
            const isValid = await validateGitHubToken();
            
            if (isValid) {
                localStorage.setItem('github_token', token);
                isOnlineMode = true;
                await getUserInfo();
                updateAuthUI(true);
                updateConnectionStatus('online');
                tokenInput.style.display = 'none';
                tokenInput.value = '';
                
                // ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚’è©¦è¡Œ
                await syncData();
            } else {
                alert('ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚æ­£ã—ã„GitHub Personal Access Tokenã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                githubToken = null;
                tokenInput.value = '';
                tokenInput.focus();
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        async function logout() {
            githubToken = null;
            userInfo = null;
            isOnlineMode = false;
            localStorage.removeItem('github_token');
            updateAuthUI(false);
            updateConnectionStatus('offline');
        }

        // GitHub ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
        async function validateGitHubToken() {
            if (!githubToken) return false;
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                return response.ok;
            } catch (error) {
                console.warn('GitHub APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
        async function getUserInfo() {
            if (!githubToken) return null;
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    userInfo = await response.json();
                    return userInfo;
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
            return null;
        }

        // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncData() {
            if (!isOnlineMode || !githubToken) return false;
            
            try {
                // GitHub ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const remoteData = await getDataFromGitHub();
                const localData = getData();
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ï¼ˆç°¡å˜ãªå®Ÿè£…ï¼‰
                if (remoteData) {
                    const mergedData = mergeData(localData, remoteData);
                    saveData(mergedData);
                    return true;
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
            }
            return false;
        }

        // GitHub ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function getDataFromGitHub() {
            if (!githubToken) return null;
            
            try {
                const response = await fetch(`${GITHUB_API_BASE}/data/ff14_raid_data.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return JSON.parse(atob(data.content));
                } else if (response.status === 404) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
                    return null;
                }
            } catch (error) {
                console.error('GitHub ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
            return null;
        }

        // GitHub ã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveDataToGitHub(data) {
            if (!githubToken) return false;
            
            try {
                // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAã‚’å–å¾—
                let sha = null;
                try {
                    const existingResponse = await fetch(`${GITHUB_API_BASE}/data/ff14_raid_data.json`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (existingResponse.ok) {
                        const existing = await existingResponse.json();
                        sha = existing.sha;
                    }
                } catch (e) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const content = btoa(JSON.stringify(data, null, 2));
                const body = {
                    message: `è£…å‚™åˆ†é…ãƒ‡ãƒ¼ã‚¿æ›´æ–° - ${new Date().toISOString()}`,
                    content: content
                };
                
                if (sha) {
                    body.sha = sha;
                }
                
                const response = await fetch(`${GITHUB_API_BASE}/data/ff14_raid_data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                return response.ok;
            } catch (error) {
                console.error('GitHub ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ï¼ˆç°¡å˜ãªå®Ÿè£…ï¼‰
        function mergeData(localData, remoteData) {
            // ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®æ–°ã—ã„å¤‰æ›´ãŒã‚ã‚Œã°è¿½åŠ 
            const merged = { ...remoteData };
            
            // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®ãƒãƒ¼ã‚¸
            if (localData.raidTiers) {
                merged.raidTiers = merged.raidTiers || [];
                localData.raidTiers.forEach(localTier => {
                    if (!merged.raidTiers.find(tier => tier.id === localTier.id)) {
                        merged.raidTiers.push(localTier);
                    }
                });
            }
            
            return merged;
        }

        // UIæ›´æ–°é–¢æ•°
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connection-status');
            
            switch (status) {
                case 'connecting':
                    indicator.className = 'connection-indicator';
                    indicator.innerHTML = '<span>ğŸ”„</span> æ¥ç¶šç¢ºèªä¸­...';
                    break;
                case 'online':
                    indicator.className = 'connection-indicator online';
                    indicator.innerHTML = '<span>ğŸŸ¢</span> ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ (GitHubé€£æº)';
                    break;
                case 'offline':
                    indicator.className = 'connection-indicator offline';
                    indicator.innerHTML = '<span>ğŸ”´</span> ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ (ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿)';
                    break;
            }
        }

        function updateAuthUI(isLoggedIn) {
            const authButton = document.getElementById('auth-button');
            const tokenInput = document.getElementById('github-token');
            
            if (isLoggedIn) {
                authButton.textContent = userInfo ? `${userInfo.login} (ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ)` : 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
                authButton.className = 'auth-btn logout';
                tokenInput.style.display = 'none';
            } else {
                authButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
                authButton.className = 'auth-btn';
                tokenInput.style.display = 'none';
            }
        }

        // ===== ä»¥ä¸‹ã€working_index.htmlã®æ©Ÿèƒ½ã‚’ãã®ã¾ã¾ç§»æ¤ =====
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é–¢æ•°
        function getData() {
            const data = localStorage.getItem('ff14RaidData');
            return data ? JSON.parse(data) : {
                raidTiers: [],
                activeRaidTierId: null,
                players: {},
                allocations: {}
            };
        }

        function saveData(data) {
            localStorage.setItem('ff14RaidData', JSON.stringify(data));
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯GitHubã«ã‚‚ä¿å­˜
            if (isOnlineMode) {
                saveDataToGitHub(data).catch(error => {
                    console.warn('GitHubåŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                });
            }
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠç”»é¢
        function showRaidTierSelection() {
            const data = getData();
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                
                <div class="section">
                    <h2>ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠãƒ»ç™»éŒ²</h2>
                    <p>æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                    
                    ${data.raidTiers.length > 0 ? `
                        <h3>æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢</h3>
                        <div class="tier-list">
                            ${data.raidTiers.map(tier => `
                                <div class="tier-item ${tier.id === data.activeRaidTierId ? 'active' : ''}" 
                                     onclick="selectRaidTier('${tier.id}')">
                                    <h3>${tier.name}</h3>
                                    <p>${tier.description || ''}</p>
                                    <p style="font-size: 0.8rem; color: #666;">
                                        ä½œæˆæ—¥: ${new Date(tier.createdAt).toLocaleDateString('ja-JP')}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>ã¾ã ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>'}
                    
                    <h3>æ–°è¦ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ç™»éŒ²</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="tier-name" placeholder="ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢å (ä¾‹: 7.2é›¶å¼)" 
                               style="width: 250px;">
                        <input type="text" id="tier-description" placeholder="èª¬æ˜ (ä»»æ„)" 
                               style="width: 300px;">
                        <button onclick="createRaidTier()">ç™»éŒ²</button>
                    </div>
                </div>
                
                ${data.raidTiers.length > 0 ? `
                    <div class="section">
                        <h2>ãƒ†ã‚¹ãƒˆãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="generateTestData()" class="export-button">
                                ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                            </button>
                            <button onclick="exportData()" class="export-button">
                                ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <input type="file" id="import-file" accept=".json" style="display: none;" 
                                   onchange="importData(event)">
                            <button onclick="document.getElementById('import-file').click()" class="export-button">
                                ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä½œæˆ
        function createRaidTier() {
            const nameInput = document.getElementById('tier-name');
            const descInput = document.getElementById('tier-description');
            
            const name = nameInput.value.trim();
            const description = descInput.value.trim();
            
            if (!name) {
                alert('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                nameInput.focus();
                return;
            }
            
            const newTier = {
                id: 'tier_' + Date.now(),
                name: name,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            const data = getData();
            if (!data.raidTiers) data.raidTiers = [];
            data.raidTiers.push(newTier);
            data.activeRaidTierId = newTier.id;
            
            saveData(data);
            currentRaidTier = newTier;
            
            showPlayerSetup();
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ
        function selectRaidTier(tierId) {
            const data = getData();
            const tier = data.raidTiers.find(t => t.id === tierId);
            
            if (tier) {
                data.activeRaidTierId = tierId;
                saveData(data);
                currentRaidTier = tier;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (data.players && data.players[tierId] && Object.keys(data.players[tierId]).length > 0) {
                    showMainDashboard();
                } else {
                    showPlayerSetup();
                }
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šç”»é¢
        function showPlayerSetup() {
            const data = getData();
            const players = (data.players && data.players[currentRaidTier.id]) || {};
            
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const jobsByRole = {
                'MT': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                'ST': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                'H1': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…'],
                'H2': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…'],
                'D1': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                'D2': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                'D3': ['é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼', 'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­'],
                'D4': ['é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼', 'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­']
            };
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <h1>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ã‚¸ãƒ§ãƒ–è¨­å®š</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>8äººã®ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position] || {};
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${position}</span>
                                        <span class="position-badge">${position}</span>
                                    </div>
                                    <div>
                                        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                                        <input type="text" id="${position}-name" value="${player.name || ''}" 
                                               placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:</label>
                                        <input type="text" id="${position}-character" value="${player.characterName || ''}" 
                                               placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label>æ‹…å½“ã‚¸ãƒ§ãƒ–:</label>
                                        <select id="${position}-job" class="job-select">
                                            <option value="">ã‚¸ãƒ§ãƒ–ã‚’é¸æŠ</option>
                                            ${jobsByRole[position].map(job => 
                                                `<option value="${job}" ${player.job === job ? 'selected' : ''}>${job}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button secondary" onclick="showRaidTierSelection()">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠã«æˆ»ã‚‹</button>
                        <button class="nav-button" onclick="savePlayersAndContinue()">ä¿å­˜ã—ã¦æ¬¡ã¸</button>
                    </div>
                </div>
            `;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ä¿å­˜
        function savePlayersAndContinue() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const data = getData();
            
            if (!data.players) data.players = {};
            if (!data.players[currentRaidTier.id]) data.players[currentRaidTier.id] = {};
            
            for (const position of positions) {
                const name = document.getElementById(`${position}-name`).value.trim();
                const characterName = document.getElementById(`${position}-character`).value.trim();
                const job = document.getElementById(`${position}-job`).value;
                
                if (!name || !characterName || !job) {
                    alert(`${position}ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                data.players[currentRaidTier.id][position] = {
                    name: name,
                    characterName: characterName,
                    job: job,
                    position: position,
                    equipmentPolicy: {},
                    weaponWishes: [],
                    currentEquipment: {}
                };
            }
            
            saveData(data);
            showEquipmentPolicySetup();
        }

        // è£…å‚™æ–¹é‡è¨­å®šç”»é¢
        function showEquipmentPolicySetup() {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <h1>è£…å‚™æ–¹é‡è¨­å®š</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>å„éƒ¨ä½ã®è£…å‚™æ–¹é‡ã‚’è¨­å®šã—ã¦ãã ã•ã„</h3>
                    <p>é›¶å¼è£…å‚™: ãƒ¬ã‚¤ãƒ‰ã§ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹è£…å‚™ã‚’ç‹™ã† | ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³è£…å‚™: ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã§äº¤æ›å¯èƒ½ãªè£…å‚™ã‚’ä½¿ç”¨</p>
                    
                    <div class="player-grid">
                        ${Object.entries(players).map(([position, player]) => `
                            <div class="player-card">
                                <div class="player-header">
                                    <span class="player-name">${player.name} (${player.characterName})</span>
                                    <span class="position-badge">${position} - ${player.job}</span>
                                </div>
                                <div class="equipment-policy">
                                    <div class="policy-grid">
                                        ${slots.map(slot => `
                                            <div class="policy-item">
                                                <label>${slot}</label>
                                                <select id="${position}-${slot}-policy">
                                                    <option value="é›¶å¼" ${(player.equipmentPolicy[slot] === 'é›¶å¼') ? 'selected' : ''}>é›¶å¼</option>
                                                    <option value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³" ${(player.equipmentPolicy[slot] === 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³') ? 'selected' : ''}>ãƒˆãƒ¼ãƒ </option>
                                                </select>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button secondary" onclick="showPlayerSetup()">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šã«æˆ»ã‚‹</button>
                        <button class="nav-button" onclick="saveEquipmentPolicyAndContinue()">ä¿å­˜ã—ã¦å®Œäº†</button>
                    </div>
                </div>
            `;
        }

        // è£…å‚™æ–¹é‡ä¿å­˜
        function saveEquipmentPolicyAndContinue() {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
            
            for (const [position, player] of Object.entries(players)) {
                for (const slot of slots) {
                    const policy = document.getElementById(`${position}-${slot}-policy`).value;
                    player.equipmentPolicy[slot] = policy;
                }
            }
            
            saveData(data);
            showMainDashboard();
        }

        // ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        function showMainDashboard() {
            const data = getData();
            const players = data.players[currentRaidTier.id] || {};
            const allocations = data.allocations[currentRaidTier.id] || [];
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <h1>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                <h2>${currentRaidTier.name} - ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                
                <div class="navigation">
                    <button class="nav-button" onclick="showPlayerSetup()">ãƒ¡ãƒ³ãƒãƒ¼ãƒ»è£…å‚™è¨­å®š</button>
                    <button class="nav-button secondary" onclick="showRaidTierSelection()">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ</button>
                </div>
                
                <div class="section">
                    <h3>ãƒ¬ã‚¤ãƒ‰ã‚¯ãƒªã‚¢ - å±¤é¸æŠ</h3>
                    <div class="layer-section">
                        ${[1, 2, 3, 4].map(layer => `
                            <div class="layer-card">
                                <div class="layer-header">${layer}å±¤ã‚¯ãƒªã‚¢</div>
                                <div class="layer-content">
                                    <div class="drop-item">å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—è£…å‚™ã®åˆ†é…å‡¦ç†</div>
                                    <button onclick="processLayerAllocation(${layer})" style="width: 100%; margin-top: 10px;">
                                        ${layer}å±¤ è£…å‚™åˆ†é…é–‹å§‹
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ³</h3>
                    <div class="player-grid">
                        ${Object.entries(players).map(([position, player]) => `
                            <div class="player-card">
                                <div class="player-header">
                                    <span class="player-name">${player.name}</span>
                                    <span class="position-badge">${position}</span>
                                </div>
                                <p><strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</strong> ${player.characterName}</p>
                                <p><strong>ã‚¸ãƒ§ãƒ–:</strong> ${player.job}</p>
                                <p><strong>è£…å‚™å–å¾—æ•°:</strong> ${allocations.filter(a => a.winner && a.winner.position === position).length}å€‹</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="showAllocationHistory()" class="nav-button">é…å¸ƒå±¥æ­´ç¢ºèª</button>
                        <button onclick="showStatistics()" class="nav-button">çµ±è¨ˆæƒ…å ±</button>
                        <button onclick="generateTestData()" class="export-button">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                        <button onclick="exportData()" class="export-button">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    </div>
                </div>
            `;
        }

        // å±¤åˆ¥è£…å‚™åˆ†é…å‡¦ç†
        function processLayerAllocation(layer) {
            generateLayerDropsAndProcess(layer);
        }

        // å±¤åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ç”Ÿæˆã¨åˆ†é…å‡¦ç†
        function generateLayerDropsAndProcess(layer) {
            try {
                const layerDrops = {
                    1: [
                        { slot: 'è€³', name: 'è€³ - ã‚¤ãƒ¤ãƒªãƒ³ã‚°ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' },
                        { slot: 'é¦–', name: 'é¦– - ãƒãƒƒã‚¯ãƒ¬ã‚¹ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' },
                        { slot: 'è…•', name: 'è…• - ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' },
                        { slot: 'æŒ‡', name: 'æŒ‡ - ãƒªãƒ³ã‚°ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' }
                    ],
                    2: [
                        { slot: 'é ­', name: 'é ­ - ãƒ˜ãƒƒãƒ‰ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'æ‰‹', name: 'æ‰‹ - ãƒãƒ³ãƒ‰ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'è¶³', name: 'è¶³ - ãƒ•ãƒƒãƒˆã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'æ­¦å™¨çŸ³', name: 'æ­¦å™¨çŸ³', itemLevel: 1, type: 'material' },
                        { slot: 'ç¡¬åŒ–è–¬', name: 'ç¡¬åŒ–è–¬', itemLevel: 1, type: 'material' }
                    ],
                    3: [
                        { slot: 'èƒ´', name: 'èƒ´ - ãƒœãƒ‡ã‚£ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'è„š', name: 'è„š - ãƒ¬ãƒƒã‚°ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'å¼·åŒ–è–¬', name: 'å¼·åŒ–è–¬', itemLevel: 1, type: 'material' },
                        { slot: 'å¼·åŒ–ç¹Šç¶­', name: 'å¼·åŒ–ç¹Šç¶­', itemLevel: 1, type: 'material' }
                    ],
                    4: [
                        { slot: 'èƒ´', name: 'èƒ´ - ãƒœãƒ‡ã‚£ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'æ­¦å™¨', name: 'æ­¦å™¨ - ã‚¦ã‚§ãƒãƒ³ãƒã‚§ã‚¹ãƒˆ', itemLevel: 735, type: 'weapon_box' },
                        { slot: 'ãƒã‚¦ãƒ³ãƒˆ', name: 'ãƒã‚¦ãƒ³ãƒˆ', itemLevel: 1, type: 'mount' }
                    ]
                };
                
                currentDropItems = layerDrops[layer] || [];
                displayAllocationResults(layer);
                
            } catch (error) {
                console.error('ãƒ‰ãƒ­ãƒƒãƒ—ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // åˆ†é…çµæœè¡¨ç¤º
        function displayAllocationResults(layer) {
            const data = getData();
            const players = data.players[currentRaidTier.id] || {};
            
            // Need/Greed/Pass åˆ¤å®š
            allocationResults = currentDropItems.map(item => {
                const needPlayers = [];
                const greedPlayers = [];
                const passPlayers = [];
                
                Object.entries(players).forEach(([position, player]) => {
                    const policy = player.equipmentPolicy[item.slot];
                    
                    if (policy === 'é›¶å¼') {
                        needPlayers.push({
                            position: position,
                            name: player.name,
                            job: player.job,
                            priority: getPriority(player.job)
                        });
                    } else if (policy === 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³' && item.type !== 'material' && item.type !== 'mount') {
                        greedPlayers.push({
                            position: position,
                            name: player.name,
                            job: player.job,
                            priority: getPriority(player.job)
                        });
                    } else {
                        passPlayers.push({
                            position: position,
                            name: player.name,
                            job: player.job
                        });
                    }
                });
                
                // å„ªå…ˆé †ä½ã§ã‚½ãƒ¼ãƒˆ
                needPlayers.sort((a, b) => a.priority - b.priority);
                greedPlayers.sort((a, b) => a.priority - b.priority);
                
                return {
                    equipment: item,
                    need: needPlayers,
                    greed: greedPlayers,
                    pass: passPlayers,
                    winner: needPlayers.length > 0 ? needPlayers[0] : 
                            (greedPlayers.length > 0 ? greedPlayers[0] : null)
                };
            });
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <h1>${layer}å±¤ è£…å‚™åˆ†é…çµæœ</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="allocation-section">
                    <div class="allocation-grid">
                        ${allocationResults.map((result, index) => `
                            <div class="allocation-card">
                                <div class="allocation-header">
                                    ${result.equipment.name}
                                </div>
                                <div class="allocation-body">
                                    <div class="need-list">
                                        <h5>Need (${result.need.length}äºº)</h5>
                                        <ul class="player-list">
                                            ${result.need.map((player, i) => `
                                                <li style="${i === 0 ? 'background-color: #ffe6e6; font-weight: bold;' : ''}">
                                                    ${player.name} (${player.position} - ${player.job})
                                                    ${i === 0 ? ' ğŸ†' : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    
                                    <div class="greed-list">
                                        <h5>Greed (${result.greed.length}äºº)</h5>
                                        <ul class="player-list">
                                            ${result.greed.map(player => `
                                                <li>${player.name} (${player.position} - ${player.job})</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    
                                    <div class="pass-list">
                                        <h5>Pass (${result.pass.length}äºº)</h5>
                                        <ul class="player-list">
                                            ${result.pass.map(player => `
                                                <li>${player.name} (${player.position} - ${player.job})</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="confirm-section">
                        <h3>åˆ†é…ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ</h3>
                        <p>ä¸Šè¨˜ã®åˆ†é…çµæœã§ã‚ˆã‚ã—ã‘ã‚Œã°ç¢ºå®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                        <button class="confirm-button" onclick="confirmAllocation(${layer})">
                            åˆ†é…ç¢ºå®š
                        </button>
                        <button class="nav-button secondary" onclick="showMainDashboard()" style="margin-left: 15px;">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            `;
        }

        // åˆ†é…ç¢ºå®š
        function confirmAllocation(layer) {
            const data = getData();
            
            if (!data.allocations) data.allocations = {};
            if (!data.allocations[currentRaidTier.id]) data.allocations[currentRaidTier.id] = [];
            
            const currentWeek = getCurrentWeekString();
            
            allocationResults.forEach(result => {
                if (result.winner) {
                    data.allocations[currentRaidTier.id].push({
                        id: 'alloc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        layer: layer,
                        equipment: result.equipment,
                        winner: result.winner,
                        timestamp: new Date().toISOString(),
                        week: currentWeek,
                        allNeedPlayers: result.need,
                        allGreedPlayers: result.greed
                    });
                }
            });
            
            saveData(data);
            
            alert(`${layer}å±¤ã®è£…å‚™åˆ†é…ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`);
            showMainDashboard();
        }

        // é…å¸ƒå±¥æ­´è¡¨ç¤º
        function showAllocationHistory() {
            const data = getData();
            const allocations = data.allocations[currentRaidTier.id] || [];
            
            const content = document.getElementById('content');
            
            if (allocations.length === 0) {
                content.innerHTML = `
                    <h1>é…å¸ƒå±¥æ­´</h1>
                    <h2>${currentRaidTier.name}</h2>
                    
                    <div class="section">
                        <h3>é…å¸ƒå±¥æ­´</h3>
                        <p>ã¾ã è£…å‚™ã®é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        <p>ãƒ¬ã‚¤ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¦è£…å‚™ã‚’åˆ†é…ã™ã‚‹ã¨ã€ã“ã“ã«å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                        
                        <div class="navigation">
                            <button class="nav-button" onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // å±¥æ­´ã‚’æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            content.innerHTML = `
                <h1>é…å¸ƒå±¥æ­´</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        <button class="export-button" onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    </div>
                    
                    <div class="allocation-history-header">
                        <span>æ—¥ä»˜</span>
                        <span>å±¤</span>
                        <span>ã‚¢ã‚¤ãƒ†ãƒ </span>
                        <span>éƒ¨ä½</span>
                        <span>å–å¾—è€…</span>
                        <span>é€±</span>
                    </div>
                    ${sortedAllocations.map(allocation => {
                        const timestamp = new Date(allocation.timestamp);
                        const formattedDate = timestamp.toLocaleDateString('ja-JP');
                        const winnerText = allocation.winner ? 
                            `${allocation.winner.name} (${allocation.winner.position})` : 
                            'ãªã—';
                        
                        return `
                            <div class="allocation-history-row">
                                <span>${formattedDate}</span>
                                <span>${allocation.layer}å±¤</span>
                                <span>${allocation.equipment.name}</span>
                                <span>${allocation.equipment.slot}</span>
                                <span>${winnerText}</span>
                                <span>${allocation.week || 'ä¸æ˜'}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        function showStatistics() {
            const data = getData();
            const players = data.players[currentRaidTier.id] || {};
            const allocations = data.allocations[currentRaidTier.id] || [];
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥çµ±è¨ˆ
            const playerStats = {};
            Object.keys(players).forEach(position => {
                playerStats[position] = {
                    player: players[position],
                    totalItems: 0,
                    itemsByLayer: { 1: 0, 2: 0, 3: 0, 4: 0 },
                    itemsByType: {}
                };
            });
            
            allocations.forEach(allocation => {
                if (allocation.winner) {
                    const position = allocation.winner.position;
                    if (playerStats[position]) {
                        playerStats[position].totalItems++;
                        playerStats[position].itemsByLayer[allocation.layer]++;
                        
                        const type = allocation.equipment.type || 'other';
                        playerStats[position].itemsByType[type] = 
                            (playerStats[position].itemsByType[type] || 0) + 1;
                    }
                }
            });
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <h1>çµ±è¨ˆæƒ…å ±</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        <button class="nav-button" onclick="showAllocationHistory()">é…å¸ƒå±¥æ­´</button>
                    </div>
                    
                    <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥è£…å‚™å–å¾—çµ±è¨ˆ</h3>
                    <div class="statistics-grid">
                        ${Object.entries(playerStats).map(([position, stats]) => `
                            <div class="stat-card">
                                <h4>${stats.player.name} (${position})</h4>
                                <p><strong>ã‚¸ãƒ§ãƒ–:</strong> ${stats.player.job}</p>
                                <div class="stat-value">${stats.totalItems}å€‹</div>
                                <p>ç·è£…å‚™å–å¾—æ•°</p>
                                <div style="font-size: 0.8rem; margin-top: 10px;">
                                    <div>1å±¤: ${stats.itemsByLayer[1]}å€‹</div>
                                    <div>2å±¤: ${stats.itemsByLayer[2]}å€‹</div>
                                    <div>3å±¤: ${stats.itemsByLayer[3]}å€‹</div>
                                    <div>4å±¤: ${stats.itemsByLayer[4]}å€‹</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h3>å…¨ä½“çµ±è¨ˆ</h3>
                    <div class="statistics-grid">
                        <div class="stat-card">
                            <h4>ç·åˆ†é…æ•°</h4>
                            <div class="stat-value">${allocations.length}</div>
                            <p>ã‚¢ã‚¤ãƒ†ãƒ </p>
                        </div>
                        <div class="stat-card">
                            <h4>æœ€å¤šå–å¾—è€…</h4>
                            <div class="stat-value">
                                ${Object.values(playerStats).reduce((max, stats) => 
                                    stats.totalItems > max.totalItems ? stats : max, 
                                    { totalItems: 0, player: { name: '-' } }
                                ).player.name}
                            </div>
                            <p>
                                ${Math.max(...Object.values(playerStats).map(s => s.totalItems))}å€‹
                            </p>
                        </div>
                        <div class="stat-card">
                            <h4>å±¤åˆ¥åˆ†é…æ•°</h4>
                            <div style="font-size: 0.9rem;">
                                ${[1,2,3,4].map(layer => {
                                    const count = allocations.filter(a => a.layer === layer).length;
                                    return `<div>${layer}å±¤: ${count}å€‹</div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getPriority(job) {
            const priorities = {
                'ãƒ¢ãƒ³ã‚¯': 1, 'ç«œé¨å£«': 1, 'å¿è€…': 1, 'ä¾': 1, 'ãƒªãƒ¼ãƒ‘ãƒ¼': 1, 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼': 1,
                'é»’é­”é“å£«': 2, 'å¬å–šå£«': 2, 'èµ¤é­”é“å£«': 2, 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼': 2,
                'åŸéŠè©©äºº': 2, 'æ©Ÿå·¥å£«': 2, 'è¸Šã‚Šå­': 2,
                'ãƒŠã‚¤ãƒˆ': 3, 'æˆ¦å£«': 3, 'æš—é»’é¨å£«': 3, 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼': 3,
                'ç™½é­”é“å£«': 4, 'å æ˜Ÿè¡“å£«': 4, 'å­¦è€…': 4, 'è³¢è€…': 4
            };
            return priorities[job] || 5;
        }

        function getCurrentWeekString() {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay() + 2); // ç«æ›œæ—¥ã‚’é€±ã®å§‹ã¾ã‚Šã¨ã™ã‚‹
            return startOfWeek.toISOString().split('T')[0];
        }

        // ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•°
        function exportData() {
            try {
                const data = getData();
                const jsonData = JSON.stringify(data, null, 2);
                
                // CSPå¯¾å¿œ: data URIã‚’ä½¿ç”¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(jsonData);
                const a = document.createElement('a');
                a.href = dataUri;
                a.download = `ff14_gear_data_${currentRaidTier ? currentRaidTier.name : 'backup'}_${new Date().toISOString().split('T')[0]}.json`;
                
                // ä¸€æ™‚çš„ã«DOMã«è¿½åŠ ã—ã¦ã‚¯ãƒªãƒƒã‚¯
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
            } catch (error) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                        saveData(importedData);
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
                        location.reload();
                    }
                } catch (error) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function generateTestData() {
            if (confirm('ãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                const testTier = {
                    id: 'test_' + Date.now(),
                    name: 'ãƒ†ã‚¹ãƒˆç”¨7.2é›¶å¼',
                    description: 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä»˜ããƒ†ã‚¹ãƒˆç’°å¢ƒ',
                    createdAt: new Date().toISOString()
                };
                
                const data = getData();
                if (!data.raidTiers) data.raidTiers = [];
                data.raidTiers.push(testTier);
                data.activeRaidTierId = testTier.id;
                
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿
                if (!data.players) data.players = {};
                data.players[testTier.id] = {
                    MT: { name: 'ãƒ†ã‚¹ãƒˆMT', characterName: 'ã‚µãƒ³ãƒ—ãƒ«ã‚¿ãƒ³ã‚¯', job: 'ãƒŠã‚¤ãƒˆ', position: 'MT', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    ST: { name: 'ãƒ†ã‚¹ãƒˆST', characterName: 'ã‚µãƒ³ãƒ—ãƒ«æˆ¦å£«', job: 'æˆ¦å£«', position: 'ST', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    H1: { name: 'ãƒ†ã‚¹ãƒˆH1', characterName: 'ã‚µãƒ³ãƒ—ãƒ«ç™½', job: 'ç™½é­”é“å£«', position: 'H1', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    H2: { name: 'ãƒ†ã‚¹ãƒˆH2', characterName: 'ã‚µãƒ³ãƒ—ãƒ«å­¦è€…', job: 'å­¦è€…', position: 'H2', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D1: { name: 'ãƒ†ã‚¹ãƒˆD1', characterName: 'ã‚µãƒ³ãƒ—ãƒ«ç«œé¨å£«', job: 'ç«œé¨å£«', position: 'D1', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D2: { name: 'ãƒ†ã‚¹ãƒˆD2', characterName: 'ã‚µãƒ³ãƒ—ãƒ«å¿è€…', job: 'å¿è€…', position: 'D2', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D3: { name: 'ãƒ†ã‚¹ãƒˆD3', characterName: 'ã‚µãƒ³ãƒ—ãƒ«é»’é­”', job: 'é»’é­”é“å£«', position: 'D3', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D4: { name: 'ãƒ†ã‚¹ãƒˆD4', characterName: 'ã‚µãƒ³ãƒ—ãƒ«è©©äºº', job: 'åŸéŠè©©äºº', position: 'D4', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} }
                };
                
                saveData(data);
                currentRaidTier = testTier;
                
                alert('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
                showMainDashboard();
            }
        }
    </script>
</body>
</html>