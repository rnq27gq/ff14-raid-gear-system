<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://*.supabase.co https://supabase.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
    <title>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ  (Supabaseç‰ˆ)</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
        // Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª
        window.addEventListener('load', function() {
            console.log('Supabase library loaded:', typeof window.supabase !== 'undefined');
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase version:', window.supabase.createClient ? 'OK' : 'No createClient method');
            }
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        /* Supabaseèªè¨¼ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .supabase-header {
            background: linear-gradient(135deg, #16a085 0%, #27ae60 100%);
            color: white;
            padding: 10px 20px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px;
            min-width: 120px;
        }
        
        .dashboard-layer-button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .supabase-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .connection-indicator.online {
            background-color: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        
        .connection-indicator.offline {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-input {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .auth-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4a9d6b;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #3e8a57;
        }
        
        .auth-btn.logout {
            background-color: #d86a5a;
        }
        
        .auth-btn.logout:hover {
            background-color: #b85a4a;
        }
        
        /* èªè¨¼ç”»é¢ */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
        }
        
        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-card h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .auth-form button {
            padding: 12px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .auth-form button:hover {
            background-color: #219a52;
        }
        
        .demo-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .main-content {
            display: none;
        }
        
        .main-content.authenticated {
            display: block;
        }
        
        /* æ—¢å­˜ã®collaborative_index.htmlã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±åˆ */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .player-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        .position-badge {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .job-select {
            width: 100%;
            margin: 5px 0;
        }
        .equipment-policy {
            margin: 10px 0;
        }
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }
        .policy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .policy-item label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .policy-item select {
            width: 100%;
            padding: 6px;
            font-size: 0.8rem;
            margin: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* è£…å‚™æ–¹é‡ã®èƒŒæ™¯è‰² */
        .policy-item select option[value="é›¶å¼"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select option[value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        .policy-item select[value="é›¶å¼"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select[value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        
        /* ã‚¿ãƒ–é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-container {
            margin: 20px 0;
        }
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }
        .tab-content {
            min-height: 400px;
        }
        
        /* å±¤é¸æŠé–¢é€£ */
        .layer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .layer-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .layer-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .layer-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-align: center;
        }
        .layer-content {
            padding: 15px;
        }
        
        /* å„ªå…ˆåº¦è¨­å®šé–¢é€£ */
        .priority-container {
            max-width: 600px;
            margin: 20px auto;
        }
        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .priority-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s ease;
        }
        .priority-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .priority-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .priority-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .position-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .player-details {
            font-size: 0.9rem;
            color: #666;
        }
        .drag-handle {
            color: #999;
            font-size: 20px;
            cursor: move;
        }
        
        /* æ­¦å™¨å¸Œæœ›é–¢é€£ */
        .weapon-wishes {
            margin: 10px 0;
        }
        .wish-priority {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wish-priority label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #555;
        }
        .wish-priority select,
        .wish-priority input {
            flex: 1;
            min-width: 150px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tier-item.active {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .tier-item h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .tier-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .dashboard-layer-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }
        
        /* çµ±è¨ˆæƒ…å ±ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .player-stats-table {
            display: grid;
            grid-template-columns: 150px repeat(14, 1fr);
            gap: 1px;
            background-color: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .stats-header {
            display: contents;
        }
        
        .stats-header > div {
            background-color: #4a9d6b;
            color: white;
            padding: 10px 5px;
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .stats-row {
            display: contents;
        }
        
        .player-name-col {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            border-right: 2px solid #dee2e6;
        }
        
        .slot-col {
            background-color: white;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .slot-col.acquired {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .slot-col.not-acquired {
            background-color: #f8d7da;
            color: #721c24;
        }
        .nav-button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background-color: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        /* ãƒ‡ãƒ¼ã‚¿ç§»è¡Œé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .migration-section {
            transition: all 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .migration-section:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .file-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-input-container input[type="file"] {
            transition: border-color 0.3s ease;
        }
        
        .file-input-container input[type="file"]:hover {
            border-color: #2980b9;
        }
        
        .csv-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }
        
        .csv-input-section {
            display: flex;
            flex-direction: column;
        }
        
        .csv-help-section {
            min-width: 200px;
        }
        
        .reset-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .reset-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .reset-warning {
            background-color: #fee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }
        
        .hints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .hint-card {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.2s ease;
        }
        
        .hint-card:hover {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        /* è£…å‚™åˆ†é…é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .layer-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .layer-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        .layer-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .layer-stats {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .allocation-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .allocation-choice {
            margin: 15px 0;
        }
        
        .allocation-choice select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .candidates-detail {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .candidate-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .no-candidates {
            color: #666;
            font-style: italic;
        }
        
        .weapon-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .weapon-selection h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .weapon-selection select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        .predicted-winner {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .judgment-details {
            margin-top: 15px;
        }
        
        .judgment-toggle {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .judgment-toggle:hover {
            background: #e9ecef;
        }
        
        .judgment-content {
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .need-section, .greed-section, .pass-section {
            margin: 10px 0;
        }
        
        .need-section h6 {
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .greed-section h6 {
            color: #f39c12;
            margin-bottom: 8px;
        }
        
        .pass-section h6 {
            color: #95a5a6;
            margin-bottom: 8px;
        }
        
        .candidate-item.need {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.greed {
            background: #fef9e7;
            border-left: 4px solid #f39c12;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.pass {
            background: #f8f9fa;
            border-left: 4px solid #95a5a6;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            color: #666;
        }
        
        .allocation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .confirm-btn {
            background: #27ae60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .confirm-btn:hover {
            background: #2ecc71;
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        /* çµ±è¨ˆé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .stat-details {
            margin-top: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slot-stats, .week-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .slot-stat-item, .week-stat-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .slot-name, .week-number {
            width: 100px;
            font-weight: 600;
        }
        
        .slot-count, .week-count {
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        
        .slot-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .slot-progress {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3498db;
            margin-top: 10px;
        }
        
        /* å±¥æ­´é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-group select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .clear-filters-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .clear-filters-btn:hover {
            background: #c0392b;
        }
        
        .history-table {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .history-header {
            background: #3498db;
            color: white;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
        }
        
        .history-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-row:hover {
            background: #e8f4fd;
        }
        
        .history-cell {
            padding: 10px;
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        @media (max-width: 768px) {
            .csv-container {
                grid-template-columns: 1fr;
            }
            
            .reset-buttons-container {
                grid-template-columns: 1fr;
            }
            
            .file-input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .layer-grid {
                grid-template-columns: 1fr;
            }
            
            .allocation-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .history-header, .history-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .history-cell {
                border-bottom: 1px solid #e9ecef;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Supabaseèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="supabase-header">
            <div class="supabase-status">
                <h1 style="margin: 0; font-size: 18px;">FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ  (Supabaseç‰ˆ)</h1>
                <div id="connectionStatus" class="connection-indicator offline">
                    <span>âš«</span>
                    <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
                </div>
                <div id="teamInfo" style="display: none;">
                    <span id="currentTeamName">ãƒãƒ¼ãƒ å</span>
                </div>
            </div>
            
            <div class="auth-controls" id="authControls">
                <input type="text" id="teamIdInput" class="auth-input" placeholder="ãƒãƒ¼ãƒ ID" maxlength="20">
                <input type="password" id="passwordInput" class="auth-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" maxlength="20">
                <button class="auth-btn" onclick="authenticateTeam()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
            
            <div class="auth-controls" id="loggedInControls" style="display: none;">
                <span id="loggedInTeam">demo-team</span>
                <button class="auth-btn logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
        
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- èªè¨¼ç”»é¢ -->
        <div id="authScreen" class="auth-screen">
            <div class="auth-card">
                <h2>ğŸ›¡ï¸ ãƒãƒ¼ãƒ èªè¨¼</h2>
                <p>8äººã§ã®å…±åŒåˆ©ç”¨ã«ã¯<br>ãƒãƒ¼ãƒ IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
                
                <div class="auth-form">
                    <input type="text" id="mainTeamIdInput" placeholder="ãƒãƒ¼ãƒ ID (ä¾‹: my-raid-team)" maxlength="20">
                    <input type="password" id="mainPasswordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" maxlength="20">
                    <button onclick="authenticateTeam()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
                
                <div class="demo-info">
                    <strong>ğŸ® ãƒ‡ãƒ¢ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong><br>
                    ãƒãƒ¼ãƒ ID: <code>demo-team</code><br>
                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: <code>demo123</code>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p>æ–°ã—ã„ãƒãƒ¼ãƒ ã®ä½œæˆã‚’ã”å¸Œæœ›ã®å ´åˆã¯<br>ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„</p>
                </div>
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰ -->
        <div id="mainContent" class="main-content">
            <div id="content">
                <!-- åˆæœŸè¡¨ç¤ºã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            </div>
        </div>
    </div>

    <!-- Supabaseèªè¨¼æƒ…å ±ï¼ˆGitHub SecretsçµŒç”±ã§æ³¨å…¥ï¼‰ -->
    <script>
        // GitHub Actionsã«ã‚ˆã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«èªè¨¼æƒ…å ±ãŒæ³¨å…¥ã•ã‚Œã¾ã™
        window.SUPABASE_CONFIG = {
            SUPABASE_URL: 'https://bpzvuwhnjvbfohopeoxr.supabase.co',
            SUPABASE_ANON_KEY: null, // GitHub Actionsã§ç½®æ›ã•ã‚Œã‚‹
            DEMO_TEAM_ID: 'demo-team',
            DEMO_PASSWORD: 'demo123'
        };
    </script>
    
    <!-- Supabaseè¨­å®šã¨ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ -->
    <script src="supabase_config.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let isAuthenticated = false;
        let currentTeamId = null;
        
        // åˆæœŸåŒ– - ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
        window.addEventListener('load', async function() {
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
            setTimeout(async () => {
                await initializeApp();
            }, 100);
        });
        
        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        async function initializeApp() {
            try {
                console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
                
                // Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèª
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                console.log('Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªå®Œäº†');
                
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆï¼ˆæ©Ÿå¯†æƒ…å ±ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰
                const supabaseUrl = window.SUPABASE_CONFIG?.SUPABASE_URL;
                const supabaseKey = window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Supabaseèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚GitHub Secretsã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                
                window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆå®Œäº†');
                
                // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
                updateConnectionStatus(true);
                
                // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
                await tryAutoLogin();
                
                console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                updateConnectionStatus(false);
            }
        }
        
        // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
        async function tryAutoLogin() {
            const savedTeamId = localStorage.getItem('ff14_team_id');
            if (savedTeamId) {
                currentTeamId = savedTeamId;
                supabaseConfig.currentTeamId = savedTeamId;
                await showAuthenticatedState();
            }
        }
        
        // ãƒãƒ¼ãƒ èªè¨¼
        async function authenticateTeam() {
            const teamId = document.getElementById('teamIdInput')?.value || 
                          document.getElementById('mainTeamIdInput')?.value;
            const password = document.getElementById('passwordInput')?.value || 
                           document.getElementById('mainPasswordInput')?.value;
            
            if (!teamId || !password) {
                showError('ãƒãƒ¼ãƒ IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                showMessage('èªè¨¼ä¸­...', 'info');
                
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèª
                if (!window.supabaseClient) {
                    throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                console.log('èªè¨¼è©¦è¡Œ:', teamId);
                
                // Supabaseèªè¨¼
                const { data, error } = await window.supabaseClient.rpc('authenticate_team', {
                    p_team_id: teamId,
                    p_password: password
                });
                
                console.log('èªè¨¼çµæœ:', { data, error });
                
                if (error) {
                    throw new Error(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('ãƒãƒ¼ãƒ IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
                
                // èªè¨¼æˆåŠŸ
                currentTeamId = teamId;
                localStorage.setItem('ff14_team_id', teamId);
                
                // ãƒãƒ¼ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
                console.log('ãƒãƒ¼ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šä¸­...');
                const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                    team_id: teamId
                });
                
                if (contextError) {
                    console.error('ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼:', contextError);
                } else {
                    console.log('ãƒãƒ¼ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šå®Œäº†');
                }
                
                await showAuthenticatedState();
                showSuccess('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
                
                // ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®åˆæœŸåŒ–
                await initializeMainFeatures();
                
            } catch (error) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                showError('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // èªè¨¼å¾Œã®çŠ¶æ…‹è¡¨ç¤º
        async function showAuthenticatedState() {
            isAuthenticated = true;
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('authenticated');
            document.getElementById('authControls').style.display = 'none';
            document.getElementById('loggedInControls').style.display = 'flex';
            document.getElementById('loggedInTeam').textContent = currentTeamId;
            
            // ãƒãƒ¼ãƒ æƒ…å ±è¡¨ç¤º
            document.getElementById('teamInfo').style.display = 'block';
            document.getElementById('currentTeamName').textContent = `ãƒãƒ¼ãƒ : ${currentTeamId}`;
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            isAuthenticated = false;
            currentTeamId = null;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
            localStorage.removeItem('ff14_team_id');
            supabaseConfig.currentTeamId = null;
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('authenticated');
            document.getElementById('authControls').style.display = 'flex';
            document.getElementById('loggedInControls').style.display = 'none';
            document.getElementById('teamInfo').style.display = 'none';
            
            // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
            document.getElementById('teamIdInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('mainTeamIdInput').value = '';
            document.getElementById('mainPasswordInput').value = '';
            
            showSuccess('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testDatabaseConnection() {
            if (!isAuthenticated) {
                showError('å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...', 'info');
                
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèª
                if (!window.supabaseClient) {
                    throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ'
                };
                
                console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...');
                
                const { data: saveData, error: saveError } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: 'test-tier',
                        data_type: 'settings',
                        content: testData
                    });
                
                if (saveError) {
                    throw new Error(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError.message}`);
                }
                
                console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                const { data: loadData, error: loadError } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', 'test-tier')
                    .eq('data_type', 'settings');
                
                if (loadError) {
                    throw new Error(`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${loadError.message}`);
                }
                
                console.log('èª­ã¿è¾¼ã¿çµæœ:', loadData);
                
                if (loadData && loadData.length > 0) {
                    showSuccess('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚');
                } else {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                indicator.innerHTML = '<span>ğŸŸ¢</span><span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>';
            } else {
                indicator.className = 'connection-indicator offline';
                indicator.innerHTML = '<span>âš«</span><span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>';
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showMessage(message, type) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => successEl.style.display = 'none', 3000);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå‡¦ç†ã®ã‚¨ãƒ©ãƒ¼:', event.reason);
            showError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
        
        // ======================
        // ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…
        // ======================
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentRaidTier = null;
        let appData = {
            raidTiers: {},
            players: {},
            allocations: {},
            settings: {}
        };
        
        // ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–
        async function initializeMainFeatures() {
            try {
                console.log('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–é–‹å§‹');
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadAllData();
                
                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
                showMainDashboard();
                
                console.log('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å…¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAllData() {
            try {
                // Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const { data: allData, error } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId);
                
                if (error) {
                    throw new Error(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                console.log('èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿:', allData);
                
                // ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã”ã¨ã«åˆ†é¡
                if (allData && allData.length > 0) {
                    allData.forEach(item => {
                        const { tier_id, data_type, content } = item;
                        
                        if (data_type === 'settings') {
                            // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®ç‰¹æ®Šå‡¦ç†
                            if (content.raidTier) {
                                // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãƒ‡ãƒ¼ã‚¿
                                if (!appData.raidTiers) appData.raidTiers = {};
                                appData.raidTiers[tier_id] = content.raidTier;
                            } else {
                                // ãã®ä»–ã®è¨­å®š
                                if (!appData.settings) appData.settings = {};
                                appData.settings = { ...appData.settings, ...content };
                            }
                        } else {
                            // ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—
                            if (!appData[data_type]) {
                                appData[data_type] = {};
                            }
                            appData[data_type][tier_id] = content;
                        }
                    });
                }
                
                console.log('æ•´ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿:', appData);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // åˆæœŸãƒ‡ãƒ¼ã‚¿ã§ç¶™ç¶š
                appData = {
                    raidTiers: {},
                    players: {},
                    allocations: {},
                    settings: {}
                };
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
        function showMainDashboard() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                <h2>ãƒãƒ¼ãƒ : ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>ãƒ¬ã‚¤ãƒ‰é¸æŠ</h3>
                    <div class="tier-list" id="tierList">
                        <!-- ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="createNewTier()">æ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’ä½œæˆ</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ç®¡ç†æ©Ÿèƒ½</h3>
                    <div class="navigation">
                        <button class="nav-button" onclick="showSystemSettings()">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</button>
                        <button class="nav-button" onclick="exportAllData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="nav-button" onclick="testDatabaseConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #e8f5e8; border-color: #27ae60;">
                    <h3>å®Ÿè£…å®Œäº†æ©Ÿèƒ½</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Supabaseé€£æºãƒ»èªè¨¼ã‚·ã‚¹ãƒ†ãƒ </li>
                        <li>ãƒãƒ¼ãƒ åˆ¥ãƒ‡ãƒ¼ã‚¿ç®¡ç†</li>
                        <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</li>
                        <li>ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ç®¡ç†</li>
                        <li>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»è£…å‚™ç®¡ç†</li>
                    </ul>
                </div>
            `;
            
            // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä¸€è¦§ã‚’è¡¨ç¤º
            displayRaidTiers();
        }
        
        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä¸€è¦§è¡¨ç¤º
        function displayRaidTiers() {
            const tierList = document.getElementById('tierList');
            const tiers = appData.raidTiers || {};
            
            if (Object.keys(tiers).length === 0) {
                tierList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>ã¾ã ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                        <p>ã€Œæ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
                return;
            }
            
            tierList.innerHTML = Object.entries(tiers).map(([tierId, tier]) => `
                <div class="tier-item ${currentRaidTier?.id === tierId ? 'active' : ''}" 
                     onclick="selectRaidTier('${tierId}')">
                    <h3>${tier.name}</h3>
                    <p>${tier.description || 'é›¶å¼ãƒ¬ã‚¤ãƒ‰'}</p>
                    <p style="font-size: 0.8rem; color: #888;">
                        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${Object.keys(appData.players[tierId] || {}).length}äºº
                    </p>
                </div>
            `).join('');
        }
        
        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ
        async function selectRaidTier(tierId) {
            const tier = appData.raidTiers[tierId];
            if (!tier) {
                showError('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            currentRaidTier = { id: tierId, ...tier };
            showSuccess(`ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã€Œ${tier.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
            
            // ãƒ†ã‚£ã‚¢å›ºæœ‰ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            showTierDashboard();
        }
        
        // ãƒ†ã‚£ã‚¢å›ºæœ‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        function showTierDashboard() {
            if (!currentRaidTier) return;
            
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showMainDashboard()">ãƒ¬ã‚¤ãƒ‰é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
                </div>
                
                <h1>${currentRaidTier.name}</h1>
                <h2>ãƒãƒ¼ãƒ : ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>è£…å‚™åˆ†é…</h3>
                    <div class="dashboard-layer-grid">
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(1)">1å±¤</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(2)">2å±¤</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(3)">3å±¤</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(4)">4å±¤</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showPlayerManagement()">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
                        <button class="nav-button" onclick="showStatistics()">çµ±è¨ˆæƒ…å ±</button>
                        <button class="nav-button" onclick="showAllocationHistory()">é…å¸ƒå±¥æ­´</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ãƒ†ã‚£ã‚¢æƒ…å ±</h3>
                    <p><strong>ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢:</strong> ${currentRaidTier.name}</p>
                    <p><strong>èª¬æ˜:</strong> ${currentRaidTier.description || 'é›¶å¼ãƒ¬ã‚¤ãƒ‰'}</p>
                    <p><strong>ç™»éŒ²ãƒ¡ãƒ³ãƒãƒ¼:</strong> ${Object.keys(appData.players[currentRaidTier.id] || {}).length}äºº</p>
                    <p><strong>é…å¸ƒå±¥æ­´:</strong> ${(appData.allocations[currentRaidTier.id] || []).length}ä»¶</p>
                </div>
            `;
        }
        
        // æ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä½œæˆ
        async function createNewTier() {
            const name = prompt('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š7.1 ã‚¢ãƒ¼ã‚¯ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³é›¶å¼ï¼‰:');
            if (!name) return;
            
            const description = prompt('èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆçœç•¥å¯ï¼‰:') || 'é›¶å¼ãƒ¬ã‚¤ãƒ‰';
            
            try {
                const tierId = 'tier_' + Date.now();
                const tierData = {
                    name: name.trim(),
                    description: description.trim(),
                    createdAt: new Date().toISOString()
                };
                
                // Supabaseã«ä¿å­˜
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .insert({
                        team_id: currentTeamId,
                        tier_id: tierId,
                        data_type: 'settings',
                        content: { raidTier: tierData }
                    });
                
                if (error) {
                    throw new Error(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                if (!appData.raidTiers) appData.raidTiers = {};
                appData.raidTiers[tierId] = tierData;
                
                showSuccess(`ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                
                // è¡¨ç¤ºæ›´æ–°
                displayRaidTiers();
                
            } catch (error) {
                console.error('ãƒ†ã‚£ã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†æ©Ÿèƒ½
        function showPlayerManagement() {
            showPlayerSetup();
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šç”»é¢ï¼ˆã‚¿ãƒ–å½¢å¼ï¼‰
        function showPlayerSetup() {
            showTabbedSetup('players');
        }
        
        // ã‚¿ãƒ–å½¢å¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢
        function showTabbedSetup(activeTab = 'players') {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>ãƒ¡ãƒ³ãƒãƒ¼ãƒ»è£…å‚™è¨­å®š</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">ãƒ¬ã‚¤ãƒ‰é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button ${activeTab === 'players' ? 'active' : ''}" onclick="showTabbedSetup('players')">
                            ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±
                        </button>
                        <button class="tab-button ${activeTab === 'policy' ? 'active' : ''}" onclick="showTabbedSetup('policy')">
                            è£…å‚™æ–¹é‡
                        </button>
                        <button class="tab-button ${activeTab === 'weapons' ? 'active' : ''}" onclick="showTabbedSetup('weapons')">
                            æ­¦å™¨å¸Œæœ›
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        ${getTabContent(activeTab)}
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="saveCurrentTabAndContinue('${activeTab}')">
                            è¨­å®šå®Œäº†
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
        function getTabContent(tabName) {
            const players = appData.players[currentRaidTier.id] || {};
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (tabName === 'players') {
                return `
                    <h3>8äººã®ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position] || {};
                            const roleJobs = {
                                'MT': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                                'ST': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                                'H1': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…'],
                                'H2': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…'],
                                'D1': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                                'D2': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                                'D3': ['é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼', 'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­'],
                                'D4': ['é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼', 'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­']
                            };
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="position-badge">${position}</span>
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆå¿…é ˆï¼‰:</label>
                                        <input type="text" id="${position}-name" value="${player.name || ''}" 
                                               placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›" style="width: 100%;">
                                    </div>
                                    
                                    
                                    <div style="margin: 10px 0;">
                                        <label>ã‚¸ãƒ§ãƒ–ï¼ˆå¿…é ˆï¼‰:</label>
                                        <select id="${position}-job" class="job-select">
                                            <option value="">ã‚¸ãƒ§ãƒ–ã‚’é¸æŠ</option>
                                            ${roleJobs[position].map(job => `
                                                <option value="${job}" ${player.job === job ? 'selected' : ''}>${job}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'policy') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>ã¾ãšãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                }
                
                const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
                
                return `
                    <h3>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è£…å‚™æ–¹é‡ã‚’è¨­å®š</h3>
                    <p>é›¶å¼ï¼šé›¶å¼è£…å‚™ã‚’å„ªå…ˆå–å¾—ã€ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ï¼šãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³è£…å‚™ã§ååˆ†</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="equipment-policy">
                                        <div class="policy-grid">
                                            ${slots.map(slot => `
                                                <div class="policy-item">
                                                    <label>${slot}</label>
                                                    <select id="${position}-${slot}-policy">
                                                        <option value="é›¶å¼" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'é›¶å¼') ? 'selected' : ''}>é›¶å¼</option>
                                                        <option value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³') ? 'selected' : ''}>ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'weapons') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>ã¾ãšãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                }
                
                const allWeapons = [
                    'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                    'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…',
                    'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                    'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼',
                    'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­'
                ];
                
                return `
                    <h3>4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®å¸Œæœ›é †ä½ã‚’è¨­å®š</h3>
                    <p>ç¬¬ä¸€å¸Œæœ›ã¯è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–ã«ãªã‚Šã¾ã™ã€‚ç¬¬äºŒã€œç¬¬å››å¸Œæœ›ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            const weaponWishes = player.weaponWishes || [];
                            const mainWeapon = player.job;
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="weapon-wishes">
                                        <div class="wish-priority">
                                            <label>ç¬¬ä¸€å¸Œæœ› (ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–):</label>
                                            <input type="text" value="${mainWeapon}" readonly style="background-color: #e9ecef;">
                                        </div>
                                        <div class="wish-priority">
                                            <label>ç¬¬äºŒå¸Œæœ›:</label>
                                            <select id="${position}-weapon-wish-2">
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[1] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>ç¬¬ä¸‰å¸Œæœ›:</label>
                                            <select id="${position}-weapon-wish-3">
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[2] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>ç¬¬å››å¸Œæœ›:</label>
                                            <select id="${position}-weapon-wish-4">
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[3] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            return '';
        }
        
        // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ä¿å­˜ã—ã¦æ¬¡ã¸é€²ã‚€
        async function saveCurrentTabAndContinue(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                }
                
                showSuccess('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                
                // å…¨ã¦è¨­å®šæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
                if (Object.keys(appData.players[currentRaidTier.id] || {}).length > 0) {
                    showTierDashboard();
                } else {
                    showError('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                }
            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showError('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ä¿å­˜
        async function savePlayersData() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (!appData.players[currentRaidTier.id]) {
                appData.players[currentRaidTier.id] = {};
            }
            
            for (const position of positions) {
                const nameInput = document.getElementById(`${position}-name`);
                const jobSelect = document.getElementById(`${position}-job`);
                
                if (!nameInput || !jobSelect) continue;
                
                const name = nameInput.value.trim();
                const job = jobSelect.value;
                
                if (!name || !job) {
                    throw new Error(`${position}ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨ã‚¸ãƒ§ãƒ–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                }
                
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¿æŒ
                const existingPlayer = appData.players[currentRaidTier.id][position] || {};
                
                appData.players[currentRaidTier.id][position] = {
                    name: name,
                    job: job,
                    position: position,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    weaponWishes: existingPlayer.weaponWishes || [],
                    currentEquipment: existingPlayer.currentEquipment || {},
                    dynamicPriority: existingPlayer.dynamicPriority || 0,
                    allocationHistory: existingPlayer.allocationHistory || []
                };
            }
            
            // Supabaseã«ä¿å­˜
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // è£…å‚™æ–¹é‡ä¿å­˜
        async function saveEquipmentPolicyData() {
            const players = appData.players[currentRaidTier.id];
            const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
            
            for (const [position, player] of Object.entries(players)) {
                for (const slot of slots) {
                    const policyElement = document.getElementById(`${position}-${slot}-policy`);
                    if (policyElement) {
                        const policy = policyElement.value;
                        player.equipmentPolicy[slot] = policy;
                    }
                }
            }
            
            // Supabaseã«ä¿å­˜
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // æ­¦å™¨å¸Œæœ›ä¿å­˜
        async function saveWeaponWishesData() {
            const players = appData.players[currentRaidTier.id];
            
            for (const [position, player] of Object.entries(players)) {
                const mainJob = player.job;
                const wish2Element = document.getElementById(`${position}-weapon-wish-2`);
                const wish3Element = document.getElementById(`${position}-weapon-wish-3`);
                const wish4Element = document.getElementById(`${position}-weapon-wish-4`);
                
                // ç¬¬ä¸€å¸Œæœ›ã¯ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–ã€ç¬¬äºŒã€œç¬¬å››å¸Œæœ›ã¯é¸æŠã•ã‚ŒãŸå€¤
                player.weaponWishes = [
                    mainJob,
                    wish2Element ? wish2Element.value : '',
                    wish3Element ? wish3Element.value : '',
                    wish4Element ? wish4Element.value : ''
                ].filter(wish => wish !== ''); // ç©ºã®å€¤ã‚’é™¤å¤–
            }
            
            // Supabaseã«ä¿å­˜
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importFromJSON() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');
                
                const text = await file.text();
                const importData = JSON.parse(text);
                
                // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ¤œè¨¼ã¨å¤‰æ›
                const convertedData = await convertImportData(importData);
                
                if (!convertedData) {
                    showError('å¯¾å¿œã—ã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚');
                    return;
                }
                
                // è©³ç´°æƒ…å ±ã®è¡¨ç¤º
                let playerCount = 0;
                let tierCount = 0;
                
                if (convertedData.type === 'collaborative') {
                    tierCount = Object.keys(convertedData.players || {}).length;
                    playerCount = Object.values(convertedData.players || {}).reduce((total, tierPlayers) => {
                        return total + Object.keys(tierPlayers || {}).length;
                    }, 0);
                } else if (convertedData.type === 'simple') {
                    playerCount = Object.keys(convertedData.players || {}).length;
                    tierCount = 1;
                }
                
                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                const confirmMessage = `ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ï¼š
                
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${playerCount}äºº
ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢æ•°: ${tierCount}å€‹
ãƒ‡ãƒ¼ã‚¿å½¢å¼: ${convertedData.type === 'collaborative' ? 'å…±åŒåˆ©ç”¨ç‰ˆ' : 'ç°¡æ˜“ç‰ˆ'}

ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                await importConvertedData(convertedData);
                
                showSuccess(`ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆ${playerCount}äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç™»éŒ²ï¼‰`);
                showTabbedSetup('players'); // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã«ç§»å‹•
                
            } catch (error) {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                if (error.name === 'SyntaxError') {
                    showError('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else {
                    showError('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®æƒ…å ±è¡¨ç¤ºã‚’è¨­å®š
            document.addEventListener('change', function(event) {
                if (event.target.id === 'jsonFileInput') {
                    const file = event.target.files[0];
                    const fileInfo = document.getElementById('jsonFileInfo');
                    const fileName = document.getElementById('selectedFileName');
                    const fileDetails = document.getElementById('fileDetails');
                    
                    if (file && fileInfo && fileName && fileDetails) {
                        fileName.textContent = file.name;
                        fileDetails.textContent = `ã‚µã‚¤ã‚º: ${(file.size / 1024).toFixed(2)} KB, æœ€çµ‚æ›´æ–°: ${new Date(file.lastModified).toLocaleString()}`;
                        fileInfo.style.display = 'block';
                    } else if (fileInfo) {
                        fileInfo.style.display = 'none';
                    }
                }
            });
        });
        
        // CSVã‹ã‚‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importFromCSV() {
            const csvText = document.getElementById('csvTextArea').value.trim();
            
            if (!csvText) {
                showError('CSVãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const players = {};
                
                for (let i = 1; i < lines.length; i++) { // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    const columns = lines[i].split(',').map(col => col.trim());
                    
                    if (columns.length < 4) continue;
                    
                    const [position, name, job] = columns;
                    
                    players[position] = {
                        name: name,
                        job: job,
                        position: position,
                        equipmentPolicy: {},
                        weaponWishes: [job],
                        currentEquipment: {},
                        dynamicPriority: 0,
                        allocationHistory: []
                    };
                }
                
                if (Object.keys(players).length === 0) {
                    showError('æœ‰åŠ¹ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                
                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                if (!confirm(`${Object.keys(players).length}äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                appData.players[currentRaidTier.id] = players;
                await saveDataToSupabase('players', players);
                
                showSuccess('CSVãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                showTabbedSetup('players'); // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã«ç§»å‹•
                
            } catch (error) {
                console.error('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showError('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // CSVãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearCSVData() {
            const csvTextArea = document.getElementById('csvTextArea');
            if (csvTextArea) {
                csvTextArea.value = '';
                showSuccess('CSVãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
            }
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒªã‚»ãƒƒãƒˆ
        async function resetAllPlayersData() {
            if (!confirm('ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            if (!confirm('æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã€è£…å‚™æ–¹é‡ã€æ­¦å™¨å¸Œæœ›ãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }
            
            try {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                
                // Supabaseã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id)
                    .eq('data_type', 'players');
                
                showSuccess('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
                showTabbedSetup('players'); // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã«ç§»å‹•
                
            } catch (error) {
                console.error('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ç¾åœ¨ã®ãƒ†ã‚£ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        async function resetCurrentTierData() {
            if (!confirm('ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            if (!confirm('æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã€è£…å‚™æ–¹é‡ã€åˆ†é…å±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }
            
            try {
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                if (appData.allocations[currentRaidTier.id]) {
                    delete appData.allocations[currentRaidTier.id];
                }
                
                // Supabaseã‹ã‚‰ã‚‚å‰Šé™¤
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id);
                
                showSuccess('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
                showTabbedSetup('players'); // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã«ç§»å‹•
                
            } catch (error) {
                console.error('ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›
        async function convertImportData(importData) {
            // collaborative_index.htmlå½¢å¼ã®å ´åˆ
            if (importData.raidTiers && importData.players && importData.allocations) {
                return {
                    type: 'collaborative',
                    players: importData.players,
                    allocations: importData.allocations
                };
            }
            
            // å˜ç´”ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆå½¢å¼ã®å ´åˆ
            if (Array.isArray(importData) && importData.length > 0 && importData[0].name) {
                const players = {};
                importData.forEach((player, index) => {
                    const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
                    const position = positions[index] || `D${index - 3}`;
                    
                    players[position] = {
                        name: player.name,
                        characterName: player.characterName || '',
                        job: player.job,
                        position: position,
                        equipmentPolicy: player.equipmentPolicy || {},
                        weaponWishes: player.weaponWishes || [player.job],
                        currentEquipment: player.currentEquipment || {},
                        dynamicPriority: player.dynamicPriority || 0,
                        allocationHistory: player.allocationHistory || []
                    };
                });
                
                return {
                    type: 'simple',
                    players: players
                };
            }
            
            return null;
        }
        
        // å¤‰æ›æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importConvertedData(convertedData) {
            if (convertedData.type === 'collaborative') {
                // ç¾åœ¨ã®ãƒ†ã‚£ã‚¢ã«å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                const tierData = Object.values(convertedData.players)[0] || {};
                appData.players[currentRaidTier.id] = tierData;
                
                // åˆ†é…å±¥æ­´ã‚‚ç§»è¡Œ
                if (convertedData.allocations) {
                    const allocationData = Object.values(convertedData.allocations)[0] || {};
                    appData.allocations[currentRaidTier.id] = allocationData;
                    await saveDataToSupabase('allocations', allocationData);
                }
            } else if (convertedData.type === 'simple') {
                appData.players[currentRaidTier.id] = convertedData.players;
            }
            
            // Supabaseã«ä¿å­˜
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Supabaseãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ˜ãƒ«ãƒ‘ãƒ¼
        async function saveDataToSupabase(dataType, content) {
            const { error } = await window.supabaseClient
                .from('raid_data')
                .upsert({
                    team_id: currentTeamId,
                    tier_id: currentRaidTier.id,
                    data_type: dataType,
                    content: content
                });
                
            if (error) {
                throw new Error(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ 
        function showEquipmentAllocation() {
            const content = document.getElementById('content');
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">ãƒ¬ã‚¤ãƒ‰é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
                </div>
                
                <h1>è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section" id="allocationResults" style="display: none;">
                    <h3>åˆ†é…çµæœ</h3>
                    <div id="allocationContent"></div>
                </div>
            `;
        }
        
        // ç›´æ¥å±¤åˆ¥åˆ†é…ã‚’å®Ÿè¡Œï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
        async function showLayerAllocation(layer) {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (playerCount < 8) {
                if (!confirm(`ãƒ¡ãƒ³ãƒãƒ¼ãŒ${playerCount}äººã—ã‹ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆ†é…ã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
            }
            
            // è£…å‚™åˆ†é…ç”»é¢ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰è©²å½“å±¤ã®å‡¦ç†ã‚’å®Ÿè¡Œ
            showEquipmentAllocation();
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆ†é…å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆDOMæ›´æ–°ã®ãŸã‚ï¼‰
            setTimeout(() => {
                processLayerAllocation(layer);
            }, 100);
        }
        
        // å±¤åˆ¥è£…å‚™åˆ†é…å‡¦ç†
        async function processLayerAllocation(layer) {
            try {
                showMessage('åˆ†é…å‡¦ç†ä¸­...', 'info');
                
                // å±¤åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
                const drops = getLayerDrops(layer);
                
                // åˆ†é…å„ªå…ˆåº¦ã‚’è¨ˆç®—
                const allocationResults = calculateAllocation(layer, drops);
                
                // çµæœã‚’è¡¨ç¤º
                displayAllocationResults(layer, allocationResults);
                
            } catch (error) {
                console.error('åˆ†é…å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showError('åˆ†é…å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å±¤åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ å®šç¾©
        function getLayerDrops(layer) {
            const drops = {
                1: [
                    { name: 'è€³è£…å‚™', slot: 'è€³', type: 'equipment', itemLevel: '' },
                    { name: 'é¦–è£…å‚™', slot: 'é¦–', type: 'equipment', itemLevel: '' },
                    { name: 'è…•è£…å‚™', slot: 'è…•', type: 'equipment', itemLevel: '' },
                    { name: 'æŒ‡è£…å‚™', slot: 'æŒ‡', type: 'equipment', itemLevel: '' }
                ],
                2: [
                    { name: 'é ­è£…å‚™', slot: 'é ­', type: 'equipment', itemLevel: '' },
                    { name: 'æ‰‹è£…å‚™', slot: 'æ‰‹', type: 'equipment', itemLevel: '' },
                    { name: 'è¶³è£…å‚™', slot: 'è¶³', type: 'equipment', itemLevel: '' },
                    { name: 'æ­¦å™¨çŸ³', slot: 'æ­¦å™¨çŸ³', type: 'material', itemLevel: '' },
                    { name: 'ç¡¬åŒ–è–¬', slot: 'ç¡¬åŒ–è–¬', type: 'material', itemLevel: '' }
                ],
                3: [
                    { name: 'èƒ´è£…å‚™', slot: 'èƒ´', type: 'equipment', itemLevel: '' },
                    { name: 'è„šè£…å‚™', slot: 'è„š', type: 'equipment', itemLevel: '' },
                    { name: 'å¼·åŒ–è–¬', slot: 'å¼·åŒ–è–¬', type: 'material', itemLevel: '' },
                    { name: 'å¼·åŒ–ç¹Šç¶­', slot: 'å¼·åŒ–ç¹Šç¶­', type: 'material', itemLevel: '' }
                ],
                4: [
                    { name: 'èƒ´è£…å‚™', slot: 'èƒ´', type: 'equipment', itemLevel: '' },
                    { name: 'æ­¦å™¨ç®±', slot: 'æ­¦å™¨ç®±', type: 'weapon_box', itemLevel: '' },
                    { name: 'ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨', slot: 'æ­¦å™¨', type: 'direct_weapon', itemLevel: '', weapon: null }
                ]
            };
            
            return drops[layer] || [];
        }
        
        // åˆ†é…å„ªå…ˆåº¦è¨ˆç®—
        function calculateAllocation(layer, drops) {
            const players = appData.players[currentRaidTier.id] || {};
            const results = {};
            
            drops.forEach(drop => {
                const allCandidates = [];
                
                Object.entries(players).forEach(([position, player]) => {
                    const priority = calculatePlayerPriority(player, drop);
                    allCandidates.push({
                        position,
                        player,
                        priority: priority.score,
                        reason: priority.reason,
                        type: priority.type,
                        canReceive: priority.canReceive
                    });
                });
                
                // å„ªå…ˆåº¦é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
                allCandidates.sort((a, b) => b.priority - a.priority);
                
                // å–å¾—å¯èƒ½ãªå€™è£œè€…ã®ã¿æŠ½å‡º
                const candidates = allCandidates.filter(c => c.canReceive);
                
                results[drop.slot] = {
                    drop,
                    candidates: allCandidates, // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆ¤å®šçµæœ
                    recommended: candidates[0] || null // æœ€å„ªå…ˆã®å–å¾—å¯èƒ½è€…
                };
            });
            
            return results;
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å„ªå…ˆåº¦è¨ˆç®—
        function calculatePlayerPriority(player, drop) {
            let score = 0;
            let canReceive = false;
            let reason = 'Pass';
            let type = 'pass';
            
            if (drop.type === 'equipment') {
                // è£…å‚™ã®å ´åˆ
                const policy = player.equipmentPolicy?.[drop.slot] || 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³';
                const hasEquipment = player.currentEquipment?.[drop.slot];
                
                if (policy === 'é›¶å¼' && !hasEquipment) {
                    canReceive = true;
                    type = 'need';
                    score = 1000 - (player.dynamicPriority || 0);
                    reason = 'Need (é›¶å¼)';
                } else if (!hasEquipment) {
                    canReceive = true;
                    type = 'greed';
                    score = 500 - (player.dynamicPriority || 0);
                    reason = 'Greed (ãƒˆãƒ¼ãƒ å¯)';
                } else {
                    type = 'pass';
                    reason = 'Pass (æ‰€æŒæ¸ˆã¿)';
                }
            } else if (drop.type === 'material') {
                // å¼·åŒ–ç´ æã®å ´åˆï¼ˆåˆ†é…å„ªå…ˆåº¦è¨­å®šã«åŸºã¥ãï¼‰
                const materialAllocations = appData.allocations?.[currentRaidTier.id] || [];
                const hasThisMaterial = materialAllocations.some(alloc => 
                    alloc.position === player.position && alloc.slot === drop.slot
                );
                
                if (!hasThisMaterial) {
                    canReceive = true;
                    type = 'need';
                    score = getMaterialPriority(player.position, drop.slot) - (player.dynamicPriority || 0);
                    reason = 'Need (ç´ æ)';
                } else {
                    type = 'pass';
                    reason = 'Pass (å–å¾—æ¸ˆã¿)';
                }
            } else if (drop.type === 'weapon_box') {
                // æ­¦å™¨ç®±ã®å ´åˆ
                const hasWeapon = player.currentEquipment?.['æ­¦å™¨'];
                if (!hasWeapon) {
                    canReceive = true;
                    type = 'need';
                    score = 2000 - (player.dynamicPriority || 0);
                    reason = 'Need (æ­¦å™¨ç®±)';
                } else {
                    type = 'pass';
                    reason = 'Pass (æ­¦å™¨æ‰€æŒæ¸ˆã¿)';
                }
            } else if (drop.type === 'direct_weapon') {
                // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®å ´åˆï¼ˆæ­¦å™¨å¸Œæœ›ã«åŸºã¥ãï¼‰
                const weaponWishes = player.weaponWishes || [];
                const hasWeapon = player.currentEquipment?.['æ­¦å™¨'];
                const weaponType = drop.weapon; // é¸æŠã•ã‚ŒãŸæ­¦å™¨ç¨®
                
                if (!hasWeapon && weaponType && weaponWishes.includes(weaponType)) {
                    canReceive = true;
                    type = 'need';
                    const wishIndex = weaponWishes.indexOf(weaponType);
                    score = 3000 - (wishIndex * 100) - (player.dynamicPriority || 0);
                    reason = `Need (ç¬¬${wishIndex + 1}å¸Œæœ›)`;
                } else if (!hasWeapon) {
                    canReceive = true;
                    type = 'greed';
                    score = 100 - (player.dynamicPriority || 0);
                    reason = 'Greed (æ­¦å™¨)';
                } else {
                    type = 'pass';
                    reason = 'Pass (æ­¦å™¨æ‰€æŒæ¸ˆã¿)';
                }
            }
            
            return { canReceive, score, reason, type };
        }
        
        // å¼·åŒ–ç´ æã®åˆ†é…å„ªå…ˆåº¦å–å¾—
        function getMaterialPriority(position, materialType) {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ†é…å„ªå…ˆåº¦é †åºï¼ˆè¨­å®šå¯èƒ½ã«ã™ã‚‹äºˆå®šï¼‰
            const defaultOrder = ['D1', 'D2', 'D3', 'D4', 'H1', 'H2', 'MT', 'ST'];
            const positionIndex = defaultOrder.indexOf(position);
            return 800 - (positionIndex * 50); // é«˜ã„é †ä½ã»ã©é«˜ã‚¹ã‚³ã‚¢
        }
        
        // åˆ†é…çµæœè¡¨ç¤º
        function displayAllocationResults(layer, results) {
            const allocationResults = document.getElementById('allocationResults');
            const allocationContent = document.getElementById('allocationContent');
            
            let html = `
                <div class="allocation-header">
                    <h4>${layer}å±¤ è£…å‚™åˆ†é…çµæœ</h4>
                    <p>æ¨å¥¨åˆ†é…è€…ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
            
            // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨é¸æŠï¼ˆ4å±¤ã®ã¿ï¼‰
            if (layer === 4) {
                html += `
                    <div class="weapon-selection">
                        <h5>ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨é¸æŠ:</h5>
                        <select id="directWeaponSelect" onchange="updateDirectWeapon()">
                            <option value="">æ­¦å™¨ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ãƒŠã‚¤ãƒˆ">ãƒŠã‚¤ãƒˆæ­¦å™¨</option>
                            <option value="æˆ¦å£«">æˆ¦å£«æ­¦å™¨</option>
                            <option value="æš—é»’é¨å£«">æš—é»’é¨å£«æ­¦å™¨</option>
                            <option value="ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼">ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼æ­¦å™¨</option>
                            <option value="ç™½é­”é“å£«">ç™½é­”é“å£«æ­¦å™¨</option>
                            <option value="å­¦è€…">å­¦è€…æ­¦å™¨</option>
                            <option value="å æ˜Ÿè¡“å£«">å æ˜Ÿè¡“å£«æ­¦å™¨</option>
                            <option value="è³¢è€…">è³¢è€…æ­¦å™¨</option>
                            <option value="ãƒ¢ãƒ³ã‚¯">ãƒ¢ãƒ³ã‚¯æ­¦å™¨</option>
                            <option value="ç«œé¨å£«">ç«œé¨å£«æ­¦å™¨</option>
                            <option value="å¿è€…">å¿è€…æ­¦å™¨</option>
                            <option value="ä¾">ä¾æ­¦å™¨</option>
                            <option value="ãƒªãƒ¼ãƒ‘ãƒ¼">ãƒªãƒ¼ãƒ‘ãƒ¼æ­¦å™¨</option>
                            <option value="ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼">ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼æ­¦å™¨</option>
                            <option value="é»’é­”é“å£«">é»’é­”é“å£«æ­¦å™¨</option>
                            <option value="å¬å–šå£«">å¬å–šå£«æ­¦å™¨</option>
                            <option value="èµ¤é­”é“å£«">èµ¤é­”é“å£«æ­¦å™¨</option>
                            <option value="ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼">ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼æ­¦å™¨</option>
                            <option value="åŸéŠè©©äºº">åŸéŠè©©äººæ­¦å™¨</option>
                            <option value="æ©Ÿå·¥å£«">æ©Ÿå·¥å£«æ­¦å™¨</option>
                            <option value="è¸Šã‚Šå­">è¸Šã‚Šå­æ­¦å™¨</option>
                        </select>
                    </div>
                `;
            }
            
            html += `<div class="allocation-grid">`;
            
            Object.entries(results).forEach(([itemKey, result]) => {
                const drop = result.drop;
                const needCandidates = result.candidates.filter(c => c.type === 'need');
                const greedCandidates = result.candidates.filter(c => c.type === 'greed');
                const passCandidates = result.candidates.filter(c => c.type === 'pass');
                
                html += `
                    <div class="allocation-item">
                        <div class="item-header">
                            <h5>${drop.name} ${drop.itemLevel}</h5>
                            <span class="item-type">${getItemTypeLabel(drop.type)}</span>
                        </div>
                        
                        <div class="predicted-winner">
                            <strong>äºˆæ¸¬å–å¾—è€…:</strong> 
                            ${result.recommended ? 
                                `${result.recommended.player.name} (${result.recommended.position}) [${result.recommended.player.job}]` : 
                                'è©²å½“è€…ãªã—'
                            }
                        </div>
                        
                        <div class="allocation-choice">
                            <label>å®Ÿéš›ã®å–å¾—è€…:</label>
                            <select id="allocation-${itemKey}" onchange="updateAllocationChoice('${itemKey}')">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                ${result.candidates.map(candidate => `
                                    <option value="${candidate.position}" 
                                            ${result.recommended?.position === candidate.position ? 'selected' : ''}>
                                        ${candidate.player.name} (${candidate.position}) [${candidate.player.job}]
                                    </option>
                                `).join('')}
                                <option value="ãƒ•ãƒªãƒ­">ãƒ•ãƒªãƒ­</option>
                                <option value="discard">ç ´æ£„</option>
                            </select>
                        </div>
                        
                        <div class="judgment-details">
                            <div class="judgment-section">
                                <button class="judgment-toggle" onclick="toggleJudgment('${itemKey}')">
                                    åˆ¤å®šè©³ç´°ã‚’è¡¨ç¤º â–¼
                                </button>
                                <div id="judgment-${itemKey}" class="judgment-content" style="display: none;">
                                    ${needCandidates.length > 0 ? `
                                        <div class="need-section">
                                            <h6>Need (${needCandidates.length}äºº)</h6>
                                            ${needCandidates.map(candidate => `
                                                <div class="candidate-item need">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${greedCandidates.length > 0 ? `
                                        <div class="greed-section">
                                            <h6>Greed (${greedCandidates.length}äºº)</h6>
                                            ${greedCandidates.map(candidate => `
                                                <div class="candidate-item greed">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${passCandidates.length > 0 ? `
                                        <div class="pass-section">
                                            <h6>Pass (${passCandidates.length}äºº)</h6>
                                            ${passCandidates.map(candidate => `
                                                <div class="candidate-item pass">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="allocation-actions">
                    <button onclick="confirmAllocation(${layer})" class="confirm-btn">
                        åˆ†é…ã‚’ç¢ºå®š
                    </button>
                    <button onclick="showEquipmentAllocation()" class="cancel-btn">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            `;
            
            allocationContent.innerHTML = html;
            allocationResults.style.display = 'block';
            
            // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            allocationResults.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨æ›´æ–°
        function updateDirectWeapon() {
            const weaponSelect = document.getElementById('directWeaponSelect');
            const selectedWeapon = weaponSelect.value;
            
            if (selectedWeapon) {
                // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®åˆ†é…ã‚’å†è¨ˆç®—
                const drops = getLayerDrops(4);
                const weaponDrop = drops.find(d => d.type === 'direct_weapon');
                if (weaponDrop) {
                    weaponDrop.weapon = selectedWeapon;
                    const allocationResults = calculateAllocation(4, drops);
                    displayAllocationResults(4, allocationResults);
                }
            }
        }
        
        // åˆ¤å®šè©³ç´°ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleJudgment(itemKey) {
            const content = document.getElementById(`judgment-${itemKey}`);
            const button = content.previousElementSibling;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'åˆ¤å®šè©³ç´°ã‚’éš ã™ â–²';
            } else {
                content.style.display = 'none';
                button.textContent = 'åˆ¤å®šè©³ç´°ã‚’è¡¨ç¤º â–¼';
            }
        }
        
        // ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—ãƒ©ãƒ™ãƒ«
        function getItemTypeLabel(type) {
            const labels = {
                'equipment': 'è£…å‚™',
                'material': 'å¼·åŒ–ç´ æ',
                'weapon_box': 'æ­¦å™¨ç®±',
                'direct_weapon': 'ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨'
            };
            return labels[type] || type;
        }
        
        // åˆ†é…é¸æŠæ›´æ–°
        function updateAllocationChoice(slot) {
            // é¸æŠå¤‰æ›´æ™‚ã®å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
            console.log(`${slot}ã®åˆ†é…é¸æŠãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ`);
        }
        
        // åˆ†é…ç¢ºå®š
        async function confirmAllocation(layer) {
            try {
                const allocations = [];
                const selects = document.querySelectorAll('[id^="allocation-"]');
                const allocationId = Date.now().toString();
                
                selects.forEach(select => {
                    const itemKey = select.id.replace('allocation-', '');
                    const position = select.value;
                    
                    if (position && position !== 'discard' && position !== 'ãƒ•ãƒªãƒ­') {
                        const player = appData.players[currentRaidTier.id][position];
                        const drops = getLayerDrops(layer);
                        const drop = drops.find(d => d.slot === itemKey || d.name.includes(itemKey));
                        
                        if (drop && player) {
                            const allocation = {
                                id: `${allocationId}-${itemKey}`,
                                layer: layer,
                                slot: drop.slot,
                                position: position,
                                playerName: player.name,
                                characterName: player.characterName || '',
                                job: player.job,
                                equipment: {
                                    name: drop.name,
                                    slot: drop.slot,
                                    itemLevel: drop.itemLevel
                                },
                                timestamp: new Date().toISOString(),
                                week: getCurrentWeek(),
                                raidTier: currentRaidTier.name,
                                // è©³ç´°æƒ…å ±
                                itemType: drop.type,
                                equipmentName: drop.name,
                                equipmentSlot: drop.slot,
                                winner: position,
                                winnerName: player.name
                            };
                            
                            allocations.push(allocation);
                        }
                    }
                });
                
                if (allocations.length === 0) {
                    showError('åˆ†é…ã™ã‚‹è£…å‚™ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    return;
                }
                
                // åˆ†é…å±¥æ­´ã«è¨˜éŒ²
                if (!appData.allocations[currentRaidTier.id]) {
                    appData.allocations[currentRaidTier.id] = [];
                }
                
                allocations.forEach(allocation => {
                    appData.allocations[currentRaidTier.id].push(allocation);
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è£…å‚™çŠ¶æ³æ›´æ–°
                    const player = appData.players[currentRaidTier.id][allocation.position];
                    if (player) {
                        // ç¾åœ¨è£…å‚™ã®æ›´æ–°
                        if (!player.currentEquipment) player.currentEquipment = {};
                        player.currentEquipment[allocation.slot] = true;
                        
                        // åˆ†é…å±¥æ­´ã®æ›´æ–°
                        if (!player.allocationHistory) player.allocationHistory = [];
                        player.allocationHistory.push({
                            equipment: allocation.equipment,
                            timestamp: allocation.timestamp,
                            week: allocation.week,
                            layer: allocation.layer
                        });
                        
                        // å‹•çš„å„ªå…ˆåº¦æ›´æ–°
                        const itemPriority = getItemPriority(allocation.slot);
                        player.dynamicPriority = (player.dynamicPriority || 0) + itemPriority;
                    }
                });
                
                // Supabaseã«ä¿å­˜
                await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
                
                showSuccess(`${layer}å±¤ã®è£…å‚™åˆ†é…ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚${allocations.length}ä»¶ã®è£…å‚™ãŒåˆ†é…ã•ã‚Œã¾ã—ãŸã€‚`);
                showEquipmentAllocation(); // è£…å‚™åˆ†é…ç”»é¢ã«æˆ»ã‚‹
                
            } catch (error) {
                console.error('åˆ†é…ç¢ºå®šã‚¨ãƒ©ãƒ¼:', error);
                showError('åˆ†é…ã®ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ç¾åœ¨ã®é€±ç•ªå·å–å¾—
        function getCurrentWeek() {
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const weekNumber = Math.ceil(((now - yearStart) / 86400000 + yearStart.getDay() + 1) / 7);
            return weekNumber;
        }
        
        // ã‚¢ã‚¤ãƒ†ãƒ å„ªå…ˆåº¦å–å¾—
        function getItemPriority(slot) {
            const priorities = {
                'æ­¦å™¨': 3,
                'èƒ´': 2,
                'è„š': 2,
                'é ­': 1,
                'æ‰‹': 1,
                'è¶³': 1,
                'è€³': 1,
                'é¦–': 1,
                'è…•': 1,
                'æŒ‡': 1,
                'æ­¦å™¨çŸ³': 1,
                'ç¡¬åŒ–è–¬': 1,
                'å¼·åŒ–è–¬': 1,
                'å¼·åŒ–ç¹Šç¶­': 1
            };
            return priorities[slot] || 1;
        }
        
        // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        function showStatistics() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            const allocations = appData.allocations[currentRaidTier.id] || [];
            
            if (Object.keys(players).length === 0) {
                showError('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¨ˆç®—
            const stats = calculateStatistics(players, allocations);
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">ãƒ¬ã‚¤ãƒ‰é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
                </div>
                
                <h1>çµ±è¨ˆæƒ…å ±</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥å–å¾—çŠ¶æ³</h3>
                    ${generatePlayerStatistics(players, allocations)}
                </div>
            `;
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥çµ±è¨ˆæƒ…å ±ç”Ÿæˆ
        function generatePlayerStatistics(players, allocations) {
            // ãƒã‚¸ã‚·ãƒ§ãƒ³é †åºã‚’å›ºå®šåŒ– (MTâ†’STâ†’H1â†’H2â†’D1â†’D2â†’D3â†’D4)
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            // è£…å‚™éƒ¨ä½é †åºã‚’å›ºå®šåŒ– (é ­â†’èƒ´â†’æ‰‹â†’è„šâ†’è¶³â†’è€³â†’é¦–â†’è…•â†’æŒ‡â†’æ­¦å™¨)
            const equipmentSlots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
            const materialSlots = ['æ­¦å™¨çŸ³', 'ç¡¬åŒ–è–¬', 'å¼·åŒ–è–¬', 'å¼·åŒ–ç¹Šç¶­'];
            
            let html = '<div class="player-stats-table">';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            html += `
                <div class="stats-header">
                    <div class="player-name-col">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
                    ${equipmentSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                    ${materialSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                </div>
            `;
            
            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œ
            positions.forEach(position => {
                const player = players[position];
                if (!player) return;
                
                // è©²å½“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å–å¾—å±¥æ­´ã‚’å–å¾—
                const playerAllocations = allocations.filter(alloc => alloc.position === position);
                const acquiredSlots = new Set(playerAllocations.map(alloc => alloc.slot));
                
                html += `
                    <div class="stats-row">
                        <div class="player-name-col">
                            <strong>${player.name}</strong><br>
                            <small>(${position})</small>
                        </div>
                `;
                
                // è£…å‚™éƒ¨ä½ã®å–å¾—çŠ¶æ³
                equipmentSlots.forEach(slot => {
                    const acquired = acquiredSlots.has(slot);
                    html += `
                        <div class="slot-col ${acquired ? 'acquired' : 'not-acquired'}">
                            ${acquired ? 'å–å¾—æ¸ˆ' : 'æœªå–å¾—'}
                        </div>
                    `;
                });
                
                // ç´ æã®å–å¾—çŠ¶æ³
                materialSlots.forEach(slot => {
                    const acquired = acquiredSlots.has(slot);
                    html += `
                        <div class="slot-col ${acquired ? 'acquired' : 'not-acquired'}">
                            ${acquired ? 'å–å¾—æ¸ˆ' : 'æœªå–å¾—'}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }
        
        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¨ˆç®—
        function calculateStatistics(players, allocations) {
            const playerStats = {};
            const slotStats = {};
            const weekStats = {};
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆåˆæœŸåŒ–
            Object.entries(players).forEach(([position, player]) => {
                playerStats[position] = {
                    name: player.name,
                    equipmentCount: 0,
                    materialCount: 0,
                    totalCount: 0,
                    dynamicPriority: player.dynamicPriority || 0
                };
            });
            
            // åˆ†é…å±¥æ­´ã‹ã‚‰çµ±è¨ˆè¨ˆç®—
            allocations.forEach(allocation => {
                const position = allocation.position;
                const slot = allocation.slot;
                const week = allocation.week;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆæ›´æ–°
                if (playerStats[position]) {
                    if (['æ­¦å™¨çŸ³', 'ç¡¬åŒ–è–¬', 'å¼·åŒ–è–¬', 'å¼·åŒ–ç¹Šç¶­'].includes(slot)) {
                        playerStats[position].materialCount++;
                    } else {
                        playerStats[position].equipmentCount++;
                    }
                    playerStats[position].totalCount++;
                }
                
                // éƒ¨ä½çµ±è¨ˆæ›´æ–°
                slotStats[slot] = (slotStats[slot] || 0) + 1;
                
                // é€±çµ±è¨ˆæ›´æ–°
                weekStats[week] = (weekStats[week] || 0) + 1;
            });
            
            return { playerStats, slotStats, weekStats };
        }
        
        // åˆ†é…å±¥æ­´è¡¨ç¤º
        function showAllocationHistory() {
            const content = document.getElementById('content');
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">ãƒ¬ã‚¤ãƒ‰é¸æŠç”»é¢ã«æˆ»ã‚‹</button>
                </div>
                
                <h1>åˆ†é…å±¥æ­´</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>å±¤:</label>
                            <select id="layerFilter" onchange="filterAllocationHistory()">
                                <option value="">å…¨ã¦</option>
                                <option value="1">1å±¤</option>
                                <option value="2">2å±¤</option>
                                <option value="3">3å±¤</option>
                                <option value="4">4å±¤</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>å–å¾—è€…:</label>
                            <select id="playerFilter" onchange="filterAllocationHistory()">
                                <option value="">å…¨ã¦</option>
                                ${Object.entries(players).map(([position, player]) => `
                                    <option value="${position}">${player.name} (${position})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>è£…å‚™éƒ¨ä½:</label>
                            <select id="slotFilter" onchange="filterAllocationHistory()">
                                <option value="">å…¨ã¦</option>
                                <option value="æ­¦å™¨">æ­¦å™¨</option>
                                <option value="é ­">é ­</option>
                                <option value="èƒ´">èƒ´</option>
                                <option value="æ‰‹">æ‰‹</option>
                                <option value="è„š">è„š</option>
                                <option value="è¶³">è¶³</option>
                                <option value="è€³">è€³</option>
                                <option value="é¦–">é¦–</option>
                                <option value="è…•">è…•</option>
                                <option value="æŒ‡">æŒ‡</option>
                                <option value="æ­¦å™¨çŸ³">æ­¦å™¨çŸ³</option>
                                <option value="ç¡¬åŒ–è–¬">ç¡¬åŒ–è–¬</option>
                                <option value="å¼·åŒ–è–¬">å¼·åŒ–è–¬</option>
                                <option value="å¼·åŒ–ç¹Šç¶­">å¼·åŒ–ç¹Šç¶­</option>
                            </select>
                        </div>
                        
                        <button onclick="clearAllFilters()" class="clear-filters-btn">
                            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>åˆ†é…å±¥æ­´ (${allocations.length}ä»¶)</h3>
                    <div id="historyTable">
                        ${generateHistoryTable(allocations, players)}
                    </div>
                </div>
            `;
        }
        
        // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
        function generateHistoryTable(allocations, players) {
            if (allocations.length === 0) {
                return '<p class="no-data">åˆ†é…å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            
            // æ—¥ä»˜é †ã§é™é †ã‚½ãƒ¼ãƒˆ
            const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            return `
                <div class="history-table">
                    <div class="history-header">
                        <div class="history-cell">æ—¥æ™‚</div>
                        <div class="history-cell">å±¤</div>
                        <div class="history-cell">è£…å‚™éƒ¨ä½</div>
                        <div class="history-cell">å–å¾—è€…</div>
                    </div>
                    ${sortedAllocations.map(allocation => {
                        const player = players[allocation.position];
                        const date = new Date(allocation.timestamp);
                        return `
                            <div class="history-row">
                                <div class="history-cell">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
                                <div class="history-cell">${allocation.layer}å±¤</div>
                                <div class="history-cell">${allocation.slot}</div>
                                <div class="history-cell">${player ? player.name : allocation.playerName} (${allocation.position})</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterAllocationHistory() {
            const layerFilter = document.getElementById('layerFilter').value;
            const playerFilter = document.getElementById('playerFilter').value;
            const slotFilter = document.getElementById('slotFilter').value;
            
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            let filteredAllocations = allocations.filter(allocation => {
                if (layerFilter && allocation.layer.toString() !== layerFilter) return false;
                if (playerFilter && allocation.position !== playerFilter) return false;
                if (slotFilter && allocation.slot !== slotFilter) return false;
                return true;
            });
            
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = generateHistoryTable(filteredAllocations, players);
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœã®ä»¶æ•°ã‚’æ›´æ–°
            const sectionTitle = document.querySelector('h3');
            sectionTitle.textContent = `åˆ†é…å±¥æ­´ (${filteredAllocations.length}ä»¶)`;
        }
        
        // å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
        function clearAllFilters() {
            document.getElementById('layerFilter').value = '';
            document.getElementById('playerFilter').value = '';
            document.getElementById('slotFilter').value = '';
            filterAllocationHistory();
        }
        
        function showSystemSettings() {
            showMessage('ã‚·ã‚¹ãƒ†ãƒ è¨­å®šæ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™', 'info');
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ff14_raid_data_${currentTeamId}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }
    </script>
</body>
</html>