<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14零式装備分配管理システム</title>
    <style>
        /* 基本スタイル */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* 同期ステータス */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-status.offline {
            background-color: #6c757d;
        }

        .sync-status.syncing {
            background-color: #f39c12;
        }

        .sync-status button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        /* ログイン画面 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
        }

        .login-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .login-form h2 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .token-input {
            margin: 20px 0;
        }

        .token-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .token-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .token-input input:focus {
            border-color: #3498db;
            outline: none;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .login-form button:hover {
            background-color: #2980b9;
        }

        .offline-btn {
            background-color: #6c757d !important;
        }

        .offline-btn:hover {
            background-color: #5a6268 !important;
        }

        .help-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .help-section summary {
            cursor: pointer;
            font-weight: 600;
            color: #3498db;
        }

        .help-section ol {
            margin-top: 10px;
            padding-left: 20px;
        }

        /* 基本ボタンスタイル */
        button {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #ffffff;
            color: #2c3e50;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* 既存機能のスタイル統合 */
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        /* レイドティア関連スタイル */
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tier-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tier-item h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .tier-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .tier-item small {
            color: #999;
            font-size: 12px;
        }

        .new-tier-form {
            margin-top: 30px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .new-tier-form h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .new-tier-form input {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .new-tier-form input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .new-tier-form button {
            background-color: #27ae60;
            margin-top: 10px;
        }

        .new-tier-form button:hover {
            background-color: #219a52;
        }

        /* デバッグ用スタイル */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; padding: 50px;">
            <h1>Loading...</h1>
            <p>システムを初期化しています...</p>
        </div>
    </div>

    <!-- デバッグ情報 -->
    <div id="debug-info" class="debug-info">
        <div>Status: <span id="debug-status">Initializing</span></div>
        <div>Auth: <span id="debug-auth">Checking</span></div>
        <div>Error: <span id="debug-error">None</span></div>
    </div>

    <!-- GitHub API連携スクリプト -->
    <script src="js/github-api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-sync.js"></script>
    
    <script>
        // デバッグ関数
        function updateDebugInfo(status, auth = null, error = null) {
            document.getElementById('debug-status').textContent = status;
            if (auth !== null) document.getElementById('debug-auth').textContent = auth;
            if (error !== null) document.getElementById('debug-error').textContent = error;
        }

        // グローバル変数
        let githubAPI = null;
        let authManager = null;
        let dataSync = null;
        let currentRaidTier = null;

        // アプリケーション初期化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                updateDebugInfo('Starting initialization');
                await initializeApp();
            } catch (error) {
                updateDebugInfo('Initialization failed', null, error.message);
                console.error('初期化エラー:', error);
                showErrorScreen('初期化に失敗しました: ' + error.message);
            }
        });

        async function initializeApp() {
            try {
                updateDebugInfo('Creating API instances');
                
                // GitHub API初期化
                githubAPI = new GitHubAPI();
                authManager = new AuthManager(githubAPI);
                dataSync = new DataSyncManager(githubAPI, authManager);
                
                updateDebugInfo('Checking authentication');

                // 認証状態確認
                if (authManager.isAuthenticated()) {
                    updateDebugInfo('Validating token');
                    const isValid = await githubAPI.validateToken();
                    if (!isValid) {
                        updateDebugInfo('Token invalid, logging out');
                        authManager.logout();
                        showLoginScreen();
                        return;
                    }
                    
                    updateDebugInfo('Loading app data', 'Authenticated');
                    // 認証済みの場合はデータを読み込んで開始
                    await loadAndStartApp();
                } else {
                    updateDebugInfo('Not authenticated', 'None');
                    // 未認証の場合はログイン画面
                    showLoginScreen();
                }
            } catch (error) {
                updateDebugInfo('Init error', null, error.message);
                console.error('初期化エラー:', error);
                showErrorScreen('初期化エラー: ' + error.message);
            }
        }

        async function loadAndStartApp() {
            try {
                updateDebugInfo('Loading data');
                
                // 同期ステータス表示
                addSyncStatusIndicator();
                
                // データ読み込み
                const data = await dataSync.loadAllData();
                currentRaidTier = data.raidTiers.find(t => t.id === data.activeRaidTierId);
                
                updateDebugInfo('Showing main screen');
                
                // メイン画面表示
                if (data.raidTiers.length === 0) {
                    showRaidTierSelection();
                } else if (currentRaidTier) {
                    showMainDashboard();
                } else {
                    showRaidTierSelection();
                }
            } catch (error) {
                updateDebugInfo('Load error', null, error.message);
                console.error('アプリ初期化エラー:', error);
                alert('アプリの初期化に失敗しました。オフラインモードで続行します。');
                showRaidTierSelection();
            }
        }

        function showLoginScreen() {
            updateDebugInfo('Showing login screen');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <div class="login-container">
                    <div class="login-form">
                        <h1>FF14零式装備分配システム</h1>
                        <h2>GitHub認証</h2>
                        <p>チームでデータを共有するためにGitHubトークンが必要です。</p>
                        
                        <div class="token-input">
                            <label for="github-token">GitHub Personal Access Token:</label>
                            <input type="password" id="github-token" placeholder="ghp_..." />
                            <button onclick="attemptLogin()">ログイン</button>
                        </div>
                        
                        <div class="help-section">
                            <details>
                                <summary>トークンの取得方法</summary>
                                <ol>
                                    <li>GitHub → Settings → Developer settings</li>
                                    <li>Personal access tokens → Tokens (classic)</li>
                                    <li>Generate new token (classic)</li>
                                    <li>repo スコープを選択して生成</li>
                                </ol>
                            </details>
                        </div>
                        
                        <button onclick="useOfflineMode()" class="offline-btn">
                            オフラインモードで続行
                        </button>
                    </div>
                </div>
            `;
        }

        function showErrorScreen(message) {
            const app = document.querySelector('.container');
            app.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h1 style="color: #e74c3c;">エラーが発生しました</h1>
                    <p style="margin: 20px 0;">${message}</p>
                    <button onclick="location.reload()">再読み込み</button>
                    <button onclick="useOfflineMode()">オフラインモードで続行</button>
                </div>
            `;
        }

        async function attemptLogin() {
            try {
                updateDebugInfo('Attempting login');
                const token = document.getElementById('github-token').value.trim();
                
                if (!token) {
                    alert('トークンを入力してください');
                    return;
                }
                
                const result = await authManager.login(token);
                
                if (result.success) {
                    updateDebugInfo('Login successful', result.user.login);
                    alert(`ログイン成功: ${result.user.login}`);
                    await loadAndStartApp();
                } else {
                    updateDebugInfo('Login failed', null, result.error);
                    alert(`ログイン失敗: ${result.error}`);
                }
            } catch (error) {
                updateDebugInfo('Login error', null, error.message);
                alert(`ログインエラー: ${error.message}`);
            }
        }

        function useOfflineMode() {
            if (confirm('オフラインモードではデータの共有ができません。続行しますか？')) {
                updateDebugInfo('Using offline mode', 'Offline');
                // オフラインモード用の初期化
                initializeOfflineMode();
                showRaidTierSelection();
                addSyncStatusIndicator();
            }
        }

        function initializeOfflineMode() {
            // オフラインモード用のデータ初期化
            const defaultData = {
                raidTiers: [],
                activeRaidTierId: null,
                players: {},
                allocations: {},
                settings: {
                    teamMembers: [],
                    permissions: {}
                }
            };
            
            // ローカルストレージに初期データがない場合は作成
            if (!localStorage.getItem('ff14_gear_data')) {
                localStorage.setItem('ff14_gear_data', JSON.stringify(defaultData));
            }
        }

        function addSyncStatusIndicator() {
            // 既存の同期ステータスを削除
            const existing = document.getElementById('sync-status');
            if (existing) existing.remove();

            const syncIndicator = document.createElement('div');
            syncIndicator.id = 'sync-status';
            syncIndicator.className = `sync-status ${authManager && authManager.isAuthenticated() ? '' : 'offline'}`;
            
            const statusText = authManager && authManager.isAuthenticated() ? 
                `🔄 ${authManager.getUsername()}` : 
                '📴 オフライン';
            
            syncIndicator.innerHTML = `
                <span id="sync-text">${statusText}</span>
                <button onclick="manualSync()" ${!authManager || !authManager.isAuthenticated() ? 'disabled' : ''}>
                    同期
                </button>
                ${authManager && authManager.isAuthenticated() ? '<button onclick="logout()">ログアウト</button>' : ''}
            `;
            
            document.body.appendChild(syncIndicator);
        }

        async function manualSync() {
            if (!authManager || !authManager.isAuthenticated()) return;
            
            const syncStatus = document.getElementById('sync-status');
            syncStatus.className = 'sync-status syncing';
            
            try {
                const data = getLocalData();
                const result = await dataSync.saveAllData(data);
                
                if (result.success) {
                    alert('同期完了');
                } else {
                    alert(`同期失敗: ${result.error}`);
                }
            } catch (error) {
                alert(`同期エラー: ${error.message}`);
            } finally {
                syncStatus.className = `sync-status ${authManager.isAuthenticated() ? '' : 'offline'}`;
            }
        }

        function logout() {
            if (confirm('ログアウトしますか？')) {
                authManager.logout();
                location.reload();
            }
        }

        // データ管理関数
        function getLocalData() {
            return dataSync ? dataSync.getLocalData() : 
                   JSON.parse(localStorage.getItem('ff14RaidData') || '{"raidTiers":[],"activeRaidTierId":null,"players":{},"allocations":{}}');
        }

        async function saveData(data) {
            // ローカルに即座に保存
            localStorage.setItem('ff14RaidData', JSON.stringify(data));
            
            // GitHub同期（認証済みの場合のみ）
            if (authManager && authManager.isAuthenticated()) {
                try {
                    await dataSync.saveAllData(data);
                } catch (error) {
                    console.error('GitHub同期エラー:', error);
                    // エラーが発生してもローカル保存は完了しているので続行
                }
            }
        }

        // レイドティア選択画面
        function showRaidTierSelection() {
            updateDebugInfo('Showing raid tier selection');
            const app = document.querySelector('.container');
            const data = getLocalData();
            const raidTiers = data.raidTiers || [];
            
            app.innerHTML = `
                <h1>FF14 零式装備分配システム</h1>
                
                <div class="section">
                    <h2>レイドティア選択</h2>
                    <div id="existing-tiers">
                        ${raidTiers.length > 0 ? `
                            <h3>既存のレイドティア</h3>
                            <div class="tier-list">
                                ${raidTiers.map(tier => `
                                    <div class="tier-item" onclick="selectRaidTier('${tier.id}')">
                                        <h4>${tier.name}</h4>
                                        <p>${tier.description || '説明なし'}</p>
                                        <small>作成日: ${new Date(tier.createdAt).toLocaleDateString('ja-JP')}</small>
                                        <div style="margin-top: 10px;">
                                            <button onclick="event.stopPropagation(); deleteRaidTier('${tier.id}', '${tier.name}')" 
                                                    style="background-color: #e74c3c; font-size: 11px; padding: 4px 8px;">
                                                削除
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>まだレイドティアが登録されていません。</p>'}
                    </div>
                    
                    <div class="new-tier-form">
                        <h3>新規レイドティア登録</h3>
                        <input type="text" id="tier-name" placeholder="レイドティア名（例：7.2零式）" required>
                        <input type="text" id="tier-description" placeholder="説明（任意）">
                        <button onclick="createNewRaidTier()">登録</button>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 14px; color: #666;">
                        ${authManager && authManager.isAuthenticated() ? 
                            '<p style="color: green;">✅ GitHub認証済み - データは自動同期されます</p>' : 
                            '<p style="color: orange;">⚠️ オフラインモード - データはローカルのみ保存</p>'
                        }
                    </div>
                </div>
            `;
        }

        // レイドティア選択
        async function selectRaidTier(tierId) {
            const data = getLocalData();
            const tier = data.raidTiers.find(t => t.id === tierId);
            
            if (tier) {
                currentRaidTier = tier;
                data.activeRaidTierId = tierId;
                await saveData(data);
                showInitialSetup();
            }
        }

        // 新規レイドティア登録
        async function createNewRaidTier() {
            const name = document.getElementById('tier-name').value.trim();
            const description = document.getElementById('tier-description').value.trim();
            
            if (!name) {
                alert('レイドティア名を入力してください。');
                return;
            }
            
            const data = getLocalData();
            if (!data.raidTiers) data.raidTiers = [];
            
            const newTier = {
                id: Date.now().toString(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                isActive: false
            };
            
            data.raidTiers.push(newTier);
            await saveData(data);
            
            // 作成後に選択
            selectRaidTier(newTier.id);
        }

        // レイドティア削除
        async function deleteRaidTier(tierId, tierName) {
            if (!confirm(`「${tierName}」を削除しますか？\n関連するデータもすべて削除されます。`)) {
                return;
            }
            
            const data = getLocalData();
            
            // レイドティア自体を削除
            data.raidTiers = data.raidTiers.filter(tier => tier.id !== tierId);
            
            // 関連データも削除
            if (data.players && data.players[tierId]) {
                delete data.players[tierId];
            }
            if (data.allocations && data.allocations[tierId]) {
                delete data.allocations[tierId];
            }
            
            // アクティブティアが削除された場合の処理
            if (data.activeRaidTierId === tierId) {
                if (data.raidTiers.length > 0) {
                    data.activeRaidTierId = data.raidTiers[0].id;
                    currentRaidTier = data.raidTiers[0];
                } else {
                    data.activeRaidTierId = null;
                    currentRaidTier = null;
                }
            }
            
            await saveData(data);
            alert(`「${tierName}」を削除しました。`);
            
            // 画面を再描画
            showRaidTierSelection();
        }

        function showMainDashboard() {
            updateDebugInfo('Showing main dashboard');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${currentRaidTier ? currentRaidTier.name : 'メイン'} - メインダッシュボード</h1>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>設定管理</h3>
                        <button onclick="showInitialSetup()">登録内容確認・変更</button>
                        <button onclick="showPositionPrioritySettings()">ポジション優先度設定</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>レイドクリア</h3>
                        <button onclick="showLayerAllocation(1)">1層クリア</button>
                        <button onclick="showLayerAllocation(2)">2層クリア</button>
                        <button onclick="showLayerAllocation(3)">3層クリア</button>
                        <button onclick="showLayerAllocation(4)">4層クリア</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>履歴・統計</h3>
                        <button onclick="showHistory()">配布履歴・装備状況</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>その他</h3>
                        <button onclick="showRaidTierSelection()">レイドティア変更</button>
                        <button onclick="exportData()">データエクスポート</button>
                        <button onclick="generateTestData()" style="background-color: #e67e22; border-color: #d35400;">🧪 テストデータ生成</button>
                    </div>
                </div>
                
                <div class="dashboard-status">
                    <h3>今週の進行状況</h3>
                    <div id="weekly-progress">
                        <p>各層のクリア状況と装備分配の進捗を表示予定</p>
                        ${authManager && authManager.isAuthenticated() ? 
                            '<p style="color: green; font-size: 12px;">✅ GitHub同期有効 - チームデータが共有されています</p>' : 
                            '<p style="color: orange; font-size: 12px;">⚠️ オフラインモード - データはローカル保存のみ</p>'
                        }
                    </div>
                </div>
            `;
            
            // ダッシュボード用スタイル追加
            if (!document.getElementById('dashboard-styles')) {
                const style = document.createElement('style');
                style.id = 'dashboard-styles';
                style.textContent = `
                    .dashboard-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 15px;
                        margin: 15px 0;
                    }
                    @media (max-width: 1400px) {
                        .dashboard-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    @media (max-width: 800px) {
                        .dashboard-grid {
                            grid-template-columns: 1fr;
                        }
                    }
                    .dashboard-card {
                        background-color: #ffffff;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        text-align: center;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    }
                    .dashboard-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    }
                    .dashboard-card h3 {
                        color: #2c3e50;
                        margin-bottom: 10px;
                        font-size: 16px;
                        font-weight: 600;
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 8px;
                    }
                    .dashboard-card button {
                        display: block;
                        width: 100%;
                        margin: 8px 0;
                        padding: 10px 8px;
                        font-size: 13px;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                    }
                    .dashboard-card button:hover {
                        transform: translateY(-1px);
                    }
                    .dashboard-status {
                        margin-top: 20px;
                        padding: 15px;
                        background-color: #f8f9fa;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .dashboard-status h3 {
                        color: #2c3e50;
                        margin-bottom: 15px;
                        font-size: 16px;
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 8px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function showInitialSetup() {
            updateDebugInfo('Showing initial setup');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>初期設定 - ${currentRaidTier ? currentRaidTier.name : 'レイドティア'}</h1>
                
                <div class="setup-navigation">
                    <button class="nav-btn active" onclick="showMemberSetup()">メンバー設定</button>
                    <button class="nav-btn" onclick="showEquipmentPolicySetup()">装備設定</button>
                    <button class="nav-btn" onclick="showWeaponWishSetup()">武器設定</button>
                    <button class="nav-btn setup-complete-btn" onclick="completeSetup()">設定完了</button>
                </div>
                
                <div id="setup-content">
                    <!-- 設定内容が動的に表示される -->
                </div>
                
                <div class="setup-actions">
                    <button onclick="showRaidTierSelection()">レイドティア選択に戻る</button>
                </div>
            `;
            
            // 初期設定のスタイル追加
            if (!document.getElementById('initial-setup-styles')) {
                const style = document.createElement('style');
                style.id = 'initial-setup-styles';
                style.textContent = `
                    .setup-navigation {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #e9ecef;
                        padding-bottom: 10px;
                    }
                    .nav-btn {
                        padding: 12px 20px;
                        background-color: #ffffff;
                        border: 1px solid #ddd;
                        color: #2c3e50;
                        cursor: pointer;
                        border-radius: 8px 8px 0 0;
                        font-size: 14px;
                        transition: all 0.2s ease;
                    }
                    .nav-btn.active {
                        background-color: #3498db;
                        color: white;
                        border-color: #3498db;
                        border-bottom: 2px solid #3498db;
                    }
                    .nav-btn:hover:not(.active) {
                        background-color: #f8f9fa;
                        border-color: #3498db;
                    }
                    .setup-complete-btn {
                        background-color: #27ae60 !important;
                        color: white !important;
                        border-color: #27ae60 !important;
                    }
                    .setup-complete-btn:hover {
                        background-color: #219a52 !important;
                    }
                    .setup-actions {
                        margin-top: 30px;
                        text-align: center;
                        padding-top: 20px;
                        border-top: 1px solid #e9ecef;
                    }
                    .member-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    .member-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .member-card h3 {
                        margin: 0 0 15px 0;
                        color: #2c3e50;
                        text-align: center;
                        font-weight: 600;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .member-card input, .member-card select {
                        width: 100%;
                        margin: 8px 0;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        box-sizing: border-box;
                        font-size: 14px;
                    }
                    .member-card input:focus, .member-card select:focus {
                        outline: none;
                        border-color: #3498db;
                        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // デフォルトでメンバー設定を表示
            showMemberSetup();
        }

        function showMemberSetup() {
            // ナビゲーションの状態更新
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>8名のメンバー設定</h2>
                    <p>固定パーティの8名の情報を入力してください。</p>
                    <div class="member-grid">
                        ${['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'].map(position => `
                            <div class="member-card">
                                <h3>${position}</h3>
                                <input type="text" id="name-${position}" placeholder="プレイヤー名" />
                                <input type="text" id="char-${position}" placeholder="キャラクター名" />
                                <select id="job-${position}">
                                    <option value="">ジョブを選択</option>
                                    ${getJobOptionsForPosition(position)}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="saveMemberSettings()" style="background-color: #27ae60; color: white; padding: 12px 30px; font-size: 16px;">
                            メンバー設定を保存
                        </button>
                    </div>
                </div>
            `;
            
            // 既存のデータがあれば復元
            loadMemberData();
        }

        function getJobOptionsForPosition(position) {
            const jobsByPosition = {
                'MT': ['ナイト', '戦士', '暗黒騎士', 'ガンブレイカー'],
                'ST': ['ナイト', '戦士', '暗黒騎士', 'ガンブレイカー'],
                'H1': ['白魔道士', '占星術士'],
                'H2': ['学者', '賢者'],
                'D1': ['モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー'],
                'D2': ['モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー'],
                'D3': ['吟遊詩人', '機工士', '踊り子', '黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー'],
                'D4': ['吟遊詩人', '機工士', '踊り子', '黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー']
            };
            
            return jobsByPosition[position].map(job => `<option value="${job}">${job}</option>`).join('');
        }

        function loadMemberData() {
            const data = getLocalData();
            if (data.players && data.players[currentRaidTier.id]) {
                const tierPlayers = data.players[currentRaidTier.id];
                for (const [position, player] of Object.entries(tierPlayers)) {
                    const nameInput = document.getElementById(`name-${position}`);
                    const charInput = document.getElementById(`char-${position}`);
                    const jobSelect = document.getElementById(`job-${position}`);
                    
                    if (nameInput) nameInput.value = player.name || '';
                    if (charInput) charInput.value = player.characterName || '';
                    if (jobSelect) jobSelect.value = player.job || '';
                }
            }
        }

        async function saveMemberSettings() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const players = {};
            
            for (const position of positions) {
                const name = document.getElementById(`name-${position}`).value.trim();
                const characterName = document.getElementById(`char-${position}`).value.trim();
                const job = document.getElementById(`job-${position}`).value;
                
                if (!name || !characterName || !job) {
                    alert(`${position}の設定が不完全です。すべての項目を入力してください。`);
                    return;
                }
                
                players[position] = {
                    id: Date.now().toString() + position,
                    name: name,
                    characterName: characterName,
                    position: position,
                    job: job,
                    equipmentPolicy: {},
                    currentEquipment: {},
                    weaponWishes: []
                };
            }
            
            // データ保存
            const data = getLocalData();
            if (!data.players) data.players = {};
            data.players[currentRaidTier.id] = players;
            
            await saveData(data);
            alert('メンバー設定を保存しました。');
        }

        function showEquipmentPolicySetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            
            const data = getLocalData();
            const players = data.players && data.players[currentRaidTier.id];
            
            if (!players || Object.keys(players).length === 0) {
                const content = document.getElementById('setup-content');
                content.innerHTML = `
                    <div class="section">
                        <h2>装備方針設定</h2>
                        <p style="color: #e74c3c;">先にメンバー設定を完了してください。</p>
                        <button onclick="showMemberSetup()">メンバー設定に戻る</button>
                    </div>
                `;
                return;
            }
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>装備方針設定</h2>
                    <p>各ポジションの装備部位ごとに「零式」または「トームストーン」を選択してください。</p>
                    
                    <div class="policy-grid">
                        ${Object.keys(players).map(position => `
                            <div class="policy-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                <div class="equipment-slots">
                                    ${['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'].map(slot => {
                                        const currentPolicy = players[position].equipmentPolicy && players[position].equipmentPolicy[slot] || '零式';
                                        return `
                                        <div class="slot-policy">
                                            <label>${slot}:</label>
                                            <select id="policy-${position}-${slot}">
                                                <option value="零式" ${currentPolicy === '零式' ? 'selected' : ''} style="background-color: #e8f5e8;">零式</option>
                                                <option value="トームストーン" ${currentPolicy === 'トームストーン' ? 'selected' : ''} style="background-color: #f0f8ff;">トームストーン</option>
                                            </select>
                                        </div>
                                    `;}).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="policy-actions">
                        <button onclick="setAllToSavage()">全て零式に設定</button>
                        <button onclick="setAllToTomestone()">全てトームストーンに設定</button>
                        <button onclick="saveEquipmentPolicy()" style="background-color: #27ae60;">装備方針を保存</button>
                    </div>
                </div>
            `;
            
            // 装備方針設定のスタイル追加
            if (!document.getElementById('policy-styles')) {
                const style = document.createElement('style');
                style.id = 'policy-styles';
                style.textContent = `
                    .policy-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    @media (max-width: 1200px) {
                        .policy-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    .policy-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .policy-card h3 {
                        margin: 0 0 8px 0;
                        color: #2c3e50;
                        font-weight: 600;
                        text-align: center;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .policy-card small {
                        display: block;
                        text-align: center;
                        color: #666;
                        margin-bottom: 15px;
                    }
                    .equipment-slots {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 8px;
                    }
                    .slot-policy {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .slot-policy label {
                        width: 50px;
                        font-size: 12px;
                        font-weight: 600;
                        color: #2c3e50;
                    }
                    .slot-policy select {
                        flex: 1;
                        padding: 6px;
                        margin: 0;
                        font-size: 12px;
                        border-radius: 4px;
                        border: 1px solid #ddd;
                    }
                    .policy-actions {
                        text-align: center;
                        margin-top: 20px;
                        padding-top: 15px;
                        border-top: 1px solid #e9ecef;
                    }
                    .policy-actions button {
                        margin: 0 5px;
                        padding: 10px 20px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function setAllToSavage() {
            const selects = document.querySelectorAll('select[id^="policy-"]');
            selects.forEach(select => {
                select.value = '零式';
            });
        }

        function setAllToTomestone() {
            const selects = document.querySelectorAll('select[id^="policy-"]');
            selects.forEach(select => {
                select.value = 'トームストーン';
            });
        }

        async function saveEquipmentPolicy() {
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            const slots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
            
            for (const position of Object.keys(players)) {
                if (!players[position].equipmentPolicy) {
                    players[position].equipmentPolicy = {};
                }
                
                for (const slot of slots) {
                    const selectElement = document.getElementById(`policy-${position}-${slot}`);
                    if (selectElement) {
                        players[position].equipmentPolicy[slot] = selectElement.value;
                    }
                }
            }
            
            await saveData(data);
            alert('装備方針を保存しました。');
        }

        function showWeaponWishSetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[2].classList.add('active');
            
            const data = getLocalData();
            const players = data.players && data.players[currentRaidTier.id];
            
            if (!players || Object.keys(players).length === 0) {
                const content = document.getElementById('setup-content');
                content.innerHTML = `
                    <div class="section">
                        <h2>武器希望設定</h2>
                        <p style="color: #e74c3c;">先にメンバー設定を完了してください。</p>
                        <button onclick="showMemberSetup()">メンバー設定に戻る</button>
                    </div>
                `;
                return;
            }
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>4層直ドロップ武器希望設定</h2>
                    <p>4層でランダムドロップする武器への希望を各プレイヤーが登録できます。優先順位も設定してください。</p>
                    
                    <div class="weapon-wish-grid">
                        ${Object.keys(players).map(position => `
                            <div class="wish-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                
                                <div class="current-wishes" id="wishes-${position}">
                                    <!-- 現在の希望リスト -->
                                </div>
                                
                                <div class="add-wish">
                                    <select id="job-wish-${position}">
                                        <option value="">希望ジョブを選択</option>
                                        ${getAllJobOptions()}
                                    </select>
                                    <input type="number" id="priority-${position}" placeholder="優先度" min="1" max="10" value="1">
                                    <button onclick="addWeaponWish('${position}')" style="background-color: #27ae60; padding: 8px 12px; font-size: 12px;">追加</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="weapon-actions">
                        <button onclick="saveWeaponWishes()" style="background-color: #27ae60;">武器希望を保存</button>
                    </div>
                </div>
            `;
            
            // 武器希望設定のスタイル追加
            if (!document.getElementById('weapon-styles')) {
                const style = document.createElement('style');
                style.id = 'weapon-styles';
                style.textContent = `
                    .weapon-wish-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    @media (max-width: 1200px) {
                        .weapon-wish-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    .wish-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .wish-card h3 {
                        margin: 0 0 8px 0;
                        color: #2c3e50;
                        font-weight: 600;
                        text-align: center;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .wish-card small {
                        display: block;
                        text-align: center;
                        color: #666;
                        margin-bottom: 15px;
                    }
                    .current-wishes {
                        min-height: 60px;
                        margin-bottom: 15px;
                        padding: 10px;
                        border: 1px solid #e9ecef;
                        border-radius: 4px;
                        background-color: #f8f9fa;
                    }
                    .wish-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 6px 10px;
                        margin: 4px 0;
                        background-color: #ffffff;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-size: 12px;
                    }
                    .wish-priority {
                        background-color: #3498db;
                        color: white;
                        padding: 2px 6px;
                        border-radius: 3px;
                        font-size: 10px;
                        font-weight: bold;
                    }
                    .remove-wish {
                        background-color: #95a5a6;
                        color: white;
                        border: none;
                        padding: 2px 6px;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 10px;
                    }
                    .remove-wish:hover {
                        background-color: #7f8c8d;
                    }
                    .add-wish {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                        flex-wrap: wrap;
                    }
                    .add-wish select {
                        flex: 1;
                        min-width: 120px;
                        padding: 6px;
                        margin: 0;
                        font-size: 12px;
                    }
                    .add-wish input {
                        width: 60px;
                        padding: 6px;
                        margin: 0;
                        font-size: 12px;
                    }
                    .weapon-actions {
                        text-align: center;
                        margin-top: 20px;
                        padding-top: 15px;
                        border-top: 1px solid #e9ecef;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 既存の希望を表示
            Object.keys(players).forEach(position => {
                updateWishDisplay(position);
            });
        }

        function getAllJobOptions() {
            const allJobs = [
                'ナイト', '戦士', '暗黒騎士', 'ガンブレイカー',
                '白魔道士', '占星術士', '学者', '賢者',
                'モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー',
                '吟遊詩人', '機工士', '踊り子', '黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー'
            ];
            
            return allJobs.map(job => `<option value="${job}">${job}</option>`).join('');
        }

        function addWeaponWish(position) {
            const jobSelect = document.getElementById(`job-wish-${position}`);
            const priorityInput = document.getElementById(`priority-${position}`);
            
            const job = jobSelect.value;
            const priority = parseInt(priorityInput.value) || 1;
            
            if (!job) {
                alert('希望ジョブを選択してください。');
                return;
            }
            
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            
            if (!players[position].weaponWishes) {
                players[position].weaponWishes = [];
            }
            
            // 重複チェック
            if (players[position].weaponWishes.some(wish => wish.job === job)) {
                alert('そのジョブは既に登録されています。');
                return;
            }
            
            players[position].weaponWishes.push({
                job: job,
                priority: priority,
                addedAt: new Date().toISOString()
            });
            
            // 優先度でソート
            players[position].weaponWishes.sort((a, b) => a.priority - b.priority);
            
            // 表示更新
            updateWishDisplay(position);
            
            // フォームリセット
            jobSelect.value = '';
            priorityInput.value = '1';
        }

        function removeWeaponWish(position, job) {
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            
            players[position].weaponWishes = players[position].weaponWishes.filter(wish => wish.job !== job);
            
            updateWishDisplay(position);
        }

        function updateWishDisplay(position) {
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            const wishesContainer = document.getElementById(`wishes-${position}`);
            
            if (!players[position].weaponWishes || players[position].weaponWishes.length === 0) {
                wishesContainer.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center;">希望武器なし</p>';
                return;
            }
            
            wishesContainer.innerHTML = players[position].weaponWishes.map(wish => `
                <div class="wish-item">
                    <span>${wish.job}</span>
                    <div>
                        <span class="wish-priority">優先度: ${wish.priority}</span>
                        <button class="remove-wish" onclick="removeWeaponWish('${position}', '${wish.job}')">削除</button>
                    </div>
                </div>
            `).join('');
        }

        async function saveWeaponWishes() {
            const data = getLocalData();
            await saveData(data);
            alert('武器希望を保存しました。');
        }

        function completeSetup() {
            if (confirm('設定を完了してメインダッシュボードに移動しますか？')) {
                showMainDashboard();
            }
        }

        // ダッシュボードから呼び出される機能の実装

        function showPositionPrioritySettings() {
            updateDebugInfo('Showing position priority settings');
            const app = document.querySelector('.container');
            
            // 現在の設定を取得
            const data = getLocalData();
            const currentPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id] || getDefaultPositionPriorities();
            
            app.innerHTML = `
                <h1>ポジション別優先度設定</h1>
                
                <div class="section">
                    <h2>優先度設定の説明</h2>
                    <p>各ポジションの優先度を数値で設定します。数値が高いほど装備分配での優先度が高くなります。</p>
                    <p>装備方針（零式/トームストーン）の優先度と合算して最終判定を行います。</p>
                </div>
                
                <div class="section">
                    <h2>ポジション別優先度</h2>
                    <div class="priority-settings-grid">
                        <div class="priority-group">
                            <h3>タンク</h3>
                            <div class="priority-item">
                                <label>MT:</label>
                                <input type="number" id="priority-MT" value="${currentPriorities.MT || 30}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>ST:</label>
                                <input type="number" id="priority-ST" value="${currentPriorities.ST || 25}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>ヒーラー</h3>
                            <div class="priority-item">
                                <label>H1:</label>
                                <input type="number" id="priority-H1" value="${currentPriorities.H1 || 20}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>H2:</label>
                                <input type="number" id="priority-H2" value="${currentPriorities.H2 || 15}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>DPS</h3>
                            <div class="priority-item">
                                <label>D1:</label>
                                <input type="number" id="priority-D1" value="${currentPriorities.D1 || 10}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D2:</label>
                                <input type="number" id="priority-D2" value="${currentPriorities.D2 || 10}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D3:</label>
                                <input type="number" id="priority-D3" value="${currentPriorities.D3 || 5}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D4:</label>
                                <input type="number" id="priority-D4" value="${currentPriorities.D4 || 5}" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="priority-presets">
                        <h3>プリセット設定</h3>
                        <button onclick="setDPSPriority()">DPS優先</button>
                        <button onclick="setTankPriority()">タンク優先</button>
                        <button onclick="setBalancedPriority()">バランス型</button>
                        <button onclick="resetToDefaultPriorities()">デフォルト</button>
                    </div>
                    
                    <div class="section-actions">
                        <button onclick="savePositionPriorities()" style="background-color: #27ae60; color: white;">設定を保存</button>
                    </div>
                </div>
                
                <div class="section-actions">
                    <button onclick="showMainDashboard()">ダッシュボードに戻る</button>
                </div>
            `;
            
            // 優先度設定用CSS
            if (!document.getElementById('priority-styles')) {
                const style = document.createElement('style');
                style.id = 'priority-styles';
                style.textContent = `
                    .priority-settings-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 15px;
                        margin: 15px 0;
                    }
                    @media (max-width: 800px) {
                        .priority-settings-grid {
                            grid-template-columns: 1fr;
                        }
                    }
                    .priority-group {
                        background-color: #ffffff;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .priority-group h3 {
                        margin: 0 0 15px 0;
                        color: #2c3e50;
                        text-align: center;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .priority-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin: 10px 0;
                    }
                    .priority-item label {
                        font-weight: bold;
                        min-width: 30px;
                    }
                    .priority-item input {
                        width: 60px;
                        text-align: center;
                        padding: 6px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                    }
                    .priority-presets {
                        margin: 20px 0;
                        text-align: center;
                    }
                    .priority-presets button {
                        margin: 0 5px;
                        padding: 8px 15px;
                        font-size: 12px;
                    }
                    .section-actions {
                        text-align: center;
                        margin: 20px 0;
                        padding-top: 15px;
                        border-top: 1px solid #e9ecef;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function getDefaultPositionPriorities() {
            return {
                MT: 30, ST: 25,
                H1: 20, H2: 15,
                D1: 10, D2: 10, D3: 5, D4: 5
            };
        }

        function setDPSPriority() {
            document.getElementById('priority-D1').value = 40;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 30;
            document.getElementById('priority-D4').value = 25;
            document.getElementById('priority-MT').value = 20;
            document.getElementById('priority-ST').value = 15;
            document.getElementById('priority-H1').value = 10;
            document.getElementById('priority-H2').value = 5;
        }

        function setTankPriority() {
            document.getElementById('priority-MT').value = 40;
            document.getElementById('priority-ST').value = 35;
            document.getElementById('priority-H1').value = 25;
            document.getElementById('priority-H2').value = 20;
            document.getElementById('priority-D1').value = 15;
            document.getElementById('priority-D2').value = 10;
            document.getElementById('priority-D3').value = 5;
            document.getElementById('priority-D4').value = 3;
        }

        function setBalancedPriority() {
            document.getElementById('priority-MT').value = 25;
            document.getElementById('priority-ST').value = 25;
            document.getElementById('priority-H1').value = 20;
            document.getElementById('priority-H2').value = 20;
            document.getElementById('priority-D1').value = 15;
            document.getElementById('priority-D2').value = 15;
            document.getElementById('priority-D3').value = 10;
            document.getElementById('priority-D4').value = 10;
        }

        function resetToDefaultPriorities() {
            const defaults = getDefaultPositionPriorities();
            Object.keys(defaults).forEach(position => {
                document.getElementById(`priority-${position}`).value = defaults[position];
            });
        }

        async function savePositionPriorities() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const priorities = {};
            
            for (const position of positions) {
                const value = document.getElementById(`priority-${position}`).value;
                priorities[position] = parseInt(value) || 0;
            }
            
            const data = getLocalData();
            if (!data.positionPriorities) data.positionPriorities = {};
            data.positionPriorities[currentRaidTier.id] = priorities;
            
            await saveData(data);
            alert('ポジション優先度を保存しました。');
        }

        function showLayerAllocation(layer) {
            updateDebugInfo(`Showing layer ${layer} allocation`);
            const app = document.querySelector('.container');
            
            try {
                const data = getLocalData();
                
                if (!currentRaidTier || !currentRaidTier.id) {
                    app.innerHTML = `
                        <h1>エラー</h1>
                        <div class="section">
                            <p style="color: #e74c3c;">レイドティアが選択されていません。</p>
                            <button onclick="showMainDashboard()">ダッシュボードに戻る</button>
                        </div>
                    `;
                    return;
                }
                
                const players = data.players && data.players[currentRaidTier.id];
                
                if (!players || Object.keys(players).length === 0) {
                    app.innerHTML = `
                        <h1>${layer}層装備分配</h1>
                        <div class="section">
                            <p style="color: #e74c3c;">先にメンバー設定を完了してください。</p>
                            <button onclick="showMainDashboard()">ダッシュボードに戻る</button>
                        </div>
                    `;
                    return;
                }
                
                // 正常な場合のHTML描画
                app.innerHTML = `
                    <h1>${currentRaidTier.name} - ${layer}層クリア確認</h1>
                    
                    <div class="allocation-navigation">
                        <button onclick="showMainDashboard()">ダッシュボードに戻る</button>
                        <button onclick="generateLayerDropsAndProcess(${layer})" class="refresh-btn">分配結果を再計算</button>
                        <button onclick="generateTestData()" class="test-btn">テストデータ生成</button>
                    </div>
                    
                    <div class="layer-content-grid">
                        <div class="section layer-drops-section">
                            <h2>${layer}層ドロップ</h2>
                            <div id="fixed-drops">
                                <!-- ドロップアイテムがここに表示される -->
                            </div>
                        </div>
                        
                        <div class="section layer-results-section">
                            <h2>自動分配結果</h2>
                            <div id="allocation-summary">
                                <!-- 分配結果がここに表示される -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="allocation-actions">
                        <button onclick="confirmAndSaveAllocation(${layer})" class="confirm-btn">この結果で確定・保存</button>
                    </div>
                `;
            
                // 層別装備分配用CSS
                if (!document.getElementById('allocation-styles')) {
                    const style = document.createElement('style');
                    style.id = 'allocation-styles';
                    style.textContent = `
                        .layer-content-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin: 15px 0;
                        }
                        @media (max-width: 1200px) {
                            .layer-content-grid {
                                grid-template-columns: 1fr;
                            }
                        }
                        .layer-drops-section, .layer-results-section {
                            min-height: 300px;
                        }
                        .allocation-navigation {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 15px;
                            padding-bottom: 8px;
                            border-bottom: 2px solid #e9ecef;
                            flex-wrap: wrap;
                            gap: 10px;
                        }
                        .allocation-navigation button {
                            padding: 8px 12px;
                            font-size: 14px;
                            flex: 0 0 auto;
                        }
                        .refresh-btn {
                            background-color: #9b59b6 !important;
                        }
                        .test-btn {
                            background-color: #e74c3c !important;
                        }
                        .confirm-btn {
                            background-color: #27ae60 !important;
                            padding: 15px 30px !important;
                            font-size: 16px !important;
                            color: white !important;
                        }
                        .fixed-drop-item {
                            background-color: #ffffff;
                            padding: 15px;
                            margin: 10px 0;
                            border-radius: 8px;
                            border: 1px solid #e9ecef;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        .fixed-drop-item h4 {
                            margin: 0;
                            color: #2c3e50;
                            font-weight: 600;
                        }
                        .fixed-drop-item p {
                            margin: 5px 0 0 0;
                            color: #666;
                            font-size: 14px;
                        }
                        .allocation-header-compact {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 8px 12px;
                            background-color: #3498db;
                            color: white;
                            font-weight: 600;
                            font-size: 13px;
                            border-radius: 6px 6px 0 0;
                            margin-bottom: 2px;
                        }
                        .allocation-result-compact {
                            border: 1px solid #ddd;
                            border-radius: 0 0 6px 6px;
                            margin-bottom: 8px;
                            background-color: white;
                        }
                        .item-allocation-row {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 12px;
                        }
                        .item-name-compact {
                            font-weight: bold;
                            color: #2c3e50;
                            font-size: 14px;
                        }
                        .allocation-status {
                            text-align: center;
                        }
                        .auto-result {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 13px;
                            font-weight: 500;
                            background-color: #e8f5e8;
                            color: #27ae60;
                            border: 1px solid #27ae60;
                        }
                        .auto-result.freelot {
                            background-color: #fff3cd;
                            color: #856404;
                            border-color: #ffc107;
                        }
                        .manual-selection-compact select {
                            width: 100%;
                            padding: 6px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 13px;
                        }
                        .direct-weapon-section {
                            background-color: #f8f9fa;
                            border: 2px solid #3498db;
                            border-radius: 8px;
                            padding: 20px;
                            margin-top: 20px;
                        }
                        .direct-weapon-section h3 {
                            margin: 0 0 15px 0;
                            color: #2c3e50;
                        }
                        .weapon-selection {
                            margin-bottom: 15px;
                        }
                        .weapon-selection label {
                            display: block;
                            margin-bottom: 8px;
                            font-weight: 600;
                        }
                        .weapon-selection select {
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 14px;
                        }
                        .direct-weapon-compact {
                            background-color: #f8f9fa;
                            border: 2px solid #3498db;
                            border-radius: 6px;
                            margin-top: 10px;
                        }
                        .weapon-header-compact {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 8px 12px;
                            background-color: #3498db;
                            color: white;
                            font-weight: 600;
                            font-size: 13px;
                            border-radius: 4px 4px 0 0;
                            margin-bottom: 0;
                        }
                        .weapon-allocation-row {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 12px;
                        }
                        .weapon-name-compact {
                            font-weight: bold;
                            color: #2c3e50;
                            font-size: 14px;
                        }
                        .weapon-status {
                            text-align: center;
                        }
                        .weapon-selection-compact select {
                            width: 100%;
                            padding: 6px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 13px;
                        }
                    `;
                    document.head.appendChild(style);
                }
            
                // HTMLの描画完了後に処理を実行
                setTimeout(() => {
                    const fixedDropsEl = document.getElementById('fixed-drops');
                    const summaryEl = document.getElementById('allocation-summary');
                    
                    if (fixedDropsEl && summaryEl) {
                        generateLayerDropsAndProcess(layer);
                    } else {
                        alert('DOM要素が見つかりません。手動で「分配結果を再計算」ボタンを押してください。');
                    }
                }, 200);
                
            } catch (error) {
                console.error('Layer allocation error:', error);
                app.innerHTML = `
                    <h1>エラー</h1>
                    <div class="section">
                        <p style="color: #e74c3c;">エラーが発生しました: ${error.message}</p>
                        <button onclick="showMainDashboard()">ダッシュボードに戻る</button>
                    </div>
                `;
            }
        }

        function showHistory() {
            updateDebugInfo('Showing history');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${currentRaidTier ? currentRaidTier.name : 'レイド'} - 配布履歴・装備状況</h1>
                <div class="section">
                    <h2>履歴・統計システム</h2>
                    <p>🚧 開発中：配布履歴と装備状況の表示機能を実装予定</p>
                    
                    <button onclick="showMainDashboard()">ダッシュボードに戻る</button>
                </div>
            `;
        }

        function exportData() {
            try {
                const data = getLocalData();
                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ff14_gear_data_${currentRaidTier ? currentRaidTier.name : 'backup'}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('データをエクスポートしました。');
            } catch (error) {
                alert('エクスポートに失敗しました: ' + error.message);
            }
        }

        function generateTestData() {
            if (confirm('テスト用のサンプルデータを生成しますか？\n既存のデータは上書きされます。')) {
                const testTier = {
                    id: 'test_' + Date.now(),
                    name: 'テスト用7.2零式',
                    description: 'サンプルデータ付きテスト環境',
                    createdAt: new Date().toISOString()
                };
                
                const data = getLocalData();
                if (!data.raidTiers) data.raidTiers = [];
                data.raidTiers.push(testTier);
                data.activeRaidTierId = testTier.id;
                
                // テスト用メンバーデータ
                if (!data.players) data.players = {};
                data.players[testTier.id] = {
                    MT: { name: 'テストMT', characterName: 'サンプルタンク', job: 'ナイト', position: 'MT', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    ST: { name: 'テストST', characterName: 'サンプル戦士', job: '戦士', position: 'ST', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    H1: { name: 'テストH1', characterName: 'サンプル白', job: '白魔道士', position: 'H1', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    H2: { name: 'テストH2', characterName: 'サンプル学者', job: '学者', position: 'H2', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D1: { name: 'テストD1', characterName: 'サンプル竜騎士', job: '竜騎士', position: 'D1', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D2: { name: 'テストD2', characterName: 'サンプル忍者', job: '忍者', position: 'D2', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D3: { name: 'テストD3', characterName: 'サンプル黒魔', job: '黒魔道士', position: 'D3', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D4: { name: 'テストD4', characterName: 'サンプル詩人', job: '吟遊詩人', position: 'D4', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} }
                };
                
                localStorage.setItem('ff14RaidData', JSON.stringify(data));
                currentRaidTier = testTier;
                
                alert('テストデータを生成しました。');
                showMainDashboard();
            }
        }

        // 分配システムのグローバル変数
        let currentDropItems = [];
        let allocationResults = [];

        // 層別ドロップ生成と分配処理
        function generateLayerDropsAndProcess(layer) {
            try {
                const layerDrops = {
                    1: [
                        { slot: '耳', name: '耳 - イヤリングチェスト', itemLevel: 730, type: 'accessory' },
                        { slot: '首', name: '首 - ネックレスチェスト', itemLevel: 730, type: 'accessory' },
                        { slot: '腕', name: '腕 - ブレスレットチェスト', itemLevel: 730, type: 'accessory' },
                        { slot: '指', name: '指 - リングチェスト', itemLevel: 730, type: 'accessory' }
                    ],
                    2: [
                        { slot: '頭', name: '頭 - ヘッドギアチェスト', itemLevel: 730, type: 'armor' },
                        { slot: '手', name: '手 - ハンドギアチェスト', itemLevel: 730, type: 'armor' },
                        { slot: '足', name: '足 - フットギアチェスト', itemLevel: 730, type: 'armor' },
                        { slot: '武器石', name: '武器石', itemLevel: 1, type: 'material' },
                        { slot: '硬化薬', name: '硬化薬', itemLevel: 1, type: 'material' }
                    ],
                    3: [
                        { slot: '胴', name: '胴 - ボディギアチェスト', itemLevel: 730, type: 'armor' },
                        { slot: '脚', name: '脚 - レッグギアチェスト', itemLevel: 730, type: 'armor' },
                        { slot: '強化薬', name: '強化薬', itemLevel: 1, type: 'material' },
                        { slot: '強化繊維', name: '強化繊維', itemLevel: 1, type: 'material' }
                    ],
                    4: [
                        { slot: '武器', name: '武器 - ウェポンチェスト', itemLevel: 735, type: 'weapon_box' },
                        { slot: 'マウント', name: 'マウント', itemLevel: 1, type: 'mount' }
                    ]
                };
                
                // 固定ドロップを設定
                currentDropItems = layerDrops[layer] || [];
                
                // 4層の場合は直ドロップ武器選択機能を追加
                if (layer === 4) {
                    displayFixedDropsWithDirectWeapon(currentDropItems, layer);
                } else {
                    // 固定ドロップ表示
                    displayFixedDrops(currentDropItems);
                    // 即座に分配処理を実行
                    processAllocationImmediate(layer);
                }
            } catch (error) {
                console.error('ドロップ生成エラー:', error);
                alert('エラーが発生しました: ' + error.message);
            }
        }

        // 固定ドロップ表示
        function displayFixedDrops(dropItems) {
            const container = document.getElementById('fixed-drops');
            if (!container) return;
            
            container.innerHTML = dropItems.map(item => `
                <div class="fixed-drop-item">
                    <div>
                        <h4>${item.name}</h4>
                        <p>${item.slot}</p>
                    </div>
                    <div style="color: #3498db; font-weight: bold;">
                        固定ドロップ
                    </div>
                </div>
            `).join('');
        }

        // 4層専用の表示関数（直ドロップ武器選択機能付き）
        function displayFixedDropsWithDirectWeapon(dropItems, layer) {
            const container = document.getElementById('fixed-drops');
            if (!container) return;
            
            const allJobs = [
                'ナイト', '戦士', '暗黒騎士', 'ガンブレイカー',
                '白魔道士', '占星術師', '学者', '賢者',
                'モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー',
                '吟遊詩人', '機工士', '踊り子',
                '黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー'
            ];
            
            container.innerHTML = `
                ${dropItems.map(item => `
                    <div class="fixed-drop-item">
                        <div>
                            <h4>${item.name}</h4>
                            <p>${item.slot}</p>
                        </div>
                        <div style="color: #3498db; font-weight: bold;">
                            固定ドロップ
                        </div>
                    </div>
                `).join('')}
                
                <div class="direct-weapon-section">
                    <h3>4層直ドロップ武器設定</h3>
                    <div class="weapon-selection">
                        <label for="direct-weapon-select">ドロップした武器を選択してください：</label>
                        <select id="direct-weapon-select" onchange="onDirectWeaponSelected(${layer})">
                            <option value="">武器を選択...</option>
                            ${allJobs.map(job => `<option value="${job}">${job}武器</option>`).join('')}
                        </select>
                    </div>
                    <div id="direct-weapon-result" style="margin-top: 15px;">
                        <!-- 武器選択後に取得予定者が表示される -->
                    </div>
                </div>
            `;
            
            // 固定ドロップのみで分配処理を実行
            processAllocationImmediate(layer);
        }

        // 直ドロップ武器選択時の処理
        function onDirectWeaponSelected(layer) {
            const selectedJob = document.getElementById('direct-weapon-select').value;
            const resultDiv = document.getElementById('direct-weapon-result');
            
            if (!selectedJob) {
                resultDiv.innerHTML = '';
                return;
            }
            
            // 直ドロップ武器アイテムを作成
            const directWeapon = {
                slot: '武器',
                name: `${selectedJob}武器`,
                itemLevel: 735,
                type: 'direct_weapon'
            };
            
            // プレイヤーデータ取得
            const data = getLocalData();
            const players = Object.values(data.players[currentRaidTier.id]);
            
            // 武器の分配処理を実行
            const allocationResult = processDirectDropWeaponSimple(directWeapon, players);
            
            // 結果を表示
            resultDiv.innerHTML = `
                <div class="direct-weapon-compact">
                    <div class="weapon-header-compact">
                        <div class="header-item">アイテム</div>
                        <div class="header-predicted">取得予定者</div>
                        <div class="header-actual">実際の取得者</div>
                    </div>
                    <div class="weapon-allocation-row">
                        <div class="weapon-name-compact">${selectedJob}武器</div>
                        <div class="weapon-status">
                            ${allocationResult.winner ? `
                                <span class="auto-result">${allocationResult.winner.position} - ${allocationResult.winner.characterName}</span>
                            ` : `
                                <span class="auto-result freelot">フリーロット</span>
                            `}
                        </div>
                        <div class="weapon-selection-compact">
                            <select id="manual-weapon-winner" onchange="updateManualWeaponWinner('${selectedJob}')">
                                <option value="">取得者を選択...</option>
                                ${players.map(player => `
                                    <option value="${player.position}" 
                                        ${allocationResult.winner && allocationResult.winner.position === player.position ? 'selected' : ''}>
                                        ${player.position} - ${player.characterName}
                                    </option>
                                `).join('')}
                                <option value="discard" ${!allocationResult.winner ? 'selected' : ''}>分解・保管</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            // 直ドロップ武器を現在のドロップアイテムに追加（一時的）
            const weaponIndex = currentDropItems.findIndex(item => item.type === 'direct_weapon');
            if (weaponIndex >= 0) {
                currentDropItems[weaponIndex] = directWeapon;
            } else {
                currentDropItems.push(directWeapon);
            }
            
            // 全体の分配結果を更新
            processAllocationImmediate(layer);
        }

        // 分配処理実行（即座に実行版）
        function processAllocationImmediate(layer) {
            const data = getLocalData();
            const players = Object.values(data.players[currentRaidTier.id]);
            
            allocationResults = [];
            
            currentDropItems.forEach((item, index) => {
                let allocationResult;
                
                // 4層直ドロップ武器の特別処理
                if (item.type === 'direct_weapon') {
                    allocationResult = processDirectDropWeaponSimple(item, players);
                } else {
                    // 装備方針データをプレイヤーデータから構築
                    const gearPolicies = {};
                    players.forEach(player => {
                        gearPolicies[player.position] = player.equipmentPolicy || {};
                    });
                    
                    // 新しい判定システムを使用
                    allocationResult = processEquipmentWithNewSystem(item, players, gearPolicies);
                }
                
                allocationResults.push(allocationResult);
            });
            
            displayAllocationResults();
        }

        // 装備優先度計算システム
        function calculateEquipmentPriority(player, equipment, gearPolicies) {
            const slot = equipment.slot || getSlotFromEquipmentName(equipment.name);
            const playerGearPolicy = gearPolicies && gearPolicies[player.position] && gearPolicies[player.position][slot];
            
            // 現在装備との比較
            const currentEquipment = player.currentEquipment && player.currentEquipment[slot];
            const isUpgrade = !currentEquipment || equipment.itemLevel > (currentEquipment.itemLevel || 0);
            
            // 既により良い装備を持っている場合はPass
            if (!isUpgrade) {
                return {
                    totalPriority: 0,
                    gearPolicyPriority: 0,
                    rolePriority: 0,
                    gearPolicy: playerGearPolicy || '零式(デフォルト)',
                    judgment: 'Pass',
                    reason: `既により良い装備を装備済み (IL${currentEquipment?.itemLevel || 0} → IL${equipment.itemLevel})`
                };
            }
            
            // 装備方針による優先度（未設定の場合は零式扱い）
            const gearPolicyPriority = (playerGearPolicy === '零式' || !playerGearPolicy) ? 100 : 50;
            
            // カスタムポジション優先度を取得
            const data = getLocalData();
            const customPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id];
            
            let rolePriority;
            if (customPriorities && customPriorities[player.position]) {
                rolePriority = customPriorities[player.position];
            } else {
                // デフォルト優先度
                const defaultRolePriorities = {
                    'D1': 30, 'D2': 30,    // DPS高優先度
                    'D3': 25, 'D4': 25,    // DPS中優先度
                    'MT': 20, 'ST': 20,    // タンク
                    'H1': 10, 'H2': 10     // ヒーラー
                };
                rolePriority = defaultRolePriorities[player.position] || 0;
            }
            
            // 総合優先度 = 装備方針優先度 + ポジション優先度
            const totalPriority = gearPolicyPriority + rolePriority;
            
            return {
                totalPriority,
                gearPolicyPriority,
                rolePriority,
                gearPolicy: playerGearPolicy || '零式(デフォルト)',
                judgment: totalPriority >= 100 ? 'Need' : totalPriority >= 50 ? 'Greed' : 'Pass',
                reason: isUpgrade ? `アップグレード (IL${currentEquipment?.itemLevel || 0} → IL${equipment.itemLevel})` : ''
            };
        }

        // 新しい装備分配処理
        function processEquipmentWithNewSystem(equipment, allPlayers, gearPolicies) {
            // 全プレイヤーの優先度を計算
            const playerPriorities = allPlayers.map(player => {
                const priority = calculateEquipmentPriority(player, equipment, gearPolicies);
                return {
                    player: player,
                    ...priority
                };
            });
            
            // 判定別に分類
            const needPlayers = playerPriorities.filter(p => p.judgment === 'Need').sort((a, b) => b.totalPriority - a.totalPriority);
            const greedPlayers = playerPriorities.filter(p => p.judgment === 'Greed').sort((a, b) => b.totalPriority - a.totalPriority);
            const passPlayers = playerPriorities.filter(p => p.judgment === 'Pass');
            
            // 勝者決定
            let winner = null;
            let reason = '';
            
            if (needPlayers.length > 0) {
                winner = needPlayers[0].player;
                reason = `Need判定 (装備方針: ${needPlayers[0].gearPolicy}, 優先度: ${needPlayers[0].totalPriority})`;
            } else if (greedPlayers.length > 0) {
                winner = greedPlayers[0].player;
                reason = `Greed判定 (装備方針: ${greedPlayers[0].gearPolicy}, 優先度: ${greedPlayers[0].totalPriority})`;
            } else {
                reason = '全員Pass判定 (分解・保管)';
            }
            
            return {
                equipment: equipment,
                winner: winner,
                reason: reason,
                allJudgments: playerPriorities.map(p => ({
                    player: p.player,
                    judgment: p.judgment,
                    priority: p.totalPriority,
                    gearPolicy: p.gearPolicy,
                    reason: p.reason || ''
                })),
                needCount: needPlayers.length,
                greedCount: greedPlayers.length,
                passCount: passPlayers.length
            };
        }

        // 4層直ドロップ武器の特別処理
        function processDirectDropWeaponSimple(equipment, allPlayers) {
            const droppedWeaponJob = extractJobFromWeaponName(equipment.name);
            
            // 1. 登録ジョブに該当 & 武器未取得のプレイヤーを検索
            const primaryCandidates = allPlayers.filter(player => {
                const hasWeaponWish = player.weaponWishes && player.weaponWishes.some(wish => wish.job === droppedWeaponJob);
                const hasWeapon = playerHasWeaponForJobSimple(player, droppedWeaponJob);
                return hasWeaponWish && !hasWeapon;
            });

            if (primaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(primaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: '登録ジョブ該当・武器未取得',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: primaryCandidates.includes(p) ? 'Need' : 'Pass' 
                    })),
                    needCount: primaryCandidates.length,
                    greedCount: 0,
                    passCount: allPlayers.length - primaryCandidates.length
                };
            }

            // 2. 希望登録済みのプレイヤーを検索
            const secondaryCandidates = allPlayers.filter(player => {
                return player.weaponWishes && player.weaponWishes.some(wish => wish.job === droppedWeaponJob);
            });

            if (secondaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(secondaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: '希望登録済み',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: secondaryCandidates.includes(p) ? 'Greed' : 'Pass' 
                    })),
                    needCount: 0,
                    greedCount: secondaryCandidates.length,
                    passCount: allPlayers.length - secondaryCandidates.length
                };
            }

            // 3. 該当者なし
            return {
                equipment: equipment,
                winner: null,
                reason: '該当者なし（分解・保管）',
                allJudgments: allPlayers.map(p => ({ player: p, judgment: 'Pass' })),
                needCount: 0,
                greedCount: 0,
                passCount: allPlayers.length
            };
        }

        // 分配結果表示
        function displayAllocationResults() {
            try {
                const container = document.getElementById('allocation-summary');
                if (!container) return;
                
                // プレイヤーデータを取得
                const data = getLocalData();
                const players = Object.values(data.players[currentRaidTier.id]);
                
                const htmlContent = allocationResults.map((result, index) => {
                    // 勝者情報の安全な取得
                    let winnerText = 'なし';
                    let isFreeLot = false;
                    
                    if (result.winner) {
                        const winnerName = result.winner.name || '名前不明';
                        const winnerPosition = result.winner.position || 'ポジション不明';
                        winnerText = `${winnerName} (${winnerPosition})`;
                    } else {
                        winnerText = 'フリーロット';
                        isFreeLot = true;
                    }
                    
                    return `
                        <div class="allocation-result-compact">
                            <div class="item-allocation-row">
                                <div class="item-name-compact">${result.equipment.name}</div>
                                <div class="allocation-status">
                                    <span class="auto-result ${isFreeLot ? 'freelot' : ''}">${winnerText}</span>
                                </div>
                                <div class="manual-selection-compact">
                                    <select id="manual-winner-${index}" onchange="updateManualWinner(${index})">
                                        <option value="">取得者を選択...</option>
                                        ${players.map(player => `
                                            <option value="${player.position}" 
                                                ${result.winner && result.winner.position === player.position ? 'selected' : ''}>
                                                ${player.position} - ${player.characterName}
                                            </option>
                                        `).join('')}
                                        <option value="discard" ${!result.winner ? 'selected' : ''}>分解・保管</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="allocation-header-compact">
                        <div class="header-item">アイテム</div>
                        <div class="header-predicted">取得予定者</div>
                        <div class="header-actual">実際の取得者</div>
                    </div>
                    ${htmlContent}
                `;
                
            } catch (error) {
                console.error('分配結果表示エラー:', error);
                const container = document.getElementById('allocation-summary');
                if (container) {
                    container.innerHTML = `<p style="color: #e74c3c;">分配結果の表示中にエラーが発生しました。</p>`;
                }
            }
        }

        // 手動取得者設定
        function updateManualWinner(resultIndex) {
            const selectedPosition = document.getElementById(`manual-winner-${resultIndex}`).value;
            
            if (!allocationResults[resultIndex]) return;
            
            if (selectedPosition === '' || selectedPosition === 'discard') {
                allocationResults[resultIndex].winner = null;
                allocationResults[resultIndex].reason = '手動設定: 分解・保管';
            } else {
                const data = getLocalData();
                const players = Object.values(data.players[currentRaidTier.id]);
                const selectedPlayer = players.find(p => p.position === selectedPosition);
                
                if (selectedPlayer) {
                    allocationResults[resultIndex].winner = selectedPlayer;
                    allocationResults[resultIndex].reason = '手動設定: ユーザー指定';
                }
            }
        }

        // 直ドロップ武器の手動取得者設定
        function updateManualWeaponWinner(weaponJob) {
            const selectedPosition = document.getElementById('manual-weapon-winner').value;
            
            const weaponResultIndex = allocationResults.findIndex(result => 
                result.equipment.type === 'direct_weapon' && result.equipment.name.includes(weaponJob)
            );
            
            if (weaponResultIndex >= 0) {
                if (selectedPosition === '' || selectedPosition === 'discard') {
                    allocationResults[weaponResultIndex].winner = null;
                    allocationResults[weaponResultIndex].reason = '手動設定: 分解・保管';
                } else {
                    const data = getLocalData();
                    const players = Object.values(data.players[currentRaidTier.id]);
                    const selectedPlayer = players.find(p => p.position === selectedPosition);
                    
                    if (selectedPlayer) {
                        allocationResults[weaponResultIndex].winner = selectedPlayer;
                        allocationResults[weaponResultIndex].reason = '手動設定: ユーザー指定';
                    }
                }
                
                displayAllocationResults();
            }
        }

        // 分配結果確定・保存
        async function confirmAndSaveAllocation(layer) {
            if (!allocationResults || allocationResults.length === 0) {
                alert('分配結果が生成されていません。');
                return;
            }
            
            if (!confirm(`${layer}層の分配結果を確定して保存しますか？`)) {
                return;
            }
            
            const data = getLocalData();
            
            if (!data.allocations) data.allocations = {};
            if (!data.allocations[currentRaidTier.id]) data.allocations[currentRaidTier.id] = [];
            
            const timestamp = new Date().toISOString();
            
            allocationResults.forEach(result => {
                const allocation = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    layer: layer,
                    equipment: result.equipment,
                    winner: result.winner,
                    reason: result.reason,
                    allJudgments: result.allJudgments,
                    timestamp: timestamp,
                    week: getCurrentWeekString()
                };
                
                data.allocations[currentRaidTier.id].push(allocation);
                
                // 勝者の現在装備を更新
                if (result.winner) {
                    const playerKey = Object.keys(data.players[currentRaidTier.id]).find(
                        key => data.players[currentRaidTier.id][key].name === result.winner.name
                    );
                    if (playerKey) {
                        if (!data.players[currentRaidTier.id][playerKey].currentEquipment) {
                            data.players[currentRaidTier.id][playerKey].currentEquipment = {};
                        }
                        data.players[currentRaidTier.id][playerKey].currentEquipment[result.equipment.slot] = result.equipment;
                    }
                }
            });
            
            await saveData(data);
            
            alert(`${layer}層の分配結果を確定・保存しました！`);
            
            // 状態リセット
            currentDropItems = [];
            allocationResults = [];
            showMainDashboard();
        }

        // ヘルパー関数群
        function extractJobFromWeaponName(weaponName) {
            const jobNames = [
                'ナイト', '戦士', '暗黒騎士', 'ガンブレイカー',
                '白魔道士', '占星術師', '学者', '賢者',
                'モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー',
                '吟遊詩人', '機工士', '踊り子',
                '黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー'
            ];
            
            for (const job of jobNames) {
                if (weaponName.includes(job)) {
                    return job;
                }
            }
            
            return '不明';
        }

        function playerHasWeaponForJobSimple(player, jobName) {
            const currentWeapon = player.currentEquipment && player.currentEquipment['武器'];
            if (!currentWeapon) return false;
            
            // 簡易的にアイテムレベル720以上を持っていれば武器ありとする
            return currentWeapon.itemLevel >= 720;
        }

        function selectWinnerByPriority(candidatePlayers) {
            const players = candidatePlayers.map(cp => cp.player || cp);
            
            if (players.length === 1) {
                return players[0];
            }
            
            // 優先度: D1/D2 > D3/D4 > MT/ST > H1/H2
            const positionPriorities = {
                'D1': 1, 'D2': 1,    // DPS Melee
                'D3': 2, 'D4': 2,    // DPS Range/Caster
                'MT': 3, 'ST': 3,    // Tank
                'H1': 4, 'H2': 4     // Healer
            };
            
            const sortedPlayers = players.sort((a, b) => {
                const priorityA = positionPriorities[a.position] || 999;
                const priorityB = positionPriorities[b.position] || 999;
                return priorityA - priorityB;
            });
            
            return sortedPlayers[0];
        }

        function getSlotFromEquipmentName(equipmentName) {
            const slotKeywords = {
                '武器': ['武器', 'ソード', 'アクス', 'ハンマー', 'ロッド', 'ボウ', 'ガン'],
                '頭': ['ヘルム', 'フード', 'ハット', '帽子', '頭'],
                '胴': ['アーマー', 'ローブ', 'コート', '胴', 'チェスト'],
                '手': ['ガントレット', 'グローブ', '手袋', '手'],
                '脚': ['パンタロン', 'ホーズ', 'ブーツ', '脚', 'レッグ'],
                '足': ['ブーツ', 'シューズ', '靴', '足'],
                '耳': ['イヤリング', '耳飾り', '耳'],
                '首': ['ネックレス', 'チョーカー', '首飾り', '首'],
                '腕': ['ブレスレット', '腕輪', '腕'],
                '指': ['リング', '指輪', '指']
            };
            
            for (const [slot, keywords] of Object.entries(slotKeywords)) {
                if (keywords.some(keyword => equipmentName.includes(keyword))) {
                    return slot;
                }
            }
            
            return '不明';
        }

        function getCurrentWeekString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>