<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://*.supabase.co https://supabase.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
    <title>FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É† (SupabaseÁâà)</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
        // Supabase„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç
        window.addEventListener('load', function() {
            console.log('Supabase library loaded:', typeof window.supabase !== 'undefined');
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase version:', window.supabase.createClient ? 'OK' : 'No createClient method');
            }
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        /* SupabaseË™çË®ºÁî®„ÅÆ„Éò„ÉÉ„ÉÄ„Éº */
        .supabase-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 10px 20px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁî®„Çπ„Çø„Ç§„É´ */
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px;
            min-width: 120px;
        }
        
        .dashboard-layer-button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .supabase-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: white;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .connection-indicator.online {
            background-color: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        
        .connection-indicator.offline {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-input {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .auth-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4a9d6b;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #3e8a57;
        }
        
        .auth-btn.logout {
            background-color: #d86a5a;
        }
        
        .auth-btn.logout:hover {
            background-color: #b85a4a;
        }
        
        /* Ë™çË®ºÁîªÈù¢ */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
        }
        
        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-card h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .auth-form button {
            padding: 12px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .auth-form button:hover {
            background-color: #219a52;
        }
        
        .demo-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }
        
        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .main-content {
            display: none;
        }
        
        .main-content.authenticated {
            display: block;
        }
        
        /* Êó¢Â≠ò„ÅÆcollaborative_index.html„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÁµ±Âêà */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .player-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        .position-badge {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .job-select {
            width: 100%;
            margin: 5px 0;
        }
        .equipment-policy {
            margin: 10px 0;
        }
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }
        .policy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .policy-item label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .policy-item select {
            width: 100%;
            padding: 6px;
            font-size: 0.8rem;
            margin: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* Ë£ÖÂÇôÊñπÈáù„ÅÆËÉåÊôØËâ≤ */
        .policy-item select option[value="Èõ∂Âºè"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select option[value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        .policy-item select[value="Èõ∂Âºè"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select[value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        
        /* „Çø„ÉñÈñ¢ÈÄ£„Çπ„Çø„Ç§„É´ */
        .tab-container {
            margin: 20px 0;
        }
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }
        .tab-content {
            min-height: 400px;
        }
        
        /* Â±§ÈÅ∏ÊäûÈñ¢ÈÄ£ */
        .layer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .layer-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .layer-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .layer-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-align: center;
        }
        .layer-content {
            padding: 15px;
        }
        
        /* ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆöÈñ¢ÈÄ£ */
        .priority-container {
            max-width: 600px;
            margin: 20px auto;
        }
        .priority-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s ease;
        }
        .priority-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .priority-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .priority-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .position-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .player-details {
            font-size: 0.9rem;
            color: #666;
        }
        .drag-handle {
            color: #999;
            font-size: 20px;
            cursor: move;
        }
        
        /* Ê≠¶Âô®Â∏åÊúõÈñ¢ÈÄ£ */
        .weapon-wishes {
            margin: 10px 0;
        }
        .wish-priority {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wish-priority label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #555;
        }
        .wish-priority select,
        .wish-priority input {
            flex: 1;
            min-width: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .wish-priority select option {
            font-size: 0.85rem;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tier-item.active {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .tier-item h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .tier-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .dashboard-layer-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }
        
        /* Áµ±Ë®àÊÉÖÂ†±Áî®„Çπ„Çø„Ç§„É´ */
        .player-stats-table {
            display: grid;
            grid-template-columns: 150px repeat(14, 1fr);
            gap: 1px;
            background-color: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .stats-header {
            display: contents;
        }
        
        .stats-header > div {
            background-color: #4a9d6b;
            color: white;
            padding: 10px 5px;
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .stats-row {
            display: contents;
        }
        
        .player-name-col {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            border-right: 2px solid #dee2e6;
        }
        
        .slot-col {
            background-color: white;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .slot-col.acquired {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .slot-col.not-acquired {
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .slot-col.tome-exchange {
            background-color: #fff3cd;
            color: #856404;
            font-weight: bold;
        }
        
        .slot-col.tome-exchange-completed {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        
        /* Á∑®ÈõÜ„É¢„Éº„ÉâÁî®„Çπ„Çø„Ç§„É´ */
        .editable-slot {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .editable-slot:hover {
            opacity: 0.8;
        }
        
        .checkbox-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 100%;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin: 0 0 4px 0;
            transform: scale(1.2);
            cursor: pointer;
        }
        
        .checkbox-container .status-text {
            font-size: 0.7rem;
            text-align: center;
        }
        
        .checkmark {
            display: none;
        }
        
        .edit-button, .save-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }
        
        .edit-button:hover, .save-button:hover {
            background-color: #218838;
        }
        
        .save-button {
            background-color: #007bff;
        }
        
        .save-button:hover {
            background-color: #0056b3;
        }
        
        /* „Éï„Ç©„Éº„É†Áî®„Çπ„Çø„Ç§„É´ */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .primary-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        
        .secondary-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .secondary-btn:hover {
            background-color: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(149, 165, 166, 0.3);
        }
        
        /* ÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆöÁî®„Çπ„Çø„Ç§„É´ */
        .priority-container {
            max-width: 100%;
            margin: 15px 0;
            width: 100%;
            display: block;
        }
        
        .priority-list {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 8px;
            justify-content: flex-start;
            align-items: center;
            min-height: auto;
            overflow-x: auto;
            width: 100%;
        }
        
        .priority-item {
            background-color: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            margin: 0;
            padding: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
            min-width: 70px;
            width: 70px;
            height: 70px;
            text-align: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .priority-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            border-color: #007bff;
        }
        
        .priority-item:active {
            cursor: grabbing;
        }
        
        .priority-item.dragging {
            opacity: 0.7;
            transform: rotate(5deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            z-index: 1000;
        }
        
        .priority-item.drag-over {
            border-color: #28a745;
            background-color: #f8fff8;
            transform: scale(1.02);
        }
        
        .priority-rank {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 9px;
            position: absolute;
            top: 1px;
            left: 1px;
        }
        
        .priority-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            margin-top: 12px;
        }
        
        .priority-info .position-badge {
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 11px;
        }
        
        /* „É≠„Éº„É´Âà•Ëâ≤ÂàÜ„Åë - ÂÖ±ÈÄöÂÆöÁæ© */
        .position-badge.tank, .role-tank, .priority-info .position-badge.tank {
            background-color: #3498db; /* „Çø„É≥„ÇØ: Èùí */
            color: white;
        }
        
        .position-badge.healer, .role-healer, .priority-info .position-badge.healer {
            background-color: #27ae60; /* „Éí„Éº„É©„Éº: Á∑ë */
            color: white;
        }
        
        .position-badge.dps, .role-dps, .priority-info .position-badge.dps {
            background-color: #e67e22; /* DPS: Êüî„Çâ„Åã„ÅÑËµ§Ôºà„Ç™„É¨„É≥„Ç∏ÂØÑ„ÇäÔºâ */
            color: white;
        }
        
        .priority-info .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 11px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }
        
        .priority-info .player-job {
            color: #6c757d;
            font-size: 10px;
            font-weight: 500;
            line-height: 1.1;
        }
        
        .drag-handle {
            color: #007bff;
            font-size: 10px;
            cursor: grab;
            transition: all 0.2s ease;
            padding: 1px;
            border-radius: 3px;
            position: absolute;
            bottom: 1px;
            right: 1px;
        }
        
        .drag-handle:hover {
            color: #0056b3;
            background-color: rgba(0, 123, 255, 0.1);
            transform: scale(1.1);
        }
        
        .drag-handle:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        .priority-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .nav-button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ */
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background-color: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        /* „Éá„Éº„ÇøÁßªË°åÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .migration-section {
            transition: all 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .migration-section:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .file-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-input-container input[type="file"] {
            transition: border-color 0.3s ease;
        }
        
        .file-input-container input[type="file"]:hover {
            border-color: #2980b9;
        }
        
        .csv-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }
        
        .csv-input-section {
            display: flex;
            flex-direction: column;
        }
        
        .csv-help-section {
            min-width: 200px;
        }
        
        .reset-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .reset-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .reset-warning {
            background-color: #fee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }
        
        .hints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .hint-card {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.2s ease;
        }
        
        .hint-card:hover {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        /* Ë£ÖÂÇôÂàÜÈÖçÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .layer-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .layer-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        .layer-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .layer-stats {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .allocation-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .allocation-choice {
            margin: 15px 0;
        }
        
        .allocation-choice select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .candidates-detail {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .candidate-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .no-candidates {
            color: #666;
            font-style: italic;
        }
        
        .weapon-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .weapon-selection h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .weapon-selection select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        .predicted-winner {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .judgment-details {
            margin-top: 15px;
        }
        
        .judgment-toggle {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            color: #000;
        }
        
        .judgment-toggle:hover {
            background: #e9ecef;
        }
        
        .judgment-content {
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .need-section, .greed-section, .pass-section {
            margin: 10px 0;
        }
        
        .need-section h6 {
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .greed-section h6 {
            color: #f39c12;
            margin-bottom: 8px;
        }
        
        .pass-section h6 {
            color: #95a5a6;
            margin-bottom: 8px;
        }
        
        .candidate-item.need {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.greed {
            background: #fef9e7;
            border-left: 4px solid #f39c12;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.pass {
            background: #f8f9fa;
            border-left: 4px solid #95a5a6;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            color: #666;
        }
        
        .allocation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .confirm-btn {
            background: #27ae60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .confirm-btn:hover {
            background: #2ecc71;
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        /* Áµ±Ë®àÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .stat-details {
            margin-top: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slot-stats, .week-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .slot-stat-item, .week-stat-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .slot-name, .week-number {
            width: 100px;
            font-weight: 600;
        }
        
        .slot-count, .week-count {
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        
        .slot-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .slot-progress {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3498db;
            margin-top: 10px;
        }
        
        /* Â±•Ê≠¥Èñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-group select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .clear-filters-btn {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
        }
        
        /* „Çø„Éñ‰øùÂ≠ò„Éú„Çø„É≥ */
        .tab-save-button {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .save-btn:hover {
            background: #218838;
        }
        
        .history-table {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .history-header {
            background: #3498db;
            color: white;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
        }
        
        .history-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-row:hover {
            background: #e8f4fd;
        }
        
        .history-cell {
            padding: 10px;
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        @media (max-width: 768px) {
            .csv-container {
                grid-template-columns: 1fr;
            }
            
            .reset-buttons-container {
                grid-template-columns: 1fr;
            }
            
            .file-input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .layer-grid {
                grid-template-columns: 1fr;
            }
            
            .allocation-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .history-header, .history-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .history-cell {
                border-bottom: 1px solid #e9ecef;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SupabaseË™çË®º„Éò„ÉÉ„ÉÄ„Éº -->
        <div class="supabase-header">
            <div class="supabase-status">
                <h1 style="margin: 0; font-size: 18px;">FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†</h1>
                <div id="connectionStatus" class="connection-indicator offline">
                    <span>‚ö´</span>
                    <span>„Ç™„Éï„É©„Ç§„É≥</span>
                </div>
                <div id="teamInfo" style="display: none;">
                    <span id="currentTeamName">„ÉÅ„Éº„É†Âêç</span>
                </div>
            </div>
            
            
            <div class="auth-controls" id="loggedInControls" style="display: none;">
                <span id="loggedInTeam">demo-team</span>
                <button class="auth-btn logout" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
        </div>
        
        <!-- „Ç®„É©„Éº„ÉªÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- Ë™çË®ºÁîªÈù¢ -->
        <div id="authScreen" class="auth-screen">
            <div class="auth-card">
                <h2>üõ°Ô∏è „ÉÅ„Éº„É†Ë™çË®º</h2>
                <p>8‰∫∫„Åß„ÅÆÂÖ±ÂêåÂà©Áî®„Å´„ÅØ<br>„ÉÅ„Éº„É†ID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô</p>
                
                <div class="auth-form">
                    <input type="text" id="mainTeamIdInput" placeholder="„ÉÅ„Éº„É†ID (‰æã: my-raid-team)" maxlength="20">
                    <input type="password" id="mainPasswordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="20">
                    <button onclick="authenticateTeam()">„É≠„Ç∞„Ç§„É≥</button>
                </div>
                
                <div class="demo-info">
                    <strong>üéÆ „Éá„É¢Áî®„Ç¢„Ç´„Ç¶„É≥„Éà</strong><br>
                    „ÉÅ„Éº„É†ID: <code>demo-team</code><br>
                    „Éë„Çπ„ÉØ„Éº„Éâ: <code>demo123</code>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p><a href="#" onclick="showSignupForm()" style="color: #3498db; text-decoration: none;">Êñ∞„Åó„ÅÑ„ÉÅ„Éº„É†„Çí‰ΩúÊàê</a> | 
                    <a href="#" onclick="showPasswordResetForm()" style="color: #e74c3c; text-decoration: none;">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÂ†¥Âêà</a></p>
                </div>
            </div>
        </div>
        
        <!-- Êñ∞Ë¶èÁôªÈå≤ÁîªÈù¢ -->
        <div id="signupScreen" class="auth-screen" style="display: none;">
            <div class="auth-container">
                <h1>üõ°Ô∏è Êñ∞„Åó„ÅÑ„ÉÅ„Éº„É†‰ΩúÊàê</h1>
                <p style="margin-bottom: 30px; color: #666;">
                    FF14Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†Áî®„ÅÆ<br>Êñ∞„Åó„ÅÑ„ÉÅ„Éº„É†„Çí‰ΩúÊàê„Åó„Åæ„Åô
                </p>
                
                <div class="auth-form">
                    <input type="text" id="signupTeamIdInput" placeholder="„ÉÅ„Éº„É†ID (Ëã±Êï∞Â≠ó„ÄÅ3-20ÊñáÂ≠ó)" maxlength="20">
                    <input type="text" id="signupCreatedByInput" placeholder="‰ΩúÊàêËÄÖÂêç („Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÊôÇ„Å´‰ΩøÁî®)" maxlength="50">
                    <input type="password" id="signupPasswordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ (6ÊñáÂ≠ó‰ª•‰∏ä)" maxlength="20">
                    <input type="password" id="signupPasswordConfirmInput" placeholder="„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç" maxlength="20">
                    
                    <div style="margin: 15px 0; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem;">„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè („Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÁî®)</label>
                        <select id="signupSecurityQuestionSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="">„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="favorite_job">Â•Ω„Åç„Å™„Ç∏„Éß„Éñ„ÅØ‰Ωï„Åß„Åô„ÅãÔºü</option>
                            <option value="first_datacenter">ÊúÄÂàù„Å´„Éó„É¨„Ç§„Åó„Åü„Éá„Éº„Çø„Çª„É≥„Çø„Éº„ÅØÔºü</option>
                            <option value="main_character">„É°„Ç§„É≥„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂêçÂâç„ÅØÔºü</option>
                            <option value="favorite_raid">Â•Ω„Åç„Å™Èõ∂Âºè„É¨„Ç§„Éâ„ÅØÔºü</option>
                            <option value="fc_name">ÊâÄÂ±ûFC„ÅÆÂêçÂâç„ÅØÔºü</option>
                            <option value="custom">„Ç´„Çπ„Çø„É†Ë≥™Âïè„ÇíÂÖ•Âäõ</option>
                        </select>
                    </div>
                    
                    <input type="text" id="signupCustomQuestionInput" placeholder="„Ç´„Çπ„Çø„É†Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" style="display: none;" maxlength="100">
                    <input type="text" id="signupSecurityAnswerInput" placeholder="„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ≠î„Åà" maxlength="50">
                    
                    <button onclick="createNewTeam()">„ÉÅ„Éº„É†‰ΩúÊàê</button>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p><a href="#" onclick="showLoginForm()" style="color: #3498db; text-decoration: none;">Êó¢Â≠ò„ÉÅ„Éº„É†„Åß„É≠„Ç∞„Ç§„É≥</a></p>
                </div>
                
                <div style="margin-top: 20px; font-size: 11px; color: #999; line-height: 1.4;">
                    <p>„Éª„ÉÅ„Éº„É†ID„ÅØ‰ªñ„ÅÆ„ÉÅ„Éº„É†„Å®ÈáçË§á„Åß„Åç„Åæ„Åõ„Çì<br>
                    „Éª„Éë„Çπ„ÉØ„Éº„Éâ„ÅØÂÆâÂÖ®„Å´ÁÆ°ÁêÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>
                    „Éª‰ΩúÊàêÂæå„ÅØ8‰∫∫„ÅßÂÖ±Êúâ„Åó„Å¶„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ</p>
                </div>
            </div>
        </div>
        
        <!-- „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÁîªÈù¢ -->
        <div id="passwordResetScreen" class="auth-screen" style="display: none;">
            <div class="auth-container">
                <h1>üîë „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà</h1>
                <p style="margin-bottom: 30px; color: #666;">
                    „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„Å´Á≠î„Åà„Å¶<br>„Éë„Çπ„ÉØ„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô
                </p>
                
                <!-- „Çπ„ÉÜ„ÉÉ„Éó1: „ÉÅ„Éº„É†ID„Å®„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™ÂïèÁ¢∫Ë™ç -->
                <div id="resetStep1" class="auth-form">
                    <input type="text" id="resetTeamIdInput" placeholder="„ÉÅ„Éº„É†ID" maxlength="20">
                    <button onclick="getSecurityQuestion()">„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÇíÂèñÂæó</button>
                </div>
                
                <!-- „Çπ„ÉÜ„ÉÉ„Éó2: „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™ÂïèÂõûÁ≠î -->
                <div id="resetStep2" class="auth-form" style="display: none;">
                    <div id="teamInfoDisplay" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; text-align: left;">
                        <!-- „ÉÅ„Éº„É†ÊÉÖÂ†±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    <div id="securityQuestionDisplay" style="margin-bottom: 15px; color: #666; font-weight: bold;">
                        <!-- „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    <input type="text" id="resetSecurityAnswerInput" placeholder="„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ≠î„Åà" maxlength="50">
                    <button onclick="verifySecurityAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                </div>
                
                <!-- „Çπ„ÉÜ„ÉÉ„Éó3: Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâË®≠ÂÆö -->
                <div id="resetStep3" class="auth-form" style="display: none;">
                    <div style="margin-bottom: 20px; color: #27ae60; font-weight: bold;">
                        ‚úÖ „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ¢∫Ë™ç„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü
                    </div>
                    <input type="password" id="resetNewPasswordInput" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ (6ÊñáÂ≠ó‰ª•‰∏ä)" maxlength="20">
                    <input type="password" id="resetNewPasswordConfirmInput" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç" maxlength="20">
                    <button onclick="executePasswordReset()">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥</button>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p><a href="#" onclick="showLoginForm()" style="color: #3498db; text-decoration: none;">„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã</a></p>
                </div>
                
                <div style="margin-top: 20px; font-size: 11px; color: #999; line-height: 1.4;">
                    <p>„Éª„ÉÅ„Éº„É†‰ΩúÊàêÊôÇ„Å´Ë®≠ÂÆö„Åó„Åü„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅåÂøÖË¶Å„Åß„Åô<br>
                    „Éª„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ≠î„Åà„ÇíÂøò„Çå„ÅüÂ†¥Âêà„ÅØ„ÄÅ„ÉÅ„Éº„É†‰ΩúÊàêËÄÖ„Å´Áõ∏Ë´á„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>
                    „Éª„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÂæå„ÅØÊñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>
            </div>
        </div>
        
        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàË™çË®ºÂæå„Å´Ë°®Á§∫Ôºâ -->
        <div id="mainContent" class="main-content">
            <div id="content">
                <!-- ÂàùÊúüË°®Á§∫„ÅØ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
            </div>
        </div>
    </div>

    <!-- SupabaseË™çË®ºÊÉÖÂ†±ÔºàGitHub SecretsÁµåÁî±„ÅßÊ≥®ÂÖ•Ôºâ -->
    <script>
        // GitHub Actions„Å´„Çà„Å£„Å¶„Éá„Éó„É≠„Ç§ÊôÇ„Å´Ë™çË®ºÊÉÖÂ†±„ÅåÊ≥®ÂÖ•„Åï„Çå„Åæ„Åô
        window.SUPABASE_CONFIG = {
            SUPABASE_URL: 'https://bpzvuwhnjvbfohopeoxr.supabase.co',
            SUPABASE_ANON_KEY: null, // GitHub Actions„ÅßÁΩÆÊèõ„Åï„Çå„Çã
            DEMO_TEAM_ID: 'demo-team',
            DEMO_PASSWORD: 'demo123'
        };
    </script>
    
    <!-- SupabaseË®≠ÂÆö„Å®„É°„Ç§„É≥Ê©üËÉΩ -->
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let isAuthenticated = false;
        let currentTeamId = null;
        let isInitializing = false;
        let isInitialized = false;
        let selectedDirectWeapon = ''; // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí‰øùÊåÅ
        
        // „É≠„Éº„É´Âà§ÂÆöÁî®ÂÖ±ÈÄöÈñ¢Êï∞
        function getPositionRoleClass(position) {
            if (position === 'MT' || position === 'ST') {
                return 'tank';
            } else if (position === 'H1' || position === 'H2') {
                return 'healer';
            } else if (position.startsWith('D')) {
                return 'dps';
            }
            return '';
        }
        
        // ÂàùÊúüÂåñ - „É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
        window.addEventListener('load', async function() {
            if (!isInitialized && !isInitializing) {
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                showMessage('„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...', 'info');
                
                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Ç¢„Éó„É™ÂàùÊúüÂåñ
                setTimeout(async () => {
                    await initializeApp();
                }, 100);
            }
        });
        
        // DOMContentLoaded„Åß„ÇÇÂàùÊúüÂåñ„ÇíË©¶Ë°åÔºà„Éè„Éº„Éâ„É™„É≠„Éº„ÉâÂØæÁ≠ñÔºâ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded: DOMÊ∫ñÂÇôÂÆå‰∫Ü');
            if (!isInitialized && !isInitializing && !window.supabaseClient) {
                showMessage('„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...', 'info');
                // DOMË¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
                setTimeout(async () => {
                    console.log('DOMË¶ÅÁ¥†Á¢∫Ë™çÂæå„ÅÆÂàùÊúüÂåñÈñãÂßã');
                    await initializeApp();
                }, 300);
            }
        });
        
        // „Ç¢„Éó„É™ÂàùÊúüÂåñ
        async function initializeApp() {
            // ÈáçË§áÂàùÊúüÂåñÈò≤Ê≠¢
            if (isInitializing || isInitialized) {
                console.log('ÂàùÊúüÂåñ„Çπ„Ç≠„ÉÉ„Éó: Êó¢„Å´ÂàùÊúüÂåñÊ∏à„Åø„Åæ„Åü„ÅØÂàùÊúüÂåñ‰∏≠');
                return;
            }
            
            isInitializing = true;
            
            try {
                console.log('„Ç¢„Éó„É™ÂàùÊúüÂåñÈñãÂßã');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (window.supabaseClient) {
                    console.log('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊó¢Â≠ò„ÅÆ„Åü„ÇÅÂàùÊúüÂåñ„Çπ„Ç≠„ÉÉ„Éó');
                    isInitialized = true;
                    isInitializing = false;
                    await tryAutoLogin();
                    return;
                }
                
                // Supabase„É©„Ç§„Éñ„É©„É™„ÅÆÁ¢∫Ë™ç
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase JavaScript„É©„Ç§„Éñ„É©„É™„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                console.log('Supabase„É©„Ç§„Éñ„É©„É™Á¢∫Ë™çÂÆå‰∫Ü');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà‰ΩúÊàêÔºàÊ©üÂØÜÊÉÖÂ†±„ÅØÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâÔºâ
                const supabaseUrl = window.SUPABASE_CONFIG?.SUPABASE_URL;
                const supabaseKey = window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('SupabaseË™çË®ºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇGitHub Secrets„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
                
                window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                console.log('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà‰ΩúÊàêÂÆå‰∫Ü');
                
                // Êé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞
                updateConnectionStatus(true);
                
                // Ëá™Âãï„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å
                await tryAutoLogin();
                
                console.log('„Ç¢„Éó„É™ÂàùÊúüÂåñÂÆå‰∫Ü');
                
                // ÂàùÊúüÂåñÂÆå‰∫Ü„Éï„É©„Ç∞Ë®≠ÂÆö
                isInitialized = true;
                isInitializing = false;
                
            } catch (error) {
                console.error('„Ç¢„Éó„É™ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                showError('„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                updateConnectionStatus(false);
                
                // ÂàùÊúüÂåñÂ§±ÊïóÊôÇ„ÅØ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                isInitializing = false;
            }
        }
        
        // Ëá™Âãï„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å
        async function tryAutoLogin() {
            const savedTeamId = localStorage.getItem('ff14_team_id');
            if (savedTeamId) {
                console.log('Ëá™Âãï„É≠„Ç∞„Ç§„É≥ÈñãÂßã:', savedTeamId);
                currentTeamId = savedTeamId;
                
                // „ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö
                try {
                    const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                        team_id: savedTeamId
                    });
                    
                    if (contextError) {
                        console.error('„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö„Ç®„É©„Éº:', contextError);
                    } else {
                        console.log('„ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆöÂÆå‰∫Ü');
                    }
                } catch (error) {
                    console.error('Ëá™Âãï„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö„Ç®„É©„Éº:', error);
                }
                
                await showAuthenticatedState();
                
                // „É°„Ç§„É≥Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
                await initializeMainFeatures();
                
                console.log('Ëá™Âãï„É≠„Ç∞„Ç§„É≥ÂÆå‰∫Ü');
            }
        }
        
        // „ÉÅ„Éº„É†Ë™çË®º
        async function authenticateTeam() {
            const teamId = document.getElementById('mainTeamIdInput')?.value;
            const password = document.getElementById('mainPasswordInput')?.value;
            
            if (!teamId || !password) {
                showError('„ÉÅ„Éº„É†ID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                showMessage('Ë™çË®º‰∏≠...', 'info');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÁ¢∫Ë™ç
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                console.log('Ë™çË®ºË©¶Ë°å:', teamId);
                
                // SupabaseË™çË®º
                const { data, error } = await window.supabaseClient.rpc('authenticate_team', {
                    p_team_id: teamId,
                    p_password: password
                });
                
                console.log('Ë™çË®ºÁµêÊûú:', { data, error });
                
                if (error) {
                    throw new Error(`Ë™çË®º„Ç®„É©„Éº: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('„ÉÅ„Éº„É†ID„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                // Ë™çË®ºÊàêÂäü
                currentTeamId = teamId;
                localStorage.setItem('ff14_team_id', teamId);
                
                // „ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö
                console.log('„ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö‰∏≠...');
                const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                    team_id: teamId
                });
                
                if (contextError) {
                    console.error('„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö„Ç®„É©„Éº:', contextError);
                } else {
                    console.log('„ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆöÂÆå‰∫Ü');
                }
                
                await showAuthenticatedState();
                showSuccess('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü');
                
                // „É°„Ç§„É≥Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
                await initializeMainFeatures();
                
            } catch (error) {
                console.error('Ë™çË®º„Ç®„É©„Éº:', error);
                showError('Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Êñ∞Ë¶è„ÉÅ„Éº„É†‰ΩúÊàê
        async function createNewTeam() {
            const teamId = document.getElementById('signupTeamIdInput').value;
            const createdBy = document.getElementById('signupCreatedByInput').value;
            const password = document.getElementById('signupPasswordInput').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirmInput').value;
            const securityQuestionSelect = document.getElementById('signupSecurityQuestionSelect').value;
            const customQuestion = document.getElementById('signupCustomQuestionInput').value;
            const securityAnswer = document.getElementById('signupSecurityAnswerInput').value;
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!teamId || !createdBy || !password || !passwordConfirm || !securityQuestionSelect || !securityAnswer) {
                showError('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (teamId.length < 3) {
                showError('„ÉÅ„Éº„É†ID„ÅØ3ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(teamId)) {
                showError('„ÉÅ„Éº„É†ID„ÅØËã±Êï∞Â≠ó„ÄÅ„Éè„Ç§„Éï„É≥„ÄÅ„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÅÆ„Åø‰ΩøÁî®ÂèØËÉΩ„Åß„Åô');
                return;
            }
            
            if (password.length < 6) {
                showError('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (password !== passwordConfirm) {
                showError('„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì');
                return;
            }
            
            // „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÊ§úË®º
            let finalSecurityQuestion;
            if (securityQuestionSelect === 'custom') {
                if (!customQuestion.trim()) {
                    showError('„Ç´„Çπ„Çø„É†Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                finalSecurityQuestion = customQuestion.trim();
            } else {
                const questionTexts = {
                    'favorite_job': 'Â•Ω„Åç„Å™„Ç∏„Éß„Éñ„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                    'first_datacenter': 'ÊúÄÂàù„Å´„Éó„É¨„Ç§„Åó„Åü„Éá„Éº„Çø„Çª„É≥„Çø„Éº„ÅØÔºü',
                    'main_character': '„É°„Ç§„É≥„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂêçÂâç„ÅØÔºü',
                    'favorite_raid': 'Â•Ω„Åç„Å™Èõ∂Âºè„É¨„Ç§„Éâ„ÅØÔºü',
                    'fc_name': 'ÊâÄÂ±ûFC„ÅÆÂêçÂâç„ÅØÔºü'
                };
                finalSecurityQuestion = questionTexts[securityQuestionSelect];
            }
            
            try {
                showMessage('„ÉÅ„Éº„É†‰ΩúÊàê‰∏≠...', 'info');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÁ¢∫Ë™ç
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                console.log('„ÉÅ„Éº„É†‰ΩúÊàêË©¶Ë°å:', teamId);
                
                // Supabase„Åß„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè‰ªò„Åç„ÉÅ„Éº„É†‰ΩúÊàê
                const { data, error } = await window.supabaseClient.rpc('create_team_with_security', {
                    p_team_id: teamId,
                    p_team_name: teamId, // „ÉÅ„Éº„É†Âêç„ÅØ„ÉÅ„Éº„É†ID„Å®Âêå„Åò„Å´Ë®≠ÂÆö
                    p_password: password,
                    p_created_by: createdBy,
                    p_security_question: finalSecurityQuestion,
                    p_security_answer: securityAnswer
                });
                
                console.log('„ÉÅ„Éº„É†‰ΩúÊàêÁµêÊûú:', { data, error });
                
                if (error) {
                    if (error.message.includes('already exists') || error.message.includes('duplicate')) {
                        throw new Error('„Åì„ÅÆ„ÉÅ„Éº„É†ID„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    }
                    throw new Error(`„ÉÅ„Éº„É†‰ΩúÊàê„Ç®„É©„Éº: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('„ÉÅ„Éº„É†‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                // ‰ΩúÊàêÊàêÂäü - Ëá™Âãï„É≠„Ç∞„Ç§„É≥
                showSuccess('„ÉÅ„Éº„É†„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅËá™Âãï„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åô...');
                
                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâËá™Âãï„É≠„Ç∞„Ç§„É≥
                setTimeout(async () => {
                    // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´ÂÄ§„ÇíË®≠ÂÆö
                    document.getElementById('mainTeamIdInput').value = teamId;
                    document.getElementById('mainPasswordInput').value = password;
                    
                    // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã
                    showLoginForm();
                    
                    // Ëá™Âãï„É≠„Ç∞„Ç§„É≥
                    await authenticateTeam();
                }, 1000);
                
            } catch (error) {
                console.error('„ÉÅ„Éº„É†‰ΩúÊàê„Ç®„É©„Éº:', error);
                showError('„ÉÅ„Éº„É†‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Êñ∞Ë¶èÁôªÈå≤ÁîªÈù¢Ë°®Á§∫
        function showSignupForm() {
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'none';
            
            const signupScreen = document.getElementById('signupScreen');
            if (signupScreen) signupScreen.style.display = 'block';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'none';
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
            const signupTeamIdInput = document.getElementById('signupTeamIdInput');
            if (signupTeamIdInput) signupTeamIdInput.value = '';
            
            const signupPasswordInput = document.getElementById('signupPasswordInput');
            if (signupPasswordInput) signupPasswordInput.value = '';
            
            const signupPasswordConfirmInput = document.getElementById('signupPasswordConfirmInput');
            if (signupPasswordConfirmInput) signupPasswordConfirmInput.value = '';
        }
        
        // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢Ë°®Á§∫
        function showLoginForm() {
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'block';
            
            const signupScreen = document.getElementById('signupScreen');
            if (signupScreen) signupScreen.style.display = 'none';
            
            const passwordResetScreen = document.getElementById('passwordResetScreen');
            if (passwordResetScreen) passwordResetScreen.style.display = 'none';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'none';
        }
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÁîªÈù¢Ë°®Á§∫
        function showPasswordResetForm() {
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'none';
            
            const signupScreen = document.getElementById('signupScreen');
            if (signupScreen) signupScreen.style.display = 'none';
            
            const passwordResetScreen = document.getElementById('passwordResetScreen');
            if (passwordResetScreen) passwordResetScreen.style.display = 'block';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'none';
            
            // „É™„Çª„ÉÉ„ÉàÁîªÈù¢„ÅÆÂàùÊúüÂåñ
            resetPasswordResetForm();
        }
        
        // Ë™çË®ºÂæå„ÅÆÁä∂ÊÖãË°®Á§∫
        async function showAuthenticatedState() {
            isAuthenticated = true;
            
            // UIÂàá„ÇäÊõø„ÅàÔºàÂÆâÂÖ®„Å™Ë¶ÅÁ¥†„Ç¢„ÇØ„Çª„ÇπÔºâ
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'none';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.classList.add('authenticated');
                mainContent.style.display = 'block'; // Override inline style from showLoginForm
            }
            
            const loggedInControls = document.getElementById('loggedInControls');
            if (loggedInControls) loggedInControls.style.display = 'flex';
            
            const loggedInTeam = document.getElementById('loggedInTeam');
            if (loggedInTeam) loggedInTeam.textContent = currentTeamId;
            
            // „ÉÅ„Éº„É†ÊÉÖÂ†±Ë°®Á§∫
            const teamInfo = document.getElementById('teamInfo');
            if (teamInfo) teamInfo.style.display = 'block';
            
            const currentTeamName = document.getElementById('currentTeamName');
            if (currentTeamName) currentTeamName.textContent = `„ÉÅ„Éº„É†: ${currentTeamId}`;
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        function logout() {
            isAuthenticated = false;
            currentTeamId = null;
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇØ„É™„Ç¢
            localStorage.removeItem('ff14_team_id');
            
            // UIÂàá„ÇäÊõø„ÅàÔºàÂÆâÂÖ®„Å™Ë¶ÅÁ¥†„Ç¢„ÇØ„Çª„ÇπÔºâ
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'flex';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.classList.remove('authenticated');
            
            const loggedInControls = document.getElementById('loggedInControls');
            if (loggedInControls) loggedInControls.style.display = 'none';
            
            const teamInfo = document.getElementById('teamInfo');
            if (teamInfo) teamInfo.style.display = 'none';
            
            // ÂÖ•ÂäõÊ¨Ñ„ÇØ„É™„Ç¢Ôºà„É°„Ç§„É≥Ë™çË®º„Éï„Ç©„Éº„É†„ÅÆ„ÅøÔºâ
            const mainTeamIdInput = document.getElementById('mainTeamIdInput');
            if (mainTeamIdInput) mainTeamIdInput.value = '';
            
            const mainPasswordInput = document.getElementById('mainPasswordInput');
            if (mainPasswordInput) mainPasswordInput.value = '';
            
            showSuccess('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
        }
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÈñ¢ÈÄ£Èñ¢Êï∞
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Éï„Ç©„Éº„É†„ÅÆÂàùÊúüÂåñ
        function resetPasswordResetForm() {
            // ÂÖ®„Çπ„ÉÜ„ÉÉ„Éó„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶„Çπ„ÉÜ„ÉÉ„Éó1„ÅÆ„ÅøË°®Á§∫
            document.getElementById('resetStep1').style.display = 'block';
            document.getElementById('resetStep2').style.display = 'none';
            document.getElementById('resetStep3').style.display = 'none';
            
            // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            document.getElementById('resetTeamIdInput').value = '';
            document.getElementById('resetSecurityAnswerInput').value = '';
            document.getElementById('resetNewPasswordInput').value = '';
            document.getElementById('resetNewPasswordConfirmInput').value = '';
            
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Çí„ÇØ„É™„Ç¢
            window.resetToken = null;
            window.resetTeamId = null;
        }
        
        // „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™ÂïèÂèñÂæó
        async function getSecurityQuestion() {
            const teamId = document.getElementById('resetTeamIdInput').value.trim();
            
            if (!teamId) {
                showError('„ÉÅ„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                showMessage('„ÉÅ„Éº„É†ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...', 'info');
                
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                const { data, error } = await window.supabaseClient.rpc('get_team_reset_info', {
                    p_team_id: teamId
                });
                
                if (error) {
                    throw new Error(`„ÉÅ„Éº„É†ÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
                }
                
                if (!data || data.length === 0) {
                    showError('ÊåáÂÆö„Åï„Çå„Åü„ÉÅ„Éº„É†ID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const teamInfo = data[0];
                
                if (!teamInfo.security_question) {
                    showError('„Åì„ÅÆ„ÉÅ„Éº„É†„Å´„ÅØ„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÉÅ„Éº„É†‰ΩúÊàêËÄÖ„Å´Áõ∏Ë´á„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                // „ÉÅ„Éº„É†ÊÉÖÂ†±„Å®„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÇíË°®Á§∫
                const teamInfoDisplay = document.getElementById('teamInfoDisplay');
                teamInfoDisplay.innerHTML = `
                    <strong>„ÉÅ„Éº„É†Âêç:</strong> ${teamInfo.team_name}<br>
                    <strong>‰ΩúÊàêËÄÖ:</strong> ${teamInfo.created_by || 'Êú™Ë®≠ÂÆö'}<br>
                    <strong>‰ΩúÊàêÊó•:</strong> ${new Date(teamInfo.created_at).toLocaleDateString('ja-JP')}
                `;
                
                const securityQuestionDisplay = document.getElementById('securityQuestionDisplay');
                securityQuestionDisplay.textContent = `Q: ${teamInfo.security_question}`;
                
                // „Çπ„ÉÜ„ÉÉ„Éó2„ÇíË°®Á§∫
                document.getElementById('resetStep1').style.display = 'none';
                document.getElementById('resetStep2').style.display = 'block';
                
                window.resetTeamId = teamId;
                showSuccess('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü');
                
            } catch (error) {
                console.error('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™ÂïèÂèñÂæó„Ç®„É©„Éº:', error);
                showError('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ≠î„ÅàÁ¢∫Ë™ç
        async function verifySecurityAnswer() {
            const answer = document.getElementById('resetSecurityAnswerInput').value.trim();
            
            if (!answer) {
                showError('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                showMessage('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÇíÁ¢∫Ë™ç‰∏≠...', 'info');
                
                if (!window.supabaseClient || !window.resetTeamId) {
                    throw new Error('„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                }
                
                const { data, error } = await window.supabaseClient.rpc('verify_security_answer', {
                    p_team_id: window.resetTeamId,
                    p_answer: answer
                });
                
                if (error) {
                    throw new Error(`„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™ÂïèÁ¢∫Ë™ç„Ç®„É©„Éº: ${error.message}`);
                }
                
                if (!data) {
                    showError('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ≠î„Åà„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // „É™„Çª„ÉÉ„Éà„Éà„Éº„ÇØ„É≥„ÇíÁîüÊàê
                const tokenResult = await window.supabaseClient.rpc('generate_reset_token', {
                    p_team_id: window.resetTeamId
                });
                
                if (tokenResult.error) {
                    throw new Error(`„Éà„Éº„ÇØ„É≥ÁîüÊàê„Ç®„É©„Éº: ${tokenResult.error.message}`);
                }
                
                window.resetToken = tokenResult.data;
                
                // „Çπ„ÉÜ„ÉÉ„Éó3„ÇíË°®Á§∫
                document.getElementById('resetStep2').style.display = 'none';
                document.getElementById('resetStep3').style.display = 'block';
                
                showSuccess('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ¢∫Ë™ç„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                
            } catch (error) {
                console.error('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™ÂïèÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
                showError('„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™Âïè„ÅÆÁ¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÂÆüË°å
        async function executePasswordReset() {
            const newPassword = document.getElementById('resetNewPasswordInput').value;
            const newPasswordConfirm = document.getElementById('resetNewPasswordConfirmInput').value;
            
            if (!newPassword || !newPasswordConfirm) {
                showError('Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (newPassword !== newPasswordConfirm) {
                showError('„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì');
                return;
            }
            
            try {
                showMessage('„Éë„Çπ„ÉØ„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà‰∏≠...', 'info');
                
                if (!window.supabaseClient || !window.resetTeamId || !window.resetToken) {
                    throw new Error('„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                }
                
                const { data, error } = await window.supabaseClient.rpc('reset_password', {
                    p_team_id: window.resetTeamId,
                    p_token: window.resetToken,
                    p_new_password: newPassword
                });
                
                if (error) {
                    throw new Error(`„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº: ${error.message}`);
                }
                
                if (!data) {
                    showError('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éà„Éº„ÇØ„É≥„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                    return;
                }
                
                showSuccess('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£Â∏∏„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„ÅüÔºÅÊñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                
                // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã
                setTimeout(() => {
                    showLoginForm();
                    // „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†„Å´Êñ∞„Åó„ÅÑÂÄ§„ÇíË®≠ÂÆö
                    document.getElementById('mainTeamIdInput').value = window.resetTeamId;
                }, 2000);
                
            } catch (error) {
                console.error('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                showError('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÉÜ„Çπ„Éà
        async function testDatabaseConnection() {
            if (!isAuthenticated) {
                showError('ÂÖà„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                showMessage('„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Êé•Á∂ö‰∏≠...', 'info');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÁ¢∫Ë™ç
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                // „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: '„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü'
                };
                
                console.log('„ÉÜ„Çπ„Éà„Éá„Éº„Çø‰øùÂ≠ò‰∏≠...');
                
                const { data: saveData, error: saveError } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: 'test-tier',
                        data_type: 'settings',
                        content: testData
                    });
                
                if (saveError) {
                    throw new Error(`‰øùÂ≠ò„Ç®„É©„Éº: ${saveError.message}`);
                }
                
                console.log('„ÉÜ„Çπ„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
                
                // „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
                const { data: loadData, error: loadError } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', 'test-tier')
                    .eq('data_type', 'settings');
                
                if (loadError) {
                    throw new Error(`Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${loadError.message}`);
                }
                
                console.log('Ë™≠„ÅøËæº„ÅøÁµêÊûú:', loadData);
                
                if (loadData && loadData.length > 0) {
                    showSuccess('„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅ„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                } else {
                    throw new Error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
            } catch (error) {
                console.error('„Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
                showError('„Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Êé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                indicator.innerHTML = '<span>üü¢</span><span>„Ç™„É≥„É©„Ç§„É≥</span>';
            } else {
                indicator.className = 'connection-indicator offline';
                indicator.innerHTML = '<span>‚ö´</span><span>„Ç™„Éï„É©„Ç§„É≥</span>';
            }
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showMessage(message, type) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // ÂÖ®„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈö†„Åô
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => successEl.style.display = 'none', 3000);
            }
        }
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Êú™Âá¶ÁêÜ„ÅÆ„Ç®„É©„Éº:', event.reason);
            showError('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        });
        
        // ======================
        // „É°„Ç§„É≥Ê©üËÉΩ„ÅÆÂÆüË£Ö
        // ======================
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentRaidTier = null;
        let appData = {
            raidTiers: {},
            players: {},
            allocations: {},
            settings: {}
        };
        
        // „É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñ
        async function initializeMainFeatures() {
            try {
                console.log('„É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñÈñãÂßã');
                
                // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                await loadAllData();
                
                // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâË°®Á§∫
                showMainDashboard();
                
                console.log('„É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('„É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                showError('„É°„Ç§„É≥Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                
                // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíË°®Á§∫ÔºàÁ©∫„ÅÆ„Éá„Éº„Çø„ÅßÔºâ
                try {
                    console.log('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Á©∫„ÅÆ„Éá„Éº„Çø„Åß„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâË°®Á§∫');
                    showMainDashboard();
                } catch (fallbackError) {
                    console.error('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ„Ç®„É©„Éº:', fallbackError);
                }
            }
        }
        
        // ÂÖ®„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadAllData() {
            try {
                // Supabase„Åã„Çâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                const { data: allData, error } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId);
                
                if (error) {
                    throw new Error(`„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`);
                }
                
                console.log('Ë™≠„ÅøËæº„Åø„Éá„Éº„Çø:', allData);
                
                // „Éá„Éº„ÇøÁ®ÆÂà•„Åî„Å®„Å´ÂàÜÈ°û
                if (allData && allData.length > 0) {
                    allData.forEach(item => {
                        const { tier_id, data_type, content } = item;
                        
                        if (data_type === 'settings') {
                            // Ë®≠ÂÆö„Éá„Éº„Çø„ÅÆÁâπÊÆäÂá¶ÁêÜ
                            if (content.raidTier) {
                                // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Éá„Éº„Çø
                                if (!appData.raidTiers) appData.raidTiers = {};
                                appData.raidTiers[tier_id] = content.raidTier;
                            } else {
                                // „Åù„ÅÆ‰ªñ„ÅÆË®≠ÂÆö
                                if (!appData.settings) appData.settings = {};
                                appData.settings = { ...appData.settings, ...content };
                            }
                        } else {
                            // „Åù„ÅÆ‰ªñ„ÅÆ„Éá„Éº„Çø„Çø„Ç§„Éó
                            if (!appData[data_type]) {
                                appData[data_type] = {};
                            }
                            appData[data_type][tier_id] = content;
                        }
                    });
                }
                
                console.log('Êï¥ÁêÜÊ∏à„Åø„Éá„Éº„Çø:', appData);
                
            } catch (error) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                // ÂàùÊúü„Éá„Éº„Çø„ÅßÁ∂ôÁ∂ö
                appData = {
                    raidTiers: {},
                    players: {},
                    allocations: {},
                    settings: {}
                };
            }
        }
        
        // „É°„Ç§„É≥„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâË°®Á§∫
        function showMainDashboard() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†</h1>
                <h2>„ÉÅ„Éº„É†: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>„É¨„Ç§„ÉâÈÅ∏Êäû</h3>
                    <div class="tier-list" id="tierList">
                        <!-- „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="createNewTier()">Êñ∞„Åó„ÅÑ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Çí‰ΩúÊàê</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ÁÆ°ÁêÜÊ©üËÉΩ</h3>
                    <div class="navigation">
                        <button class="nav-button" onclick="showSystemSettings()">„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö</button>
                        <button class="nav-button" onclick="exportAllData()">„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        <button class="nav-button" onclick="testDatabaseConnection()">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #e8f5e8; border-color: #27ae60;">
                    <h3>ÂÆüË£ÖÂÆå‰∫ÜÊ©üËÉΩ</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>SupabaseÈÄ£Êê∫„ÉªË™çË®º„Ç∑„Çπ„ÉÜ„É†</li>
                        <li>„ÉÅ„Éº„É†Âà•„Éá„Éº„ÇøÁÆ°ÁêÜ</li>
                        <li>„É™„Ç¢„É´„Çø„Ç§„É†„Éá„Éº„ÇøÂêåÊúü</li>
                        <li>„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÁÆ°ÁêÜ</li>
                        <li>„Éó„É¨„Ç§„É§„Éº„ÉªË£ÖÂÇôÁÆ°ÁêÜ</li>
                    </ul>
                </div>
            `;
            
            // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰∏ÄË¶ß„ÇíË°®Á§∫
            displayRaidTiers();
        }
        
        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰∏ÄË¶ßË°®Á§∫
        function displayRaidTiers() {
            const tierList = document.getElementById('tierList');
            const tiers = appData.raidTiers || {};
            
            if (Object.keys(tiers).length === 0) {
                tierList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>„Åæ„Å†„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
                        <p>„ÄåÊñ∞„Åó„ÅÑ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Çí‰ΩúÊàê„Äç„Éú„Çø„É≥„Åã„ÇâÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    </div>
                `;
                return;
            }
            
            tierList.innerHTML = Object.entries(tiers).map(([tierId, tier]) => `
                <div class="tier-item ${currentRaidTier?.id === tierId ? 'active' : ''}" 
                     onclick="selectRaidTier('${tierId}')">
                    <h3>${tier.name}</h3>
                    <p>${tier.description || 'Èõ∂Âºè„É¨„Ç§„Éâ'}</p>
                </div>
            `).join('');
        }
        
        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû
        async function selectRaidTier(tierId) {
            const tier = appData.raidTiers[tierId];
            if (!tier) {
                showError('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            currentRaidTier = { id: tierId, ...tier };
            showSuccess(`„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Äå${tier.name}„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`);
            
            // „ÉÜ„Ç£„Ç¢Âõ∫Êúâ„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíË°®Á§∫
            showTierDashboard();
        }
        
        // „ÉÜ„Ç£„Ç¢Âõ∫Êúâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        function showTierDashboard() {
            if (!currentRaidTier) return;
            
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showMainDashboard()">„É¨„Ç§„ÉâÈÅ∏ÊäûÁîªÈù¢„Å´Êàª„Çã</button>
                </div>
                
                <h1>${currentRaidTier.name}</h1>
                <h2>„ÉÅ„Éº„É†: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>Ë£ÖÂÇôÂàÜÈÖç</h3>
                    <div class="dashboard-layer-grid">
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(1)">1Â±§</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(2)">2Â±§</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(3)">3Â±§</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(4)">4Â±§</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showPlayerManagement()">„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</button>
                        <button class="nav-button" onclick="showPriorityManagement()">ÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆö</button>
                        <button class="nav-button" onclick="showStatistics()">Áµ±Ë®àÊÉÖÂ†±</button>
                        <button class="nav-button" onclick="showAllocationHistory()">ÈÖçÂ∏ÉÂ±•Ê≠¥</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>„É¨„Ç§„ÉâÊÉÖÂ†±</h3>
                    <p><strong>„É¨„Ç§„ÉâÂêç:</strong> ${currentRaidTier.name}</p>
                    <p><strong>Ë™¨Êòé:</strong> ${currentRaidTier.description || 'Èõ∂Âºè„É¨„Ç§„Éâ'}</p>
                </div>
            `;
        }
        
        // Êñ∞„Åó„ÅÑ„É¨„Ç§„Éâ‰ΩúÊàêÁîªÈù¢„ÇíË°®Á§∫
        function createNewTier() {
            showCreateTierForm();
        }
        
        // „É¨„Ç§„Éâ‰ΩúÊàê„Éï„Ç©„Éº„É†Ë°®Á§∫
        function showCreateTierForm() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showMainDashboard()">„É¨„Ç§„ÉâÈÅ∏ÊäûÁîªÈù¢„Å´Êàª„Çã</button>
                </div>
                
                <h1>Êñ∞„Åó„ÅÑ„É¨„Ç§„Éâ„Çí‰ΩúÊàê</h1>
                <h2>„ÉÅ„Éº„É†: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>„É¨„Ç§„ÉâÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    
                    <div class="form-grid" style="max-width: 600px;">
                        <div class="form-group">
                            <label for="tierName">„É¨„Ç§„ÉâÂêçÔºàÂøÖÈ†àÔºâ:</label>
                            <input type="text" id="tierName" 
                                   placeholder="‰æãÔºö7.1 „Ç¢„Éº„ÇØ„Ç¨„Éº„Éá„Ç£„Ç¢„É≥Èõ∂Âºè" 
                                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                            <small style="color: #666; margin-top: 5px; display: block;">
                                „Éë„ÉÉ„ÉÅÁï™Âè∑„ÇÑ„Éú„ÇπÂêç„ÇíÂê´„ÇÅ„Çã„Å®ÂàÜ„Åã„Çä„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="tierDescription">Ë™¨ÊòéÔºàÁúÅÁï•ÂèØÔºâ:</label>
                            <textarea id="tierDescription" 
                                      placeholder="‰æãÔºöÊñ∞„Éë„ÉÉ„ÉÅ„ÅÆÈõ∂Âºè„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÄÅIL730Ë£ÖÂÇô„Åå„Éâ„É≠„ÉÉ„Éó" 
                                      style="width: 100%; height: 80px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                Á©∫Ê¨Ñ„ÅÆÂ†¥Âêà„ÅØ„ÄåÈõ∂Âºè„É¨„Ç§„Éâ„Äç„ÅåË®≠ÂÆö„Åï„Çå„Åæ„Åô
                            </small>
                        </div>
                        
                        <div class="form-actions" style="margin-top: 30px;">
                            <button onclick="submitCreateTier()" class="primary-btn" style="margin-right: 15px;">
                                „É¨„Ç§„Éâ„Çí‰ΩúÊàê
                            </button>
                            <button onclick="showMainDashboard()" class="secondary-btn">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="section" style="background-color: #f8f9fa; border-left: 4px solid #17a2b8;">
                    <h4>üí° ‰ΩúÊàêÂæå„ÅÆÊµÅ„Çå</h4>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>„É¨„Ç§„Éâ„Çí‰ΩúÊàê„Åô„Çã„Å®„ÄÅ„Åù„ÅÆ„É¨„Ç§„ÉâÂ∞ÇÁî®„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´ÁßªÂãï„Åó„Åæ„Åô</li>
                        <li>„Åæ„Åö„ÅØ„Äå„É°„É≥„Éê„ÉºÁÆ°ÁêÜ„Äç„Åã„Çâ8‰∫∫„ÅÆ„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                        <li>Ë£ÖÂÇôÊñπÈáù„ÇÑÊ≠¶Âô®Â∏åÊúõ„ÇíË®≠ÂÆö„Åó„Å¶„ÄÅË£ÖÂÇôÂàÜÈÖç„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô</li>
                    </ol>
                </div>
            `;
            
            // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂêçÂâçÂÖ•ÂäõÊ¨Ñ„Å´Ë®≠ÂÆö
            setTimeout(() => {
                const nameInput = document.getElementById('tierName');
                if (nameInput) nameInput.focus();
            }, 100);
        }
        
        // „É¨„Ç§„Éâ‰ΩúÊàêÂÆüË°å
        async function submitCreateTier() {
            const nameInput = document.getElementById('tierName');
            const descriptionInput = document.getElementById('tierDescription');
            
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim() || 'Èõ∂Âºè„É¨„Ç§„Éâ';
            
            if (!name) {
                showError('„É¨„Ç§„ÉâÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                nameInput.focus();
                return;
            }
            
            try {
                showMessage('„É¨„Ç§„Éâ„Çí‰ΩúÊàê‰∏≠...', 'info');
                
                const tierId = 'tier_' + Date.now();
                const tierData = {
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString()
                };
                
                // Supabase„Å´‰øùÂ≠ò
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .insert({
                        team_id: currentTeamId,
                        tier_id: tierId,
                        data_type: 'settings',
                        content: { raidTier: tierData }
                    });
                
                if (error) {
                    throw new Error(`‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
                }
                
                // „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÊõ¥Êñ∞
                if (!appData.raidTiers) appData.raidTiers = {};
                appData.raidTiers[tierId] = tierData;
                
                showSuccess(`„É¨„Ç§„Éâ„Äå${name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`);
                
                // ‰ΩúÊàê„Åó„Åü„É¨„Ç§„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´ÁßªÂãï
                currentRaidTier = { id: tierId, ...tierData };
                showTierDashboard();
                
            } catch (error) {
                console.error('„É¨„Ç§„Éâ‰ΩúÊàê„Ç®„É©„Éº:', error);
                showError('„É¨„Ç§„Éâ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÂÑ™ÂÖàÈ†Ü‰ΩçÁÆ°ÁêÜÁîªÈù¢
        function showPriorityManagement() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            
            if (Object.keys(players).length === 0) {
                showError('„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Åæ„Åö„É°„É≥„Éê„ÉºÁÆ°ÁêÜ„Åã„ÇâË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            // ÁèæÂú®„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà: D1‚ÜíD2‚ÜíD3‚ÜíD4‚ÜíMT‚ÜíST‚ÜíH1‚ÜíH2Ôºâ
            const defaultPriority = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            const currentPriority = appData.settings?.positionPriority || defaultPriority;
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                </div>
                
                <h1>„Éù„Ç∏„Ç∑„Éß„É≥ÈñìÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆö</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>„Éù„Ç∏„Ç∑„Éß„É≥ÈñìÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆö</h3>
                    <p>Ë£ÖÂÇô„ÉªÁ¥†Êùê„Åô„Åπ„Å¶„ÅÆÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ„Å´‰ΩúÁî®„Åô„ÇãÂÑ™ÂÖàÈ†Ü‰Ωç„Åß„Åô„ÄÇ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÈ†ÜÂ∫è„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    
                    <div class="priority-container">
                        <div class="priority-list" id="priorityList">
                            ${currentPriority.map((position, index) => {
                                const player = players[position];
                                if (!player) return '';
                                
                                // „É≠„Éº„É´Âà•„ÇØ„É©„ÇπÂà§ÂÆö
                                const roleClass = getPositionRoleClass(position);
                                
                                return `
                                    <div class="priority-item" data-position="${position}" draggable="true">
                                        <div class="priority-rank">${index + 1}</div>
                                        <div class="priority-info">
                                            <span class="position-badge ${roleClass}">${position}</span>
                                            <span class="player-name">${player.name}</span>
                                            <span class="player-job">[${player.job}]</span>
                                        </div>
                                        <div class="drag-handle">‚ãÆ‚ãÆ</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="priority-actions">
                        <button onclick="savePrioritySettings()" class="primary-btn">
                            ÂÑ™ÂÖàÈ†Ü‰Ωç„Çí‰øùÂ≠ò
                        </button>
                        <button onclick="resetPrioritySettings()" class="secondary-btn">
                            „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô
                        </button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #f8f9fa; border-left: 4px solid #17a2b8;">
                    <h4>üí° ÂÑ™ÂÖàÈ†Ü‰Ωç„ÅÆ‰ªïÁµÑ„Åø</h4>
                    <p><strong>Ë£ÖÂÇôÂàÜÈÖçÔºö</strong> Ë£ÖÂÇôÊñπÈáùÔºàÈõ∂Âºè/„Éà„Éº„É†„Çπ„Éà„Éº„É≥Ôºâ„Å®„Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÈ†Ü‰Ωç„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅßÂèñÂæóËÄÖ„ÇíÊ±∫ÂÆö</p>
                    <p><strong>Á¥†ÊùêÂàÜÈÖçÔºö</strong> „Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÈ†Ü‰Ωç„Å´Âü∫„Å•„ÅÑ„Å¶Ê≠¶Âô®Áü≥„ÄÅÁ°¨ÂåñËñ¨„ÄÅÂº∑ÂåñËñ¨„ÄÅÂº∑ÂåñÁπäÁ∂≠„ÅÆÂèñÂæóËÄÖ„ÇíÊ±∫ÂÆö</p>
                    <p><strong>Ê≠¶Âô®ÂàÜÈÖçÔºö</strong> Ê≠¶Âô®Â∏åÊúõÈ†Ü‰Ωç„Å®„Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÈ†Ü‰Ωç„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅßÂèñÂæóËÄÖ„ÇíÊ±∫ÂÆö</p>
                    <p><strong>NoteÔºö</strong> ÂÑ™ÂÖàÈ†Ü‰Ωç„ÅØË£ÖÂÇô„ÉªÁ¥†Êùê„Åô„Åπ„Å¶„ÅÆÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ„Å´‰ΩúÁî®„Åó„Åæ„Åô„ÄÇ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÈ†ÜÂ∫è„ÇíË™øÊï¥„Åß„Åç„Åæ„Åô„ÄÇ</p>
                </div>
            `;
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ„ÇíÂàùÊúüÂåñ
            initializeDragAndDrop();
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩÂàùÊúüÂåñ
        function initializeDragAndDrop() {
            const priorityList = document.getElementById('priorityList');
            if (!priorityList) return;
            
            let draggedElement = null;
            
            priorityList.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('priority-item')) {
                    draggedElement = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });
            
            priorityList.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('priority-item')) {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                    // ÂÖ®„Å¶„ÅÆ drag-over „ÇØ„É©„Çπ„ÇíÂâäÈô§
                    document.querySelectorAll('.priority-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                }
            });
            
            priorityList.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Å¶„ÅÑ„ÇãË¶ÅÁ¥†‰ª•Â§ñ„Å´„Éõ„Éê„ÉºÂäπÊûú„ÇíÈÅ©Áî®
                const closestItem = e.target.closest('.priority-item');
                if (closestItem && closestItem !== draggedElement) {
                    // ÂÖ®„Å¶„ÅÆ drag-over „ÇØ„É©„Çπ„ÇíÂâäÈô§
                    document.querySelectorAll('.priority-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                    // ÁèæÂú®„ÅÆË¶ÅÁ¥†„Å´ drag-over „ÇØ„É©„Çπ„ÇíËøΩÂä†
                    closestItem.classList.add('drag-over');
                }
            });
            
            priorityList.addEventListener('dragleave', function(e) {
                const closestItem = e.target.closest('.priority-item');
                if (closestItem && !priorityList.contains(e.relatedTarget)) {
                    closestItem.classList.remove('drag-over');
                }
            });
            
            priorityList.addEventListener('drop', function(e) {
                e.preventDefault();
                
                const closestItem = e.target.closest('.priority-item');
                if (draggedElement && closestItem && draggedElement !== closestItem) {
                    // „Éâ„É≠„ÉÉ„Éó‰ΩçÁΩÆ„ÇíË®àÁÆó
                    const rect = closestItem.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    
                    if (e.clientY < midpoint) {
                        // ‰∏äÂçäÂàÜ„Å´„Éâ„É≠„ÉÉ„Éó - Ââç„Å´ÊåøÂÖ•
                        priorityList.insertBefore(draggedElement, closestItem);
                    } else {
                        // ‰∏ãÂçäÂàÜ„Å´„Éâ„É≠„ÉÉ„Éó - Âæå„Å´ÊåøÂÖ•
                        priorityList.insertBefore(draggedElement, closestItem.nextSibling);
                    }
                    
                    updatePriorityNumbers();
                }
                
                // ÂÖ®„Å¶„ÅÆ drag-over „ÇØ„É©„Çπ„ÇíÂâäÈô§
                document.querySelectorAll('.priority-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
            });
        }
        
        // ÂÑ™ÂÖàÈ†Ü‰ΩçÁï™Âè∑Êõ¥Êñ∞
        function updatePriorityNumbers() {
            const items = document.querySelectorAll('.priority-item');
            items.forEach((item, index) => {
                const rankElement = item.querySelector('.priority-rank');
                if (rankElement) {
                    rankElement.textContent = index + 1;
                }
            });
        }
        
        // ÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆö‰øùÂ≠ò
        async function savePrioritySettings() {
            try {
                const items = document.querySelectorAll('.priority-item');
                const newPriority = Array.from(items).map(item => item.dataset.position);
                
                // Ë®≠ÂÆö„Çí‰øùÂ≠ò
                if (!appData.settings) appData.settings = {};
                appData.settings.positionPriority = newPriority;
                
                // Supabase„Å´‰øùÂ≠ò
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: currentRaidTier.id,
                        data_type: 'settings',
                        content: { positionPriority: newPriority }
                    });
                
                if (error) {
                    throw new Error(`‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
                }
                
                showSuccess('ÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                
            } catch (error) {
                console.error('ÂÑ™ÂÖàÈ†Ü‰Ωç‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('ÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÂÑ™ÂÖàÈ†Ü‰ΩçË®≠ÂÆö„É™„Çª„ÉÉ„Éà
        async function resetPrioritySettings() {
            if (confirm('ÂÑ™ÂÖàÈ†Ü‰Ωç„Çí„Éá„Éï„Ç©„É´„ÉàÔºàD1‚ÜíD2‚ÜíD3‚ÜíD4‚ÜíMT‚ÜíST‚ÜíH1‚ÜíH2Ôºâ„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) {
                const defaultPriority = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
                
                // Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà
                if (!appData.settings) {
                    appData.settings = {};
                }
                appData.settings.positionPriority = defaultPriority;
                
                // Supabase„Å´‰øùÂ≠ò
                try {
                    await saveDataToSupabase('settings', { positionPriority: defaultPriority });
                    showSuccess('ÂÑ™ÂÖàÈ†Ü‰Ωç„Çí„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åó„Åü');
                } catch (error) {
                    console.error('Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº:', error);
                    showError('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                // ÁîªÈù¢„ÇíÂÜçË™≠„ÅøËæº„Åø
                showPriorityManagement();
            }
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÁÆ°ÁêÜÊ©üËÉΩ
        function showPlayerManagement() {
            showPlayerSetup();
        }
        
        // „Éó„É¨„Ç§„É§„ÉºË®≠ÂÆöÁîªÈù¢Ôºà„Çø„ÉñÂΩ¢ÂºèÔºâ
        function showPlayerSetup() {
            showTabbedSetup('players');
        }
        
        // „Çø„ÉñÂΩ¢Âºè„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢
        function showTabbedSetup(activeTab = 'players') {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>„É°„É≥„Éê„Éº„ÉªË£ÖÂÇôË®≠ÂÆö</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button ${activeTab === 'players' ? 'active' : ''}" onclick="showTabbedSetup('players')">
                            „É°„É≥„Éê„ÉºÊÉÖÂ†±
                        </button>
                        <button class="tab-button ${activeTab === 'policy' ? 'active' : ''}" onclick="showTabbedSetup('policy')">
                            Ë£ÖÂÇôÊñπÈáù
                        </button>
                        <button class="tab-button ${activeTab === 'weapons' ? 'active' : ''}" onclick="showTabbedSetup('weapons')">
                            Ê≠¶Âô®Â∏åÊúõ
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        ${getTabContent(activeTab)}
                    </div>
                    
                    <div class="navigation" style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                        <button class="save-btn" onclick="saveCurrentTab('${activeTab}')">
                            ${activeTab === 'players' ? '„É°„É≥„Éê„ÉºÊÉÖÂ†±„Çí‰øùÂ≠ò' : activeTab === 'policy' ? 'Ë£ÖÂÇôÊñπÈáù„Çí‰øùÂ≠ò' : 'Ê≠¶Âô®Â∏åÊúõ„Çí‰øùÂ≠ò'}
                        </button>
                        <button class="nav-button" onclick="saveCurrentTabAndContinue('${activeTab}')">
                            Ë®≠ÂÆöÂÆå‰∫Ü
                        </button>
                    </div>
                </div>
            `;
        }
        
        // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁîüÊàê
        function getTabContent(tabName) {
            const players = appData.players[currentRaidTier.id] || {};
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            
            if (tabName === 'players') {
                return `
                    <h3>8‰∫∫„ÅÆ„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position] || {};
                            const roleJobs = {
                                'MT': ['„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº'],
                                'ST': ['„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº'],
                                'H1': ['ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ£´'],
                                'H2': ['Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ'],
                                'D1': ['„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº'],
                                'D2': ['„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº'],
                                'D3': ['ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê'],
                                'D4': ['ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº']
                            };
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="position-badge ${getPositionRoleClass(position)}">${position}</span>
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>„Éó„É¨„Ç§„É§„ÉºÂêçÔºàÂøÖÈ†àÔºâ:</label>
                                        <input type="text" id="${position}-name" value="${player.name || ''}" 
                                               placeholder="„Éó„É¨„Ç§„É§„ÉºÂêç„ÇíÂÖ•Âäõ" class="job-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;">
                                    </div>
                                    
                                    
                                    <div style="margin: 10px 0;">
                                        <label>„Ç∏„Éß„ÉñÔºàÂøÖÈ†àÔºâ:</label>
                                        <select id="${position}-job" class="job-select">
                                            <option value="">„Ç∏„Éß„Éñ„ÇíÈÅ∏Êäû</option>
                                            ${roleJobs[position].map(job => `
                                                <option value="${job}" ${player.job === job ? 'selected' : ''}>${job}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'policy') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>„Åæ„Åö„É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Åß„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        </div>
                    `;
                }
                
                const slots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
                
                return `
                    <h3>ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆË£ÖÂÇôÊñπÈáù„ÇíË®≠ÂÆö</h3>
                    <p>Èõ∂ÂºèÔºöÈõ∂ÂºèË£ÖÂÇô„ÇíÂÑ™ÂÖàÂèñÂæó„ÄÅ„Éà„Éº„É†„Çπ„Éà„Éº„É≥Ôºö„Éà„Éº„É†„Çπ„Éà„Éº„É≥Ë£ÖÂÇô„ÅßÂçÅÂàÜ</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge ${getPositionRoleClass(position)}">${position} - ${player.job}</span>
                                    </div>
                                    <div class="equipment-policy">
                                        <div class="policy-grid">
                                            ${slots.map(slot => `
                                                <div class="policy-item">
                                                    <label>${slot}</label>
                                                    <select id="${position}-${slot}-policy">
                                                        <option value="Èõ∂Âºè" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'Èõ∂Âºè') ? 'selected' : ''}>Èõ∂Âºè</option>
                                                        <option value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === '„Éà„Éº„É†„Çπ„Éà„Éº„É≥') ? 'selected' : ''}>„Éà„Éº„É†„Çπ„Éà„Éº„É≥</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'weapons') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>„Åæ„Åö„É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Åß„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        </div>
                    `;
                }
                
                const allWeapons = [
                    '„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº',
                    'ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ£´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ',
                    '„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº',
                    'ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº',
                    'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê'
                ];
                
                return `
                    <h3>4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÂ∏åÊúõÈ†Ü‰Ωç„ÇíË®≠ÂÆö</h3>
                    <p>Á¨¨‰∏ÄÂ∏åÊúõ„ÅØËá™ÂãïÁöÑ„Å´„É°„Ç§„É≥„Ç∏„Éß„Éñ„Å´„Å™„Çä„Åæ„Åô„ÄÇÁ¨¨‰∫å„ÄúÁ¨¨ÂõõÂ∏åÊúõ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            const weaponWishes = player.weaponWishes || [];
                            const mainWeapon = player.job;
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge ${getPositionRoleClass(position)}">${position} - ${player.job}</span>
                                    </div>
                                    <div class="weapon-wishes">
                                        <div class="wish-priority">
                                            <label>Á¨¨‰∏ÄÂ∏åÊúõ („É°„Ç§„É≥„Ç∏„Éß„Éñ):</label>
                                            <input type="text" value="${mainWeapon}" readonly style="background-color: #e9ecef; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; min-width: 120px;">
                                        </div>
                                        <div class="wish-priority">
                                            <label>Á¨¨‰∫åÂ∏åÊúõ:</label>
                                            <select id="${position}-weapon-wish-2">
                                                <option value="">ÈÅ∏Êäû</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[1] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>Á¨¨‰∏âÂ∏åÊúõ:</label>
                                            <select id="${position}-weapon-wish-3">
                                                <option value="">ÈÅ∏Êäû</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[2] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>Á¨¨ÂõõÂ∏åÊúõ:</label>
                                            <select id="${position}-weapon-wish-4">
                                                <option value="">ÈÅ∏Êäû</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[3] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            return '';
        }
        
        // ÁèæÂú®„ÅÆ„Çø„Éñ„ÅÆ„Åø‰øùÂ≠ò
        async function saveCurrentTab(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                    showSuccess('„É°„É≥„Éê„ÉºÊÉÖÂ†±„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                    showSuccess('Ë£ÖÂÇôÊñπÈáù„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                    showSuccess('Ê≠¶Âô®Â∏åÊúõ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // ÁèæÂú®„ÅÆ„Çø„Éñ„Çí‰øùÂ≠ò„Åó„Å¶Ê¨°„Å∏ÈÄ≤„ÇÄ
        async function saveCurrentTabAndContinue(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                }
                
                showSuccess('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                
                // ÂÖ®„Å¶Ë®≠ÂÆöÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏
                if (Object.keys(appData.players[currentRaidTier.id] || {}).length > 0) {
                    showTierDashboard();
                } else {
                    showError('„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                }
            } catch (error) {
                console.error('Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±‰øùÂ≠ò
        async function savePlayersData() {
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            
            if (!appData.players[currentRaidTier.id]) {
                appData.players[currentRaidTier.id] = {};
            }
            
            for (const position of positions) {
                const nameInput = document.getElementById(`${position}-name`);
                const jobSelect = document.getElementById(`${position}-job`);
                
                if (!nameInput || !jobSelect) continue;
                
                const name = nameInput.value.trim();
                const job = jobSelect.value;
                
                if (!name || !job) {
                    throw new Error(`${position}„ÅÆ„Éó„É¨„Ç§„É§„ÉºÂêç„Å®„Ç∏„Éß„Éñ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                }
                
                // Êó¢Â≠ò„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰øùÊåÅ
                const existingPlayer = appData.players[currentRaidTier.id][position] || {};
                
                appData.players[currentRaidTier.id][position] = {
                    name: name,
                    job: job,
                    position: position,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    weaponWishes: existingPlayer.weaponWishes || [],
                    currentEquipment: existingPlayer.currentEquipment || {},
                    dynamicPriority: existingPlayer.dynamicPriority || 0,
                    allocationHistory: existingPlayer.allocationHistory || []
                };
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Ë£ÖÂÇôÊñπÈáù‰øùÂ≠ò
        async function saveEquipmentPolicyData() {
            const players = appData.players[currentRaidTier.id];
            const slots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
            
            for (const [position, player] of Object.entries(players)) {
                for (const slot of slots) {
                    const policyElement = document.getElementById(`${position}-${slot}-policy`);
                    if (policyElement) {
                        const policy = policyElement.value;
                        player.equipmentPolicy[slot] = policy;
                    }
                }
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // „Çø„ÉñÂ∞ÇÁî®‰øùÂ≠òÈñ¢Êï∞
        async function savePlayersDataTab() {
            try {
                await savePlayersData();
                showSuccess('„É°„É≥„Éê„ÉºÊÉÖÂ†±„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('„É°„É≥„Éê„ÉºÊÉÖÂ†±‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        async function saveEquipmentPolicyDataTab() {
            try {
                await saveEquipmentPolicyData();
                showSuccess('Ë£ÖÂÇôÊñπÈáù„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Ë£ÖÂÇôÊñπÈáù‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('Ë£ÖÂÇôÊñπÈáù„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        async function saveWeaponWishesDataTab() {
            try {
                await saveWeaponWishesData();
                showSuccess('Ê≠¶Âô®Â∏åÊúõ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Ê≠¶Âô®Â∏åÊúõ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('Ê≠¶Âô®Â∏åÊúõ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Ê≠¶Âô®Â∏åÊúõ‰øùÂ≠ò
        async function saveWeaponWishesData() {
            const players = appData.players[currentRaidTier.id];
            
            for (const [position, player] of Object.entries(players)) {
                const mainJob = player.job;
                const wish2Element = document.getElementById(`${position}-weapon-wish-2`);
                const wish3Element = document.getElementById(`${position}-weapon-wish-3`);
                const wish4Element = document.getElementById(`${position}-weapon-wish-4`);
                
                // Á¨¨‰∏ÄÂ∏åÊúõ„ÅØ„É°„Ç§„É≥„Ç∏„Éß„Éñ„ÄÅÁ¨¨‰∫å„ÄúÁ¨¨ÂõõÂ∏åÊúõ„ÅØÈÅ∏Êäû„Åï„Çå„ÅüÂÄ§
                player.weaponWishes = [
                    mainJob,
                    wish2Element ? wish2Element.value : '',
                    wish3Element ? wish3Element.value : '',
                    wish4Element ? wish4Element.value : ''
                ].filter(wish => wish !== ''); // Á©∫„ÅÆÂÄ§„ÇíÈô§Â§ñ
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // „Éá„Éº„ÇøÁßªË°åÊ©üËÉΩ
        
        // JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        async function importFromJSON() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('JSON„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            try {
                showMessage('„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...', 'info');
                
                const text = await file.text();
                const importData = JSON.parse(text);
                
                // „Éá„Éº„ÇøÂΩ¢Âºè„ÅÆÊ§úË®º„Å®Â§âÊèõ
                const convertedData = await convertImportData(importData);
                
                if (!convertedData) {
                    showError('ÂØæÂøú„Åó„Å¶„ÅÑ„Å™„ÅÑ„Éá„Éº„ÇøÂΩ¢Âºè„Åß„Åô„ÄÇ');
                    return;
                }
                
                // Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆË°®Á§∫
                let playerCount = 0;
                let tierCount = 0;
                
                if (convertedData.type === 'collaborative') {
                    tierCount = Object.keys(convertedData.players || {}).length;
                    playerCount = Object.values(convertedData.players || {}).reduce((total, tierPlayers) => {
                        return total + Object.keys(tierPlayers || {}).length;
                    }, 0);
                } else if (convertedData.type === 'simple') {
                    playerCount = Object.keys(convertedData.players || {}).length;
                    tierCount = 1;
                }
                
                // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
                const confirmMessage = `‰ª•‰∏ã„ÅÆ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„ÅôÔºö
                
„Éó„É¨„Ç§„É§„ÉºÊï∞: ${playerCount}‰∫∫
„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Êï∞: ${tierCount}ÂÄã
„Éá„Éº„ÇøÂΩ¢Âºè: ${convertedData.type === 'collaborative' ? 'ÂÖ±ÂêåÂà©Áî®Áâà' : 'Á∞°ÊòìÁâà'}

ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // „Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
                await importConvertedData(convertedData);
                
                showSuccess(`„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÔºà${playerCount}‰∫∫„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÁôªÈå≤Ôºâ`);
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                if (error.name === 'SyntaxError') {
                    showError('JSON„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    showError('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
        }
        
        // JSON„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆÊÉÖÂ†±Ë°®Á§∫„ÇíË®≠ÂÆö
            document.addEventListener('change', function(event) {
                if (event.target.id === 'jsonFileInput') {
                    const file = event.target.files[0];
                    const fileInfo = document.getElementById('jsonFileInfo');
                    const fileName = document.getElementById('selectedFileName');
                    const fileDetails = document.getElementById('fileDetails');
                    
                    if (file && fileInfo && fileName && fileDetails) {
                        fileName.textContent = file.name;
                        fileDetails.textContent = `„Çµ„Ç§„Ç∫: ${(file.size / 1024).toFixed(2)} KB, ÊúÄÁµÇÊõ¥Êñ∞: ${new Date(file.lastModified).toLocaleString()}`;
                        fileInfo.style.display = 'block';
                    } else if (fileInfo) {
                        fileInfo.style.display = 'none';
                    }
                }
            });
        });
        
        // CSV„Åã„Çâ„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        async function importFromCSV() {
            const csvText = document.getElementById('csvTextArea').value.trim();
            
            if (!csvText) {
                showError('CSV„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const players = {};
                
                for (let i = 1; i < lines.length; i++) { // „Éò„ÉÉ„ÉÄ„ÉºË°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                    const columns = lines[i].split(',').map(col => col.trim());
                    
                    if (columns.length < 4) continue;
                    
                    const [position, name, job] = columns;
                    
                    players[position] = {
                        name: name,
                        job: job,
                        position: position,
                        equipmentPolicy: {},
                        weaponWishes: [job],
                        currentEquipment: {},
                        dynamicPriority: 0,
                        allocationHistory: []
                    };
                }
                
                if (Object.keys(players).length === 0) {
                    showError('ÊúâÂäπ„Å™„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }
                
                // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
                if (!confirm(`${Object.keys(players).length}‰∫∫„ÅÆ„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)) {
                    return;
                }
                
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                appData.players[currentRaidTier.id] = players;
                await saveDataToSupabase('players', players);
                
                showSuccess('CSV„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('CSV„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                showError('CSV„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // CSV„Éá„Éº„Çø„ÇØ„É™„Ç¢
        function clearCSVData() {
            const csvTextArea = document.getElementById('csvTextArea');
            if (csvTextArea) {
                csvTextArea.value = '';
                showSuccess('CSV„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„Åø„É™„Çª„ÉÉ„Éà
        async function resetAllPlayersData() {
            if (!confirm('ÁèæÂú®„ÅÆ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                return;
            }
            
            if (!confirm('Êú¨ÂΩì„Å´„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÄÅË£ÖÂÇôÊñπÈáù„ÄÅÊ≠¶Âô®Â∏åÊúõ„Åå„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            try {
                // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„ÅøÂâäÈô§
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                
                // Supabase„Åã„Çâ„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„ÅøÂâäÈô§
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id)
                    .eq('data_type', 'players');
                
                showSuccess('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                showError('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÁèæÂú®„ÅÆ„ÉÜ„Ç£„Ç¢„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà
        async function resetCurrentTierData() {
            if (!confirm('ÁèæÂú®„ÅÆ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                return;
            }
            
            if (!confirm('Êú¨ÂΩì„Å´„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü„Åô„Åπ„Å¶„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÄÅË£ÖÂÇôÊñπÈáù„ÄÅÂàÜÈÖçÂ±•Ê≠¥„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            try {
                // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÂâäÈô§
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                if (appData.allocations[currentRaidTier.id]) {
                    delete appData.allocations[currentRaidTier.id];
                }
                
                // Supabase„Åã„Çâ„ÇÇÂâäÈô§
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id);
                
                showSuccess('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                showError('„Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Ç§„É≥„Éù„Éº„Éà„Éá„Éº„Çø„ÅÆÂ§âÊèõ
        async function convertImportData(importData) {
            // collaborative_index.htmlÂΩ¢Âºè„ÅÆÂ†¥Âêà
            if (importData.raidTiers && importData.players && importData.allocations) {
                return {
                    type: 'collaborative',
                    players: importData.players,
                    allocations: importData.allocations
                };
            }
            
            // ÂçòÁ¥î„Å™„Éó„É¨„Ç§„É§„Éº„É™„Çπ„ÉàÂΩ¢Âºè„ÅÆÂ†¥Âêà
            if (Array.isArray(importData) && importData.length > 0 && importData[0].name) {
                const players = {};
                importData.forEach((player, index) => {
                    const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
                    const position = positions[index] || `D${index - 3}`;
                    
                    players[position] = {
                        name: player.name,
                        characterName: player.characterName || '',
                        job: player.job,
                        position: position,
                        equipmentPolicy: player.equipmentPolicy || {},
                        weaponWishes: player.weaponWishes || [player.job],
                        currentEquipment: player.currentEquipment || {},
                        dynamicPriority: player.dynamicPriority || 0,
                        allocationHistory: player.allocationHistory || []
                    };
                });
                
                return {
                    type: 'simple',
                    players: players
                };
            }
            
            return null;
        }
        
        // Â§âÊèõÊ∏à„Åø„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        async function importConvertedData(convertedData) {
            if (convertedData.type === 'collaborative') {
                // ÁèæÂú®„ÅÆ„ÉÜ„Ç£„Ç¢„Å´ÂØæÂøú„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
                const tierData = Object.values(convertedData.players)[0] || {};
                appData.players[currentRaidTier.id] = tierData;
                
                // ÂàÜÈÖçÂ±•Ê≠¥„ÇÇÁßªË°å
                if (convertedData.allocations) {
                    const allocationData = Object.values(convertedData.allocations)[0] || {};
                    appData.allocations[currentRaidTier.id] = allocationData;
                    await saveDataToSupabase('allocations', allocationData);
                }
            } else if (convertedData.type === 'simple') {
                appData.players[currentRaidTier.id] = convertedData.players;
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Supabase„Éá„Éº„Çø‰øùÂ≠ò„Éò„É´„Éë„Éº
        async function saveDataToSupabase(dataType, content) {
            const { error } = await window.supabaseClient
                .from('raid_data')
                .upsert({
                    team_id: currentTeamId,
                    tier_id: currentRaidTier.id,
                    data_type: dataType,
                    content: content
                });
                
            if (error) {
                throw new Error(`‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        }
        
        // Ë£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†
        function showEquipmentAllocation() {
            const content = document.getElementById('content');
            
            // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„É°„É≥„Éê„ÉºË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                </div>
                
                <h1>Ë£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section" id="allocationResults" style="display: none;">
                    <h3>ÂàÜÈÖçÁµêÊûú</h3>
                    <div id="allocationContent"></div>
                </div>
            `;
        }
        
        // Áõ¥Êé•Â±§Âà•ÂàÜÈÖç„ÇíÂÆüË°åÔºà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Åã„ÇâÂëº„Å≥Âá∫„ÅóÔºâ
        async function showLayerAllocation(layer) {
            // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Åæ„Åö„É°„É≥„Éê„ÉºÁÆ°ÁêÜ„Åã„ÇâË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            if (playerCount < 8) {
                if (!confirm(`„É°„É≥„Éê„Éº„Åå${playerCount}‰∫∫„Åó„ÅãÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂàÜÈÖç„ÇíÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
            }
            
            // Ë£ÖÂÇôÂàÜÈÖçÁîªÈù¢„ÇíË°®Á§∫„Åó„Å¶„Åã„ÇâË©≤ÂΩìÂ±§„ÅÆÂá¶ÁêÜ„ÇíÂÆüË°å
            showEquipmentAllocation();
            
            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂàÜÈÖçÂá¶ÁêÜ„ÇíÂÆüË°åÔºàDOMÊõ¥Êñ∞„ÅÆ„Åü„ÇÅÔºâ
            setTimeout(() => {
                processLayerAllocation(layer);
            }, 100);
        }
        
        // Â±§Âà•Ë£ÖÂÇôÂàÜÈÖçÂá¶ÁêÜ
        async function processLayerAllocation(layer) {
            try {
                showMessage('ÂàÜÈÖçÂá¶ÁêÜ‰∏≠...', 'info');
                
                // Â±§Âà•„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó
                const drops = getLayerDrops(layer);
                
                // ÂàÜÈÖçÂÑ™ÂÖàÂ∫¶„ÇíË®àÁÆó
                const allocationResults = calculateAllocation(layer, drops);
                
                // ÁµêÊûú„ÇíË°®Á§∫
                displayAllocationResults(layer, allocationResults);
                
            } catch (error) {
                console.error('ÂàÜÈÖçÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                showError('ÂàÜÈÖçÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Â±§Âà•„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†ÂÆöÁæ©
        function getLayerDrops(layer) {
            const drops = {
                1: [
                    { name: 'ËÄ≥Ë£ÖÂÇô', slot: 'ËÄ≥', type: 'equipment', itemLevel: '' },
                    { name: 'È¶ñË£ÖÂÇô', slot: 'È¶ñ', type: 'equipment', itemLevel: '' },
                    { name: 'ËÖïË£ÖÂÇô', slot: 'ËÖï', type: 'equipment', itemLevel: '' },
                    { name: 'ÊåáË£ÖÂÇô', slot: 'Êåá', type: 'equipment', itemLevel: '' }
                ],
                2: [
                    { name: 'È†≠Ë£ÖÂÇô', slot: 'È†≠', type: 'equipment', itemLevel: '' },
                    { name: 'ÊâãË£ÖÂÇô', slot: 'Êâã', type: 'equipment', itemLevel: '' },
                    { name: 'Ë∂≥Ë£ÖÂÇô', slot: 'Ë∂≥', type: 'equipment', itemLevel: '' },
                    { name: 'Ê≠¶Âô®Áü≥', slot: 'Ê≠¶Âô®Áü≥', type: 'material', itemLevel: '' },
                    { name: 'Á°¨ÂåñËñ¨', slot: 'Á°¨ÂåñËñ¨', type: 'material', itemLevel: '' }
                ],
                3: [
                    { name: 'ËÉ¥Ë£ÖÂÇô', slot: 'ËÉ¥', type: 'equipment', itemLevel: '' },
                    { name: 'ËÑöË£ÖÂÇô', slot: 'ËÑö', type: 'equipment', itemLevel: '' },
                    { name: 'Âº∑ÂåñËñ¨', slot: 'Âº∑ÂåñËñ¨', type: 'material', itemLevel: '' },
                    { name: 'Âº∑ÂåñÁπäÁ∂≠', slot: 'Âº∑ÂåñÁπäÁ∂≠', type: 'material', itemLevel: '' }
                ],
                4: [
                    { name: 'ËÉ¥Ë£ÖÂÇô', slot: 'ËÉ¥', type: 'equipment', itemLevel: '' },
                    { name: 'Ê≠¶Âô®ÁÆ±', slot: 'Ê≠¶Âô®ÁÆ±', type: 'weapon_box', itemLevel: '' },
                    { name: 'Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®', slot: 'Ê≠¶Âô®', type: 'direct_weapon', itemLevel: '', weapon: null }
                ]
            };
            
            return drops[layer] || [];
        }
        
        // ÂàÜÈÖçÂÑ™ÂÖàÂ∫¶Ë®àÁÆó
        function calculateAllocation(layer, drops) {
            const players = appData.players[currentRaidTier.id] || {};
            const results = {};
            
            drops.forEach(drop => {
                const allCandidates = [];
                
                Object.entries(players).forEach(([position, player]) => {
                    const priority = calculatePlayerPriority(player, drop);
                    allCandidates.push({
                        position,
                        player,
                        priority: priority.score,
                        reason: priority.reason,
                        type: priority.type,
                        canReceive: priority.canReceive
                    });
                });
                
                // ÂÑ™ÂÖàÂ∫¶È†Ü„Åß„ÇΩ„Éº„ÉàÔºàÂÖ®„Éó„É¨„Ç§„É§„ÉºÔºâ
                allCandidates.sort((a, b) => b.priority - a.priority);
                
                // ÂèñÂæóÂèØËÉΩ„Å™ÂÄôË£úËÄÖ„ÅÆ„ÅøÊäΩÂá∫
                const candidates = allCandidates.filter(c => c.canReceive);
                
                results[drop.slot] = {
                    drop,
                    candidates: allCandidates, // ÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆÂà§ÂÆöÁµêÊûú
                    recommended: candidates[0] || null // ÊúÄÂÑ™ÂÖà„ÅÆÂèñÂæóÂèØËÉΩËÄÖ
                };
            });
            
            return results;
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÂÑ™ÂÖàÂ∫¶Ë®àÁÆó
        function calculatePlayerPriority(player, drop) {
            let score = 0;
            let canReceive = false;
            let reason = 'Pass';
            let type = 'pass';
            
            if (drop.type === 'equipment') {
                // Ë£ÖÂÇô„ÅÆÂ†¥Âêà
                const policy = player.equipmentPolicy?.[drop.slot] || '„Éà„Éº„É†„Çπ„Éà„Éº„É≥';
                
                // ÁèæÂú®„ÅÆË£ÖÂÇôÁä∂Ê≥Å„ÇíÂèñÂæóÔºàÂàÜÈÖçÂ±•Ê≠¥„Åã„ÇâÔºâ
                const equipmentStatus = getPlayerEquipmentStatus(player.position, drop.slot);
                
                // Êñ≠Á´†‰∫§ÊèõËÄÖ„ÅÆÁâπÂà•Âá¶ÁêÜ
                if (equipmentStatus === 'Êñ≠Á´†‰∫§Êèõ') {
                    // Êú™ÂèñÂæóËÄÖ„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers(drop.slot, player.position);
                    
                    if (hasUnacquiredRaidPlayer) {
                        // Êú™ÂèñÂæóËÄÖ„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØÂàÜÈÖçÂØæË±°Â§ñ
                        type = 'pass';
                        reason = 'Pass (Êñ≠Á´†‰∫§Êèõ - ‰ªñ„Å´Êú™ÂèñÂæóËÄÖ„ÅÇ„Çä)';
                    } else {
                        // Êú™ÂèñÂæóËÄÖ„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂæ©Ê¥ª
                        canReceive = true;
                        type = 'need';
                        score = 1000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                        reason = 'Need (Êñ≠Á´†‰∫§Êèõ - Âæ©Ê¥ª)';
                    }
                } else if (equipmentStatus === 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à') {
                    // Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à„ÅØÂÆåÂÖ®„Å´ÂàÜÈÖçÂØæË±°Â§ñ
                    type = 'pass';
                    reason = 'Pass (Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à)';
                } else if (policy === 'Èõ∂Âºè' && equipmentStatus === 'Êú™ÂèñÂæó') {
                    canReceive = true;
                    type = 'need';
                    score = 1000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Need (Èõ∂Âºè)';
                } else if (equipmentStatus === 'Êú™ÂèñÂæó') {
                    canReceive = true;
                    type = 'greed';
                    score = 500 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Greed („Éà„Éº„É†ÂèØ)';
                } else {
                    type = 'pass';
                    reason = 'Pass (ÊâÄÊåÅÊ∏à„Åø)';
                }
            } else if (drop.type === 'material') {
                // Âº∑ÂåñÁ¥†Êùê„ÅÆÂ†¥ÂêàÔºàÂàÜÈÖçÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö„Å´Âü∫„Å•„ÅèÔºâ
                const materialStatus = getPlayerEquipmentStatus(player.position, drop.slot);
                
                // Êñ≠Á´†‰∫§ÊèõÁ¥†Êùê„ÅÆÁâπÂà•Âá¶ÁêÜ
                if (materialStatus === 'Êñ≠Á´†‰∫§Êèõ') {
                    type = 'pass';
                    reason = 'Pass (Êñ≠Á´†‰∫§Êèõ)';
                } else if (materialStatus === 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à') {
                    type = 'pass';
                    reason = 'Pass (Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à)';
                } else if (materialStatus === 'Êú™ÂèñÂæó') {
                    canReceive = true;
                    type = 'need';
                    score = getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Need (Á¥†Êùê)';
                } else {
                    type = 'pass';
                    reason = 'Pass (ÂèñÂæóÊ∏à„Åø)';
                }
            } else if (drop.type === 'weapon_box') {
                // Ê≠¶Âô®ÁÆ±„ÅÆÂ†¥Âêà
                const weaponStatus = getPlayerEquipmentStatus(player.position, 'Ê≠¶Âô®');
                
                if (weaponStatus === 'Êñ≠Á´†‰∫§Êèõ') {
                    // Êú™ÂèñÂæóËÄÖ„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers('Ê≠¶Âô®', player.position);
                    
                    if (hasUnacquiredRaidPlayer) {
                        type = 'pass';
                        reason = 'Pass (Êñ≠Á´†‰∫§Êèõ - ‰ªñ„Å´Êú™ÂèñÂæóËÄÖ„ÅÇ„Çä)';
                    } else {
                        canReceive = true;
                        type = 'need';
                        score = 2000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                        reason = 'Need (Êñ≠Á´†‰∫§Êèõ - Âæ©Ê¥ª)';
                    }
                } else if (weaponStatus === 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à') {
                    type = 'pass';
                    reason = 'Pass (Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à)';
                } else if (weaponStatus === 'Êú™ÂèñÂæó') {
                    canReceive = true;
                    type = 'need';
                    score = 2000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Need (Ê≠¶Âô®ÁÆ±)';
                } else {
                    type = 'pass';
                    reason = 'Pass (Ê≠¶Âô®ÊâÄÊåÅÊ∏à„Åø)';
                }
            } else if (drop.type === 'direct_weapon') {
                // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÂ†¥ÂêàÔºàÊ≠¶Âô®Â∏åÊúõ„Å´Âü∫„Å•„ÅèÔºâ
                const weaponWishes = player.weaponWishes || [];
                const weaponStatus = getPlayerEquipmentStatus(player.position, 'Ê≠¶Âô®');
                const weaponType = drop.weapon; // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠¶Âô®Á®Æ
                
                if (weaponStatus === 'Êñ≠Á´†‰∫§Êèõ') {
                    // Êú™ÂèñÂæóËÄÖ„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers('Ê≠¶Âô®', player.position);
                    
                    if (hasUnacquiredRaidPlayer) {
                        type = 'pass';
                        reason = 'Pass (Êñ≠Á´†‰∫§Êèõ - ‰ªñ„Å´Êú™ÂèñÂæóËÄÖ„ÅÇ„Çä)';
                    } else if (weaponType && weaponWishes.includes(weaponType)) {
                        canReceive = true;
                        type = 'need';
                        const wishIndex = weaponWishes.indexOf(weaponType);
                        score = 3000 + getPositionPriority(player.position) - (wishIndex * 100) - (player.dynamicPriority || 0);
                        reason = `Need (Êñ≠Á´†‰∫§Êèõ - Âæ©Ê¥ª„ÉªÁ¨¨${wishIndex + 1}Â∏åÊúõ)`;
                    } else {
                        canReceive = true;
                        type = 'greed';
                        score = 100 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                        reason = 'Greed (Êñ≠Á´†‰∫§Êèõ - Âæ©Ê¥ª)';
                    }
                } else if (weaponStatus === 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à') {
                    type = 'pass';
                    reason = 'Pass (Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à)';
                } else if (weaponStatus === 'Êú™ÂèñÂæó' && weaponType && weaponWishes.includes(weaponType)) {
                    canReceive = true;
                    type = 'need';
                    const wishIndex = weaponWishes.indexOf(weaponType);
                    score = 3000 + getPositionPriority(player.position) - (wishIndex * 100) - (player.dynamicPriority || 0);
                    reason = `Need (Á¨¨${wishIndex + 1}Â∏åÊúõ)`;
                } else if (weaponStatus === 'Êú™ÂèñÂæó') {
                    canReceive = true;
                    type = 'greed';
                    score = 100 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Greed (Ê≠¶Âô®)';
                } else {
                    type = 'pass';
                    reason = 'Pass (Ê≠¶Âô®ÊâÄÊåÅÊ∏à„Åø)';
                }
            }
            
            return { canReceive, score, reason, type };
        }
        
        // „Éó„É¨„Ç§„É§„Éº„ÅÆË£ÖÂÇôÁä∂Ê≥ÅÂèñÂæó
        function getPlayerEquipmentStatus(position, slot) {
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const allocation = allocations.find(alloc => 
                alloc.position === position && alloc.slot === slot
            );
            
            if (allocation && allocation.status) {
                return allocation.status;
            }
            
            // Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Åßstatus„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄåÂèñÂæóÊ∏à„Åø„Äç„Å®„Åø„Å™„Åô
            if (allocation) {
                return 'ÂèñÂæóÊ∏à„Åø';
            }
            
            return 'Êú™ÂèñÂæó';
        }
        
        // Âêå„Åò„Çπ„É≠„ÉÉ„Éà„ÅßÈõ∂ÂºèÊñπÈáù„ÅÆÊú™ÂèñÂæóËÄÖ„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function hasUnacquiredRaidPlayers(slot, excludePosition) {
            const players = appData.players[currentRaidTier.id] || {};
            
            for (const [position, player] of Object.entries(players)) {
                if (position === excludePosition) continue;
                
                const policy = player.equipmentPolicy?.[slot] || '„Éà„Éº„É†„Çπ„Éà„Éº„É≥';
                const equipmentStatus = getPlayerEquipmentStatus(position, slot);
                
                // Èõ∂ÂºèÊñπÈáù„ÅßÊú™ÂèñÂæó„ÅÆ„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Çã„Åã
                if (policy === 'Èõ∂Âºè' && equipmentStatus === 'Êú™ÂèñÂæó') {
                    return true;
                }
            }
            
            return false;
        }
        
        // ÂàÜÈÖçÂØæË±°„ÅÆÂÖ®Âì°„ÅåÂèñÂæóÊ∏à„Åø„Åæ„Åü„ÅØÊñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à„Åã„ÇíÂà§ÂÆö
        function isAllEligiblePlayersObtained(drop, candidates) {
            const players = appData.players[currentRaidTier.id] || {};
            
            // 4Â±§Áõ¥„Éâ„É≠Ê≠¶Âô®„ÅÆÁâπÂà•Âá¶ÁêÜ
            if (drop.type === 'direct_weapon') {
                const weaponType = drop.weapon;
                
                // Ê≠¶Âô®„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éï„É™„É≠
                if (!weaponType) {
                    return true;
                }
                
                let hasEligiblePlayer = false;
                
                for (const [position, player] of Object.entries(players)) {
                    const weaponWishes = player.weaponWishes || [];
                    const weaponStatus = getPlayerEquipmentStatus(position, 'Ê≠¶Âô®');
                    
                    // „Åì„ÅÆÊ≠¶Âô®„ÇíÂ∏åÊúõ„Åó„Å¶„ÅÑ„Å¶Êú™ÂèñÂæó„ÅÆ„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (weaponStatus === 'Êú™ÂèñÂæó' && weaponWishes.includes(weaponType)) {
                        hasEligiblePlayer = true;
                        break;
                    }
                    
                    // Êñ≠Á´†‰∫§Êèõ„ÅßÂæ©Ê¥ªÂèØËÉΩ„Åã„Å§„Åì„ÅÆÊ≠¶Âô®„ÇíÂ∏åÊúõ„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà
                    if (weaponStatus === 'Êñ≠Á´†‰∫§Êèõ') {
                        const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers('Ê≠¶Âô®', position);
                        if (!hasUnacquiredRaidPlayer && weaponWishes.includes(weaponType)) {
                            hasEligiblePlayer = true;
                            break;
                        }
                    }
                }
                
                // Â∏åÊúõËÄÖ„Åå„ÅÑ„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØÂ∏åÊúõËÄÖÂÖ®Âì°„ÅåÂèñÂæóÊ∏à„Åø = „Éï„É™„É≠
                return !hasEligiblePlayer;
            }
            
            // ÈÄöÂ∏∏Ë£ÖÂÇô„ÅÆÂá¶ÁêÜ
            for (const [position, player] of Object.entries(players)) {
                const policy = player.equipmentPolicy?.[drop.slot] || '„Éà„Éº„É†„Çπ„Éà„Éº„É≥';
                const equipmentStatus = getPlayerEquipmentStatus(position, drop.slot);
                
                // Èõ∂ÂºèÊñπÈáù„ÅßÊú™ÂèñÂæó„ÅÆ„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Éï„É™„É≠ÂØæË±°Â§ñ
                if (policy === 'Èõ∂Âºè' && equipmentStatus === 'Êú™ÂèñÂæó') {
                    return false;
                }
                
                // Êñ≠Á´†‰∫§Êèõ„ÅßÊú™ÂèñÂæóËÄÖ„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂæ©Ê¥ªÂØæË±°„ÇÇËÄÉÊÖÆ
                if (equipmentStatus === 'Êñ≠Á´†‰∫§Êèõ') {
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers(drop.slot, position);
                    if (!hasUnacquiredRaidPlayer) {
                        return false; // Êñ≠Á´†‰∫§ÊèõËÄÖ„ÅåÂæ©Ê¥ªÂèØËÉΩ = „Éï„É™„É≠ÂØæË±°Â§ñ
                    }
                }
            }
            
            // ÂÖ®Âì°„ÅåÂèñÂæóÊ∏à„Åø„ÄÅ„Éà„Éº„É†ÊñπÈáù„ÄÅ„Åæ„Åü„ÅØÊñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à = „Éï„É™„É≠
            return true;
        }
        
        // „Éù„Ç∏„Ç∑„Éß„É≥ÈñìÂÑ™ÂÖàÈ†Ü‰ΩçÂèñÂæóÔºàË£ÖÂÇô„ÉªÁ¥†ÊùêÂÖ±ÈÄöÔºâ
        function getPositionPriority(position) {
            // Ë®≠ÂÆö„Åï„Çå„ÅüÂÑ™ÂÖàÈ†Ü‰Ωç„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà: D1D2D3D4MTSTH1H2Ôºâ
            const savedPriority = appData.settings?.positionPriority || ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            const positionIndex = savedPriority.indexOf(position);
            return 800 - (positionIndex * 50); // È´ò„ÅÑÈ†Ü‰Ωç„Åª„Å©È´ò„Çπ„Ç≥„Ç¢
        }
        
        // Âº∑ÂåñÁ¥†Êùê„ÅÆÂàÜÈÖçÂÑ™ÂÖàÂ∫¶ÂèñÂæóÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function getMaterialPriority(position, materialType) {
            return getPositionPriority(position);
        }
        
        // ÂàÜÈÖçÁµêÊûúË°®Á§∫
        function displayAllocationResults(layer, results) {
            const allocationResults = document.getElementById('allocationResults');
            const allocationContent = document.getElementById('allocationContent');
            
            let html = `
                <div class="allocation-header">
                    <h4>${layer}Â±§ Ë£ÖÂÇôÂàÜÈÖçÁµêÊûú</h4>
                    <p>Êé®Â•®ÂàÜÈÖçËÄÖ„ÅåËá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åó„Åü„ÄÇÂøÖË¶Å„Å´Âøú„Åò„Å¶Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>
            `;
            
            // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®ÈÅ∏ÊäûÔºà4Â±§„ÅÆ„ÅøÔºâ
            if (layer === 4) {
                html += `
                    <div class="weapon-selection">
                        <h5>Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®ÈÅ∏Êäû:</h5>
                        <select id="directWeaponSelect" onchange="updateDirectWeapon()" style="width: 100%; padding: 5px;">
                            <option value="" ${selectedDirectWeapon === '' ? 'selected' : ''}>Ê≠¶Âô®„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Éä„Ç§„Éà" ${selectedDirectWeapon === '„Éä„Ç§„Éà' ? 'selected' : ''}>„Éä„Ç§„ÉàÊ≠¶Âô®</option>
                            <option value="Êà¶Â£´" ${selectedDirectWeapon === 'Êà¶Â£´' ? 'selected' : ''}>Êà¶Â£´Ê≠¶Âô®</option>
                            <option value="ÊöóÈªíÈ®éÂ£´" ${selectedDirectWeapon === 'ÊöóÈªíÈ®éÂ£´' ? 'selected' : ''}>ÊöóÈªíÈ®éÂ£´Ê≠¶Âô®</option>
                            <option value="„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº" ${selectedDirectWeapon === '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº' ? 'selected' : ''}>„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„ÉºÊ≠¶Âô®</option>
                            <option value="ÁôΩÈ≠îÈÅìÂ£´" ${selectedDirectWeapon === 'ÁôΩÈ≠îÈÅìÂ£´' ? 'selected' : ''}>ÁôΩÈ≠îÈÅìÂ£´Ê≠¶Âô®</option>
                            <option value="Â≠¶ËÄÖ" ${selectedDirectWeapon === 'Â≠¶ËÄÖ' ? 'selected' : ''}>Â≠¶ËÄÖÊ≠¶Âô®</option>
                            <option value="Âç†ÊòüË°ìÂ£´" ${selectedDirectWeapon === 'Âç†ÊòüË°ìÂ£´' ? 'selected' : ''}>Âç†ÊòüË°ìÂ£´Ê≠¶Âô®</option>
                            <option value="Ë≥¢ËÄÖ" ${selectedDirectWeapon === 'Ë≥¢ËÄÖ' ? 'selected' : ''}>Ë≥¢ËÄÖÊ≠¶Âô®</option>
                            <option value="„É¢„É≥„ÇØ" ${selectedDirectWeapon === '„É¢„É≥„ÇØ' ? 'selected' : ''}>„É¢„É≥„ÇØÊ≠¶Âô®</option>
                            <option value="Á´úÈ®éÂ£´" ${selectedDirectWeapon === 'Á´úÈ®éÂ£´' ? 'selected' : ''}>Á´úÈ®éÂ£´Ê≠¶Âô®</option>
                            <option value="ÂøçËÄÖ" ${selectedDirectWeapon === 'ÂøçËÄÖ' ? 'selected' : ''}>ÂøçËÄÖÊ≠¶Âô®</option>
                            <option value="‰æç" ${selectedDirectWeapon === '‰æç' ? 'selected' : ''}>‰æçÊ≠¶Âô®</option>
                            <option value="„É™„Éº„Éë„Éº" ${selectedDirectWeapon === '„É™„Éº„Éë„Éº' ? 'selected' : ''}>„É™„Éº„Éë„ÉºÊ≠¶Âô®</option>
                            <option value="„É¥„Ç°„Ç§„Éë„Éº" ${selectedDirectWeapon === '„É¥„Ç°„Ç§„Éë„Éº' ? 'selected' : ''}>„É¥„Ç°„Ç§„Éë„ÉºÊ≠¶Âô®</option>
                            <option value="ÈªíÈ≠îÈÅìÂ£´" ${selectedDirectWeapon === 'ÈªíÈ≠îÈÅìÂ£´' ? 'selected' : ''}>ÈªíÈ≠îÈÅìÂ£´Ê≠¶Âô®</option>
                            <option value="Âè¨ÂñöÂ£´" ${selectedDirectWeapon === 'Âè¨ÂñöÂ£´' ? 'selected' : ''}>Âè¨ÂñöÂ£´Ê≠¶Âô®</option>
                            <option value="Ëµ§È≠îÈÅìÂ£´" ${selectedDirectWeapon === 'Ëµ§È≠îÈÅìÂ£´' ? 'selected' : ''}>Ëµ§È≠îÈÅìÂ£´Ê≠¶Âô®</option>
                            <option value="„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº" ${selectedDirectWeapon === '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº' ? 'selected' : ''}>„Éî„ÇØ„Éà„Éû„É≥„Çµ„ÉºÊ≠¶Âô®</option>
                            <option value="ÂêüÈÅäË©©‰∫∫" ${selectedDirectWeapon === 'ÂêüÈÅäË©©‰∫∫' ? 'selected' : ''}>ÂêüÈÅäË©©‰∫∫Ê≠¶Âô®</option>
                            <option value="Ê©üÂ∑•Â£´" ${selectedDirectWeapon === 'Ê©üÂ∑•Â£´' ? 'selected' : ''}>Ê©üÂ∑•Â£´Ê≠¶Âô®</option>
                            <option value="Ë∏ä„ÇäÂ≠ê" ${selectedDirectWeapon === 'Ë∏ä„ÇäÂ≠ê' ? 'selected' : ''}>Ë∏ä„ÇäÂ≠êÊ≠¶Âô®</option>
                        </select>
                    </div>
                `;
            }
            
            html += `<div class="allocation-grid">`;
            
            Object.entries(results).forEach(([itemKey, result]) => {
                const drop = result.drop;
                const needCandidates = result.candidates.filter(c => c.type === 'need');
                const greedCandidates = result.candidates.filter(c => c.type === 'greed');
                const passCandidates = result.candidates.filter(c => c.type === 'pass');
                
                html += `
                    <div class="allocation-item">
                        <div class="item-header">
                            <h5>${drop.name} ${drop.itemLevel}</h5>
                            <span class="item-type">${getItemTypeLabel(drop.type)}</span>
                        </div>
                        
                        <div class="predicted-winner">
                            <strong>‰∫àÊ∏¨ÂèñÂæóËÄÖ:</strong> 
                            ${result.recommended ? 
                                `${result.recommended.player.name} (${result.recommended.position}) [${result.recommended.player.job}]` : 
                                (isAllEligiblePlayersObtained(drop, result.candidates) ? '„Éï„É™„É≠' : 'Ë©≤ÂΩìËÄÖ„Å™„Åó')
                            }
                        </div>
                        
                        <div class="allocation-choice">
                            <label>ÂÆüÈöõ„ÅÆÂèñÂæóËÄÖ:</label>
                            <select id="allocation-${itemKey}" onchange="updateAllocationChoice('${itemKey}')">
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                ${result.candidates.map(candidate => `
                                    <option value="${candidate.position}" 
                                            ${result.recommended?.position === candidate.position ? 'selected' : ''}>
                                        ${candidate.player.name} (${candidate.position}) [${candidate.player.job}]
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="judgment-details">
                            <div class="judgment-section">
                                <button class="judgment-toggle" onclick="toggleJudgment('${itemKey}')">
                                    Âà§ÂÆöË©≥Á¥∞„ÇíË°®Á§∫ ‚ñº
                                </button>
                                <div id="judgment-${itemKey}" class="judgment-content" style="display: none;">
                                    ${needCandidates.length > 0 ? `
                                        <div class="need-section">
                                            <h6>Need (${needCandidates.length}‰∫∫)</h6>
                                            ${needCandidates.map(candidate => `
                                                <div class="candidate-item need">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${greedCandidates.length > 0 ? `
                                        <div class="greed-section">
                                            <h6>Greed (${greedCandidates.length}‰∫∫)</h6>
                                            ${greedCandidates.map(candidate => `
                                                <div class="candidate-item greed">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${passCandidates.length > 0 ? `
                                        <div class="pass-section">
                                            <h6>Pass (${passCandidates.length}‰∫∫)</h6>
                                            ${passCandidates.map(candidate => `
                                                <div class="candidate-item pass">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="allocation-actions">
                    <button onclick="confirmAllocation(${layer})" class="confirm-btn">
                        ÂàÜÈÖç„ÇíÁ¢∫ÂÆö
                    </button>
                    <button onclick="showTierDashboard()" class="cancel-btn">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                </div>
            `;
            
            allocationContent.innerHTML = html;
            allocationResults.style.display = 'block';
            
            // ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            allocationResults.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®Êõ¥Êñ∞
        function updateDirectWeapon() {
            console.log('updateDirectWeaponÈñ¢Êï∞„ÅåÂëº„Å≥Âá∫„Åï„Çå„Åæ„Åó„Åü');
            
            const weaponSelect = document.getElementById('directWeaponSelect');
            if (!weaponSelect) {
                console.error('Ê≠¶Âô®ÈÅ∏Êäû„Éó„É´„ÉÄ„Ç¶„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                showError('Ê≠¶Âô®ÈÅ∏Êäû„Éó„É´„ÉÄ„Ç¶„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const selectedWeapon = weaponSelect.value;
            console.log('ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠¶Âô®:', selectedWeapon);
            console.log('„Éó„É´„ÉÄ„Ç¶„É≥„ÅÆÂÖ®ÈÅ∏ÊäûËÇ¢:', weaponSelect.options.length);
            
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´ÈÅ∏ÊäûÁä∂ÊÖã„Çí‰øùÂ≠ò
            selectedDirectWeapon = selectedWeapon;
            console.log('ÈÅ∏ÊäûÁä∂ÊÖã„Çí‰øùÂ≠ò:', selectedDirectWeapon);
            
            if (selectedWeapon) {
                try {
                    // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÂàÜÈÖç„ÇíÂÜçË®àÁÆó
                    const drops = getLayerDrops(4);
                    console.log('4Â±§„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†:', drops);
                    
                    const weaponDrop = drops.find(d => d.type === 'direct_weapon');
                    if (weaponDrop) {
                        weaponDrop.weapon = selectedWeapon;
                        console.log('Ê≠¶Âô®„Éâ„É≠„ÉÉ„ÉóÊõ¥Êñ∞:', weaponDrop);
                        
                        const allocationResults = calculateAllocation(4, drops);
                        displayAllocationResults(4, allocationResults);
                        showSuccess(`${selectedWeapon}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`);
                    } else {
                        console.error('Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                        console.log('Âà©Áî®ÂèØËÉΩ„Å™„Éâ„É≠„ÉÉ„Éó„Çø„Ç§„Éó:', drops.map(d => d.type));
                        showError('Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                } catch (error) {
                    console.error('Ê≠¶Âô®ÈÅ∏ÊäûÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                    showError('Ê≠¶Âô®ÈÅ∏ÊäûÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            } else {
                console.log('Ê≠¶Âô®ÈÅ∏Êäû„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åó„Åü');
                // ÈÅ∏Êäû„Åå„ÇØ„É™„Ç¢„Åï„Çå„ÅüÂ†¥Âêà„ÇÇÁîªÈù¢„ÇíÊõ¥Êñ∞
                const drops = getLayerDrops(4);
                const allocationResults = calculateAllocation(4, drops);
                displayAllocationResults(4, allocationResults);
            }
        }
        
        // Âà§ÂÆöË©≥Á¥∞„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleJudgment(itemKey) {
            const content = document.getElementById(`judgment-${itemKey}`);
            const button = content.previousElementSibling;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'Âà§ÂÆöË©≥Á¥∞„ÇíÈö†„Åô ‚ñ≤';
            } else {
                content.style.display = 'none';
                button.textContent = 'Âà§ÂÆöË©≥Á¥∞„ÇíË°®Á§∫ ‚ñº';
            }
        }
        
        // „Ç¢„Ç§„ÉÜ„É†„Çø„Ç§„Éó„É©„Éô„É´
        function getItemTypeLabel(type) {
            const labels = {
                'equipment': 'Ë£ÖÂÇô',
                'material': 'Âº∑ÂåñÁ¥†Êùê',
                'weapon_box': 'Ê≠¶Âô®ÁÆ±',
                'direct_weapon': 'Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®'
            };
            return labels[type] || type;
        }
        
        // ÂàÜÈÖçÈÅ∏ÊäûÊõ¥Êñ∞
        function updateAllocationChoice(slot) {
            // ÈÅ∏ÊäûÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂÆüË£ÖÔºâ
            console.log(`${slot}„ÅÆÂàÜÈÖçÈÅ∏Êäû„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü`);
        }
        
        // ÂàÜÈÖçÁ¢∫ÂÆö
        async function confirmAllocation(layer) {
            try {
                const allocations = [];
                const selects = document.querySelectorAll('[id^="allocation-"]');
                const allocationId = Date.now().toString();
                
                selects.forEach(select => {
                    const itemKey = select.id.replace('allocation-', '');
                    const position = select.value;
                    
                    if (position && position !== 'discard' && position !== '„Éï„É™„É≠') {
                        const player = appData.players[currentRaidTier.id][position];
                        const drops = getLayerDrops(layer);
                        const drop = drops.find(d => d.slot === itemKey || d.name.includes(itemKey));
                        
                        if (drop && player) {
                            const allocation = {
                                id: `${allocationId}-${itemKey}`,
                                layer: layer,
                                slot: drop.slot,
                                position: position,
                                playerName: player.name,
                                characterName: player.characterName || '',
                                job: player.job,
                                equipment: {
                                    name: drop.name,
                                    slot: drop.slot,
                                    itemLevel: drop.itemLevel
                                },
                                timestamp: new Date().toISOString(),
                                week: getCurrentWeek(),
                                raidTier: currentRaidTier.name,
                                // Ë©≥Á¥∞ÊÉÖÂ†±
                                itemType: drop.type,
                                equipmentName: drop.name,
                                equipmentSlot: drop.slot,
                                winner: position,
                                winnerName: player.name
                            };
                            
                            allocations.push(allocation);
                        }
                    }
                });
                
                if (allocations.length === 0) {
                    showError('ÂàÜÈÖç„Åô„ÇãË£ÖÂÇô„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }
                
                // ÂàÜÈÖçÂ±•Ê≠¥„Å´Ë®òÈå≤
                if (!appData.allocations[currentRaidTier.id]) {
                    appData.allocations[currentRaidTier.id] = [];
                }
                
                allocations.forEach(allocation => {
                    appData.allocations[currentRaidTier.id].push(allocation);
                    
                    // „Éó„É¨„Ç§„É§„Éº„ÅÆË£ÖÂÇôÁä∂Ê≥ÅÊõ¥Êñ∞
                    const player = appData.players[currentRaidTier.id][allocation.position];
                    if (player) {
                        // ÁèæÂú®Ë£ÖÂÇô„ÅÆÊõ¥Êñ∞
                        if (!player.currentEquipment) player.currentEquipment = {};
                        player.currentEquipment[allocation.slot] = true;
                        
                        // ÂàÜÈÖçÂ±•Ê≠¥„ÅÆÊõ¥Êñ∞
                        if (!player.allocationHistory) player.allocationHistory = [];
                        player.allocationHistory.push({
                            equipment: allocation.equipment,
                            timestamp: allocation.timestamp,
                            week: allocation.week,
                            layer: allocation.layer
                        });
                        
                        // ÂãïÁöÑÂÑ™ÂÖàÂ∫¶Êõ¥Êñ∞
                        const itemPriority = getItemPriority(allocation.slot);
                        player.dynamicPriority = (player.dynamicPriority || 0) + itemPriority;
                    }
                });
                
                // Êñ≠Á´†‰∫§ÊèõËÄÖ„ÅÆËá™Âãï„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                await updateTomeExchangeStatus(allocations);
                
                // Supabase„Å´‰øùÂ≠ò
                await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
                
                showSuccess(`${layer}Â±§„ÅÆË£ÖÂÇôÂàÜÈÖç„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åó„Åü„ÄÇ${allocations.length}‰ª∂„ÅÆË£ÖÂÇô„ÅåÂàÜÈÖç„Åï„Çå„Åæ„Åó„Åü„ÄÇ`);
                showEquipmentAllocation(); // Ë£ÖÂÇôÂàÜÈÖçÁîªÈù¢„Å´Êàª„Çã
                
            } catch (error) {
                console.error('ÂàÜÈÖçÁ¢∫ÂÆö„Ç®„É©„Éº:', error);
                showError('ÂàÜÈÖç„ÅÆÁ¢∫ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÁèæÂú®„ÅÆÈÄ±Áï™Âè∑ÂèñÂæó
        function getCurrentWeek() {
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const weekNumber = Math.ceil(((now - yearStart) / 86400000 + yearStart.getDay() + 1) / 7);
            return weekNumber;
        }
        
        // „Ç¢„Ç§„ÉÜ„É†ÂÑ™ÂÖàÂ∫¶ÂèñÂæó
        function getItemPriority(slot) {
            const priorities = {
                'Ê≠¶Âô®': 3,
                'ËÉ¥': 2,
                'ËÑö': 2,
                'È†≠': 1,
                'Êâã': 1,
                'Ë∂≥': 1,
                'ËÄ≥': 1,
                'È¶ñ': 1,
                'ËÖï': 1,
                'Êåá': 1,
                'Ê≠¶Âô®Áü≥': 1,
                'Á°¨ÂåñËñ¨': 1,
                'Âº∑ÂåñËñ¨': 1,
                'Âº∑ÂåñÁπäÁ∂≠': 1
            };
            return priorities[slot] || 1;
        }
        
        // Êñ≠Á´†‰∫§ÊèõËÄÖ„ÅÆËá™Âãï„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        async function updateTomeExchangeStatus(allocations) {
            try {
                const currentAllocations = appData.allocations[currentRaidTier.id] || [];
                let hasUpdates = false;
                
                // ÂêÑË£ÖÂÇô„Çπ„É≠„ÉÉ„Éà„Å´„Å§„ÅÑ„Å¶Êñ≠Á´†‰∫§ÊèõËÄÖ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const equipmentSlots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
                
                for (const slot of equipmentSlots) {
                    // ‰ªäÂõû„ÅÆ„Ç¢„É≠„Ç±„Éº„Ç∑„Éß„É≥„Åß„Åì„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÅÆË£ÖÂÇô„ÅåÂàÜÈÖç„Åï„Çå„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    const slotAllocations = allocations.filter(alloc => alloc.slot === slot);
                    
                    if (slotAllocations.length > 0) {
                        // „Åì„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÅßÊñ≠Á´†‰∫§Êèõ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ‰∫∫„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                        const players = appData.players[currentRaidTier.id] || {};
                        
                        for (const [position, player] of Object.entries(players)) {
                            const currentStatus = getPlayerEquipmentStatus(position, slot);
                            
                            // Êñ≠Á´†‰∫§Êèõ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ‰∫∫„ÅåË£ÖÂÇô„ÇíÂèñÂæó„Åó„ÅüÂ†¥Âêà
                            if (currentStatus === 'Êñ≠Á´†‰∫§Êèõ') {
                                const receivedAllocation = slotAllocations.find(alloc => alloc.position === position);
                                
                                if (receivedAllocation) {
                                    // „Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÄåÊñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à„Äç„Å´Êõ¥Êñ∞
                                    const existingAllocation = currentAllocations.find(alloc => 
                                        alloc.position === position && alloc.slot === slot
                                    );
                                    
                                    if (existingAllocation) {
                                        existingAllocation.status = 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à';
                                        hasUpdates = true;
                                        console.log(`${player.name}(${position})„ÅÆ${slot}„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÄåÊñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à„Äç„Å´Êõ¥Êñ∞`);
                                    }
                                }
                            }
                        }
                    }
                }
                
                if (hasUpdates) {
                    // Êõ¥Êñ∞„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÅØÂÜç‰øùÂ≠ò
                    await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                    console.log('Êñ≠Á´†‰∫§Êèõ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆËá™ÂãïÊõ¥Êñ∞„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                }
                
            } catch (error) {
                console.error('Êñ≠Á´†‰∫§Êèõ„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇÂàÜÈÖçÂá¶ÁêÜËá™‰Ωì„ÅØÁ∂öË°å
            }
        }
        
        // Áµ±Ë®àÊÉÖÂ†±Ë°®Á§∫
        function showStatistics() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            const allocations = appData.allocations[currentRaidTier.id] || [];
            
            if (Object.keys(players).length === 0) {
                showError('„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            // Áµ±Ë®à„Éá„Éº„ÇøË®àÁÆó
            const stats = calculateStatistics(players, allocations);
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                </div>
                
                <h1>Áµ±Ë®àÊÉÖÂ†±</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>„Éó„É¨„Ç§„É§„ÉºÂà•ÂèñÂæóÁä∂Ê≥Å
                        <button class="edit-button" onclick="showStatisticsEditMode()" style="margin-left: 20px;">Á∑®ÈõÜÈñãÂßã</button>
                    </h3>
                    ${generatePlayerStatistics(players, allocations)}
                </div>
            `;
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÂà•Áµ±Ë®àÊÉÖÂ†±ÁîüÊàê
        function generatePlayerStatistics(players, allocations) {
            // „Éù„Ç∏„Ç∑„Éß„É≥È†ÜÂ∫è„ÇíÂõ∫ÂÆöÂåñ (D1‚ÜíD2‚ÜíD3‚ÜíD4‚ÜíMT‚ÜíST‚ÜíH1‚ÜíH2)
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            
            // Ë£ÖÂÇôÈÉ®‰ΩçÈ†ÜÂ∫è„ÇíÂõ∫ÂÆöÂåñ (È†≠‚ÜíËÉ¥‚ÜíÊâã‚ÜíËÑö‚ÜíË∂≥‚ÜíËÄ≥‚ÜíÈ¶ñ‚ÜíËÖï‚ÜíÊåá‚ÜíÊ≠¶Âô®)
            const equipmentSlots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
            const materialSlots = ['Ê≠¶Âô®Áü≥', 'Á°¨ÂåñËñ¨', 'Âº∑ÂåñËñ¨', 'Âº∑ÂåñÁπäÁ∂≠'];
            
            let html = '<div class="player-stats-table">';
            
            // „Éò„ÉÉ„ÉÄ„Éº
            html += `
                <div class="stats-header">
                    <div class="player-name-col">„Éó„É¨„Ç§„É§„Éº</div>
                    ${equipmentSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                    ${materialSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                </div>
            `;
            
            // ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆË°å
            positions.forEach(position => {
                const player = players[position];
                if (!player) return;
                
                // Ë©≤ÂΩì„Éó„É¨„Ç§„É§„Éº„ÅÆÂèñÂæóÂ±•Ê≠¥„ÇíÂèñÂæó
                const playerAllocations = allocations.filter(alloc => alloc.position === position);
                const acquiredSlots = new Set(playerAllocations.map(alloc => alloc.slot));
                
                html += `
                    <div class="stats-row">
                        <div class="player-name-col">
                            <strong>${player.name}</strong><br>
                            <span class="position-badge ${getPositionRoleClass(position)}" style="font-size: 11px; padding: 2px 6px;">${position}</span>
                        </div>
                `;
                
                // Ë£ÖÂÇôÈÉ®‰Ωç„ÅÆÂèñÂæóÁä∂Ê≥Å
                equipmentSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || 'ÂèñÂæóÊ∏à„Åø') : 'Êú™ÂèñÂæó';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col ${statusClass}">
                            ${status}
                        </div>
                    `;
                });
                
                // Á¥†Êùê„ÅÆÂèñÂæóÁä∂Ê≥Å
                materialSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || 'ÂèñÂæóÊ∏à„Åø') : 'Êú™ÂèñÂæó';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col ${statusClass}">
                            ${status}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }
        
        // Áµ±Ë®à„Éá„Éº„ÇøË®àÁÆó
        function calculateStatistics(players, allocations) {
            const playerStats = {};
            const slotStats = {};
            const weekStats = {};
            
            // „Éó„É¨„Ç§„É§„ÉºÁµ±Ë®àÂàùÊúüÂåñ
            Object.entries(players).forEach(([position, player]) => {
                playerStats[position] = {
                    name: player.name,
                    equipmentCount: 0,
                    materialCount: 0,
                    totalCount: 0,
                    dynamicPriority: player.dynamicPriority || 0
                };
            });
            
            // ÂàÜÈÖçÂ±•Ê≠¥„Åã„ÇâÁµ±Ë®àË®àÁÆó
            allocations.forEach(allocation => {
                const position = allocation.position;
                const slot = allocation.slot;
                const week = allocation.week;
                
                // „Éó„É¨„Ç§„É§„ÉºÁµ±Ë®àÊõ¥Êñ∞
                if (playerStats[position]) {
                    if (['Ê≠¶Âô®Áü≥', 'Á°¨ÂåñËñ¨', 'Âº∑ÂåñËñ¨', 'Âº∑ÂåñÁπäÁ∂≠'].includes(slot)) {
                        playerStats[position].materialCount++;
                    } else {
                        playerStats[position].equipmentCount++;
                    }
                    playerStats[position].totalCount++;
                }
                
                // ÈÉ®‰ΩçÁµ±Ë®àÊõ¥Êñ∞
                slotStats[slot] = (slotStats[slot] || 0) + 1;
                
                // ÈÄ±Áµ±Ë®àÊõ¥Êñ∞
                weekStats[week] = (weekStats[week] || 0) + 1;
            });
            
            return { playerStats, slotStats, weekStats };
        }
        
        // Áµ±Ë®àÊÉÖÂ†±Á∑®ÈõÜ„É¢„Éº„ÉâË°®Á§∫
        function showStatisticsEditMode() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            const allocations = appData.allocations[currentRaidTier.id] || [];
            
            if (Object.keys(players).length === 0) {
                showError('„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    <button class="nav-button" onclick="showStatistics()">Á∑®ÈõÜÁµÇ‰∫Ü</button>
                </div>
                
                <h1>Áµ±Ë®àÊÉÖÂ†±Á∑®ÈõÜ</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>„Éó„É¨„Ç§„É§„ÉºÂà•ÂèñÂæóÁä∂Ê≥ÅÁ∑®ÈõÜ
                        <button class="save-button" onclick="saveStatisticsChanges()" style="margin-left: 20px;">Â§âÊõ¥„Çí‰øùÂ≠ò</button>
                    </h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                        „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂèñÂæóÁä∂Ê≥Å„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇÂ§âÊõ¥Âæå„ÅØ„ÄåÂ§âÊõ¥„Çí‰øùÂ≠ò„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </p>
                    ${generateEditablePlayerStatistics(players, allocations)}
                </div>
            `;
        }
        
        // Á∑®ÈõÜÂèØËÉΩ„Å™„Éó„É¨„Ç§„É§„ÉºÂà•Áµ±Ë®àÊÉÖÂ†±ÁîüÊàê
        function generateEditablePlayerStatistics(players, allocations) {
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            const equipmentSlots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
            const materialSlots = ['Ê≠¶Âô®Áü≥', 'Á°¨ÂåñËñ¨', 'Âº∑ÂåñËñ¨', 'Âº∑ÂåñÁπäÁ∂≠'];
            
            let html = '<div class="player-stats-table">';
            
            // „Éò„ÉÉ„ÉÄ„Éº
            html += `
                <div class="stats-header">
                    <div class="player-name-col">„Éó„É¨„Ç§„É§„Éº</div>
                    ${equipmentSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                    ${materialSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                </div>
            `;
            
            // ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆË°å
            positions.forEach(position => {
                const player = players[position];
                if (!player) return;
                
                // Ë©≤ÂΩì„Éó„É¨„Ç§„É§„Éº„ÅÆÂèñÂæóÂ±•Ê≠¥„ÇíÂèñÂæó
                const playerAllocations = allocations.filter(alloc => alloc.position === position);
                
                html += `
                    <div class="stats-row">
                        <div class="player-name-col">
                            <strong>${player.name}</strong><br>
                            <span class="position-badge ${getPositionRoleClass(position)}" style="font-size: 11px; padding: 2px 6px;">${position}</span>
                        </div>
                `;
                
                // Ë£ÖÂÇôÈÉ®‰Ωç„ÅÆÂèñÂæóÁä∂Ê≥ÅÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ
                equipmentSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || 'ÂèñÂæóÊ∏à„Åø') : 'Êú™ÂèñÂæó';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col editable-slot ${statusClass}">
                            <select data-position="${position}" 
                                    data-slot="${slot}" 
                                    onchange="updateEquipmentStatus(this)"
                                    style="width: 100%; font-size: 0.8rem; padding: 2px;">
                                <option value="Êú™ÂèñÂæó" ${status === 'Êú™ÂèñÂæó' ? 'selected' : ''}>Êú™ÂèñÂæó</option>
                                <option value="ÂèñÂæóÊ∏à„Åø" ${status === 'ÂèñÂæóÊ∏à„Åø' ? 'selected' : ''}>ÂèñÂæóÊ∏à„Åø</option>
                                <option value="Êñ≠Á´†‰∫§Êèõ" ${status === 'Êñ≠Á´†‰∫§Êèõ' ? 'selected' : ''}>Êñ≠Á´†‰∫§Êèõ</option>
                                <option value="Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à" ${status === 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à' ? 'selected' : ''}>Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à</option>
                            </select>
                        </div>
                    `;
                });
                
                // Á¥†Êùê„ÅÆÂèñÂæóÁä∂Ê≥ÅÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ
                materialSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || 'ÂèñÂæóÊ∏à„Åø') : 'Êú™ÂèñÂæó';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col editable-slot ${statusClass}">
                            <select data-position="${position}" 
                                    data-slot="${slot}" 
                                    onchange="updateEquipmentStatus(this)"
                                    style="width: 100%; font-size: 0.8rem; padding: 2px;">
                                <option value="Êú™ÂèñÂæó" ${status === 'Êú™ÂèñÂæó' ? 'selected' : ''}>Êú™ÂèñÂæó</option>
                                <option value="ÂèñÂæóÊ∏à„Åø" ${status === 'ÂèñÂæóÊ∏à„Åø' ? 'selected' : ''}>ÂèñÂæóÊ∏à„Åø</option>
                                <option value="Êñ≠Á´†‰∫§Êèõ" ${status === 'Êñ≠Á´†‰∫§Êèõ' ? 'selected' : ''}>Êñ≠Á´†‰∫§Êèõ</option>
                                <option value="Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à" ${status === 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à' ? 'selected' : ''}>Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à</option>
                            </select>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }
        
        // Ë£ÖÂÇôÁä∂Ê≥Å„ÅÆCSS„ÇØ„É©„ÇπÂèñÂæó
        function getEquipmentStatusClass(status) {
            switch (status) {
                case 'Êú™ÂèñÂæó': return 'not-acquired';
                case 'ÂèñÂæóÊ∏à„Åø': return 'acquired';
                case 'Êñ≠Á´†‰∫§Êèõ': return 'tome-exchange';
                case 'Êñ≠Á´†‰∫§Êèõ„ÉªÁÆ±ÂèñÂæóÊ∏à': return 'tome-exchange-completed';
                default: return 'not-acquired';
            }
        }
        
        // Ë£ÖÂÇôÁä∂Ê≥Å„ÅÆÊõ¥Êñ∞
        function updateEquipmentStatus(selectElement) {
            const position = selectElement.dataset.position;
            const slot = selectElement.dataset.slot;
            const status = selectElement.value;
            const slotDiv = selectElement.closest('.slot-col');
            
            // Êó¢Â≠ò„ÅÆ„ÇØ„É©„Çπ„ÇíÂâäÈô§
            slotDiv.classList.remove('not-acquired', 'acquired', 'tome-exchange', 'tome-exchange-completed');
            
            // Êñ∞„Åó„ÅÑ„ÇØ„É©„Çπ„ÇíËøΩÂä†
            const statusClass = getEquipmentStatusClass(status);
            slotDiv.classList.add(statusClass);
        }
        
        // Áµ±Ë®àÊÉÖÂ†±„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò
        async function saveStatisticsChanges() {
            const selectors = document.querySelectorAll('select[data-position][data-slot]');
            const currentAllocations = appData.allocations[currentRaidTier.id] || [];
            const newAllocations = [];
            
            // Êó¢Â≠ò„ÅÆÂàÜÈÖç„Éá„Éº„Çø„Åã„ÇâÁ∑®ÈõÜÂØæË±°‰ª•Â§ñ„ÅÆ„Éá„Éº„Çø„Çí‰øùÊåÅ
            const editedSlots = new Set();
            selectors.forEach(selector => {
                const key = `${selector.dataset.position}-${selector.dataset.slot}`;
                editedSlots.add(key);
            });
            
            // Á∑®ÈõÜÂØæË±°Â§ñ„ÅÆÂàÜÈÖç„Éá„Éº„Çø„Çí‰øùÊåÅ
            currentAllocations.forEach(allocation => {
                const key = `${allocation.position}-${allocation.slot}`;
                if (!editedSlots.has(key)) {
                    newAllocations.push(allocation);
                }
            });
            
            // ÈÅ∏Êäû„Åï„Çå„ÅüÈ†ÖÁõÆ„ÇíÂàÜÈÖç„Éá„Éº„Çø„Å®„Åó„Å¶ËøΩÂä†
            selectors.forEach(selector => {
                const position = selector.dataset.position;
                const slot = selector.dataset.slot;
                const status = selector.value;
                
                // „ÄåÊú™ÂèñÂæó„Äç‰ª•Â§ñ„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂàÜÈÖç„Éá„Éº„Çø„Å®„Åó„Å¶ËøΩÂä†
                if (status !== 'Êú™ÂèñÂæó') {
                    // Êó¢Â≠ò„ÅÆÂàÜÈÖç„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
                    const existingAllocation = newAllocations.find(alloc => 
                        alloc.position === position && alloc.slot === slot
                    );
                    
                    if (!existingAllocation) {
                        newAllocations.push({
                            position: position,
                            slot: slot,
                            status: status, // Ë£ÖÂÇôÁä∂Ê≥Å„ÇíËøΩÂä†
                            week: 'Manual', // ÊâãÂãïÁ∑®ÈõÜ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ§∫„Åô
                            layer: 'Manual', // ÊâãÂãïÁ∑®ÈõÜ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ§∫„Åô
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            });
            
            // „Éá„Éº„Çø„Çí‰øùÂ≠ò
            appData.allocations[currentRaidTier.id] = newAllocations;
            
            try {
                await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                showSuccess('Áµ±Ë®àÊÉÖÂ†±„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
                
                // Áµ±Ë®àÁîªÈù¢„Å´Êàª„Çã
                setTimeout(() => {
                    showStatistics();
                }, 1500);
            } catch (error) {
                console.error('Áµ±Ë®àÊÉÖÂ†±‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('Áµ±Ë®àÊÉÖÂ†±„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÂàÜÈÖçÂ±•Ê≠¥Ë°®Á§∫
        function showAllocationHistory() {
            const content = document.getElementById('content');
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                </div>
                
                <h1>ÂàÜÈÖçÂ±•Ê≠¥</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>„Éï„Ç£„É´„Çø„Éº</h3>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>Â±§:</label>
                            <select id="layerFilter" onchange="filterAllocationHistory()">
                                <option value="">ÂÖ®„Å¶</option>
                                <option value="1">1Â±§</option>
                                <option value="2">2Â±§</option>
                                <option value="3">3Â±§</option>
                                <option value="4">4Â±§</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>ÂèñÂæóËÄÖ:</label>
                            <select id="playerFilter" onchange="filterAllocationHistory()">
                                <option value="">ÂÖ®„Å¶</option>
                                ${Object.entries(players).map(([position, player]) => `
                                    <option value="${position}">${player.name} (${position})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Ë£ÖÂÇôÈÉ®‰Ωç:</label>
                            <select id="slotFilter" onchange="filterAllocationHistory()">
                                <option value="">ÂÖ®„Å¶</option>
                                <option value="Ê≠¶Âô®">Ê≠¶Âô®</option>
                                <option value="È†≠">È†≠</option>
                                <option value="ËÉ¥">ËÉ¥</option>
                                <option value="Êâã">Êâã</option>
                                <option value="ËÑö">ËÑö</option>
                                <option value="Ë∂≥">Ë∂≥</option>
                                <option value="ËÄ≥">ËÄ≥</option>
                                <option value="È¶ñ">È¶ñ</option>
                                <option value="ËÖï">ËÖï</option>
                                <option value="Êåá">Êåá</option>
                                <option value="Ê≠¶Âô®Áü≥">Ê≠¶Âô®Áü≥</option>
                                <option value="Á°¨ÂåñËñ¨">Á°¨ÂåñËñ¨</option>
                                <option value="Âº∑ÂåñËñ¨">Âº∑ÂåñËñ¨</option>
                                <option value="Âº∑ÂåñÁπäÁ∂≠">Âº∑ÂåñÁπäÁ∂≠</option>
                            </select>
                        </div>
                        
                        <button onclick="clearAllFilters()" class="clear-filters-btn">
                            „Éï„Ç£„É´„Çø„Éº„ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ÂàÜÈÖçÂ±•Ê≠¥ (${allocations.length}‰ª∂)</h3>
                    <div id="historyTable">
                        ${generateHistoryTable(allocations, players)}
                    </div>
                </div>
            `;
        }
        
        // Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´ÁîüÊàê
        function generateHistoryTable(allocations, players) {
            if (allocations.length === 0) {
                return '<p class="no-data">ÂàÜÈÖçÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            }
            
            // Êó•‰ªòÈ†Ü„ÅßÈôçÈ†Ü„ÇΩ„Éº„Éà
            const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            return `
                <div class="history-table">
                    <div class="history-header">
                        <div class="history-cell">Êó•ÊôÇ</div>
                        <div class="history-cell">Â±§</div>
                        <div class="history-cell">Ë£ÖÂÇôÈÉ®‰Ωç</div>
                        <div class="history-cell">ÂèñÂæóËÄÖ</div>
                    </div>
                    ${sortedAllocations.map(allocation => {
                        const player = players[allocation.position];
                        const date = new Date(allocation.timestamp);
                        return `
                            <div class="history-row">
                                <div class="history-cell">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
                                <div class="history-cell">${allocation.layer}Â±§</div>
                                <div class="history-cell">${allocation.slot}</div>
                                <div class="history-cell">${player ? player.name : allocation.playerName} (${allocation.position})</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // Â±•Ê≠¥„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterAllocationHistory() {
            const layerFilter = document.getElementById('layerFilter').value;
            const playerFilter = document.getElementById('playerFilter').value;
            const slotFilter = document.getElementById('slotFilter').value;
            
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            let filteredAllocations = allocations.filter(allocation => {
                if (layerFilter && allocation.layer.toString() !== layerFilter) return false;
                if (playerFilter && allocation.position !== playerFilter) return false;
                if (slotFilter && allocation.slot !== slotFilter) return false;
                return true;
            });
            
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = generateHistoryTable(filteredAllocations, players);
            
            // „Éï„Ç£„É´„Çø„ÉºÁµêÊûú„ÅÆ‰ª∂Êï∞„ÇíÊõ¥Êñ∞
            const sectionTitle = document.querySelector('h3');
            sectionTitle.textContent = `ÂàÜÈÖçÂ±•Ê≠¥ (${filteredAllocations.length}‰ª∂)`;
        }
        
        // ÂÖ®„Éï„Ç£„É´„Çø„Éº„ÇØ„É™„Ç¢
        function clearAllFilters() {
            document.getElementById('layerFilter').value = '';
            document.getElementById('playerFilter').value = '';
            document.getElementById('slotFilter').value = '';
            filterAllocationHistory();
        }
        
        function showSystemSettings() {
            showMessage('„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆöÊ©üËÉΩ„ÅØÂÆüË£Ö‰∏≠„Åß„Åô', 'info');
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ff14_raid_data_${currentTeamId}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSuccess('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
        }
        
        // „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≥™ÂïèÈÅ∏ÊäûÊôÇ„ÅÆÂãï‰Ωú
        document.addEventListener('DOMContentLoaded', function() {
            const securityQuestionSelect = document.getElementById('signupSecurityQuestionSelect');
            const customQuestionInput = document.getElementById('signupCustomQuestionInput');
            
            if (securityQuestionSelect && customQuestionInput) {
                securityQuestionSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customQuestionInput.style.display = 'block';
                        customQuestionInput.focus();
                    } else {
                        customQuestionInput.style.display = 'none';
                        customQuestionInput.value = '';
                    }
                });
            }
        });
    </script>
</body>
</html>„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÁ¢∫Ë™çÁî®„ÅÆ„Ç≥„É°„É≥„Éà
