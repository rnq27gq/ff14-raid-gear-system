<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .tier-item h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-weight: 600;
        }
        .tier-item p {
            margin: 5px 0;
            color: #666;
        }
        .tier-item small {
            color: #95a5a6;
        }
        .new-tier-form {
            margin-top: 30px;
            padding: 24px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        .new-tier-form input {
            display: block;
            width: 100%;
            margin: 10px 0;
            box-sizing: border-box;
        }
        
        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        @media (max-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 800px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        .dashboard-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dashboard-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .dashboard-card button {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 8px;
            font-size: 14px;
        }
        .dashboard-status {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .dashboard-status h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        /* Member Setup Styles */
        .member-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        @media (max-width: 1200px) {
            .member-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .member-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .member-card h3 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            text-align: center;
            font-weight: 600;
        }
        .member-card input, .member-card select {
            width: 100%;
            margin: 5px 0;
            box-sizing: border-box;
        }
        
        /* Priority Settings Styles */
        .priority-settings-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        @media (max-width: 1200px) {
            .priority-settings-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .priority-group {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        .priority-group h3 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
        }
        .priority-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        .priority-item label {
            font-weight: 500;
            width: 40px;
        }
        .priority-item input {
            width: 80px;
            text-align: center;
            font-weight: bold;
        }
        .priority-presets {
            margin: 30px 0;
            text-align: center;
        }
        .priority-presets button {
            margin: 5px;
            background-color: #6c757d;
        }
        .priority-actions {
            text-align: center;
            margin-top: 30px;
        }
        
        /* Allocation Results Styles */
        .allocation-result-simple {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .item-winner-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        .winner-name {
            font-weight: 500;
            color: #27ae60;
            font-size: 14px;
        }
        .drop-item, .fixed-drop-item {
            background-color: #16213e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .fixed-drop-item h4 {
            margin: 0 0 5px 0;
            color: #ffd700;
        }
        .fixed-drop-item p {
            margin: 0;
            color: #bbb;
        }
        
        /* Direct Weapon Section Styles */
        .direct-weapon-section {
            background-color: #f8f9fa;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .direct-weapon-section h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .weapon-selection {
            margin-bottom: 15px;
        }
        .weapon-selection label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .weapon-selection select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .direct-weapon-allocation {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
        }
        .direct-weapon-allocation h4 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .winner-display {
            padding: 10px;
            background-color: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 5px;
        }
        .no-winner-display {
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #6c757d;
            border-radius: 5px;
        }
        .winner-name {
            color: #27ae60;
            font-weight: bold;
        }
        .allocation-reason {
            color: #666;
            font-style: italic;
        }
        .no-winner {
            color: #6c757d;
            font-weight: bold;
        }
        .judgment-counts {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }
        .need-count {
            color: #e74c3c;
            font-weight: bold;
        }
        .greed-count {
            color: #f39c12;
            font-weight: bold;
        }
        .pass-count {
            color: #6c757d;
        }
        
        /* Interactive Allocation Results */
        .allocation-result-interactive {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .item-info {
            margin-bottom: 10px;
        }
        .item-name {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .allocation-details {
            display: flex;
            gap: 15px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .winner-section {
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .automatic-result {
            background-color: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .automatic-result.freelot {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .freelot {
            color: #856404 !important;
            font-weight: bold;
        }
        .automatic-result .reason {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
        .manual-selection {
            margin-top: 8px;
        }
        .manual-selection label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }
        .manual-selection select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .manual-weapon-selection {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .manual-weapon-selection label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }
        .manual-weapon-selection select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .automatic-weapon-result {
            margin-bottom: 10px;
        }
        
        /* Compact Allocation Results */
        .allocation-header-compact {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            font-weight: 600;
            font-size: 13px;
            border-radius: 6px 6px 0 0;
            margin-bottom: 2px;
        }
        .header-item, .header-predicted, .header-actual {
            text-align: center;
        }
        .allocation-result-compact {
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            margin-bottom: 8px;
            background-color: white;
        }
        .allocation-result-compact:first-of-type {
            border-radius: 0;
        }
        .allocation-result-compact:last-of-type {
            border-radius: 0 0 6px 6px;
        }
        .item-allocation-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 12px;
        }
        .item-name-compact {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        .allocation-status {
            text-align: center;
        }
        .auto-result {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background-color: #e8f5e8;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        .auto-result.freelot {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .manual-selection-compact select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* Compact Direct Weapon */
        .direct-weapon-compact {
            background-color: #f8f9fa;
            border: 2px solid #3498db;
            border-radius: 6px;
            margin-top: 10px;
        }
        .weapon-header-compact {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            font-weight: 600;
            font-size: 13px;
            border-radius: 4px 4px 0 0;
            margin-bottom: 0;
        }
        .weapon-allocation-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 12px;
        }
        .weapon-name-compact {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        .weapon-status {
            text-align: center;
        }
        .weapon-selection-compact select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentScreen = 'raidTierSelection';
        let currentRaidTier = null;
        const STORAGE_KEY = 'ff14_gear_allocation_data';

        // „Éá„Éº„ÇøÁÆ°ÁêÜ
        function initStorage() {
            if (!localStorage.getItem(STORAGE_KEY)) {
                const data = {
                    raidTiers: [],
                    activeRaidTierId: null,
                    players: {},
                    allocations: {}
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }
        }

        function getData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏ÊäûÁîªÈù¢
        function showRaidTierSelection() {
            const app = document.querySelector('.container');
            const data = getData();
            const raidTiers = data.raidTiers || [];
            
            app.innerHTML = `
                <h1>FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†</h1>
                
                <div class="section">
                    <h2>„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû</h2>
                    <div id="existing-tiers">
                        ${raidTiers.length > 0 ? `
                            <h3>Êó¢Â≠ò„ÅÆ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢</h3>
                            <div class="tier-list">
                                ${raidTiers.map(tier => `
                                    <div class="tier-item" onclick="selectRaidTier('${tier.id}')">
                                        <div class="tier-info">
                                            <h4>${tier.name}</h4>
                                            <p>${tier.description || 'Ë™¨ÊòéÊú™Ë®≠ÂÆö'}</p>
                                            <small>‰ΩúÊàêÊó•: ${new Date(tier.createdAt).toLocaleDateString('ja-JP')}</small>
                                        </div>
                                        <div class="tier-actions">
                                            <button class="delete-btn" onclick="event.stopPropagation(); deleteRaidTier('${tier.id}', '${tier.name}')" title="ÂâäÈô§">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>„Åæ„Å†„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>'}
                    </div>
                    
                    <div class="new-tier-form">
                        <h3>Êñ∞„Åó„ÅÑ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆ‰ΩúÊàê</h3>
                        <input type="text" id="tier-name" placeholder="„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÂêçÔºà‰æãÔºö7.2Èõ∂ÂºèÔºâ" required>
                        <input type="text" id="tier-description" placeholder="Ë™¨ÊòéÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ">
                        <button onclick="createNewRaidTier()">Êñ∞Ë¶è‰ΩúÊàê</button>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #0f3460;">
                            <h4>„ÉÜ„Çπ„ÉàÁí∞Â¢É</h4>
                            <p style="font-size: 14px; color: #bbb;">„Åô„Åê„Å´„Ç∑„Çπ„ÉÜ„É†„Çí„ÉÜ„Çπ„Éà„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Çµ„É≥„Éó„É´„Éá„Éº„Çø‰ªò„Åç„ÅÆ„ÉÜ„Çπ„ÉàÁî®„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ</p>
                            <button onclick="generateTestData()" style="background-color: #e67e22; border-color: #d35400; width: 100%;">
                                üß™ „ÉÜ„Çπ„ÉàÁî®„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰ΩúÊàê
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // „ÉÜ„Ç£„Ç¢ÂâäÈô§Áî®CSS„ÇíËøΩÂä†
            addTierDeleteStyles();
        }
        
        // „ÉÜ„Ç£„Ç¢ÂâäÈô§Áî®CSS
        function addTierDeleteStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .tier-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    position: relative;
                }
                .tier-info {
                    flex: 1;
                }
                .tier-actions {
                    margin-left: 15px;
                }
                .delete-btn {
                    background-color: #e74c3c !important;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 16px;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                }
                .delete-btn:hover {
                    background-color: #c0392b !important;
                    transform: scale(1.1);
                }
            `;
            if (!document.getElementById('tier-delete-styles')) {
                style.id = 'tier-delete-styles';
                document.head.appendChild(style);
            }
        }
        
        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÂâäÈô§Ê©üËÉΩ
        function deleteRaidTier(tierId, tierName) {
            if (!confirm(`„Äå${tierName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n‚ö†Ô∏è „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n„Éª„Åô„Åπ„Å¶„ÅÆ„É°„É≥„Éê„Éº„Éá„Éº„Çø\n„ÉªË£ÖÂÇôÊñπÈáùË®≠ÂÆö\n„ÉªÊ≠¶Âô®Â∏åÊúõË®≠ÂÆö\n„ÉªÂàÜÈÖçÂ±•Ê≠¥\n\n„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂÆåÂÖ®„Å´ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ`)) {
                return;
            }
            
            // ÊúÄÁµÇÁ¢∫Ë™ç
            if (!confirm(`Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Äå${tierName}„Äç„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂ§±„Çè„Çå„Åæ„Åô„ÄÇ`)) {
                return;
            }
            
            const data = getData();
            
            // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Ëá™‰Ωì„ÇíÂâäÈô§
            data.raidTiers = data.raidTiers.filter(tier => tier.id !== tierId);
            
            // Èñ¢ÈÄ£„Éá„Éº„Çø„ÇÇÂâäÈô§
            if (data.players && data.players[tierId]) {
                delete data.players[tierId];
            }
            if (data.gearPolicies && data.gearPolicies[tierId]) {
                delete data.gearPolicies[tierId];
            }
            if (data.weaponWishes && data.weaponWishes[tierId]) {
                delete data.weaponWishes[tierId];
            }
            if (data.allocations && data.allocations[tierId]) {
                delete data.allocations[tierId];
            }
            if (data.positionPriorities && data.positionPriorities[tierId]) {
                delete data.positionPriorities[tierId];
            }
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÉÜ„Ç£„Ç¢„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (data.activeRaidTierId === tierId) {
                if (data.raidTiers.length > 0) {
                    // ‰ªñ„ÅÆ„ÉÜ„Ç£„Ç¢„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆ„ÇÇ„ÅÆ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
                    data.activeRaidTierId = data.raidTiers[0].id;
                    data.raidTiers[0].isActive = true;
                    currentRaidTier = data.raidTiers[0];
                } else {
                    // „ÉÜ„Ç£„Ç¢„ÅåÂÖ®„Åè„Å™„ÅÑÂ†¥Âêà
                    data.activeRaidTierId = null;
                    currentRaidTier = null;
                }
            }
            
            saveData(data);
            alert(`„Äå${tierName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);
            
            // ÁîªÈù¢„ÇíÂÜçÊèèÁîª
            showRaidTierSelection();
        }

        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰ΩúÊàê
        function createNewRaidTier() {
            const name = document.getElementById('tier-name').value.trim();
            const description = document.getElementById('tier-description').value.trim();
            
            if (!name) {
                alert('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const data = getData();
            const newTier = {
                id: Date.now().toString(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                isActive: false
            };
            
            data.raidTiers.push(newTier);
            saveData(data);
            
            selectRaidTier(newTier.id);
        }

        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû
        function selectRaidTier(tierId) {
            const data = getData();
            const tier = data.raidTiers.find(t => t.id === tierId);
            
            if (tier) {
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÇíÊõ¥Êñ∞
                data.raidTiers.forEach(t => t.isActive = false);
                tier.isActive = true;
                data.activeRaidTierId = tierId;
                saveData(data);
                
                currentRaidTier = tier;
                showInitialSetup();
            }
        }

        // ÂàùÊúüË®≠ÂÆöÁîªÈù¢
        function showInitialSetup() {
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>ÂàùÊúüË®≠ÂÆö - ${currentRaidTier.name}</h1>
                
                <div class="setup-navigation">
                    <button class="nav-btn active" onclick="showMemberSetup()">„É°„É≥„Éê„ÉºË®≠ÂÆö</button>
                    <button class="nav-btn" onclick="showEquipmentPolicySetup()">Ë£ÖÂÇôÊñπÈáùË®≠ÂÆö</button>
                    <button class="nav-btn" onclick="showWeaponWishSetup()">Ê≠¶Âô®Â∏åÊúõË®≠ÂÆö</button>
                </div>
                
                <div id="setup-content">
                    <!-- Ë®≠ÂÆöÂÜÖÂÆπ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
                
                <div class="setup-actions">
                    <button onclick="showRaidTierSelection()">„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû„Å´Êàª„Çã</button>
                    <button class="complete-setup-btn" onclick="completeSetup()">Ë®≠ÂÆöÂÆå‰∫Ü</button>
                </div>
            `;
            
            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Áî®CSS
            const style = document.createElement('style');
            style.textContent = `
                .setup-navigation {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #0f3460;
                    padding-bottom: 10px;
                }
                .nav-btn {
                    padding: 12px 24px;
                    background-color: #ffffff;
                    border: 1px solid #ddd;
                    color: #666;
                    cursor: pointer;
                    border-radius: 8px 8px 0 0;
                    font-weight: 500;
                    transition: all 0.2s ease;
                }
                .nav-btn.active {
                    background-color: #3498db;
                    color: white;
                    border-bottom: 2px solid #3498db;
                }
                .nav-btn:hover:not(.active) {
                    background-color: #f8f9fa;
                    color: #333;
                    border-color: #3498db;
                }
                .setup-actions {
                    margin-top: 30px;
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                }
                .complete-setup-btn {
                    background-color: #27ae60 !important;
                    color: white !important;
                    border: 2px solid #2ecc71 !important;
                    font-weight: bold;
                }
            `;
            if (!document.getElementById('setup-styles')) {
                style.id = 'setup-styles';
                document.head.appendChild(style);
            }
            
            showMemberSetup();
        }

        // „É°„É≥„Éê„ÉºË®≠ÂÆöÁîªÈù¢
        function showMemberSetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn').classList.add('active');
            
            // Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂèñÂæó
            const data = getData();
            const existingPlayers = data.players && data.players[currentRaidTier.id] || {};
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>8‰∫∫Âõ∫ÂÆö„É°„É≥„Éê„ÉºË®≠ÂÆö</h2>
                    <p>ÂêÑ„Éù„Ç∏„Ç∑„Éß„É≥„ÅÆ„É°„É≥„Éê„ÉºÊÉÖÂ†±„Å®„Ç∏„Éß„Éñ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <div class="member-grid">
                        ${['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'].map(position => {
                            const player = existingPlayers[position] || {};
                            return `
                            <div class="member-card">
                                <h3>${position}</h3>
                                <input type="text" id="name-${position}" placeholder="„Éó„É¨„Ç§„É§„ÉºÂêç" value="${player.name || ''}" />
                                <input type="text" id="char-${position}" placeholder="„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç" value="${player.characterName || ''}" />
                                <select id="job-${position}">
                                    <option value="">„Ç∏„Éß„Éñ„ÇíÈÅ∏Êäû</option>
                                    ${getJobOptionsForPosition(position, player.job)}
                                </select>
                            </div>
                        `;}).join('')}
                    </div>
                    <button onclick="saveMemberSettings()">„É°„É≥„Éê„ÉºË®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </div>
            `;
        }

        // „Éù„Ç∏„Ç∑„Éß„É≥Âà•„Ç∏„Éß„Éñ„Ç™„Éó„Ç∑„Éß„É≥
        function getJobOptionsForPosition(position, selectedJob = '') {
            const jobsByPosition = {
                'MT': ['„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº'],
                'ST': ['„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº'],
                'H1': ['ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ∏´'],
                'H2': ['Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ'],
                'D1': ['„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº'],
                'D2': ['„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº'],
                'D3': ['ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê'], // „É¨„É≥„Ç∏„Ç∏„Éß„Éñ„ÅÆ„Åø
                'D4': ['ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº'] // „Ç≠„É£„Çπ„Çø„Éº„Ç∏„Éß„Éñ„ÅÆ„Åø
            };
            
            return jobsByPosition[position].map(job => 
                `<option value="${job}" ${job === selectedJob ? 'selected' : ''}>${job}</option>`
            ).join('');
        }

        // „É°„É≥„Éê„ÉºË®≠ÂÆö‰øùÂ≠ò
        function saveMemberSettings() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const data = getData();
            const existingPlayers = data.players && data.players[currentRaidTier.id] || {};
            const players = {};
            
            for (const position of positions) {
                const name = document.getElementById(`name-${position}`).value.trim();
                const characterName = document.getElementById(`char-${position}`).value.trim();
                const job = document.getElementById(`job-${position}`).value;
                
                if (!name || !characterName || !job) {
                    alert(`${position}„ÅÆË®≠ÂÆö„Åå‰∏çÂÆåÂÖ®„Åß„Åô„ÄÇ„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    return;
                }
                
                // Êó¢Â≠ò„Éá„Éº„Çø„Çí‰øùÊåÅ„Åó„Å§„Å§Êõ¥Êñ∞
                const existingPlayer = existingPlayers[position] || {};
                players[position] = {
                    id: existingPlayer.id || Date.now().toString() + position,
                    name: name,
                    characterName: characterName,
                    position: position,
                    job: job,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    currentEquipment: existingPlayer.currentEquipment || {},
                    weaponWishes: existingPlayer.weaponWishes || []
                };
            }
            
            if (!data.players) data.players = {};
            data.players[currentRaidTier.id] = players;
            saveData(data);
            
            alert('„É°„É≥„Éê„ÉºË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºàË£ÖÂÇôÊñπÈáùË®≠ÂÆöÔºâ„Å´Ëá™ÂãïÈÅ∑Áßª
            showEquipmentPolicySetup();
        }

        // Ë£ÖÂÇôÊñπÈáùË®≠ÂÆöÁîªÈù¢
        function showEquipmentPolicySetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            if (!players || Object.keys(players).length === 0) {
                const content = document.getElementById('setup-content');
                content.innerHTML = `
                    <div class="section">
                        <h2>Ë£ÖÂÇôÊñπÈáùË®≠ÂÆö</h2>
                        <p style="color: #ff6b6b;">ÂÖà„Å´„É°„É≥„Éê„ÉºË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        <button onclick="showMemberSetup()">„É°„É≥„Éê„ÉºË®≠ÂÆö„Å´Êàª„Çã</button>
                    </div>
                `;
                return;
            }
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>Ë£ÖÂÇôÊñπÈáùË®≠ÂÆö</h2>
                    <p>ÂêÑ„Éù„Ç∏„Ç∑„Éß„É≥„ÅÆË£ÖÂÇôÈÉ®‰Ωç„Åî„Å®„Å´„ÄåÈõ∂Âºè„Äç„Åæ„Åü„ÅØ„Äå„Éà„Éº„É†„Çπ„Éà„Éº„É≥„Äç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    
                    <div class="policy-grid">
                        ${Object.keys(players).map(position => `
                            <div class="policy-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                <div class="equipment-slots">
                                    ${['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'].map(slot => {
                                        const currentPolicy = players[position].equipmentPolicy && players[position].equipmentPolicy[slot] || 'Èõ∂Âºè';
                                        return `
                                        <div class="slot-policy">
                                            <label>${slot}:</label>
                                            <select id="policy-${position}-${slot}">
                                                <option value="Èõ∂Âºè" ${currentPolicy === 'Èõ∂Âºè' ? 'selected' : ''}>Èõ∂Âºè</option>
                                                <option value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥" ${currentPolicy === '„Éà„Éº„É†„Çπ„Éà„Éº„É≥' ? 'selected' : ''}>„Éà„Éº„É†„Çπ„Éà„Éº„É≥</option>
                                            </select>
                                        </div>
                                    `;}).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="policy-actions">
                        <button onclick="setAllToSavage()">ÂÖ®„Å¶Èõ∂Âºè„Å´Ë®≠ÂÆö</button>
                        <button onclick="setAllToTomestone()">ÂÖ®„Å¶„Éà„Éº„É†„Çπ„Éà„Éº„É≥„Å´Ë®≠ÂÆö</button>
                        <button onclick="saveEquipmentPolicy()">Ë£ÖÂÇôÊñπÈáù„Çí‰øùÂ≠ò</button>
                    </div>
                </div>
            `;
            
            // Ë£ÖÂÇôÊñπÈáùÁî®CSS
            const style = document.createElement('style');
            style.textContent = `
                .policy-grid {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 12px;
                    margin: 20px 0;
                }
                @media (max-width: 1200px) {
                    .policy-grid {
                        grid-template-columns: repeat(2, 1fr);
                    }
                }
                @media (max-width: 800px) {
                    .policy-grid {
                        grid-template-columns: 1fr;
                    }
                }
                .policy-card {
                    background-color: #ffffff;
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                    max-width: 300px;
                    font-size: 14px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .policy-card h3 {
                    margin: 0 0 4px 0;
                    color: #2c3e50;
                    font-size: 16px;
                }
                .policy-card small {
                    color: #666;
                    margin-bottom: 8px;
                    display: block;
                    font-size: 12px;
                }
                .equipment-slots {
                    margin-top: 8px;
                }
                .slot-policy {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin: 3px 0;
                }
                .slot-policy label {
                    min-width: 35px;
                    color: #333;
                    font-size: 12px;
                }
                .slot-policy select {
                    width: 100px;
                    font-size: 11px;
                    padding: 2px;
                    border: 1px solid #ddd;
                    border-radius: 3px;
                }
                .slot-policy select option[value="Èõ∂Âºè"] {
                    background-color: #e8f4fd;
                    color: #1976d2;
                }
                .slot-policy select option[value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥"] {
                    background-color: #fff3e0;
                    color: #f57c00;
                }
                .policy-actions {
                    text-align: center;
                    margin-top: 20px;
                }
                .policy-actions button {
                    margin: 0 10px;
                }
            `;
            if (!document.getElementById('policy-styles')) {
                style.id = 'policy-styles';
                document.head.appendChild(style);
            }
        }
        
        // Ë£ÖÂÇôÊñπÈáù‰∏ÄÊã¨Ë®≠ÂÆö
        function setAllToSavage() {
            document.querySelectorAll('select[id^="policy-"]').forEach(select => {
                select.value = 'Èõ∂Âºè';
            });
        }
        
        function setAllToTomestone() {
            document.querySelectorAll('select[id^="policy-"]').forEach(select => {
                select.value = '„Éà„Éº„É†„Çπ„Éà„Éº„É≥';
            });
        }
        
        // Ë£ÖÂÇôÊñπÈáù‰øùÂ≠ò
        function saveEquipmentPolicy() {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            Object.keys(players).forEach(position => {
                const equipmentPolicy = {};
                ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'].forEach(slot => {
                    const policySelect = document.getElementById(`policy-${position}-${slot}`);
                    if (policySelect) {
                        equipmentPolicy[slot] = policySelect.value;
                    }
                });
                players[position].equipmentPolicy = equipmentPolicy;
            });
            
            saveData(data);
            showWeaponWishSetup();
        }

        function showWeaponWishSetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[2].classList.add('active');
            
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®Â∏åÊúõË®≠ÂÆö</h2>
                    <p>4Â±§„Åß„É©„É≥„ÉÄ„É†„Éâ„É≠„ÉÉ„Éó„Åô„ÇãÊ≠¶Âô®„Å∏„ÅÆÂ∏åÊúõ„ÇíÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅåÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇÂÑ™ÂÖàÈ†Ü‰Ωç„ÇÇË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    
                    <div class="weapon-wish-grid">
                        ${Object.keys(players).map(position => `
                            <div class="wish-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                
                                <div class="current-wishes" id="wishes-${position}">
                                    <!-- ÁèæÂú®„ÅÆÂ∏åÊúõ„É™„Çπ„Éà -->
                                </div>
                                
                                <div class="add-wish">
                                    <select id="job-wish-${position}">
                                        <option value="">Â∏åÊúõ„Ç∏„Éß„Éñ„ÇíÈÅ∏Êäû</option>
                                        ${getAllJobOptions()}
                                    </select>
                                    <input type="number" id="priority-${position}" placeholder="ÂÑ™ÂÖàÂ∫¶" min="1" max="10" value="1">
                                    <button onclick="addWeaponWish('${position}')">ËøΩÂä†</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                </div>
            `;
            
            // Ê≠¶Âô®Â∏åÊúõÁî®CSS
            const style = document.createElement('style');
            style.textContent = `
                .weapon-wish-grid {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 12px;
                    margin: 20px 0;
                }
                @media (max-width: 1200px) {
                    .weapon-wish-grid {
                        grid-template-columns: repeat(2, 1fr);
                    }
                }
                @media (max-width: 800px) {
                    .weapon-wish-grid {
                        grid-template-columns: 1fr;
                    }
                }
                .wish-card {
                    background-color: #ffffff;
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                    max-width: 300px;
                    font-size: 14px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .wish-card h3 {
                    margin: 0 0 4px 0;
                    color: #2c3e50;
                    font-size: 16px;
                }
                .wish-card small {
                    color: #666;
                    margin-bottom: 12px;
                    display: block;
                    font-size: 12px;
                }
                .current-wishes {
                    min-height: 50px;
                    margin-bottom: 12px;
                }
                .wish-item {
                    background-color: #f8f9fa;
                    padding: 6px;
                    margin: 3px 0;
                    border-radius: 4px;
                    border: 1px solid #e9ecef;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 13px;
                }
                .wish-item span {
                    color: #333;
                }
                .wish-item button {
                    background-color: #6c757d;
                    padding: 2px 8px;
                    font-size: 12px;
                    color: white;
                }
                .add-wish {
                    display: flex;
                    gap: 4px;
                    flex-wrap: wrap;
                }
                .add-wish select, .add-wish input {
                    flex: 1;
                    min-width: 80px;
                    font-size: 12px;
                    padding: 4px;
                }
                .add-wish button {
                    font-size: 12px;
                    padding: 4px 8px;
                    background-color: #6c757d;
                    color: white;
                }
            `;
            if (!document.getElementById('wish-styles')) {
                style.id = 'wish-styles';
                document.head.appendChild(style);
            }
            
            // Êó¢Â≠ò„ÅÆÂ∏åÊúõ„ÇíË°®Á§∫
            Object.keys(players).forEach(position => {
                updateWishDisplay(position);
            });
        }
        
        // ÂÖ®„Ç∏„Éß„Éñ„Ç™„Éó„Ç∑„Éß„É≥
        function getAllJobOptions() {
            const allJobs = [
                '„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº',
                'ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ∏´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ',
                '„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº',
                'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê', 'ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº'
            ];
            return allJobs.map(job => `<option value="${job}">${job}</option>`).join('');
        }
        
        // Ê≠¶Âô®Â∏åÊúõËøΩÂä†
        function addWeaponWish(position) {
            const jobSelect = document.getElementById(`job-wish-${position}`);
            const priorityInput = document.getElementById(`priority-${position}`);
            
            if (!jobSelect.value) return;
            
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            if (!players[position].weaponWishes) {
                players[position].weaponWishes = [];
            }
            
            // Êó¢„Å´Âêå„Åò„Ç∏„Éß„Éñ„ÅÆÂ∏åÊúõ„Åå„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (players[position].weaponWishes.some(wish => wish.jobName === jobSelect.value)) {
                return; // Êó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØËøΩÂä†„Åó„Å™„ÅÑ
            }
            
            players[position].weaponWishes.push({
                jobName: jobSelect.value,
                priority: parseInt(priorityInput.value) || 1,
                addedAt: new Date().toISOString()
            });
            
            // ÂÑ™ÂÖàÂ∫¶È†Ü„Å´„ÇΩ„Éº„Éà
            players[position].weaponWishes.sort((a, b) => a.priority - b.priority);
            
            saveData(data);
            
            // Ë°®Á§∫Êõ¥Êñ∞
            updateWishDisplay(position);
            
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            jobSelect.value = '';
            priorityInput.value = '1';
        }
        
        // Ê≠¶Âô®Â∏åÊúõÂâäÈô§
        function removeWeaponWish(position, jobName) {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            players[position].weaponWishes = players[position].weaponWishes.filter(
                wish => wish.jobName !== jobName
            );
            
            saveData(data);
            updateWishDisplay(position);
        }
        
        // Â∏åÊúõË°®Á§∫Êõ¥Êñ∞
        function updateWishDisplay(position) {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            const container = document.getElementById(`wishes-${position}`);
            
            if (!players[position].weaponWishes || players[position].weaponWishes.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 14px;">Â∏åÊúõ„Å™„Åó</p>';
                return;
            }
            
            container.innerHTML = players[position].weaponWishes.map(wish => `
                <div class="wish-item">
                    <span>${wish.jobName} (ÂÑ™ÂÖàÂ∫¶: ${wish.priority})</span>
                    <button onclick="removeWeaponWish('${position}', '${wish.jobName}')">ÂâäÈô§</button>
                </div>
            `).join('');
        }

        function completeSetup() {
            showMainDashboard();
        }
        
        // „É°„Ç§„É≥„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        function showMainDashboard() {
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${currentRaidTier.name} - „É°„Ç§„É≥„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Ë®≠ÂÆöÁÆ°ÁêÜ</h3>
                        <button onclick="showInitialSetup()">ÁôªÈå≤ÂÜÖÂÆπÁ¢∫Ë™ç„ÉªÂ§âÊõ¥</button>
                        <button onclick="showPositionPrioritySettings()">„Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>„É¨„Ç§„Éâ„ÇØ„É™„Ç¢</h3>
                        <button onclick="showLayerAllocation(1)">1Â±§„ÇØ„É™„Ç¢</button>
                        <button onclick="showLayerAllocation(2)">2Â±§„ÇØ„É™„Ç¢</button>
                        <button onclick="showLayerAllocation(3)">3Â±§„ÇØ„É™„Ç¢</button>
                        <button onclick="showLayerAllocation(4)">4Â±§„ÇØ„É™„Ç¢</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Â±•Ê≠¥„ÉªÁµ±Ë®à</h3>
                        <button onclick="showHistory()">ÈÖçÂ∏ÉÂ±•Ê≠¥„ÉªË£ÖÂÇôÁä∂Ê≥Å</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>„Åù„ÅÆ‰ªñ</h3>
                        <button onclick="showRaidTierSelection()">„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Â§âÊõ¥</button>
                        <button onclick="exportData()">„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        <button onclick="generateTestData()" style="background-color: #e67e22; border-color: #d35400;">üß™ „ÉÜ„Çπ„Éà„Éá„Éº„ÇøÁîüÊàê</button>
                    </div>
                </div>
                
                <div class="dashboard-status">
                    <h3>‰ªäÈÄ±„ÅÆÈÄ≤Ë°åÁä∂Ê≥Å</h3>
                    <div id="weekly-progress">
                        <p>ÂÆüË£Ö‰∫àÂÆöÔºöÂêÑÂ±§„ÅÆ„ÇØ„É™„Ç¢Áä∂Ê≥Å„ÄÅÂèñÂæóË£ÖÂÇô„ÅÆË°®Á§∫</p>
                    </div>
                </div>
            `;
        }
        
        // Â±§Âà•Ë£ÖÂÇôÂàÜÈÖçÁîªÈù¢ÔºàÂõ∫ÂÆö„Éâ„É≠„ÉÉ„ÉóÂç≥ÊôÇË°®Á§∫ÊñπÂºèÔºâ
        function showLayerAllocation(layer) {
            
            const app = document.querySelector('.container');
            
            try {
                const data = getData();
                
                
                if (!currentRaidTier || !currentRaidTier.id) {
                    app.innerHTML = `
                        <h1>„Ç®„É©„Éº</h1>
                        <div class="section">
                            <p style="color: #ff6b6b;">„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
                            <button onclick="showRaidTierSelection()">„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû„Å´Êàª„Çã</button>
                        </div>
                    `;
                    return;
                }
                
                const players = data.players && data.players[currentRaidTier.id];
                
                if (!players || Object.keys(players).length === 0) {
                    app.innerHTML = `
                        <h1>${layer}Â±§Ë£ÖÂÇôÂàÜÈÖç</h1>
                        <div class="section">
                            <p style="color: #ff6b6b;">ÂÖà„Å´„É°„É≥„Éê„ÉºË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                            <button onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                        </div>
                    `;
                    return;
                }
                
                // Ê≠£Â∏∏„Å™Â†¥Âêà„ÅÆHTMLÊèèÁîª
                app.innerHTML = `
                <h1>${layer}Â±§„ÇØ„É™„Ç¢Á¢∫Ë™ç</h1>
                
                <div class="allocation-navigation">
                    <button onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    <button onclick="generateLayerDropsAndProcess(${layer})" class="refresh-btn">ÂàÜÈÖçÁµêÊûú„ÇíÂÜçË®àÁÆó</button>
                    <button onclick="generateTestData()" class="test-btn">„ÉÜ„Çπ„Éà„Éá„Éº„ÇøÁîüÊàê</button>
                    <button onclick="showItemImportFromWeb(${layer})" class="import-btn">Web„Åã„Çâ„Ç¢„Ç§„ÉÜ„É†ÂèñÂæó</button>
                </div>
                
                <div class="layer-content-grid">
                    <div class="section layer-drops-section">
                        <h2>${layer}Â±§</h2>
                        <div id="fixed-drops">
                            <!-- „Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                    
                    <div class="section layer-results-section">
                        <h2>Ëá™ÂãïÂàÜÈÖçÁµêÊûú</h2>
                        <div id="allocation-summary">
                            <!-- ÂàÜÈÖçÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                </div>
                
                <div class="allocation-actions">
                    <button onclick="confirmAndSaveAllocation(${layer})" class="confirm-btn">„Åì„ÅÆÁµêÊûú„ÅßÁ¢∫ÂÆö„Éª‰øùÂ≠ò</button>
                </div>
                `;
            
            // Â±§Âà•Ë£ÖÂÇôÂàÜÈÖçÁî®CSS
            const style = document.createElement('style');
            style.textContent = `
                .layer-content-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin: 15px 0;
                }
                @media (max-width: 1200px) {
                    .layer-content-grid {
                        grid-template-columns: 1fr;
                    }
                }
                .layer-drops-section {
                    min-height: 300px;
                }
                .layer-results-section {
                    min-height: 300px;
                }
                .allocation-navigation {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    padding-bottom: 8px;
                    border-bottom: 2px solid #e9ecef;
                    flex-wrap: wrap;
                    gap: 10px;
                }
                .allocation-navigation button {
                    padding: 8px 12px;
                    font-size: 14px;
                    flex: 0 0 auto;
                }
                .generate-btn {
                    background-color: #2ed573 !important;
                }
                .test-btn {
                    background-color: #e74c3c !important;
                }
                .refresh-btn {
                    background-color: #9b59b6 !important;
                }
                .import-btn {
                    background-color: #ff9f43 !important;
                }
                .confirm-btn {
                    background-color: #27ae60 !important;
                    padding: 15px 30px !important;
                    font-size: 16px !important;
                }
                .fixed-drop-item {
                    background-color: #ffffff;
                    padding: 16px 20px;
                    margin: 12px 0;
                    border-radius: 12px;
                    border-left: 4px solid #3498db;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    border: 1px solid #e9ecef;
                }
                .fixed-drop-item h4 {
                    margin: 0;
                    color: #2c3e50;
                    font-size: 16px;
                    font-weight: 600;
                }
                .fixed-drop-item p {
                    margin: 0;
                    color: #666;
                    font-size: 14px;
                }
                .add-item-form {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                    flex-wrap: wrap;
                }
                .add-item-form select, .add-item-form input {
                    flex: 1;
                    min-width: 120px;
                }
                .drop-item {
                    background-color: #ffffff;
                    padding: 15px;
                    margin: 10px 0;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .drop-item-info h4 {
                    margin: 0 0 5px 0;
                    color: #2c3e50;
                }
                .drop-item-info p {
                    margin: 0;
                    color: #666;
                    font-size: 14px;
                }
                .drop-item-actions button {
                    margin-left: 10px;
                    background-color: #ff4757 !important;
                    padding: 5px 10px;
                    font-size: 12px;
                }
                .allocation-result {
                    background-color: #ffffff;
                    padding: 20px;
                    margin: 16px 0;
                    border-radius: 12px;
                    border-left: 4px solid #3498db;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border: 1px solid #e9ecef;
                }
                .allocation-result h4 {
                    margin: 0 0 12px 0;
                    color: #2c3e50;
                    font-weight: 600;
                    font-size: 18px;
                }
                .allocation-result p {
                    margin: 8px 0;
                    color: #555;
                    line-height: 1.5;
                }
                .allocation-result strong {
                    color: #2c3e50;
                }
                .judgment-list {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 12px;
                    margin-top: 16px;
                }
                .judgment-item {
                    padding: 12px;
                    border-radius: 8px;
                    text-align: center;
                    font-size: 14px;
                    font-weight: 500;
                    transition: transform 0.2s ease;
                    cursor: pointer;
                }
                .judgment-item:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
                }
                .player-name {
                    font-weight: bold;
                    font-size: 16px;
                    margin-bottom: 4px;
                }
                .judgment-text {
                    font-size: 18px;
                    font-weight: bold;
                    margin: 4px 0;
                }
                .priority-text {
                    font-size: 12px;
                    opacity: 0.9;
                    margin: 2px 0;
                }
                .policy-text {
                    font-size: 11px;
                    opacity: 0.8;
                    margin-top: 2px;
                }
                .judgment-need {
                    background-color: #27ae60;
                    color: white;
                    box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
                }
                .judgment-greed {
                    background-color: #f39c12;
                    color: white;
                    box-shadow: 0 2px 4px rgba(243, 156, 18, 0.3);
                }
                .judgment-pass {
                    background-color: #95a5a6;
                    color: white;
                    box-shadow: 0 2px 4px rgba(149, 165, 166, 0.3);
                }
                .allocation-actions {
                    text-align: center;
                    margin-top: 20px;
                }
                .allocation-actions button {
                    margin: 0 10px;
                    padding: 15px 30px;
                    font-size: 16px;
                }
                .allocation-actions button:disabled {
                    background-color: #555 !important;
                    cursor: not-allowed;
                }
                .allocation-result-simple {
                    background-color: #ffffff;
                    padding: 12px;
                    margin-bottom: 10px;
                    border-radius: 8px;
                    border: 2px solid #e9ecef;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .item-winner-display {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .item-name {
                    font-size: 16px;
                    font-weight: bold;
                    color: #2c3e50;
                }
                .winner-name {
                    font-size: 14px;
                    font-weight: 500;
                    color: #27ae60;
                    background-color: #d5f4e6;
                    padding: 6px 12px;
                    border-radius: 16px;
                    border: 2px solid #27ae60;
                }
            `;
            if (!document.getElementById('allocation-styles')) {
                style.id = 'allocation-styles';
                document.head.appendChild(style);
            }
            
                // HTML„ÅÆÊèèÁîªÂÆå‰∫ÜÂæå„Å´Âá¶ÁêÜ„ÇíÂÆüË°å
                setTimeout(() => {
                    const fixedDropsEl = document.getElementById('fixed-drops');
                    const summaryEl = document.getElementById('allocation-summary');
                    
                    if (fixedDropsEl && summaryEl) {
                        generateLayerDropsAndProcess(layer);
                    } else {
                        // DOMË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        alert('DOMË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÊâãÂãï„Åß„ÄåÂàÜÈÖçÁµêÊûú„ÇíÂÜçË®àÁÆó„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                }, 200);
                
            } catch (error) {
                app.innerHTML = `
                    <h1>„Ç®„É©„Éº</h1>
                    <div class="section">
                        <p style="color: #ff6b6b;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}</p>
                        <button onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    </div>
                `;
            }
        }
        
        function showHistory() {
            try {
                const app = document.querySelector('.container');
                const data = getData();
                
                if (!currentRaidTier || !currentRaidTier.id) {
                    app.innerHTML = `
                        <h1>„Ç®„É©„Éº</h1>
                        <div class="section">
                            <p style="color: #ff6b6b;">„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
                            <button onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                        </div>
                    `;
                    return;
                }
                
                const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
                const players = data.players && data.players[currentRaidTier.id] || {};
                
                app.innerHTML = `
                    <h1>${currentRaidTier.name} - ÈÖçÂ∏ÉÂ±•Ê≠¥„ÉªË£ÖÂÇôÁä∂Ê≥Å</h1>
                    
                    <div class="history-navigation">
                        <button onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                        <button onclick="exportHistoryData()" class="export-btn">Â±•Ê≠¥„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    </div>
                    
                    <div class="history-tabs">
                        <button class="tab-btn active" onclick="showAllocationHistory()">ÈÖçÂ∏ÉÂ±•Ê≠¥</button>
                        <button class="tab-btn" onclick="showPlayerEquipmentStatus()">Ë£ÖÂÇôÁä∂Ê≥Å</button>
                        <button class="tab-btn" onclick="showWeeklyStatistics()">ÈÄ±Âà•Áµ±Ë®à</button>
                    </div>
                    
                    <div id="history-content">
                        <!-- Â±•Ê≠¥ÂÜÖÂÆπ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                `;
                
                // Â±•Ê≠¥Áî®CSS
                const style = document.createElement('style');
                style.textContent = `
                    .history-navigation {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 15px;
                        padding-bottom: 8px;
                        border-bottom: 2px solid #e9ecef;
                    }
                    .export-btn {
                        background-color: #17a2b8 !important;
                    }
                    .history-tabs {
                        display: flex;
                        gap: 8px;
                        margin-bottom: 15px;
                        border-bottom: 2px solid #e9ecef;
                        padding-bottom: 8px;
                    }
                    .tab-btn {
                        padding: 8px 16px;
                        background-color: #f8f9fa;
                        border: 1px solid #dee2e6;
                        color: #495057;
                        cursor: pointer;
                        border-radius: 6px 6px 0 0;
                        font-weight: 500;
                        font-size: 14px;
                        transition: all 0.2s ease;
                    }
                    .tab-btn.active {
                        background-color: #3498db;
                        color: white;
                        border-bottom: 2px solid #3498db;
                    }
                    .tab-btn:hover:not(.active) {
                        background-color: #e9ecef;
                        color: #2c3e50;
                        border-color: #3498db;
                    }
                    .allocation-history-header {
                        display: grid;
                        grid-template-columns: 100px 60px 1fr 80px 150px 80px;
                        gap: 10px;
                        padding: 12px;
                        background-color: #f8f9fa;
                        border: 1px solid #e9ecef;
                        border-radius: 8px 8px 0 0;
                        font-weight: 600;
                        color: #2c3e50;
                        font-size: 14px;
                    }
                    .allocation-history-row {
                        display: grid;
                        grid-template-columns: 100px 60px 1fr 80px 150px 80px;
                        gap: 10px;
                        padding: 10px 12px;
                        background-color: #ffffff;
                        border: 1px solid #e9ecef;
                        border-top: none;
                        font-size: 14px;
                        color: #555;
                        transition: background-color 0.2s ease;
                    }
                    .allocation-history-row:hover {
                        background-color: #f8f9fa;
                    }
                    .allocation-history-row:last-child {
                        border-radius: 0 0 8px 8px;
                    }
                    .history-col-date, .history-col-layer, .history-col-item, 
                    .history-col-slot, .history-col-winner, .history-col-week {
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .player-equipment-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 15px;
                        margin: 15px 0;
                    }
                    .player-equipment-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .player-equipment-card h3 {
                        margin: 0 0 15px 0;
                        color: #2c3e50;
                        font-weight: 600;
                        text-align: center;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #3498db;
                    }
                    .equipment-slot {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 0;
                        border-bottom: 1px solid #f1f3f4;
                    }
                    .equipment-slot:last-child {
                        border-bottom: none;
                    }
                    .equipment-slot-name {
                        font-weight: 500;
                        color: #495057;
                        min-width: 60px;
                    }
                    .equipment-item {
                        flex: 1;
                        text-align: right;
                        color: #6c757d;
                    }
                    .equipment-item.has-item {
                        color: #28a745;
                        font-weight: 500;
                    }
                    .equipment-item.no-item {
                        color: #dc3545;
                        font-style: italic;
                    }
                    .equipment-status-select {
                        flex: 1;
                        text-align: right;
                        padding: 4px 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        background-color: #ffffff;
                        font-size: 14px;
                        transition: background-color 0.3s ease;
                    }
                    .equipment-status-select:focus {
                        outline: none;
                        border-color: #3498db;
                        box-shadow: 0 0 3px rgba(52, 152, 219, 0.3);
                    }
                    .equipment-status-select option[value="Èõ∂Âºè"] {
                        background-color: #e8f4fd;
                        color: #1976d2;
                    }
                    .equipment-status-select option[value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥"] {
                        background-color: #fff3e0;
                        color: #f57c00;
                    }
                    .statistics-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                        gap: 15px;
                        margin: 15px 0;
                    }
                    .stat-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        text-align: center;
                    }
                    .stat-card h3 {
                        margin: 0 0 10px 0;
                        color: #2c3e50;
                        font-weight: 600;
                    }
                    .stat-number {
                        font-size: 2.5rem;
                        font-weight: 700;
                        color: #3498db;
                        margin: 10px 0;
                    }
                    .stat-description {
                        color: #6c757d;
                        font-size: 14px;
                    }
                    .filter-section {
                        background-color: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        border: 1px solid #e9ecef;
                    }
                    .filter-controls {
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        align-items: center;
                    }
                    .filter-controls select, .filter-controls input {
                        padding: 8px 12px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        background-color: white;
                        color: #495057;
                    }
                `;
                if (!document.getElementById('history-styles')) {
                    style.id = 'history-styles';
                    document.head.appendChild(style);
                }
                
                // „Éá„Éï„Ç©„É´„Éà„ÅßÈÖçÂ∏ÉÂ±•Ê≠¥„ÇíË°®Á§∫
                setTimeout(() => {
                    showAllocationHistory();
                }, 100);
                
            } catch (error) {
                const app = document.querySelector('.container');
                app.innerHTML = `
                    <h1>„Ç®„É©„Éº</h1>
                    <div class="section">
                        <p style="color: #ff6b6b;">Â±•Ê≠¥Ë°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}</p>
                        <button onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    </div>
                `;
            }
        }
        
        // ÈÖçÂ∏ÉÂ±•Ê≠¥Ë°®Á§∫
        function showAllocationHistory() {
            try {
                // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                
                const data = getData();
                const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
                const content = document.getElementById('history-content');
                
                if (allocations.length === 0) {
                    content.innerHTML = `
                        <div class="section">
                            <h3>ÈÖçÂ∏ÉÂ±•Ê≠¥</h3>
                            <p>„Åæ„Å†Ë£ÖÂÇô„ÅÆÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                            <p>„É¨„Ç§„Éâ„Çí„ÇØ„É™„Ç¢„Åó„Å¶Ë£ÖÂÇô„ÇíÂàÜÈÖç„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Â±•Ê≠¥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</p>
                        </div>
                    `;
                    return;
                }
                
                // Â±•Ê≠¥„ÇíÊñ∞„Åó„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
                const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                content.innerHTML = `
                    <div class="filter-section">
                        <h3>„Éï„Ç£„É´„Çø„Éº</h3>
                        <div class="filter-controls">
                            <label>Â±§:</label>
                            <select id="layer-filter" onchange="filterAllocationHistory()">
                                <option value="">„Åô„Åπ„Å¶„ÅÆÂ±§</option>
                                <option value="1">1Â±§</option>
                                <option value="2">2Â±§</option>
                                <option value="3">3Â±§</option>
                                <option value="4">4Â±§</option>
                            </select>
                            
                            <label>„Éó„É¨„Ç§„É§„Éº:</label>
                            <select id="player-filter" onchange="filterAllocationHistory()">
                                <option value="">„Åô„Åπ„Å¶„ÅÆ„Éó„É¨„Ç§„É§„Éº</option>
                                ${getUniquePlayersFromAllocations(allocations).map(player => 
                                    `<option value="${player}">${player}</option>`
                                ).join('')}
                            </select>
                            
                            <label>ÈÄ±:</label>
                            <select id="week-filter" onchange="filterAllocationHistory()">
                                <option value="">„Åô„Åπ„Å¶„ÅÆÈÄ±</option>
                                ${getUniqueWeeksFromAllocations(allocations).map(week => 
                                    `<option value="${week}">${week}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div id="filtered-allocations">
                        ${renderAllocationHistory(sortedAllocations)}
                    </div>
                `;
                
            } catch (error) {
                const content = document.getElementById('history-content');
                content.innerHTML = `<p style="color: #ff6b6b;">Â±•Ê≠¥Ë°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ</p>`;
            }
        }
        
        // ÈÖçÂ∏ÉÂ±•Ê≠¥„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderAllocationHistory(allocations) {
            if (allocations.length === 0) {
                return '<p>„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„Å´Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            }
            
            return `<div class="allocation-history-header">
                        <span class="history-col-date">Êó•‰ªò</span>
                        <span class="history-col-layer">Â±§</span>
                        <span class="history-col-item">„Ç¢„Ç§„ÉÜ„É†</span>
                        <span class="history-col-slot">ÈÉ®‰Ωç</span>
                        <span class="history-col-winner">ÂèñÂæóËÄÖ</span>
                        <span class="history-col-week">ÈÄ±</span>
                    </div>` + 
                    allocations.map(allocation => {
                const timestamp = new Date(allocation.timestamp);
                const formattedDate = timestamp.toLocaleDateString('ja-JP');
                const winnerText = allocation.winner ? 
                    `${allocation.winner.name} (${allocation.winner.position})` : 
                    '„Å™„Åó';
                
                return `
                    <div class="allocation-history-row">
                        <span class="history-col-date">${formattedDate}</span>
                        <span class="history-col-layer">${allocation.layer}Â±§</span>
                        <span class="history-col-item">${allocation.equipment.name}</span>
                        <span class="history-col-slot">${allocation.equipment.slot}</span>
                        <span class="history-col-winner">${winnerText}</span>
                        <span class="history-col-week">${allocation.week || '‰∏çÊòé'}</span>
                    </div>
                `;
            }).join('');
        }
        
        // „Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩ
        function filterAllocationHistory() {
            const data = getData();
            const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
            
            const layerFilter = document.getElementById('layer-filter').value;
            const playerFilter = document.getElementById('player-filter').value;
            const weekFilter = document.getElementById('week-filter').value;
            
            let filteredAllocations = allocations;
            
            if (layerFilter) {
                filteredAllocations = filteredAllocations.filter(a => a.layer.toString() === layerFilter);
            }
            
            if (playerFilter) {
                filteredAllocations = filteredAllocations.filter(a => 
                    a.winner && a.winner.name === playerFilter
                );
            }
            
            if (weekFilter) {
                filteredAllocations = filteredAllocations.filter(a => a.week === weekFilter);
            }
            
            // Êñ∞„Åó„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
            const sortedFiltered = filteredAllocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            document.getElementById('filtered-allocations').innerHTML = renderAllocationHistory(sortedFiltered);
        }
        
        // „É¶„Éã„Éº„ÇØ„Å™„Éó„É¨„Ç§„É§„Éº„É™„Çπ„Éà„ÇíÂèñÂæó
        function getUniquePlayersFromAllocations(allocations) {
            const playerNames = new Set();
            allocations.forEach(allocation => {
                if (allocation.winner && allocation.winner.name) {
                    playerNames.add(allocation.winner.name);
                }
            });
            return Array.from(playerNames).sort();
        }
        
        // „É¶„Éã„Éº„ÇØ„Å™ÈÄ±„É™„Çπ„Éà„ÇíÂèñÂæó
        function getUniqueWeeksFromAllocations(allocations) {
            const weeks = new Set();
            allocations.forEach(allocation => {
                if (allocation.week) {
                    weeks.add(allocation.week);
                }
            });
            return Array.from(weeks).sort().reverse(); // Êñ∞„Åó„ÅÑÈÄ±„Åã„ÇâÈ†ÜÁï™„Å´
        }
        
        // „Éó„É¨„Ç§„É§„ÉºË£ÖÂÇôÁä∂Ê≥ÅË°®Á§∫
        function showPlayerEquipmentStatus() {
            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            
            const data = getData();
            const players = data.players && data.players[currentRaidTier.id] || {};
            const content = document.getElementById('history-content');
            
            if (Object.keys(players).length === 0) {
                content.innerHTML = `
                    <div class="section">
                        <h3>Ë£ÖÂÇôÁä∂Ê≥Å</h3>
                        <p>„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                    </div>
                `;
                return;
            }
            
            const equipmentSlots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
            
            content.innerHTML = `
                <div class="section">
                    <h3>ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆÁèæÂú®Ë£ÖÂÇôÁä∂Ê≥Å</h3>
                    <div class="player-equipment-grid">
                        ${Object.values(players).map(player => {
                            return `
                                <div class="player-equipment-card">
                                    <h3>${player.name} (${player.position}) - ${player.job}</h3>
                                    ${equipmentSlots.map(slot => {
                                        const equipment = player.currentEquipment && player.currentEquipment[slot];
                                        const hasEquipment = equipment && equipment.itemLevel;
                                        const equipmentPolicy = player.equipmentPolicy && player.equipmentPolicy[slot];
                                        
                                        // ÁèæÂú®„ÅÆË£ÖÂÇôÁä∂ÊÖã„ÇíÂà§ÂÆö
                                        let currentStatus = 'Êú™ÂèñÂæó';
                                        if (hasEquipment && equipmentPolicy === 'Èõ∂Âºè') {
                                            currentStatus = 'Èõ∂Âºè';
                                        } else if (hasEquipment && equipmentPolicy === '„Éà„Éº„É†„Çπ„Éà„Éº„É≥') {
                                            currentStatus = '„Éà„Éº„É†„Çπ„Éà„Éº„É≥';
                                        }
                                        
                                        return `
                                            <div class="equipment-slot">
                                                <span class="equipment-slot-name">${slot}:</span>
                                                <select class="equipment-status-select" 
                                                        id="equipment-${player.position}-${slot}"
                                                        onchange="updateEquipmentStatus('${player.position}', '${slot}', this.value)">
                                                    <option value="Êú™ÂèñÂæó" ${currentStatus === 'Êú™ÂèñÂæó' ? 'selected' : ''}>Êú™ÂèñÂæó</option>
                                                    <option value="Èõ∂Âºè" ${currentStatus === 'Èõ∂Âºè' ? 'selected' : ''}>Èõ∂Âºè</option>
                                                    <option value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥" ${currentStatus === '„Éà„Éº„É†„Çπ„Éà„Éº„É≥' ? 'selected' : ''}>„Éà„Éº„É†„Çπ„Éà„Éº„É≥</option>
                                                </select>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Ë£ÖÂÇôÁä∂Ê≥ÅÊâãÂãïÊõ¥Êñ∞
        function updateEquipmentStatus(position, slot, status) {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            if (!players[position]) {
                alert('„Éó„É¨„Ç§„É§„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // Ë£ÖÂÇôÊñπÈáù„ÇíÊõ¥Êñ∞
            if (!players[position].equipmentPolicy) {
                players[position].equipmentPolicy = {};
            }
            
            // ÁèæÂú®Ë£ÖÂÇô„ÇíÊõ¥Êñ∞
            if (!players[position].currentEquipment) {
                players[position].currentEquipment = {};
            }
            
            if (status === 'Êú™ÂèñÂæó') {
                // Êú™ÂèñÂæó„ÅÆÂ†¥Âêà„ÅØË£ÖÂÇô„Éá„Éº„Çø„ÇíÂâäÈô§
                delete players[position].currentEquipment[slot];
                players[position].equipmentPolicy[slot] = 'Èõ∂Âºè'; // „Éá„Éï„Ç©„É´„ÉàÊñπÈáù
            } else {
                // Èõ∂Âºè„Åæ„Åü„ÅØ„Éà„Éº„É†„Çπ„Éà„Éº„É≥„ÅÆÂ†¥Âêà
                players[position].equipmentPolicy[slot] = status;
                
                // „ÉÄ„Éü„ÉºË£ÖÂÇô„Éá„Éº„Çø„Çí‰ΩúÊàêÔºà„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´„ÅØ‰ªÆ„ÅÆÂÄ§Ôºâ
                const itemLevel = status === 'Èõ∂Âºè' ? 730 : 720;
                players[position].currentEquipment[slot] = {
                    name: `${status}Ë£ÖÂÇô`,
                    slot: slot,
                    itemLevel: itemLevel,
                    type: status === 'Èõ∂Âºè' ? 'savage' : 'tomestone'
                };
            }
            
            saveData(data);
            
            // Áä∂Ê≥ÅÊõ¥Êñ∞„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            const selectElement = document.getElementById(`equipment-${position}-${slot}`);
            if (selectElement) {
                selectElement.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    selectElement.style.backgroundColor = '';
                }, 1000);
            }
        }
        
        // ÈÄ±Âà•Áµ±Ë®àË°®Á§∫
        function showWeeklyStatistics() {
            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[2].classList.add('active');
            
            const data = getData();
            const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
            const players = data.players && data.players[currentRaidTier.id] || {};
            const content = document.getElementById('history-content');
            
            if (allocations.length === 0) {
                content.innerHTML = `
                    <div class="section">
                        <h3>ÈÄ±Âà•Áµ±Ë®à</h3>
                        <p>ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                    </div>
                `;
                return;
            }
            
            // Áµ±Ë®à„Éá„Éº„Çø„ÅÆË®àÁÆó
            const totalAllocations = allocations.length;
            const totalPlayers = Object.keys(players).length;
            const uniqueWeeks = getUniqueWeeksFromAllocations(allocations);
            
            // „Éó„É¨„Ç§„É§„ÉºÂà•„ÅÆÂèñÂæóÊï∞Áµ±Ë®à
            const playerStats = {};
            Object.values(players).forEach(player => {
                playerStats[player.name] = {
                    player: player,
                    count: 0,
                    items: []
                };
            });
            
            allocations.forEach(allocation => {
                if (allocation.winner && allocation.winner.name) {
                    const playerName = allocation.winner.name;
                    if (playerStats[playerName]) {
                        playerStats[playerName].count++;
                        playerStats[playerName].items.push(allocation.equipment);
                    }
                }
            });
            
            // Â±§Âà•Áµ±Ë®à
            const layerStats = {};
            [1, 2, 3, 4].forEach(layer => {
                layerStats[layer] = allocations.filter(a => a.layer === layer).length;
            });
            
            // „Éù„Ç∏„Ç∑„Éß„É≥Âõ∫ÂÆöÈ†ÜÂ∫è
            const positionOrder = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const slotOrder = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
            
            content.innerHTML = `
                <div class="section">
                    <h3>„Éó„É¨„Ç§„É§„ÉºÂà•ÂèñÂæóÊï∞</h3>
                    <div class="player-equipment-grid">
                        ${positionOrder.map(position => {
                            const stat = Object.values(playerStats).find(s => s.player.position === position);
                            if (!stat) return '';
                            
                            // Ë£ÖÂÇô„Çí„Çπ„É≠„ÉÉ„ÉàÈ†Ü„Åß„ÇΩ„Éº„Éà
                            const sortedItems = stat.items.sort((a, b) => {
                                const aIndex = slotOrder.indexOf(a.slot);
                                const bIndex = slotOrder.indexOf(b.slot);
                                return aIndex - bIndex;
                            });
                            
                            // ÂèñÂæóÊ∏à„Åø/Êú™ÂèñÂæó„ÅÆÊï¥ÁêÜ
                            const obtainedSlots = new Set(sortedItems.map(item => item.slot));
                            const obtainedItems = slotOrder.filter(slot => obtainedSlots.has(slot));
                            const notObtainedItems = slotOrder.filter(slot => !obtainedSlots.has(slot));
                            
                            return `
                                <div class="player-equipment-card">
                                    <h3>${stat.player.name} (${stat.player.position})</h3>
                                    <div class="stat-number" style="font-size: 1.8rem; margin: 10px 0;">${stat.count}</div>
                                    <div class="stat-description">„Ç¢„Ç§„ÉÜ„É†ÂèñÂæó</div>
                                    <div style="margin-top: 15px; font-size: 14px;">
                                        <div style="margin-bottom: 10px;">
                                            <strong>ÂèñÂæóÊ∏à„Åø:</strong><br>
                                            ${obtainedItems.length > 0 ? 
                                                obtainedItems.map(slot => `‚Ä¢ ${slot}`).join('<br>') : 
                                                '<span style="color: #888;">„Å™„Åó</span>'
                                            }
                                        </div>
                                        <div>
                                            <strong>Êú™ÂèñÂæó:</strong><br>
                                            ${notObtainedItems.length > 0 ? 
                                                notObtainedItems.map(slot => `‚Ä¢ ${slot}`).join('<br>') : 
                                                '<span style="color: #888;">„Å™„Åó</span>'
                                            }
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                </div>
            `;
        }
        
        // Web„Åã„Çâ„Ç¢„Ç§„ÉÜ„É†„Ç§„É≥„Éù„Éº„ÉàUIË°®Á§∫
        function showItemImportFromWeb(layer) {
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${layer}Â±§ - Web„Åã„Çâ„Ç¢„Ç§„ÉÜ„É†ÂèñÂæó</h1>
                
                <div class="import-navigation">
                    <button onclick="showLayerAllocation(${layer})">Â±§ÂàÜÈÖçÁîªÈù¢„Å´Êàª„Çã</button>
                    <button onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                </div>
                
                <div class="section">
                    <h2>FF14 Lodestone „Éá„Éº„Çø„Éô„Éº„Çπ„Åã„Çâ„Ç¢„Ç§„ÉÜ„É†ÂèñÂæó</h2>
                    <p>FF14ÂÖ¨Âºè„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Éö„Éº„Ç∏URL„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅ„Ç¢„Ç§„ÉÜ„É†ÊÉÖÂ†±„ÇíËá™ÂãïÂèñÂæó„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    
                    <div class="url-input-section">
                        <h3>ÊñπÊ≥ï1: ÂÄãÂà•„Ç¢„Ç§„ÉÜ„É†ÂèñÂæó</h3>
                        <input type="url" id="item-url" placeholder="https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/..." 
                               style="width: 100%; margin: 10px 0;">
                        <button onclick="importSingleItemFromWeb(${layer})">„Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó</button>
                        
                        <div id="single-item-result" style="margin-top: 20px;">
                            <!-- ÂèñÂæóÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                    
                    <div class="url-input-section" style="margin-top: 30px;">
                        <h3>ÊñπÊ≥ï2: Ë§áÊï∞„Ç¢„Ç§„ÉÜ„É†‰∏ÄÊã¨ÂèñÂæó</h3>
                        <p>Ë§áÊï∞„ÅÆURL„ÇíÊîπË°åÂå∫Âàá„Çä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                        <textarea id="multiple-urls" rows="8" placeholder="https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/...
https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/...
https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/..." 
                                  style="width: 100%; margin: 10px 0; resize: vertical;"></textarea>
                        <button onclick="importMultipleItemsFromWeb(${layer})">„Åô„Åπ„Å¶„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó</button>
                        
                        <div id="multiple-items-result" style="margin-top: 20px;">
                            <!-- ÂèñÂæóÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                    
                    <div class="preset-section" style="margin-top: 30px;">
                        <h3>ÊñπÊ≥ï3: Êó¢Áü•„ÅÆ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Ë£ÖÂÇô„Çª„ÉÉ„Éà</h3>
                        <p>‰∏ÄËà¨ÁöÑ„Å™„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆË£ÖÂÇô„Çª„ÉÉ„Éà„ÇíËá™ÂãïË®≠ÂÆöÔºö</p>
                        <select id="preset-raid-tier" style="margin: 10px;">
                            <option value="">„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÇíÈÅ∏Êäû</option>
                            <option value="savage_72">7.2Èõ∂ÂºèÔºàÂíé‰∫∫„Ç∑„É™„Éº„Ç∫Ôºâ</option>
                            <option value="savage_71">7.1Èõ∂ÂºèÔºàÂíé‰∫∫„Ç∑„É™„Éº„Ç∫Ôºâ</option>
                            <option value="savage_70">7.0Èõ∂ÂºèÔºà„Ç¢„É´„Ç´„Éá„Ç£„Ç¢„Ç∑„É™„Éº„Ç∫Ôºâ</option>
                        </select>
                        <button onclick="applyPresetRaidGear(${layer})">„Åì„ÅÆ„Çª„ÉÉ„Éà„ÇíÈÅ©Áî®</button>
                        
                        <div id="preset-result" style="margin-top: 20px;">
                            <!-- „Éó„É™„Çª„ÉÉ„ÉàÈÅ©Áî®ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                    
                    <div class="auto-search-section" style="margin-top: 30px;">
                        <h3>ÊñπÊ≥ï4: Ëá™Âãï„Éá„Éº„Çø„Éô„Éº„ÇπÊ§úÁ¥¢</h3>
                        <p>FF14„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÊúÄÈ´òIL„ÅÆË£ÖÂÇô„ÉÅ„Çß„Çπ„Éà„ÇíËá™ÂãïÊ§úÁ¥¢„Åó„Å¶ÂèñÂæóÔºö</p>
                        <div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin: 10px 0;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">üîç Ëá™ÂãïÊ§úÁ¥¢Ê©üËÉΩ</h4>
                            <p style="margin: 0; color: #856404;">ÊåáÂÆö„Åó„ÅüÈÉ®‰Ωç„ÅÆÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´Ë£ÖÂÇô„ÅåÂÖ•Êâã„Åß„Åç„Çã„ÉÅ„Çß„Çπ„ÉàÂêç„ÇíËá™Âãï„ÅßÊ§úÁ¥¢„ÉªÂèñÂæó„Åó„Åæ„Åô</p>
                        </div>
                        
                        <div class="search-controls" style="margin: 15px 0;">
                            <label style="font-size: 16px; font-weight: bold; margin-bottom: 15px; display: block;">Ê§úÁ¥¢„Åô„ÇãË£ÖÂÇôÈÉ®‰Ωç„ÇíÈÅ∏Êäû:</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 10px 0;">
                                <label><input type="checkbox" value="Ê≠¶Âô®" class="slot-checkbox"> Ê≠¶Âô®</label>
                                <label><input type="checkbox" value="È†≠" class="slot-checkbox"> È†≠</label>
                                <label><input type="checkbox" value="ËÉ¥" class="slot-checkbox"> ËÉ¥</label>
                                <label><input type="checkbox" value="Êâã" class="slot-checkbox"> Êâã</label>
                                <label><input type="checkbox" value="ËÑö" class="slot-checkbox"> ËÑö</label>
                                <label><input type="checkbox" value="Ë∂≥" class="slot-checkbox"> Ë∂≥</label>
                                <label><input type="checkbox" value="ËÄ≥" class="slot-checkbox"> ËÄ≥</label>
                                <label><input type="checkbox" value="È¶ñ" class="slot-checkbox"> È¶ñ</label>
                                <label><input type="checkbox" value="ËÖï" class="slot-checkbox"> ËÖï</label>
                                <label><input type="checkbox" value="Êåá" class="slot-checkbox"> Êåá</label>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <button onclick="selectAllSlots()" style="background-color: #28a745; margin-right: 10px;">ÂÖ®ÈÅ∏Êäû</button>
                                <button onclick="clearAllSlots()" style="background-color: #6c757d;">ÂÖ®Ëß£Èô§</button>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <label>ÊúÄÂ∞è„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´:</label>
                                <input type="number" id="min-item-level" value="720" min="1" max="999" style="margin-left: 10px; width: 80px;">
                                <small style="color: #666; margin-left: 10px;">‚Äª„ÉÅ„Çß„Çπ„Éà„Åã„ÇâÂÖ•Êâã„Åß„Åç„ÇãË£ÖÂÇô„ÅÆÊúÄÂ∞èIL</small>
                            </div>
                        </div>
                        
                        <button onclick="autoSearchHighestILChests(${layer})" class="auto-search-btn" style="background-color: #17a2b8 !important; font-weight: bold;">
                            üîç Ëá™ÂãïÊ§úÁ¥¢„Åó„Å¶ÂèçÊò†
                        </button>
                        
                        <div id="auto-search-result" style="margin-top: 20px;">
                            <!-- Ëá™ÂãïÊ§úÁ¥¢ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                </div>
                
                <div class="imported-items-section">
                    <h2>ÂèñÂæóÊ∏à„Åø„Ç¢„Ç§„ÉÜ„É†</h2>
                    <div id="imported-items-list">
                        <!-- ÂèñÂæó„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    
                    <div class="import-actions" style="text-align: center; margin-top: 20px;">
                        <button onclick="applyImportedItems(${layer})" class="confirm-btn" disabled id="apply-btn">
                            „Åì„Çå„Çâ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí${layer}Â±§„Éâ„É≠„ÉÉ„Éó„Å®„Åó„Å¶ÈÅ©Áî®
                        </button>
                        <button onclick="clearImportedItems()" style="background-color: #e74c3c !important;">
                            ÂèñÂæó„Ç¢„Ç§„ÉÜ„É†„Çí„ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>
            `;
            
            // „Ç§„É≥„Éù„Éº„ÉàÁî®CSS
            const style = document.createElement('style');
            style.textContent = `
                .import-navigation {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #e9ecef;
                }
                .url-input-section {
                    background-color: #f8f9fa;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #e9ecef;
                    margin: 15px 0;
                }
                .url-input-section h3 {
                    margin-top: 0;
                    color: #2c3e50;
                }
                .url-input-section input, .url-input-section textarea {
                    padding: 12px;
                    border: 1px solid #ced4da;
                    border-radius: 8px;
                    font-size: 14px;
                    box-sizing: border-box;
                    background-color: white;
                }
                .preset-section {
                    background-color: #e3f2fd;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #bbdefb;
                }
                .auto-search-section {
                    background-color: #e8f5e8;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #c8e6c9;
                }
                .auto-search-section h3 {
                    color: #2e7d32;
                    margin-top: 0;
                }
                .search-controls {
                    background-color: rgba(255,255,255,0.8);
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #a5d6a7;
                }
                .search-controls label {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    font-weight: 500;
                    color: #2e7d32;
                }
                .search-controls input[type="checkbox"] {
                    margin: 0;
                    width: auto;
                }
                .auto-search-btn {
                    padding: 15px 25px !important;
                    font-size: 16px !important;
                    border-radius: 10px !important;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
                    transition: all 0.3s ease !important;
                }
                .auto-search-btn:hover {
                    transform: translateY(-2px) !important;
                    box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
                }
                .imported-items-section {
                    background-color: #f1f8e9;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #c8e6c9;
                    margin-top: 30px;
                }
                .imported-item-card {
                    background-color: white;
                    padding: 15px;
                    margin: 10px 0;
                    border-radius: 8px;
                    border: 1px solid #ddd;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .imported-item-info h4 {
                    margin: 0 0 5px 0;
                    color: #2c3e50;
                }
                .imported-item-info p {
                    margin: 0;
                    color: #666;
                    font-size: 14px;
                }
                .loading-spinner {
                    display: inline-block;
                    width: 20px;
                    height: 20px;
                    border: 3px solid rgba(0,0,0,.1);
                    border-radius: 50%;
                    border-top-color: #3498db;
                    animation: spin 1s ease-in-out infinite;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
                .import-actions {
                    padding-top: 20px;
                    border-top: 2px solid #c8e6c9;
                }
            `;
            if (!document.getElementById('import-styles')) {
                style.id = 'import-styles';
                document.head.appendChild(style);
            }
            
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíÂàùÊúüÂåñ
            if (!window.importedItems) {
                window.importedItems = [];
            }
            
            updateImportedItemsList();
        }
        
        // Âçò‰∏Ä„Ç¢„Ç§„ÉÜ„É†„ÅÆWeb„Ç§„É≥„Éù„Éº„Éà
        async function importSingleItemFromWeb(layer) {
            const urlInput = document.getElementById('item-url');
            const resultDiv = document.getElementById('single-item-result');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            if (!url.includes('finalfantasyxiv.com/lodestone/playguide/db/item/')) {
                alert('FF14 Lodestone „Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„Ç¢„Ç§„ÉÜ„É†URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading-spinner"></div> „Ç¢„Ç§„ÉÜ„É†ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...';
            
            try {
                // WebFetchÊ©üËÉΩ„ÅØÂÆüÈöõ„ÅÆÁí∞Â¢É„Åß„ÅÆ„ÅøÂãï‰Ωú„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ„ÉÄ„Éü„Éº„Éá„Éº„Çø„ÇíÁîüÊàê
                const itemData = await simulateWebFetch(url);
                
                if (itemData) {
                    // „Ç∞„É≠„Éº„Éê„É´„ÅÆ„Ç§„É≥„Éù„Éº„Éà„É™„Çπ„Éà„Å´ËøΩÂä†
                    window.importedItems = window.importedItems || [];
                    window.importedItems.push({
                        ...itemData,
                        layer: layer,
                        source: 'web',
                        url: url
                    });
                    
                    resultDiv.innerHTML = `
                        <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <h4 style="color: #155724; margin: 0 0 10px 0;">‚úÖ „Ç¢„Ç§„ÉÜ„É†ÂèñÂæóÊàêÂäü</h4>
                            <p><strong>ÂêçÂâç:</strong> ${itemData.name}</p>
                            <p><strong>ÈÉ®‰Ωç:</strong> ${itemData.slot}</p>
                            <p><strong>„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´:</strong> ${itemData.itemLevel}</p>
                            <p><strong>„Çø„Ç§„Éó:</strong> ${itemData.type}</p>
                        </div>
                    `;
                    
                    updateImportedItemsList();
                    urlInput.value = '';
                } else {
                    throw new Error('„Ç¢„Ç§„ÉÜ„É†ÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">‚ùå ÂèñÂæóÂ§±Êïó</h4>
                        <p>„Ç¢„Ç§„ÉÜ„É†ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</p>
                        <p>URL„ÅåÊ≠£„Åó„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    </div>
                `;
            }
        }
        
        // Ë§áÊï∞„Ç¢„Ç§„ÉÜ„É†„ÅÆ‰∏ÄÊã¨Web„Ç§„É≥„Éù„Éº„Éà
        async function importMultipleItemsFromWeb(layer) {
            const textArea = document.getElementById('multiple-urls');
            const resultDiv = document.getElementById('multiple-items-result');
            const urls = textArea.value.trim().split('\n').filter(url => url.trim());
            
            if (urls.length === 0) {
                alert('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            resultDiv.innerHTML = `<div class="loading-spinner"></div> ${urls.length}ÂÄã„ÅÆ„Ç¢„Ç§„ÉÜ„É†ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...`;
            
            const results = [];
            const errors = [];
            
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i].trim();
                
                if (!url.includes('finalfantasyxiv.com/lodestone/playguide/db/item/')) {
                    errors.push(`URL ${i + 1}: ÁÑ°Âäπ„Å™Lodestone URL`);
                    continue;
                }
                
                try {
                    const itemData = await simulateWebFetch(url);
                    if (itemData) {
                        results.push({
                            ...itemData,
                            layer: layer,
                            source: 'web',
                            url: url
                        });
                    } else {
                        errors.push(`URL ${i + 1}: „Éá„Éº„ÇøÂèñÂæóÂ§±Êïó`);
                    }
                } catch (error) {
                    errors.push(`URL ${i + 1}: ${error.message}`);
                }
                
                // „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫„ÅÆÊõ¥Êñ∞
                resultDiv.innerHTML = `<div class="loading-spinner"></div> ${i + 1}/${urls.length} ÂÆå‰∫Ü...`;
                
                // API„É¨„Éº„ÉàÂà∂Èôê„ÇíËÄÉÊÖÆ„Åó„Å¶Â∞ë„ÅóÂæÖÊ©ü
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // ÊàêÂäü„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„Çí„Ç∞„É≠„Éº„Éê„É´„É™„Çπ„Éà„Å´ËøΩÂä†
            window.importedItems = window.importedItems || [];
            window.importedItems.push(...results);
            
            // ÁµêÊûúË°®Á§∫
            let resultHtml = '';
            
            if (results.length > 0) {
                resultHtml += `
                    <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb; margin-bottom: 15px;">
                        <h4 style="color: #155724; margin: 0 0 10px 0;">‚úÖ ${results.length}ÂÄã„ÅÆ„Ç¢„Ç§„ÉÜ„É†ÂèñÂæóÊàêÂäü</h4>
                        ${results.map(item => `<p>‚Ä¢ ${item.name} (${item.slot})</p>`).join('')}
                    </div>
                `;
            }
            
            if (errors.length > 0) {
                resultHtml += `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">‚ùå ${errors.length}ÂÄã„ÅÆ„Ç®„É©„Éº</h4>
                        ${errors.map(error => `<p>‚Ä¢ ${error}</p>`).join('')}
                    </div>
                `;
            }
            
            resultDiv.innerHTML = resultHtml;
            updateImportedItemsList();
            textArea.value = '';
        }
        
        // WebFetch„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÊú¨Áâ©„ÅÆWebFetchÊ©üËÉΩ„Çí‰ΩøÁî®Ôºâ
        async function simulateWebFetch(url) {
            // URL„Åã„Çâ„Ç¢„Ç§„ÉÜ„É†ID„ÇíÊäΩÂá∫
            const itemIdMatch = url.match(/\/item\/([a-f0-9]+)\//);
            if (!itemIdMatch) {
                throw new Error('URL„Åã„Çâ„Ç¢„Ç§„ÉÜ„É†ID„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì');
            }
            
            const itemId = itemIdMatch[1];
            
            // „ÉÄ„Éü„Éº„Éá„Éº„ÇøÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ WebFetch „ÉÑ„Éº„É´„Çí‰ΩøÁî®Ôºâ
            const dummyItems = {
                '545b8977a73': { name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„ÇΩ„Éº„Éâ', slot: 'Ê≠¶Âô®', itemLevel: 735, type: 'weapon' },
                '12345abcdef': { name: 'ËÄ≥', slot: 'ËÄ≥', itemLevel: 730, type: 'accessory' },
                '67890fedcba': { name: 'ËÉ¥', slot: 'ËÉ¥', itemLevel: 730, type: 'armor' },
                'abc123def45': { name: 'Ê≠¶Âô®', slot: 'Ê≠¶Âô®', itemLevel: 735, type: 'weapon_box' }
            };
            
            // „ÉÄ„Éü„Éº„Ç¢„Ç§„ÉÜ„É†„Åæ„Åü„ÅØ„É©„É≥„ÉÄ„É†ÁîüÊàê
            if (dummyItems[itemId]) {
                return dummyItems[itemId];
            } else {
                // „É©„É≥„ÉÄ„É†„Å™„Ç¢„Ç§„ÉÜ„É†„ÇíÁîüÊàê
                const slots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
                const types = ['weapon', 'armor', 'accessory'];
                const randomSlot = slots[Math.floor(Math.random() * slots.length)];
                
                return {
                    name: `ÂèñÂæó„Ç¢„Ç§„ÉÜ„É†${itemId.substr(0, 6)}`,
                    slot: randomSlot,
                    itemLevel: 720 + Math.floor(Math.random() * 15),
                    type: randomSlot === 'Ê≠¶Âô®' ? 'weapon' : (randomSlot === 'ËÄ≥' || randomSlot === 'È¶ñ' || randomSlot === 'ËÖï' || randomSlot === 'Êåá' ? 'accessory' : 'armor')
                };
            }
        }
        
        // „Éó„É™„Çª„ÉÉ„Éà„É¨„Ç§„ÉâË£ÖÂÇô„ÅÆÈÅ©Áî®
        function applyPresetRaidGear(layer) {
            const selectElement = document.getElementById('preset-raid-tier');
            const resultDiv = document.getElementById('preset-result');
            const selectedTier = selectElement.value;
            
            if (!selectedTier) {
                alert('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const presetGear = {
                'savage_72': {
                    1: [
                        { name: 'ËÄ≥', slot: 'ËÄ≥', itemLevel: 730, type: 'accessory' },
                        { name: 'È¶ñ', slot: 'È¶ñ', itemLevel: 730, type: 'accessory' },
                        { name: 'ËÖï', slot: 'ËÖï', itemLevel: 730, type: 'accessory' },
                        { name: 'Êåá', slot: 'Êåá', itemLevel: 730, type: 'accessory' }
                    ],
                    2: [
                        { name: 'È†≠', slot: 'È†≠', itemLevel: 730, type: 'armor' },
                        { name: 'Êâã', slot: 'Êâã', itemLevel: 730, type: 'armor' },
                        { name: 'Ë∂≥', slot: 'Ë∂≥', itemLevel: 730, type: 'armor' },
                        { name: 'Ê≠¶Âô®Áü≥', slot: 'Ê≠¶Âô®Áü≥', itemLevel: 1, type: 'material' },
                        { name: 'Á°¨ÂåñËñ¨', slot: 'Á°¨ÂåñËñ¨', itemLevel: 1, type: 'material' }
                    ],
                    3: [
                        { name: 'ËÉ¥', slot: 'ËÉ¥', itemLevel: 730, type: 'armor' },
                        { name: 'ËÑö', slot: 'ËÑö', itemLevel: 730, type: 'armor' },
                        { name: 'Âº∑ÂåñËñ¨', slot: 'Âº∑ÂåñËñ¨', itemLevel: 1, type: 'material' },
                        { name: 'Âº∑ÂåñÁπäÁ∂≠', slot: 'Âº∑ÂåñÁπäÁ∂≠', itemLevel: 1, type: 'material' }
                    ],
                    4: [
                        { name: 'Ê≠¶Âô®-„Ç¶„Çß„Éù„É≥„ÉÅ„Çß„Çπ„Éà', slot: 'Ê≠¶Âô®', itemLevel: 735, type: 'weapon_box' },
                        { name: '„Éû„Ç¶„É≥„Éà', slot: '„Éû„Ç¶„É≥„Éà', itemLevel: 1, type: 'mount' }
                    ]
                }
            };
            
            const tierData = presetGear[selectedTier];
            if (tierData && tierData[layer]) {
                window.importedItems = window.importedItems || [];
                const newItems = tierData[layer].map(item => ({
                    ...item,
                    layer: layer,
                    source: 'preset'
                }));
                
                window.importedItems.push(...newItems);
                
                resultDiv.innerHTML = `
                    <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                        <h4 style="color: #155724; margin: 0 0 10px 0;">‚úÖ „Éó„É™„Çª„ÉÉ„ÉàÈÅ©Áî®ÂÆå‰∫Ü</h4>
                        <p>${newItems.length}ÂÄã„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ</p>
                    </div>
                `;
                
                updateImportedItemsList();
            } else {
                resultDiv.innerHTML = `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">‚ùå Ë©≤ÂΩì„Å™„Åó</h4>
                        <p>ÈÅ∏Êäû„Åï„Çå„Åü„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆ${layer}Â±§„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                    </div>
                `;
            }
        }
        
        // „Ç§„É≥„Éù„Éº„Éà„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà„ÅÆÊõ¥Êñ∞
        function updateImportedItemsList() {
            const listDiv = document.getElementById('imported-items-list');
            const applyBtn = document.getElementById('apply-btn');
            
            if (!window.importedItems || window.importedItems.length === 0) {
                listDiv.innerHTML = '<p>„Åæ„Å†„Ç¢„Ç§„ÉÜ„É†„ÅåÂèñÂæó„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>';
                if (applyBtn) applyBtn.disabled = true;
                return;
            }
            
            listDiv.innerHTML = window.importedItems.map((item, index) => `
                <div class="imported-item-card">
                    <div class="imported-item-info">
                        <h4>${item.name}</h4>
                        <p>ÈÉ®‰Ωç: ${item.slot} | IL: ${item.itemLevel} | „ÇΩ„Éº„Çπ: ${item.source}</p>
                    </div>
                    <button onclick="removeImportedItem(${index})" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px;">
                        ÂâäÈô§
                    </button>
                </div>
            `).join('');
            
            if (applyBtn) applyBtn.disabled = false;
        }
        
        // „Ç§„É≥„Éù„Éº„Éà„Ç¢„Ç§„ÉÜ„É†„ÅÆÂâäÈô§
        function removeImportedItem(index) {
            if (window.importedItems && window.importedItems[index]) {
                window.importedItems.splice(index, 1);
                updateImportedItemsList();
            }
        }
        
        // „Ç§„É≥„Éù„Éº„Éà„Ç¢„Ç§„ÉÜ„É†„ÅÆ„ÇØ„É™„Ç¢
        function clearImportedItems() {
            if (confirm('ÂèñÂæó„Åó„Åü„Åô„Åπ„Å¶„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                window.importedItems = [];
                updateImportedItemsList();
            }
        }
        
        // Ëá™Âãï„Éá„Éº„Çø„Éô„Éº„ÇπÊ§úÁ¥¢„ÅßÊúÄÈ´òIL„ÉÅ„Çß„Çπ„Éà„ÇíÂèñÂæó
        async function autoSearchHighestILChests(layer) {
            const resultDiv = document.getElementById('auto-search-result');
            const selectedSlots = Array.from(document.querySelectorAll('.slot-checkbox:checked'))
                .map(cb => cb.value);
            const minItemLevel = parseInt(document.getElementById('min-item-level').value) || 720;
            
            if (selectedSlots.length === 0) {
                alert('Ê§úÁ¥¢„Åô„ÇãË£ÖÂÇôÈÉ®‰Ωç„Çí1„Å§‰ª•‰∏äÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            
            resultDiv.innerHTML = `
                <div class="loading-spinner"></div> 
                ${selectedSlots.length}ÂÄã„ÅÆÈÉ®‰Ωç„Å´„Å§„ÅÑ„Å¶ÊúÄÈ´òIL„ÉÅ„Çß„Çπ„Éà„ÇíÊ§úÁ¥¢‰∏≠...
            `;
            
            try {
                const searchResults = [];
                
                for (let i = 0; i < selectedSlots.length; i++) {
                    const slot = selectedSlots[i];
                    
                    // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞
                    resultDiv.innerHTML = `
                        <div class="loading-spinner"></div> 
                        ${slot}Ë£ÖÂÇô„ÅÆ„ÉÅ„Çß„Çπ„Éà„ÇíÊ§úÁ¥¢‰∏≠... (${i + 1}/${selectedSlots.length})
                    `;
                    
                    try {
                        const chestData = await searchHighestILChestForSlot(slot, minItemLevel);
                        if (chestData) {
                            // URL„ÇíËøΩÂä†
                            chestData.sourceUrl = chestData.url || `Ê§úÁ¥¢„ÇØ„Ç®„É™: ${slot} „ÉÅ„Çß„Çπ„Éà`;
                            searchResults.push(chestData);
                        }
                    } catch (error) {
                        // „Ç®„É©„Éº„ÅÆË©≥Á¥∞„ÇíË°®Á§∫„Å´Âê´„ÇÅ„Çã
                        searchResults.push({
                            name: `${slot}„ÉÅ„Çß„Çπ„ÉàÊ§úÁ¥¢„Ç®„É©„Éº`,
                            slot: slot,
                            itemLevel: 0,
                            maxItemLevel: 0,
                            type: 'error',
                            description: `Ê§úÁ¥¢„Ç®„É©„Éº: ${error.message}`,
                            sourceUrl: `„Ç®„É©„ÉºË©≥Á¥∞: ${error.message}`
                        });
                    }
                    
                    // Áü≠„ÅÑÂæÖÊ©üÊôÇÈñì
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                
                if (searchResults.length > 0) {
                    // ÊàêÂäü„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„Çí„Ç§„É≥„Éù„Éº„Éà„É™„Çπ„Éà„Å´ËøΩÂä†
                    window.importedItems = window.importedItems || [];
                    window.importedItems.push(...searchResults);
                    
                    resultDiv.innerHTML = `
                        <div style="background-color: #d4edda; padding: 20px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <h4 style="color: #155724; margin: 0 0 15px 0;">‚úÖ Ëá™ÂãïÊ§úÁ¥¢ÂÆå‰∫Ü</h4>
                            <p style="margin: 0 0 15px 0;"><strong>${searchResults.length}ÂÄã„ÅÆ„ÉÅ„Çß„Çπ„Éà</strong>„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü:</p>
                            ${searchResults.map(item => `
                                <div style="background-color: rgba(255,255,255,0.8); padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #28a745;">
                                    <strong style="color: #155724;">${item.name}</strong><br>
                                    <span style="color: #666;">ÈÉ®‰Ωç: ${item.slot} | ÂÖ•ÊâãÂèØËÉΩË£ÖÂÇôIL: ${item.maxItemLevel}</span><br>
                                    <small style="color: #6c757d;">${item.description}</small><br>
                                    ${item.sourceUrl ? `<small style="color: #0066cc;"><strong>ÂèÇÁÖßURL:</strong> <a href="${item.sourceUrl}" target="_blank" style="color: #0066cc;">${item.sourceUrl}</a></small>` : ''}
                                </div>
                            `).join('')}
                            <p style="margin: 15px 0 0 0; color: #155724;">
                                ‚¨áÔ∏è ‰∏ã„ÅÆ„ÄåÂèñÂæóÊ∏à„Åø„Ç¢„Ç§„ÉÜ„É†„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÁ¢∫Ë™ç„ÉªÈÅ©Áî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                            </p>
                        </div>
                    `;
                    
                    updateImportedItemsList();
                } else {
                    resultDiv.innerHTML = `
                        <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                            <h4 style="color: #721c24; margin: 0 0 10px 0;">‚ùå Ê§úÁ¥¢ÁµêÊûú„Å™„Åó</h4>
                            <p style="margin: 0;">ÊåáÂÆöÊù°‰ª∂„Å´Ë©≤ÂΩì„Åô„Çã„ÉÅ„Çß„Çπ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
                            <p style="margin: 5px 0 0 0;">ÊúÄÂ∞è„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´„Çí‰∏ã„Åí„Å¶ÂÜçÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">‚ùå Ê§úÁ¥¢„Ç®„É©„Éº</h4>
                        <p style="margin: 0;">Ëá™ÂãïÊ§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}</p>
                        <p style="margin: 5px 0 0 0;">„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´„ÅßË©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    </div>
                `;
            }
        }
        
        // ÊåáÂÆöÈÉ®‰Ωç„ÅÆÊúÄÈ´òIL„ÉÅ„Çß„Çπ„Éà„ÇíÊ§úÁ¥¢ÔºàÂÆüÈöõ„ÅÆFF14„Éá„Éº„Çø„Éô„Éº„Çπ„Çí‰ΩøÁî®Ôºâ
        async function searchHighestILChestForSlot(slot, minItemLevel) {
            
            try {
                // FF14 Lodestone„Éá„Éº„Çø„Éô„Éº„Çπ„ÅßÊ§úÁ¥¢
                const searchResults = await searchFF14Database(slot, minItemLevel);
                
                if (searchResults && searchResults.name) {
                    return {
                        ...searchResults,
                        slot: slot,
                        layer: null,
                        source: 'ff14_database',
                        searchTimestamp: new Date().toISOString()
                    };
                } else {
                    return null;
                }
                
            } catch (error) {
                throw error;
            }
        }
        
        // FF14„Éá„Éº„Çø„Éô„Éº„ÇπÊ§úÁ¥¢„ÅÆÂÆüË£Ö
        async function searchFF14Database(slot, minItemLevel) {
            
            try {
                // ÈÉ®‰ΩçÂà•„ÅÆ„Ç´„ÉÜ„Ç¥„É™ID„Éû„ÉÉ„Éî„É≥„Ç∞
                const categoryMapping = {
                    'Ê≠¶Âô®': { category2: 1, category3: null },  // Ê≠¶Âô®
                    'È†≠': { category2: 3, category3: 34 },      // Èò≤ÂÖ∑‚ÜíÈ†≠Èò≤ÂÖ∑
                    'ËÉ¥': { category2: 3, category3: 35 },      // Èò≤ÂÖ∑‚ÜíËÉ¥Èò≤ÂÖ∑
                    'Êâã': { category2: 3, category3: 37 },      // Èò≤ÂÖ∑‚ÜíÊâãÈò≤ÂÖ∑
                    'ËÑö': { category2: 3, category3: 36 },      // Èò≤ÂÖ∑‚ÜíËÑöÈò≤ÂÖ∑
                    'Ë∂≥': { category2: 3, category3: 38 },      // Èò≤ÂÖ∑‚ÜíË∂≥Èò≤ÂÖ∑
                    'ËÄ≥': { category2: 4, category3: 40 },      // „Ç¢„ÇØ„Çª„Çµ„É™‚ÜíËÄ≥È£æ„Çä
                    'È¶ñ': { category2: 4, category3: 41 },      // „Ç¢„ÇØ„Çª„Çµ„É™‚ÜíÈ¶ñÈ£æ„Çä
                    'ËÖï': { category2: 4, category3: 42 },      // „Ç¢„ÇØ„Çª„Çµ„É™‚ÜíËÖïËº™
                    'Êåá': { category2: 4, category3: 43 }       // „Ç¢„ÇØ„Çª„Çµ„É™‚ÜíÊåáËº™
                };
                
                const category = categoryMapping[slot];
                if (!category) {
                    return await searchAlternativeFF14Database(slot, minItemLevel);
                }
                
                // Step 1: ÁâπÂÆö„ÅÆURL„Çí‰ΩøÁî®„Åó„Å¶„ÉÜ„Çπ„ÉàÔºàÊ≠¶Âô®„ÅÆÂ†¥ÂêàÔºâ
                if (slot === 'Ê≠¶Âô®') {
                    const specificUrl = 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/2ec7d8cfb2d/';
                    
                    const specificResult = await WebFetch(specificUrl, `
                        „Åì„ÅÆFF14„Ç¢„Ç§„ÉÜ„É†„Éö„Éº„Ç∏„Åã„ÇâÊ≠£Á¢∫„Å™ÊÉÖÂ†±„ÇíÊäΩÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                        
                        „Éö„Éº„Ç∏„Åã„Çâ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
                        1. „Ç¢„Ç§„ÉÜ„É†ÂêçÔºàÂÆåÂÖ®„Å™ÂêçÂâçÔºâ
                        2. „Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´Ôºà„ÄêILvÊï∞ÂÄ§„ÄëÂΩ¢Âºè„ÅßË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÔºâ
                        3. „Ç¢„Ç§„ÉÜ„É†„ÅÆÁ®ÆÈ°ûÔºà„ÉÅ„Çß„Çπ„Éà„Åã„Å©„ÅÜ„ÅãÔºâ
                        
                        JSONÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
                        {
                            "name": "Ê≠£Á¢∫„Å™„Ç¢„Ç§„ÉÜ„É†ÂêçÔºà‰æãÔºö„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Ç¶„Çß„Éù„É≥„ÉÅ„Çß„Çπ„Éà„ÄêILv765„ÄëÔºâ",
                            "itemLevel": „Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                            "maxItemLevel": „Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                            "type": "weapon_chest",
                            "url": "${specificUrl}",
                            "description": "FF14„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂèñÂæó",
                            "source": "Lodestone"
                        }
                    `);
                    
                    
                    if (specificResult && specificResult.trim() !== 'null') {
                        try {
                            const parsed = JSON.parse(specificResult);
                            if (parsed.name) {
                                return parsed;
                            }
                        } catch (e) {
                        }
                    }
                }
                
                // Step 2: „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„Çí‰ΩøÁî®„Åó„ÅüÊ§úÁ¥¢
                let searchUrl;
                if (category.category3) {
                    searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?category2=${category.category2}&category3=${category.category3}`;
                } else {
                    searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?category2=${category.category2}`;
                }
                
                
                const searchResult = await WebFetch(searchUrl, `
                    „Åì„ÅÆFF14„Ç¢„Ç§„ÉÜ„É†Ê§úÁ¥¢ÁµêÊûú„Éö„Éº„Ç∏Ôºà${slot}Ë£ÖÂÇô„Ç´„ÉÜ„Ç¥„É™Ôºâ„ÇíËß£Êûê„Åó„Å¶„ÄÅÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´„ÅÆ„ÉÅ„Çß„Çπ„Éà„ÇíË¶ã„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    
                    Êé¢„Åó„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ:
                    - ${slot}Ë£ÖÂÇô„ÅåÂÖ•Êâã„Åß„Åç„Çã„ÉÅ„Çß„Çπ„Éà
                    - „Éö„Éº„Ç∏„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„Ç¢„Ç§„ÉÜ„É†„ÅÆ‰∏≠„ÅßÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´„ÅÆ„ÇÇ„ÅÆ
                    - „Äå‚óã‚óã„ÉÅ„Çß„Çπ„Éà„Äç„Äå‚óã‚óã„Ç≥„Éï„Ç°„Éº„Äç„Å™„Å©„ÅÆÂêçÂâç„ÅÆ„Ç¢„Ç§„ÉÜ„É†
                    - „Ç¢„Ç§„ÉÜ„É†Âêç„Å´„ÄêILvÊï∞ÂÄ§„Äë„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂΩ¢Âºè„ÇíÂÑ™ÂÖà
                    - Êû∂Á©∫„ÅÆÂêçÂâç„ÅØ‰Ωú„Çâ„Åö„ÄÅÂÆüÈöõ„Å´„Éö„Éº„Ç∏„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„Ç¢„Ç§„ÉÜ„É†Âêç„ÅÆ„Åø„Çí‰ΩøÁî®
                    
                    Ê§úÁ¥¢ÁµêÊûú„Åã„ÇâÊúÄ„ÇÇÈ´ò„ÅÑ„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´„ÅÆ„ÉÅ„Çß„Çπ„Éà„Çí1„Å§ÈÅ∏„Çì„Åß„ÄÅ‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
                    {
                        "name": "ÂÆüÈöõ„ÅÆ„Éö„Éº„Ç∏„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„ÉÅ„Çß„Çπ„Éà„ÅÆÊ≠£Á¢∫„Å™ÂêçÂâçÔºà„ÄêILvÊï∞ÂÄ§„Äë„ÇÇÂê´„ÇÄÔºâ",
                        "itemLevel": „ÉÅ„Çß„Çπ„ÉàËá™‰Ωì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                        "maxItemLevel": „Åì„ÅÆ„ÉÅ„Çß„Çπ„Éà„Åã„ÇâÂÖ•Êâã„Åß„Åç„ÇãË£ÖÂÇô„ÅÆÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                        "type": "weapon_chest/armor_chest/accessory_chest",
                        "url": "„Åì„ÅÆ„ÉÅ„Çß„Çπ„Éà„ÅÆË©≥Á¥∞„Éö„Éº„Ç∏URLÔºàÂÆüÈöõ„Å´„Éö„Éº„Ç∏„Å´Â≠òÂú®„Åô„ÇãURLÔºâ",
                        "description": "„ÉÅ„Çß„Çπ„Éà„ÅÆË™¨Êòé",
                        "source": "Lodestone"
                    }
                    
                    Ë©≤ÂΩì„Åô„Çã„ÉÅ„Çß„Çπ„Éà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ null „ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                `);
                
                
                // JSON„Éë„Éº„Çπ
                if (searchResult && searchResult.trim() !== 'null') {
                    try {
                        const parsed = JSON.parse(searchResult);
                        
                        // Ë©≥Á¥∞„Éö„Éº„Ç∏„Åã„ÇâËøΩÂä†ÊÉÖÂ†±„ÇíÂèñÂæó
                        if (parsed.url && parsed.url !== searchUrl) {
                            const detailResult = await getChestDetailInfo(parsed.url, slot);
                            if (detailResult) {
                                // Ë©≥Á¥∞ÊÉÖÂ†±„Å®„Éû„Éº„Ç∏
                                return {
                                    ...parsed,
                                    ...detailResult,
                                    url: parsed.url  // ÂÖÉ„ÅÆURL„Çí‰øùÊåÅ
                                };
                            }
                        }
                        
                        // ÊúÄÂ∞è„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´Êù°‰ª∂„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                        if (parsed.maxItemLevel && parsed.maxItemLevel >= minItemLevel) {
                            return parsed;
                        } else {
                            return null;
                        }
                    } catch (parseError) {
                        
                        // JSONËß£Êûê„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÄÅ‰ª£ÊõøÊ§úÁ¥¢„ÇíË©¶„Åô
                        return await searchAlternativeFF14Database(slot, minItemLevel);
                    }
                } else {
                    return await searchAlternativeFF14Database(slot, minItemLevel);
                }
                
            } catch (error) {
                
                // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÄÅ‰ª£ÊõøÊ§úÁ¥¢„ÇíË©¶„Åô
                return await searchAlternativeFF14Database(slot, minItemLevel);
            }
        }
        
        // „ÉÅ„Çß„Çπ„ÉàË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
        async function getChestDetailInfo(chestUrl, slot) {
            try {
                
                const detailResult = await WebFetch(chestUrl, `
                    „Åì„ÅÆFF14„ÉÅ„Çß„Çπ„Éà„Ç¢„Ç§„ÉÜ„É†„Éö„Éº„Ç∏„Åã„Çâ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÇíÊ≠£Á¢∫„Å´ÊäΩÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
                    
                    1. „Ç¢„Ç§„ÉÜ„É†ÂêçÔºàÂÆåÂÖ®„Å™ÂêçÂâçÔºâ
                    2. „Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´
                    3. „Åì„ÅÆ„ÉÅ„Çß„Çπ„Éà„Åã„ÇâÂÖ•Êâã„Åß„Åç„ÇãË£ÖÂÇô„ÅÆÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´
                    4. Ë£ÖÂÇôÈÉ®‰ΩçÔºà${slot}„Å´Èñ¢ÈÄ£„Åô„Çã„ÅãÁ¢∫Ë™çÔºâ
                    5. ÂÖ•ÊâãÊñπÊ≥ï„ÇÑ„ÇΩ„Éº„ÇπÊÉÖÂ†±
                    
                    JSONÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
                    {
                        "name": "Ê≠£Á¢∫„Å™„Ç¢„Ç§„ÉÜ„É†Âêç",
                        "itemLevel": „Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                        "maxItemLevel": ÂÖ•ÊâãÂèØËÉΩË£ÖÂÇô„ÅÆÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                        "equipmentSlot": "Ë£ÖÂÇôÈÉ®‰Ωç",
                        "source": "ÂÖ•ÊâãÊñπÊ≥ï„Éª„ÇΩ„Éº„Çπ",
                        "description": "Ë©≥Á¥∞Ë™¨Êòé"
                    }
                `);
                
                const parsed = JSON.parse(detailResult);
                return parsed;
                
            } catch (error) {
                return null;
            }
        }
        
        // ‰ª£ÊõøÊ§úÁ¥¢ÊñπÊ≥ï
        async function searchAlternativeFF14Database(slot, minItemLevel) {
            
            try {
                // „Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™Ê§úÁ¥¢„ÇØ„Ç®„É™„ÅßÂÜçË©¶Ë°å
                const alternativeQueries = [
                    `${slot}„ÉÅ„Çß„Çπ„Éà`,
                    `${slot}„Ç≥„Éï„Ç°„Éº`,
                    `${slot}„Ç¶„Çß„Éù„É≥„ÉÅ„Çß„Çπ„Éà`,
                    `${slot}„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà`
                ];
                
                for (const query of alternativeQueries) {
                    
                    const searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?q=${encodeURIComponent(query)}`;
                    
                    try {
                        const result = await WebFetch(searchUrl, `
                            „Åì„ÅÆÊ§úÁ¥¢ÁµêÊûú„Åã„Çâ„Äå${slot}„ÄçË£ÖÂÇô„ÅåÂÖ•Êâã„Åß„Åç„Çã„ÉÅ„Çß„Çπ„Éà„ÇíÊé¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            „Äå„ÉÅ„Çß„Çπ„Éà„Äç„Äå„Ç≥„Éï„Ç°„Éº„Äç„Äå„ÇÆ„Ç¢„Äç„Å™„Å©„ÅÆÂêçÂâç„ÅåÂê´„Åæ„Çå„Çã„Ç¢„Ç§„ÉÜ„É†„ÇíÂÑ™ÂÖàÁöÑ„Å´ÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
                            
                            ÊúÄÈÅ©„Å™„ÉÅ„Çß„Çπ„Éà„ÅåË¶ã„Å§„Åã„Å£„Åü„Çâ‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
                            {
                                "name": "„ÉÅ„Çß„Çπ„ÉàÂêç",
                                "itemLevel": „Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                                "maxItemLevel": ÂÖ•ÊâãÂèØËÉΩË£ÖÂÇô„ÅÆÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                                "type": "chest",
                                "description": "Ë™¨Êòé"
                            }
                            
                            Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ null „ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                        `);
                        
                        if (result && result.trim() !== 'null') {
                            const parsed = JSON.parse(result);
                            if (parsed.maxItemLevel >= minItemLevel) {
                                return parsed;
                            }
                        }
                    } catch (queryError) {
                        continue;
                    }
                }
                
                // „Åô„Åπ„Å¶„ÅÆ‰ª£ÊõøÊ§úÁ¥¢„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà
                return getFallbackChestData(slot, minItemLevel);
                
            } catch (error) {
                return getFallbackChestData(slot, minItemLevel);
            }
        }
        
        // WebFetchÊ©üËÉΩ„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÊúÄÊñ∞„ÅÆFF14„ÉÅ„Çß„Çπ„ÉàÂêç„Çí‰ΩøÁî®Ôºâ
        function getFallbackChestData(slot, minItemLevel) {
            
            // ÂÆüÈöõ„ÅÆFF14„Åß‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„ÇãÊúÄÊñ∞„ÉÅ„Çß„Çπ„ÉàÂêç
            const fallbackData = {
                'Ê≠¶Âô®': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Ç¶„Çß„Éù„É≥„ÉÅ„Çß„Çπ„Éà„ÄêILv765„Äë',
                    itemLevel: 765,
                    maxItemLevel: 765,
                    type: 'weapon_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/2ec7d8cfb2d/',
                    description: 'IL765„ÅÆÂêÑ„Ç∏„Éß„ÉñÊ≠¶Âô®„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'È†≠': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Éò„ÉÉ„Éâ„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆÈ†≠Ë£ÖÂÇô„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'ËÉ¥': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Éú„Éá„Ç£„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆËÉ¥Ë£ÖÂÇô„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'Êâã': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Éè„É≥„Éâ„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆÊâãË£ÖÂÇô„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'ËÑö': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„É¨„ÉÉ„Ç∞„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆËÑöË£ÖÂÇô„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'Ë∂≥': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Éï„ÉÉ„Éà„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆË∂≥Ë£ÖÂÇô„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'ËÄ≥': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Ç¢„ÇØ„Çª„Çµ„É™„Éº„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆ„Ç§„É§„É™„É≥„Ç∞„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'È¶ñ': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Ç¢„ÇØ„Çª„Çµ„É™„Éº„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆ„Éç„ÉÉ„ÇØ„É¨„Çπ„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'ËÖï': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Ç¢„ÇØ„Çª„Çµ„É™„Éº„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆ„Éñ„É¨„Çπ„É¨„ÉÉ„Éà„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                },
                'Êåá': {
                    name: '„Éô„Éì„Éº„Éï„Çß„Ç§„Çπ„ÉÅ„É£„É≥„Éî„Ç™„É≥„Éª„Ç¢„ÇØ„Çª„Çµ„É™„Éº„ÉÅ„Çß„Çπ„Éà„ÄêILv750„Äë',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14ÊúÄÊñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750„ÅÆ„É™„É≥„Ç∞„ÅåÂÖ•ÊâãÂèØËÉΩ„Å™„ÉÅ„Çß„Çπ„Éà'
                }
            };
            
            const data = fallbackData[slot];
            if (!data || data.maxItemLevel < minItemLevel) {
                return null;
            }
            
            return data;
        }
        
        // ÂÖ®ÈÅ∏Êäû„ÉªÂÖ®Ëß£Èô§Ê©üËÉΩ
        function selectAllSlots() {
            document.querySelectorAll('.slot-checkbox').forEach(cb => {
                cb.checked = true;
            });
        }
        
        function clearAllSlots() {
            document.querySelectorAll('.slot-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // ÂÆüÈöõ„ÅÆWebFetchÂÆüË£Ö‰æãÔºàÊú¨Áï™Áí∞Â¢É„Åß‰ΩøÁî®Ôºâ
        async function realSearchHighestILChestForSlot(slot, jobRestriction, minItemLevel) {
            try {
                // FF14„Éá„Éº„Çø„Éô„Éº„Çπ„ÅßÊ§úÁ¥¢
                const searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?q=${slot}+„ÉÅ„Çß„Çπ„Éà+„Ç≥„Éï„Ç°„Éº+ÁÆ±&category2=3`;
                
                const searchResult = await WebFetch(searchUrl, `
                    „Åì„ÅÆFF14„Ç¢„Ç§„ÉÜ„É†Ê§úÁ¥¢ÁµêÊûú„Éö„Éº„Ç∏„Åã„Çâ„ÄÅ‰ª•‰∏ã„ÅÆÊù°‰ª∂„ÅßÊúÄÈÅ©„Å™„ÉÅ„Çß„Çπ„Éà/„Ç≥„Éï„Ç°„Éº„ÇíË¶ã„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºö
                    
                    Êù°‰ª∂:
                    - Ë£ÖÂÇôÈÉ®‰Ωç: ${slot}
                    - ËÅ∑Ê•≠Âà∂Èôê: ${jobRestriction}
                    - ÊúÄÂ∞è„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´: ${minItemLevel}‰ª•‰∏ä
                    
                    ÂõûÁ≠îÂΩ¢Âºè:
                    {
                        "name": "„ÉÅ„Çß„Çπ„ÉàÂêç",
                        "maxItemLevel": ÂÖ•ÊâãÂèØËÉΩ„Å™Ë£ÖÂÇô„ÅÆÊúÄÈ´ò„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´,
                        "source": "ÂÖ•ÊâãÂÖà„É¨„Ç§„Éâ/„Ç≥„É≥„ÉÜ„É≥„ÉÑÂêç",
                        "description": "Ë©≥Á¥∞Ë™¨Êòé"
                    }
                    
                    ÊúÄ„ÇÇÈ´ò„ÅÑ„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´„ÅÆË£ÖÂÇô„ÅåÂÖ•Êâã„Åß„Åç„Çã„ÉÅ„Çß„Çπ„Éà„Çí1„Å§„Å†„ÅëÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
                `);
                
                return JSON.parse(searchResult);
                
            } catch (error) {
                throw error;
            }
        }
        
        // „Ç§„É≥„Éù„Éº„Éà„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„ÇíÂ±§„Éâ„É≠„ÉÉ„Éó„Å®„Åó„Å¶ÈÅ©Áî®
        function applyImportedItems(layer) {
            if (!window.importedItems || window.importedItems.length === 0) {
                alert('ÈÅ©Áî®„Åô„Çã„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            if (confirm(`${window.importedItems.length}ÂÄã„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí${layer}Â±§„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„Å®„Åó„Å¶ÈÅ©Áî®„Åó„Åæ„Åô„ÅãÔºü`)) {
                // currentDropItems„Å´Ë®≠ÂÆö
                currentDropItems = window.importedItems.map(item => ({
                    slot: item.slot,
                    name: item.name,
                    itemLevel: item.itemLevel,
                    type: item.type
                }));
                
                // „Ç§„É≥„Éù„Éº„Éà„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
                window.importedItems = [];
                
                alert('„Ç¢„Ç§„ÉÜ„É†„ÅåÈÅ©Áî®„Åï„Çå„Åæ„Åó„ÅüÔºÅÂ±§ÂàÜÈÖçÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô„ÄÇ');
                showLayerAllocation(layer);
            }
        }
        
        // Â±•Ê≠¥„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportHistoryData() {
            const data = getData();
            const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
            const players = data.players && data.players[currentRaidTier.id] || {};
            
            const exportData = {
                raidTier: currentRaidTier,
                allocations: allocations,
                players: players,
                exportDate: new Date().toISOString()
            };
            
            const jsonData = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ff14_history_${currentRaidTier.name}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Â±•Ê≠¥„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ');
        }
        
        // Â±§Âà•„Çπ„É≠„ÉÉ„Éà„Ç™„Éó„Ç∑„Éß„É≥ÔºàË¶Å‰ª∂ÂÆöÁæ©Êõ∏Âü∫Ê∫ñÔºâ
        function getSlotOptionsForLayer(layer) {
            const slotsByLayer = {
                1: ['ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'],
                2: ['È†≠', 'Êâã', 'Ë∂≥', 'Ê≠¶Âô®Áü≥', 'Á°¨ÂåñËñ¨'],
                3: ['ËÉ¥', 'ËÑö', 'Âº∑ÂåñËñ¨', 'Âº∑ÂåñÁπäÁ∂≠'],
                4: ['Ê≠¶Âô®', '„Éû„Ç¶„É≥„Éà']
            };
            
            const slots = slotsByLayer[layer] || [];
            return slots.map(slot => `<option value="${slot}">${slot}</option>`).join('');
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ÔºàÁèæÂú®„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†Ôºâ
        let currentDropItems = [];
        let allocationResults = [];
        
        // Âõ∫ÂÆö„Éâ„É≠„ÉÉ„ÉóÁîüÊàê„Å®Âç≥Â∫ß„Å´ÂàÜÈÖçÂá¶ÁêÜÂÆüË°å
        function generateLayerDropsAndProcess(layer) {
            // „Éú„Çø„É≥„ÅÆ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢„Å®„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            const button = event ? event.target : null;
            if (button) {
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'Âá¶ÁêÜ‰∏≠...';
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                }, 1000);
            }
            
            try {
                const layerDrops = {
                1: [
                    { slot: 'ËÄ≥', name: 'ËÄ≥ - „Ç§„É§„É™„É≥„Ç∞„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'accessory' },
                    { slot: 'È¶ñ', name: 'È¶ñ - „Éç„ÉÉ„ÇØ„É¨„Çπ„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'accessory' },
                    { slot: 'ËÖï', name: 'ËÖï - „Éñ„É¨„Çπ„É¨„ÉÉ„Éà„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'accessory' },
                    { slot: 'Êåá', name: 'Êåá - „É™„É≥„Ç∞„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'accessory' }
                ],
                2: [
                    { slot: 'È†≠', name: 'È†≠ - „Éò„ÉÉ„Éâ„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'armor' },
                    { slot: 'Êâã', name: 'Êâã - „Éè„É≥„Éâ„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'armor' },
                    { slot: 'Ë∂≥', name: 'Ë∂≥ - „Éï„ÉÉ„Éà„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'armor' },
                    { slot: 'Ê≠¶Âô®Áü≥', name: 'Ê≠¶Âô®Áü≥', itemLevel: 1, type: 'material' },
                    { slot: 'Á°¨ÂåñËñ¨', name: 'Á°¨ÂåñËñ¨', itemLevel: 1, type: 'material' }
                ],
                3: [
                    { slot: 'ËÉ¥', name: 'ËÉ¥ - „Éú„Éá„Ç£„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'armor' },
                    { slot: 'ËÑö', name: 'ËÑö - „É¨„ÉÉ„Ç∞„ÇÆ„Ç¢„ÉÅ„Çß„Çπ„Éà', itemLevel: 730, type: 'armor' },
                    { slot: 'Âº∑ÂåñËñ¨', name: 'Âº∑ÂåñËñ¨', itemLevel: 1, type: 'material' },
                    { slot: 'Âº∑ÂåñÁπäÁ∂≠', name: 'Âº∑ÂåñÁπäÁ∂≠', itemLevel: 1, type: 'material' }
                ],
                4: [
                    { slot: 'Ê≠¶Âô®', name: 'Ê≠¶Âô® - „Ç¶„Çß„Éù„É≥„ÉÅ„Çß„Çπ„Éà', itemLevel: 735, type: 'weapon_box' },
                    { slot: '„Éû„Ç¶„É≥„Éà', name: '„Éû„Ç¶„É≥„Éà', itemLevel: 1, type: 'mount' }
                ]
            };
            
                // Âõ∫ÂÆö„Éâ„É≠„ÉÉ„Éó„ÇíË®≠ÂÆö
                currentDropItems = layerDrops[layer] || [];
                
                // 4Â±§„ÅÆÂ†¥Âêà„ÅØÁõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®ÈÅ∏ÊäûÊ©üËÉΩ„ÇíËøΩÂä†
                if (layer === 4) {
                    displayFixedDropsWithDirectWeapon(currentDropItems, layer);
                } else {
                    // Âõ∫ÂÆö„Éâ„É≠„ÉÉ„ÉóË°®Á§∫
                    displayFixedDrops(currentDropItems);
                    // Âç≥Â∫ß„Å´ÂàÜÈÖçÂá¶ÁêÜ„ÇíÂÆüË°å
                    processAllocationImmediate(layer);
                }
            } catch (error) {
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // 4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„Çí„É©„É≥„ÉÄ„É†ÁîüÊàê
        function getRandomDirectDropWeapon() {
            const allJobs = [
                '„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº',
                'ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ∏´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ',
                '„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº',
                'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê',
                'ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº'
            ];
            
            const randomJob = allJobs[Math.floor(Math.random() * allJobs.length)];
            return `${randomJob}Ê≠¶Âô®`;
        }
        
        // „Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†ÊâãÂãïËøΩÂä†
        function addDropItem(layer) {
            const slot = document.getElementById('item-slot').value;
            const name = document.getElementById('item-name').value.trim();
            const itemLevel = parseInt(document.getElementById('item-level').value) || 730;
            
            if (!slot || !name) {
                alert('ÈÉ®‰Ωç„Å®„Ç¢„Ç§„ÉÜ„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const newItem = {
                slot: slot,
                name: name,
                itemLevel: itemLevel
            };
            
            currentDropItems.push(newItem);
            updateDropItemsDisplay();
            
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('item-slot').value = '';
            document.getElementById('item-name').value = '';
            document.getElementById('item-level').value = '730';
        }
        
        // „Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†Ë°®Á§∫Êõ¥Êñ∞
        function updateDropItemsDisplay() {
            const container = document.getElementById('drop-items');
            
            if (currentDropItems.length === 0) {
                container.innerHTML = '<p>„Äå„É©„É≥„ÉÄ„É†„Éâ„É≠„ÉÉ„ÉóÁîüÊàê„Äç„Éú„Çø„É≥„Åß„Ç¢„Ç§„ÉÜ„É†„ÇíÁîüÊàê„Åô„Çã„Åã„ÄÅÊâãÂãï„ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
                document.getElementById('process-btn').disabled = true;
                return;
            }
            
            container.innerHTML = currentDropItems.map((item, index) => `
                <div class="drop-item">
                    <div class="drop-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.slot}</p>
                    </div>
                    <div class="drop-item-actions">
                        <button onclick="removeDropItem(${index})">ÂâäÈô§</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('process-btn').disabled = false;
        }
        
        // „Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†ÂâäÈô§
        function removeDropItem(index) {
            currentDropItems.splice(index, 1);
            updateDropItemsDisplay();
        }
        
        // Âõ∫ÂÆö„Éâ„É≠„ÉÉ„ÉóË°®Á§∫
        function displayFixedDrops(dropItems) {
            const container = document.getElementById('fixed-drops');
            
            if (!container) {
                return;
            }
            
            container.innerHTML = dropItems.map(item => `
                <div class="fixed-drop-item">
                    <div>
                        <h4>${item.name}</h4>
                        <p>${item.slot}</p>
                    </div>
                    <div style="color: #3742fa; font-weight: bold;">
                        Âõ∫ÂÆö„Éâ„É≠„ÉÉ„Éó
                    </div>
                </div>
            `).join('');
        }
        
        // 4Â±§Â∞ÇÁî®„ÅÆË°®Á§∫Èñ¢Êï∞ÔºàÁõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®ÈÅ∏ÊäûÊ©üËÉΩ‰ªò„ÅçÔºâ
        function displayFixedDropsWithDirectWeapon(dropItems, layer) {
            const container = document.getElementById('fixed-drops');
            
            if (!container) {
                return;
            }
            
            const allJobs = [
                '„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº',
                'ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ∏´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ',
                '„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº',
                'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê',
                'ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº'
            ];
            
            container.innerHTML = `
                ${dropItems.map(item => `
                    <div class="fixed-drop-item">
                        <div>
                            <h4>${item.name}</h4>
                            <p>${item.slot}</p>
                        </div>
                        <div style="color: #3742fa; font-weight: bold;">
                            Âõ∫ÂÆö„Éâ„É≠„ÉÉ„Éó
                        </div>
                    </div>
                `).join('')}
                
                <div class="direct-weapon-section">
                    <h3>4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®Ë®≠ÂÆö</h3>
                    <div class="weapon-selection">
                        <label for="direct-weapon-select">„Éâ„É≠„ÉÉ„Éó„Åó„ÅüÊ≠¶Âô®„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</label>
                        <select id="direct-weapon-select" onchange="onDirectWeaponSelected(${layer})">
                            <option value="">Ê≠¶Âô®„ÇíÈÅ∏Êäû...</option>
                            ${allJobs.map(job => `<option value="${job}">${job}Ê≠¶Âô®</option>`).join('')}
                        </select>
                    </div>
                    <div id="direct-weapon-result" style="margin-top: 15px;">
                        <!-- Ê≠¶Âô®ÈÅ∏ÊäûÂæå„Å´ÂèñÂæó‰∫àÂÆöËÄÖ„ÅåË°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>
            `;
            
            // Âõ∫ÂÆö„Éâ„É≠„ÉÉ„Éó„ÅÆ„Åø„ÅßÂàÜÈÖçÂá¶ÁêÜ„ÇíÂÆüË°å
            processAllocationImmediate(layer);
        }
        
        // ÂàÜÈÖçÂá¶ÁêÜÂÆüË°åÔºàÂç≥Â∫ß„Å´ÂÆüË°åÁâàÔºâ
        function processAllocationImmediate(layer) {
            const data = getData();
            const players = Object.values(data.players[currentRaidTier.id]);
            
            allocationResults = [];
            
            
            currentDropItems.forEach((item, index) => {
                let allocationResult;
                
                // 4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÁâπÂà•Âá¶ÁêÜ
                if (item.type === 'direct_weapon') {
                    allocationResult = processDirectDropWeaponSimple(item, players);
                } else {
                    // Ë£ÖÂÇôÊñπÈáù„Éá„Éº„Çø„Çí„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„Åã„ÇâÊßãÁØâ
                    const gearPolicies = {};
                    players.forEach(player => {
                        gearPolicies[player.position] = player.equipmentPolicy || {};
                    });
                    
                    // Êñ∞„Åó„ÅÑÂà§ÂÆö„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
                    allocationResult = processEquipmentWithNewSystem(item, players, gearPolicies);
                }
                
                allocationResults.push(allocationResult);
            });
            
            displayAllocationResults();
        }
        
        // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®ÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ
        function onDirectWeaponSelected(layer) {
            const selectedJob = document.getElementById('direct-weapon-select').value;
            const resultDiv = document.getElementById('direct-weapon-result');
            
            if (!selectedJob) {
                resultDiv.innerHTML = '';
                return;
            }
            
            // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
            const directWeapon = {
                slot: 'Ê≠¶Âô®',
                name: `${selectedJob}Ê≠¶Âô®`,
                itemLevel: 735,
                type: 'direct_weapon'
            };
            
            // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„ÇøÂèñÂæó
            const data = getData();
            const players = Object.values(data.players[currentRaidTier.id]);
            
            // Ê≠¶Âô®„ÅÆÂàÜÈÖçÂá¶ÁêÜ„ÇíÂÆüË°å
            const allocationResult = processDirectDropWeaponSimple(directWeapon, players);
            
            // ÁµêÊûú„ÇíË°®Á§∫
            resultDiv.innerHTML = `
                <div class="direct-weapon-compact">
                    <div class="weapon-header-compact">
                        <div class="header-item">„Ç¢„Ç§„ÉÜ„É†</div>
                        <div class="header-predicted">ÂèñÂæó‰∫àÂÆöËÄÖ</div>
                        <div class="header-actual">ÂÆüÈöõ„ÅÆÂèñÂæóËÄÖ</div>
                    </div>
                    <div class="weapon-allocation-row">
                        <div class="weapon-name-compact">${selectedJob}Ê≠¶Âô®</div>
                        <div class="weapon-status">
                            ${allocationResult.winner ? `
                                <span class="auto-result">${allocationResult.winner.position} - ${allocationResult.winner.characterName}</span>
                            ` : `
                                <span class="auto-result freelot">„Éï„É™„Éº„É≠„ÉÉ„Éà</span>
                            `}
                        </div>
                        <div class="weapon-selection-compact">
                            <select id="manual-weapon-winner" onchange="updateManualWeaponWinner('${selectedJob}')">
                                <option value="">ÂèñÂæóËÄÖ„ÇíÈÅ∏Êäû...</option>
                                ${players.map(player => `
                                    <option value="${player.position}" 
                                        ${allocationResult.winner && allocationResult.winner.position === player.position ? 'selected' : ''}>
                                        ${player.position} - ${player.characterName}
                                    </option>
                                `).join('')}
                                <option value="discard" ${!allocationResult.winner ? 'selected' : ''}>ÂàÜËß£„Éª‰øùÁÆ°</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÇíÁèæÂú®„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„Å´ËøΩÂä†Ôºà‰∏ÄÊôÇÁöÑÔºâ
            const weaponIndex = currentDropItems.findIndex(item => item.type === 'direct_weapon');
            if (weaponIndex >= 0) {
                currentDropItems[weaponIndex] = directWeapon;
            } else {
                currentDropItems.push(directWeapon);
            }
            
            // ÂÖ®‰Ωì„ÅÆÂàÜÈÖçÁµêÊûú„ÇíÊõ¥Êñ∞
            processAllocationImmediate(layer);
        }
        
        // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÊâãÂãïÂèñÂæóËÄÖË®≠ÂÆö
        function updateManualWeaponWinner(weaponJob) {
            const selectedPosition = document.getElementById('manual-weapon-winner').value;
            
            // Ë©≤ÂΩì„Åô„ÇãÊ≠¶Âô®„ÅÆallocationResults„ÇíË¶ã„Å§„Åë„Å¶Êõ¥Êñ∞
            const weaponResultIndex = allocationResults.findIndex(result => 
                result.equipment.type === 'direct_weapon' && result.equipment.name.includes(weaponJob)
            );
            
            if (weaponResultIndex >= 0) {
                if (selectedPosition === '' || selectedPosition === 'discard') {
                    // ÂàÜËß£„Éª‰øùÁÆ°„ÅÆÂ†¥Âêà
                    allocationResults[weaponResultIndex].winner = null;
                    allocationResults[weaponResultIndex].reason = 'ÊâãÂãïË®≠ÂÆö: ÂàÜËß£„Éª‰øùÁÆ°';
                } else {
                    // „Éó„É¨„Ç§„É§„Éº„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà
                    const data = getData();
                    const players = Object.values(data.players[currentRaidTier.id]);
                    const selectedPlayer = players.find(p => p.position === selectedPosition);
                    
                    if (selectedPlayer) {
                        allocationResults[weaponResultIndex].winner = selectedPlayer;
                        allocationResults[weaponResultIndex].reason = 'ÊâãÂãïË®≠ÂÆö: „É¶„Éº„Ç∂„ÉºÊåáÂÆö';
                    }
                }
                
                // ÂÖ®‰Ωì„ÅÆÂàÜÈÖçÁµêÊûúË°®Á§∫„ÇíÊõ¥Êñ∞
                displayAllocationResults();
            }
        }
        
        // Ë¶Å‰ª∂ÂÆöÁæ©Êõ∏Âü∫Ê∫ñ„ÅÆÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØÔºàworking_index.htmlÁî®Ôºâ
        function calculatePlayerJudgmentSimple(player, equipment) {
            // „Éû„ÉÜ„É™„Ç¢„É´Á≥ª„Ç¢„Ç§„ÉÜ„É†„ÅØÂàÜÈÖçÂØæË±°Â§ñÔºàPassÔºâ
            if (equipment.type === 'material' || equipment.type === 'mount') {
                return 'Pass';
            }
            
            // 1. Ë£ÖÂÇôÊñπÈáù„ÉÅ„Çß„ÉÉ„ÇØÔºàË¶Å‰ª∂ÂÆöÁæ©Êõ∏Âü∫Ê∫ñÔºâ
            const slotPolicy = player.equipmentPolicy[equipment.slot];
            
            // Ë£ÖÂÇôÊñπÈáù„Åå„Äå„Éà„Éº„É†„Çπ„Éà„Éº„É≥„Äç„ÅßÈõ∂ÂºèË£ÖÂÇô„ÅÆÂ†¥Âêà„ÅÆÂà§ÂÆö
            if (slotPolicy === '„Éà„Éº„É†„Çπ„Éà„Éº„É≥' && equipment.type !== 'weapon_box') {
                // Â∞ÜÊù•ÁöÑ„Å´‰ΩøÁî®ÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØGreed„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞Pass
                return 'Greed'; // Á∞°ÊòìÂÆüË£Ö„Åß„ÅØ‰∏ÄÂæãGreed
            }
            
            // 2. ÁèæÂú®Ë£ÖÂÇô„Å®„ÅÆÊØîËºÉ
            const currentEquipment = player.currentEquipment[equipment.slot];
            const isUpgrade = !currentEquipment || equipment.itemLevel > (currentEquipment.itemLevel || 0);
            
            // 3. NeedÂà§ÂÆö: „Åù„ÅÆË£ÖÂÇô„ÅåÁèæÂú®„ÅÆË£ÖÂÇô„Çà„Çä‰∏ä‰Ωç„Åß„ÄÅ„Åã„Å§Ë£ÖÂÇôÊñπÈáù„Åå„ÄåÈõ∂Âºè„Äç„ÅÆÂ†¥Âêà
            if (slotPolicy === 'Èõ∂Âºè' && isUpgrade) {
                return 'Need';
            }
            
            // 4. Êó¢„Å´„Çà„ÇäËâØ„ÅÑË£ÖÂÇô„ÇíÊåÅ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØPass
            if (!isUpgrade) {
                return 'Pass';
            }
            
            // 5. „Åù„ÅÆ‰ªñ„ÅØGreed
            return 'Greed';
        }
        
        // „Ç∑„É≥„Éó„É´„Å™ÂàÜÈÖçÂá¶ÁêÜÔºàworking_index.htmlÁî®Ôºâ
        function processAllocationVotingSimple(equipment, playerJudgments) {
            // 4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÁâπÂà•Âá¶ÁêÜ
            if (equipment.type === 'direct_weapon') {
                return processDirectDropWeaponSimple(equipment, playerJudgments);
            }
            
            const needPlayers = playerJudgments.filter(pj => pj.judgment === 'Need');
            const greedPlayers = playerJudgments.filter(pj => pj.judgment === 'Greed');
            
            let winner = null;
            let reason = '';
            
            if (needPlayers.length > 0) {
                // NeedËÄÖ„Åå„ÅÑ„ÇãÂ†¥Âêà„ÄÅË¶Å‰ª∂ÂÆöÁæ©Êõ∏„Å´Âü∫„Å•„ÅèÂÑ™ÂÖàÂ∫¶„ÅßÈÅ∏Êäû
                winner = selectWinnerByPriority(needPlayers);
                reason = needPlayers.length === 1 ? 'NeedÔºàÂçòÁã¨Ôºâ' : 'NeedÔºàÂÑ™ÂÖàÂ∫¶Âà§ÂÆöÔºâ';
            } else if (greedPlayers.length > 0) {
                // GreedËÄÖ„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÄÅÂÑ™ÂÖàÂ∫¶„ÅßÈÅ∏Êäû
                winner = selectWinnerByPriority(greedPlayers);
                reason = greedPlayers.length === 1 ? 'GreedÔºàÂçòÁã¨Ôºâ' : 'GreedÔºàÂÑ™ÂÖàÂ∫¶Âà§ÂÆöÔºâ';
            } else {
                reason = 'ÂÖ®Âì°PassÔºàÂàÜËß£Ôºâ';
            }
            
            return {
                equipment: equipment,
                winner: winner,
                reason: reason,
                allJudgments: playerJudgments,
                needCount: needPlayers.length,
                greedCount: greedPlayers.length,
                passCount: playerJudgments.length - needPlayers.length - greedPlayers.length
            };
        }
        
        // 4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÁâπÂà•Âá¶ÁêÜ
        function processDirectDropWeaponSimple(equipment, allPlayers) {
            const droppedWeaponJob = extractJobFromWeaponName(equipment.name);
            
            // 1. ÁôªÈå≤„Ç∏„Éß„Éñ„Å´Ë©≤ÂΩì & Ê≠¶Âô®Êú™ÂèñÂæó„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÊ§úÁ¥¢
            const primaryCandidates = allPlayers.filter(player => {
                const hasWeaponWish = player.weaponWishes && player.weaponWishes.some(wish => wish.jobName === droppedWeaponJob);
                const hasWeapon = playerHasWeaponForJobSimple(player, droppedWeaponJob);
                return hasWeaponWish && !hasWeapon;
            });

            if (primaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(primaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: 'ÁôªÈå≤„Ç∏„Éß„ÉñË©≤ÂΩì„ÉªÊ≠¶Âô®Êú™ÂèñÂæó',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: primaryCandidates.includes(p) ? 'Need' : 'Pass' 
                    })),
                    needCount: primaryCandidates.length,
                    greedCount: 0,
                    passCount: allPlayers.length - primaryCandidates.length
                };
            }

            // 2. Â∏åÊúõÁôªÈå≤Ê∏à„Åø„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÊ§úÁ¥¢
            const secondaryCandidates = allPlayers.filter(player => {
                return player.weaponWishes && player.weaponWishes.some(wish => wish.jobName === droppedWeaponJob);
            });

            if (secondaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(secondaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: 'Â∏åÊúõÁôªÈå≤Ê∏à„Åø',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: secondaryCandidates.includes(p) ? 'Greed' : 'Pass' 
                    })),
                    needCount: 0,
                    greedCount: secondaryCandidates.length,
                    passCount: allPlayers.length - secondaryCandidates.length
                };
            }

            // 3. Ë©≤ÂΩìËÄÖ„Å™„Åó
            return {
                equipment: equipment,
                winner: null,
                reason: 'Ë©≤ÂΩìËÄÖ„Å™„ÅóÔºàÂàÜËß£„Éª‰øùÁÆ°Ôºâ',
                allJudgments: allPlayers.map(p => ({ player: p, judgment: 'Pass' })),
                needCount: 0,
                greedCount: 0,
                passCount: allPlayers.length
            };
        }
        
        // Ê≠¶Âô®Âêç„Åã„Çâ„Ç∏„Éß„Éñ„ÇíÊäΩÂá∫
        function extractJobFromWeaponName(weaponName) {
            const jobNames = [
                '„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº',
                'ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ∏´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ',
                '„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº',
                'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê',
                'ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº'
            ];
            
            for (const job of jobNames) {
                if (weaponName.includes(job)) {
                    return job;
                }
            }
            
            return '‰∏çÊòé';
        }
        
        // „Éó„É¨„Ç§„É§„Éº„ÅåÁâπÂÆö„Ç∏„Éß„Éñ„ÅÆÊ≠¶Âô®„ÇíÊåÅ„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÁ∞°ÊòìÁâàÔºâ
        function playerHasWeaponForJobSimple(player, jobName) {
            const currentWeapon = player.currentEquipment && player.currentEquipment['Ê≠¶Âô®'];
            if (!currentWeapon) return false;
            
            // Á∞°ÊòìÁöÑ„Å´„Ç¢„Ç§„ÉÜ„É†„É¨„Éô„É´720‰ª•‰∏ä„ÇíÊåÅ„Å£„Å¶„ÅÑ„Çå„Å∞Ê≠¶Âô®„ÅÇ„Çä„Å®„Åô„Çã
            return currentWeapon.itemLevel >= 720;
        }
        
        // Ë¶Å‰ª∂ÂÆöÁæ©Êõ∏„Å´Âü∫„Å•„ÅèÂÑ™ÂÖàÂ∫¶„ÅßÂãùËÄÖÈÅ∏ÊäûÔºà„Éá„Éê„ÉÉ„Ç∞Âº∑ÂåñÁâàÔºâ
        function selectWinnerByPriority(candidatePlayers) {
            // player„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâÂÆüÈöõ„ÅÆ„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÇíÂèñÂæó
            const players = candidatePlayers.map(cp => cp.player || cp);
            
            if (players.length === 1) {
                return players[0];
            }
            
            
            // ÂÑ™ÂÖàÂ∫¶: D1/D2 > D3/D4 > MT/ST > H1/H2
            const positionPriorities = {
                'D1': 1, 'D2': 1,    // DPS Melee
                'D3': 2, 'D4': 2,    // DPS Range/Caster
                'MT': 3, 'ST': 3,    // Tank
                'H1': 4, 'H2': 4     // Healer
            };
            
            // ÂÑ™ÂÖàÂ∫¶„ÇíË°®Á§∫
            players.forEach(player => {
                const priority = positionPriorities[player.position] || 999;
            });
            
            const sortedPlayers = players.sort((a, b) => {
                const priorityA = positionPriorities[a.position] || 999;
                const priorityB = positionPriorities[b.position] || 999;
                return priorityA - priorityB;
            });
            
            
            return sortedPlayers[0];
        }
        
        // Êñ∞„Åó„ÅÑNeed/Greed/PassÂà§ÂÆö„Ç∑„Çπ„ÉÜ„É†ÔºàË£ÖÂÇôÊñπÈáùÔºã„Ç´„Çπ„Çø„É†„Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶Ôºâ
        function calculateEquipmentPriority(player, equipment, gearPolicies) {
            const slot = equipment.slot || getSlotFromEquipmentName(equipment.name);
            const playerGearPolicy = gearPolicies && gearPolicies[player.position] && gearPolicies[player.position][slot];
            
            // ÁèæÂú®Ë£ÖÂÇô„Å®„ÅÆÊØîËºÉ - ÈáçË¶Å„Å™‰øÆÊ≠£ÁÇπ
            const currentEquipment = player.currentEquipment && player.currentEquipment[slot];
            const isUpgrade = !currentEquipment || equipment.itemLevel > (currentEquipment.itemLevel || 0);
            
            // Êó¢„Å´„Çà„ÇäËâØ„ÅÑË£ÖÂÇô„ÇíÊåÅ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØPass
            if (!isUpgrade) {
                return {
                    totalPriority: 0,
                    gearPolicyPriority: 0,
                    rolePriority: 0,
                    gearPolicy: playerGearPolicy || 'Èõ∂Âºè(„Éá„Éï„Ç©„É´„Éà)',
                    judgment: 'Pass',
                    reason: `Êó¢„Å´„Çà„ÇäËâØ„ÅÑË£ÖÂÇô„ÇíË£ÖÂÇôÊ∏à„Åø (IL${currentEquipment?.itemLevel || 0} ‚Üí IL${equipment.itemLevel})`
                };
            }
            
            // Ë£ÖÂÇôÊñπÈáù„Å´„Çà„ÇãÂÑ™ÂÖàÂ∫¶ÔºàÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØÈõ∂ÂºèÊâ±„ÅÑÔºâ
            const gearPolicyPriority = (playerGearPolicy === 'Èõ∂Âºè' || !playerGearPolicy) ? 100 : 50;
            
            // „Ç´„Çπ„Çø„É†„Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶„ÇíÂèñÂæó
            const data = getData();
            const customPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id];
            
            let rolePriority;
            if (customPriorities && customPriorities[player.position]) {
                rolePriority = customPriorities[player.position];
            } else {
                // „Éá„Éï„Ç©„É´„ÉàÂÑ™ÂÖàÂ∫¶ÔºàÂæìÊù•„ÅÆË®≠ÂÆöÔºâ
                const defaultRolePriorities = {
                    'D1': 30, 'D2': 30,    // DPSÈ´òÂÑ™ÂÖàÂ∫¶
                    'D3': 25, 'D4': 25,    // DPS‰∏≠ÂÑ™ÂÖàÂ∫¶
                    'MT': 20, 'ST': 20,    // „Çø„É≥„ÇØ
                    'H1': 10, 'H2': 10     // „Éí„Éº„É©„Éº
                };
                rolePriority = defaultRolePriorities[player.position] || 0;
            }
            
            // Á∑èÂêàÂÑ™ÂÖàÂ∫¶ = Ë£ÖÂÇôÊñπÈáùÂÑ™ÂÖàÂ∫¶ + „Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶
            const totalPriority = gearPolicyPriority + rolePriority;
            
            return {
                totalPriority,
                gearPolicyPriority,
                rolePriority,
                gearPolicy: playerGearPolicy || 'Èõ∂Âºè(„Éá„Éï„Ç©„É´„Éà)',
                judgment: totalPriority >= 100 ? 'Need' : totalPriority >= 50 ? 'Greed' : 'Pass',
                reason: isUpgrade ? `„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ (IL${currentEquipment?.itemLevel || 0} ‚Üí IL${equipment.itemLevel})` : ''
            };
        }
        
        // Ë£ÖÂÇôÂêç„Åã„Çâ„Çπ„É≠„ÉÉ„Éà„ÇíÊé®ÂÆö
        function getSlotFromEquipmentName(equipmentName) {
            const slotKeywords = {
                'Ê≠¶Âô®': ['Ê≠¶Âô®', '„ÇΩ„Éº„Éâ', '„Ç¢„ÇØ„Çπ', '„Éè„É≥„Éû„Éº', '„É≠„ÉÉ„Éâ', '„Éú„Ç¶', '„Ç¨„É≥'],
                'È†≠': ['„Éò„É´„É†', '„Éï„Éº„Éâ', '„Éè„ÉÉ„Éà', 'Â∏ΩÂ≠ê', 'È†≠'],
                'ËÉ¥': ['„Ç¢„Éº„Éû„Éº', '„É≠„Éº„Éñ', '„Ç≥„Éº„Éà', 'ËÉ¥', '„ÉÅ„Çß„Çπ„Éà'],
                'Êâã': ['„Ç¨„É≥„Éà„É¨„ÉÉ„Éà', '„Ç∞„É≠„Éº„Éñ', 'ÊâãË¢ã', 'Êâã'],
                'ËÑö': ['„Éë„É≥„Çø„É≠„É≥', '„Éõ„Éº„Ç∫', '„Éñ„Éº„ÉÑ', 'ËÑö', '„É¨„ÉÉ„Ç∞'],
                'Ë∂≥': ['„Éñ„Éº„ÉÑ', '„Ç∑„É•„Éº„Ç∫', 'Èù¥', 'Ë∂≥'],
                'ËÄ≥': ['„Ç§„É§„É™„É≥„Ç∞', 'ËÄ≥È£æ„Çä', 'ËÄ≥'],
                'È¶ñ': ['„Éç„ÉÉ„ÇØ„É¨„Çπ', '„ÉÅ„Éß„Éº„Ç´„Éº', 'È¶ñÈ£æ„Çä', 'È¶ñ'],
                'ËÖï': ['„Éñ„É¨„Çπ„É¨„ÉÉ„Éà', 'ËÖïËº™', 'ËÖï'],
                'Êåá': ['„É™„É≥„Ç∞', 'ÊåáËº™', 'Êåá']
            };
            
            for (const [slot, keywords] of Object.entries(slotKeywords)) {
                if (keywords.some(keyword => equipmentName.includes(keyword))) {
                    return slot;
                }
            }
            
            return '‰∏çÊòé';
        }
        
        // Êñ∞„Åó„ÅÑË£ÖÂÇôÂàÜÈÖçÂá¶ÁêÜÔºàË£ÖÂÇôÊñπÈáùÔºã„É≠„Éº„É´ÂÑ™ÂÖàÂ∫¶ÁâàÔºâ
        function processEquipmentWithNewSystem(equipment, allPlayers, gearPolicies) {
            
            // ÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆÂÑ™ÂÖàÂ∫¶„ÇíË®àÁÆó
            const playerPriorities = allPlayers.map(player => {
                const priority = calculateEquipmentPriority(player, equipment, gearPolicies);
                return {
                    player: player,
                    ...priority
                };
            });
            
            // Âà§ÂÆöÂà•„Å´ÂàÜÈ°û
            const needPlayers = playerPriorities.filter(p => p.judgment === 'Need').sort((a, b) => b.totalPriority - a.totalPriority);
            const greedPlayers = playerPriorities.filter(p => p.judgment === 'Greed').sort((a, b) => b.totalPriority - a.totalPriority);
            const passPlayers = playerPriorities.filter(p => p.judgment === 'Pass');
            
            // ÂãùËÄÖÊ±∫ÂÆö
            let winner = null;
            let reason = '';
            
            if (needPlayers.length > 0) {
                winner = needPlayers[0].player;
                reason = `NeedÂà§ÂÆö (Ë£ÖÂÇôÊñπÈáù: ${needPlayers[0].gearPolicy}, ÂÑ™ÂÖàÂ∫¶: ${needPlayers[0].totalPriority})`;
            } else if (greedPlayers.length > 0) {
                winner = greedPlayers[0].player;
                reason = `GreedÂà§ÂÆö (Ë£ÖÂÇôÊñπÈáù: ${greedPlayers[0].gearPolicy}, ÂÑ™ÂÖàÂ∫¶: ${greedPlayers[0].totalPriority})`;
            } else {
                reason = 'ÂÖ®Âì°PassÂà§ÂÆö (ÂàÜËß£„Éª‰øùÁÆ°)';
            }
            
            // ÁµêÊûú„Çí„É≠„Ç∞Âá∫Âäõ
            playerPriorities.forEach(p => {
            });
            
            return {
                equipment: equipment,
                winner: winner,
                reason: reason,
                allJudgments: playerPriorities.map(p => ({
                    player: p.player,
                    judgment: p.judgment,
                    priority: p.totalPriority,
                    gearPolicy: p.gearPolicy,
                    reason: p.reason || ''
                })),
                needCount: needPlayers.length,
                greedCount: greedPlayers.length,
                passCount: passPlayers.length
            };
        }
        
        // ÂàÜÈÖçÁµêÊûúË°®Á§∫
        function displayAllocationResults() {
            try {
                const container = document.getElementById('allocation-summary');
                
                if (!container) {
                    return;
                }
                
                // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÇíÂèñÂæó
                const data = getData();
                const players = Object.values(data.players[currentRaidTier.id]);
                
                const htmlContent = allocationResults.map((result, index) => {
                    
                    // ÂãùËÄÖÊÉÖÂ†±„ÅÆÂÆâÂÖ®„Å™ÂèñÂæó
                    let winnerText = '„Å™„Åó';
                    let isFreeLot = false;
                    
                    if (result.winner) {
                        const winnerName = result.winner.name || 'ÂêçÂâç‰∏çÊòé';
                        const winnerPosition = result.winner.position || '„Éù„Ç∏„Ç∑„Éß„É≥‰∏çÊòé';
                        winnerText = `${winnerName} (${winnerPosition})`;
                    } else {
                        // Ë©≤ÂΩìËÄÖ„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éï„É™„Éº„É≠„ÉÉ„Éà
                        winnerText = '„Éï„É™„Éº„É≠„ÉÉ„Éà';
                        isFreeLot = true;
                    }
                    
                    return `
                        <div class="allocation-result-compact">
                            <div class="item-allocation-row">
                                <div class="item-name-compact">${result.equipment.name}</div>
                                <div class="allocation-status">
                                    <span class="auto-result ${isFreeLot ? 'freelot' : ''}">${winnerText}</span>
                                </div>
                                <div class="manual-selection-compact">
                                    <select id="manual-winner-${index}" onchange="updateManualWinner(${index})">
                                        <option value="">ÂèñÂæóËÄÖ„ÇíÈÅ∏Êäû...</option>
                                        ${players.map(player => `
                                            <option value="${player.position}" 
                                                ${result.winner && result.winner.position === player.position ? 'selected' : ''}>
                                                ${player.position} - ${player.characterName}
                                            </option>
                                        `).join('')}
                                        <option value="discard" ${!result.winner ? 'selected' : ''}>ÂàÜËß£„Éª‰øùÁÆ°</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="allocation-header-compact">
                        <div class="header-item">„Ç¢„Ç§„ÉÜ„É†</div>
                        <div class="header-predicted">ÂèñÂæó‰∫àÂÆöËÄÖ</div>
                        <div class="header-actual">ÂÆüÈöõ„ÅÆÂèñÂæóËÄÖ</div>
                    </div>
                    ${htmlContent}
                `;
                
            } catch (error) {
                
                // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅÆ‰ª£ÊõøË°®Á§∫
                const container = document.getElementById('allocation-summary');
                if (container) {
                    container.innerHTML = `<p style="color: #ff6b6b;">ÂàÜÈÖçÁµêÊûú„ÅÆË°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ</p>`;
                }
            }
        }
        
        // ÊâãÂãïÂèñÂæóËÄÖË®≠ÂÆö
        function updateManualWinner(resultIndex) {
            const selectedPosition = document.getElementById(`manual-winner-${resultIndex}`).value;
            
            if (!allocationResults[resultIndex]) {
                return;
            }
            
            if (selectedPosition === '' || selectedPosition === 'discard') {
                // ÂàÜËß£„Éª‰øùÁÆ°„ÅÆÂ†¥Âêà
                allocationResults[resultIndex].winner = null;
                allocationResults[resultIndex].reason = 'ÊâãÂãïË®≠ÂÆö: ÂàÜËß£„Éª‰øùÁÆ°';
            } else {
                // „Éó„É¨„Ç§„É§„Éº„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà
                const data = getData();
                const players = Object.values(data.players[currentRaidTier.id]);
                const selectedPlayer = players.find(p => p.position === selectedPosition);
                
                if (selectedPlayer) {
                    allocationResults[resultIndex].winner = selectedPlayer;
                    allocationResults[resultIndex].reason = 'ÊâãÂãïË®≠ÂÆö: „É¶„Éº„Ç∂„ÉºÊåáÂÆö';
                }
            }
        }
        
        // ÂàÜÈÖçÁµêÊûúÁ¢∫ÂÆö„Éª‰øùÂ≠ò
        function confirmAndSaveAllocation(layer) {
            if (!allocationResults || allocationResults.length === 0) {
                alert('ÂàÜÈÖçÁµêÊûú„ÅåÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            if (!confirm(`${layer}Â±§„ÅÆÂàÜÈÖçÁµêÊûú„ÇíÁ¢∫ÂÆö„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }
            
            const data = getData();
            
            if (!data.allocations) data.allocations = {};
            if (!data.allocations[currentRaidTier.id]) data.allocations[currentRaidTier.id] = [];
            
            const timestamp = new Date().toISOString();
            
            allocationResults.forEach(result => {
                const allocation = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    layer: layer,
                    equipment: result.equipment,
                    winner: result.winner,
                    reason: result.reason,
                    allJudgments: result.allJudgments,
                    timestamp: timestamp,
                    week: getCurrentWeekString()
                };
                
                data.allocations[currentRaidTier.id].push(allocation);
                
                // ÂãùËÄÖ„ÅÆÁèæÂú®Ë£ÖÂÇô„ÇíÊõ¥Êñ∞
                if (result.winner) {
                    const playerKey = Object.keys(data.players[currentRaidTier.id]).find(
                        key => data.players[currentRaidTier.id][key].name === result.winner.name
                    );
                    if (playerKey) {
                        if (!data.players[currentRaidTier.id][playerKey].currentEquipment) {
                            data.players[currentRaidTier.id][playerKey].currentEquipment = {};
                        }
                        data.players[currentRaidTier.id][playerKey].currentEquipment[result.equipment.slot] = result.equipment;
                    }
                }
            });
            
            saveData(data);
            
            alert(`${layer}Â±§„ÅÆÂàÜÈÖçÁµêÊûú„ÇíÁ¢∫ÂÆö„Éª‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`);
            
            // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            currentDropItems = [];
            allocationResults = [];
            showMainDashboard();
        }
        
        // ÁèæÂú®„ÅÆÈÄ±„ÇíÂèñÂæó
        function getCurrentWeekString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }
        
        // „Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆöÁîªÈù¢Ôºà„Ç∑„É≥„Éó„É´Êï∞ÂÄ§ÂÖ•ÂäõÁâàÔºâ
        function showPositionPrioritySettings() {
            const app = document.querySelector('.container');
            
            // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæó
            const data = getData();
            const currentPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id] || getDefaultPositionPriorities();
            
            app.innerHTML = `
                <h1>„Éù„Ç∏„Ç∑„Éß„É≥Âà•ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö</h1>
                
                <div class="section">
                    <h2>ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö„ÅÆË™¨Êòé</h2>
                    <p>ÂêÑ„Éù„Ç∏„Ç∑„Éß„É≥„ÅÆÂÑ™ÂÖàÂ∫¶„ÇíÊï∞ÂÄ§„ÅßË®≠ÂÆö„Åó„Åæ„Åô„ÄÇÊï∞ÂÄ§„ÅåÈ´ò„ÅÑ„Åª„Å©Ë£ÖÂÇôÂàÜÈÖç„Åß„ÅÆÂÑ™ÂÖàÂ∫¶„ÅåÈ´ò„Åè„Å™„Çä„Åæ„Åô„ÄÇ</p>
                    <p>Ë£ÖÂÇôÊñπÈáùÔºàÈõ∂Âºè/„Éà„Éº„É†„Çπ„Éà„Éº„É≥Ôºâ„ÅÆÂÑ™ÂÖàÂ∫¶„Å®ÂêàÁÆó„Åó„Å¶ÊúÄÁµÇÂà§ÂÆö„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ</p>
                </div>
                
                <div class="section">
                    <h2>„Éù„Ç∏„Ç∑„Éß„É≥Âà•ÂÑ™ÂÖàÂ∫¶</h2>
                    <div class="priority-settings-grid">
                        <div class="priority-group">
                            <h3>„Çø„É≥„ÇØ</h3>
                            <div class="priority-item">
                                <label>MT:</label>
                                <input type="number" id="priority-MT" value="${currentPriorities.MT || 30}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>ST:</label>
                                <input type="number" id="priority-ST" value="${currentPriorities.ST || 25}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>„Éí„Éº„É©„Éº</h3>
                            <div class="priority-item">
                                <label>H1:</label>
                                <input type="number" id="priority-H1" value="${currentPriorities.H1 || 20}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>H2:</label>
                                <input type="number" id="priority-H2" value="${currentPriorities.H2 || 15}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>DPS</h3>
                            <div class="priority-item">
                                <label>D1:</label>
                                <input type="number" id="priority-D1" value="${currentPriorities.D1 || 50}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D2:</label>
                                <input type="number" id="priority-D2" value="${currentPriorities.D2 || 45}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D3:</label>
                                <input type="number" id="priority-D3" value="${currentPriorities.D3 || 40}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D4:</label>
                                <input type="number" id="priority-D4" value="${currentPriorities.D4 || 35}" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="priority-presets">
                        <h3>„Éó„É™„Çª„ÉÉ„Éà</h3>
                        <button onclick="applyDPSPriorityPreset()">DPSÂÑ™ÂÖà (Ê®ôÊ∫ñ)</button>
                        <button onclick="applyBalancedPreset()">„Éê„É©„É≥„ÇπÂûã</button>
                        <button onclick="applyTankPriorityPreset()">„Çø„É≥„ÇØÂÑ™ÂÖà</button>
                        <button onclick="applyHealerPriorityPreset()">„Éí„Éº„É©„ÉºÂÑ™ÂÖà</button>
                    </div>
                    
                    <div class="priority-actions">
                        <button onclick="savePositionPriorities()" class="confirm-btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                        <button onclick="showMainDashboard()" class="back-btn">‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    </div>
                </div>
            `;
            
            // „Çπ„Çø„Ç§„É´„ÅØÊó¢„Å´CSS„Çª„ÇØ„Ç∑„Éß„É≥„ÅßÂÆöÁæ©Ê∏à„Åø
        }
        
        // „Éá„Éï„Ç©„É´„Éà„ÅÆÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö„ÇíÂèñÂæó
        function getDefaultPositionPriorities() {
            return {
                'MT': 30, 'ST': 25,
                'H1': 20, 'H2': 15,
                'D1': 50, 'D2': 45, 'D3': 40, 'D4': 35
            };
        }
        
        
        // „Éó„É™„Çª„ÉÉ„ÉàÈÅ©Áî®Èñ¢Êï∞
        function applyDPSPriorityPreset() {
            document.getElementById('priority-MT').value = 30;
            document.getElementById('priority-ST').value = 25;
            document.getElementById('priority-H1').value = 20;
            document.getElementById('priority-H2').value = 15;
            document.getElementById('priority-D1').value = 50;
            document.getElementById('priority-D2').value = 45;
            document.getElementById('priority-D3').value = 40;
            document.getElementById('priority-D4').value = 35;
        }
        
        function applyBalancedPreset() {
            document.getElementById('priority-MT').value = 30;
            document.getElementById('priority-ST').value = 30;
            document.getElementById('priority-H1').value = 25;
            document.getElementById('priority-H2').value = 25;
            document.getElementById('priority-D1').value = 35;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 35;
            document.getElementById('priority-D4').value = 35;
        }
        
        function applyTankPriorityPreset() {
            document.getElementById('priority-MT').value = 50;
            document.getElementById('priority-ST').value = 45;
            document.getElementById('priority-H1').value = 30;
            document.getElementById('priority-H2').value = 25;
            document.getElementById('priority-D1').value = 40;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 30;
            document.getElementById('priority-D4').value = 25;
        }
        
        function applyHealerPriorityPreset() {
            document.getElementById('priority-MT').value = 25;
            document.getElementById('priority-ST').value = 20;
            document.getElementById('priority-H1').value = 50;
            document.getElementById('priority-H2').value = 45;
            document.getElementById('priority-D1').value = 40;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 30;
            document.getElementById('priority-D4').value = 25;
        }
        
        // „Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶„Çí‰øùÂ≠ò
        function savePositionPriorities() {
            const priorities = {
                'MT': parseInt(document.getElementById('priority-MT').value) || 30,
                'ST': parseInt(document.getElementById('priority-ST').value) || 25,
                'H1': parseInt(document.getElementById('priority-H1').value) || 20,
                'H2': parseInt(document.getElementById('priority-H2').value) || 15,
                'D1': parseInt(document.getElementById('priority-D1').value) || 50,
                'D2': parseInt(document.getElementById('priority-D2').value) || 45,
                'D3': parseInt(document.getElementById('priority-D3').value) || 40,
                'D4': parseInt(document.getElementById('priority-D4').value) || 35
            };
            
            const data = getData();
            if (!data.positionPriorities) {
                data.positionPriorities = {};
            }
            data.positionPriorities[currentRaidTier.id] = priorities;
            
            setData(data);
            alert('„Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            showMainDashboard();
        }
        
        // „ÉÜ„Çπ„Éà„Éá„Éº„ÇøÁîüÊàêÊ©üËÉΩ
        function generateTestData() {
            if (confirm('„ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇíÁîüÊàê„Åô„Çã„Å®ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                createTestRaidTier();
            }
        }
        
        function createTestRaidTier() {
            const data = getData();
            
            // „ÉÜ„Çπ„ÉàÁî®„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰ΩúÊàê
            const testTier = {
                id: 'test_' + Date.now().toString(),
                name: '7.2Èõ∂Âºè„ÉÜ„Çπ„Éà',
                description: '„ÉÜ„Çπ„ÉàÁî®„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Ôºà„É©„É≥„ÉÄ„É†Ë£ÖÂÇôÊñπÈáùÔºâ',
                createdAt: new Date().toISOString(),
                isActive: true
            };
            
            // Êó¢Â≠ò„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÉÜ„Ç£„Ç¢„ÇíÁÑ°ÂäπÂåñ
            data.raidTiers.forEach(tier => tier.isActive = false);
            data.raidTiers.push(testTier);
            data.activeRaidTierId = testTier.id;
            
            // „É©„É≥„ÉÄ„É†Ë£ÖÂÇôÊñπÈáùÁîüÊàêÈñ¢Êï∞
            function generateRandomEquipmentPolicy() {
                const slots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
                const policy = {};
                slots.forEach(slot => {
                    // 70%„ÅÆÁ¢∫Áéá„ÅßÈõ∂Âºè„ÄÅ30%„ÅÆÁ¢∫Áéá„Åß„Éà„Éº„É†„Çπ„Éà„Éº„É≥
                    policy[slot] = Math.random() < 0.7 ? 'Èõ∂Âºè' : '„Éà„Éº„É†„Çπ„Éà„Éº„É≥';
                });
                return policy;
            }
            
            // „ÉÜ„Çπ„ÉàÁî®„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø
            const testPlayers = {
                'MT': {
                    id: 'test_mt',
                    name: '„Çø„É≥„ÇØÂ§™ÈÉé',
                    characterName: 'Tank Taro',
                    position: 'MT',
                    job: '„Éä„Ç§„Éà',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'Ê≠¶Âô®': { itemLevel: 710 }, 'È†≠': { itemLevel: 710 }, 'ËÉ¥': { itemLevel: 710 }
                    },
                    weaponWishes: [
                        { jobName: '„Éä„Ç§„Éà', priority: 1 }
                    ]
                },
                'ST': {
                    id: 'test_st',
                    name: '„Çµ„Éñ„Çø„É≥Ëä±Â≠ê',
                    characterName: 'SubTank Hanako',
                    position: 'ST',
                    job: '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'Ê≠¶Âô®': { itemLevel: 710 }, 'ËÉ¥': { itemLevel: 710 }
                    },
                    weaponWishes: [
                        { jobName: '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº', priority: 1 }
                    ]
                },
                'H1': {
                    id: 'test_h1',
                    name: '„Éí„Éº„É©„Éº‰∏ÄÈÉé',
                    characterName: 'Healer Ichiro',
                    position: 'H1',
                    job: 'ÁôΩÈ≠îÈÅìÂ£´',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'Ê≠¶Âô®': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'ÁôΩÈ≠îÈÅìÂ£´', priority: 1 }
                    ]
                },
                'H2': {
                    id: 'test_h2',
                    name: '„Éê„É™„Ç¢Ê¨°ÈÉé',
                    characterName: 'Barrier Jiro',
                    position: 'H2',
                    job: 'Â≠¶ËÄÖ',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'È†≠': { itemLevel: 720 }, 'Êâã': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'Â≠¶ËÄÖ', priority: 1 }
                    ]
                },
                'D1': {
                    id: 'test_d1',
                    name: '„É°„É¨„Éº‰∏âÈÉé',
                    characterName: 'Melee Saburo',
                    position: 'D1',
                    job: 'Á´úÈ®éÂ£´',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'Ê≠¶Âô®': { itemLevel: 710 }
                    },
                    weaponWishes: [
                        { jobName: 'Á´úÈ®éÂ£´', priority: 1 },
                        { jobName: '„É™„Éº„Éë„Éº', priority: 2 }
                    ]
                },
                'D2': {
                    id: 'test_d2',
                    name: '„É°„É¨„ÉºÂõõÈÉé',
                    characterName: 'Melee Shiro',
                    position: 'D2',
                    job: 'ÂøçËÄÖ',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {},
                    weaponWishes: [
                        { jobName: 'ÂøçËÄÖ', priority: 1 }
                    ]
                },
                'D3': {
                    id: 'test_d3',
                    name: '„É¨„É≥„Ç∏‰∫îÈÉé',
                    characterName: 'Range Goro',
                    position: 'D3',
                    job: 'Ê©üÂ∑•Â£´',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'ËÉ¥': { itemLevel: 720 }, 'ËÑö': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'Ê©üÂ∑•Â£´', priority: 1 }
                    ]
                },
                'D4': {
                    id: 'test_d4',
                    name: '„Ç≠„É£„ÇπÂÖ≠ÈÉé',
                    characterName: 'Caster Rokuro',
                    position: 'D4',
                    job: 'ÈªíÈ≠îÈÅìÂ£´',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'ËÄ≥': { itemLevel: 720 }, 'È¶ñ': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'ÈªíÈ≠îÈÅìÂ£´', priority: 1 },
                        { jobName: 'Ëµ§È≠îÈÅìÂ£´', priority: 2 }
                    ]
                }
            };
            
            // „Éá„Éº„Çø‰øùÂ≠ò
            if (!data.players) data.players = {};
            data.players[testTier.id] = testPlayers;
            
            if (!data.allocations) data.allocations = {};
            data.allocations[testTier.id] = [];
            
            saveData(data);
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Êõ¥Êñ∞
            currentRaidTier = testTier;
            
            alert('üß™ „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇíÁîüÊàê„Åó„Åæ„Åó„ÅüÔºÅ\\n\\nüìã ‰ΩúÊàêÂÜÖÂÆπÔºö\\n‚Ä¢ 8‰∫∫„ÅÆ„ÉÜ„Çπ„Éà„Éó„É¨„Ç§„É§„ÉºÔºàÂêÑ„Éù„Ç∏„Ç∑„Éß„É≥Ôºâ\\n‚Ä¢ „É©„É≥„ÉÄ„É†Ë£ÖÂÇôÊñπÈáùË®≠ÂÆöÔºàÈõ∂Âºè70%Ôºö„Éà„Éº„É†30%Ôºâ\\n‚Ä¢ Ë£ÖÂÇôÊ†ºÂ∑Æ„ÅÆÂÜçÁèæÔºàIL710-720Ôºâ\\n‚Ä¢ Ê≠¶Âô®Â∏åÊúõË®≠ÂÆöÔºàË§áÊï∞Â∏åÊúõÂê´„ÇÄÔºâ\\n‚Ä¢ „Éá„Éï„Ç©„É´„Éà„Éù„Ç∏„Ç∑„Éß„É≥ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö\\n\\n‚úÖ „Åô„Åê„Å´ÂêÑÂ±§„ÅÆÂàÜÈÖç„ÉÜ„Çπ„Éà„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ\\n„Äå„É¨„Ç§„Éâ„ÇØ„É™„Ç¢„Äç„Éú„Çø„É≥„Åã„ÇâË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            showMainDashboard();
        }
        
        function exportData() {
            const data = getData();
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ff14_gear_data_${currentRaidTier.name}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initStorage();
            showRaidTierSelection();
        });
    </script>
</body>
</html>