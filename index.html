<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14é›¶å¼è£…å‚™åˆ†é…ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-status.offline {
            background-color: #6c757d;
        }

        .sync-status.syncing {
            background-color: #f39c12;
        }

        .sync-status button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
        }

        .login-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .login-form h2 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .token-input {
            margin: 20px 0;
        }

        .token-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .token-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .token-input input:focus {
            border-color: #3498db;
            outline: none;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .login-form button:hover {
            background-color: #2980b9;
        }

        .offline-btn {
            background-color: #6c757d !important;
        }

        .offline-btn:hover {
            background-color: #5a6268 !important;
        }

        .help-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .help-section summary {
            cursor: pointer;
            font-weight: 600;
            color: #3498db;
        }

        .help-section ol {
            margin-top: 10px;
            padding-left: 20px;
        }

        /* åŸºæœ¬ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #ffffff;
            color: #2c3e50;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* æ—¢å­˜æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±åˆ */
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        /* ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tier-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tier-item h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .tier-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .tier-item small {
            color: #999;
            font-size: 12px;
        }

        .new-tier-form {
            margin-top: 30px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .new-tier-form h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .new-tier-form input {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .new-tier-form input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .new-tier-form button {
            background-color: #27ae60;
            margin-top: 10px;
        }

        .new-tier-form button:hover {
            background-color: #219a52;
        }

        /* ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; padding: 50px;">
            <h1>Loading...</h1>
            <p>ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...</p>
        </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <div id="debug-info" class="debug-info">
        <div>Status: <span id="debug-status">Initializing</span></div>
        <div>Auth: <span id="debug-auth">Checking</span></div>
        <div>Error: <span id="debug-error">None</span></div>
    </div>

    <!-- GitHub APIé€£æºã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="js/github-api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-sync.js"></script>
    
    <script>
        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°
        function updateDebugInfo(status, auth = null, error = null) {
            document.getElementById('debug-status').textContent = status;
            if (auth !== null) document.getElementById('debug-auth').textContent = auth;
            if (error !== null) document.getElementById('debug-error').textContent = error;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let githubAPI = null;
        let authManager = null;
        let dataSync = null;
        let currentRaidTier = null;

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                updateDebugInfo('Starting initialization');
                await initializeApp();
            } catch (error) {
                updateDebugInfo('Initialization failed', null, error.message);
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showErrorScreen('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        async function initializeApp() {
            try {
                updateDebugInfo('Creating API instances');
                
                // GitHub APIåˆæœŸåŒ–
                githubAPI = new GitHubAPI();
                authManager = new AuthManager(githubAPI);
                dataSync = new DataSyncManager(githubAPI, authManager);
                
                updateDebugInfo('Checking authentication');

                // èªè¨¼çŠ¶æ…‹ç¢ºèª
                if (authManager.isAuthenticated()) {
                    updateDebugInfo('Validating token');
                    const isValid = await githubAPI.validateToken();
                    if (!isValid) {
                        updateDebugInfo('Token invalid, logging out');
                        authManager.logout();
                        showLoginScreen();
                        return;
                    }
                    
                    updateDebugInfo('Loading app data', 'Authenticated');
                    // èªè¨¼æ¸ˆã¿ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§é–‹å§‹
                    await loadAndStartApp();
                } else {
                    updateDebugInfo('Not authenticated', 'None');
                    // æœªèªè¨¼ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
                    showLoginScreen();
                }
            } catch (error) {
                updateDebugInfo('Init error', null, error.message);
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showErrorScreen('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        async function loadAndStartApp() {
            try {
                updateDebugInfo('Loading data');
                
                // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
                addSyncStatusIndicator();
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const data = await dataSync.loadAllData();
                currentRaidTier = data.raidTiers.find(t => t.id === data.activeRaidTierId);
                
                updateDebugInfo('Showing main screen');
                
                // ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
                if (data.raidTiers.length === 0) {
                    showRaidTierSelection();
                } else if (currentRaidTier) {
                    showMainDashboard();
                } else {
                    showRaidTierSelection();
                }
            } catch (error) {
                updateDebugInfo('Load error', null, error.message);
                console.error('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã—ã¾ã™ã€‚');
                showRaidTierSelection();
            }
        }

        function showLoginScreen() {
            updateDebugInfo('Showing login screen');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <div class="login-container">
                    <div class="login-form">
                        <h1>FF14é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <h2>GitHubèªè¨¼</h2>
                        <p>ãƒãƒ¼ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«GitHubãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                        
                        <div class="token-input">
                            <label for="github-token">GitHub Personal Access Token:</label>
                            <input type="password" id="github-token" placeholder="ghp_..." />
                            <button onclick="attemptLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                        </div>
                        
                        <div class="help-section">
                            <details>
                                <summary>ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—æ–¹æ³•</summary>
                                <ol>
                                    <li>GitHub â†’ Settings â†’ Developer settings</li>
                                    <li>Personal access tokens â†’ Tokens (classic)</li>
                                    <li>Generate new token (classic)</li>
                                    <li>repo ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ç”Ÿæˆ</li>
                                </ol>
                            </details>
                        </div>
                        
                        <button onclick="useOfflineMode()" class="offline-btn">
                            ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ
                        </button>
                    </div>
                </div>
            `;
        }

        function showErrorScreen(message) {
            const app = document.querySelector('.container');
            app.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h1 style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h1>
                    <p style="margin: 20px 0;">${message}</p>
                    <button onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
                    <button onclick="useOfflineMode()">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ</button>
                </div>
            `;
        }

        async function attemptLogin() {
            try {
                updateDebugInfo('Attempting login');
                const token = document.getElementById('github-token').value.trim();
                
                if (!token) {
                    alert('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const result = await authManager.login(token);
                
                if (result.success) {
                    updateDebugInfo('Login successful', result.user.login);
                    alert(`ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${result.user.login}`);
                    await loadAndStartApp();
                } else {
                    updateDebugInfo('Login failed', null, result.error);
                    alert(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${result.error}`);
                }
            } catch (error) {
                updateDebugInfo('Login error', null, error.message);
                alert(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function useOfflineMode() {
            if (confirm('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ‡ãƒ¼ã‚¿ã®å…±æœ‰ãŒã§ãã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                updateDebugInfo('Using offline mode', 'Offline');
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ã®åˆæœŸåŒ–
                initializeOfflineMode();
                showRaidTierSelection();
                addSyncStatusIndicator();
            }
        }

        function initializeOfflineMode() {
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
            const defaultData = {
                raidTiers: [],
                activeRaidTierId: null,
                players: {},
                allocations: {},
                settings: {
                    teamMembers: [],
                    permissions: {}
                }
            };
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ä½œæˆ
            if (!localStorage.getItem('ff14_gear_data')) {
                localStorage.setItem('ff14_gear_data', JSON.stringify(defaultData));
            }
        }

        function addSyncStatusIndicator() {
            // æ—¢å­˜ã®åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‰Šé™¤
            const existing = document.getElementById('sync-status');
            if (existing) existing.remove();

            const syncIndicator = document.createElement('div');
            syncIndicator.id = 'sync-status';
            syncIndicator.className = `sync-status ${authManager && authManager.isAuthenticated() ? '' : 'offline'}`;
            
            const statusText = authManager && authManager.isAuthenticated() ? 
                `ğŸ”„ ${authManager.getUsername()}` : 
                'ğŸ“´ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
            
            syncIndicator.innerHTML = `
                <span id="sync-text">${statusText}</span>
                <button onclick="manualSync()" ${!authManager || !authManager.isAuthenticated() ? 'disabled' : ''}>
                    åŒæœŸ
                </button>
                ${authManager && authManager.isAuthenticated() ? '<button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>' : ''}
            `;
            
            document.body.appendChild(syncIndicator);
        }

        async function manualSync() {
            if (!authManager || !authManager.isAuthenticated()) return;
            
            const syncStatus = document.getElementById('sync-status');
            syncStatus.className = 'sync-status syncing';
            
            try {
                const data = getLocalData();
                const result = await dataSync.saveAllData(data);
                
                if (result.success) {
                    alert('åŒæœŸå®Œäº†');
                } else {
                    alert(`åŒæœŸå¤±æ•—: ${result.error}`);
                }
            } catch (error) {
                alert(`åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                syncStatus.className = `sync-status ${authManager.isAuthenticated() ? '' : 'offline'}`;
            }
        }

        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                authManager.logout();
                location.reload();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢æ•°
        function getLocalData() {
            return dataSync ? dataSync.getLocalData() : 
                   JSON.parse(localStorage.getItem('ff14RaidData') || '{"raidTiers":[],"activeRaidTierId":null,"players":{},"allocations":{}}');
        }

        async function saveData(data) {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã«å³åº§ã«ä¿å­˜
            localStorage.setItem('ff14RaidData', JSON.stringify(data));
            
            // GitHubåŒæœŸï¼ˆèªè¨¼æ¸ˆã¿ã®å ´åˆã®ã¿ï¼‰
            if (authManager && authManager.isAuthenticated()) {
                try {
                    await dataSync.saveAllData(data);
                } catch (error) {
                    console.error('GitHubåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã¯å®Œäº†ã—ã¦ã„ã‚‹ã®ã§ç¶šè¡Œ
                }
            }
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠç”»é¢
        function showRaidTierSelection() {
            updateDebugInfo('Showing raid tier selection');
            const app = document.querySelector('.container');
            const data = getLocalData();
            const raidTiers = data.raidTiers || [];
            
            app.innerHTML = `
                <h1>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                
                <div class="section">
                    <h2>ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ</h2>
                    <div id="existing-tiers">
                        ${raidTiers.length > 0 ? `
                            <h3>æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢</h3>
                            <div class="tier-list">
                                ${raidTiers.map(tier => `
                                    <div class="tier-item" onclick="selectRaidTier('${tier.id}')">
                                        <h4>${tier.name}</h4>
                                        <p>${tier.description || 'èª¬æ˜ãªã—'}</p>
                                        <small>ä½œæˆæ—¥: ${new Date(tier.createdAt).toLocaleDateString('ja-JP')}</small>
                                        <div style="margin-top: 10px;">
                                            <button onclick="event.stopPropagation(); deleteRaidTier('${tier.id}', '${tier.name}')" 
                                                    style="background-color: #e74c3c; font-size: 11px; padding: 4px 8px;">
                                                å‰Šé™¤
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>ã¾ã ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>'}
                    </div>
                    
                    <div class="new-tier-form">
                        <h3>æ–°è¦ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ç™»éŒ²</h3>
                        <input type="text" id="tier-name" placeholder="ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢åï¼ˆä¾‹ï¼š7.2é›¶å¼ï¼‰" required>
                        <input type="text" id="tier-description" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰">
                        <button onclick="createNewRaidTier()">ç™»éŒ²</button>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 14px; color: #666;">
                        ${authManager && authManager.isAuthenticated() ? 
                            '<p style="color: green;">âœ… GitHubèªè¨¼æ¸ˆã¿ - ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™</p>' : 
                            '<p style="color: orange;">âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ - ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜</p>'
                        }
                    </div>
                </div>
            `;
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ
        async function selectRaidTier(tierId) {
            const data = getLocalData();
            const tier = data.raidTiers.find(t => t.id === tierId);
            
            if (tier) {
                currentRaidTier = tier;
                data.activeRaidTierId = tierId;
                await saveData(data);
                showInitialSetup();
            }
        }

        // æ–°è¦ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ç™»éŒ²
        async function createNewRaidTier() {
            const name = document.getElementById('tier-name').value.trim();
            const description = document.getElementById('tier-description').value.trim();
            
            if (!name) {
                alert('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const data = getLocalData();
            if (!data.raidTiers) data.raidTiers = [];
            
            const newTier = {
                id: Date.now().toString(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                isActive: false
            };
            
            data.raidTiers.push(newTier);
            await saveData(data);
            
            // ä½œæˆå¾Œã«é¸æŠ
            selectRaidTier(newTier.id);
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢å‰Šé™¤
        async function deleteRaidTier(tierId, tierName) {
            if (!confirm(`ã€Œ${tierName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            const data = getLocalData();
            
            // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢è‡ªä½“ã‚’å‰Šé™¤
            data.raidTiers = data.raidTiers.filter(tier => tier.id !== tierId);
            
            // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
            if (data.players && data.players[tierId]) {
                delete data.players[tierId];
            }
            if (data.allocations && data.allocations[tierId]) {
                delete data.allocations[tierId];
            }
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ†ã‚£ã‚¢ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
            if (data.activeRaidTierId === tierId) {
                if (data.raidTiers.length > 0) {
                    data.activeRaidTierId = data.raidTiers[0].id;
                    currentRaidTier = data.raidTiers[0];
                } else {
                    data.activeRaidTierId = null;
                    currentRaidTier = null;
                }
            }
            
            await saveData(data);
            alert(`ã€Œ${tierName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
            
            // ç”»é¢ã‚’å†æç”»
            showRaidTierSelection();
        }

        function showMainDashboard() {
            updateDebugInfo('Showing main dashboard');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${currentRaidTier ? currentRaidTier.name : 'ãƒ¡ã‚¤ãƒ³'} - ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>è¨­å®šç®¡ç†</h3>
                        <button onclick="showInitialSetup()">ç™»éŒ²å†…å®¹ç¢ºèªãƒ»å¤‰æ›´</button>
                        <button onclick="showPositionPrioritySettings()">ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦è¨­å®š</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ãƒ¬ã‚¤ãƒ‰ã‚¯ãƒªã‚¢</h3>
                        <button onclick="showLayerAllocation(1)">1å±¤ã‚¯ãƒªã‚¢</button>
                        <button onclick="showLayerAllocation(2)">2å±¤ã‚¯ãƒªã‚¢</button>
                        <button onclick="showLayerAllocation(3)">3å±¤ã‚¯ãƒªã‚¢</button>
                        <button onclick="showLayerAllocation(4)">4å±¤ã‚¯ãƒªã‚¢</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>å±¥æ­´ãƒ»çµ±è¨ˆ</h3>
                        <button onclick="showHistory()">é…å¸ƒå±¥æ­´ãƒ»è£…å‚™çŠ¶æ³</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ãã®ä»–</h3>
                        <button onclick="showRaidTierSelection()">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢å¤‰æ›´</button>
                        <button onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button onclick="generateTestData()" style="background-color: #e67e22; border-color: #d35400;">ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                    </div>
                </div>
                
                <div class="dashboard-status">
                    <h3>ä»Šé€±ã®é€²è¡ŒçŠ¶æ³</h3>
                    <div id="weekly-progress">
                        <p>å„å±¤ã®ã‚¯ãƒªã‚¢çŠ¶æ³ã¨è£…å‚™åˆ†é…ã®é€²æ—ã‚’è¡¨ç¤ºäºˆå®š</p>
                        ${authManager && authManager.isAuthenticated() ? 
                            '<p style="color: green; font-size: 12px;">âœ… GitHubåŒæœŸæœ‰åŠ¹ - ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒå…±æœ‰ã•ã‚Œã¦ã„ã¾ã™</p>' : 
                            '<p style="color: orange; font-size: 12px;">âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ - ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿</p>'
                        }
                    </div>
                </div>
            `;
            
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            if (!document.getElementById('dashboard-styles')) {
                const style = document.createElement('style');
                style.id = 'dashboard-styles';
                style.textContent = `
                    .dashboard-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 15px;
                        margin: 15px 0;
                    }
                    @media (max-width: 1400px) {
                        .dashboard-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    @media (max-width: 800px) {
                        .dashboard-grid {
                            grid-template-columns: 1fr;
                        }
                    }
                    .dashboard-card {
                        background-color: #ffffff;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        text-align: center;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    }
                    .dashboard-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    }
                    .dashboard-card h3 {
                        color: #2c3e50;
                        margin-bottom: 10px;
                        font-size: 16px;
                        font-weight: 600;
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 8px;
                    }
                    .dashboard-card button {
                        display: block;
                        width: 100%;
                        margin: 8px 0;
                        padding: 10px 8px;
                        font-size: 13px;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                    }
                    .dashboard-card button:hover {
                        transform: translateY(-1px);
                    }
                    .dashboard-status {
                        margin-top: 20px;
                        padding: 15px;
                        background-color: #f8f9fa;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .dashboard-status h3 {
                        color: #2c3e50;
                        margin-bottom: 15px;
                        font-size: 16px;
                        border-bottom: 2px solid #3498db;
                        padding-bottom: 8px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function showInitialSetup() {
            updateDebugInfo('Showing initial setup');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>åˆæœŸè¨­å®š - ${currentRaidTier ? currentRaidTier.name : 'ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢'}</h1>
                
                <div class="setup-navigation">
                    <button class="nav-btn active" onclick="showMemberSetup()">ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</button>
                    <button class="nav-btn" onclick="showEquipmentPolicySetup()">è£…å‚™è¨­å®š</button>
                    <button class="nav-btn" onclick="showWeaponWishSetup()">æ­¦å™¨è¨­å®š</button>
                    <button class="nav-btn setup-complete-btn" onclick="completeSetup()">è¨­å®šå®Œäº†</button>
                </div>
                
                <div id="setup-content">
                    <!-- è¨­å®šå†…å®¹ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                <div class="setup-actions">
                    <button onclick="showRaidTierSelection()">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠã«æˆ»ã‚‹</button>
                </div>
            `;
            
            // åˆæœŸè¨­å®šã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            if (!document.getElementById('initial-setup-styles')) {
                const style = document.createElement('style');
                style.id = 'initial-setup-styles';
                style.textContent = `
                    .setup-navigation {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #e9ecef;
                        padding-bottom: 10px;
                    }
                    .nav-btn {
                        padding: 12px 20px;
                        background-color: #ffffff;
                        border: 1px solid #ddd;
                        color: #2c3e50;
                        cursor: pointer;
                        border-radius: 8px 8px 0 0;
                        font-size: 14px;
                        transition: all 0.2s ease;
                    }
                    .nav-btn.active {
                        background-color: #3498db;
                        color: white;
                        border-color: #3498db;
                        border-bottom: 2px solid #3498db;
                    }
                    .nav-btn:hover:not(.active) {
                        background-color: #f8f9fa;
                        border-color: #3498db;
                    }
                    .setup-complete-btn {
                        background-color: #27ae60 !important;
                        color: white !important;
                        border-color: #27ae60 !important;
                    }
                    .setup-complete-btn:hover {
                        background-color: #219a52 !important;
                    }
                    .setup-actions {
                        margin-top: 30px;
                        text-align: center;
                        padding-top: 20px;
                        border-top: 1px solid #e9ecef;
                    }
                    .member-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    .member-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .member-card h3 {
                        margin: 0 0 15px 0;
                        color: #2c3e50;
                        text-align: center;
                        font-weight: 600;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .member-card input, .member-card select {
                        width: 100%;
                        margin: 8px 0;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        box-sizing: border-box;
                        font-size: 14px;
                    }
                    .member-card input:focus, .member-card select:focus {
                        outline: none;
                        border-color: #3498db;
                        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’è¡¨ç¤º
            showMemberSetup();
        }

        function showMemberSetup() {
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>8åã®ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
                    <p>å›ºå®šãƒ‘ãƒ¼ãƒ†ã‚£ã®8åã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    <div class="member-grid">
                        ${['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'].map(position => `
                            <div class="member-card">
                                <h3>${position}</h3>
                                <input type="text" id="name-${position}" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" />
                                <input type="text" id="char-${position}" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å" />
                                <select id="job-${position}">
                                    <option value="">ã‚¸ãƒ§ãƒ–ã‚’é¸æŠ</option>
                                    ${getJobOptionsForPosition(position)}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="saveMemberSettings()" style="background-color: #27ae60; color: white; padding: 12px 30px; font-size: 16px;">
                            ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¾©å…ƒ
            loadMemberData();
        }

        function getJobOptionsForPosition(position) {
            const jobsByPosition = {
                'MT': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                'ST': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                'H1': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«'],
                'H2': ['å­¦è€…', 'è³¢è€…'],
                'D1': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                'D2': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                'D3': ['åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­', 'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'],
                'D4': ['åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­', 'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼']
            };
            
            return jobsByPosition[position].map(job => `<option value="${job}">${job}</option>`).join('');
        }

        function loadMemberData() {
            const data = getLocalData();
            if (data.players && data.players[currentRaidTier.id]) {
                const tierPlayers = data.players[currentRaidTier.id];
                for (const [position, player] of Object.entries(tierPlayers)) {
                    const nameInput = document.getElementById(`name-${position}`);
                    const charInput = document.getElementById(`char-${position}`);
                    const jobSelect = document.getElementById(`job-${position}`);
                    
                    if (nameInput) nameInput.value = player.name || '';
                    if (charInput) charInput.value = player.characterName || '';
                    if (jobSelect) jobSelect.value = player.job || '';
                }
            }
        }

        async function saveMemberSettings() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const players = {};
            
            for (const position of positions) {
                const name = document.getElementById(`name-${position}`).value.trim();
                const characterName = document.getElementById(`char-${position}`).value.trim();
                const job = document.getElementById(`job-${position}`).value;
                
                if (!name || !characterName || !job) {
                    alert(`${position}ã®è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                players[position] = {
                    id: Date.now().toString() + position,
                    name: name,
                    characterName: characterName,
                    position: position,
                    job: job,
                    equipmentPolicy: {},
                    currentEquipment: {},
                    weaponWishes: []
                };
            }
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            const data = getLocalData();
            if (!data.players) data.players = {};
            data.players[currentRaidTier.id] = players;
            
            await saveData(data);
            alert('ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        function showEquipmentPolicySetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            
            const data = getLocalData();
            const players = data.players && data.players[currentRaidTier.id];
            
            if (!players || Object.keys(players).length === 0) {
                const content = document.getElementById('setup-content');
                content.innerHTML = `
                    <div class="section">
                        <h2>è£…å‚™æ–¹é‡è¨­å®š</h2>
                        <p style="color: #e74c3c;">å…ˆã«ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="showMemberSetup()">ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã«æˆ»ã‚‹</button>
                    </div>
                `;
                return;
            }
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>è£…å‚™æ–¹é‡è¨­å®š</h2>
                    <p>å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®è£…å‚™éƒ¨ä½ã”ã¨ã«ã€Œé›¶å¼ã€ã¾ãŸã¯ã€Œãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div class="policy-grid">
                        ${Object.keys(players).map(position => `
                            <div class="policy-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                <div class="equipment-slots">
                                    ${['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'].map(slot => {
                                        const currentPolicy = players[position].equipmentPolicy && players[position].equipmentPolicy[slot] || 'é›¶å¼';
                                        return `
                                        <div class="slot-policy">
                                            <label>${slot}:</label>
                                            <select id="policy-${position}-${slot}">
                                                <option value="é›¶å¼" ${currentPolicy === 'é›¶å¼' ? 'selected' : ''} style="background-color: #e8f5e8;">é›¶å¼</option>
                                                <option value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³" ${currentPolicy === 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³' ? 'selected' : ''} style="background-color: #f0f8ff;">ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³</option>
                                            </select>
                                        </div>
                                    `;}).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="policy-actions">
                        <button onclick="setAllToSavage()">å…¨ã¦é›¶å¼ã«è¨­å®š</button>
                        <button onclick="setAllToTomestone()">å…¨ã¦ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã«è¨­å®š</button>
                        <button onclick="saveEquipmentPolicy()" style="background-color: #27ae60;">è£…å‚™æ–¹é‡ã‚’ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            // è£…å‚™æ–¹é‡è¨­å®šã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            if (!document.getElementById('policy-styles')) {
                const style = document.createElement('style');
                style.id = 'policy-styles';
                style.textContent = `
                    .policy-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    @media (max-width: 1200px) {
                        .policy-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    .policy-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .policy-card h3 {
                        margin: 0 0 8px 0;
                        color: #2c3e50;
                        font-weight: 600;
                        text-align: center;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .policy-card small {
                        display: block;
                        text-align: center;
                        color: #666;
                        margin-bottom: 15px;
                    }
                    .equipment-slots {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 8px;
                    }
                    .slot-policy {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .slot-policy label {
                        width: 50px;
                        font-size: 12px;
                        font-weight: 600;
                        color: #2c3e50;
                    }
                    .slot-policy select {
                        flex: 1;
                        padding: 6px;
                        margin: 0;
                        font-size: 12px;
                        border-radius: 4px;
                        border: 1px solid #ddd;
                    }
                    .policy-actions {
                        text-align: center;
                        margin-top: 20px;
                        padding-top: 15px;
                        border-top: 1px solid #e9ecef;
                    }
                    .policy-actions button {
                        margin: 0 5px;
                        padding: 10px 20px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function setAllToSavage() {
            const selects = document.querySelectorAll('select[id^="policy-"]');
            selects.forEach(select => {
                select.value = 'é›¶å¼';
            });
        }

        function setAllToTomestone() {
            const selects = document.querySelectorAll('select[id^="policy-"]');
            selects.forEach(select => {
                select.value = 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³';
            });
        }

        async function saveEquipmentPolicy() {
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
            
            for (const position of Object.keys(players)) {
                if (!players[position].equipmentPolicy) {
                    players[position].equipmentPolicy = {};
                }
                
                for (const slot of slots) {
                    const selectElement = document.getElementById(`policy-${position}-${slot}`);
                    if (selectElement) {
                        players[position].equipmentPolicy[slot] = selectElement.value;
                    }
                }
            }
            
            await saveData(data);
            alert('è£…å‚™æ–¹é‡ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        function showWeaponWishSetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[2].classList.add('active');
            
            const data = getLocalData();
            const players = data.players && data.players[currentRaidTier.id];
            
            if (!players || Object.keys(players).length === 0) {
                const content = document.getElementById('setup-content');
                content.innerHTML = `
                    <div class="section">
                        <h2>æ­¦å™¨å¸Œæœ›è¨­å®š</h2>
                        <p style="color: #e74c3c;">å…ˆã«ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="showMemberSetup()">ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã«æˆ»ã‚‹</button>
                    </div>
                `;
                return;
            }
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨å¸Œæœ›è¨­å®š</h2>
                    <p>4å±¤ã§ãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹æ­¦å™¨ã¸ã®å¸Œæœ›ã‚’å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç™»éŒ²ã§ãã¾ã™ã€‚å„ªå…ˆé †ä½ã‚‚è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div class="weapon-wish-grid">
                        ${Object.keys(players).map(position => `
                            <div class="wish-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                
                                <div class="current-wishes" id="wishes-${position}">
                                    <!-- ç¾åœ¨ã®å¸Œæœ›ãƒªã‚¹ãƒˆ -->
                                </div>
                                
                                <div class="add-wish">
                                    <select id="job-wish-${position}">
                                        <option value="">å¸Œæœ›ã‚¸ãƒ§ãƒ–ã‚’é¸æŠ</option>
                                        ${getAllJobOptions()}
                                    </select>
                                    <input type="number" id="priority-${position}" placeholder="å„ªå…ˆåº¦" min="1" max="10" value="1">
                                    <button onclick="addWeaponWish('${position}')" style="background-color: #27ae60; padding: 8px 12px; font-size: 12px;">è¿½åŠ </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="weapon-actions">
                        <button onclick="saveWeaponWishes()" style="background-color: #27ae60;">æ­¦å™¨å¸Œæœ›ã‚’ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            // æ­¦å™¨å¸Œæœ›è¨­å®šã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            if (!document.getElementById('weapon-styles')) {
                const style = document.createElement('style');
                style.id = 'weapon-styles';
                style.textContent = `
                    .weapon-wish-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    @media (max-width: 1200px) {
                        .weapon-wish-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    .wish-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .wish-card h3 {
                        margin: 0 0 8px 0;
                        color: #2c3e50;
                        font-weight: 600;
                        text-align: center;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .wish-card small {
                        display: block;
                        text-align: center;
                        color: #666;
                        margin-bottom: 15px;
                    }
                    .current-wishes {
                        min-height: 60px;
                        margin-bottom: 15px;
                        padding: 10px;
                        border: 1px solid #e9ecef;
                        border-radius: 4px;
                        background-color: #f8f9fa;
                    }
                    .wish-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 6px 10px;
                        margin: 4px 0;
                        background-color: #ffffff;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-size: 12px;
                    }
                    .wish-priority {
                        background-color: #3498db;
                        color: white;
                        padding: 2px 6px;
                        border-radius: 3px;
                        font-size: 10px;
                        font-weight: bold;
                    }
                    .remove-wish {
                        background-color: #95a5a6;
                        color: white;
                        border: none;
                        padding: 2px 6px;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 10px;
                    }
                    .remove-wish:hover {
                        background-color: #7f8c8d;
                    }
                    .add-wish {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                        flex-wrap: wrap;
                    }
                    .add-wish select {
                        flex: 1;
                        min-width: 120px;
                        padding: 6px;
                        margin: 0;
                        font-size: 12px;
                    }
                    .add-wish input {
                        width: 60px;
                        padding: 6px;
                        margin: 0;
                        font-size: 12px;
                    }
                    .weapon-actions {
                        text-align: center;
                        margin-top: 20px;
                        padding-top: 15px;
                        border-top: 1px solid #e9ecef;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // æ—¢å­˜ã®å¸Œæœ›ã‚’è¡¨ç¤º
            Object.keys(players).forEach(position => {
                updateWishDisplay(position);
            });
        }

        function getAllJobOptions() {
            const allJobs = [
                'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…',
                'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­', 'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'
            ];
            
            return allJobs.map(job => `<option value="${job}">${job}</option>`).join('');
        }

        function addWeaponWish(position) {
            const jobSelect = document.getElementById(`job-wish-${position}`);
            const priorityInput = document.getElementById(`priority-${position}`);
            
            const job = jobSelect.value;
            const priority = parseInt(priorityInput.value) || 1;
            
            if (!job) {
                alert('å¸Œæœ›ã‚¸ãƒ§ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            
            if (!players[position].weaponWishes) {
                players[position].weaponWishes = [];
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (players[position].weaponWishes.some(wish => wish.job === job)) {
                alert('ãã®ã‚¸ãƒ§ãƒ–ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }
            
            players[position].weaponWishes.push({
                job: job,
                priority: priority,
                addedAt: new Date().toISOString()
            });
            
            // å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆ
            players[position].weaponWishes.sort((a, b) => a.priority - b.priority);
            
            // è¡¨ç¤ºæ›´æ–°
            updateWishDisplay(position);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            jobSelect.value = '';
            priorityInput.value = '1';
        }

        function removeWeaponWish(position, job) {
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            
            players[position].weaponWishes = players[position].weaponWishes.filter(wish => wish.job !== job);
            
            updateWishDisplay(position);
        }

        function updateWishDisplay(position) {
            const data = getLocalData();
            const players = data.players[currentRaidTier.id];
            const wishesContainer = document.getElementById(`wishes-${position}`);
            
            if (!players[position].weaponWishes || players[position].weaponWishes.length === 0) {
                wishesContainer.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center;">å¸Œæœ›æ­¦å™¨ãªã—</p>';
                return;
            }
            
            wishesContainer.innerHTML = players[position].weaponWishes.map(wish => `
                <div class="wish-item">
                    <span>${wish.job}</span>
                    <div>
                        <span class="wish-priority">å„ªå…ˆåº¦: ${wish.priority}</span>
                        <button class="remove-wish" onclick="removeWeaponWish('${position}', '${wish.job}')">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function saveWeaponWishes() {
            const data = getLocalData();
            await saveData(data);
            alert('æ­¦å™¨å¸Œæœ›ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        function completeSetup() {
            if (confirm('è¨­å®šã‚’å®Œäº†ã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) {
                showMainDashboard();
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹æ©Ÿèƒ½ã®å®Ÿè£…

        function showPositionPrioritySettings() {
            updateDebugInfo('Showing position priority settings');
            const app = document.querySelector('.container');
            
            // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
            const data = getLocalData();
            const currentPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id] || getDefaultPositionPriorities();
            
            app.innerHTML = `
                <h1>ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¥å„ªå…ˆåº¦è¨­å®š</h1>
                
                <div class="section">
                    <h2>å„ªå…ˆåº¦è¨­å®šã®èª¬æ˜</h2>
                    <p>å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®å„ªå…ˆåº¦ã‚’æ•°å€¤ã§è¨­å®šã—ã¾ã™ã€‚æ•°å€¤ãŒé«˜ã„ã»ã©è£…å‚™åˆ†é…ã§ã®å„ªå…ˆåº¦ãŒé«˜ããªã‚Šã¾ã™ã€‚</p>
                    <p>è£…å‚™æ–¹é‡ï¼ˆé›¶å¼/ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ï¼‰ã®å„ªå…ˆåº¦ã¨åˆç®—ã—ã¦æœ€çµ‚åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
                </div>
                
                <div class="section">
                    <h2>ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¥å„ªå…ˆåº¦</h2>
                    <div class="priority-settings-grid">
                        <div class="priority-group">
                            <h3>ã‚¿ãƒ³ã‚¯</h3>
                            <div class="priority-item">
                                <label>MT:</label>
                                <input type="number" id="priority-MT" value="${currentPriorities.MT || 30}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>ST:</label>
                                <input type="number" id="priority-ST" value="${currentPriorities.ST || 25}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>ãƒ’ãƒ¼ãƒ©ãƒ¼</h3>
                            <div class="priority-item">
                                <label>H1:</label>
                                <input type="number" id="priority-H1" value="${currentPriorities.H1 || 20}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>H2:</label>
                                <input type="number" id="priority-H2" value="${currentPriorities.H2 || 15}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>DPS</h3>
                            <div class="priority-item">
                                <label>D1:</label>
                                <input type="number" id="priority-D1" value="${currentPriorities.D1 || 10}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D2:</label>
                                <input type="number" id="priority-D2" value="${currentPriorities.D2 || 10}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D3:</label>
                                <input type="number" id="priority-D3" value="${currentPriorities.D3 || 5}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D4:</label>
                                <input type="number" id="priority-D4" value="${currentPriorities.D4 || 5}" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="priority-presets">
                        <h3>ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®š</h3>
                        <button onclick="setDPSPriority()">DPSå„ªå…ˆ</button>
                        <button onclick="setTankPriority()">ã‚¿ãƒ³ã‚¯å„ªå…ˆ</button>
                        <button onclick="setBalancedPriority()">ãƒãƒ©ãƒ³ã‚¹å‹</button>
                        <button onclick="resetToDefaultPriorities()">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</button>
                    </div>
                    
                    <div class="section-actions">
                        <button onclick="savePositionPriorities()" style="background-color: #27ae60; color: white;">è¨­å®šã‚’ä¿å­˜</button>
                    </div>
                </div>
                
                <div class="section-actions">
                    <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                </div>
            `;
            
            // å„ªå…ˆåº¦è¨­å®šç”¨CSS
            if (!document.getElementById('priority-styles')) {
                const style = document.createElement('style');
                style.id = 'priority-styles';
                style.textContent = `
                    .priority-settings-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 15px;
                        margin: 15px 0;
                    }
                    @media (max-width: 800px) {
                        .priority-settings-grid {
                            grid-template-columns: 1fr;
                        }
                    }
                    .priority-group {
                        background-color: #ffffff;
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .priority-group h3 {
                        margin: 0 0 15px 0;
                        color: #2c3e50;
                        text-align: center;
                        background-color: #3498db;
                        color: white;
                        padding: 8px;
                        border-radius: 4px;
                    }
                    .priority-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin: 10px 0;
                    }
                    .priority-item label {
                        font-weight: bold;
                        min-width: 30px;
                    }
                    .priority-item input {
                        width: 60px;
                        text-align: center;
                        padding: 6px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                    }
                    .priority-presets {
                        margin: 20px 0;
                        text-align: center;
                    }
                    .priority-presets button {
                        margin: 0 5px;
                        padding: 8px 15px;
                        font-size: 12px;
                    }
                    .section-actions {
                        text-align: center;
                        margin: 20px 0;
                        padding-top: 15px;
                        border-top: 1px solid #e9ecef;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function getDefaultPositionPriorities() {
            return {
                MT: 30, ST: 25,
                H1: 20, H2: 15,
                D1: 10, D2: 10, D3: 5, D4: 5
            };
        }

        function setDPSPriority() {
            document.getElementById('priority-D1').value = 40;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 30;
            document.getElementById('priority-D4').value = 25;
            document.getElementById('priority-MT').value = 20;
            document.getElementById('priority-ST').value = 15;
            document.getElementById('priority-H1').value = 10;
            document.getElementById('priority-H2').value = 5;
        }

        function setTankPriority() {
            document.getElementById('priority-MT').value = 40;
            document.getElementById('priority-ST').value = 35;
            document.getElementById('priority-H1').value = 25;
            document.getElementById('priority-H2').value = 20;
            document.getElementById('priority-D1').value = 15;
            document.getElementById('priority-D2').value = 10;
            document.getElementById('priority-D3').value = 5;
            document.getElementById('priority-D4').value = 3;
        }

        function setBalancedPriority() {
            document.getElementById('priority-MT').value = 25;
            document.getElementById('priority-ST').value = 25;
            document.getElementById('priority-H1').value = 20;
            document.getElementById('priority-H2').value = 20;
            document.getElementById('priority-D1').value = 15;
            document.getElementById('priority-D2').value = 15;
            document.getElementById('priority-D3').value = 10;
            document.getElementById('priority-D4').value = 10;
        }

        function resetToDefaultPriorities() {
            const defaults = getDefaultPositionPriorities();
            Object.keys(defaults).forEach(position => {
                document.getElementById(`priority-${position}`).value = defaults[position];
            });
        }

        async function savePositionPriorities() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const priorities = {};
            
            for (const position of positions) {
                const value = document.getElementById(`priority-${position}`).value;
                priorities[position] = parseInt(value) || 0;
            }
            
            const data = getLocalData();
            if (!data.positionPriorities) data.positionPriorities = {};
            data.positionPriorities[currentRaidTier.id] = priorities;
            
            await saveData(data);
            alert('ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        function showLayerAllocation(layer) {
            updateDebugInfo(`Showing layer ${layer} allocation`);
            const app = document.querySelector('.container');
            
            try {
                const data = getLocalData();
                
                if (!currentRaidTier || !currentRaidTier.id) {
                    app.innerHTML = `
                        <h1>ã‚¨ãƒ©ãƒ¼</h1>
                        <div class="section">
                            <p style="color: #e74c3c;">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                            <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        </div>
                    `;
                    return;
                }
                
                const players = data.players && data.players[currentRaidTier.id];
                
                if (!players || Object.keys(players).length === 0) {
                    app.innerHTML = `
                        <h1>${layer}å±¤è£…å‚™åˆ†é…</h1>
                        <div class="section">
                            <p style="color: #e74c3c;">å…ˆã«ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
                            <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        </div>
                    `;
                    return;
                }
                
                // æ­£å¸¸ãªå ´åˆã®HTMLæç”»
                app.innerHTML = `
                    <h1>${currentRaidTier.name} - ${layer}å±¤ã‚¯ãƒªã‚¢ç¢ºèª</h1>
                    
                    <div class="allocation-navigation">
                        <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        <button onclick="generateLayerDropsAndProcess(${layer})" class="refresh-btn">åˆ†é…çµæœã‚’å†è¨ˆç®—</button>
                        <button onclick="generateTestData()" class="test-btn">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                    </div>
                    
                    <div class="layer-content-grid">
                        <div class="section layer-drops-section">
                            <h2>${layer}å±¤ãƒ‰ãƒ­ãƒƒãƒ—</h2>
                            <div id="fixed-drops">
                                <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                        
                        <div class="section layer-results-section">
                            <h2>è‡ªå‹•åˆ†é…çµæœ</h2>
                            <div id="allocation-summary">
                                <!-- åˆ†é…çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="allocation-actions">
                        <button onclick="confirmAndSaveAllocation(${layer})" class="confirm-btn">ã“ã®çµæœã§ç¢ºå®šãƒ»ä¿å­˜</button>
                    </div>
                `;
            
                // å±¤åˆ¥è£…å‚™åˆ†é…ç”¨CSS
                if (!document.getElementById('allocation-styles')) {
                    const style = document.createElement('style');
                    style.id = 'allocation-styles';
                    style.textContent = `
                        .layer-content-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin: 15px 0;
                        }
                        @media (max-width: 1200px) {
                            .layer-content-grid {
                                grid-template-columns: 1fr;
                            }
                        }
                        .layer-drops-section, .layer-results-section {
                            min-height: 300px;
                        }
                        .allocation-navigation {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 15px;
                            padding-bottom: 8px;
                            border-bottom: 2px solid #e9ecef;
                            flex-wrap: wrap;
                            gap: 10px;
                        }
                        .allocation-navigation button {
                            padding: 8px 12px;
                            font-size: 14px;
                            flex: 0 0 auto;
                        }
                        .refresh-btn {
                            background-color: #9b59b6 !important;
                        }
                        .test-btn {
                            background-color: #e74c3c !important;
                        }
                        .confirm-btn {
                            background-color: #27ae60 !important;
                            padding: 15px 30px !important;
                            font-size: 16px !important;
                            color: white !important;
                        }
                        .fixed-drop-item {
                            background-color: #ffffff;
                            padding: 15px;
                            margin: 10px 0;
                            border-radius: 8px;
                            border: 1px solid #e9ecef;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        .fixed-drop-item h4 {
                            margin: 0;
                            color: #2c3e50;
                            font-weight: 600;
                        }
                        .fixed-drop-item p {
                            margin: 5px 0 0 0;
                            color: #666;
                            font-size: 14px;
                        }
                        .allocation-header-compact {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 8px 12px;
                            background-color: #3498db;
                            color: white;
                            font-weight: 600;
                            font-size: 13px;
                            border-radius: 6px 6px 0 0;
                            margin-bottom: 2px;
                        }
                        .allocation-result-compact {
                            border: 1px solid #ddd;
                            border-radius: 0 0 6px 6px;
                            margin-bottom: 8px;
                            background-color: white;
                        }
                        .item-allocation-row {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 12px;
                        }
                        .item-name-compact {
                            font-weight: bold;
                            color: #2c3e50;
                            font-size: 14px;
                        }
                        .allocation-status {
                            text-align: center;
                        }
                        .auto-result {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 13px;
                            font-weight: 500;
                            background-color: #e8f5e8;
                            color: #27ae60;
                            border: 1px solid #27ae60;
                        }
                        .auto-result.freelot {
                            background-color: #fff3cd;
                            color: #856404;
                            border-color: #ffc107;
                        }
                        .manual-selection-compact select {
                            width: 100%;
                            padding: 6px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 13px;
                        }
                        .direct-weapon-section {
                            background-color: #f8f9fa;
                            border: 2px solid #3498db;
                            border-radius: 8px;
                            padding: 20px;
                            margin-top: 20px;
                        }
                        .direct-weapon-section h3 {
                            margin: 0 0 15px 0;
                            color: #2c3e50;
                        }
                        .weapon-selection {
                            margin-bottom: 15px;
                        }
                        .weapon-selection label {
                            display: block;
                            margin-bottom: 8px;
                            font-weight: 600;
                        }
                        .weapon-selection select {
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 14px;
                        }
                        .direct-weapon-compact {
                            background-color: #f8f9fa;
                            border: 2px solid #3498db;
                            border-radius: 6px;
                            margin-top: 10px;
                        }
                        .weapon-header-compact {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 8px 12px;
                            background-color: #3498db;
                            color: white;
                            font-weight: 600;
                            font-size: 13px;
                            border-radius: 4px 4px 0 0;
                            margin-bottom: 0;
                        }
                        .weapon-allocation-row {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 10px;
                            align-items: center;
                            padding: 12px;
                        }
                        .weapon-name-compact {
                            font-weight: bold;
                            color: #2c3e50;
                            font-size: 14px;
                        }
                        .weapon-status {
                            text-align: center;
                        }
                        .weapon-selection-compact select {
                            width: 100%;
                            padding: 6px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 13px;
                        }
                    `;
                    document.head.appendChild(style);
                }
            
                // HTMLã®æç”»å®Œäº†å¾Œã«å‡¦ç†ã‚’å®Ÿè¡Œ
                setTimeout(() => {
                    const fixedDropsEl = document.getElementById('fixed-drops');
                    const summaryEl = document.getElementById('allocation-summary');
                    
                    if (fixedDropsEl && summaryEl) {
                        generateLayerDropsAndProcess(layer);
                    } else {
                        alert('DOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ã€Œåˆ†é…çµæœã‚’å†è¨ˆç®—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
                    }
                }, 200);
                
            } catch (error) {
                console.error('Layer allocation error:', error);
                app.innerHTML = `
                    <h1>ã‚¨ãƒ©ãƒ¼</h1>
                    <div class="section">
                        <p style="color: #e74c3c;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>
                        <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                    </div>
                `;
            }
        }

        function showHistory() {
            updateDebugInfo('Showing history');
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${currentRaidTier ? currentRaidTier.name : 'ãƒ¬ã‚¤ãƒ‰'} - é…å¸ƒå±¥æ­´ãƒ»è£…å‚™çŠ¶æ³</h1>
                <div class="section">
                    <h2>å±¥æ­´ãƒ»çµ±è¨ˆã‚·ã‚¹ãƒ†ãƒ </h2>
                    <p>ğŸš§ é–‹ç™ºä¸­ï¼šé…å¸ƒå±¥æ­´ã¨è£…å‚™çŠ¶æ³ã®è¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Ÿè£…äºˆå®š</p>
                    
                    <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                </div>
            `;
        }

        function exportData() {
            try {
                const data = getLocalData();
                const jsonData = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ff14_gear_data_${currentRaidTier ? currentRaidTier.name : 'backup'}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
            } catch (error) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function generateTestData() {
            if (confirm('ãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                const testTier = {
                    id: 'test_' + Date.now(),
                    name: 'ãƒ†ã‚¹ãƒˆç”¨7.2é›¶å¼',
                    description: 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä»˜ããƒ†ã‚¹ãƒˆç’°å¢ƒ',
                    createdAt: new Date().toISOString()
                };
                
                const data = getLocalData();
                if (!data.raidTiers) data.raidTiers = [];
                data.raidTiers.push(testTier);
                data.activeRaidTierId = testTier.id;
                
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿
                if (!data.players) data.players = {};
                data.players[testTier.id] = {
                    MT: { name: 'ãƒ†ã‚¹ãƒˆMT', characterName: 'ã‚µãƒ³ãƒ—ãƒ«ã‚¿ãƒ³ã‚¯', job: 'ãƒŠã‚¤ãƒˆ', position: 'MT', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    ST: { name: 'ãƒ†ã‚¹ãƒˆST', characterName: 'ã‚µãƒ³ãƒ—ãƒ«æˆ¦å£«', job: 'æˆ¦å£«', position: 'ST', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    H1: { name: 'ãƒ†ã‚¹ãƒˆH1', characterName: 'ã‚µãƒ³ãƒ—ãƒ«ç™½', job: 'ç™½é­”é“å£«', position: 'H1', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    H2: { name: 'ãƒ†ã‚¹ãƒˆH2', characterName: 'ã‚µãƒ³ãƒ—ãƒ«å­¦è€…', job: 'å­¦è€…', position: 'H2', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D1: { name: 'ãƒ†ã‚¹ãƒˆD1', characterName: 'ã‚µãƒ³ãƒ—ãƒ«ç«œé¨å£«', job: 'ç«œé¨å£«', position: 'D1', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D2: { name: 'ãƒ†ã‚¹ãƒˆD2', characterName: 'ã‚µãƒ³ãƒ—ãƒ«å¿è€…', job: 'å¿è€…', position: 'D2', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D3: { name: 'ãƒ†ã‚¹ãƒˆD3', characterName: 'ã‚µãƒ³ãƒ—ãƒ«é»’é­”', job: 'é»’é­”é“å£«', position: 'D3', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} },
                    D4: { name: 'ãƒ†ã‚¹ãƒˆD4', characterName: 'ã‚µãƒ³ãƒ—ãƒ«è©©äºº', job: 'åŸéŠè©©äºº', position: 'D4', equipmentPolicy: {}, weaponWishes: [], currentEquipment: {} }
                };
                
                localStorage.setItem('ff14RaidData', JSON.stringify(data));
                currentRaidTier = testTier;
                
                alert('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
                showMainDashboard();
            }
        }

        // åˆ†é…ã‚·ã‚¹ãƒ†ãƒ ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentDropItems = [];
        let allocationResults = [];

        // å±¤åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ç”Ÿæˆã¨åˆ†é…å‡¦ç†
        function generateLayerDropsAndProcess(layer) {
            try {
                const layerDrops = {
                    1: [
                        { slot: 'è€³', name: 'è€³ - ã‚¤ãƒ¤ãƒªãƒ³ã‚°ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' },
                        { slot: 'é¦–', name: 'é¦– - ãƒãƒƒã‚¯ãƒ¬ã‚¹ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' },
                        { slot: 'è…•', name: 'è…• - ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' },
                        { slot: 'æŒ‡', name: 'æŒ‡ - ãƒªãƒ³ã‚°ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'accessory' }
                    ],
                    2: [
                        { slot: 'é ­', name: 'é ­ - ãƒ˜ãƒƒãƒ‰ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'æ‰‹', name: 'æ‰‹ - ãƒãƒ³ãƒ‰ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'è¶³', name: 'è¶³ - ãƒ•ãƒƒãƒˆã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'æ­¦å™¨çŸ³', name: 'æ­¦å™¨çŸ³', itemLevel: 1, type: 'material' },
                        { slot: 'ç¡¬åŒ–è–¬', name: 'ç¡¬åŒ–è–¬', itemLevel: 1, type: 'material' }
                    ],
                    3: [
                        { slot: 'èƒ´', name: 'èƒ´ - ãƒœãƒ‡ã‚£ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'è„š', name: 'è„š - ãƒ¬ãƒƒã‚°ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ', itemLevel: 730, type: 'armor' },
                        { slot: 'å¼·åŒ–è–¬', name: 'å¼·åŒ–è–¬', itemLevel: 1, type: 'material' },
                        { slot: 'å¼·åŒ–ç¹Šç¶­', name: 'å¼·åŒ–ç¹Šç¶­', itemLevel: 1, type: 'material' }
                    ],
                    4: [
                        { slot: 'æ­¦å™¨', name: 'æ­¦å™¨ - ã‚¦ã‚§ãƒãƒ³ãƒã‚§ã‚¹ãƒˆ', itemLevel: 735, type: 'weapon_box' },
                        { slot: 'ãƒã‚¦ãƒ³ãƒˆ', name: 'ãƒã‚¦ãƒ³ãƒˆ', itemLevel: 1, type: 'mount' }
                    ]
                };
                
                // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨­å®š
                currentDropItems = layerDrops[layer] || [];
                
                // 4å±¤ã®å ´åˆã¯ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ 
                if (layer === 4) {
                    displayFixedDropsWithDirectWeapon(currentDropItems, layer);
                } else {
                    // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤º
                    displayFixedDrops(currentDropItems);
                    // å³åº§ã«åˆ†é…å‡¦ç†ã‚’å®Ÿè¡Œ
                    processAllocationImmediate(layer);
                }
            } catch (error) {
                console.error('ãƒ‰ãƒ­ãƒƒãƒ—ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤º
        function displayFixedDrops(dropItems) {
            const container = document.getElementById('fixed-drops');
            if (!container) return;
            
            container.innerHTML = dropItems.map(item => `
                <div class="fixed-drop-item">
                    <div>
                        <h4>${item.name}</h4>
                        <p>${item.slot}</p>
                    </div>
                    <div style="color: #3498db; font-weight: bold;">
                        å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—
                    </div>
                </div>
            `).join('');
        }

        // 4å±¤å°‚ç”¨ã®è¡¨ç¤ºé–¢æ•°ï¼ˆç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨é¸æŠæ©Ÿèƒ½ä»˜ãï¼‰
        function displayFixedDropsWithDirectWeapon(dropItems, layer) {
            const container = document.getElementById('fixed-drops');
            if (!container) return;
            
            const allJobs = [
                'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å¸«', 'å­¦è€…', 'è³¢è€…',
                'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­',
                'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'
            ];
            
            container.innerHTML = `
                ${dropItems.map(item => `
                    <div class="fixed-drop-item">
                        <div>
                            <h4>${item.name}</h4>
                            <p>${item.slot}</p>
                        </div>
                        <div style="color: #3498db; font-weight: bold;">
                            å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—
                        </div>
                    </div>
                `).join('')}
                
                <div class="direct-weapon-section">
                    <h3>4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨è¨­å®š</h3>
                    <div class="weapon-selection">
                        <label for="direct-weapon-select">ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸæ­¦å™¨ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</label>
                        <select id="direct-weapon-select" onchange="onDirectWeaponSelected(${layer})">
                            <option value="">æ­¦å™¨ã‚’é¸æŠ...</option>
                            ${allJobs.map(job => `<option value="${job}">${job}æ­¦å™¨</option>`).join('')}
                        </select>
                    </div>
                    <div id="direct-weapon-result" style="margin-top: 15px;">
                        <!-- æ­¦å™¨é¸æŠå¾Œã«å–å¾—äºˆå®šè€…ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            `;
            
            // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—ã®ã¿ã§åˆ†é…å‡¦ç†ã‚’å®Ÿè¡Œ
            processAllocationImmediate(layer);
        }

        // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨é¸æŠæ™‚ã®å‡¦ç†
        function onDirectWeaponSelected(layer) {
            const selectedJob = document.getElementById('direct-weapon-select').value;
            const resultDiv = document.getElementById('direct-weapon-result');
            
            if (!selectedJob) {
                resultDiv.innerHTML = '';
                return;
            }
            
            // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
            const directWeapon = {
                slot: 'æ­¦å™¨',
                name: `${selectedJob}æ­¦å™¨`,
                itemLevel: 735,
                type: 'direct_weapon'
            };
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
            const data = getLocalData();
            const players = Object.values(data.players[currentRaidTier.id]);
            
            // æ­¦å™¨ã®åˆ†é…å‡¦ç†ã‚’å®Ÿè¡Œ
            const allocationResult = processDirectDropWeaponSimple(directWeapon, players);
            
            // çµæœã‚’è¡¨ç¤º
            resultDiv.innerHTML = `
                <div class="direct-weapon-compact">
                    <div class="weapon-header-compact">
                        <div class="header-item">ã‚¢ã‚¤ãƒ†ãƒ </div>
                        <div class="header-predicted">å–å¾—äºˆå®šè€…</div>
                        <div class="header-actual">å®Ÿéš›ã®å–å¾—è€…</div>
                    </div>
                    <div class="weapon-allocation-row">
                        <div class="weapon-name-compact">${selectedJob}æ­¦å™¨</div>
                        <div class="weapon-status">
                            ${allocationResult.winner ? `
                                <span class="auto-result">${allocationResult.winner.position} - ${allocationResult.winner.characterName}</span>
                            ` : `
                                <span class="auto-result freelot">ãƒ•ãƒªãƒ¼ãƒ­ãƒƒãƒˆ</span>
                            `}
                        </div>
                        <div class="weapon-selection-compact">
                            <select id="manual-weapon-winner" onchange="updateManualWeaponWinner('${selectedJob}')">
                                <option value="">å–å¾—è€…ã‚’é¸æŠ...</option>
                                ${players.map(player => `
                                    <option value="${player.position}" 
                                        ${allocationResult.winner && allocationResult.winner.position === player.position ? 'selected' : ''}>
                                        ${player.position} - ${player.characterName}
                                    </option>
                                `).join('')}
                                <option value="discard" ${!allocationResult.winner ? 'selected' : ''}>åˆ†è§£ãƒ»ä¿ç®¡</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã‚’ç¾åœ¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã«è¿½åŠ ï¼ˆä¸€æ™‚çš„ï¼‰
            const weaponIndex = currentDropItems.findIndex(item => item.type === 'direct_weapon');
            if (weaponIndex >= 0) {
                currentDropItems[weaponIndex] = directWeapon;
            } else {
                currentDropItems.push(directWeapon);
            }
            
            // å…¨ä½“ã®åˆ†é…çµæœã‚’æ›´æ–°
            processAllocationImmediate(layer);
        }

        // åˆ†é…å‡¦ç†å®Ÿè¡Œï¼ˆå³åº§ã«å®Ÿè¡Œç‰ˆï¼‰
        function processAllocationImmediate(layer) {
            const data = getLocalData();
            const players = Object.values(data.players[currentRaidTier.id]);
            
            allocationResults = [];
            
            currentDropItems.forEach((item, index) => {
                let allocationResult;
                
                // 4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®ç‰¹åˆ¥å‡¦ç†
                if (item.type === 'direct_weapon') {
                    allocationResult = processDirectDropWeaponSimple(item, players);
                } else {
                    // è£…å‚™æ–¹é‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ§‹ç¯‰
                    const gearPolicies = {};
                    players.forEach(player => {
                        gearPolicies[player.position] = player.equipmentPolicy || {};
                    });
                    
                    // æ–°ã—ã„åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
                    allocationResult = processEquipmentWithNewSystem(item, players, gearPolicies);
                }
                
                allocationResults.push(allocationResult);
            });
            
            displayAllocationResults();
        }

        // è£…å‚™å„ªå…ˆåº¦è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ 
        function calculateEquipmentPriority(player, equipment, gearPolicies) {
            const slot = equipment.slot || getSlotFromEquipmentName(equipment.name);
            const playerGearPolicy = gearPolicies && gearPolicies[player.position] && gearPolicies[player.position][slot];
            
            // ç¾åœ¨è£…å‚™ã¨ã®æ¯”è¼ƒ
            const currentEquipment = player.currentEquipment && player.currentEquipment[slot];
            const isUpgrade = !currentEquipment || equipment.itemLevel > (currentEquipment.itemLevel || 0);
            
            // æ—¢ã«ã‚ˆã‚Šè‰¯ã„è£…å‚™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã¯Pass
            if (!isUpgrade) {
                return {
                    totalPriority: 0,
                    gearPolicyPriority: 0,
                    rolePriority: 0,
                    gearPolicy: playerGearPolicy || 'é›¶å¼(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)',
                    judgment: 'Pass',
                    reason: `æ—¢ã«ã‚ˆã‚Šè‰¯ã„è£…å‚™ã‚’è£…å‚™æ¸ˆã¿ (IL${currentEquipment?.itemLevel || 0} â†’ IL${equipment.itemLevel})`
                };
            }
            
            // è£…å‚™æ–¹é‡ã«ã‚ˆã‚‹å„ªå…ˆåº¦ï¼ˆæœªè¨­å®šã®å ´åˆã¯é›¶å¼æ‰±ã„ï¼‰
            const gearPolicyPriority = (playerGearPolicy === 'é›¶å¼' || !playerGearPolicy) ? 100 : 50;
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦ã‚’å–å¾—
            const data = getLocalData();
            const customPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id];
            
            let rolePriority;
            if (customPriorities && customPriorities[player.position]) {
                rolePriority = customPriorities[player.position];
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå„ªå…ˆåº¦
                const defaultRolePriorities = {
                    'D1': 30, 'D2': 30,    // DPSé«˜å„ªå…ˆåº¦
                    'D3': 25, 'D4': 25,    // DPSä¸­å„ªå…ˆåº¦
                    'MT': 20, 'ST': 20,    // ã‚¿ãƒ³ã‚¯
                    'H1': 10, 'H2': 10     // ãƒ’ãƒ¼ãƒ©ãƒ¼
                };
                rolePriority = defaultRolePriorities[player.position] || 0;
            }
            
            // ç·åˆå„ªå…ˆåº¦ = è£…å‚™æ–¹é‡å„ªå…ˆåº¦ + ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦
            const totalPriority = gearPolicyPriority + rolePriority;
            
            return {
                totalPriority,
                gearPolicyPriority,
                rolePriority,
                gearPolicy: playerGearPolicy || 'é›¶å¼(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)',
                judgment: totalPriority >= 100 ? 'Need' : totalPriority >= 50 ? 'Greed' : 'Pass',
                reason: isUpgrade ? `ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ (IL${currentEquipment?.itemLevel || 0} â†’ IL${equipment.itemLevel})` : ''
            };
        }

        // æ–°ã—ã„è£…å‚™åˆ†é…å‡¦ç†
        function processEquipmentWithNewSystem(equipment, allPlayers, gearPolicies) {
            // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å„ªå…ˆåº¦ã‚’è¨ˆç®—
            const playerPriorities = allPlayers.map(player => {
                const priority = calculateEquipmentPriority(player, equipment, gearPolicies);
                return {
                    player: player,
                    ...priority
                };
            });
            
            // åˆ¤å®šåˆ¥ã«åˆ†é¡
            const needPlayers = playerPriorities.filter(p => p.judgment === 'Need').sort((a, b) => b.totalPriority - a.totalPriority);
            const greedPlayers = playerPriorities.filter(p => p.judgment === 'Greed').sort((a, b) => b.totalPriority - a.totalPriority);
            const passPlayers = playerPriorities.filter(p => p.judgment === 'Pass');
            
            // å‹è€…æ±ºå®š
            let winner = null;
            let reason = '';
            
            if (needPlayers.length > 0) {
                winner = needPlayers[0].player;
                reason = `Needåˆ¤å®š (è£…å‚™æ–¹é‡: ${needPlayers[0].gearPolicy}, å„ªå…ˆåº¦: ${needPlayers[0].totalPriority})`;
            } else if (greedPlayers.length > 0) {
                winner = greedPlayers[0].player;
                reason = `Greedåˆ¤å®š (è£…å‚™æ–¹é‡: ${greedPlayers[0].gearPolicy}, å„ªå…ˆåº¦: ${greedPlayers[0].totalPriority})`;
            } else {
                reason = 'å…¨å“¡Passåˆ¤å®š (åˆ†è§£ãƒ»ä¿ç®¡)';
            }
            
            return {
                equipment: equipment,
                winner: winner,
                reason: reason,
                allJudgments: playerPriorities.map(p => ({
                    player: p.player,
                    judgment: p.judgment,
                    priority: p.totalPriority,
                    gearPolicy: p.gearPolicy,
                    reason: p.reason || ''
                })),
                needCount: needPlayers.length,
                greedCount: greedPlayers.length,
                passCount: passPlayers.length
            };
        }

        // 4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®ç‰¹åˆ¥å‡¦ç†
        function processDirectDropWeaponSimple(equipment, allPlayers) {
            const droppedWeaponJob = extractJobFromWeaponName(equipment.name);
            
            // 1. ç™»éŒ²ã‚¸ãƒ§ãƒ–ã«è©²å½“ & æ­¦å™¨æœªå–å¾—ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢
            const primaryCandidates = allPlayers.filter(player => {
                const hasWeaponWish = player.weaponWishes && player.weaponWishes.some(wish => wish.job === droppedWeaponJob);
                const hasWeapon = playerHasWeaponForJobSimple(player, droppedWeaponJob);
                return hasWeaponWish && !hasWeapon;
            });

            if (primaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(primaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: 'ç™»éŒ²ã‚¸ãƒ§ãƒ–è©²å½“ãƒ»æ­¦å™¨æœªå–å¾—',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: primaryCandidates.includes(p) ? 'Need' : 'Pass' 
                    })),
                    needCount: primaryCandidates.length,
                    greedCount: 0,
                    passCount: allPlayers.length - primaryCandidates.length
                };
            }

            // 2. å¸Œæœ›ç™»éŒ²æ¸ˆã¿ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢
            const secondaryCandidates = allPlayers.filter(player => {
                return player.weaponWishes && player.weaponWishes.some(wish => wish.job === droppedWeaponJob);
            });

            if (secondaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(secondaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: 'å¸Œæœ›ç™»éŒ²æ¸ˆã¿',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: secondaryCandidates.includes(p) ? 'Greed' : 'Pass' 
                    })),
                    needCount: 0,
                    greedCount: secondaryCandidates.length,
                    passCount: allPlayers.length - secondaryCandidates.length
                };
            }

            // 3. è©²å½“è€…ãªã—
            return {
                equipment: equipment,
                winner: null,
                reason: 'è©²å½“è€…ãªã—ï¼ˆåˆ†è§£ãƒ»ä¿ç®¡ï¼‰',
                allJudgments: allPlayers.map(p => ({ player: p, judgment: 'Pass' })),
                needCount: 0,
                greedCount: 0,
                passCount: allPlayers.length
            };
        }

        // åˆ†é…çµæœè¡¨ç¤º
        function displayAllocationResults() {
            try {
                const container = document.getElementById('allocation-summary');
                if (!container) return;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const data = getLocalData();
                const players = Object.values(data.players[currentRaidTier.id]);
                
                const htmlContent = allocationResults.map((result, index) => {
                    // å‹è€…æƒ…å ±ã®å®‰å…¨ãªå–å¾—
                    let winnerText = 'ãªã—';
                    let isFreeLot = false;
                    
                    if (result.winner) {
                        const winnerName = result.winner.name || 'åå‰ä¸æ˜';
                        const winnerPosition = result.winner.position || 'ãƒã‚¸ã‚·ãƒ§ãƒ³ä¸æ˜';
                        winnerText = `${winnerName} (${winnerPosition})`;
                    } else {
                        winnerText = 'ãƒ•ãƒªãƒ¼ãƒ­ãƒƒãƒˆ';
                        isFreeLot = true;
                    }
                    
                    return `
                        <div class="allocation-result-compact">
                            <div class="item-allocation-row">
                                <div class="item-name-compact">${result.equipment.name}</div>
                                <div class="allocation-status">
                                    <span class="auto-result ${isFreeLot ? 'freelot' : ''}">${winnerText}</span>
                                </div>
                                <div class="manual-selection-compact">
                                    <select id="manual-winner-${index}" onchange="updateManualWinner(${index})">
                                        <option value="">å–å¾—è€…ã‚’é¸æŠ...</option>
                                        ${players.map(player => `
                                            <option value="${player.position}" 
                                                ${result.winner && result.winner.position === player.position ? 'selected' : ''}>
                                                ${player.position} - ${player.characterName}
                                            </option>
                                        `).join('')}
                                        <option value="discard" ${!result.winner ? 'selected' : ''}>åˆ†è§£ãƒ»ä¿ç®¡</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="allocation-header-compact">
                        <div class="header-item">ã‚¢ã‚¤ãƒ†ãƒ </div>
                        <div class="header-predicted">å–å¾—äºˆå®šè€…</div>
                        <div class="header-actual">å®Ÿéš›ã®å–å¾—è€…</div>
                    </div>
                    ${htmlContent}
                `;
                
            } catch (error) {
                console.error('åˆ†é…çµæœè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                const container = document.getElementById('allocation-summary');
                if (container) {
                    container.innerHTML = `<p style="color: #e74c3c;">åˆ†é…çµæœã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
                }
            }
        }

        // æ‰‹å‹•å–å¾—è€…è¨­å®š
        function updateManualWinner(resultIndex) {
            const selectedPosition = document.getElementById(`manual-winner-${resultIndex}`).value;
            
            if (!allocationResults[resultIndex]) return;
            
            if (selectedPosition === '' || selectedPosition === 'discard') {
                allocationResults[resultIndex].winner = null;
                allocationResults[resultIndex].reason = 'æ‰‹å‹•è¨­å®š: åˆ†è§£ãƒ»ä¿ç®¡';
            } else {
                const data = getLocalData();
                const players = Object.values(data.players[currentRaidTier.id]);
                const selectedPlayer = players.find(p => p.position === selectedPosition);
                
                if (selectedPlayer) {
                    allocationResults[resultIndex].winner = selectedPlayer;
                    allocationResults[resultIndex].reason = 'æ‰‹å‹•è¨­å®š: ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®š';
                }
            }
        }

        // ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®æ‰‹å‹•å–å¾—è€…è¨­å®š
        function updateManualWeaponWinner(weaponJob) {
            const selectedPosition = document.getElementById('manual-weapon-winner').value;
            
            const weaponResultIndex = allocationResults.findIndex(result => 
                result.equipment.type === 'direct_weapon' && result.equipment.name.includes(weaponJob)
            );
            
            if (weaponResultIndex >= 0) {
                if (selectedPosition === '' || selectedPosition === 'discard') {
                    allocationResults[weaponResultIndex].winner = null;
                    allocationResults[weaponResultIndex].reason = 'æ‰‹å‹•è¨­å®š: åˆ†è§£ãƒ»ä¿ç®¡';
                } else {
                    const data = getLocalData();
                    const players = Object.values(data.players[currentRaidTier.id]);
                    const selectedPlayer = players.find(p => p.position === selectedPosition);
                    
                    if (selectedPlayer) {
                        allocationResults[weaponResultIndex].winner = selectedPlayer;
                        allocationResults[weaponResultIndex].reason = 'æ‰‹å‹•è¨­å®š: ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®š';
                    }
                }
                
                displayAllocationResults();
            }
        }

        // åˆ†é…çµæœç¢ºå®šãƒ»ä¿å­˜
        async function confirmAndSaveAllocation(layer) {
            if (!allocationResults || allocationResults.length === 0) {
                alert('åˆ†é…çµæœãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (!confirm(`${layer}å±¤ã®åˆ†é…çµæœã‚’ç¢ºå®šã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            const data = getLocalData();
            
            if (!data.allocations) data.allocations = {};
            if (!data.allocations[currentRaidTier.id]) data.allocations[currentRaidTier.id] = [];
            
            const timestamp = new Date().toISOString();
            
            allocationResults.forEach(result => {
                const allocation = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    layer: layer,
                    equipment: result.equipment,
                    winner: result.winner,
                    reason: result.reason,
                    allJudgments: result.allJudgments,
                    timestamp: timestamp,
                    week: getCurrentWeekString()
                };
                
                data.allocations[currentRaidTier.id].push(allocation);
                
                // å‹è€…ã®ç¾åœ¨è£…å‚™ã‚’æ›´æ–°
                if (result.winner) {
                    const playerKey = Object.keys(data.players[currentRaidTier.id]).find(
                        key => data.players[currentRaidTier.id][key].name === result.winner.name
                    );
                    if (playerKey) {
                        if (!data.players[currentRaidTier.id][playerKey].currentEquipment) {
                            data.players[currentRaidTier.id][playerKey].currentEquipment = {};
                        }
                        data.players[currentRaidTier.id][playerKey].currentEquipment[result.equipment.slot] = result.equipment;
                    }
                }
            });
            
            await saveData(data);
            
            alert(`${layer}å±¤ã®åˆ†é…çµæœã‚’ç¢ºå®šãƒ»ä¿å­˜ã—ã¾ã—ãŸï¼`);
            
            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            currentDropItems = [];
            allocationResults = [];
            showMainDashboard();
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
        function extractJobFromWeaponName(weaponName) {
            const jobNames = [
                'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å¸«', 'å­¦è€…', 'è³¢è€…',
                'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­',
                'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'
            ];
            
            for (const job of jobNames) {
                if (weaponName.includes(job)) {
                    return job;
                }
            }
            
            return 'ä¸æ˜';
        }

        function playerHasWeaponForJobSimple(player, jobName) {
            const currentWeapon = player.currentEquipment && player.currentEquipment['æ­¦å™¨'];
            if (!currentWeapon) return false;
            
            // ç°¡æ˜“çš„ã«ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«720ä»¥ä¸Šã‚’æŒã£ã¦ã„ã‚Œã°æ­¦å™¨ã‚ã‚Šã¨ã™ã‚‹
            return currentWeapon.itemLevel >= 720;
        }

        function selectWinnerByPriority(candidatePlayers) {
            const players = candidatePlayers.map(cp => cp.player || cp);
            
            if (players.length === 1) {
                return players[0];
            }
            
            // å„ªå…ˆåº¦: D1/D2 > D3/D4 > MT/ST > H1/H2
            const positionPriorities = {
                'D1': 1, 'D2': 1,    // DPS Melee
                'D3': 2, 'D4': 2,    // DPS Range/Caster
                'MT': 3, 'ST': 3,    // Tank
                'H1': 4, 'H2': 4     // Healer
            };
            
            const sortedPlayers = players.sort((a, b) => {
                const priorityA = positionPriorities[a.position] || 999;
                const priorityB = positionPriorities[b.position] || 999;
                return priorityA - priorityB;
            });
            
            return sortedPlayers[0];
        }

        function getSlotFromEquipmentName(equipmentName) {
            const slotKeywords = {
                'æ­¦å™¨': ['æ­¦å™¨', 'ã‚½ãƒ¼ãƒ‰', 'ã‚¢ã‚¯ã‚¹', 'ãƒãƒ³ãƒãƒ¼', 'ãƒ­ãƒƒãƒ‰', 'ãƒœã‚¦', 'ã‚¬ãƒ³'],
                'é ­': ['ãƒ˜ãƒ«ãƒ ', 'ãƒ•ãƒ¼ãƒ‰', 'ãƒãƒƒãƒˆ', 'å¸½å­', 'é ­'],
                'èƒ´': ['ã‚¢ãƒ¼ãƒãƒ¼', 'ãƒ­ãƒ¼ãƒ–', 'ã‚³ãƒ¼ãƒˆ', 'èƒ´', 'ãƒã‚§ã‚¹ãƒˆ'],
                'æ‰‹': ['ã‚¬ãƒ³ãƒˆãƒ¬ãƒƒãƒˆ', 'ã‚°ãƒ­ãƒ¼ãƒ–', 'æ‰‹è¢‹', 'æ‰‹'],
                'è„š': ['ãƒ‘ãƒ³ã‚¿ãƒ­ãƒ³', 'ãƒ›ãƒ¼ã‚º', 'ãƒ–ãƒ¼ãƒ„', 'è„š', 'ãƒ¬ãƒƒã‚°'],
                'è¶³': ['ãƒ–ãƒ¼ãƒ„', 'ã‚·ãƒ¥ãƒ¼ã‚º', 'é´', 'è¶³'],
                'è€³': ['ã‚¤ãƒ¤ãƒªãƒ³ã‚°', 'è€³é£¾ã‚Š', 'è€³'],
                'é¦–': ['ãƒãƒƒã‚¯ãƒ¬ã‚¹', 'ãƒãƒ§ãƒ¼ã‚«ãƒ¼', 'é¦–é£¾ã‚Š', 'é¦–'],
                'è…•': ['ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', 'è…•è¼ª', 'è…•'],
                'æŒ‡': ['ãƒªãƒ³ã‚°', 'æŒ‡è¼ª', 'æŒ‡']
            };
            
            for (const [slot, keywords] of Object.entries(slotKeywords)) {
                if (keywords.some(keyword => equipmentName.includes(keyword))) {
                    return slot;
                }
            }
            
            return 'ä¸æ˜';
        }

        function getCurrentWeekString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>