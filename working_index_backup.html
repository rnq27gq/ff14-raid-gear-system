<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 2.2rem;
        }
        h2 {
            color: #34495e;
            font-weight: 500;
            margin-bottom: 15px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 24px;
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .tier-item h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-weight: 600;
        }
        .tier-item p {
            margin: 5px 0;
            color: #666;
        }
        .tier-item small {
            color: #95a5a6;
        }
        .new-tier-form {
            margin-top: 30px;
            padding: 24px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        .new-tier-form input {
            display: block;
            width: 100%;
            margin: 10px 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentScreen = 'raidTierSelection';
        let currentRaidTier = null;
        const STORAGE_KEY = 'ff14_gear_allocation_data';

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        function initStorage() {
            if (!localStorage.getItem(STORAGE_KEY)) {
                const data = {
                    raidTiers: [],
                    activeRaidTierId: null,
                    players: {},
                    allocations: {}
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }
        }

        function getData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠç”»é¢
        function showRaidTierSelection() {
            const app = document.querySelector('.container');
            const data = getData();
            const raidTiers = data.raidTiers || [];
            
            app.innerHTML = `
                <h1>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                
                <div class="section">
                    <h2>ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ</h2>
                    <div id="existing-tiers">
                        ${raidTiers.length > 0 ? `
                            <h3>æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢</h3>
                            <div class="tier-list">
                                ${raidTiers.map(tier => `
                                    <div class="tier-item" onclick="selectRaidTier('${tier.id}')">
                                        <div class="tier-info">
                                            <h4>${tier.name}</h4>
                                            <p>${tier.description || 'èª¬æ˜æœªè¨­å®š'}</p>
                                            <small>ä½œæˆæ—¥: ${new Date(tier.createdAt).toLocaleDateString('ja-JP')}</small>
                                        </div>
                                        <div class="tier-actions">
                                            <button class="delete-btn" onclick="event.stopPropagation(); deleteRaidTier('${tier.id}', '${tier.name}')" title="å‰Šé™¤">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>ã¾ã ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>'}
                    </div>
                    
                    <div class="new-tier-form">
                        <h3>æ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®ä½œæˆ</h3>
                        <input type="text" id="tier-name" placeholder="ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢åï¼ˆä¾‹ï¼š7.2é›¶å¼ï¼‰" required>
                        <input type="text" id="tier-description" placeholder="èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰">
                        <button onclick="createNewRaidTier()">æ–°è¦ä½œæˆ</button>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #0f3460;">
                            <h4>ãƒ†ã‚¹ãƒˆç’°å¢ƒ</h4>
                            <p style="font-size: 14px; color: #bbb;">ã™ãã«ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã¯ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä»˜ãã®ãƒ†ã‚¹ãƒˆç”¨ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’ä½œæˆã§ãã¾ã™ã€‚</p>
                            <button onclick="generateTestData()" style="background-color: #e67e22; border-color: #d35400; width: 100%;">
                                ğŸ§ª ãƒ†ã‚¹ãƒˆç”¨ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä½œæˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ãƒ†ã‚£ã‚¢å‰Šé™¤ç”¨CSSã‚’è¿½åŠ 
            addTierDeleteStyles();
        }
        
        // ãƒ†ã‚£ã‚¢å‰Šé™¤ç”¨CSS
        function addTierDeleteStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .tier-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    position: relative;
                }
                .tier-info {
                    flex: 1;
                }
                .tier-actions {
                    margin-left: 15px;
                }
                .delete-btn {
                    background-color: #e74c3c !important;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 16px;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                }
                .delete-btn:hover {
                    background-color: #c0392b !important;
                    transform: scale(1.1);
                }
            `;
            if (!document.getElementById('tier-delete-styles')) {
                style.id = 'tier-delete-styles';
                document.head.appendChild(style);
            }
        }
        
        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢å‰Šé™¤æ©Ÿèƒ½
        function deleteRaidTier(tierId, tierName) {
            if (!confirm(`ã€Œ${tierName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚\nãƒ»ã™ã¹ã¦ã®ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿\nãƒ»è£…å‚™æ–¹é‡è¨­å®š\nãƒ»æ­¦å™¨å¸Œæœ›è¨­å®š\nãƒ»åˆ†é…å±¥æ­´\n\nã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            // æœ€çµ‚ç¢ºèª
            if (!confirm(`æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã€Œ${tierName}ã€ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            const data = getData();
            
            // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢è‡ªä½“ã‚’å‰Šé™¤
            data.raidTiers = data.raidTiers.filter(tier => tier.id !== tierId);
            
            // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
            if (data.players && data.players[tierId]) {
                delete data.players[tierId];
            }
            if (data.gearPolicies && data.gearPolicies[tierId]) {
                delete data.gearPolicies[tierId];
            }
            if (data.weaponWishes && data.weaponWishes[tierId]) {
                delete data.weaponWishes[tierId];
            }
            if (data.allocations && data.allocations[tierId]) {
                delete data.allocations[tierId];
            }
            if (data.positionPriorities && data.positionPriorities[tierId]) {
                delete data.positionPriorities[tierId];
            }
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ†ã‚£ã‚¢ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
            if (data.activeRaidTierId === tierId) {
                if (data.raidTiers.length > 0) {
                    // ä»–ã®ãƒ†ã‚£ã‚¢ãŒã‚ã‚‹å ´åˆã¯æœ€åˆã®ã‚‚ã®ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    data.activeRaidTierId = data.raidTiers[0].id;
                    data.raidTiers[0].isActive = true;
                    currentRaidTier = data.raidTiers[0];
                } else {
                    // ãƒ†ã‚£ã‚¢ãŒå…¨ããªã„å ´åˆ
                    data.activeRaidTierId = null;
                    currentRaidTier = null;
                }
            }
            
            saveData(data);
            alert(`ã€Œ${tierName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
            
            // ç”»é¢ã‚’å†æç”»
            showRaidTierSelection();
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä½œæˆ
        function createNewRaidTier() {
            const name = document.getElementById('tier-name').value.trim();
            const description = document.getElementById('tier-description').value.trim();
            
            if (!name) {
                alert('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const data = getData();
            const newTier = {
                id: Date.now().toString(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                isActive: false
            };
            
            data.raidTiers.push(newTier);
            saveData(data);
            
            selectRaidTier(newTier.id);
        }

        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ
        function selectRaidTier(tierId) {
            const data = getData();
            const tier = data.raidTiers.find(t => t.id === tierId);
            
            if (tier) {
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’æ›´æ–°
                data.raidTiers.forEach(t => t.isActive = false);
                tier.isActive = true;
                data.activeRaidTierId = tierId;
                saveData(data);
                
                currentRaidTier = tier;
                showInitialSetup();
            }
        }

        // åˆæœŸè¨­å®šç”»é¢
        function showInitialSetup() {
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>åˆæœŸè¨­å®š - ${currentRaidTier.name}</h1>
                
                <div class="setup-navigation">
                    <button class="nav-btn active" onclick="showMemberSetup()">ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</button>
                    <button class="nav-btn" onclick="showEquipmentPolicySetup()">è£…å‚™æ–¹é‡è¨­å®š</button>
                    <button class="nav-btn" onclick="showWeaponWishSetup()">æ­¦å™¨å¸Œæœ›è¨­å®š</button>
                    <button class="nav-btn" onclick="completeSetup()">è¨­å®šå®Œäº†</button>
                </div>
                
                <div id="setup-content">
                    <!-- è¨­å®šå†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                <div class="setup-actions">
                    <button onclick="showRaidTierSelection()">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠã«æˆ»ã‚‹</button>
                </div>
            `;
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSS
            const style = document.createElement('style');
            style.textContent = `
                .setup-navigation {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #0f3460;
                    padding-bottom: 10px;
                }
                .nav-btn {
                    padding: 12px 24px;
                    background-color: #ffffff;
                    border: 1px solid #ddd;
                    color: #666;
                    cursor: pointer;
                    border-radius: 8px 8px 0 0;
                    font-weight: 500;
                    transition: all 0.2s ease;
                }
                .nav-btn.active {
                    background-color: #3498db;
                    color: white;
                    border-bottom: 2px solid #3498db;
                }
                .nav-btn:hover:not(.active) {
                    background-color: #f8f9fa;
                    color: #333;
                    border-color: #3498db;
                }
                .setup-actions {
                    margin-top: 30px;
                    text-align: center;
                }
            `;
            if (!document.getElementById('setup-styles')) {
                style.id = 'setup-styles';
                document.head.appendChild(style);
            }
            
            showMemberSetup();
        }

        // ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šç”»é¢
        function showMemberSetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn').classList.add('active');
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const data = getData();
            const existingPlayers = data.players && data.players[currentRaidTier.id] || {};
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>8äººå›ºå®šãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
                    <p>å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã¨ã‚¸ãƒ§ãƒ–ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                    <div class="member-grid">
                        ${['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'].map(position => {
                            const player = existingPlayers[position] || {};
                            return `
                            <div class="member-card">
                                <h3>${position}</h3>
                                <input type="text" id="name-${position}" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" value="${player.name || ''}" />
                                <input type="text" id="char-${position}" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å" value="${player.characterName || ''}" />
                                <select id="job-${position}">
                                    <option value="">ã‚¸ãƒ§ãƒ–ã‚’é¸æŠ</option>
                                    ${getJobOptionsForPosition(position, player.job)}
                                </select>
                            </div>
                        `;}).join('')}
                    </div>
                    <button onclick="saveMemberSettings()">ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’ä¿å­˜</button>
                </div>
            `;
            
            // ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ç”¨CSS
            const style = document.createElement('style');
            style.textContent = `
                .member-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin: 20px 0;
                }
                .member-card {
                    background-color: #ffffff;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #e9ecef;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .member-card h3 {
                    margin: 0 0 12px 0;
                    color: #2c3e50;
                    text-align: center;
                    font-weight: 600;
                }
                .member-card input, .member-card select {
                    width: 100%;
                    margin: 5px 0;
                    box-sizing: border-box;
                }
            `;
            if (!document.getElementById('member-styles')) {
                style.id = 'member-styles';
                document.head.appendChild(style);
            }
        }

        // ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¥ã‚¸ãƒ§ãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        function getJobOptionsForPosition(position, selectedJob = '') {
            const jobsByPosition = {
                'MT': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                'ST': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                'H1': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å¸«'],
                'H2': ['å­¦è€…', 'è³¢è€…'],
                'D1': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                'D2': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                'D3': ['åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­'], // ãƒ¬ãƒ³ã‚¸ã‚¸ãƒ§ãƒ–ã®ã¿
                'D4': ['é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'] // ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ã‚¸ãƒ§ãƒ–ã®ã¿
            };
            
            return jobsByPosition[position].map(job => 
                `<option value="${job}" ${job === selectedJob ? 'selected' : ''}>${job}</option>`
            ).join('');
        }

        // ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šä¿å­˜
        function saveMemberSettings() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            const data = getData();
            const existingPlayers = data.players && data.players[currentRaidTier.id] || {};
            const players = {};
            
            for (const position of positions) {
                const name = document.getElementById(`name-${position}`).value.trim();
                const characterName = document.getElementById(`char-${position}`).value.trim();
                const job = document.getElementById(`job-${position}`).value;
                
                if (!name || !characterName || !job) {
                    alert(`${position}ã®è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¤ã¤æ›´æ–°
                const existingPlayer = existingPlayers[position] || {};
                players[position] = {
                    id: existingPlayer.id || Date.now().toString() + position,
                    name: name,
                    characterName: characterName,
                    position: position,
                    job: job,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    currentEquipment: existingPlayer.currentEquipment || {},
                    weaponWishes: existingPlayer.weaponWishes || []
                };
            }
            
            if (!data.players) data.players = {};
            data.players[currentRaidTier.id] = players;
            saveData(data);
            
            alert('ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè£…å‚™æ–¹é‡è¨­å®šï¼‰ã«è‡ªå‹•é·ç§»
            showEquipmentPolicySetup();
        }

        // è£…å‚™æ–¹é‡è¨­å®šç”»é¢
        function showEquipmentPolicySetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            if (!players || Object.keys(players).length === 0) {
                const content = document.getElementById('setup-content');
                content.innerHTML = `
                    <div class="section">
                        <h2>è£…å‚™æ–¹é‡è¨­å®š</h2>
                        <p style="color: #ff6b6b;">å…ˆã«ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="showMemberSetup()">ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã«æˆ»ã‚‹</button>
                    </div>
                `;
                return;
            }
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>è£…å‚™æ–¹é‡è¨­å®š</h2>
                    <p>å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®è£…å‚™éƒ¨ä½ã”ã¨ã«ã€Œé›¶å¼ã€ã¾ãŸã¯ã€Œãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div class="policy-grid">
                        ${Object.keys(players).map(position => `
                            <div class="policy-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                <div class="equipment-slots">
                                    ${['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'].map(slot => {
                                        const currentPolicy = players[position].equipmentPolicy && players[position].equipmentPolicy[slot] || 'é›¶å¼';
                                        return `
                                        <div class="slot-policy">
                                            <label>${slot}:</label>
                                            <select id="policy-${position}-${slot}">
                                                <option value="é›¶å¼" ${currentPolicy === 'é›¶å¼' ? 'selected' : ''}>é›¶å¼</option>
                                                <option value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³" ${currentPolicy === 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³' ? 'selected' : ''}>ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³</option>
                                            </select>
                                        </div>
                                    `;}).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="policy-actions">
                        <button onclick="setAllToSavage()">å…¨ã¦é›¶å¼ã«è¨­å®š</button>
                        <button onclick="setAllToTomestone()">å…¨ã¦ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã«è¨­å®š</button>
                        <button onclick="saveEquipmentPolicy()">è£…å‚™æ–¹é‡ã‚’ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            // è£…å‚™æ–¹é‡ç”¨CSS
            const style = document.createElement('style');
            style.textContent = `
                .policy-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 15px;
                    margin: 20px 0;
                }
                .policy-card {
                    background-color: #16213e;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #0f3460;
                }
                .policy-card h3 {
                    margin: 0 0 5px 0;
                    color: #ffd700;
                }
                .policy-card small {
                    color: #999;
                    margin-bottom: 10px;
                    display: block;
                }
                .equipment-slots {
                    margin-top: 10px;
                }
                .slot-policy {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin: 5px 0;
                }
                .slot-policy label {
                    min-width: 50px;
                    color: #ccc;
                }
                .slot-policy select {
                    width: 150px;
                }
                .policy-actions {
                    text-align: center;
                    margin-top: 20px;
                }
                .policy-actions button {
                    margin: 0 10px;
                }
            `;
            if (!document.getElementById('policy-styles')) {
                style.id = 'policy-styles';
                document.head.appendChild(style);
            }
        }
        
        // è£…å‚™æ–¹é‡ä¸€æ‹¬è¨­å®š
        function setAllToSavage() {
            document.querySelectorAll('select[id^="policy-"]').forEach(select => {
                select.value = 'é›¶å¼';
            });
        }
        
        function setAllToTomestone() {
            document.querySelectorAll('select[id^="policy-"]').forEach(select => {
                select.value = 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³';
            });
        }
        
        // è£…å‚™æ–¹é‡ä¿å­˜
        function saveEquipmentPolicy() {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            Object.keys(players).forEach(position => {
                const equipmentPolicy = {};
                ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'].forEach(slot => {
                    const policySelect = document.getElementById(`policy-${position}-${slot}`);
                    if (policySelect) {
                        equipmentPolicy[slot] = policySelect.value;
                    }
                });
                players[position].equipmentPolicy = equipmentPolicy;
            });
            
            saveData(data);
            showWeaponWishSetup();
        }

        function showWeaponWishSetup() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[2].classList.add('active');
            
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            const content = document.getElementById('setup-content');
            content.innerHTML = `
                <div class="section">
                    <h2>4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨å¸Œæœ›è¨­å®š</h2>
                    <p>4å±¤ã§ãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹æ­¦å™¨ã¸ã®å¸Œæœ›ã‚’å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç™»éŒ²ã§ãã¾ã™ã€‚å„ªå…ˆé †ä½ã‚‚è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                    
                    <div class="weapon-wish-grid">
                        ${Object.keys(players).map(position => `
                            <div class="wish-card">
                                <h3>${position} - ${players[position].job}</h3>
                                <small>${players[position].name}</small>
                                
                                <div class="current-wishes" id="wishes-${position}">
                                    <!-- ç¾åœ¨ã®å¸Œæœ›ãƒªã‚¹ãƒˆ -->
                                </div>
                                
                                <div class="add-wish">
                                    <select id="job-wish-${position}">
                                        <option value="">å¸Œæœ›ã‚¸ãƒ§ãƒ–ã‚’é¸æŠ</option>
                                        ${getAllJobOptions()}
                                    </select>
                                    <input type="number" id="priority-${position}" placeholder="å„ªå…ˆåº¦" min="1" max="10" value="1">
                                    <button onclick="addWeaponWish('${position}')">è¿½åŠ </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="wish-actions">
                        <button onclick="completeSetup()">è¨­å®šå®Œäº†</button>
                    </div>
                </div>
            `;
            
            // æ­¦å™¨å¸Œæœ›ç”¨CSS
            const style = document.createElement('style');
            style.textContent = `
                .weapon-wish-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 15px;
                    margin: 20px 0;
                }
                .wish-card {
                    background-color: #16213e;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #0f3460;
                }
                .wish-card h3 {
                    margin: 0 0 5px 0;
                    color: #ffd700;
                }
                .wish-card small {
                    color: #999;
                    margin-bottom: 15px;
                    display: block;
                }
                .current-wishes {
                    min-height: 60px;
                    margin-bottom: 15px;
                }
                .wish-item {
                    background-color: #0f3460;
                    padding: 8px;
                    margin: 5px 0;
                    border-radius: 4px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .wish-item span {
                    color: #ccc;
                }
                .wish-item button {
                    background-color: #ff4757;
                    padding: 2px 8px;
                    font-size: 12px;
                }
                .add-wish {
                    display: flex;
                    gap: 5px;
                    flex-wrap: wrap;
                }
                .add-wish select, .add-wish input {
                    flex: 1;
                    min-width: 120px;
                }
                .add-wish button {
                    background-color: #2ed573;
                }
                .wish-actions {
                    text-align: center;
                    margin-top: 20px;
                }
            `;
            if (!document.getElementById('wish-styles')) {
                style.id = 'wish-styles';
                document.head.appendChild(style);
            }
            
            // æ—¢å­˜ã®å¸Œæœ›ã‚’è¡¨ç¤º
            Object.keys(players).forEach(position => {
                updateWishDisplay(position);
            });
        }
        
        // å…¨ã‚¸ãƒ§ãƒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        function getAllJobOptions() {
            const allJobs = [
                'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å¸«', 'å­¦è€…', 'è³¢è€…',
                'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­', 'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'
            ];
            return allJobs.map(job => `<option value="${job}">${job}</option>`).join('');
        }
        
        // æ­¦å™¨å¸Œæœ›è¿½åŠ 
        function addWeaponWish(position) {
            const jobSelect = document.getElementById(`job-wish-${position}`);
            const priorityInput = document.getElementById(`priority-${position}`);
            
            if (!jobSelect.value) return;
            
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            if (!players[position].weaponWishes) {
                players[position].weaponWishes = [];
            }
            
            // æ—¢ã«åŒã˜ã‚¸ãƒ§ãƒ–ã®å¸Œæœ›ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (players[position].weaponWishes.some(wish => wish.jobName === jobSelect.value)) {
                return; // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯è¿½åŠ ã—ãªã„
            }
            
            players[position].weaponWishes.push({
                jobName: jobSelect.value,
                priority: parseInt(priorityInput.value) || 1,
                addedAt: new Date().toISOString()
            });
            
            // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
            players[position].weaponWishes.sort((a, b) => a.priority - b.priority);
            
            saveData(data);
            
            // è¡¨ç¤ºæ›´æ–°
            updateWishDisplay(position);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            jobSelect.value = '';
            priorityInput.value = '1';
        }
        
        // æ­¦å™¨å¸Œæœ›å‰Šé™¤
        function removeWeaponWish(position, jobName) {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            
            players[position].weaponWishes = players[position].weaponWishes.filter(
                wish => wish.jobName !== jobName
            );
            
            saveData(data);
            updateWishDisplay(position);
        }
        
        // å¸Œæœ›è¡¨ç¤ºæ›´æ–°
        function updateWishDisplay(position) {
            const data = getData();
            const players = data.players[currentRaidTier.id];
            const container = document.getElementById(`wishes-${position}`);
            
            if (!players[position].weaponWishes || players[position].weaponWishes.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 14px;">å¸Œæœ›ãªã—</p>';
                return;
            }
            
            container.innerHTML = players[position].weaponWishes.map(wish => `
                <div class="wish-item">
                    <span>${wish.jobName} (å„ªå…ˆåº¦: ${wish.priority})</span>
                    <button onclick="removeWeaponWish('${position}', '${wish.jobName}')">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        function completeSetup() {
            showMainDashboard();
        }
        
        // ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        function showMainDashboard() {
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${currentRaidTier.name} - ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>è¨­å®šç®¡ç†</h3>
                        <button onclick="showInitialSetup()">ç™»éŒ²å†…å®¹ç¢ºèªãƒ»å¤‰æ›´</button>
                        <button onclick="showPositionPrioritySettings()">ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦è¨­å®š</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ãƒ¬ã‚¤ãƒ‰ã‚¯ãƒªã‚¢</h3>
                        <button onclick="showLayerAllocation(1)">1å±¤ã‚¯ãƒªã‚¢</button>
                        <button onclick="showLayerAllocation(2)">2å±¤ã‚¯ãƒªã‚¢</button>
                        <button onclick="showLayerAllocation(3)">3å±¤ã‚¯ãƒªã‚¢</button>
                        <button onclick="showLayerAllocation(4)">4å±¤ã‚¯ãƒªã‚¢</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>å±¥æ­´ãƒ»çµ±è¨ˆ</h3>
                        <button onclick="showHistory()">é…å¸ƒå±¥æ­´ãƒ»è£…å‚™çŠ¶æ³</button>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ãã®ä»–</h3>
                        <button onclick="showRaidTierSelection()">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢å¤‰æ›´</button>
                        <button onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button onclick="generateTestData()" style="background-color: #e67e22; border-color: #d35400;">ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                    </div>
                </div>
                
                <div class="dashboard-status">
                    <h3>ä»Šé€±ã®é€²è¡ŒçŠ¶æ³</h3>
                    <div id="weekly-progress">
                        <p>å®Ÿè£…äºˆå®šï¼šå„å±¤ã®ã‚¯ãƒªã‚¢çŠ¶æ³ã€å–å¾—è£…å‚™ã®è¡¨ç¤º</p>
                    </div>
                </div>
            `;
            
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
            const style = document.createElement('style');
            style.textContent = `
                .dashboard-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                    margin: 20px 0;
                }
                .dashboard-card {
                    background-color: #16213e;
                    padding: 20px;
                    border-radius: 8px;
                    border: 1px solid #0f3460;
                    text-align: center;
                }
                .dashboard-card h3 {
                    color: #ffd700;
                    margin-bottom: 15px;
                }
                .dashboard-card button {
                    display: block;
                    width: 100%;
                    margin: 10px 0;
                }
                .dashboard-status {
                    margin-top: 30px;
                    padding: 20px;
                    background-color: #16213e;
                    border-radius: 8px;
                }
            `;
            if (!document.getElementById('dashboard-styles')) {
                style.id = 'dashboard-styles';
                document.head.appendChild(style);
            }
        }
        
        // å±¤åˆ¥è£…å‚™åˆ†é…ç”»é¢ï¼ˆå›ºå®šãƒ‰ãƒ­ãƒƒãƒ—å³æ™‚è¡¨ç¤ºæ–¹å¼ï¼‰
        function showLayerAllocation(layer) {
            console.log('showLayerAllocationå‘¼ã³å‡ºã—:', layer);
            
            const app = document.querySelector('.container');
            
            try {
                const data = getData();
                
                console.log('currentRaidTier:', currentRaidTier);
                
                if (!currentRaidTier || !currentRaidTier.id) {
                    app.innerHTML = `
                        <h1>ã‚¨ãƒ©ãƒ¼</h1>
                        <div class="section">
                            <p style="color: #ff6b6b;">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                            <button onclick="showRaidTierSelection()">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠã«æˆ»ã‚‹</button>
                        </div>
                    `;
                    return;
                }
                
                const players = data.players && data.players[currentRaidTier.id];
                console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿:', players);
                
                if (!players || Object.keys(players).length === 0) {
                    app.innerHTML = `
                        <h1>${layer}å±¤è£…å‚™åˆ†é…</h1>
                        <div class="section">
                            <p style="color: #ff6b6b;">å…ˆã«ãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
                            <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        </div>
                    `;
                    return;
                }
                
                // æ­£å¸¸ãªå ´åˆã®HTMLæç”»
                app.innerHTML = `
                <h1>${layer}å±¤ã‚¯ãƒªã‚¢ç¢ºèª</h1>
                
                <div class="allocation-navigation">
                    <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                    <button onclick="generateLayerDropsAndProcess(${layer})" class="refresh-btn">åˆ†é…çµæœã‚’å†è¨ˆç®—</button>
                    <button onclick="generateTestData()" class="test-btn">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                    <button onclick="showItemImportFromWeb(${layer})" class="import-btn">Webã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ å–å¾—</button>
                </div>
                
                <div class="section">
                    <h2>${layer}å±¤å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ </h2>
                    <div id="fixed-drops">
                        <!-- å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
                
                <div class="section">
                    <h2>è‡ªå‹•åˆ†é…çµæœ</h2>
                    <div id="allocation-summary">
                        <!-- åˆ†é…çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
                
                <div class="allocation-actions">
                    <button onclick="confirmAndSaveAllocation(${layer})" class="confirm-btn">ã“ã®çµæœã§ç¢ºå®šãƒ»ä¿å­˜</button>
                </div>
                `;
            
            // å±¤åˆ¥è£…å‚™åˆ†é…ç”¨CSS
            const style = document.createElement('style');
            style.textContent = `
                .allocation-navigation {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #0f3460;
                }
                .generate-btn {
                    background-color: #2ed573 !important;
                }
                .test-btn {
                    background-color: #e74c3c !important;
                }
                .refresh-btn {
                    background-color: #9b59b6 !important;
                }
                .import-btn {
                    background-color: #ff9f43 !important;
                }
                .confirm-btn {
                    background-color: #27ae60 !important;
                    padding: 15px 30px !important;
                    font-size: 16px !important;
                }
                .fixed-drop-item {
                    background-color: #ffffff;
                    padding: 16px 20px;
                    margin: 12px 0;
                    border-radius: 12px;
                    border-left: 4px solid #3498db;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    border: 1px solid #e9ecef;
                }
                .fixed-drop-item h4 {
                    margin: 0;
                    color: #2c3e50;
                    font-size: 16px;
                    font-weight: 600;
                }
                .fixed-drop-item p {
                    margin: 0;
                    color: #666;
                    font-size: 14px;
                }
                .add-item-form {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                    flex-wrap: wrap;
                }
                .add-item-form select, .add-item-form input {
                    flex: 1;
                    min-width: 120px;
                }
                .drop-item {
                    background-color: #16213e;
                    padding: 15px;
                    margin: 10px 0;
                    border-radius: 8px;
                    border: 1px solid #0f3460;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .drop-item-info h4 {
                    margin: 0 0 5px 0;
                    color: #ffd700;
                }
                .drop-item-info p {
                    margin: 0;
                    color: #ccc;
                    font-size: 14px;
                }
                .drop-item-actions button {
                    margin-left: 10px;
                    background-color: #ff4757 !important;
                    padding: 5px 10px;
                    font-size: 12px;
                }
                .allocation-result {
                    background-color: #ffffff;
                    padding: 20px;
                    margin: 16px 0;
                    border-radius: 12px;
                    border-left: 4px solid #3498db;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border: 1px solid #e9ecef;
                }
                .allocation-result h4 {
                    margin: 0 0 12px 0;
                    color: #2c3e50;
                    font-weight: 600;
                    font-size: 18px;
                }
                .allocation-result p {
                    margin: 8px 0;
                    color: #555;
                    line-height: 1.5;
                }
                .allocation-result strong {
                    color: #2c3e50;
                }
                .judgment-list {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 12px;
                    margin-top: 16px;
                }
                .judgment-item {
                    padding: 12px;
                    border-radius: 8px;
                    text-align: center;
                    font-size: 14px;
                    font-weight: 500;
                    transition: transform 0.2s ease;
                    cursor: pointer;
                }
                .judgment-item:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
                }
                .player-name {
                    font-weight: bold;
                    font-size: 16px;
                    margin-bottom: 4px;
                }
                .judgment-text {
                    font-size: 18px;
                    font-weight: bold;
                    margin: 4px 0;
                }
                .priority-text {
                    font-size: 12px;
                    opacity: 0.9;
                    margin: 2px 0;
                }
                .policy-text {
                    font-size: 11px;
                    opacity: 0.8;
                    margin-top: 2px;
                }
                .judgment-need {
                    background-color: #27ae60;
                    color: white;
                    box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
                }
                .judgment-greed {
                    background-color: #f39c12;
                    color: white;
                    box-shadow: 0 2px 4px rgba(243, 156, 18, 0.3);
                }
                .judgment-pass {
                    background-color: #95a5a6;
                    color: white;
                    box-shadow: 0 2px 4px rgba(149, 165, 166, 0.3);
                }
                .allocation-actions {
                    text-align: center;
                    margin-top: 20px;
                }
                .allocation-actions button {
                    margin: 0 10px;
                    padding: 15px 30px;
                    font-size: 16px;
                }
                .allocation-actions button:disabled {
                    background-color: #555 !important;
                    cursor: not-allowed;
                }
                .allocation-result-simple {
                    background-color: #ffffff;
                    padding: 20px;
                    margin-bottom: 15px;
                    border-radius: 12px;
                    border: 2px solid #e9ecef;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .item-winner-display {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .item-name {
                    font-size: 18px;
                    font-weight: bold;
                    color: #2c3e50;
                }
                .winner-name {
                    font-size: 16px;
                    font-weight: 500;
                    color: #27ae60;
                    background-color: #d5f4e6;
                    padding: 8px 16px;
                    border-radius: 20px;
                    border: 2px solid #27ae60;
                }
            `;
            if (!document.getElementById('allocation-styles')) {
                style.id = 'allocation-styles';
                document.head.appendChild(style);
            }
            
                // HTMLã®æç”»å®Œäº†å¾Œã«å‡¦ç†ã‚’å®Ÿè¡Œ
                setTimeout(() => {
                    console.log('DOMè¦ç´ ç¢ºèªä¸­...');
                    const fixedDropsEl = document.getElementById('fixed-drops');
                    const summaryEl = document.getElementById('allocation-summary');
                    console.log('fixed-dropsè¦ç´ :', fixedDropsEl);
                    console.log('allocation-summaryè¦ç´ :', summaryEl);
                    
                    if (fixedDropsEl && summaryEl) {
                        generateLayerDropsAndProcess(layer);
                    } else {
                        console.error('DOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€å†è©¦è¡Œã—ã¾ã™');
                        setTimeout(() => {
                            generateLayerDropsAndProcess(layer);
                        }, 500);
                    }
                }, 200);
                
            } catch (error) {
                console.error('showLayerAllocation ã‚¨ãƒ©ãƒ¼:', error);
                app.innerHTML = `
                    <h1>ã‚¨ãƒ©ãƒ¼</h1>
                    <div class="section">
                        <p style="color: #ff6b6b;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>
                        <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                    </div>
                `;
            }
        }
        
        function showHistory() {
            try {
                const app = document.querySelector('.container');
                const data = getData();
                
                if (!currentRaidTier || !currentRaidTier.id) {
                    app.innerHTML = `
                        <h1>ã‚¨ãƒ©ãƒ¼</h1>
                        <div class="section">
                            <p style="color: #ff6b6b;">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                            <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        </div>
                    `;
                    return;
                }
                
                const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
                const players = data.players && data.players[currentRaidTier.id] || {};
                
                app.innerHTML = `
                    <h1>${currentRaidTier.name} - é…å¸ƒå±¥æ­´ãƒ»è£…å‚™çŠ¶æ³</h1>
                    
                    <div class="history-navigation">
                        <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        <button onclick="exportHistoryData()" class="export-btn">å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    </div>
                    
                    <div class="history-tabs">
                        <button class="tab-btn active" onclick="showAllocationHistory()">é…å¸ƒå±¥æ­´</button>
                        <button class="tab-btn" onclick="showPlayerEquipmentStatus()">è£…å‚™çŠ¶æ³</button>
                        <button class="tab-btn" onclick="showWeeklyStatistics()">é€±åˆ¥çµ±è¨ˆ</button>
                    </div>
                    
                    <div id="history-content">
                        <!-- å±¥æ­´å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                `;
                
                // å±¥æ­´ç”¨CSS
                const style = document.createElement('style');
                style.textContent = `
                    .history-navigation {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e9ecef;
                    }
                    .export-btn {
                        background-color: #17a2b8 !important;
                    }
                    .history-tabs {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #e9ecef;
                        padding-bottom: 10px;
                    }
                    .tab-btn {
                        padding: 12px 24px;
                        background-color: #f8f9fa;
                        border: 1px solid #dee2e6;
                        color: #495057;
                        cursor: pointer;
                        border-radius: 8px 8px 0 0;
                        font-weight: 500;
                        transition: all 0.2s ease;
                    }
                    .tab-btn.active {
                        background-color: #3498db;
                        color: white;
                        border-bottom: 2px solid #3498db;
                    }
                    .tab-btn:hover:not(.active) {
                        background-color: #e9ecef;
                        color: #2c3e50;
                        border-color: #3498db;
                    }
                    .allocation-history-item {
                        background-color: #ffffff;
                        padding: 20px;
                        margin: 15px 0;
                        border-radius: 12px;
                        border-left: 4px solid #3498db;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        border: 1px solid #e9ecef;
                    }
                    .allocation-history-item h4 {
                        margin: 0 0 10px 0;
                        color: #2c3e50;
                        font-weight: 600;
                    }
                    .allocation-history-item p {
                        margin: 5px 0;
                        color: #555;
                    }
                    .allocation-history-item small {
                        color: #95a5a6;
                    }
                    .player-equipment-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 20px;
                        margin: 20px 0;
                    }
                    .player-equipment-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    .player-equipment-card h3 {
                        margin: 0 0 15px 0;
                        color: #2c3e50;
                        font-weight: 600;
                        text-align: center;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #3498db;
                    }
                    .equipment-slot {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 0;
                        border-bottom: 1px solid #f1f3f4;
                    }
                    .equipment-slot:last-child {
                        border-bottom: none;
                    }
                    .equipment-slot-name {
                        font-weight: 500;
                        color: #495057;
                        min-width: 60px;
                    }
                    .equipment-item {
                        flex: 1;
                        text-align: right;
                        color: #6c757d;
                    }
                    .equipment-item.has-item {
                        color: #28a745;
                        font-weight: 500;
                    }
                    .equipment-item.no-item {
                        color: #dc3545;
                        font-style: italic;
                    }
                    .statistics-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                        margin: 20px 0;
                    }
                    .stat-card {
                        background-color: #ffffff;
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        text-align: center;
                    }
                    .stat-card h3 {
                        margin: 0 0 10px 0;
                        color: #2c3e50;
                        font-weight: 600;
                    }
                    .stat-number {
                        font-size: 2.5rem;
                        font-weight: 700;
                        color: #3498db;
                        margin: 10px 0;
                    }
                    .stat-description {
                        color: #6c757d;
                        font-size: 14px;
                    }
                    .filter-section {
                        background-color: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        border: 1px solid #e9ecef;
                    }
                    .filter-controls {
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        align-items: center;
                    }
                    .filter-controls select, .filter-controls input {
                        padding: 8px 12px;
                        border: 1px solid #ced4da;
                        border-radius: 6px;
                        background-color: white;
                        color: #495057;
                    }
                `;
                if (!document.getElementById('history-styles')) {
                    style.id = 'history-styles';
                    document.head.appendChild(style);
                }
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é…å¸ƒå±¥æ­´ã‚’è¡¨ç¤º
                setTimeout(() => {
                    showAllocationHistory();
                }, 100);
                
            } catch (error) {
                console.error('showHistory ã‚¨ãƒ©ãƒ¼:', error);
                const app = document.querySelector('.container');
                app.innerHTML = `
                    <h1>ã‚¨ãƒ©ãƒ¼</h1>
                    <div class="section">
                        <p style="color: #ff6b6b;">å±¥æ­´è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>
                        <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                    </div>
                `;
            }
        }
        
        // é…å¸ƒå±¥æ­´è¡¨ç¤º
        function showAllocationHistory() {
            try {
                // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                
                const data = getData();
                const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
                const content = document.getElementById('history-content');
                
                if (allocations.length === 0) {
                    content.innerHTML = `
                        <div class="section">
                            <h3>é…å¸ƒå±¥æ­´</h3>
                            <p>ã¾ã è£…å‚™ã®é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                            <p>ãƒ¬ã‚¤ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¦è£…å‚™ã‚’åˆ†é…ã™ã‚‹ã¨ã€ã“ã“ã«å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                        </div>
                    `;
                    return;
                }
                
                // å±¥æ­´ã‚’æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
                const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                content.innerHTML = `
                    <div class="filter-section">
                        <h3>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                        <div class="filter-controls">
                            <label>å±¤:</label>
                            <select id="layer-filter" onchange="filterAllocationHistory()">
                                <option value="">ã™ã¹ã¦ã®å±¤</option>
                                <option value="1">1å±¤</option>
                                <option value="2">2å±¤</option>
                                <option value="3">3å±¤</option>
                                <option value="4">4å±¤</option>
                            </select>
                            
                            <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:</label>
                            <select id="player-filter" onchange="filterAllocationHistory()">
                                <option value="">ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</option>
                                ${getUniquePlayersFromAllocations(allocations).map(player => 
                                    `<option value="${player}">${player}</option>`
                                ).join('')}
                            </select>
                            
                            <label>é€±:</label>
                            <select id="week-filter" onchange="filterAllocationHistory()">
                                <option value="">ã™ã¹ã¦ã®é€±</option>
                                ${getUniqueWeeksFromAllocations(allocations).map(week => 
                                    `<option value="${week}">${week}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div id="filtered-allocations">
                        ${renderAllocationHistory(sortedAllocations)}
                    </div>
                `;
                
            } catch (error) {
                console.error('showAllocationHistory ã‚¨ãƒ©ãƒ¼:', error);
                const content = document.getElementById('history-content');
                content.innerHTML = `<p style="color: #ff6b6b;">å±¥æ­´è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            }
        }
        
        // é…å¸ƒå±¥æ­´ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderAllocationHistory(allocations) {
            if (allocations.length === 0) {
                return '<p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            
            return allocations.map(allocation => {
                const timestamp = new Date(allocation.timestamp);
                const formattedDate = timestamp.toLocaleString('ja-JP');
                const winnerText = allocation.winner ? 
                    `${allocation.winner.name} (${allocation.winner.position})` : 
                    'ãªã—';
                
                return `
                    <div class="allocation-history-item">
                        <h4>${allocation.equipment.name}</h4>
                        <p><strong>å±¤:</strong> ${allocation.layer}å±¤</p>
                        <p><strong>å‹è€…:</strong> ${winnerText}</p>
                        <p><strong>éƒ¨ä½:</strong> ${allocation.equipment.slot} (IL${allocation.equipment.itemLevel})</p>
                        <p><strong>é€±:</strong> ${allocation.week || 'ä¸æ˜'}</p>
                        <small>é…å¸ƒæ—¥æ™‚: ${formattedDate}</small>
                    </div>
                `;
            }).join('');
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
        function filterAllocationHistory() {
            const data = getData();
            const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
            
            const layerFilter = document.getElementById('layer-filter').value;
            const playerFilter = document.getElementById('player-filter').value;
            const weekFilter = document.getElementById('week-filter').value;
            
            let filteredAllocations = allocations;
            
            if (layerFilter) {
                filteredAllocations = filteredAllocations.filter(a => a.layer.toString() === layerFilter);
            }
            
            if (playerFilter) {
                filteredAllocations = filteredAllocations.filter(a => 
                    a.winner && a.winner.name === playerFilter
                );
            }
            
            if (weekFilter) {
                filteredAllocations = filteredAllocations.filter(a => a.week === weekFilter);
            }
            
            // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedFiltered = filteredAllocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            document.getElementById('filtered-allocations').innerHTML = renderAllocationHistory(sortedFiltered);
        }
        
        // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
        function getUniquePlayersFromAllocations(allocations) {
            const playerNames = new Set();
            allocations.forEach(allocation => {
                if (allocation.winner && allocation.winner.name) {
                    playerNames.add(allocation.winner.name);
                }
            });
            return Array.from(playerNames).sort();
        }
        
        // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªé€±ãƒªã‚¹ãƒˆã‚’å–å¾—
        function getUniqueWeeksFromAllocations(allocations) {
            const weeks = new Set();
            allocations.forEach(allocation => {
                if (allocation.week) {
                    weeks.add(allocation.week);
                }
            });
            return Array.from(weeks).sort().reverse(); // æ–°ã—ã„é€±ã‹ã‚‰é †ç•ªã«
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è£…å‚™çŠ¶æ³è¡¨ç¤º
        function showPlayerEquipmentStatus() {
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            
            const data = getData();
            const players = data.players && data.players[currentRaidTier.id] || {};
            const content = document.getElementById('history-content');
            
            if (Object.keys(players).length === 0) {
                content.innerHTML = `
                    <div class="section">
                        <h3>è£…å‚™çŠ¶æ³</h3>
                        <p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                `;
                return;
            }
            
            const equipmentSlots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
            
            content.innerHTML = `
                <div class="section">
                    <h3>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨è£…å‚™çŠ¶æ³</h3>
                    <div class="player-equipment-grid">
                        ${Object.values(players).map(player => {
                            return `
                                <div class="player-equipment-card">
                                    <h3>${player.name} (${player.position}) - ${player.job}</h3>
                                    ${equipmentSlots.map(slot => {
                                        const equipment = player.currentEquipment && player.currentEquipment[slot];
                                        const hasEquipment = equipment && equipment.itemLevel;
                                        
                                        return `
                                            <div class="equipment-slot">
                                                <span class="equipment-slot-name">${slot}:</span>
                                                <span class="equipment-item ${hasEquipment ? 'has-item' : 'no-item'}">
                                                    ${hasEquipment ? 
                                                        `${equipment.name || slot} (IL${equipment.itemLevel})` : 
                                                        'æœªè£…å‚™'
                                                    }
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // é€±åˆ¥çµ±è¨ˆè¡¨ç¤º
        function showWeeklyStatistics() {
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[2].classList.add('active');
            
            const data = getData();
            const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
            const players = data.players && data.players[currentRaidTier.id] || {};
            const content = document.getElementById('history-content');
            
            if (allocations.length === 0) {
                content.innerHTML = `
                    <div class="section">
                        <h3>é€±åˆ¥çµ±è¨ˆ</h3>
                        <p>é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                `;
                return;
            }
            
            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
            const totalAllocations = allocations.length;
            const totalPlayers = Object.keys(players).length;
            const uniqueWeeks = getUniqueWeeksFromAllocations(allocations);
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®å–å¾—æ•°çµ±è¨ˆ
            const playerStats = {};
            Object.values(players).forEach(player => {
                playerStats[player.name] = {
                    player: player,
                    count: 0,
                    items: []
                };
            });
            
            allocations.forEach(allocation => {
                if (allocation.winner && allocation.winner.name) {
                    const playerName = allocation.winner.name;
                    if (playerStats[playerName]) {
                        playerStats[playerName].count++;
                        playerStats[playerName].items.push(allocation.equipment);
                    }
                }
            });
            
            // å±¤åˆ¥çµ±è¨ˆ
            const layerStats = {};
            [1, 2, 3, 4].forEach(layer => {
                layerStats[layer] = allocations.filter(a => a.layer === layer).length;
            });
            
            content.innerHTML = `
                <div class="section">
                    <h3>é…å¸ƒçµ±è¨ˆ</h3>
                    
                    <div class="statistics-grid">
                        <div class="stat-card">
                            <h3>ç·é…å¸ƒæ•°</h3>
                            <div class="stat-number">${totalAllocations}</div>
                            <div class="stat-description">ã‚¢ã‚¤ãƒ†ãƒ </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3>å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
                            <div class="stat-number">${totalPlayers}</div>
                            <div class="stat-description">äºº</div>
                        </div>
                        
                        <div class="stat-card">
                            <h3>æ´»å‹•é€±æ•°</h3>
                            <div class="stat-number">${uniqueWeeks.length}</div>
                            <div class="stat-description">é€±</div>
                        </div>
                        
                        <div class="stat-card">
                            <h3>å¹³å‡å–å¾—æ•°</h3>
                            <div class="stat-number">${totalPlayers > 0 ? (totalAllocations / totalPlayers).toFixed(1) : 0}</div>
                            <div class="stat-description">ã‚¢ã‚¤ãƒ†ãƒ /äºº</div>
                        </div>
                    </div>
                    
                    <h4>å±¤åˆ¥é…å¸ƒæ•°</h4>
                    <div class="statistics-grid">
                        ${[1, 2, 3, 4].map(layer => `
                            <div class="stat-card">
                                <h3>${layer}å±¤</h3>
                                <div class="stat-number">${layerStats[layer]}</div>
                                <div class="stat-description">ã‚¢ã‚¤ãƒ†ãƒ </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h4>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥å–å¾—æ•°</h4>
                    <div class="player-equipment-grid">
                        ${Object.values(playerStats)
                            .sort((a, b) => b.count - a.count)
                            .map(stat => `
                                <div class="player-equipment-card">
                                    <h3>${stat.player.name} (${stat.player.position})</h3>
                                    <div class="stat-number" style="font-size: 1.8rem; margin: 10px 0;">${stat.count}</div>
                                    <div class="stat-description">ã‚¢ã‚¤ãƒ†ãƒ å–å¾—</div>
                                    ${stat.items.length > 0 ? `
                                        <div style="margin-top: 15px; font-size: 14px;">
                                            <strong>æœ€è¿‘ã®å–å¾—:</strong><br>
                                            ${stat.items.slice(-3).map(item => 
                                                `â€¢ ${item.name} (${item.slot})`
                                            ).join('<br>')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Webã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆUIè¡¨ç¤º
        function showItemImportFromWeb(layer) {
            const app = document.querySelector('.container');
            
            app.innerHTML = `
                <h1>${layer}å±¤ - Webã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ å–å¾—</h1>
                
                <div class="import-navigation">
                    <button onclick="showLayerAllocation(${layer})">å±¤åˆ†é…ç”»é¢ã«æˆ»ã‚‹</button>
                    <button onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                </div>
                
                <div class="section">
                    <h2>FF14 Lodestone ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ å–å¾—</h2>
                    <p>FF14å…¬å¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒšãƒ¼ã‚¸URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã‚’è‡ªå‹•å–å¾—ã§ãã¾ã™ã€‚</p>
                    
                    <div class="url-input-section">
                        <h3>æ–¹æ³•1: å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ å–å¾—</h3>
                        <input type="url" id="item-url" placeholder="https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/..." 
                               style="width: 100%; margin: 10px 0;">
                        <button onclick="importSingleItemFromWeb(${layer})">ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—</button>
                        
                        <div id="single-item-result" style="margin-top: 20px;">
                            <!-- å–å¾—çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    
                    <div class="url-input-section" style="margin-top: 30px;">
                        <h3>æ–¹æ³•2: è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ä¸€æ‹¬å–å¾—</h3>
                        <p>è¤‡æ•°ã®URLã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
                        <textarea id="multiple-urls" rows="8" placeholder="https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/...
https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/...
https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/..." 
                                  style="width: 100%; margin: 10px 0; resize: vertical;"></textarea>
                        <button onclick="importMultipleItemsFromWeb(${layer})">ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—</button>
                        
                        <div id="multiple-items-result" style="margin-top: 20px;">
                            <!-- å–å¾—çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    
                    <div class="preset-section" style="margin-top: 30px;">
                        <h3>æ–¹æ³•3: æ—¢çŸ¥ã®ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢è£…å‚™ã‚»ãƒƒãƒˆ</h3>
                        <p>ä¸€èˆ¬çš„ãªãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®è£…å‚™ã‚»ãƒƒãƒˆã‚’è‡ªå‹•è¨­å®šï¼š</p>
                        <select id="preset-raid-tier" style="margin: 10px;">
                            <option value="">ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’é¸æŠ</option>
                            <option value="savage_72">7.2é›¶å¼ï¼ˆå’äººã‚·ãƒªãƒ¼ã‚ºï¼‰</option>
                            <option value="savage_71">7.1é›¶å¼ï¼ˆå’äººã‚·ãƒªãƒ¼ã‚ºï¼‰</option>
                            <option value="savage_70">7.0é›¶å¼ï¼ˆã‚¢ãƒ«ã‚«ãƒ‡ã‚£ã‚¢ã‚·ãƒªãƒ¼ã‚ºï¼‰</option>
                        </select>
                        <button onclick="applyPresetRaidGear(${layer})">ã“ã®ã‚»ãƒƒãƒˆã‚’é©ç”¨</button>
                        
                        <div id="preset-result" style="margin-top: 20px;">
                            <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    
                    <div class="auto-search-section" style="margin-top: 30px;">
                        <h3>æ–¹æ³•4: è‡ªå‹•ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢</h3>
                        <p>FF14ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€é«˜ILã®è£…å‚™ãƒã‚§ã‚¹ãƒˆã‚’è‡ªå‹•æ¤œç´¢ã—ã¦å–å¾—ï¼š</p>
                        <div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin: 10px 0;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ” è‡ªå‹•æ¤œç´¢æ©Ÿèƒ½</h4>
                            <p style="margin: 0; color: #856404;">æŒ‡å®šã—ãŸéƒ¨ä½ã®æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«è£…å‚™ãŒå…¥æ‰‹ã§ãã‚‹ãƒã‚§ã‚¹ãƒˆåã‚’è‡ªå‹•ã§æ¤œç´¢ãƒ»å–å¾—ã—ã¾ã™</p>
                        </div>
                        
                        <div class="search-controls" style="margin: 15px 0;">
                            <label style="font-size: 16px; font-weight: bold; margin-bottom: 15px; display: block;">æ¤œç´¢ã™ã‚‹è£…å‚™éƒ¨ä½ã‚’é¸æŠ:</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 10px 0;">
                                <label><input type="checkbox" value="æ­¦å™¨" class="slot-checkbox"> æ­¦å™¨</label>
                                <label><input type="checkbox" value="é ­" class="slot-checkbox"> é ­</label>
                                <label><input type="checkbox" value="èƒ´" class="slot-checkbox"> èƒ´</label>
                                <label><input type="checkbox" value="æ‰‹" class="slot-checkbox"> æ‰‹</label>
                                <label><input type="checkbox" value="è„š" class="slot-checkbox"> è„š</label>
                                <label><input type="checkbox" value="è¶³" class="slot-checkbox"> è¶³</label>
                                <label><input type="checkbox" value="è€³" class="slot-checkbox"> è€³</label>
                                <label><input type="checkbox" value="é¦–" class="slot-checkbox"> é¦–</label>
                                <label><input type="checkbox" value="è…•" class="slot-checkbox"> è…•</label>
                                <label><input type="checkbox" value="æŒ‡" class="slot-checkbox"> æŒ‡</label>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <button onclick="selectAllSlots()" style="background-color: #28a745; margin-right: 10px;">å…¨é¸æŠ</button>
                                <button onclick="clearAllSlots()" style="background-color: #6c757d;">å…¨è§£é™¤</button>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <label>æœ€å°ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«:</label>
                                <input type="number" id="min-item-level" value="720" min="1" max="999" style="margin-left: 10px; width: 80px;">
                                <small style="color: #666; margin-left: 10px;">â€»ãƒã‚§ã‚¹ãƒˆã‹ã‚‰å…¥æ‰‹ã§ãã‚‹è£…å‚™ã®æœ€å°IL</small>
                            </div>
                        </div>
                        
                        <button onclick="autoSearchHighestILChests(${layer})" class="auto-search-btn" style="background-color: #17a2b8 !important; font-weight: bold;">
                            ğŸ” è‡ªå‹•æ¤œç´¢ã—ã¦åæ˜ 
                        </button>
                        
                        <div id="auto-search-result" style="margin-top: 20px;">
                            <!-- è‡ªå‹•æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>
                
                <div class="imported-items-section">
                    <h2>å–å¾—æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ </h2>
                    <div id="imported-items-list">
                        <!-- å–å¾—ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    
                    <div class="import-actions" style="text-align: center; margin-top: 20px;">
                        <button onclick="applyImportedItems(${layer})" class="confirm-btn" disabled id="apply-btn">
                            ã“ã‚Œã‚‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’${layer}å±¤ãƒ‰ãƒ­ãƒƒãƒ—ã¨ã—ã¦é©ç”¨
                        </button>
                        <button onclick="clearImportedItems()" style="background-color: #e74c3c !important;">
                            å–å¾—ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
            `;
            
            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨CSS
            const style = document.createElement('style');
            style.textContent = `
                .import-navigation {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #e9ecef;
                }
                .url-input-section {
                    background-color: #f8f9fa;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #e9ecef;
                    margin: 15px 0;
                }
                .url-input-section h3 {
                    margin-top: 0;
                    color: #2c3e50;
                }
                .url-input-section input, .url-input-section textarea {
                    padding: 12px;
                    border: 1px solid #ced4da;
                    border-radius: 8px;
                    font-size: 14px;
                    box-sizing: border-box;
                    background-color: white;
                }
                .preset-section {
                    background-color: #e3f2fd;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #bbdefb;
                }
                .auto-search-section {
                    background-color: #e8f5e8;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #c8e6c9;
                }
                .auto-search-section h3 {
                    color: #2e7d32;
                    margin-top: 0;
                }
                .search-controls {
                    background-color: rgba(255,255,255,0.8);
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #a5d6a7;
                }
                .search-controls label {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    font-weight: 500;
                    color: #2e7d32;
                }
                .search-controls input[type="checkbox"] {
                    margin: 0;
                    width: auto;
                }
                .auto-search-btn {
                    padding: 15px 25px !important;
                    font-size: 16px !important;
                    border-radius: 10px !important;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
                    transition: all 0.3s ease !important;
                }
                .auto-search-btn:hover {
                    transform: translateY(-2px) !important;
                    box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
                }
                .imported-items-section {
                    background-color: #f1f8e9;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #c8e6c9;
                    margin-top: 30px;
                }
                .imported-item-card {
                    background-color: white;
                    padding: 15px;
                    margin: 10px 0;
                    border-radius: 8px;
                    border: 1px solid #ddd;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .imported-item-info h4 {
                    margin: 0 0 5px 0;
                    color: #2c3e50;
                }
                .imported-item-info p {
                    margin: 0;
                    color: #666;
                    font-size: 14px;
                }
                .loading-spinner {
                    display: inline-block;
                    width: 20px;
                    height: 20px;
                    border: 3px solid rgba(0,0,0,.1);
                    border-radius: 50%;
                    border-top-color: #3498db;
                    animation: spin 1s ease-in-out infinite;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
                .import-actions {
                    padding-top: 20px;
                    border-top: 2px solid #c8e6c9;
                }
            `;
            if (!document.getElementById('import-styles')) {
                style.id = 'import-styles';
                document.head.appendChild(style);
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åˆæœŸåŒ–
            if (!window.importedItems) {
                window.importedItems = [];
            }
            
            updateImportedItemsList();
        }
        
        // å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ ã®Webã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importSingleItemFromWeb(layer) {
            const urlInput = document.getElementById('item-url');
            const resultDiv = document.getElementById('single-item-result');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (!url.includes('finalfantasyxiv.com/lodestone/playguide/db/item/')) {
                alert('FF14 Lodestone ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¤ãƒ†ãƒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading-spinner"></div> ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—ä¸­...';
            
            try {
                // WebFetchæ©Ÿèƒ½ã¯å®Ÿéš›ã®ç’°å¢ƒã§ã®ã¿å‹•ä½œã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                const itemData = await simulateWebFetch(url);
                
                if (itemData) {
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ 
                    window.importedItems = window.importedItems || [];
                    window.importedItems.push({
                        ...itemData,
                        layer: layer,
                        source: 'web',
                        url: url
                    });
                    
                    resultDiv.innerHTML = `
                        <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <h4 style="color: #155724; margin: 0 0 10px 0;">âœ… ã‚¢ã‚¤ãƒ†ãƒ å–å¾—æˆåŠŸ</h4>
                            <p><strong>åå‰:</strong> ${itemData.name}</p>
                            <p><strong>éƒ¨ä½:</strong> ${itemData.slot}</p>
                            <p><strong>ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«:</strong> ${itemData.itemLevel}</p>
                            <p><strong>ã‚¿ã‚¤ãƒ—:</strong> ${itemData.type}</p>
                        </div>
                    `;
                    
                    updateImportedItemsList();
                    urlInput.value = '';
                } else {
                    throw new Error('ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
            } catch (error) {
                console.error('Webå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                resultDiv.innerHTML = `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">âŒ å–å¾—å¤±æ•—</h4>
                        <p>ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</p>
                        <p>URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
            }
        }
        
        // è¤‡æ•°ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸€æ‹¬Webã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importMultipleItemsFromWeb(layer) {
            const textArea = document.getElementById('multiple-urls');
            const resultDiv = document.getElementById('multiple-items-result');
            const urls = textArea.value.trim().split('\n').filter(url => url.trim());
            
            if (urls.length === 0) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            resultDiv.innerHTML = `<div class="loading-spinner"></div> ${urls.length}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—ä¸­...`;
            
            const results = [];
            const errors = [];
            
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i].trim();
                
                if (!url.includes('finalfantasyxiv.com/lodestone/playguide/db/item/')) {
                    errors.push(`URL ${i + 1}: ç„¡åŠ¹ãªLodestone URL`);
                    continue;
                }
                
                try {
                    const itemData = await simulateWebFetch(url);
                    if (itemData) {
                        results.push({
                            ...itemData,
                            layer: layer,
                            source: 'web',
                            url: url
                        });
                    } else {
                        errors.push(`URL ${i + 1}: ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—`);
                    }
                } catch (error) {
                    errors.push(`URL ${i + 1}: ${error.message}`);
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã®æ›´æ–°
                resultDiv.innerHTML = `<div class="loading-spinner"></div> ${i + 1}/${urls.length} å®Œäº†...`;
                
                // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è€ƒæ…®ã—ã¦å°‘ã—å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // æˆåŠŸã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚¹ãƒˆã«è¿½åŠ 
            window.importedItems = window.importedItems || [];
            window.importedItems.push(...results);
            
            // çµæœè¡¨ç¤º
            let resultHtml = '';
            
            if (results.length > 0) {
                resultHtml += `
                    <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb; margin-bottom: 15px;">
                        <h4 style="color: #155724; margin: 0 0 10px 0;">âœ… ${results.length}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ å–å¾—æˆåŠŸ</h4>
                        ${results.map(item => `<p>â€¢ ${item.name} (${item.slot})</p>`).join('')}
                    </div>
                `;
            }
            
            if (errors.length > 0) {
                resultHtml += `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">âŒ ${errors.length}å€‹ã®ã‚¨ãƒ©ãƒ¼</h4>
                        ${errors.map(error => `<p>â€¢ ${error}</p>`).join('')}
                    </div>
                `;
            }
            
            resultDiv.innerHTML = resultHtml;
            updateImportedItemsList();
            textArea.value = '';
        }
        
        // WebFetchã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯æœ¬ç‰©ã®WebFetchæ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
        async function simulateWebFetch(url) {
            // URLã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ IDã‚’æŠ½å‡º
            const itemIdMatch = url.match(/\/item\/([a-f0-9]+)\//);
            if (!itemIdMatch) {
                throw new Error('URLã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ IDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“');
            }
            
            const itemId = itemIdMatch[1];
            
            // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ WebFetch ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ï¼‰
            const dummyItems = {
                '545b8977a73': { name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ã‚½ãƒ¼ãƒ‰', slot: 'æ­¦å™¨', itemLevel: 735, type: 'weapon' },
                '12345abcdef': { name: 'å’äººã®ã‚¤ãƒ¤ãƒªãƒ³ã‚°', slot: 'è€³', itemLevel: 730, type: 'accessory' },
                '67890fedcba': { name: 'å’äººã®ãƒãƒ¼ãƒãƒ¼ã‚¯', slot: 'èƒ´', itemLevel: 730, type: 'armor' },
                'abc123def45': { name: 'å’äººã®æ­¦å™¨ç®±', slot: 'æ­¦å™¨', itemLevel: 735, type: 'weapon_box' }
            };
            
            // ãƒ€ãƒŸãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã¾ãŸã¯ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
            if (dummyItems[itemId]) {
                return dummyItems[itemId];
            } else {
                // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆ
                const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
                const types = ['weapon', 'armor', 'accessory'];
                const randomSlot = slots[Math.floor(Math.random() * slots.length)];
                
                return {
                    name: `å–å¾—ã‚¢ã‚¤ãƒ†ãƒ ${itemId.substr(0, 6)}`,
                    slot: randomSlot,
                    itemLevel: 720 + Math.floor(Math.random() * 15),
                    type: randomSlot === 'æ­¦å™¨' ? 'weapon' : (randomSlot === 'è€³' || randomSlot === 'é¦–' || randomSlot === 'è…•' || randomSlot === 'æŒ‡' ? 'accessory' : 'armor')
                };
            }
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ¬ã‚¤ãƒ‰è£…å‚™ã®é©ç”¨
        function applyPresetRaidGear(layer) {
            const selectElement = document.getElementById('preset-raid-tier');
            const resultDiv = document.getElementById('preset-result');
            const selectedTier = selectElement.value;
            
            if (!selectedTier) {
                alert('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const presetGear = {
                'savage_72': {
                    1: [
                        { name: 'å’äººã®ã‚¤ãƒ¤ãƒªãƒ³ã‚°', slot: 'è€³', itemLevel: 730, type: 'accessory' },
                        { name: 'å’äººã®ãƒãƒƒã‚¯ãƒ¬ã‚¹', slot: 'é¦–', itemLevel: 730, type: 'accessory' },
                        { name: 'å’äººã®ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', slot: 'è…•', itemLevel: 730, type: 'accessory' },
                        { name: 'å’äººã®ãƒªãƒ³ã‚°', slot: 'æŒ‡', itemLevel: 730, type: 'accessory' }
                    ],
                    2: [
                        { name: 'å’äººã®ãƒ˜ãƒƒãƒ‰ã‚®ã‚¢', slot: 'é ­', itemLevel: 730, type: 'armor' },
                        { name: 'å’äººã®ã‚¬ãƒ³ãƒˆãƒ¬ãƒƒãƒˆ', slot: 'æ‰‹', itemLevel: 730, type: 'armor' },
                        { name: 'å’äººã®ã‚½ãƒ«ãƒ¬ãƒƒãƒˆ', slot: 'è¶³', itemLevel: 730, type: 'armor' },
                        { name: 'å’äººã®æ­¦å™¨çŸ³', slot: 'æ­¦å™¨çŸ³', itemLevel: 1, type: 'material' },
                        { name: 'å’äººã®ç¡¬åŒ–è–¬', slot: 'ç¡¬åŒ–è–¬', itemLevel: 1, type: 'material' }
                    ],
                    3: [
                        { name: 'å’äººã®ãƒãƒ¼ãƒãƒ¼ã‚¯', slot: 'èƒ´', itemLevel: 730, type: 'armor' },
                        { name: 'å’äººã®ãƒ–ãƒªãƒ¼ãƒ', slot: 'è„š', itemLevel: 730, type: 'armor' },
                        { name: 'å’äººã®å¼·åŒ–è–¬', slot: 'å¼·åŒ–è–¬', itemLevel: 1, type: 'material' },
                        { name: 'å’äººã®å¼·åŒ–ç¹Šç¶­', slot: 'å¼·åŒ–ç¹Šç¶­', itemLevel: 1, type: 'material' }
                    ],
                    4: [
                        { name: 'å’äººã®ãƒãƒ¼ãƒãƒ¼ã‚¯', slot: 'èƒ´', itemLevel: 730, type: 'armor' },
                        { name: 'å’äººã®æ­¦å™¨ç®±', slot: 'æ­¦å™¨', itemLevel: 735, type: 'weapon_box' },
                        { name: 'å’äººã®ãƒã‚¦ãƒ³ãƒˆ', slot: 'ãƒã‚¦ãƒ³ãƒˆ', itemLevel: 1, type: 'mount' }
                    ]
                }
            };
            
            const tierData = presetGear[selectedTier];
            if (tierData && tierData[layer]) {
                window.importedItems = window.importedItems || [];
                const newItems = tierData[layer].map(item => ({
                    ...item,
                    layer: layer,
                    source: 'preset'
                }));
                
                window.importedItems.push(...newItems);
                
                resultDiv.innerHTML = `
                    <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb;">
                        <h4 style="color: #155724; margin: 0 0 10px 0;">âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨å®Œäº†</h4>
                        <p>${newItems.length}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚</p>
                    </div>
                `;
                
                updateImportedItemsList();
            } else {
                resultDiv.innerHTML = `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">âŒ è©²å½“ãªã—</h4>
                        <p>é¸æŠã•ã‚ŒãŸãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®${layer}å±¤ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                `;
            }
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã®æ›´æ–°
        function updateImportedItemsList() {
            const listDiv = document.getElementById('imported-items-list');
            const applyBtn = document.getElementById('apply-btn');
            
            if (!window.importedItems || window.importedItems.length === 0) {
                listDiv.innerHTML = '<p>ã¾ã ã‚¢ã‚¤ãƒ†ãƒ ãŒå–å¾—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                if (applyBtn) applyBtn.disabled = true;
                return;
            }
            
            listDiv.innerHTML = window.importedItems.map((item, index) => `
                <div class="imported-item-card">
                    <div class="imported-item-info">
                        <h4>${item.name}</h4>
                        <p>éƒ¨ä½: ${item.slot} | IL: ${item.itemLevel} | ã‚½ãƒ¼ã‚¹: ${item.source}</p>
                    </div>
                    <button onclick="removeImportedItem(${index})" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px;">
                        å‰Šé™¤
                    </button>
                </div>
            `).join('');
            
            if (applyBtn) applyBtn.disabled = false;
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®å‰Šé™¤
        function removeImportedItem(index) {
            if (window.importedItems && window.importedItems[index]) {
                window.importedItems.splice(index, 1);
                updateImportedItemsList();
            }
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªã‚¢
        function clearImportedItems() {
            if (confirm('å–å¾—ã—ãŸã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                window.importedItems = [];
                updateImportedItemsList();
            }
        }
        
        // è‡ªå‹•ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã§æœ€é«˜ILãƒã‚§ã‚¹ãƒˆã‚’å–å¾—
        async function autoSearchHighestILChests(layer) {
            const resultDiv = document.getElementById('auto-search-result');
            const selectedSlots = Array.from(document.querySelectorAll('.slot-checkbox:checked'))
                .map(cb => cb.value);
            const minItemLevel = parseInt(document.getElementById('min-item-level').value) || 720;
            
            if (selectedSlots.length === 0) {
                alert('æ¤œç´¢ã™ã‚‹è£…å‚™éƒ¨ä½ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            console.log('è‡ªå‹•æ¤œç´¢é–‹å§‹:', selectedSlots);
            
            resultDiv.innerHTML = `
                <div class="loading-spinner"></div> 
                ${selectedSlots.length}å€‹ã®éƒ¨ä½ã«ã¤ã„ã¦æœ€é«˜ILãƒã‚§ã‚¹ãƒˆã‚’æ¤œç´¢ä¸­...
            `;
            
            try {
                const searchResults = [];
                
                for (let i = 0; i < selectedSlots.length; i++) {
                    const slot = selectedSlots[i];
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                    resultDiv.innerHTML = `
                        <div class="loading-spinner"></div> 
                        ${slot}è£…å‚™ã®ãƒã‚§ã‚¹ãƒˆã‚’æ¤œç´¢ä¸­... (${i + 1}/${selectedSlots.length})
                    `;
                    
                    try {
                        const chestData = await searchHighestILChestForSlot(slot, minItemLevel);
                        console.log(`${slot}æ¤œç´¢çµæœ:`, chestData);
                        if (chestData) {
                            // URLã‚’è¿½åŠ 
                            chestData.sourceUrl = chestData.url || `æ¤œç´¢ã‚¯ã‚¨ãƒª: ${slot} ãƒã‚§ã‚¹ãƒˆ`;
                            searchResults.push(chestData);
                        }
                    } catch (error) {
                        console.error(`${slot}ã®æ¤œç´¢ã‚¨ãƒ©ãƒ¼:`, error);
                        // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤ºã«å«ã‚ã‚‹
                        searchResults.push({
                            name: `${slot}ãƒã‚§ã‚¹ãƒˆæ¤œç´¢ã‚¨ãƒ©ãƒ¼`,
                            slot: slot,
                            itemLevel: 0,
                            maxItemLevel: 0,
                            type: 'error',
                            description: `æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${error.message}`,
                            sourceUrl: `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`
                        });
                    }
                    
                    // çŸ­ã„å¾…æ©Ÿæ™‚é–“
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                console.log('æ¤œç´¢å®Œäº†ã€‚çµæœæ•°:', searchResults.length);
                
                if (searchResults.length > 0) {
                    // æˆåŠŸã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒªã‚¹ãƒˆã«è¿½åŠ 
                    window.importedItems = window.importedItems || [];
                    window.importedItems.push(...searchResults);
                    
                    resultDiv.innerHTML = `
                        <div style="background-color: #d4edda; padding: 20px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <h4 style="color: #155724; margin: 0 0 15px 0;">âœ… è‡ªå‹•æ¤œç´¢å®Œäº†</h4>
                            <p style="margin: 0 0 15px 0;"><strong>${searchResults.length}å€‹ã®ãƒã‚§ã‚¹ãƒˆ</strong>ã‚’å–å¾—ã—ã¾ã—ãŸ:</p>
                            ${searchResults.map(item => `
                                <div style="background-color: rgba(255,255,255,0.8); padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #28a745;">
                                    <strong style="color: #155724;">${item.name}</strong><br>
                                    <span style="color: #666;">éƒ¨ä½: ${item.slot} | å…¥æ‰‹å¯èƒ½è£…å‚™IL: ${item.maxItemLevel}</span><br>
                                    <small style="color: #6c757d;">${item.description}</small><br>
                                    ${item.sourceUrl ? `<small style="color: #0066cc;"><strong>å‚ç…§URL:</strong> <a href="${item.sourceUrl}" target="_blank" style="color: #0066cc;">${item.sourceUrl}</a></small>` : ''}
                                </div>
                            `).join('')}
                            <p style="margin: 15px 0 0 0; color: #155724;">
                                â¬‡ï¸ ä¸‹ã®ã€Œå–å¾—æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç¢ºèªãƒ»é©ç”¨ã—ã¦ãã ã•ã„
                            </p>
                        </div>
                    `;
                    
                    updateImportedItemsList();
                } else {
                    resultDiv.innerHTML = `
                        <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                            <h4 style="color: #721c24; margin: 0 0 10px 0;">âŒ æ¤œç´¢çµæœãªã—</h4>
                            <p style="margin: 0;">æŒ‡å®šæ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒã‚§ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                            <p style="margin: 5px 0 0 0;">æœ€å°ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã‚’ä¸‹ã’ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('è‡ªå‹•æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                resultDiv.innerHTML = `
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4 style="color: #721c24; margin: 0 0 10px 0;">âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼</h4>
                        <p style="margin: 0;">è‡ªå‹•æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>
                        <p style="margin: 5px 0 0 0;">ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
            }
        }
        
        // æŒ‡å®šéƒ¨ä½ã®æœ€é«˜ILãƒã‚§ã‚¹ãƒˆã‚’æ¤œç´¢ï¼ˆå®Ÿéš›ã®FF14ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ï¼‰
        async function searchHighestILChestForSlot(slot, minItemLevel) {
            console.log(`${slot}ã®æœ€é«˜ILãƒã‚§ã‚¹ãƒˆã‚’æ¤œç´¢ä¸­...`);
            
            try {
                // FF14 Lodestoneãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§æ¤œç´¢
                const searchResults = await searchFF14Database(slot, minItemLevel);
                
                if (searchResults && searchResults.name) {
                    console.log(`${slot}ãƒã‚§ã‚¹ãƒˆè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:`, searchResults.name);
                    return {
                        ...searchResults,
                        slot: slot,
                        layer: null,
                        source: 'ff14_database',
                        searchTimestamp: new Date().toISOString()
                    };
                } else {
                    console.log(`${slot}ã®æ¡ä»¶ã«åˆã†ãƒã‚§ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                    return null;
                }
                
            } catch (error) {
                console.error(`${slot}ã®æ¤œç´¢ã‚¨ãƒ©ãƒ¼:`, error);
                throw error;
            }
        }
        
        // FF14ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã®å®Ÿè£…
        async function searchFF14Database(slot, minItemLevel) {
            console.log(`FF14ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§${slot}è£…å‚™ã®ãƒã‚§ã‚¹ãƒˆã‚’æ¤œç´¢ä¸­...`);
            
            try {
                // éƒ¨ä½åˆ¥ã®ã‚«ãƒ†ã‚´ãƒªIDãƒãƒƒãƒ”ãƒ³ã‚°
                const categoryMapping = {
                    'æ­¦å™¨': { category2: 1, category3: null },  // æ­¦å™¨
                    'é ­': { category2: 3, category3: 34 },      // é˜²å…·â†’é ­é˜²å…·
                    'èƒ´': { category2: 3, category3: 35 },      // é˜²å…·â†’èƒ´é˜²å…·
                    'æ‰‹': { category2: 3, category3: 37 },      // é˜²å…·â†’æ‰‹é˜²å…·
                    'è„š': { category2: 3, category3: 36 },      // é˜²å…·â†’è„šé˜²å…·
                    'è¶³': { category2: 3, category3: 38 },      // é˜²å…·â†’è¶³é˜²å…·
                    'è€³': { category2: 4, category3: 40 },      // ã‚¢ã‚¯ã‚»ã‚µãƒªâ†’è€³é£¾ã‚Š
                    'é¦–': { category2: 4, category3: 41 },      // ã‚¢ã‚¯ã‚»ã‚µãƒªâ†’é¦–é£¾ã‚Š
                    'è…•': { category2: 4, category3: 42 },      // ã‚¢ã‚¯ã‚»ã‚µãƒªâ†’è…•è¼ª
                    'æŒ‡': { category2: 4, category3: 43 }       // ã‚¢ã‚¯ã‚»ã‚µãƒªâ†’æŒ‡è¼ª
                };
                
                const category = categoryMapping[slot];
                if (!category) {
                    console.log(`æœªå¯¾å¿œã®éƒ¨ä½: ${slot}`);
                    return await searchAlternativeFF14Database(slot, minItemLevel);
                }
                
                // Step 1: ç‰¹å®šã®URLã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆï¼ˆæ­¦å™¨ã®å ´åˆï¼‰
                if (slot === 'æ­¦å™¨') {
                    const specificUrl = 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/2ec7d8cfb2d/';
                    console.log('æ­¦å™¨ç‰¹å®šURLæ¤œç´¢:', specificUrl);
                    
                    const specificResult = await WebFetch(specificUrl, `
                        ã“ã®FF14ã‚¢ã‚¤ãƒ†ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰æ­£ç¢ºãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
                        
                        ãƒšãƒ¼ã‚¸ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„:
                        1. ã‚¢ã‚¤ãƒ†ãƒ åï¼ˆå®Œå…¨ãªåå‰ï¼‰
                        2. ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ï¼ˆã€ILvæ•°å€¤ã€‘å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ï¼‰
                        3. ã‚¢ã‚¤ãƒ†ãƒ ã®ç¨®é¡ï¼ˆãƒã‚§ã‚¹ãƒˆã‹ã©ã†ã‹ï¼‰
                        
                        JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
                        {
                            "name": "æ­£ç¢ºãªã‚¢ã‚¤ãƒ†ãƒ åï¼ˆä¾‹ï¼šãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ã‚¦ã‚§ãƒãƒ³ãƒã‚§ã‚¹ãƒˆã€ILv765ã€‘ï¼‰",
                            "itemLevel": ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                            "maxItemLevel": ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                            "type": "weapon_chest",
                            "url": "${specificUrl}",
                            "description": "FF14ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—",
                            "source": "Lodestone"
                        }
                    `);
                    
                    console.log('æ­¦å™¨ç‰¹å®šURLçµæœ:', specificResult);
                    
                    if (specificResult && specificResult.trim() !== 'null') {
                        try {
                            const parsed = JSON.parse(specificResult);
                            if (parsed.name) {
                                return parsed;
                            }
                        } catch (e) {
                            console.log('æ­¦å™¨ç‰¹å®šURL JSONè§£æå¤±æ•—:', e);
                        }
                    }
                }
                
                // Step 2: ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ç”¨ã—ãŸæ¤œç´¢
                let searchUrl;
                if (category.category3) {
                    searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?category2=${category.category2}&category3=${category.category3}`;
                } else {
                    searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?category2=${category.category2}`;
                }
                
                console.log(`${slot}ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢URL:`, searchUrl);
                
                const searchResult = await WebFetch(searchUrl, `
                    ã“ã®FF14ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ï¼ˆ${slot}è£…å‚™ã‚«ãƒ†ã‚´ãƒªï¼‰ã‚’è§£æã—ã¦ã€æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®ãƒã‚§ã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚
                    
                    æ¢ã—ã¦ã„ã‚‹ã‚‚ã®:
                    - ${slot}è£…å‚™ãŒå…¥æ‰‹ã§ãã‚‹ãƒã‚§ã‚¹ãƒˆ
                    - ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸­ã§æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®ã‚‚ã®
                    - ã€Œâ—‹â—‹ãƒã‚§ã‚¹ãƒˆã€ã€Œâ—‹â—‹ã‚³ãƒ•ã‚¡ãƒ¼ã€ãªã©ã®åå‰ã®ã‚¢ã‚¤ãƒ†ãƒ 
                    - ã‚¢ã‚¤ãƒ†ãƒ åã«ã€ILvæ•°å€¤ã€‘ãŒå«ã¾ã‚Œã¦ã„ã‚‹å½¢å¼ã‚’å„ªå…ˆ
                    - æ¶ç©ºã®åå‰ã¯ä½œã‚‰ãšã€å®Ÿéš›ã«ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ åã®ã¿ã‚’ä½¿ç”¨
                    
                    æ¤œç´¢çµæœã‹ã‚‰æœ€ã‚‚é«˜ã„ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®ãƒã‚§ã‚¹ãƒˆã‚’1ã¤é¸ã‚“ã§ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
                    {
                        "name": "å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒã‚§ã‚¹ãƒˆã®æ­£ç¢ºãªåå‰ï¼ˆã€ILvæ•°å€¤ã€‘ã‚‚å«ã‚€ï¼‰",
                        "itemLevel": ãƒã‚§ã‚¹ãƒˆè‡ªä½“ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                        "maxItemLevel": ã“ã®ãƒã‚§ã‚¹ãƒˆã‹ã‚‰å…¥æ‰‹ã§ãã‚‹è£…å‚™ã®æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                        "type": "weapon_chest/armor_chest/accessory_chest",
                        "url": "ã“ã®ãƒã‚§ã‚¹ãƒˆã®è©³ç´°ãƒšãƒ¼ã‚¸URLï¼ˆå®Ÿéš›ã«ãƒšãƒ¼ã‚¸ã«å­˜åœ¨ã™ã‚‹URLï¼‰",
                        "description": "ãƒã‚§ã‚¹ãƒˆã®èª¬æ˜",
                        "source": "Lodestone"
                    }
                    
                    è©²å½“ã™ã‚‹ãƒã‚§ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ null ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
                `);
                
                console.log(`${slot}ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢çµæœ:`, searchResult);
                
                // JSONãƒ‘ãƒ¼ã‚¹
                if (searchResult && searchResult.trim() !== 'null') {
                    try {
                        const parsed = JSON.parse(searchResult);
                        
                        // è©³ç´°ãƒšãƒ¼ã‚¸ã‹ã‚‰è¿½åŠ æƒ…å ±ã‚’å–å¾—
                        if (parsed.url && parsed.url !== searchUrl) {
                            console.log('ãƒã‚§ã‚¹ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã‚’å–å¾—ä¸­:', parsed.url);
                            const detailResult = await getChestDetailInfo(parsed.url, slot);
                            if (detailResult) {
                                // è©³ç´°æƒ…å ±ã¨ãƒãƒ¼ã‚¸
                                return {
                                    ...parsed,
                                    ...detailResult,
                                    url: parsed.url  // å…ƒã®URLã‚’ä¿æŒ
                                };
                            }
                        }
                        
                        // æœ€å°ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
                        if (parsed.maxItemLevel && parsed.maxItemLevel >= minItemLevel) {
                            return parsed;
                        } else {
                            console.log(`${slot}: è¦‹ã¤ã‹ã£ãŸãƒã‚§ã‚¹ãƒˆã®æœ€é«˜IL${parsed.maxItemLevel}ãŒæœ€å°è¦æ±‚IL${minItemLevel}ã‚’ä¸‹å›ã‚Šã¾ã™`);
                            return null;
                        }
                    } catch (parseError) {
                        console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', parseError);
                        console.log('ç”Ÿã®å¿œç­”:', searchResult);
                        
                        // JSONè§£æã«å¤±æ•—ã—ãŸå ´åˆã€ä»£æ›¿æ¤œç´¢ã‚’è©¦ã™
                        return await searchAlternativeFF14Database(slot, minItemLevel);
                    }
                } else {
                    console.log(`${slot}ã®æ¡ä»¶ã«åˆã†ãƒã‚§ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                    return await searchAlternativeFF14Database(slot, minItemLevel);
                }
                
            } catch (error) {
                console.error(`FF14ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã‚¨ãƒ©ãƒ¼ (${slot}):`, error);
                
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ä»£æ›¿æ¤œç´¢ã‚’è©¦ã™
                return await searchAlternativeFF14Database(slot, minItemLevel);
            }
        }
        
        // ãƒã‚§ã‚¹ãƒˆè©³ç´°æƒ…å ±ã‚’å–å¾—
        async function getChestDetailInfo(chestUrl, slot) {
            try {
                console.log(`ãƒã‚§ã‚¹ãƒˆè©³ç´°æƒ…å ±ã‚’å–å¾—ä¸­: ${chestUrl}`);
                
                const detailResult = await WebFetch(chestUrl, `
                    ã“ã®FF14ãƒã‚§ã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æ­£ç¢ºã«æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š
                    
                    1. ã‚¢ã‚¤ãƒ†ãƒ åï¼ˆå®Œå…¨ãªåå‰ï¼‰
                    2. ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«
                    3. ã“ã®ãƒã‚§ã‚¹ãƒˆã‹ã‚‰å…¥æ‰‹ã§ãã‚‹è£…å‚™ã®æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«
                    4. è£…å‚™éƒ¨ä½ï¼ˆ${slot}ã«é–¢é€£ã™ã‚‹ã‹ç¢ºèªï¼‰
                    5. å…¥æ‰‹æ–¹æ³•ã‚„ã‚½ãƒ¼ã‚¹æƒ…å ±
                    
                    JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
                    {
                        "name": "æ­£ç¢ºãªã‚¢ã‚¤ãƒ†ãƒ å",
                        "itemLevel": ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                        "maxItemLevel": å…¥æ‰‹å¯èƒ½è£…å‚™ã®æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                        "equipmentSlot": "è£…å‚™éƒ¨ä½",
                        "source": "å…¥æ‰‹æ–¹æ³•ãƒ»ã‚½ãƒ¼ã‚¹",
                        "description": "è©³ç´°èª¬æ˜"
                    }
                `);
                
                const parsed = JSON.parse(detailResult);
                console.log('ãƒã‚§ã‚¹ãƒˆè©³ç´°å–å¾—æˆåŠŸ:', parsed);
                return parsed;
                
            } catch (error) {
                console.error('ãƒã‚§ã‚¹ãƒˆè©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // ä»£æ›¿æ¤œç´¢æ–¹æ³•
        async function searchAlternativeFF14Database(slot, minItemLevel) {
            console.log(`${slot}ã®ä»£æ›¿æ¤œç´¢ã‚’å®Ÿè¡Œä¸­...`);
            
            try {
                // ã‚ˆã‚Šå…·ä½“çš„ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã§å†è©¦è¡Œ
                const alternativeQueries = [
                    `${slot}ãƒã‚§ã‚¹ãƒˆ`,
                    `${slot}ã‚³ãƒ•ã‚¡ãƒ¼`,
                    `${slot}ã‚¦ã‚§ãƒãƒ³ãƒã‚§ã‚¹ãƒˆ`,
                    `${slot}ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆ`
                ];
                
                for (const query of alternativeQueries) {
                    console.log(`ä»£æ›¿æ¤œç´¢: ${query}`);
                    
                    const searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?q=${encodeURIComponent(query)}`;
                    
                    try {
                        const result = await WebFetch(searchUrl, `
                            ã“ã®æ¤œç´¢çµæœã‹ã‚‰ã€Œ${slot}ã€è£…å‚™ãŒå…¥æ‰‹ã§ãã‚‹ãƒã‚§ã‚¹ãƒˆã‚’æ¢ã—ã¦ãã ã•ã„ã€‚
                            ã€Œãƒã‚§ã‚¹ãƒˆã€ã€Œã‚³ãƒ•ã‚¡ãƒ¼ã€ã€Œã‚®ã‚¢ã€ãªã©ã®åå‰ãŒå«ã¾ã‚Œã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’å„ªå…ˆçš„ã«é¸ã‚“ã§ãã ã•ã„ã€‚
                            
                            æœ€é©ãªãƒã‚§ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã£ãŸã‚‰ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
                            {
                                "name": "ãƒã‚§ã‚¹ãƒˆå",
                                "itemLevel": ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                                "maxItemLevel": å…¥æ‰‹å¯èƒ½è£…å‚™ã®æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                                "type": "chest",
                                "description": "èª¬æ˜"
                            }
                            
                            è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ null ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
                        `);
                        
                        if (result && result.trim() !== 'null') {
                            const parsed = JSON.parse(result);
                            if (parsed.maxItemLevel >= minItemLevel) {
                                console.log(`ä»£æ›¿æ¤œç´¢æˆåŠŸ: ${parsed.name}`);
                                return parsed;
                            }
                        }
                    } catch (queryError) {
                        console.log(`ä»£æ›¿æ¤œç´¢ "${query}" å¤±æ•—:`, queryError.message);
                        continue;
                    }
                }
                
                // ã™ã¹ã¦ã®ä»£æ›¿æ¤œç´¢ãŒå¤±æ•—ã—ãŸå ´åˆ
                console.log('ã™ã¹ã¦ã®ä»£æ›¿æ¤œç´¢ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                return getFallbackChestData(slot, minItemLevel);
                
            } catch (error) {
                console.error('ä»£æ›¿æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                return getFallbackChestData(slot, minItemLevel);
            }
        }
        
        // WebFetchæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæœ€æ–°ã®FF14ãƒã‚§ã‚¹ãƒˆåã‚’ä½¿ç”¨ï¼‰
        function getFallbackChestData(slot, minItemLevel) {
            console.log(`${slot}ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨`);
            
            // å®Ÿéš›ã®FF14ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æœ€æ–°ãƒã‚§ã‚¹ãƒˆå
            const fallbackData = {
                'æ­¦å™¨': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ã‚¦ã‚§ãƒãƒ³ãƒã‚§ã‚¹ãƒˆã€ILv765ã€‘',
                    itemLevel: 765,
                    maxItemLevel: 765,
                    type: 'weapon_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/2ec7d8cfb2d/',
                    description: 'IL765ã®å„ã‚¸ãƒ§ãƒ–æ­¦å™¨ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'é ­': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ãƒ˜ãƒƒãƒ‰ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®é ­è£…å‚™ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'èƒ´': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ãƒœãƒ‡ã‚£ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®èƒ´è£…å‚™ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'æ‰‹': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ãƒãƒ³ãƒ‰ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®æ‰‹è£…å‚™ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'è„š': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ãƒ¬ãƒƒã‚°ã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®è„šè£…å‚™ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'è¶³': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ãƒ•ãƒƒãƒˆã‚®ã‚¢ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'armor_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®è¶³è£…å‚™ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'è€³': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®ã‚¤ãƒ¤ãƒªãƒ³ã‚°ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'é¦–': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'è…•': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                },
                'æŒ‡': {
                    name: 'ãƒ™ãƒ“ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ãƒã‚§ã‚¹ãƒˆã€ILv750ã€‘',
                    itemLevel: 750,
                    maxItemLevel: 750,
                    type: 'accessory_chest',
                    source: 'FF14æœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
                    url: 'https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/',
                    description: 'IL750ã®ãƒªãƒ³ã‚°ãŒå…¥æ‰‹å¯èƒ½ãªãƒã‚§ã‚¹ãƒˆ'
                }
            };
            
            const data = fallbackData[slot];
            if (!data || data.maxItemLevel < minItemLevel) {
                return null;
            }
            
            return data;
        }
        
        // å…¨é¸æŠãƒ»å…¨è§£é™¤æ©Ÿèƒ½
        function selectAllSlots() {
            document.querySelectorAll('.slot-checkbox').forEach(cb => {
                cb.checked = true;
            });
        }
        
        function clearAllSlots() {
            document.querySelectorAll('.slot-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // å®Ÿéš›ã®WebFetchå®Ÿè£…ä¾‹ï¼ˆæœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ï¼‰
        async function realSearchHighestILChestForSlot(slot, jobRestriction, minItemLevel) {
            try {
                // FF14ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§æ¤œç´¢
                const searchUrl = `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/?q=${slot}+ãƒã‚§ã‚¹ãƒˆ+ã‚³ãƒ•ã‚¡ãƒ¼+ç®±&category2=3`;
                
                const searchResult = await WebFetch(searchUrl, `
                    ã“ã®FF14ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ä»¥ä¸‹ã®æ¡ä»¶ã§æœ€é©ãªãƒã‚§ã‚¹ãƒˆ/ã‚³ãƒ•ã‚¡ãƒ¼ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ï¼š
                    
                    æ¡ä»¶:
                    - è£…å‚™éƒ¨ä½: ${slot}
                    - è·æ¥­åˆ¶é™: ${jobRestriction}
                    - æœ€å°ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«: ${minItemLevel}ä»¥ä¸Š
                    
                    å›ç­”å½¢å¼:
                    {
                        "name": "ãƒã‚§ã‚¹ãƒˆå",
                        "maxItemLevel": å…¥æ‰‹å¯èƒ½ãªè£…å‚™ã®æœ€é«˜ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«,
                        "source": "å…¥æ‰‹å…ˆãƒ¬ã‚¤ãƒ‰/ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å",
                        "description": "è©³ç´°èª¬æ˜"
                    }
                    
                    æœ€ã‚‚é«˜ã„ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®è£…å‚™ãŒå…¥æ‰‹ã§ãã‚‹ãƒã‚§ã‚¹ãƒˆã‚’1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„ã€‚
                `);
                
                return JSON.parse(searchResult);
                
            } catch (error) {
                console.error(`${slot}ã®å®Ÿéš›æ¤œç´¢ã‚¨ãƒ©ãƒ¼:`, error);
                throw error;
            }
        }
        
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å±¤ãƒ‰ãƒ­ãƒƒãƒ—ã¨ã—ã¦é©ç”¨
        function applyImportedItems(layer) {
            if (!window.importedItems || window.importedItems.length === 0) {
                alert('é©ç”¨ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (confirm(`${window.importedItems.length}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’${layer}å±¤ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ`)) {
                // currentDropItemsã«è¨­å®š
                currentDropItems = window.importedItems.map(item => ({
                    slot: item.slot,
                    name: item.name,
                    itemLevel: item.itemLevel,
                    type: item.type
                }));
                
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
                window.importedItems = [];
                
                alert('ã‚¢ã‚¤ãƒ†ãƒ ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸï¼å±¤åˆ†é…ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                showLayerAllocation(layer);
            }
        }
        
        // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportHistoryData() {
            const data = getData();
            const allocations = data.allocations && data.allocations[currentRaidTier.id] || [];
            const players = data.players && data.players[currentRaidTier.id] || {};
            
            const exportData = {
                raidTier: currentRaidTier,
                allocations: allocations,
                players: players,
                exportDate: new Date().toISOString()
            };
            
            const jsonData = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ff14_history_${currentRaidTier.name}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
        }
        
        // å±¤åˆ¥ã‚¹ãƒ­ãƒƒãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¦ä»¶å®šç¾©æ›¸åŸºæº–ï¼‰
        function getSlotOptionsForLayer(layer) {
            const slotsByLayer = {
                1: ['è€³', 'é¦–', 'è…•', 'æŒ‡'],
                2: ['é ­', 'æ‰‹', 'è¶³', 'æ­¦å™¨çŸ³', 'ç¡¬åŒ–è–¬'],
                3: ['èƒ´', 'è„š', 'å¼·åŒ–è–¬', 'å¼·åŒ–ç¹Šç¶­'],
                4: ['èƒ´', 'æ­¦å™¨', 'ãƒã‚¦ãƒ³ãƒˆ']
            };
            
            const slots = slotsByLayer[layer] || [];
            return slots.map(slot => `<option value="${slot}">${slot}</option>`).join('');
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆç¾åœ¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ï¼‰
        let currentDropItems = [];
        let allocationResults = [];
        
        // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—ç”Ÿæˆã¨å³åº§ã«åˆ†é…å‡¦ç†å®Ÿè¡Œ
        function generateLayerDropsAndProcess(layer) {
            try {
                console.log('generateLayerDropsAndProcessé–‹å§‹:', layer);
                const layerDrops = {
                1: [
                    { slot: 'è€³', name: 'å’äººã®ã‚¤ãƒ¤ãƒªãƒ³ã‚°', itemLevel: 730, type: 'accessory' },
                    { slot: 'é¦–', name: 'å’äººã®ãƒãƒƒã‚¯ãƒ¬ã‚¹', itemLevel: 730, type: 'accessory' },
                    { slot: 'è…•', name: 'å’äººã®ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', itemLevel: 730, type: 'accessory' },
                    { slot: 'æŒ‡', name: 'å’äººã®ãƒªãƒ³ã‚°', itemLevel: 730, type: 'accessory' }
                ],
                2: [
                    { slot: 'é ­', name: 'å’äººã®ãƒ˜ãƒƒãƒ‰ã‚®ã‚¢', itemLevel: 730, type: 'armor' },
                    { slot: 'æ‰‹', name: 'å’äººã®ã‚¬ãƒ³ãƒˆãƒ¬ãƒƒãƒˆ', itemLevel: 730, type: 'armor' },
                    { slot: 'è¶³', name: 'å’äººã®ã‚½ãƒ«ãƒ¬ãƒƒãƒˆ', itemLevel: 730, type: 'armor' },
                    { slot: 'æ­¦å™¨çŸ³', name: 'å’äººã®æ­¦å™¨çŸ³', itemLevel: 1, type: 'material' },
                    { slot: 'ç¡¬åŒ–è–¬', name: 'å’äººã®ç¡¬åŒ–è–¬', itemLevel: 1, type: 'material' }
                ],
                3: [
                    { slot: 'èƒ´', name: 'å’äººã®ãƒãƒ¼ãƒãƒ¼ã‚¯', itemLevel: 730, type: 'armor' },
                    { slot: 'è„š', name: 'å’äººã®ãƒ–ãƒªãƒ¼ãƒ', itemLevel: 730, type: 'armor' },
                    { slot: 'å¼·åŒ–è–¬', name: 'å’äººã®å¼·åŒ–è–¬', itemLevel: 1, type: 'material' },
                    { slot: 'å¼·åŒ–ç¹Šç¶­', name: 'å’äººã®å¼·åŒ–ç¹Šç¶­', itemLevel: 1, type: 'material' }
                ],
                4: [
                    { slot: 'èƒ´', name: 'å’äººã®ãƒãƒ¼ãƒãƒ¼ã‚¯', itemLevel: 730, type: 'armor' },
                    { slot: 'æ­¦å™¨', name: 'å’äººã®æ­¦å™¨ç®±', itemLevel: 735, type: 'weapon_box' },
                    { slot: 'ãƒã‚¦ãƒ³ãƒˆ', name: 'å’äººã®ãƒã‚¦ãƒ³ãƒˆ', itemLevel: 1, type: 'mount' },
                    { slot: 'æ­¦å™¨', name: getRandomDirectDropWeapon(), itemLevel: 735, type: 'direct_weapon' }
                ]
            };
            
                // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨­å®š
                currentDropItems = layerDrops[layer] || [];
                console.log('å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ æ•°:', currentDropItems.length);
                
                // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤º
                displayFixedDrops(currentDropItems);
                
                // å³åº§ã«åˆ†é…å‡¦ç†ã‚’å®Ÿè¡Œ
                processAllocationImmediate(layer);
            } catch (error) {
                console.error('generateLayerDropsAndProcess ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // 4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
        function getRandomDirectDropWeapon() {
            const allJobs = [
                'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å¸«', 'å­¦è€…', 'è³¢è€…',
                'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­',
                'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'
            ];
            
            const randomJob = allJobs[Math.floor(Math.random() * allJobs.length)];
            return `å’äººã®${randomJob}æ­¦å™¨`;
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ æ‰‹å‹•è¿½åŠ 
        function addDropItem(layer) {
            const slot = document.getElementById('item-slot').value;
            const name = document.getElementById('item-name').value.trim();
            const itemLevel = parseInt(document.getElementById('item-level').value) || 730;
            
            if (!slot || !name) {
                alert('éƒ¨ä½ã¨ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const newItem = {
                slot: slot,
                name: name,
                itemLevel: itemLevel
            };
            
            currentDropItems.push(newItem);
            updateDropItemsDisplay();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('item-slot').value = '';
            document.getElementById('item-name').value = '';
            document.getElementById('item-level').value = '730';
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤ºæ›´æ–°
        function updateDropItemsDisplay() {
            const container = document.getElementById('drop-items');
            
            if (currentDropItems.length === 0) {
                container.innerHTML = '<p>ã€Œãƒ©ãƒ³ãƒ€ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆã™ã‚‹ã‹ã€æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                document.getElementById('process-btn').disabled = true;
                return;
            }
            
            container.innerHTML = currentDropItems.map((item, index) => `
                <div class="drop-item">
                    <div class="drop-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.slot} - IL${item.itemLevel}</p>
                    </div>
                    <div class="drop-item-actions">
                        <button onclick="removeDropItem(${index})">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('process-btn').disabled = false;
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤
        function removeDropItem(index) {
            currentDropItems.splice(index, 1);
            updateDropItemsDisplay();
        }
        
        // å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤º
        function displayFixedDrops(dropItems) {
            console.log('displayFixedDropså‘¼ã³å‡ºã—:', dropItems.length);
            const container = document.getElementById('fixed-drops');
            console.log('fixed-dropsè¦ç´ :', container);
            
            if (!container) {
                console.error('fixed-dropsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            container.innerHTML = dropItems.map(item => `
                <div class="fixed-drop-item">
                    <div>
                        <h4>${item.name}</h4>
                        <p>${item.slot} - IL${item.itemLevel}</p>
                    </div>
                    <div style="color: #3742fa; font-weight: bold;">
                        å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—
                    </div>
                </div>
            `).join('');
            console.log('å›ºå®šãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤ºå®Œäº†');
        }
        
        // åˆ†é…å‡¦ç†å®Ÿè¡Œï¼ˆå³åº§ã«å®Ÿè¡Œç‰ˆï¼‰
        function processAllocationImmediate(layer) {
            const data = getData();
            const players = Object.values(data.players[currentRaidTier.id]);
            
            allocationResults = [];
            
            console.log('=== åˆ†é…å‡¦ç†é–‹å§‹ ===');
            console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°:', players.length);
            
            currentDropItems.forEach((item, index) => {
                console.log(`\n--- ã‚¢ã‚¤ãƒ†ãƒ  ${index + 1}: ${item.name} ---`);
                let allocationResult;
                
                // 4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®ç‰¹åˆ¥å‡¦ç†
                if (item.type === 'direct_weapon') {
                    console.log('4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã¨ã—ã¦å‡¦ç†');
                    allocationResult = processDirectDropWeaponSimple(item, players);
                } else {
                    console.log('é€šå¸¸è£…å‚™ã¨ã—ã¦å‡¦ç†ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰');
                    // è£…å‚™æ–¹é‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const gearPolicies = data.gearPolicies && data.gearPolicies[currentRaidTier.id];
                    
                    // æ–°ã—ã„åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
                    allocationResult = processEquipmentWithNewSystem(item, players, gearPolicies);
                }
                
                console.log('åˆ†é…çµæœ:', allocationResult.winner ? `${allocationResult.winner.name} (${allocationResult.reason})` : allocationResult.reason);
                allocationResults.push(allocationResult);
            });
            
            displayAllocationResults();
        }
        
        // è¦ä»¶å®šç¾©æ›¸åŸºæº–ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆworking_index.htmlç”¨ï¼‰
        function calculatePlayerJudgmentSimple(player, equipment) {
            // ãƒãƒ†ãƒªã‚¢ãƒ«ç³»ã‚¢ã‚¤ãƒ†ãƒ ã¯åˆ†é…å¯¾è±¡å¤–ï¼ˆPassï¼‰
            if (equipment.type === 'material' || equipment.type === 'mount') {
                return 'Pass';
            }
            
            // 1. è£…å‚™æ–¹é‡ãƒã‚§ãƒƒã‚¯ï¼ˆè¦ä»¶å®šç¾©æ›¸åŸºæº–ï¼‰
            const slotPolicy = player.equipmentPolicy[equipment.slot];
            
            // è£…å‚™æ–¹é‡ãŒã€Œãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ã€ã§é›¶å¼è£…å‚™ã®å ´åˆã®åˆ¤å®š
            if (slotPolicy === 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³' && equipment.type !== 'weapon_box') {
                // å°†æ¥çš„ã«ä½¿ç”¨å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯Greedã€ãã†ã§ãªã‘ã‚Œã°Pass
                return 'Greed'; // ç°¡æ˜“å®Ÿè£…ã§ã¯ä¸€å¾‹Greed
            }
            
            // 2. ç¾åœ¨è£…å‚™ã¨ã®æ¯”è¼ƒ
            const currentEquipment = player.currentEquipment[equipment.slot];
            const isUpgrade = !currentEquipment || equipment.itemLevel > (currentEquipment.itemLevel || 0);
            
            // 3. Needåˆ¤å®š: ãã®è£…å‚™ãŒç¾åœ¨ã®è£…å‚™ã‚ˆã‚Šä¸Šä½ã§ã€ã‹ã¤è£…å‚™æ–¹é‡ãŒã€Œé›¶å¼ã€ã®å ´åˆ
            if (slotPolicy === 'é›¶å¼' && isUpgrade) {
                return 'Need';
            }
            
            // 4. æ—¢ã«ã‚ˆã‚Šè‰¯ã„è£…å‚™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã¯Pass
            if (!isUpgrade) {
                return 'Pass';
            }
            
            // 5. ãã®ä»–ã¯Greed
            return 'Greed';
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªåˆ†é…å‡¦ç†ï¼ˆworking_index.htmlç”¨ï¼‰
        function processAllocationVotingSimple(equipment, playerJudgments) {
            // 4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®ç‰¹åˆ¥å‡¦ç†
            if (equipment.type === 'direct_weapon') {
                return processDirectDropWeaponSimple(equipment, playerJudgments);
            }
            
            const needPlayers = playerJudgments.filter(pj => pj.judgment === 'Need');
            const greedPlayers = playerJudgments.filter(pj => pj.judgment === 'Greed');
            
            let winner = null;
            let reason = '';
            
            if (needPlayers.length > 0) {
                // Needè€…ãŒã„ã‚‹å ´åˆã€è¦ä»¶å®šç¾©æ›¸ã«åŸºã¥ãå„ªå…ˆåº¦ã§é¸æŠ
                winner = selectWinnerByPriority(needPlayers);
                reason = needPlayers.length === 1 ? 'Needï¼ˆå˜ç‹¬ï¼‰' : 'Needï¼ˆå„ªå…ˆåº¦åˆ¤å®šï¼‰';
            } else if (greedPlayers.length > 0) {
                // Greedè€…ã®ã¿ã®å ´åˆã€å„ªå…ˆåº¦ã§é¸æŠ
                winner = selectWinnerByPriority(greedPlayers);
                reason = greedPlayers.length === 1 ? 'Greedï¼ˆå˜ç‹¬ï¼‰' : 'Greedï¼ˆå„ªå…ˆåº¦åˆ¤å®šï¼‰';
            } else {
                reason = 'å…¨å“¡Passï¼ˆåˆ†è§£ï¼‰';
            }
            
            return {
                equipment: equipment,
                winner: winner,
                reason: reason,
                allJudgments: playerJudgments,
                needCount: needPlayers.length,
                greedCount: greedPlayers.length,
                passCount: playerJudgments.length - needPlayers.length - greedPlayers.length
            };
        }
        
        // 4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®ç‰¹åˆ¥å‡¦ç†
        function processDirectDropWeaponSimple(equipment, allPlayers) {
            console.log('4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨å‡¦ç†é–‹å§‹:', equipment.name);
            const droppedWeaponJob = extractJobFromWeaponName(equipment.name);
            console.log('æŠ½å‡ºã—ãŸã‚¸ãƒ§ãƒ–å:', droppedWeaponJob);
            
            // 1. ç™»éŒ²ã‚¸ãƒ§ãƒ–ã«è©²å½“ & æ­¦å™¨æœªå–å¾—ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢
            const primaryCandidates = allPlayers.filter(player => {
                const hasWeaponWish = player.weaponWishes && player.weaponWishes.some(wish => wish.jobName === droppedWeaponJob);
                const hasWeapon = playerHasWeaponForJobSimple(player, droppedWeaponJob);
                console.log(`${player.name}: å¸Œæœ›=${hasWeaponWish}, æ­¦å™¨æœ‰=${hasWeapon}`);
                return hasWeaponWish && !hasWeapon;
            });

            if (primaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(primaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: 'ç™»éŒ²ã‚¸ãƒ§ãƒ–è©²å½“ãƒ»æ­¦å™¨æœªå–å¾—',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: primaryCandidates.includes(p) ? 'Need' : 'Pass' 
                    })),
                    needCount: primaryCandidates.length,
                    greedCount: 0,
                    passCount: allPlayers.length - primaryCandidates.length
                };
            }

            // 2. å¸Œæœ›ç™»éŒ²æ¸ˆã¿ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢
            const secondaryCandidates = allPlayers.filter(player => {
                return player.weaponWishes && player.weaponWishes.some(wish => wish.jobName === droppedWeaponJob);
            });

            if (secondaryCandidates.length > 0) {
                const winner = selectWinnerByPriority(secondaryCandidates);
                return {
                    equipment: equipment,
                    winner: winner,
                    reason: 'å¸Œæœ›ç™»éŒ²æ¸ˆã¿',
                    allJudgments: allPlayers.map(p => ({ 
                        player: p, 
                        judgment: secondaryCandidates.includes(p) ? 'Greed' : 'Pass' 
                    })),
                    needCount: 0,
                    greedCount: secondaryCandidates.length,
                    passCount: allPlayers.length - secondaryCandidates.length
                };
            }

            // 3. è©²å½“è€…ãªã—
            return {
                equipment: equipment,
                winner: null,
                reason: 'è©²å½“è€…ãªã—ï¼ˆåˆ†è§£ãƒ»ä¿ç®¡ï¼‰',
                allJudgments: allPlayers.map(p => ({ player: p, judgment: 'Pass' })),
                needCount: 0,
                greedCount: 0,
                passCount: allPlayers.length
            };
        }
        
        // æ­¦å™¨åã‹ã‚‰ã‚¸ãƒ§ãƒ–ã‚’æŠ½å‡º
        function extractJobFromWeaponName(weaponName) {
            const jobNames = [
                'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å¸«', 'å­¦è€…', 'è³¢è€…',
                'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­',
                'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼'
            ];
            
            for (const job of jobNames) {
                if (weaponName.includes(job)) {
                    return job;
                }
            }
            
            return 'ä¸æ˜';
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç‰¹å®šã‚¸ãƒ§ãƒ–ã®æ­¦å™¨ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function playerHasWeaponForJobSimple(player, jobName) {
            const currentWeapon = player.currentEquipment && player.currentEquipment['æ­¦å™¨'];
            if (!currentWeapon) return false;
            
            // ç°¡æ˜“çš„ã«ã‚¢ã‚¤ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«720ä»¥ä¸Šã‚’æŒã£ã¦ã„ã‚Œã°æ­¦å™¨ã‚ã‚Šã¨ã™ã‚‹
            return currentWeapon.itemLevel >= 720;
        }
        
        // è¦ä»¶å®šç¾©æ›¸ã«åŸºã¥ãå„ªå…ˆåº¦ã§å‹è€…é¸æŠï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
        function selectWinnerByPriority(candidatePlayers) {
            // playerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const players = candidatePlayers.map(cp => cp.player || cp);
            
            if (players.length === 1) {
                console.log('å˜ç‹¬å€™è£œ:', players[0].name, players[0].position);
                return players[0];
            }
            
            console.log('è¤‡æ•°å€™è£œ:', players.map(p => `${p.name}(${p.position})`).join(', '));
            
            // å„ªå…ˆåº¦: D1/D2 > D3/D4 > MT/ST > H1/H2
            const positionPriorities = {
                'D1': 1, 'D2': 1,    // DPS Melee
                'D3': 2, 'D4': 2,    // DPS Range/Caster
                'MT': 3, 'ST': 3,    // Tank
                'H1': 4, 'H2': 4     // Healer
            };
            
            // å„ªå…ˆåº¦ã‚’è¡¨ç¤º
            players.forEach(player => {
                const priority = positionPriorities[player.position] || 999;
                console.log(`${player.name} (${player.position}): å„ªå…ˆåº¦ ${priority}`);
            });
            
            const sortedPlayers = players.sort((a, b) => {
                const priorityA = positionPriorities[a.position] || 999;
                const priorityB = positionPriorities[b.position] || 999;
                return priorityA - priorityB;
            });
            
            console.log('å„ªå…ˆåº¦é †:', sortedPlayers.map(p => `${p.name}(${p.position})`).join(' > '));
            console.log('é¸æŠã•ã‚ŒãŸå‹è€…:', sortedPlayers[0].name, sortedPlayers[0].position);
            
            return sortedPlayers[0];
        }
        
        // æ–°ã—ã„Need/Greed/Passåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ï¼ˆè£…å‚™æ–¹é‡ï¼‹ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦ï¼‰
        function calculateEquipmentPriority(player, equipment, gearPolicies) {
            const slot = equipment.slot || getSlotFromEquipmentName(equipment.name);
            const playerGearPolicy = gearPolicies && gearPolicies[player.position] && gearPolicies[player.position][slot];
            
            // è£…å‚™æ–¹é‡ã«ã‚ˆã‚‹å„ªå…ˆåº¦
            const gearPolicyPriority = playerGearPolicy === 'é›¶å¼' ? 100 : 50;
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦ã‚’å–å¾—
            const data = getData();
            const customPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id];
            
            let rolePriority;
            if (customPriorities && customPriorities[player.position]) {
                rolePriority = customPriorities[player.position];
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå„ªå…ˆåº¦ï¼ˆå¾“æ¥ã®è¨­å®šï¼‰
                const defaultRolePriorities = {
                    'D1': 30, 'D2': 30,    // DPSé«˜å„ªå…ˆåº¦
                    'D3': 25, 'D4': 25,    // DPSä¸­å„ªå…ˆåº¦
                    'MT': 20, 'ST': 20,    // ã‚¿ãƒ³ã‚¯
                    'H1': 10, 'H2': 10     // ãƒ’ãƒ¼ãƒ©ãƒ¼
                };
                rolePriority = defaultRolePriorities[player.position] || 0;
            }
            
            // ç·åˆå„ªå…ˆåº¦ = è£…å‚™æ–¹é‡å„ªå…ˆåº¦ + ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦
            const totalPriority = gearPolicyPriority + rolePriority;
            
            return {
                totalPriority,
                gearPolicyPriority,
                rolePriority,
                gearPolicy: playerGearPolicy || 'æœªè¨­å®š',
                judgment: totalPriority >= 100 ? 'Need' : totalPriority >= 50 ? 'Greed' : 'Pass'
            };
        }
        
        // è£…å‚™åã‹ã‚‰ã‚¹ãƒ­ãƒƒãƒˆã‚’æ¨å®š
        function getSlotFromEquipmentName(equipmentName) {
            const slotKeywords = {
                'æ­¦å™¨': ['æ­¦å™¨', 'ã‚½ãƒ¼ãƒ‰', 'ã‚¢ã‚¯ã‚¹', 'ãƒãƒ³ãƒãƒ¼', 'ãƒ­ãƒƒãƒ‰', 'ãƒœã‚¦', 'ã‚¬ãƒ³'],
                'é ­': ['ãƒ˜ãƒ«ãƒ ', 'ãƒ•ãƒ¼ãƒ‰', 'ãƒãƒƒãƒˆ', 'å¸½å­', 'é ­'],
                'èƒ´': ['ã‚¢ãƒ¼ãƒãƒ¼', 'ãƒ­ãƒ¼ãƒ–', 'ã‚³ãƒ¼ãƒˆ', 'èƒ´', 'ãƒã‚§ã‚¹ãƒˆ'],
                'æ‰‹': ['ã‚¬ãƒ³ãƒˆãƒ¬ãƒƒãƒˆ', 'ã‚°ãƒ­ãƒ¼ãƒ–', 'æ‰‹è¢‹', 'æ‰‹'],
                'è„š': ['ãƒ‘ãƒ³ã‚¿ãƒ­ãƒ³', 'ãƒ›ãƒ¼ã‚º', 'ãƒ–ãƒ¼ãƒ„', 'è„š', 'ãƒ¬ãƒƒã‚°'],
                'è¶³': ['ãƒ–ãƒ¼ãƒ„', 'ã‚·ãƒ¥ãƒ¼ã‚º', 'é´', 'è¶³'],
                'è€³': ['ã‚¤ãƒ¤ãƒªãƒ³ã‚°', 'è€³é£¾ã‚Š', 'è€³'],
                'é¦–': ['ãƒãƒƒã‚¯ãƒ¬ã‚¹', 'ãƒãƒ§ãƒ¼ã‚«ãƒ¼', 'é¦–é£¾ã‚Š', 'é¦–'],
                'è…•': ['ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', 'è…•è¼ª', 'è…•'],
                'æŒ‡': ['ãƒªãƒ³ã‚°', 'æŒ‡è¼ª', 'æŒ‡']
            };
            
            for (const [slot, keywords] of Object.entries(slotKeywords)) {
                if (keywords.some(keyword => equipmentName.includes(keyword))) {
                    return slot;
                }
            }
            
            return 'ä¸æ˜';
        }
        
        // æ–°ã—ã„è£…å‚™åˆ†é…å‡¦ç†ï¼ˆè£…å‚™æ–¹é‡ï¼‹ãƒ­ãƒ¼ãƒ«å„ªå…ˆåº¦ç‰ˆï¼‰
        function processEquipmentWithNewSystem(equipment, allPlayers, gearPolicies) {
            console.log('æ–°ã‚·ã‚¹ãƒ†ãƒ ã§è£…å‚™åˆ†é…å‡¦ç†:', equipment.name);
            
            // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å„ªå…ˆåº¦ã‚’è¨ˆç®—
            const playerPriorities = allPlayers.map(player => {
                const priority = calculateEquipmentPriority(player, equipment, gearPolicies);
                return {
                    player: player,
                    ...priority
                };
            });
            
            // åˆ¤å®šåˆ¥ã«åˆ†é¡
            const needPlayers = playerPriorities.filter(p => p.judgment === 'Need').sort((a, b) => b.totalPriority - a.totalPriority);
            const greedPlayers = playerPriorities.filter(p => p.judgment === 'Greed').sort((a, b) => b.totalPriority - a.totalPriority);
            const passPlayers = playerPriorities.filter(p => p.judgment === 'Pass');
            
            // å‹è€…æ±ºå®š
            let winner = null;
            let reason = '';
            
            if (needPlayers.length > 0) {
                winner = needPlayers[0].player;
                reason = `Needåˆ¤å®š (è£…å‚™æ–¹é‡: ${needPlayers[0].gearPolicy}, å„ªå…ˆåº¦: ${needPlayers[0].totalPriority})`;
            } else if (greedPlayers.length > 0) {
                winner = greedPlayers[0].player;
                reason = `Greedåˆ¤å®š (è£…å‚™æ–¹é‡: ${greedPlayers[0].gearPolicy}, å„ªå…ˆåº¦: ${greedPlayers[0].totalPriority})`;
            } else {
                reason = 'å…¨å“¡Passåˆ¤å®š (åˆ†è§£ãƒ»ä¿ç®¡)';
            }
            
            // çµæœã‚’ãƒ­ã‚°å‡ºåŠ›
            console.log('å„ªå…ˆåº¦çµæœ:');
            playerPriorities.forEach(p => {
                console.log(`${p.player.name} (${p.player.position}): ${p.judgment} - ç·åˆ${p.totalPriority} (æ–¹é‡${p.gearPolicyPriority} + ãƒ­ãƒ¼ãƒ«${p.rolePriority})`);
            });
            
            return {
                equipment: equipment,
                winner: winner,
                reason: reason,
                allJudgments: playerPriorities.map(p => ({
                    player: p.player,
                    judgment: p.judgment,
                    priority: p.totalPriority,
                    gearPolicy: p.gearPolicy
                })),
                needCount: needPlayers.length,
                greedCount: greedPlayers.length,
                passCount: passPlayers.length
            };
        }
        
        // åˆ†é…çµæœè¡¨ç¤º
        function displayAllocationResults() {
            try {
                console.log('displayAllocationResultså‘¼ã³å‡ºã—:', allocationResults.length);
                const container = document.getElementById('allocation-summary');
                console.log('allocation-summaryè¦ç´ :', container);
                
                if (!container) {
                    console.error('allocation-summaryè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                console.log('HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆä¸­...');
                const htmlContent = allocationResults.map(result => {
                    console.log('å‡¦ç†ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ :', result.equipment.name);
                    console.log('å‹è€…ãƒ‡ãƒ¼ã‚¿:', result.winner);
                    
                    // å‹è€…æƒ…å ±ã®å®‰å…¨ãªå–å¾—
                    let winnerText = 'ãªã—';
                    if (result.winner) {
                        const winnerName = result.winner.name || 'åå‰ä¸æ˜';
                        const winnerPosition = result.winner.position || 'ãƒã‚¸ã‚·ãƒ§ãƒ³ä¸æ˜';
                        winnerText = `${winnerName} (${winnerPosition})`;
                    }
                    
                    return `
                        <div class="allocation-result-simple">
                            <div class="item-winner-display">
                                <div class="item-name">${result.equipment.name}</div>
                                <div class="winner-name">${winnerText}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¨­å®šä¸­...');
                container.innerHTML = htmlContent;
                console.log('åˆ†é…çµæœè¡¨ç¤ºå®Œäº†');
                
            } catch (error) {
                console.error('displayAllocationResultså†…ã§ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', error.stack);
                
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ä»£æ›¿è¡¨ç¤º
                const container = document.getElementById('allocation-summary');
                if (container) {
                    container.innerHTML = `<p style="color: #ff6b6b;">åˆ†é…çµæœã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
                }
            }
        }
        
        // åˆ†é…çµæœç¢ºå®šãƒ»ä¿å­˜
        function confirmAndSaveAllocation(layer) {
            if (!allocationResults || allocationResults.length === 0) {
                alert('åˆ†é…çµæœãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (!confirm(`${layer}å±¤ã®åˆ†é…çµæœã‚’ç¢ºå®šã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            const data = getData();
            
            if (!data.allocations) data.allocations = {};
            if (!data.allocations[currentRaidTier.id]) data.allocations[currentRaidTier.id] = [];
            
            const timestamp = new Date().toISOString();
            
            allocationResults.forEach(result => {
                const allocation = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    layer: layer,
                    equipment: result.equipment,
                    winner: result.winner,
                    reason: result.reason,
                    allJudgments: result.allJudgments,
                    timestamp: timestamp,
                    week: getCurrentWeekString()
                };
                
                data.allocations[currentRaidTier.id].push(allocation);
                
                // å‹è€…ã®ç¾åœ¨è£…å‚™ã‚’æ›´æ–°
                if (result.winner) {
                    const playerKey = Object.keys(data.players[currentRaidTier.id]).find(
                        key => data.players[currentRaidTier.id][key].name === result.winner.name
                    );
                    if (playerKey) {
                        if (!data.players[currentRaidTier.id][playerKey].currentEquipment) {
                            data.players[currentRaidTier.id][playerKey].currentEquipment = {};
                        }
                        data.players[currentRaidTier.id][playerKey].currentEquipment[result.equipment.slot] = result.equipment;
                    }
                }
            });
            
            saveData(data);
            
            alert(`${layer}å±¤ã®åˆ†é…çµæœã‚’ç¢ºå®šãƒ»ä¿å­˜ã—ã¾ã—ãŸï¼`);
            
            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            currentDropItems = [];
            allocationResults = [];
            showMainDashboard();
        }
        
        // ç¾åœ¨ã®é€±ã‚’å–å¾—
        function getCurrentWeekString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }
        
        // ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦è¨­å®šç”»é¢ï¼ˆã‚·ãƒ³ãƒ—ãƒ«æ•°å€¤å…¥åŠ›ç‰ˆï¼‰
        function showPositionPrioritySettings() {
            const app = document.querySelector('.container');
            
            // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
            const data = getData();
            const currentPriorities = data.positionPriorities && data.positionPriorities[currentRaidTier.id] || getDefaultPositionPriorities();
            
            app.innerHTML = `
                <h1>ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¥å„ªå…ˆåº¦è¨­å®š</h1>
                
                <div class="section">
                    <h2>å„ªå…ˆåº¦è¨­å®šã®èª¬æ˜</h2>
                    <p>å„ãƒã‚¸ã‚·ãƒ§ãƒ³ã®å„ªå…ˆåº¦ã‚’æ•°å€¤ã§è¨­å®šã—ã¾ã™ã€‚æ•°å€¤ãŒé«˜ã„ã»ã©è£…å‚™åˆ†é…ã§ã®å„ªå…ˆåº¦ãŒé«˜ããªã‚Šã¾ã™ã€‚</p>
                    <p>è£…å‚™æ–¹é‡ï¼ˆé›¶å¼/ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ï¼‰ã®å„ªå…ˆåº¦ã¨åˆç®—ã—ã¦æœ€çµ‚åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
                </div>
                
                <div class="section">
                    <h2>ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¥å„ªå…ˆåº¦</h2>
                    <div class="priority-settings-grid">
                        <div class="priority-group">
                            <h3>ã‚¿ãƒ³ã‚¯</h3>
                            <div class="priority-item">
                                <label>MT:</label>
                                <input type="number" id="priority-MT" value="${currentPriorities.MT || 30}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>ST:</label>
                                <input type="number" id="priority-ST" value="${currentPriorities.ST || 25}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>ãƒ’ãƒ¼ãƒ©ãƒ¼</h3>
                            <div class="priority-item">
                                <label>H1:</label>
                                <input type="number" id="priority-H1" value="${currentPriorities.H1 || 20}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>H2:</label>
                                <input type="number" id="priority-H2" value="${currentPriorities.H2 || 15}" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="priority-group">
                            <h3>DPS</h3>
                            <div class="priority-item">
                                <label>D1:</label>
                                <input type="number" id="priority-D1" value="${currentPriorities.D1 || 50}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D2:</label>
                                <input type="number" id="priority-D2" value="${currentPriorities.D2 || 45}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D3:</label>
                                <input type="number" id="priority-D3" value="${currentPriorities.D3 || 40}" min="0" max="100">
                            </div>
                            <div class="priority-item">
                                <label>D4:</label>
                                <input type="number" id="priority-D4" value="${currentPriorities.D4 || 35}" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="priority-presets">
                        <h3>ãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
                        <button onclick="applyDPSPriorityPreset()">DPSå„ªå…ˆ (æ¨™æº–)</button>
                        <button onclick="applyBalancedPreset()">ãƒãƒ©ãƒ³ã‚¹å‹</button>
                        <button onclick="applyTankPriorityPreset()">ã‚¿ãƒ³ã‚¯å„ªå…ˆ</button>
                        <button onclick="applyHealerPriorityPreset()">ãƒ’ãƒ¼ãƒ©ãƒ¼å„ªå…ˆ</button>
                    </div>
                    
                    <div class="priority-actions">
                        <button onclick="savePositionPriorities()" class="confirm-btn">è¨­å®šã‚’ä¿å­˜</button>
                        <button onclick="showMainDashboard()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            `;
            
            // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
            addSimplePriorityStyles();
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å„ªå…ˆåº¦è¨­å®šã‚’å–å¾—
        function getDefaultPositionPriorities() {
            return {
                'MT': 30, 'ST': 25,
                'H1': 20, 'H2': 15,
                'D1': 50, 'D2': 45, 'D3': 40, 'D4': 35
            };
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦è¨­å®šç”¨CSS
        function addSimplePriorityStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .priority-settings-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin: 20px 0;
                }
                .priority-group {
                    background-color: #f8f9fa;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #e9ecef;
                }
                .priority-group h3 {
                    margin-top: 0;
                    color: #2c3e50;
                    text-align: center;
                }
                .priority-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin: 10px 0;
                }
                .priority-item label {
                    font-weight: 500;
                    width: 40px;
                }
                .priority-item input {
                    width: 80px;
                    text-align: center;
                    font-weight: bold;
                }
                .priority-presets {
                    margin: 30px 0;
                    text-align: center;
                }
                .priority-presets button {
                    margin: 5px;
                    background-color: #6c757d;
                }
                .priority-actions {
                    text-align: center;
                    margin-top: 30px;
                }
            `;
            if (!document.getElementById('simple-priority-styles')) {
                style.id = 'simple-priority-styles';
                document.head.appendChild(style);
            }
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨é–¢æ•°
        function applyDPSPriorityPreset() {
            document.getElementById('priority-MT').value = 30;
            document.getElementById('priority-ST').value = 25;
            document.getElementById('priority-H1').value = 20;
            document.getElementById('priority-H2').value = 15;
            document.getElementById('priority-D1').value = 50;
            document.getElementById('priority-D2').value = 45;
            document.getElementById('priority-D3').value = 40;
            document.getElementById('priority-D4').value = 35;
        }
        
        function applyBalancedPreset() {
            document.getElementById('priority-MT').value = 30;
            document.getElementById('priority-ST').value = 30;
            document.getElementById('priority-H1').value = 25;
            document.getElementById('priority-H2').value = 25;
            document.getElementById('priority-D1').value = 35;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 35;
            document.getElementById('priority-D4').value = 35;
        }
        
        function applyTankPriorityPreset() {
            document.getElementById('priority-MT').value = 50;
            document.getElementById('priority-ST').value = 45;
            document.getElementById('priority-H1').value = 30;
            document.getElementById('priority-H2').value = 25;
            document.getElementById('priority-D1').value = 40;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 30;
            document.getElementById('priority-D4').value = 25;
        }
        
        function applyHealerPriorityPreset() {
            document.getElementById('priority-MT').value = 25;
            document.getElementById('priority-ST').value = 20;
            document.getElementById('priority-H1').value = 50;
            document.getElementById('priority-H2').value = 45;
            document.getElementById('priority-D1').value = 40;
            document.getElementById('priority-D2').value = 35;
            document.getElementById('priority-D3').value = 30;
            document.getElementById('priority-D4').value = 25;
        }
        
        // ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦ã‚’ä¿å­˜
        function savePositionPriorities() {
            const priorities = {
                'MT': parseInt(document.getElementById('priority-MT').value) || 30,
                'ST': parseInt(document.getElementById('priority-ST').value) || 25,
                'H1': parseInt(document.getElementById('priority-H1').value) || 20,
                'H2': parseInt(document.getElementById('priority-H2').value) || 15,
                'D1': parseInt(document.getElementById('priority-D1').value) || 50,
                'D2': parseInt(document.getElementById('priority-D2').value) || 45,
                'D3': parseInt(document.getElementById('priority-D3').value) || 40,
                'D4': parseInt(document.getElementById('priority-D4').value) || 35
            };
            
            const data = getData();
            if (!data.positionPriorities) {
                data.positionPriorities = {};
            }
            data.positionPriorities[currentRaidTier.id] = priorities;
            
            setData(data);
            alert('ãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            showMainDashboard();
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ©Ÿèƒ½
        function generateTestData() {
            if (confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                createTestRaidTier();
            }
        }
        
        function createTestRaidTier() {
            const data = getData();
            
            // ãƒ†ã‚¹ãƒˆç”¨ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä½œæˆ
            const testTier = {
                id: 'test_' + Date.now().toString(),
                name: '7.2é›¶å¼ãƒ†ã‚¹ãƒˆ',
                description: 'ãƒ†ã‚¹ãƒˆç”¨ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ï¼ˆãƒ©ãƒ³ãƒ€ãƒ è£…å‚™æ–¹é‡ï¼‰',
                createdAt: new Date().toISOString(),
                isActive: true
            };
            
            // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ†ã‚£ã‚¢ã‚’ç„¡åŠ¹åŒ–
            data.raidTiers.forEach(tier => tier.isActive = false);
            data.raidTiers.push(testTier);
            data.activeRaidTierId = testTier.id;
            
            // ãƒ©ãƒ³ãƒ€ãƒ è£…å‚™æ–¹é‡ç”Ÿæˆé–¢æ•°
            function generateRandomEquipmentPolicy() {
                const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
                const policy = {};
                slots.forEach(slot => {
                    // 70%ã®ç¢ºç‡ã§é›¶å¼ã€30%ã®ç¢ºç‡ã§ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³
                    policy[slot] = Math.random() < 0.7 ? 'é›¶å¼' : 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³';
                });
                return policy;
            }
            
            // ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿
            const testPlayers = {
                'MT': {
                    id: 'test_mt',
                    name: 'ã‚¿ãƒ³ã‚¯å¤ªéƒ',
                    characterName: 'Tank Taro',
                    position: 'MT',
                    job: 'ãƒŠã‚¤ãƒˆ',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'æ­¦å™¨': { itemLevel: 710 }, 'é ­': { itemLevel: 710 }, 'èƒ´': { itemLevel: 710 }
                    },
                    weaponWishes: [
                        { jobName: 'ãƒŠã‚¤ãƒˆ', priority: 1 }
                    ]
                },
                'ST': {
                    id: 'test_st',
                    name: 'ã‚µãƒ–ã‚¿ãƒ³èŠ±å­',
                    characterName: 'SubTank Hanako',
                    position: 'ST',
                    job: 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'æ­¦å™¨': { itemLevel: 710 }, 'èƒ´': { itemLevel: 710 }
                    },
                    weaponWishes: [
                        { jobName: 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼', priority: 1 }
                    ]
                },
                'H1': {
                    id: 'test_h1',
                    name: 'ãƒ’ãƒ¼ãƒ©ãƒ¼ä¸€éƒ',
                    characterName: 'Healer Ichiro',
                    position: 'H1',
                    job: 'ç™½é­”é“å£«',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'æ­¦å™¨': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'ç™½é­”é“å£«', priority: 1 }
                    ]
                },
                'H2': {
                    id: 'test_h2',
                    name: 'ãƒãƒªã‚¢æ¬¡éƒ',
                    characterName: 'Barrier Jiro',
                    position: 'H2',
                    job: 'å­¦è€…',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'é ­': { itemLevel: 720 }, 'æ‰‹': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'å­¦è€…', priority: 1 }
                    ]
                },
                'D1': {
                    id: 'test_d1',
                    name: 'ãƒ¡ãƒ¬ãƒ¼ä¸‰éƒ',
                    characterName: 'Melee Saburo',
                    position: 'D1',
                    job: 'ç«œé¨å£«',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'æ­¦å™¨': { itemLevel: 710 }
                    },
                    weaponWishes: [
                        { jobName: 'ç«œé¨å£«', priority: 1 },
                        { jobName: 'ãƒªãƒ¼ãƒ‘ãƒ¼', priority: 2 }
                    ]
                },
                'D2': {
                    id: 'test_d2',
                    name: 'ãƒ¡ãƒ¬ãƒ¼å››éƒ',
                    characterName: 'Melee Shiro',
                    position: 'D2',
                    job: 'å¿è€…',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {},
                    weaponWishes: [
                        { jobName: 'å¿è€…', priority: 1 }
                    ]
                },
                'D3': {
                    id: 'test_d3',
                    name: 'ãƒ¬ãƒ³ã‚¸äº”éƒ',
                    characterName: 'Range Goro',
                    position: 'D3',
                    job: 'æ©Ÿå·¥å£«',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'èƒ´': { itemLevel: 720 }, 'è„š': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'æ©Ÿå·¥å£«', priority: 1 }
                    ]
                },
                'D4': {
                    id: 'test_d4',
                    name: 'ã‚­ãƒ£ã‚¹å…­éƒ',
                    characterName: 'Caster Rokuro',
                    position: 'D4',
                    job: 'é»’é­”é“å£«',
                    equipmentPolicy: generateRandomEquipmentPolicy(),
                    currentEquipment: {
                        'è€³': { itemLevel: 720 }, 'é¦–': { itemLevel: 720 }
                    },
                    weaponWishes: [
                        { jobName: 'é»’é­”é“å£«', priority: 1 },
                        { jobName: 'èµ¤é­”é“å£«', priority: 2 }
                    ]
                }
            };
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            if (!data.players) data.players = {};
            data.players[testTier.id] = testPlayers;
            
            if (!data.allocations) data.allocations = {};
            data.allocations[testTier.id] = [];
            
            saveData(data);
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢æ›´æ–°
            currentRaidTier = testTier;
            
            alert('ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\\n\\nğŸ“‹ ä½œæˆå†…å®¹ï¼š\\nâ€¢ 8äººã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå„ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼‰\\nâ€¢ ãƒ©ãƒ³ãƒ€ãƒ è£…å‚™æ–¹é‡è¨­å®šï¼ˆé›¶å¼70%ï¼šãƒˆãƒ¼ãƒ 30%ï¼‰\\nâ€¢ è£…å‚™æ ¼å·®ã®å†ç¾ï¼ˆIL710-720ï¼‰\\nâ€¢ æ­¦å™¨å¸Œæœ›è¨­å®šï¼ˆè¤‡æ•°å¸Œæœ›å«ã‚€ï¼‰\\nâ€¢ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¸ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦è¨­å®š\\n\\nâœ… ã™ãã«å„å±¤ã®åˆ†é…ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã§ã™ã€‚\\nã€Œãƒ¬ã‚¤ãƒ‰ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è©¦ã—ã¦ãã ã•ã„ã€‚');
            showMainDashboard();
        }
        
        function exportData() {
            const data = getData();
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ff14_gear_data_${currentRaidTier.name}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–');
            initStorage();
            showRaidTierSelection();
        });
    </script>
</body>
</html>