<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://*.supabase.co https://supabase.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
    <title>FF14 零式装備分配システム (Supabase版)</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
        // Supabaseライブラリの読み込み確認
        window.addEventListener('load', function() {
            console.log('Supabase library loaded:', typeof window.supabase !== 'undefined');
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase version:', window.supabase.createClient ? 'OK' : 'No createClient method');
            }
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        /* Supabase認証用のヘッダー */
        .supabase-header {
            background: linear-gradient(135deg, #16a085 0%, #27ae60 100%);
            color: white;
            padding: 10px 20px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ダッシュボード用スタイル */
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px;
            min-width: 120px;
        }
        
        .dashboard-layer-button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .supabase-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .connection-indicator.online {
            background-color: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        
        .connection-indicator.offline {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-input {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .auth-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4a9d6b;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #3e8a57;
        }
        
        .auth-btn.logout {
            background-color: #d86a5a;
        }
        
        .auth-btn.logout:hover {
            background-color: #b85a4a;
        }
        
        /* 認証画面 */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
        }
        
        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-card h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .auth-form button {
            padding: 12px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .auth-form button:hover {
            background-color: #219a52;
        }
        
        .demo-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }
        
        /* メインコンテンツエリア */
        .main-content {
            display: none;
        }
        
        .main-content.authenticated {
            display: block;
        }
        
        /* 既存のcollaborative_index.htmlのスタイルを統合 */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .player-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        .position-badge {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .job-select {
            width: 100%;
            margin: 5px 0;
        }
        .equipment-policy {
            margin: 10px 0;
        }
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }
        .policy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .policy-item label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .policy-item select {
            width: 100%;
            padding: 6px;
            font-size: 0.8rem;
            margin: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* 装備方針の背景色 */
        .policy-item select option[value="零式"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select option[value="トームストーン"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        .policy-item select[value="零式"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select[value="トームストーン"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        
        /* タブ関連スタイル */
        .tab-container {
            margin: 20px 0;
        }
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }
        .tab-content {
            min-height: 400px;
        }
        
        /* 層選択関連 */
        .layer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .layer-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .layer-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .layer-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-align: center;
        }
        .layer-content {
            padding: 15px;
        }
        
        /* 優先度設定関連 */
        .priority-container {
            max-width: 600px;
            margin: 20px auto;
        }
        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .priority-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s ease;
        }
        .priority-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .priority-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .priority-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .position-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .player-details {
            font-size: 0.9rem;
            color: #666;
        }
        .drag-handle {
            color: #999;
            font-size: 20px;
            cursor: move;
        }
        
        /* 武器希望関連 */
        .weapon-wishes {
            margin: 10px 0;
        }
        .wish-priority {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wish-priority label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #555;
        }
        .wish-priority select,
        .wish-priority input {
            flex: 1;
            min-width: 150px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tier-item.active {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .tier-item h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .tier-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .dashboard-layer-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }
        .nav-button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* エラーメッセージ */
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background-color: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        /* データ移行関連のスタイル */
        .migration-section {
            transition: all 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .migration-section:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .file-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-input-container input[type="file"] {
            transition: border-color 0.3s ease;
        }
        
        .file-input-container input[type="file"]:hover {
            border-color: #2980b9;
        }
        
        .csv-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }
        
        .csv-input-section {
            display: flex;
            flex-direction: column;
        }
        
        .csv-help-section {
            min-width: 200px;
        }
        
        .reset-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .reset-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .reset-warning {
            background-color: #fee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }
        
        .hints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .hint-card {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.2s ease;
        }
        
        .hint-card:hover {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        /* 装備分配関連のスタイル */
        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .layer-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .layer-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        .layer-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .layer-stats {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .allocation-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .allocation-choice {
            margin: 15px 0;
        }
        
        .allocation-choice select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .candidates-detail {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .candidate-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .no-candidates {
            color: #666;
            font-style: italic;
        }
        
        .weapon-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .weapon-selection h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .weapon-selection select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        .predicted-winner {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .judgment-details {
            margin-top: 15px;
        }
        
        .judgment-toggle {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .judgment-toggle:hover {
            background: #e9ecef;
        }
        
        .judgment-content {
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .need-section, .greed-section, .pass-section {
            margin: 10px 0;
        }
        
        .need-section h6 {
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .greed-section h6 {
            color: #f39c12;
            margin-bottom: 8px;
        }
        
        .pass-section h6 {
            color: #95a5a6;
            margin-bottom: 8px;
        }
        
        .candidate-item.need {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.greed {
            background: #fef9e7;
            border-left: 4px solid #f39c12;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.pass {
            background: #f8f9fa;
            border-left: 4px solid #95a5a6;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            color: #666;
        }
        
        .allocation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .confirm-btn {
            background: #27ae60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .confirm-btn:hover {
            background: #2ecc71;
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        /* 統計関連のスタイル */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .stat-details {
            margin-top: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slot-stats, .week-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .slot-stat-item, .week-stat-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .slot-name, .week-number {
            width: 100px;
            font-weight: 600;
        }
        
        .slot-count, .week-count {
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        
        .slot-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .slot-progress {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3498db;
            margin-top: 10px;
        }
        
        /* 履歴関連のスタイル */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-group select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .clear-filters-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .clear-filters-btn:hover {
            background: #c0392b;
        }
        
        .history-table {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .history-header {
            background: #3498db;
            color: white;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
        }
        
        .history-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-row:hover {
            background: #e8f4fd;
        }
        
        .history-cell {
            padding: 10px;
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        @media (max-width: 768px) {
            .csv-container {
                grid-template-columns: 1fr;
            }
            
            .reset-buttons-container {
                grid-template-columns: 1fr;
            }
            
            .file-input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .layer-grid {
                grid-template-columns: 1fr;
            }
            
            .allocation-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .history-header, .history-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .history-cell {
                border-bottom: 1px solid #e9ecef;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Supabase認証ヘッダー -->
        <div class="supabase-header">
            <div class="supabase-status">
                <h1 style="margin: 0; font-size: 18px;">FF14 零式装備分配システム (Supabase版)</h1>
                <div id="connectionStatus" class="connection-indicator offline">
                    <span>⚫</span>
                    <span>オフライン</span>
                </div>
                <div id="teamInfo" style="display: none;">
                    <span id="currentTeamName">チーム名</span>
                </div>
            </div>
            
            <div class="auth-controls" id="authControls">
                <input type="text" id="teamIdInput" class="auth-input" placeholder="チームID" maxlength="20">
                <input type="password" id="passwordInput" class="auth-input" placeholder="パスワード" maxlength="20">
                <button class="auth-btn" onclick="authenticateTeam()">ログイン</button>
            </div>
            
            <div class="auth-controls" id="loggedInControls" style="display: none;">
                <span id="loggedInTeam">demo-team</span>
                <button class="auth-btn logout" onclick="logout()">ログアウト</button>
            </div>
        </div>
        
        <!-- エラー・成功メッセージ -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- 認証画面 -->
        <div id="authScreen" class="auth-screen">
            <div class="auth-card">
                <h2>🛡️ チーム認証</h2>
                <p>8人での共同利用には<br>チームIDとパスワードが必要です</p>
                
                <div class="auth-form">
                    <input type="text" id="mainTeamIdInput" placeholder="チームID (例: my-raid-team)" maxlength="20">
                    <input type="password" id="mainPasswordInput" placeholder="パスワード" maxlength="20">
                    <button onclick="authenticateTeam()">ログイン</button>
                </div>
                
                <div class="demo-info">
                    <strong>🎮 デモ用アカウント</strong><br>
                    チームID: <code>demo-team</code><br>
                    パスワード: <code>demo123</code>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p>新しいチームの作成をご希望の場合は<br>管理者にお問い合わせください</p>
                </div>
            </div>
        </div>
        
        <!-- メインコンテンツ（認証後に表示） -->
        <div id="mainContent" class="main-content">
            <div id="content">
                <!-- 初期表示はダッシュボード -->
            </div>
        </div>
    </div>

    <!-- Supabase認証情報（GitHub Secrets経由で注入） -->
    <script>
        // GitHub Actionsによってデプロイ時に認証情報が注入されます
        window.SUPABASE_CONFIG = {
            SUPABASE_URL: 'https://bpzvuwhnjvbfohopeoxr.supabase.co',
            SUPABASE_ANON_KEY: null, // GitHub Actionsで置換される
            DEMO_TEAM_ID: 'demo-team',
            DEMO_PASSWORD: 'demo123'
        };
    </script>
    
    <!-- Supabase設定とメイン機能 -->
    <script src="supabase_config.js"></script>
    <script>
        // グローバル変数
        let isAuthenticated = false;
        let currentTeamId = null;
        
        // 初期化 - ライブラリ読み込み完了を待つ
        window.addEventListener('load', async function() {
            // 少し待ってからアプリ初期化
            setTimeout(async () => {
                await initializeApp();
            }, 100);
        });
        
        // アプリ初期化
        async function initializeApp() {
            try {
                console.log('アプリ初期化開始');
                
                // Supabaseライブラリの確認
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase JavaScriptライブラリが読み込まれていません');
                }
                
                console.log('Supabaseライブラリ確認完了');
                
                // Supabaseクライアント作成（機密情報は外部ファイルから）
                const supabaseUrl = window.SUPABASE_CONFIG?.SUPABASE_URL;
                const supabaseKey = window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Supabase認証情報が設定されていません。GitHub Secretsの設定を確認してください。');
                }
                
                window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントの作成に失敗しました');
                }
                
                console.log('Supabaseクライアント作成完了');
                
                // 接続状態更新
                updateConnectionStatus(true);
                
                // 自動ログイン試行
                await tryAutoLogin();
                
                console.log('アプリ初期化完了');
                
            } catch (error) {
                console.error('アプリ初期化エラー:', error);
                showError('システムの初期化に失敗しました: ' + error.message);
                updateConnectionStatus(false);
            }
        }
        
        // 自動ログイン試行
        async function tryAutoLogin() {
            const savedTeamId = localStorage.getItem('ff14_team_id');
            if (savedTeamId) {
                currentTeamId = savedTeamId;
                supabaseConfig.currentTeamId = savedTeamId;
                await showAuthenticatedState();
            }
        }
        
        // チーム認証
        async function authenticateTeam() {
            const teamId = document.getElementById('teamIdInput')?.value || 
                          document.getElementById('mainTeamIdInput')?.value;
            const password = document.getElementById('passwordInput')?.value || 
                           document.getElementById('mainPasswordInput')?.value;
            
            if (!teamId || !password) {
                showError('チームIDとパスワードを入力してください');
                return;
            }
            
            try {
                showMessage('認証中...', 'info');
                
                // Supabaseクライアント確認
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントが初期化されていません');
                }
                
                console.log('認証試行:', teamId);
                
                // Supabase認証
                const { data, error } = await window.supabaseClient.rpc('authenticate_team', {
                    p_team_id: teamId,
                    p_password: password
                });
                
                console.log('認証結果:', { data, error });
                
                if (error) {
                    throw new Error(`認証エラー: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('チームIDまたはパスワードが正しくありません');
                }
                
                // 認証成功
                currentTeamId = teamId;
                localStorage.setItem('ff14_team_id', teamId);
                
                // チームコンテキスト設定
                console.log('チームコンテキスト設定中...');
                const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                    team_id: teamId
                });
                
                if (contextError) {
                    console.error('コンテキスト設定エラー:', contextError);
                } else {
                    console.log('チームコンテキスト設定完了');
                }
                
                await showAuthenticatedState();
                showSuccess('ログインしました');
                
                // メイン機能の初期化
                await initializeMainFeatures();
                
            } catch (error) {
                console.error('認証エラー:', error);
                showError('認証に失敗しました: ' + error.message);
            }
        }
        
        // 認証後の状態表示
        async function showAuthenticatedState() {
            isAuthenticated = true;
            
            // UI切り替え
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('authenticated');
            document.getElementById('authControls').style.display = 'none';
            document.getElementById('loggedInControls').style.display = 'flex';
            document.getElementById('loggedInTeam').textContent = currentTeamId;
            
            // チーム情報表示
            document.getElementById('teamInfo').style.display = 'block';
            document.getElementById('currentTeamName').textContent = `チーム: ${currentTeamId}`;
        }
        
        // ログアウト
        function logout() {
            isAuthenticated = false;
            currentTeamId = null;
            
            // ローカルストレージクリア
            localStorage.removeItem('ff14_team_id');
            supabaseConfig.currentTeamId = null;
            
            // UI切り替え
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('authenticated');
            document.getElementById('authControls').style.display = 'flex';
            document.getElementById('loggedInControls').style.display = 'none';
            document.getElementById('teamInfo').style.display = 'none';
            
            // 入力欄クリア
            document.getElementById('teamIdInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('mainTeamIdInput').value = '';
            document.getElementById('mainPasswordInput').value = '';
            
            showSuccess('ログアウトしました');
        }
        
        // データベース接続テスト
        async function testDatabaseConnection() {
            if (!isAuthenticated) {
                showError('先にログインしてください');
                return;
            }
            
            try {
                showMessage('データベースに接続中...', 'info');
                
                // Supabaseクライアント確認
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントが初期化されていません');
                }
                
                // テストデータの保存
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'データベース接続テスト成功'
                };
                
                console.log('テストデータ保存中...');
                
                const { data: saveData, error: saveError } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: 'test-tier',
                        data_type: 'settings',
                        content: testData
                    });
                
                if (saveError) {
                    throw new Error(`保存エラー: ${saveError.message}`);
                }
                
                console.log('テストデータ読み込み中...');
                
                // テストデータの読み込み
                const { data: loadData, error: loadError } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', 'test-tier')
                    .eq('data_type', 'settings');
                
                if (loadError) {
                    throw new Error(`読み込みエラー: ${loadError.message}`);
                }
                
                console.log('読み込み結果:', loadData);
                
                if (loadData && loadData.length > 0) {
                    showSuccess('データベース接続テスト成功！データの保存・読み込みが正常に動作しています。');
                } else {
                    throw new Error('データの読み込みに失敗しました');
                }
                
            } catch (error) {
                console.error('データベーステストエラー:', error);
                showError('データベーステストに失敗しました: ' + error.message);
            }
        }
        
        // 接続状態更新
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                indicator.innerHTML = '<span>🟢</span><span>オンライン</span>';
            } else {
                indicator.className = 'connection-indicator offline';
                indicator.innerHTML = '<span>⚫</span><span>オフライン</span>';
            }
        }
        
        // メッセージ表示関数
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showMessage(message, type) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // 全メッセージを隠す
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => successEl.style.display = 'none', 3000);
            }
        }
        
        // エラーハンドリング
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未処理のエラー:', event.reason);
            showError('予期しないエラーが発生しました');
        });
        
        // ======================
        // メイン機能の実装
        // ======================
        
        // グローバル変数
        let currentRaidTier = null;
        let appData = {
            raidTiers: {},
            players: {},
            allocations: {},
            settings: {}
        };
        
        // メイン機能初期化
        async function initializeMainFeatures() {
            try {
                console.log('メイン機能初期化開始');
                
                // データ読み込み
                await loadAllData();
                
                // ダッシュボード表示
                showMainDashboard();
                
                console.log('メイン機能初期化完了');
            } catch (error) {
                console.error('メイン機能初期化エラー:', error);
                showError('メイン機能の初期化に失敗しました: ' + error.message);
            }
        }
        
        // 全データ読み込み
        async function loadAllData() {
            try {
                // Supabaseからデータ読み込み
                const { data: allData, error } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId);
                
                if (error) {
                    throw new Error(`データ読み込みエラー: ${error.message}`);
                }
                
                console.log('読み込みデータ:', allData);
                
                // データ種別ごとに分類
                if (allData && allData.length > 0) {
                    allData.forEach(item => {
                        const { tier_id, data_type, content } = item;
                        
                        if (data_type === 'settings') {
                            // 設定データの特殊処理
                            if (content.raidTier) {
                                // レイドティアデータ
                                if (!appData.raidTiers) appData.raidTiers = {};
                                appData.raidTiers[tier_id] = content.raidTier;
                            } else {
                                // その他の設定
                                if (!appData.settings) appData.settings = {};
                                appData.settings = { ...appData.settings, ...content };
                            }
                        } else {
                            // その他のデータタイプ
                            if (!appData[data_type]) {
                                appData[data_type] = {};
                            }
                            appData[data_type][tier_id] = content;
                        }
                    });
                }
                
                console.log('整理済みデータ:', appData);
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                // 初期データで継続
                appData = {
                    raidTiers: {},
                    players: {},
                    allocations: {},
                    settings: {}
                };
            }
        }
        
        // メインダッシュボード表示
        function showMainDashboard() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>FF14 零式装備分配システム</h1>
                <h2>チーム: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>レイドティア選択</h3>
                    <div class="tier-list" id="tierList">
                        <!-- レイドティア一覧がここに表示されます -->
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="createNewTier()">新しいレイドティアを作成</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>管理機能</h3>
                    <div class="navigation">
                        <button class="nav-button" onclick="showSystemSettings()">システム設定</button>
                        <button class="nav-button" onclick="exportAllData()">データエクスポート</button>
                        <button class="nav-button" onclick="testDatabaseConnection()">接続テスト</button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #e8f5e8; border-color: #27ae60;">
                    <h3>実装完了機能</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Supabase連携・認証システム</li>
                        <li>チーム別データ管理</li>
                        <li>リアルタイムデータ同期</li>
                        <li>レイドティア管理</li>
                        <li>プレイヤー・装備管理</li>
                    </ul>
                </div>
            `;
            
            // レイドティア一覧を表示
            displayRaidTiers();
        }
        
        // レイドティア一覧表示
        function displayRaidTiers() {
            const tierList = document.getElementById('tierList');
            const tiers = appData.raidTiers || {};
            
            if (Object.keys(tiers).length === 0) {
                tierList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>まだレイドティアが作成されていません。</p>
                        <p>「新しいレイドティアを作成」ボタンから始めてください。</p>
                    </div>
                `;
                return;
            }
            
            tierList.innerHTML = Object.entries(tiers).map(([tierId, tier]) => `
                <div class="tier-item ${currentRaidTier?.id === tierId ? 'active' : ''}" 
                     onclick="selectRaidTier('${tierId}')">
                    <h3>${tier.name}</h3>
                    <p>${tier.description || '零式レイド'}</p>
                    <p style="font-size: 0.8rem; color: #888;">
                        プレイヤー: ${Object.keys(appData.players[tierId] || {}).length}人
                    </p>
                </div>
            `).join('');
        }
        
        // レイドティア選択
        async function selectRaidTier(tierId) {
            const tier = appData.raidTiers[tierId];
            if (!tier) {
                showError('レイドティアが見つかりません');
                return;
            }
            
            currentRaidTier = { id: tierId, ...tier };
            showSuccess(`レイドティア「${tier.name}」を選択しました`);
            
            // ティア固有のダッシュボードを表示
            showTierDashboard();
        }
        
        // ティア固有ダッシュボード
        function showTierDashboard() {
            if (!currentRaidTier) return;
            
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showMainDashboard()">ダッシュボードに戻る</button>
                </div>
                
                <h1>${currentRaidTier.name}</h1>
                <h2>チーム: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>装備分配</h3>
                    <div class="dashboard-layer-grid">
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(1)">1層</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(2)">2層</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(3)">3層</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(4)">4層</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showPlayerManagement()">メンバー管理</button>
                        <button class="nav-button" onclick="showStatistics()">統計情報</button>
                        <button class="nav-button" onclick="showAllocationHistory()">配布履歴</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ティア情報</h3>
                    <p><strong>レイドティア:</strong> ${currentRaidTier.name}</p>
                    <p><strong>説明:</strong> ${currentRaidTier.description || '零式レイド'}</p>
                    <p><strong>登録メンバー:</strong> ${Object.keys(appData.players[currentRaidTier.id] || {}).length}人</p>
                    <p><strong>配布履歴:</strong> ${(appData.allocations[currentRaidTier.id] || []).length}件</p>
                </div>
            `;
        }
        
        // 新しいレイドティア作成
        async function createNewTier() {
            const name = prompt('レイドティア名を入力してください（例：7.1 アークガーディアン零式）:');
            if (!name) return;
            
            const description = prompt('説明を入力してください（省略可）:') || '零式レイド';
            
            try {
                const tierId = 'tier_' + Date.now();
                const tierData = {
                    name: name.trim(),
                    description: description.trim(),
                    createdAt: new Date().toISOString()
                };
                
                // Supabaseに保存
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .insert({
                        team_id: currentTeamId,
                        tier_id: tierId,
                        data_type: 'settings',
                        content: { raidTier: tierData }
                    });
                
                if (error) {
                    throw new Error(`保存エラー: ${error.message}`);
                }
                
                // ローカルデータ更新
                if (!appData.raidTiers) appData.raidTiers = {};
                appData.raidTiers[tierId] = tierData;
                
                showSuccess(`レイドティア「${name}」を作成しました`);
                
                // 表示更新
                displayRaidTiers();
                
            } catch (error) {
                console.error('ティア作成エラー:', error);
                showError('レイドティアの作成に失敗しました: ' + error.message);
            }
        }
        
        // プレイヤー管理機能
        function showPlayerManagement() {
            showPlayerSetup();
        }
        
        // プレイヤー設定画面（タブ形式）
        function showPlayerSetup() {
            showTabbedSetup('players');
        }
        
        // タブ形式のセットアップ画面
        function showTabbedSetup(activeTab = 'players') {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>メンバー・装備設定</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button ${activeTab === 'players' ? 'active' : ''}" onclick="showTabbedSetup('players')">
                            メンバー情報
                        </button>
                        <button class="tab-button ${activeTab === 'policy' ? 'active' : ''}" onclick="showTabbedSetup('policy')">
                            装備方針
                        </button>
                        <button class="tab-button ${activeTab === 'weapons' ? 'active' : ''}" onclick="showTabbedSetup('weapons')">
                            武器希望
                        </button>
                        <button class="tab-button ${activeTab === 'migration' ? 'active' : ''}" onclick="showTabbedSetup('migration')">
                            データ移行
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        ${getTabContent(activeTab)}
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="saveCurrentTabAndContinue('${activeTab}')">
                            設定完了
                        </button>
                    </div>
                </div>
            `;
        }
        
        // タブコンテンツ生成
        function getTabContent(tabName) {
            const players = appData.players[currentRaidTier.id] || {};
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (tabName === 'players') {
                return `
                    <h3>8人のメンバー情報を入力してください</h3>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position] || {};
                            const roleJobs = {
                                'MT': ['ナイト', '戦士', '暗黒騎士', 'ガンブレイカー'],
                                'ST': ['ナイト', '戦士', '暗黒騎士', 'ガンブレイカー'],
                                'H1': ['白魔道士', '占星術士', '学者', '賢者'],
                                'H2': ['白魔道士', '占星術士', '学者', '賢者'],
                                'D1': ['モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー'],
                                'D2': ['モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー'],
                                'D3': ['黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー', '吟遊詩人', '機工士', '踊り子'],
                                'D4': ['黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー', '吟遊詩人', '機工士', '踊り子']
                            };
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="position-badge">${position}</span>
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>プレイヤー名（必須）:</label>
                                        <input type="text" id="${position}-name" value="${player.name || ''}" 
                                               placeholder="プレイヤー名を入力" style="width: 100%;">
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>キャラクター名:</label>
                                        <input type="text" id="${position}-character" value="${player.characterName || ''}" 
                                               placeholder="キャラクター名（省略可）" style="width: 100%;">
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>ジョブ（必須）:</label>
                                        <select id="${position}-job" class="job-select">
                                            <option value="">ジョブを選択</option>
                                            ${roleJobs[position].map(job => `
                                                <option value="${job}" ${player.job === job ? 'selected' : ''}>${job}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'policy') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>まずメンバー情報タブでプレイヤー情報を設定してください。</p>
                        </div>
                    `;
                }
                
                const slots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
                
                return `
                    <h3>各プレイヤーの装備方針を設定</h3>
                    <p>零式：零式装備を優先取得、トームストーン：トームストーン装備で十分</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="equipment-policy">
                                        <div class="policy-grid">
                                            ${slots.map(slot => `
                                                <div class="policy-item">
                                                    <label>${slot}</label>
                                                    <select id="${position}-${slot}-policy">
                                                        <option value="零式" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === '零式') ? 'selected' : ''}>零式</option>
                                                        <option value="トームストーン" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'トームストーン') ? 'selected' : ''}>トームストーン</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'weapons') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>まずメンバー情報タブでプレイヤー情報を設定してください。</p>
                        </div>
                    `;
                }
                
                const allWeapons = [
                    'ナイト', '戦士', '暗黒騎士', 'ガンブレイカー',
                    '白魔道士', '占星術士', '学者', '賢者',
                    'モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー',
                    '黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー',
                    '吟遊詩人', '機工士', '踊り子'
                ];
                
                return `
                    <h3>4層直ドロップ武器の希望順位を設定</h3>
                    <p>第一希望は自動的にメインジョブになります。第二〜第四希望を選択してください。</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            const weaponWishes = player.weaponWishes || [];
                            const mainWeapon = player.job;
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="weapon-wishes">
                                        <div class="wish-priority">
                                            <label>第一希望 (メインジョブ):</label>
                                            <input type="text" value="${mainWeapon}" readonly style="background-color: #e9ecef;">
                                        </div>
                                        <div class="wish-priority">
                                            <label>第二希望:</label>
                                            <select id="${position}-weapon-wish-2">
                                                <option value="">選択してください</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[1] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>第三希望:</label>
                                            <select id="${position}-weapon-wish-3">
                                                <option value="">選択してください</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[2] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>第四希望:</label>
                                            <select id="${position}-weapon-wish-4">
                                                <option value="">選択してください</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[3] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'migration') {
                return `
                    <h3>既存データからの移行</h3>
                    <p>他のシステムやファイルからデータを移行する場合は、以下の機能をご利用ください。</p>
                    
                    <div class="section" style="background-color: #f8f9fa; border: 2px solid #e9ecef;">
                        <h4>📄 JSONファイルからのインポート</h4>
                        <div style="margin: 15px 0;">
                            <div style="display: flex; align-items: center; gap: 15px; margin: 10px 0;">
                                <input type="file" id="jsonFileInput" accept=".json" 
                                       style="flex: 1; padding: 12px; border: 2px dashed #3498db; border-radius: 8px; background-color: white;">
                                <button onclick="importFromJSON()" 
                                        style="padding: 12px 24px; background-color: #3498db; border-radius: 8px; font-weight: 600;">
                                    📂 JSONファイルをインポート
                                </button>
                            </div>
                            <div id="jsonFileInfo" style="display: none; padding: 10px; background-color: #d4edda; border-left: 4px solid #28a745; margin: 10px 0;">
                                <strong>ファイル選択済み:</strong> <span id="selectedFileName"></span><br>
                                <small id="fileDetails"></small>
                            </div>
                        </div>
                        <div style="background-color: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #27ae60;">
                            <strong>📋 対応形式:</strong><br>
                            • collaborative_index.htmlで作成されたデータ<br>
                            • 従来のFF14装備分配システムのエクスポートデータ<br>
                            • プレイヤー情報、装備方針、武器希望を含むJSONファイル<br>
                            • カスタムJSONフォーマット（自動判別）
                        </div>
                    </div>
                    
                    <div class="section" style="background-color: #fff9e6; border: 2px solid #f39c12;">
                        <h4>📋 CSV形式での一括登録</h4>
                        <div style="margin: 15px 0;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: start;">
                                <div style="display: flex; flex-direction: column;">
                                    <label for="csvTextArea" style="font-weight: 600; margin-bottom: 8px; color: #8b4513;">
                                        CSVデータを入力してください（ヘッダー行含む）:
                                    </label>
                                    <textarea id="csvTextArea" 
                                             placeholder="ポジション,プレイヤー名,ジョブ,キャラクター名&#10;MT,田中太郎,ナイト,Taro Tanaka&#10;ST,佐藤次郎,戦士,Jiro Sato&#10;H1,佐藤花子,白魔道士,Hanako Sato&#10;H2,田中美咲,学者,Misaki Tanaka&#10;D1,山田一郎,竜騎士,Ichiro Yamada&#10;D2,鈴木三郎,忍者,Saburo Suzuki&#10;D3,高橋美里,黒魔道士,Misato Takahashi&#10;D4,渡辺健太,吟遊詩人,Kenta Watanabe" 
                                             style="width: 100%; height: 160px; font-family: 'Courier New', monospace; font-size: 12px; padding: 12px; border: 2px solid #f39c12; border-radius: 8px; resize: vertical;"></textarea>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button onclick="importFromCSV()" 
                                                style="flex: 1; padding: 12px 24px; background-color: #f39c12; color: white; border-radius: 8px; font-weight: 600;">
                                            📊 CSVデータをインポート
                                        </button>
                                        <button onclick="clearCSVData()" 
                                                style="padding: 12px 20px; background-color: #95a5a6; color: white; border-radius: 8px;">
                                            🗑️ クリア
                                        </button>
                                    </div>
                                </div>
                                <div style="min-width: 200px;">
                                    <div style="background-color: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12;">
                                        <strong>CSV形式例:</strong><br>
                                        <code style="font-size: 11px; display: block; margin: 5px 0;">
                                        ポジション,プレイヤー名,ジョブ,キャラクター名<br>
                                        MT,田中太郎,ナイト,Taro Tanaka<br>
                                        ST,佐藤次郎,戦士,Jiro Sato
                                        </code><br>
                                        <strong>ポジション:</strong><br>
                                        MT, ST, H1, H2, D1, D2, D3, D4<br><br>
                                        <strong>⚠️ 注意:</strong><br>
                                        既存データは上書きされます
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section" style="background-color: #fdf2f2; border: 2px solid #e74c3c;">
                        <h4>🔄 データのリセット</h4>
                        <div style="margin: 15px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <button onclick="resetCurrentTierData()" 
                                            style="width: 100%; padding: 15px; background-color: #e74c3c; color: white; border-radius: 8px; font-weight: 600; margin-bottom: 10px;">
                                        🗑️ 現在のレイドティアデータをリセット
                                    </button>
                                    <button onclick="resetAllPlayersData()" 
                                            style="width: 100%; padding: 15px; background-color: #d86a5a; color: white; border-radius: 8px; font-weight: 600;">
                                        👥 プレイヤーデータのみリセット
                                    </button>
                                </div>
                                <div style="background-color: #fee; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; color: #721c24;">
                                    <strong>⚠️ 重要な注意事項:</strong><br><br>
                                    <strong>全データリセット:</strong><br>
                                    • プレイヤー情報<br>
                                    • 装備方針設定<br>
                                    • 武器希望リスト<br>
                                    • 分配履歴<br><br>
                                    <strong>プレイヤーデータのみ:</strong><br>
                                    • プレイヤー情報のみ削除<br>
                                    • 設定とログは保持<br><br>
                                    <strong>🚨 この操作は取り消せません</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section" style="background-color: #f0f8ff; border: 2px solid #3498db;">
                        <h4>💡 データ移行のヒント</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0;">
                            <div style="background-color: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                                <strong>📋 CSVファイルから貼り付ける場合:</strong><br>
                                1. Excelやスプレッドシートでファイルを開く<br>
                                2. データ範囲を選択してコピー<br>
                                3. CSVテキストエリアに貼り付け<br>
                                4. インポートボタンをクリック
                            </div>
                            <div style="background-color: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                                <strong>📄 JSONデータの準備:</strong><br>
                                1. 既存システムからエクスポート<br>
                                2. ファイル形式が.jsonであることを確認<br>
                                3. ファイルサイズが適切であることを確認<br>
                                4. アップロード前にバックアップを作成
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return '';
        }
        
        // 現在のタブを保存して次へ進む
        async function saveCurrentTabAndContinue(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                }
                
                showSuccess('設定を保存しました');
                
                // 全て設定済みかチェックしてダッシュボードへ
                if (Object.keys(appData.players[currentRaidTier.id] || {}).length > 0) {
                    showTierDashboard();
                } else {
                    showError('メンバー情報が設定されていません。');
                }
            } catch (error) {
                console.error('設定保存エラー:', error);
                showError('設定の保存に失敗しました: ' + error.message);
            }
        }
        
        // プレイヤー情報保存
        async function savePlayersData() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (!appData.players[currentRaidTier.id]) {
                appData.players[currentRaidTier.id] = {};
            }
            
            for (const position of positions) {
                const nameInput = document.getElementById(`${position}-name`);
                const characterInput = document.getElementById(`${position}-character`);
                const jobSelect = document.getElementById(`${position}-job`);
                
                if (!nameInput || !jobSelect) continue;
                
                const name = nameInput.value.trim();
                const characterName = characterInput.value.trim();
                const job = jobSelect.value;
                
                if (!name || !job) {
                    throw new Error(`${position}のプレイヤー名とジョブを入力してください。`);
                }
                
                // 既存データがある場合は保持
                const existingPlayer = appData.players[currentRaidTier.id][position] || {};
                
                appData.players[currentRaidTier.id][position] = {
                    name: name,
                    characterName: characterName,
                    job: job,
                    position: position,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    weaponWishes: existingPlayer.weaponWishes || [],
                    currentEquipment: existingPlayer.currentEquipment || {},
                    dynamicPriority: existingPlayer.dynamicPriority || 0,
                    allocationHistory: existingPlayer.allocationHistory || []
                };
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // 装備方針保存
        async function saveEquipmentPolicyData() {
            const players = appData.players[currentRaidTier.id];
            const slots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
            
            for (const [position, player] of Object.entries(players)) {
                for (const slot of slots) {
                    const policyElement = document.getElementById(`${position}-${slot}-policy`);
                    if (policyElement) {
                        const policy = policyElement.value;
                        player.equipmentPolicy[slot] = policy;
                    }
                }
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // 武器希望保存
        async function saveWeaponWishesData() {
            const players = appData.players[currentRaidTier.id];
            
            for (const [position, player] of Object.entries(players)) {
                const mainJob = player.job;
                const wish2Element = document.getElementById(`${position}-weapon-wish-2`);
                const wish3Element = document.getElementById(`${position}-weapon-wish-3`);
                const wish4Element = document.getElementById(`${position}-weapon-wish-4`);
                
                // 第一希望はメインジョブ、第二〜第四希望は選択された値
                player.weaponWishes = [
                    mainJob,
                    wish2Element ? wish2Element.value : '',
                    wish3Element ? wish3Element.value : '',
                    wish4Element ? wish4Element.value : ''
                ].filter(wish => wish !== ''); // 空の値を除外
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // データ移行機能
        
        // JSONファイルからのインポート
        async function importFromJSON() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('JSONファイルを選択してください。');
                return;
            }
            
            try {
                showMessage('ファイルを読み込み中...', 'info');
                
                const text = await file.text();
                const importData = JSON.parse(text);
                
                // データ形式の検証と変換
                const convertedData = await convertImportData(importData);
                
                if (!convertedData) {
                    showError('対応していないデータ形式です。');
                    return;
                }
                
                // 詳細情報の表示
                let playerCount = 0;
                let tierCount = 0;
                
                if (convertedData.type === 'collaborative') {
                    tierCount = Object.keys(convertedData.players || {}).length;
                    playerCount = Object.values(convertedData.players || {}).reduce((total, tierPlayers) => {
                        return total + Object.keys(tierPlayers || {}).length;
                    }, 0);
                } else if (convertedData.type === 'simple') {
                    playerCount = Object.keys(convertedData.players || {}).length;
                    tierCount = 1;
                }
                
                // 確認ダイアログ
                const confirmMessage = `以下のデータをインポートします：
                
プレイヤー数: ${playerCount}人
レイドティア数: ${tierCount}個
データ形式: ${convertedData.type === 'collaborative' ? '共同利用版' : '簡易版'}

現在のデータを上書きします。よろしいですか？`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // データをインポート
                await importConvertedData(convertedData);
                
                showSuccess(`データのインポートが完了しました。（${playerCount}人のプレイヤーを登録）`);
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('インポートエラー:', error);
                if (error.name === 'SyntaxError') {
                    showError('JSONファイルの形式が正しくありません。ファイルを確認してください。');
                } else {
                    showError('インポートに失敗しました: ' + error.message);
                }
            }
        }
        
        // JSONファイル選択時の処理
        document.addEventListener('DOMContentLoaded', function() {
            // ファイル選択時の情報表示を設定
            document.addEventListener('change', function(event) {
                if (event.target.id === 'jsonFileInput') {
                    const file = event.target.files[0];
                    const fileInfo = document.getElementById('jsonFileInfo');
                    const fileName = document.getElementById('selectedFileName');
                    const fileDetails = document.getElementById('fileDetails');
                    
                    if (file && fileInfo && fileName && fileDetails) {
                        fileName.textContent = file.name;
                        fileDetails.textContent = `サイズ: ${(file.size / 1024).toFixed(2)} KB, 最終更新: ${new Date(file.lastModified).toLocaleString()}`;
                        fileInfo.style.display = 'block';
                    } else if (fileInfo) {
                        fileInfo.style.display = 'none';
                    }
                }
            });
        });
        
        // CSVからのインポート
        async function importFromCSV() {
            const csvText = document.getElementById('csvTextArea').value.trim();
            
            if (!csvText) {
                showError('CSVデータを入力してください。');
                return;
            }
            
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const players = {};
                
                for (let i = 1; i < lines.length; i++) { // ヘッダー行をスキップ
                    const columns = lines[i].split(',').map(col => col.trim());
                    
                    if (columns.length < 4) continue;
                    
                    const [position, name, job, characterName] = columns;
                    
                    players[position] = {
                        name: name,
                        characterName: characterName || '',
                        job: job,
                        position: position,
                        equipmentPolicy: {},
                        weaponWishes: [job],
                        currentEquipment: {},
                        dynamicPriority: 0,
                        allocationHistory: []
                    };
                }
                
                if (Object.keys(players).length === 0) {
                    showError('有効なプレイヤーデータが見つかりません。');
                    return;
                }
                
                // 確認ダイアログ
                if (!confirm(`${Object.keys(players).length}人のプレイヤーデータをインポートします。よろしいですか？`)) {
                    return;
                }
                
                // データを保存
                appData.players[currentRaidTier.id] = players;
                await saveDataToSupabase('players', players);
                
                showSuccess('CSVデータのインポートが完了しました。');
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('CSVインポートエラー:', error);
                showError('CSVインポートに失敗しました: ' + error.message);
            }
        }
        
        // CSVデータクリア
        function clearCSVData() {
            const csvTextArea = document.getElementById('csvTextArea');
            if (csvTextArea) {
                csvTextArea.value = '';
                showSuccess('CSVデータをクリアしました。');
            }
        }
        
        // プレイヤーデータのみリセット
        async function resetAllPlayersData() {
            if (!confirm('現在のレイドティアのプレイヤー情報をすべて削除します。よろしいですか？')) {
                return;
            }
            
            if (!confirm('本当によろしいですか？プレイヤー情報、装備方針、武器希望がすべて削除されます。')) {
                return;
            }
            
            try {
                // プレイヤーデータのみ削除
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                
                // Supabaseからプレイヤーデータのみ削除
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id)
                    .eq('data_type', 'players');
                
                showSuccess('プレイヤーデータをリセットしました。');
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('プレイヤーデータリセットエラー:', error);
                showError('プレイヤーデータのリセットに失敗しました: ' + error.message);
            }
        }
        
        // 現在のティアデータをリセット
        async function resetCurrentTierData() {
            if (!confirm('現在のレイドティアのすべてのデータを削除します。この操作は取り消せません。よろしいですか？')) {
                return;
            }
            
            if (!confirm('本当によろしいですか？すべてのプレイヤー情報、装備方針、分配履歴が削除されます。')) {
                return;
            }
            
            try {
                // ローカルデータを削除
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                if (appData.allocations[currentRaidTier.id]) {
                    delete appData.allocations[currentRaidTier.id];
                }
                
                // Supabaseからも削除
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id);
                
                showSuccess('レイドティアデータをリセットしました。');
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('リセットエラー:', error);
                showError('データのリセットに失敗しました: ' + error.message);
            }
        }
        
        // インポートデータの変換
        async function convertImportData(importData) {
            // collaborative_index.html形式の場合
            if (importData.raidTiers && importData.players && importData.allocations) {
                return {
                    type: 'collaborative',
                    players: importData.players,
                    allocations: importData.allocations
                };
            }
            
            // 単純なプレイヤーリスト形式の場合
            if (Array.isArray(importData) && importData.length > 0 && importData[0].name) {
                const players = {};
                importData.forEach((player, index) => {
                    const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
                    const position = positions[index] || `D${index - 3}`;
                    
                    players[position] = {
                        name: player.name,
                        characterName: player.characterName || '',
                        job: player.job,
                        position: position,
                        equipmentPolicy: player.equipmentPolicy || {},
                        weaponWishes: player.weaponWishes || [player.job],
                        currentEquipment: player.currentEquipment || {},
                        dynamicPriority: player.dynamicPriority || 0,
                        allocationHistory: player.allocationHistory || []
                    };
                });
                
                return {
                    type: 'simple',
                    players: players
                };
            }
            
            return null;
        }
        
        // 変換済みデータのインポート
        async function importConvertedData(convertedData) {
            if (convertedData.type === 'collaborative') {
                // 現在のティアに対応するデータがある場合はそれを使用
                const tierData = Object.values(convertedData.players)[0] || {};
                appData.players[currentRaidTier.id] = tierData;
                
                // 分配履歴も移行
                if (convertedData.allocations) {
                    const allocationData = Object.values(convertedData.allocations)[0] || {};
                    appData.allocations[currentRaidTier.id] = allocationData;
                    await saveDataToSupabase('allocations', allocationData);
                }
            } else if (convertedData.type === 'simple') {
                appData.players[currentRaidTier.id] = convertedData.players;
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Supabaseデータ保存ヘルパー
        async function saveDataToSupabase(dataType, content) {
            const { error } = await window.supabaseClient
                .from('raid_data')
                .upsert({
                    team_id: currentTeamId,
                    tier_id: currentRaidTier.id,
                    data_type: dataType,
                    content: content
                });
                
            if (error) {
                throw new Error(`保存エラー: ${error.message}`);
            }
        }
        
        // 装備分配システム
        function showEquipmentAllocation() {
            const content = document.getElementById('content');
            
            // プレイヤーデータの確認
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('プレイヤー情報が設定されていません。メンバー設定を完了してください。');
                return;
            }
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                </div>
                
                <h1>装備分配システム</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>層を選択して装備分配を実行</h3>
                    <div class="layer-grid">
                        <div class="layer-card" onclick="processLayerAllocation(1)">
                            <h4>1層</h4>
                            <p>アクセサリー（耳・首・腕・指）</p>
                            <div class="layer-stats">
                                登録プレイヤー: ${playerCount}人
                            </div>
                        </div>
                        
                        <div class="layer-card" onclick="processLayerAllocation(2)">
                            <h4>2層</h4>
                            <p>防具（頭・手・足）+ 武器石・硬化薬</p>
                            <div class="layer-stats">
                                登録プレイヤー: ${playerCount}人
                            </div>
                        </div>
                        
                        <div class="layer-card" onclick="processLayerAllocation(3)">
                            <h4>3層</h4>
                            <p>防具（胴・脚）+ 強化薬・強化繊維</p>
                            <div class="layer-stats">
                                登録プレイヤー: ${playerCount}人
                            </div>
                        </div>
                        
                        <div class="layer-card" onclick="processLayerAllocation(4)">
                            <h4>4層</h4>
                            <p>胴装備 + 武器箱・直ドロップ武器</p>
                            <div class="layer-stats">
                                登録プレイヤー: ${playerCount}人
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section" id="allocationResults" style="display: none;">
                    <h3>分配結果</h3>
                    <div id="allocationContent"></div>
                </div>
            `;
        }
        
        // 層別装備分配処理
        async function processLayerAllocation(layer) {
            try {
                showMessage('分配処理中...', 'info');
                
                // 層別ドロップアイテムを取得
                const drops = getLayerDrops(layer);
                
                // 分配優先度を計算
                const allocationResults = calculateAllocation(layer, drops);
                
                // 結果を表示
                displayAllocationResults(layer, allocationResults);
                
            } catch (error) {
                console.error('分配処理エラー:', error);
                showError('分配処理に失敗しました: ' + error.message);
            }
        }
        
        // 層別ドロップアイテム定義
        function getLayerDrops(layer) {
            const drops = {
                1: [
                    { name: '耳装備', slot: '耳', type: 'equipment', itemLevel: '' },
                    { name: '首装備', slot: '首', type: 'equipment', itemLevel: '' },
                    { name: '腕装備', slot: '腕', type: 'equipment', itemLevel: '' },
                    { name: '指装備', slot: '指', type: 'equipment', itemLevel: '' }
                ],
                2: [
                    { name: '頭装備', slot: '頭', type: 'equipment', itemLevel: '' },
                    { name: '手装備', slot: '手', type: 'equipment', itemLevel: '' },
                    { name: '足装備', slot: '足', type: 'equipment', itemLevel: '' },
                    { name: '武器石', slot: '武器石', type: 'material', itemLevel: '' },
                    { name: '硬化薬', slot: '硬化薬', type: 'material', itemLevel: '' }
                ],
                3: [
                    { name: '胴装備', slot: '胴', type: 'equipment', itemLevel: '' },
                    { name: '脚装備', slot: '脚', type: 'equipment', itemLevel: '' },
                    { name: '強化薬', slot: '強化薬', type: 'material', itemLevel: '' },
                    { name: '強化繊維', slot: '強化繊維', type: 'material', itemLevel: '' }
                ],
                4: [
                    { name: '胴装備', slot: '胴', type: 'equipment', itemLevel: '' },
                    { name: '武器箱', slot: '武器箱', type: 'weapon_box', itemLevel: '' },
                    { name: '直ドロップ武器', slot: '武器', type: 'direct_weapon', itemLevel: '', weapon: null }
                ]
            };
            
            return drops[layer] || [];
        }
        
        // 分配優先度計算
        function calculateAllocation(layer, drops) {
            const players = appData.players[currentRaidTier.id] || {};
            const results = {};
            
            drops.forEach(drop => {
                const allCandidates = [];
                
                Object.entries(players).forEach(([position, player]) => {
                    const priority = calculatePlayerPriority(player, drop);
                    allCandidates.push({
                        position,
                        player,
                        priority: priority.score,
                        reason: priority.reason,
                        type: priority.type,
                        canReceive: priority.canReceive
                    });
                });
                
                // 優先度順でソート（全プレイヤー）
                allCandidates.sort((a, b) => b.priority - a.priority);
                
                // 取得可能な候補者のみ抽出
                const candidates = allCandidates.filter(c => c.canReceive);
                
                results[drop.slot] = {
                    drop,
                    candidates: allCandidates, // 全プレイヤーの判定結果
                    recommended: candidates[0] || null // 最優先の取得可能者
                };
            });
            
            return results;
        }
        
        // プレイヤー優先度計算
        function calculatePlayerPriority(player, drop) {
            let score = 0;
            let canReceive = false;
            let reason = 'Pass';
            let type = 'pass';
            
            if (drop.type === 'equipment') {
                // 装備の場合
                const policy = player.equipmentPolicy?.[drop.slot] || 'トームストーン';
                const hasEquipment = player.currentEquipment?.[drop.slot];
                
                if (policy === '零式' && !hasEquipment) {
                    canReceive = true;
                    type = 'need';
                    score = 1000 - (player.dynamicPriority || 0);
                    reason = 'Need (零式)';
                } else if (!hasEquipment) {
                    canReceive = true;
                    type = 'greed';
                    score = 500 - (player.dynamicPriority || 0);
                    reason = 'Greed (トーム可)';
                } else {
                    type = 'pass';
                    reason = 'Pass (所持済み)';
                }
            } else if (drop.type === 'material') {
                // 強化素材の場合（分配優先度設定に基づく）
                const materialAllocations = appData.allocations?.[currentRaidTier.id] || [];
                const hasThisMaterial = materialAllocations.some(alloc => 
                    alloc.position === player.position && alloc.slot === drop.slot
                );
                
                if (!hasThisMaterial) {
                    canReceive = true;
                    type = 'need';
                    score = getMaterialPriority(player.position, drop.slot) - (player.dynamicPriority || 0);
                    reason = 'Need (素材)';
                } else {
                    type = 'pass';
                    reason = 'Pass (取得済み)';
                }
            } else if (drop.type === 'weapon_box') {
                // 武器箱の場合
                const hasWeapon = player.currentEquipment?.['武器'];
                if (!hasWeapon) {
                    canReceive = true;
                    type = 'need';
                    score = 2000 - (player.dynamicPriority || 0);
                    reason = 'Need (武器箱)';
                } else {
                    type = 'pass';
                    reason = 'Pass (武器所持済み)';
                }
            } else if (drop.type === 'direct_weapon') {
                // 直ドロップ武器の場合（武器希望に基づく）
                const weaponWishes = player.weaponWishes || [];
                const hasWeapon = player.currentEquipment?.['武器'];
                const weaponType = drop.weapon; // 選択された武器種
                
                if (!hasWeapon && weaponType && weaponWishes.includes(weaponType)) {
                    canReceive = true;
                    type = 'need';
                    const wishIndex = weaponWishes.indexOf(weaponType);
                    score = 3000 - (wishIndex * 100) - (player.dynamicPriority || 0);
                    reason = `Need (第${wishIndex + 1}希望)`;
                } else if (!hasWeapon) {
                    canReceive = true;
                    type = 'greed';
                    score = 100 - (player.dynamicPriority || 0);
                    reason = 'Greed (武器)';
                } else {
                    type = 'pass';
                    reason = 'Pass (武器所持済み)';
                }
            }
            
            return { canReceive, score, reason, type };
        }
        
        // 強化素材の分配優先度取得
        function getMaterialPriority(position, materialType) {
            // デフォルトの分配優先度順序（設定可能にする予定）
            const defaultOrder = ['D1', 'D2', 'D3', 'D4', 'H1', 'H2', 'MT', 'ST'];
            const positionIndex = defaultOrder.indexOf(position);
            return 800 - (positionIndex * 50); // 高い順位ほど高スコア
        }
        
        // 分配結果表示
        function displayAllocationResults(layer, results) {
            const allocationResults = document.getElementById('allocationResults');
            const allocationContent = document.getElementById('allocationContent');
            
            let html = `
                <div class="allocation-header">
                    <h4>${layer}層 装備分配結果</h4>
                    <p>推奨分配者が自動計算されました。必要に応じて変更してください。</p>
                </div>
            `;
            
            // 直ドロップ武器選択（4層のみ）
            if (layer === 4) {
                html += `
                    <div class="weapon-selection">
                        <h5>直ドロップ武器選択:</h5>
                        <select id="directWeaponSelect" onchange="updateDirectWeapon()">
                            <option value="">武器を選択してください</option>
                            <option value="ナイト">ナイト武器</option>
                            <option value="戦士">戦士武器</option>
                            <option value="暗黒騎士">暗黒騎士武器</option>
                            <option value="ガンブレイカー">ガンブレイカー武器</option>
                            <option value="白魔道士">白魔道士武器</option>
                            <option value="学者">学者武器</option>
                            <option value="占星術士">占星術士武器</option>
                            <option value="賢者">賢者武器</option>
                            <option value="モンク">モンク武器</option>
                            <option value="竜騎士">竜騎士武器</option>
                            <option value="忍者">忍者武器</option>
                            <option value="侍">侍武器</option>
                            <option value="リーパー">リーパー武器</option>
                            <option value="ヴァイパー">ヴァイパー武器</option>
                            <option value="黒魔道士">黒魔道士武器</option>
                            <option value="召喚士">召喚士武器</option>
                            <option value="赤魔道士">赤魔道士武器</option>
                            <option value="ピクトマンサー">ピクトマンサー武器</option>
                            <option value="吟遊詩人">吟遊詩人武器</option>
                            <option value="機工士">機工士武器</option>
                            <option value="踊り子">踊り子武器</option>
                        </select>
                    </div>
                `;
            }
            
            html += `<div class="allocation-grid">`;
            
            Object.entries(results).forEach(([itemKey, result]) => {
                const drop = result.drop;
                const needCandidates = result.candidates.filter(c => c.type === 'need');
                const greedCandidates = result.candidates.filter(c => c.type === 'greed');
                const passCandidates = result.candidates.filter(c => c.type === 'pass');
                
                html += `
                    <div class="allocation-item">
                        <div class="item-header">
                            <h5>${drop.name} ${drop.itemLevel}</h5>
                            <span class="item-type">${getItemTypeLabel(drop.type)}</span>
                        </div>
                        
                        <div class="predicted-winner">
                            <strong>予測取得者:</strong> 
                            ${result.recommended ? 
                                `${result.recommended.player.name} (${result.recommended.position}) - ${result.recommended.reason}` : 
                                '該当者なし'
                            }
                        </div>
                        
                        <div class="allocation-choice">
                            <label>実際の取得者:</label>
                            <select id="allocation-${itemKey}" onchange="updateAllocationChoice('${itemKey}')">
                                <option value="">選択してください</option>
                                ${result.candidates.map(candidate => `
                                    <option value="${candidate.position}" 
                                            ${result.recommended?.position === candidate.position ? 'selected' : ''}>
                                        ${candidate.player.name} (${candidate.position}) - ${candidate.reason}
                                    </option>
                                `).join('')}
                                <option value="フリロ">フリロ</option>
                                <option value="discard">破棄</option>
                            </select>
                        </div>
                        
                        <div class="judgment-details">
                            <div class="judgment-section">
                                <button class="judgment-toggle" onclick="toggleJudgment('${itemKey}')">
                                    判定詳細を表示 ▼
                                </button>
                                <div id="judgment-${itemKey}" class="judgment-content" style="display: none;">
                                    ${needCandidates.length > 0 ? `
                                        <div class="need-section">
                                            <h6>Need (${needCandidates.length}人)</h6>
                                            ${needCandidates.map(candidate => `
                                                <div class="candidate-item need">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${greedCandidates.length > 0 ? `
                                        <div class="greed-section">
                                            <h6>Greed (${greedCandidates.length}人)</h6>
                                            ${greedCandidates.map(candidate => `
                                                <div class="candidate-item greed">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${passCandidates.length > 0 ? `
                                        <div class="pass-section">
                                            <h6>Pass (${passCandidates.length}人)</h6>
                                            ${passCandidates.map(candidate => `
                                                <div class="candidate-item pass">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="allocation-actions">
                    <button onclick="confirmAllocation(${layer})" class="confirm-btn">
                        分配を確定
                    </button>
                    <button onclick="showEquipmentAllocation()" class="cancel-btn">
                        キャンセル
                    </button>
                </div>
            `;
            
            allocationContent.innerHTML = html;
            allocationResults.style.display = 'block';
            
            // 結果表示エリアまでスクロール
            allocationResults.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 直ドロップ武器更新
        function updateDirectWeapon() {
            const weaponSelect = document.getElementById('directWeaponSelect');
            const selectedWeapon = weaponSelect.value;
            
            if (selectedWeapon) {
                // 直ドロップ武器の分配を再計算
                const drops = getLayerDrops(4);
                const weaponDrop = drops.find(d => d.type === 'direct_weapon');
                if (weaponDrop) {
                    weaponDrop.weapon = selectedWeapon;
                    const allocationResults = calculateAllocation(4, drops);
                    displayAllocationResults(4, allocationResults);
                }
            }
        }
        
        // 判定詳細の表示切り替え
        function toggleJudgment(itemKey) {
            const content = document.getElementById(`judgment-${itemKey}`);
            const button = content.previousElementSibling;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = '判定詳細を隠す ▲';
            } else {
                content.style.display = 'none';
                button.textContent = '判定詳細を表示 ▼';
            }
        }
        
        // アイテムタイプラベル
        function getItemTypeLabel(type) {
            const labels = {
                'equipment': '装備',
                'material': '強化素材',
                'weapon_box': '武器箱',
                'direct_weapon': '直ドロップ武器'
            };
            return labels[type] || type;
        }
        
        // 分配選択更新
        function updateAllocationChoice(slot) {
            // 選択変更時の処理（必要に応じて実装）
            console.log(`${slot}の分配選択が変更されました`);
        }
        
        // 分配確定
        async function confirmAllocation(layer) {
            try {
                const allocations = [];
                const selects = document.querySelectorAll('[id^="allocation-"]');
                const allocationId = Date.now().toString();
                
                selects.forEach(select => {
                    const itemKey = select.id.replace('allocation-', '');
                    const position = select.value;
                    
                    if (position && position !== 'discard' && position !== 'フリロ') {
                        const player = appData.players[currentRaidTier.id][position];
                        const drops = getLayerDrops(layer);
                        const drop = drops.find(d => d.slot === itemKey || d.name.includes(itemKey));
                        
                        if (drop && player) {
                            const allocation = {
                                id: `${allocationId}-${itemKey}`,
                                layer: layer,
                                slot: drop.slot,
                                position: position,
                                playerName: player.name,
                                characterName: player.characterName || '',
                                job: player.job,
                                equipment: {
                                    name: drop.name,
                                    slot: drop.slot,
                                    itemLevel: drop.itemLevel
                                },
                                timestamp: new Date().toISOString(),
                                week: getCurrentWeek(),
                                raidTier: currentRaidTier.name,
                                // 詳細情報
                                itemType: drop.type,
                                equipmentName: drop.name,
                                equipmentSlot: drop.slot,
                                winner: position,
                                winnerName: player.name
                            };
                            
                            allocations.push(allocation);
                        }
                    }
                });
                
                if (allocations.length === 0) {
                    showError('分配する装備が選択されていません。');
                    return;
                }
                
                // 分配履歴に記録
                if (!appData.allocations[currentRaidTier.id]) {
                    appData.allocations[currentRaidTier.id] = [];
                }
                
                allocations.forEach(allocation => {
                    appData.allocations[currentRaidTier.id].push(allocation);
                    
                    // プレイヤーの装備状況更新
                    const player = appData.players[currentRaidTier.id][allocation.position];
                    if (player) {
                        // 現在装備の更新
                        if (!player.currentEquipment) player.currentEquipment = {};
                        player.currentEquipment[allocation.slot] = true;
                        
                        // 分配履歴の更新
                        if (!player.allocationHistory) player.allocationHistory = [];
                        player.allocationHistory.push({
                            equipment: allocation.equipment,
                            timestamp: allocation.timestamp,
                            week: allocation.week,
                            layer: allocation.layer
                        });
                        
                        // 動的優先度更新
                        const itemPriority = getItemPriority(allocation.slot);
                        player.dynamicPriority = (player.dynamicPriority || 0) + itemPriority;
                    }
                });
                
                // Supabaseに保存
                await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
                
                showSuccess(`${layer}層の装備分配を確定しました。${allocations.length}件の装備が分配されました。`);
                showEquipmentAllocation(); // 装備分配画面に戻る
                
            } catch (error) {
                console.error('分配確定エラー:', error);
                showError('分配の確定に失敗しました: ' + error.message);
            }
        }
        
        // 現在の週番号取得
        function getCurrentWeek() {
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const weekNumber = Math.ceil(((now - yearStart) / 86400000 + yearStart.getDay() + 1) / 7);
            return weekNumber;
        }
        
        // アイテム優先度取得
        function getItemPriority(slot) {
            const priorities = {
                '武器': 3,
                '胴': 2,
                '脚': 2,
                '頭': 1,
                '手': 1,
                '足': 1,
                '耳': 1,
                '首': 1,
                '腕': 1,
                '指': 1,
                '武器石': 1,
                '硬化薬': 1,
                '強化薬': 1,
                '強化繊維': 1
            };
            return priorities[slot] || 1;
        }
        
        // 統計情報表示
        function showStatistics() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            const allocations = appData.allocations[currentRaidTier.id] || [];
            
            if (Object.keys(players).length === 0) {
                showError('プレイヤー情報が設定されていません。');
                return;
            }
            
            // 統計データ計算
            const stats = calculateStatistics(players, allocations);
            
            content.innerHTML = `
                <h1>統計情報</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>📊 プレイヤー別取得状況</h3>
                    <div class="stats-grid">
                        ${Object.entries(stats.playerStats).map(([position, stat]) => `
                            <div class="stat-card">
                                <h4>${stat.name} (${position})</h4>
                                <div class="stat-details">
                                    <div class="stat-item">
                                        <span class="stat-label">装備取得数:</span>
                                        <span class="stat-value">${stat.equipmentCount}件</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">素材取得数:</span>
                                        <span class="stat-value">${stat.materialCount}件</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">総取得数:</span>
                                        <span class="stat-value">${stat.totalCount}件</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">動的優先度:</span>
                                        <span class="stat-value">${stat.dynamicPriority}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>📈 部位別分配状況</h3>
                    <div class="slot-stats">
                        ${Object.entries(stats.slotStats).map(([slot, count]) => `
                            <div class="slot-stat-item">
                                <span class="slot-name">${slot}:</span>
                                <span class="slot-count">${count}件</span>
                                <div class="slot-bar">
                                    <div class="slot-progress" style="width: ${(count / Math.max(...Object.values(stats.slotStats))) * 100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>📅 週別分配履歴</h3>
                    <div class="week-stats">
                        ${Object.entries(stats.weekStats).map(([week, count]) => `
                            <div class="week-stat-item">
                                <span class="week-number">第${week}週:</span>
                                <span class="week-count">${count}件</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>🏆 分配サマリー</h3>
                    <div class="summary-stats">
                        <div class="summary-item">
                            <h4>総分配数</h4>
                            <div class="summary-value">${allocations.length}件</div>
                        </div>
                        <div class="summary-item">
                            <h4>平均取得数</h4>
                            <div class="summary-value">${(allocations.length / Object.keys(players).length).toFixed(1)}件/人</div>
                        </div>
                        <div class="summary-item">
                            <h4>活動週数</h4>
                            <div class="summary-value">${Object.keys(stats.weekStats).length}週</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 統計データ計算
        function calculateStatistics(players, allocations) {
            const playerStats = {};
            const slotStats = {};
            const weekStats = {};
            
            // プレイヤー統計初期化
            Object.entries(players).forEach(([position, player]) => {
                playerStats[position] = {
                    name: player.name,
                    equipmentCount: 0,
                    materialCount: 0,
                    totalCount: 0,
                    dynamicPriority: player.dynamicPriority || 0
                };
            });
            
            // 分配履歴から統計計算
            allocations.forEach(allocation => {
                const position = allocation.position;
                const slot = allocation.slot;
                const week = allocation.week;
                
                // プレイヤー統計更新
                if (playerStats[position]) {
                    if (['武器石', '硬化薬', '強化薬', '強化繊維'].includes(slot)) {
                        playerStats[position].materialCount++;
                    } else {
                        playerStats[position].equipmentCount++;
                    }
                    playerStats[position].totalCount++;
                }
                
                // 部位統計更新
                slotStats[slot] = (slotStats[slot] || 0) + 1;
                
                // 週統計更新
                weekStats[week] = (weekStats[week] || 0) + 1;
            });
            
            return { playerStats, slotStats, weekStats };
        }
        
        // 分配履歴表示
        function showAllocationHistory() {
            const content = document.getElementById('content');
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            content.innerHTML = `
                <h1>分配履歴</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>フィルター</h3>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>層:</label>
                            <select id="layerFilter" onchange="filterAllocationHistory()">
                                <option value="">全て</option>
                                <option value="1">1層</option>
                                <option value="2">2層</option>
                                <option value="3">3層</option>
                                <option value="4">4層</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>取得者:</label>
                            <select id="playerFilter" onchange="filterAllocationHistory()">
                                <option value="">全て</option>
                                ${Object.entries(players).map(([position, player]) => `
                                    <option value="${position}">${player.name} (${position})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>装備部位:</label>
                            <select id="slotFilter" onchange="filterAllocationHistory()">
                                <option value="">全て</option>
                                <option value="武器">武器</option>
                                <option value="頭">頭</option>
                                <option value="胴">胴</option>
                                <option value="手">手</option>
                                <option value="脚">脚</option>
                                <option value="足">足</option>
                                <option value="耳">耳</option>
                                <option value="首">首</option>
                                <option value="腕">腕</option>
                                <option value="指">指</option>
                                <option value="武器石">武器石</option>
                                <option value="硬化薬">硬化薬</option>
                                <option value="強化薬">強化薬</option>
                                <option value="強化繊維">強化繊維</option>
                            </select>
                        </div>
                        
                        <button onclick="clearAllFilters()" class="clear-filters-btn">
                            フィルタークリア
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>分配履歴 (${allocations.length}件)</h3>
                    <div id="historyTable">
                        ${generateHistoryTable(allocations, players)}
                    </div>
                </div>
            `;
        }
        
        // 履歴テーブル生成
        function generateHistoryTable(allocations, players) {
            if (allocations.length === 0) {
                return '<p class="no-data">分配履歴がありません。</p>';
            }
            
            // 日付順で降順ソート
            const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            return `
                <div class="history-table">
                    <div class="history-header">
                        <div class="history-cell">日時</div>
                        <div class="history-cell">層</div>
                        <div class="history-cell">装備部位</div>
                        <div class="history-cell">取得者</div>
                    </div>
                    ${sortedAllocations.map(allocation => {
                        const player = players[allocation.position];
                        const date = new Date(allocation.timestamp);
                        return `
                            <div class="history-row">
                                <div class="history-cell">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
                                <div class="history-cell">${allocation.layer}層</div>
                                <div class="history-cell">${allocation.slot}</div>
                                <div class="history-cell">${player ? player.name : allocation.playerName} (${allocation.position})</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // 履歴フィルタリング
        function filterAllocationHistory() {
            const layerFilter = document.getElementById('layerFilter').value;
            const playerFilter = document.getElementById('playerFilter').value;
            const slotFilter = document.getElementById('slotFilter').value;
            
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            let filteredAllocations = allocations.filter(allocation => {
                if (layerFilter && allocation.layer.toString() !== layerFilter) return false;
                if (playerFilter && allocation.position !== playerFilter) return false;
                if (slotFilter && allocation.slot !== slotFilter) return false;
                return true;
            });
            
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = generateHistoryTable(filteredAllocations, players);
            
            // フィルター結果の件数を更新
            const sectionTitle = document.querySelector('h3');
            sectionTitle.textContent = `分配履歴 (${filteredAllocations.length}件)`;
        }
        
        // 全フィルタークリア
        function clearAllFilters() {
            document.getElementById('layerFilter').value = '';
            document.getElementById('playerFilter').value = '';
            document.getElementById('slotFilter').value = '';
            filterAllocationHistory();
        }
        
        function showSystemSettings() {
            showMessage('システム設定機能は実装中です', 'info');
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ff14_raid_data_${currentTeamId}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSuccess('データをエクスポートしました');
        }
    </script>
</body>
</html>