# 分離時リスク評価

## リスク評価基準

### 影響度スコア (0-100点)
- **0-10点**: 無視できるリスク (CSS、設定値等)
- **11-25点**: 低リスク (純粋関数、独立機能)
- **26-50点**: 中リスク (部分的依存、DOM操作)
- **51-75点**: 高リスク (状態管理、データ結合)
- **76-100点**: 極高リスク (コア機能、複雑な相互依存)

### 評価要素
1. **機能欠損リスク** (0-25点)
2. **UI崩れリスク** (0-25点)
3. **データ整合性リスク** (0-25点)
4. **復旧困難度** (0-25点)

## 詳細リスク評価

### Phase 1: CSS分離
**総合リスク: 3点 (極低リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 0 | CSS変更は機能に影響なし |
| UI崩れ | 3 | 外部ファイル読み込み失敗の可能性 |
| データ整合性 | 0 | データに影響なし |
| 復旧困難度 | 0 | 即座に元に戻せる |

**リスク要因**:
- ✅ 分離対象: 1543行のCSS定義
- ✅ 独立性: 完全独立
- ⚠️ 唯一のリスク: ファイルパスエラー

**対策**:
```html
<!-- 元のインラインCSS保持 -->
<style>
    /* フォールバック用CSS */
</style>
<link rel="stylesheet" href="css/style.css">
```

**検証方法**: UI表示の目視確認

---

### Phase 2: 設定・定数分離
**総合リスク: 8点 (極低リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 5 | 設定値読み込み失敗の可能性 |
| UI崩れ | 0 | UIに直接影響なし |
| データ整合性 | 3 | Supabase接続設定の影響 |
| 復旧困難度 | 0 | 設定値の簡単な復元 |

**リスク要因**:
- ⚠️ DISCORD_CONFIG読み込み失敗
- ⚠️ SUPABASE_CONFIG読み込み失敗
- ⚠️ GitHub Actions変数置換の対象変更

**対策**:
```javascript
// フォールバック設定
const DISCORD_CONFIG = window.DISCORD_CONFIG || {
    client_id: '1421136327843250286',
    // ... デフォルト値
};
```

**検証方法**: 認証フローの完全テスト

---

### Phase 3: ユーティリティ関数分離
**総合リスク: 12点 (低リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 8 | 関数参照エラーの可能性 |
| UI崩れ | 4 | ロール表示の影響 |
| データ整合性 | 0 | データに影響なし |
| 復旧困難度 | 0 | 関数の簡単な復元 |

**分離対象関数**:
```javascript
getPositionRoleClass(position)  // 使用箇所: 15箇所
getDisplayTeamName(teamName)    // 使用箇所: 8箇所
```

**リスク要因**:
- ⚠️ 関数のスコープ変更
- ⚠️ `undefined is not a function` エラー

**対策**:
```javascript
// グローバルスコープでの関数定義確保
window.getPositionRoleClass = getPositionRoleClass;
window.getDisplayTeamName = getDisplayTeamName;
```

**検証方法**: 全画面でのロール表示確認

---

### Phase 4: メッセージ表示機能分離
**総合リスク: 22点 (低リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 10 | エラー表示機能の影響 |
| UI崩れ | 8 | メッセージ表示の影響 |
| データ整合性 | 0 | データに影響なし |
| 復旧困難度 | 4 | DOM依存の復旧 |

**分離対象**: showError, showSuccess, showMessage

**リスク要因**:
- ⚠️ DOM要素への依存
- ⚠️ CSS クラスへの依存
- ⚠️ エラーハンドリングの連鎖

**対策**:
```javascript
// DOM要素の存在確認
function showMessage(message, type) {
    const messageElement = document.querySelector('.message-container');
    if (!messageElement) {
        console.warn('Message container not found');
        return;
    }
    // ... 処理継続
}
```

---

### Phase 5: 統計・履歴機能分離
**総合リスク: 45点 (中リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 15 | 統計計算ロジックの複雑性 |
| UI崩れ | 12 | 統計テーブル表示の影響 |
| データ整合性 | 10 | 分配データとの依存 |
| 復旧困難度 | 8 | 複雑なデータ処理の復旧 |

**高リスク要因**:
- ❌ 分配データとの密結合
- ❌ 複雑な統計計算
- ❌ 編集機能との統合

**対策**: データインターフェースの設計

---

### Phase 6: プレイヤー管理分離
**総合リスク: 58点 (高リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 18 | タブシステムの複雑性 |
| UI崩れ | 15 | タブUI、フォームの影響 |
| データ整合性 | 15 | プレイヤーデータの整合性 |
| 復旧困難度 | 10 | 複雑なタブシステム復旧 |

**極高リスク要因**:
- ❌ 複雑なタブシステム (3タブ x 多機能)
- ❌ データインポート/エクスポート機能
- ❌ プレイヤーデータの全機能への影響

---

### Phase 7: 装備分配システム分離
**総合リスク: 78点 (極高リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 22 | システムの核心機能 |
| UI崩れ | 18 | 複雑な分配UI |
| データ整合性 | 20 | 分配ロジックの整合性 |
| 復旧困難度 | 18 | 複雑な計算ロジック |

**極高リスク要因**:
- ❌ 779行の複雑な分配ロジック
- ❌ プレイヤーデータとの密結合
- ❌ 優先順位システムとの連携
- ❌ システムの核心価値

---

### Phase 8: 認証システム分離
**総合リスク: 85点 (極高リスク)**

| 要素 | スコア | 理由 |
|------|-------|------|
| 機能欠損 | 25 | 全機能の前提条件 |
| UI崩れ | 20 | 認証UI、状態遷移 |
| データ整合性 | 20 | 認証状態の整合性 |
| 復旧困難度 | 20 | 初期化順序の依存 |

**極高リスク要因**:
- ❌ 743行の認証システム
- ❌ アプリケーション初期化の中枢
- ❌ 全機能への認証状態依存
- ❌ Discord認証との複雑な連携

---

## リスク軽減戦略

### 段階的セーフティネット

#### Level 1: ファイルレベル保護
```bash
# 各段階でのバックアップ
cp index.html index_before_phase_N.html
git tag safe-point-phase-N
```

#### Level 2: 機能レベル保護
```javascript
// フォールバック関数の実装
function safeCall(fn, ...args) {
    try {
        return fn.apply(this, args);
    } catch (error) {
        console.error('Function call failed:', error);
        // フォールバック処理
    }
}
```

#### Level 3: データレベル保護
```javascript
// データ整合性チェック
function validateDataIntegrity() {
    // 主要データの存在確認
    // 状態の一貫性確認
    return isValid;
}
```

#### Level 4: UI レベル保護
```javascript
// UI状態の検証
function validateUIState() {
    // 重要なDOM要素の存在確認
    // 表示状態の一貫性確認
    return isUIValid;
}
```

## 実行時安全基準

### 各段階の成功基準
1. **機能テスト**: 100% パス
2. **UI検証**: 元と同一の表示
3. **データ整合性**: エラー 0件
4. **パフォーマンス**: 劣化なし

### 失敗時の自動復旧
```bash
# 失敗検出時の自動復旧
if [ "$VALIDATION_FAILED" = "true" ]; then
    git reset --hard safe-point-phase-N
    echo "Automatic rollback completed"
fi
```

この詳細なリスク評価により、各段階での安全な分離実行が可能になります。