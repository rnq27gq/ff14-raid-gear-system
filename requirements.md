# FF14装備分配システム Discord連携機能 要件定義書

## 1. プロジェクト概要

### 1.1 背景
現在のFF14装備分配システムは、チームID + パスワードによる認証方式を採用しているが、ユーザビリティの向上とDiscordコミュニティとの連携強化を目的として、Discord連携による認証システムを導入する。

### 1.2 目的
- Discordボットを介したシームレスなチーム作成
- 固有URLによる簡単なアクセス
- Discordユーザーとの自動連携
- 既存機能の保持と互換性確保

## 2. 機能要件

### 2.1 Discordボット機能

#### 2.1.1 チーム作成コマンド
- **コマンド**: `/team-create`
- **パラメータ**: 
  - `team-name`: チーム名（3-20文字、日本語・英数字対応）
  - `leader-name`: リーダー名（任意、デフォルトはDiscordユーザー名）
- **機能**: 新しいチームを作成し、固有URLを生成

#### 2.1.2 URL生成・投稿機能
- チーム作成時に固有の認証URLを生成
- 生成されたURLをDiscordチャンネルに自動投稿
- URL形式: `https://[domain]/team/[unique-token]`
- トークンの有効期限: 24時間（設定可能）

#### 2.1.3 チーム管理機能
- `/team-info`: 現在のチーム情報表示
- `/team-invite`: 新しい招待URLの生成
- `/team-close`: チームの無効化

### 2.2 Web認証機能

#### 2.2.1 Discord OAuth2認証
- Discord OAuth2を使用したユーザー認証
- 必要なスコープ: `identify`, `guilds`
- ユーザー情報の取得: ID, ユーザー名, アバター

#### 2.2.2 セッション管理
- Discord認証後のセッション管理
- 既存のSupabase認証との統合
- ログアウト機能の提供

#### 2.2.3 ユーザー識別
- DiscordユーザーIDによる一意識別
- ユーザー名の自動設定
- プロフィール情報の連携

### 2.3 互換性要件

#### 2.3.1 既存認証との共存
- 既存のチームID + パスワード認証の継続サポート
- データベース構造の後方互換性
- 段階的移行の支援

#### 2.3.2 既存機能の保持
- 装備分配システムの全機能維持
- データの整合性保証
- パフォーマンスの維持

## 3. 非機能要件

### 3.1 セキュリティ要件
- Discord OAuth2の適切な実装
- トークンの安全な管理
- CSRF攻撃の防止
- セッションハイジャック対策

### 3.2 パフォーマンス要件
- 認証処理: 3秒以内
- URL生成: 1秒以内
- Discord API応答: 5秒以内

### 3.3 可用性要件
- システム稼働率: 99%以上
- Discord API障害時の代替手段提供

### 3.4 ユーザビリティ要件
- 直感的な操作フロー
- エラーメッセージの日本語対応
- モバイル端末対応

## 4. システム構成要件

### 4.1 技術スタック
- **フロントエンド**: 既存のHTML/JavaScript
- **バックエンド**: Supabase + Discord API
- **Discordボット**: Discord.js または discord.py
- **認証**: Discord OAuth2

### 4.2 外部サービス
- Discord Developer Portal
- Discord Bot Token
- OAuth2クライアント設定

### 4.3 データベース要件
- 既存Supabaseテーブルの拡張
- Discord連携情報の追加テーブル
- セッション管理テーブル

## 5. 運用要件

### 5.1 デプロイ要件
- GitHub Pages での静的ホスティング継続
- Discordボットの別途ホスティング（Heroku/Railway等）
- 環境変数による設定管理

### 5.2 監視要件
- Discord API利用状況の監視
- エラー率の監視
- ユーザー認証成功率の監視

### 5.3 メンテナンス要件
- Discord API仕様変更への対応
- 定期的なセキュリティ更新
- データバックアップ

## 6. 制約事項

### 6.1 技術的制約
- Discord APIレート制限の遵守
- OAuth2フローの制限
- 静的サイトホスティングの制約

### 6.2 運用制約
- Discord Developer利用規約の遵守
- 個人情報保護法の遵守
- FF14利用規約の遵守

## 7. リスク分析

### 7.1 技術的リスク
- Discord API仕様変更
- OAuth2セキュリティ脆弱性
- 第三者サービス依存

### 7.2 運用リスク
- Discord Bot Token漏洩
- ユーザーデータ漏洩
- サービス停止

## 8. 成功基準

### 8.1 機能的成功基準
- Discordボットからのチーム作成成功率: 95%以上
- 固有URL認証成功率: 98%以上
- 既存機能の互換性: 100%

### 8.2 非機能的成功基準
- 初回認証完了時間: 平均30秒以内
- ユーザー満足度: 調査実施
- システム稼働率: 99%以上

## 9. 今後の拡張可能性

### 9.1 短期拡張
- Discord通知機能（装備分配結果等）
- Discordロール連携
- 複数サーバー対応

### 9.2 長期拡張
- Discord Slash Commandsの活用
- Webhookによるリアルタイム連携
- AIボット機能の追加