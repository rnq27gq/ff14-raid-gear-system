<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://*.supabase.co https://supabase.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
    <title>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ  (Supabaseç‰ˆ)</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
        // Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª
        window.addEventListener('load', function() {
            console.log('Supabase library loaded:', typeof window.supabase !== 'undefined');
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase version:', window.supabase.createClient ? 'OK' : 'No createClient method');
            }
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        /* Supabaseèªè¨¼ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .supabase-header {
            background: linear-gradient(135deg, #16a085 0%, #27ae60 100%);
            color: white;
            padding: 10px 20px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .supabase-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .connection-indicator.online {
            background-color: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        
        .connection-indicator.offline {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-input {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .auth-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4a9d6b;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #3e8a57;
        }
        
        .auth-btn.logout {
            background-color: #d86a5a;
        }
        
        .auth-btn.logout:hover {
            background-color: #b85a4a;
        }
        
        /* èªè¨¼ç”»é¢ */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
        }
        
        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-card h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .auth-form button {
            padding: 12px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .auth-form button:hover {
            background-color: #219a52;
        }
        
        .demo-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .main-content {
            display: none;
        }
        
        .main-content.authenticated {
            display: block;
        }
        
        /* æ—¢å­˜ã®collaborative_index.htmlã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±åˆ */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .player-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        .position-badge {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .job-select {
            width: 100%;
            margin: 5px 0;
        }
        .equipment-policy {
            margin: 10px 0;
        }
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }
        .policy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .policy-item label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .policy-item select {
            width: 100%;
            padding: 6px;
            font-size: 0.8rem;
            margin: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* è£…å‚™æ–¹é‡ã®èƒŒæ™¯è‰² */
        .policy-item select option[value="é›¶å¼"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select option[value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        .policy-item select[value="é›¶å¼"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select[value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        
        /* ã‚¿ãƒ–é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-container {
            margin: 20px 0;
        }
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }
        .tab-content {
            min-height: 400px;
        }
        
        /* å±¤é¸æŠé–¢é€£ */
        .layer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .layer-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .layer-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .layer-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-align: center;
        }
        .layer-content {
            padding: 15px;
        }
        
        /* å„ªå…ˆåº¦è¨­å®šé–¢é€£ */
        .priority-container {
            max-width: 600px;
            margin: 20px auto;
        }
        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .priority-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s ease;
        }
        .priority-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .priority-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .priority-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .position-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .player-details {
            font-size: 0.9rem;
            color: #666;
        }
        .drag-handle {
            color: #999;
            font-size: 20px;
            cursor: move;
        }
        
        /* æ­¦å™¨å¸Œæœ›é–¢é€£ */
        .weapon-wishes {
            margin: 10px 0;
        }
        .wish-priority {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wish-priority label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #555;
        }
        .wish-priority select,
        .wish-priority input {
            flex: 1;
            min-width: 150px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tier-item.active {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .tier-item h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .tier-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .nav-button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background-color: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Supabaseèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="supabase-header">
            <div class="supabase-status">
                <h1 style="margin: 0; font-size: 18px;">FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ  (Supabaseç‰ˆ)</h1>
                <div id="connectionStatus" class="connection-indicator offline">
                    <span>âš«</span>
                    <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
                </div>
                <div id="teamInfo" style="display: none;">
                    <span id="currentTeamName">ãƒãƒ¼ãƒ å</span>
                </div>
            </div>
            
            <div class="auth-controls" id="authControls">
                <input type="text" id="teamIdInput" class="auth-input" placeholder="ãƒãƒ¼ãƒ ID" maxlength="20">
                <input type="password" id="passwordInput" class="auth-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" maxlength="20">
                <button class="auth-btn" onclick="authenticateTeam()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
            
            <div class="auth-controls" id="loggedInControls" style="display: none;">
                <span id="loggedInTeam">demo-team</span>
                <button class="auth-btn logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
        
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- èªè¨¼ç”»é¢ -->
        <div id="authScreen" class="auth-screen">
            <div class="auth-card">
                <h2>ğŸ›¡ï¸ ãƒãƒ¼ãƒ èªè¨¼</h2>
                <p>8äººã§ã®å…±åŒåˆ©ç”¨ã«ã¯<br>ãƒãƒ¼ãƒ IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
                
                <div class="auth-form">
                    <input type="text" id="mainTeamIdInput" placeholder="ãƒãƒ¼ãƒ ID (ä¾‹: my-raid-team)" maxlength="20">
                    <input type="password" id="mainPasswordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" maxlength="20">
                    <button onclick="authenticateTeam()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
                
                <div class="demo-info">
                    <strong>ğŸ® ãƒ‡ãƒ¢ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong><br>
                    ãƒãƒ¼ãƒ ID: <code>demo-team</code><br>
                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: <code>demo123</code>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p>æ–°ã—ã„ãƒãƒ¼ãƒ ã®ä½œæˆã‚’ã”å¸Œæœ›ã®å ´åˆã¯<br>ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„</p>
                </div>
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰ -->
        <div id="mainContent" class="main-content">
            <div id="content">
                <!-- åˆæœŸè¡¨ç¤ºã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            </div>
        </div>
    </div>

    <!-- Supabaseèªè¨¼æƒ…å ±ï¼ˆæœ¬ç•ªç”¨ï¼‰ -->
    <script>
        // GitHub Pagesç”¨ã®è¨­å®šï¼ˆæ©Ÿå¯†æƒ…å ±ã¯ç’°å¢ƒã«å¿œã˜ã¦æ›´æ–°ï¼‰
        window.SUPABASE_CONFIG = {
            SUPABASE_URL: 'https://bpzvuwhnjvbfohopeoxr.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwenZ1d2huanZiZm9ob3Blb3hyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NzE3MDMsImV4cCI6MjA2NTQ0NzcwM30.pYiMUoptXLpWyFAlUkCE973ipObCEQgOUyILEpodVC8',
            DEMO_TEAM_ID: 'demo-team',
            DEMO_PASSWORD: 'demo123'
        };
    </script>
    
    <!-- Supabaseè¨­å®šã¨ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ -->
    <script src="supabase_config.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let isAuthenticated = false;
        let currentTeamId = null;
        
        // åˆæœŸåŒ– - ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
        window.addEventListener('load', async function() {
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
            setTimeout(async () => {
                await initializeApp();
            }, 100);
        });
        
        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        async function initializeApp() {
            try {
                console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
                
                // Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèª
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                console.log('Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªå®Œäº†');
                
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆï¼ˆæ©Ÿå¯†æƒ…å ±ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰
                const supabaseUrl = window.SUPABASE_CONFIG?.SUPABASE_URL;
                const supabaseKey = window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Supabaseèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚config/supabase_credentials.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                
                window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆå®Œäº†');
                
                // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
                updateConnectionStatus(true);
                
                // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
                await tryAutoLogin();
                
                console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                updateConnectionStatus(false);
            }
        }
        
        // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
        async function tryAutoLogin() {
            const savedTeamId = localStorage.getItem('ff14_team_id');
            if (savedTeamId) {
                currentTeamId = savedTeamId;
                supabaseConfig.currentTeamId = savedTeamId;
                await showAuthenticatedState();
            }
        }
        
        // ãƒãƒ¼ãƒ èªè¨¼
        async function authenticateTeam() {
            const teamId = document.getElementById('teamIdInput')?.value || 
                          document.getElementById('mainTeamIdInput')?.value;
            const password = document.getElementById('passwordInput')?.value || 
                           document.getElementById('mainPasswordInput')?.value;
            
            if (!teamId || !password) {
                showError('ãƒãƒ¼ãƒ IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                showMessage('èªè¨¼ä¸­...', 'info');
                
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèª
                if (!window.supabaseClient) {
                    throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                console.log('èªè¨¼è©¦è¡Œ:', teamId);
                
                // Supabaseèªè¨¼
                const { data, error } = await window.supabaseClient.rpc('authenticate_team', {
                    p_team_id: teamId,
                    p_password: password
                });
                
                console.log('èªè¨¼çµæœ:', { data, error });
                
                if (error) {
                    throw new Error(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('ãƒãƒ¼ãƒ IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
                
                // èªè¨¼æˆåŠŸ
                currentTeamId = teamId;
                localStorage.setItem('ff14_team_id', teamId);
                
                // ãƒãƒ¼ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
                console.log('ãƒãƒ¼ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šä¸­...');
                const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                    team_id: teamId
                });
                
                if (contextError) {
                    console.error('ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼:', contextError);
                } else {
                    console.log('ãƒãƒ¼ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šå®Œäº†');
                }
                
                await showAuthenticatedState();
                showSuccess('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
                
                // ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®åˆæœŸåŒ–
                await initializeMainFeatures();
                
            } catch (error) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                showError('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // èªè¨¼å¾Œã®çŠ¶æ…‹è¡¨ç¤º
        async function showAuthenticatedState() {
            isAuthenticated = true;
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('authenticated');
            document.getElementById('authControls').style.display = 'none';
            document.getElementById('loggedInControls').style.display = 'flex';
            document.getElementById('loggedInTeam').textContent = currentTeamId;
            
            // ãƒãƒ¼ãƒ æƒ…å ±è¡¨ç¤º
            document.getElementById('teamInfo').style.display = 'block';
            document.getElementById('currentTeamName').textContent = `ãƒãƒ¼ãƒ : ${currentTeamId}`;
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            isAuthenticated = false;
            currentTeamId = null;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
            localStorage.removeItem('ff14_team_id');
            supabaseConfig.currentTeamId = null;
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('authenticated');
            document.getElementById('authControls').style.display = 'flex';
            document.getElementById('loggedInControls').style.display = 'none';
            document.getElementById('teamInfo').style.display = 'none';
            
            // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
            document.getElementById('teamIdInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('mainTeamIdInput').value = '';
            document.getElementById('mainPasswordInput').value = '';
            
            showSuccess('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testDatabaseConnection() {
            if (!isAuthenticated) {
                showError('å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...', 'info');
                
                // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèª
                if (!window.supabaseClient) {
                    throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ'
                };
                
                console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...');
                
                const { data: saveData, error: saveError } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: 'test-tier',
                        data_type: 'settings',
                        content: testData
                    });
                
                if (saveError) {
                    throw new Error(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError.message}`);
                }
                
                console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                const { data: loadData, error: loadError } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', 'test-tier')
                    .eq('data_type', 'settings');
                
                if (loadError) {
                    throw new Error(`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${loadError.message}`);
                }
                
                console.log('èª­ã¿è¾¼ã¿çµæœ:', loadData);
                
                if (loadData && loadData.length > 0) {
                    showSuccess('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚');
                } else {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                indicator.innerHTML = '<span>ğŸŸ¢</span><span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>';
            } else {
                indicator.className = 'connection-indicator offline';
                indicator.innerHTML = '<span>âš«</span><span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>';
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showMessage(message, type) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => successEl.style.display = 'none', 3000);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå‡¦ç†ã®ã‚¨ãƒ©ãƒ¼:', event.reason);
            showError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
        
        // ======================
        // ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…
        // ======================
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentRaidTier = null;
        let appData = {
            raidTiers: {},
            players: {},
            allocations: {},
            settings: {}
        };
        
        // ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–
        async function initializeMainFeatures() {
            try {
                console.log('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–é–‹å§‹');
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadAllData();
                
                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
                showMainDashboard();
                
                console.log('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å…¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAllData() {
            try {
                // Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const { data: allData, error } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId);
                
                if (error) {
                    throw new Error(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                console.log('èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿:', allData);
                
                // ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã”ã¨ã«åˆ†é¡
                if (allData && allData.length > 0) {
                    allData.forEach(item => {
                        const { tier_id, data_type, content } = item;
                        
                        if (data_type === 'settings') {
                            // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®ç‰¹æ®Šå‡¦ç†
                            if (content.raidTier) {
                                // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãƒ‡ãƒ¼ã‚¿
                                if (!appData.raidTiers) appData.raidTiers = {};
                                appData.raidTiers[tier_id] = content.raidTier;
                            } else {
                                // ãã®ä»–ã®è¨­å®š
                                if (!appData.settings) appData.settings = {};
                                appData.settings = { ...appData.settings, ...content };
                            }
                        } else {
                            // ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—
                            if (!appData[data_type]) {
                                appData[data_type] = {};
                            }
                            appData[data_type][tier_id] = content;
                        }
                    });
                }
                
                console.log('æ•´ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿:', appData);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // åˆæœŸãƒ‡ãƒ¼ã‚¿ã§ç¶™ç¶š
                appData = {
                    raidTiers: {},
                    players: {},
                    allocations: {},
                    settings: {}
                };
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
        function showMainDashboard() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>FF14 é›¶å¼è£…å‚™åˆ†é…ã‚·ã‚¹ãƒ†ãƒ </h1>
                <h2>ãƒãƒ¼ãƒ : ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>ğŸ® ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ</h3>
                    <div class="tier-list" id="tierList">
                        <!-- ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="createNewTier()">æ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’ä½œæˆ</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ğŸ”§ ç®¡ç†æ©Ÿèƒ½</h3>
                    <div class="navigation">
                        <button class="nav-button" onclick="showSystemSettings()">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</button>
                        <button class="nav-button" onclick="exportAllData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="nav-button" onclick="testDatabaseConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #e8f5e8; border-color: #27ae60;">
                    <h3>âœ… å®Ÿè£…å®Œäº†æ©Ÿèƒ½</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>âœ… Supabaseé€£æºãƒ»èªè¨¼ã‚·ã‚¹ãƒ†ãƒ </li>
                        <li>âœ… ãƒãƒ¼ãƒ åˆ¥ãƒ‡ãƒ¼ã‚¿ç®¡ç†</li>
                        <li>âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</li>
                        <li>ğŸ”„ ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ç®¡ç†ï¼ˆå®Ÿè£…ä¸­ï¼‰</li>
                        <li>ğŸ”„ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»è£…å‚™ç®¡ç†ï¼ˆå®Ÿè£…ä¸­ï¼‰</li>
                    </ul>
                </div>
            `;
            
            // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä¸€è¦§ã‚’è¡¨ç¤º
            displayRaidTiers();
        }
        
        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä¸€è¦§è¡¨ç¤º
        function displayRaidTiers() {
            const tierList = document.getElementById('tierList');
            const tiers = appData.raidTiers || {};
            
            if (Object.keys(tiers).length === 0) {
                tierList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>ã¾ã ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                        <p>ã€Œæ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
                return;
            }
            
            tierList.innerHTML = Object.entries(tiers).map(([tierId, tier]) => `
                <div class="tier-item ${currentRaidTier?.id === tierId ? 'active' : ''}" 
                     onclick="selectRaidTier('${tierId}')">
                    <h3>${tier.name}</h3>
                    <p>${tier.description || 'é›¶å¼ãƒ¬ã‚¤ãƒ‰'}</p>
                    <p style="font-size: 0.8rem; color: #888;">
                        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${Object.keys(appData.players[tierId] || {}).length}äºº
                    </p>
                </div>
            `).join('');
        }
        
        // ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢é¸æŠ
        async function selectRaidTier(tierId) {
            const tier = appData.raidTiers[tierId];
            if (!tier) {
                showError('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            currentRaidTier = { id: tierId, ...tier };
            showSuccess(`ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã€Œ${tier.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
            
            // ãƒ†ã‚£ã‚¢å›ºæœ‰ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            showTierDashboard();
        }
        
        // ãƒ†ã‚£ã‚¢å›ºæœ‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        function showTierDashboard() {
            if (!currentRaidTier) return;
            
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>${currentRaidTier.name}</h1>
                <h2>ãƒãƒ¼ãƒ : ${currentTeamId}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showMainDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                        <button class="nav-button" onclick="showPlayerManagement()">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
                        <button class="nav-button" onclick="showEquipmentAllocation()">è£…å‚™åˆ†é…</button>
                        <button class="nav-button" onclick="showStatistics()">çµ±è¨ˆæƒ…å ±</button>
                        <button class="nav-button" onclick="showAllocationHistory()">é…å¸ƒå±¥æ­´</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ğŸ“Š ãƒ†ã‚£ã‚¢æƒ…å ±</h3>
                    <p><strong>ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢:</strong> ${currentRaidTier.name}</p>
                    <p><strong>èª¬æ˜:</strong> ${currentRaidTier.description || 'é›¶å¼ãƒ¬ã‚¤ãƒ‰'}</p>
                    <p><strong>ç™»éŒ²ãƒ¡ãƒ³ãƒãƒ¼:</strong> ${Object.keys(appData.players[currentRaidTier.id] || {}).length}äºº</p>
                    <p><strong>é…å¸ƒå±¥æ­´:</strong> ${(appData.allocations[currentRaidTier.id] || []).length}ä»¶</p>
                </div>
                
                <div class="section">
                    <h3>ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
                    <p>ã¾ãšã¯ã€Œãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã€ã‹ã‚‰8äººã®ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
        }
        
        // æ–°ã—ã„ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ä½œæˆ
        async function createNewTier() {
            const name = prompt('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š7.1 ã‚¢ãƒ¼ã‚¯ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³é›¶å¼ï¼‰:');
            if (!name) return;
            
            const description = prompt('èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆçœç•¥å¯ï¼‰:') || 'é›¶å¼ãƒ¬ã‚¤ãƒ‰';
            
            try {
                const tierId = 'tier_' + Date.now();
                const tierData = {
                    name: name.trim(),
                    description: description.trim(),
                    createdAt: new Date().toISOString()
                };
                
                // Supabaseã«ä¿å­˜
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .insert({
                        team_id: currentTeamId,
                        tier_id: tierId,
                        data_type: 'settings',
                        content: { raidTier: tierData }
                    });
                
                if (error) {
                    throw new Error(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                if (!appData.raidTiers) appData.raidTiers = {};
                appData.raidTiers[tierId] = tierData;
                
                showSuccess(`ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                
                // è¡¨ç¤ºæ›´æ–°
                displayRaidTiers();
                
            } catch (error) {
                console.error('ãƒ†ã‚£ã‚¢ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ¬ã‚¤ãƒ‰ãƒ†ã‚£ã‚¢ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†æ©Ÿèƒ½
        function showPlayerManagement() {
            showPlayerSetup();
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šç”»é¢ï¼ˆã‚¿ãƒ–å½¢å¼ï¼‰
        function showPlayerSetup() {
            showTabbedSetup('players');
        }
        
        // ã‚¿ãƒ–å½¢å¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢
        function showTabbedSetup(activeTab = 'players') {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>ãƒ¡ãƒ³ãƒãƒ¼ãƒ»è£…å‚™è¨­å®š</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">ãƒ¬ã‚¤ãƒ‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button ${activeTab === 'players' ? 'active' : ''}" onclick="showTabbedSetup('players')">
                            ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±
                        </button>
                        <button class="tab-button ${activeTab === 'policy' ? 'active' : ''}" onclick="showTabbedSetup('policy')">
                            è£…å‚™æ–¹é‡
                        </button>
                        <button class="tab-button ${activeTab === 'weapons' ? 'active' : ''}" onclick="showTabbedSetup('weapons')">
                            æ­¦å™¨å¸Œæœ›
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        ${getTabContent(activeTab)}
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="saveCurrentTabAndContinue('${activeTab}')">
                            è¨­å®šå®Œäº†
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
        function getTabContent(tabName) {
            const players = appData.players[currentRaidTier.id] || {};
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (tabName === 'players') {
                return `
                    <h3>8äººã®ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position] || {};
                            const roleJobs = {
                                'MT': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                                'ST': ['ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼'],
                                'H1': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…'],
                                'H2': ['ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…'],
                                'D1': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                                'D2': ['ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼'],
                                'D3': ['é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼', 'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­'],
                                'D4': ['é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼', 'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­']
                            };
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="position-badge">${position}</span>
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆå¿…é ˆï¼‰:</label>
                                        <input type="text" id="${position}-name" value="${player.name || ''}" 
                                               placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›" style="width: 100%;">
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:</label>
                                        <input type="text" id="${position}-character" value="${player.characterName || ''}" 
                                               placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åï¼ˆçœç•¥å¯ï¼‰" style="width: 100%;">
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>ã‚¸ãƒ§ãƒ–ï¼ˆå¿…é ˆï¼‰:</label>
                                        <select id="${position}-job" class="job-select">
                                            <option value="">ã‚¸ãƒ§ãƒ–ã‚’é¸æŠ</option>
                                            ${roleJobs[position].map(job => `
                                                <option value="${job}" ${player.job === job ? 'selected' : ''}>${job}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'policy') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>ã¾ãšãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                }
                
                const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
                
                return `
                    <h3>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è£…å‚™æ–¹é‡ã‚’è¨­å®š</h3>
                    <p>é›¶å¼ï¼šé›¶å¼è£…å‚™ã‚’å„ªå…ˆå–å¾—ã€ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³ï¼šãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³è£…å‚™ã§ååˆ†</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="equipment-policy">
                                        <div class="policy-grid">
                                            ${slots.map(slot => `
                                                <div class="policy-item">
                                                    <label>${slot}</label>
                                                    <select id="${position}-${slot}-policy">
                                                        <option value="é›¶å¼" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'é›¶å¼') ? 'selected' : ''}>é›¶å¼</option>
                                                        <option value="ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³') ? 'selected' : ''}>ãƒˆãƒ¼ãƒ ã‚¹ãƒˆãƒ¼ãƒ³</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'weapons') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>ã¾ãšãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚¿ãƒ–ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    `;
                }
                
                const allWeapons = [
                    'ãƒŠã‚¤ãƒˆ', 'æˆ¦å£«', 'æš—é»’é¨å£«', 'ã‚¬ãƒ³ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼',
                    'ç™½é­”é“å£«', 'å æ˜Ÿè¡“å£«', 'å­¦è€…', 'è³¢è€…',
                    'ãƒ¢ãƒ³ã‚¯', 'ç«œé¨å£«', 'å¿è€…', 'ä¾', 'ãƒªãƒ¼ãƒ‘ãƒ¼', 'ãƒ´ã‚¡ã‚¤ãƒ‘ãƒ¼',
                    'é»’é­”é“å£«', 'å¬å–šå£«', 'èµ¤é­”é“å£«', 'ãƒ”ã‚¯ãƒˆãƒãƒ³ã‚µãƒ¼',
                    'åŸéŠè©©äºº', 'æ©Ÿå·¥å£«', 'è¸Šã‚Šå­'
                ];
                
                return `
                    <h3>4å±¤ç›´ãƒ‰ãƒ­ãƒƒãƒ—æ­¦å™¨ã®å¸Œæœ›é †ä½ã‚’è¨­å®š</h3>
                    <p>ç¬¬ä¸€å¸Œæœ›ã¯è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–ã«ãªã‚Šã¾ã™ã€‚ç¬¬äºŒã€œç¬¬å››å¸Œæœ›ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            const weaponWishes = player.weaponWishes || [];
                            const mainWeapon = player.job;
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="weapon-wishes">
                                        <div class="wish-priority">
                                            <label>ç¬¬ä¸€å¸Œæœ› (ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–):</label>
                                            <input type="text" value="${mainWeapon}" readonly style="background-color: #e9ecef;">
                                        </div>
                                        <div class="wish-priority">
                                            <label>ç¬¬äºŒå¸Œæœ›:</label>
                                            <select id="${position}-weapon-wish-2">
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[1] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>ç¬¬ä¸‰å¸Œæœ›:</label>
                                            <select id="${position}-weapon-wish-3">
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[2] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>ç¬¬å››å¸Œæœ›:</label>
                                            <select id="${position}-weapon-wish-4">
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[3] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }
        
        // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ä¿å­˜ã—ã¦æ¬¡ã¸é€²ã‚€
        async function saveCurrentTabAndContinue(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                }
                
                showSuccess('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                
                // å…¨ã¦è¨­å®šæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
                if (Object.keys(appData.players[currentRaidTier.id] || {}).length > 0) {
                    showTierDashboard();
                } else {
                    showError('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                }
            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showError('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ä¿å­˜
        async function savePlayersData() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (!appData.players[currentRaidTier.id]) {
                appData.players[currentRaidTier.id] = {};
            }
            
            for (const position of positions) {
                const nameInput = document.getElementById(`${position}-name`);
                const characterInput = document.getElementById(`${position}-character`);
                const jobSelect = document.getElementById(`${position}-job`);
                
                if (!nameInput || !jobSelect) continue;
                
                const name = nameInput.value.trim();
                const characterName = characterInput.value.trim();
                const job = jobSelect.value;
                
                if (!name || !job) {
                    throw new Error(`${position}ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨ã‚¸ãƒ§ãƒ–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                }
                
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¿æŒ
                const existingPlayer = appData.players[currentRaidTier.id][position] || {};
                
                appData.players[currentRaidTier.id][position] = {
                    name: name,
                    characterName: characterName,
                    job: job,
                    position: position,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    weaponWishes: existingPlayer.weaponWishes || [],
                    currentEquipment: existingPlayer.currentEquipment || {},
                    dynamicPriority: existingPlayer.dynamicPriority || 0,
                    allocationHistory: existingPlayer.allocationHistory || []
                };
            }
            
            // Supabaseã«ä¿å­˜
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // è£…å‚™æ–¹é‡ä¿å­˜
        async function saveEquipmentPolicyData() {
            const players = appData.players[currentRaidTier.id];
            const slots = ['æ­¦å™¨', 'é ­', 'èƒ´', 'æ‰‹', 'è„š', 'è¶³', 'è€³', 'é¦–', 'è…•', 'æŒ‡'];
            
            for (const [position, player] of Object.entries(players)) {
                for (const slot of slots) {
                    const policyElement = document.getElementById(`${position}-${slot}-policy`);
                    if (policyElement) {
                        const policy = policyElement.value;
                        player.equipmentPolicy[slot] = policy;
                    }
                }
            }
            
            // Supabaseã«ä¿å­˜
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // æ­¦å™¨å¸Œæœ›ä¿å­˜
        async function saveWeaponWishesData() {
            const players = appData.players[currentRaidTier.id];
            
            for (const [position, player] of Object.entries(players)) {
                const mainJob = player.job;
                const wish2Element = document.getElementById(`${position}-weapon-wish-2`);
                const wish3Element = document.getElementById(`${position}-weapon-wish-3`);
                const wish4Element = document.getElementById(`${position}-weapon-wish-4`);
                
                // ç¬¬ä¸€å¸Œæœ›ã¯ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–ã€ç¬¬äºŒã€œç¬¬å››å¸Œæœ›ã¯é¸æŠã•ã‚ŒãŸå€¤
                player.weaponWishes = [
                    mainJob,
                    wish2Element ? wish2Element.value : '',
                    wish3Element ? wish3Element.value : '',
                    wish4Element ? wish4Element.value : ''
                ].filter(wish => wish !== ''); // ç©ºã®å€¤ã‚’é™¤å¤–
            }
            
            // Supabaseã«ä¿å­˜
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Supabaseãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ˜ãƒ«ãƒ‘ãƒ¼
        async function saveDataToSupabase(dataType, content) {
            const { error } = await window.supabaseClient
                .from('raid_data')
                .upsert({
                    team_id: currentTeamId,
                    tier_id: currentRaidTier.id,
                    data_type: dataType,
                    content: content
                });
                
            if (error) {
                throw new Error(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        function showEquipmentAllocation() {
            showMessage('è£…å‚™åˆ†é…æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™', 'info');
        }
        
        function showStatistics() {
            showMessage('çµ±è¨ˆæƒ…å ±æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™', 'info');
        }
        
        function showAllocationHistory() {
            showMessage('é…å¸ƒå±¥æ­´æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™', 'info');
        }
        
        function showSystemSettings() {
            showMessage('ã‚·ã‚¹ãƒ†ãƒ è¨­å®šæ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™', 'info');
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ff14_raid_data_${currentTeamId}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSuccess('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }
    </script>
</body>
</html>