<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://*.supabase.co https://supabase.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
    <title>FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É† (SupabaseÁâà)</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
        // Supabase„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç
        window.addEventListener('load', function() {
            console.log('Supabase library loaded:', typeof window.supabase !== 'undefined');
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase version:', window.supabase.createClient ? 'OK' : 'No createClient method');
            }
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        /* SupabaseË™çË®ºÁî®„ÅÆ„Éò„ÉÉ„ÉÄ„Éº */
        .supabase-header {
            background: linear-gradient(135deg, #16a085 0%, #27ae60 100%);
            color: white;
            padding: 10px 20px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁî®„Çπ„Çø„Ç§„É´ */
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px;
            min-width: 120px;
        }
        
        .dashboard-layer-button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .supabase-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .connection-indicator.online {
            background-color: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        
        .connection-indicator.offline {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-input {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .auth-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4a9d6b;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #3e8a57;
        }
        
        .auth-btn.logout {
            background-color: #d86a5a;
        }
        
        .auth-btn.logout:hover {
            background-color: #b85a4a;
        }
        
        /* Ë™çË®ºÁîªÈù¢ */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
        }
        
        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-card h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .auth-form button {
            padding: 12px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .auth-form button:hover {
            background-color: #219a52;
        }
        
        .demo-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }
        
        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .main-content {
            display: none;
        }
        
        .main-content.authenticated {
            display: block;
        }
        
        /* Êó¢Â≠ò„ÅÆcollaborative_index.html„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÁµ±Âêà */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .player-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        .position-badge {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .job-select {
            width: 100%;
            margin: 5px 0;
        }
        .equipment-policy {
            margin: 10px 0;
        }
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }
        .policy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .policy-item label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .policy-item select {
            width: 100%;
            padding: 6px;
            font-size: 0.8rem;
            margin: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* Ë£ÖÂÇôÊñπÈáù„ÅÆËÉåÊôØËâ≤ */
        .policy-item select option[value="Èõ∂Âºè"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select option[value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        .policy-item select[value="Èõ∂Âºè"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select[value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        
        /* „Çø„ÉñÈñ¢ÈÄ£„Çπ„Çø„Ç§„É´ */
        .tab-container {
            margin: 20px 0;
        }
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }
        .tab-content {
            min-height: 400px;
        }
        
        /* Â±§ÈÅ∏ÊäûÈñ¢ÈÄ£ */
        .layer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .layer-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .layer-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .layer-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-align: center;
        }
        .layer-content {
            padding: 15px;
        }
        
        /* ÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆöÈñ¢ÈÄ£ */
        .priority-container {
            max-width: 600px;
            margin: 20px auto;
        }
        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .priority-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s ease;
        }
        .priority-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .priority-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .priority-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .position-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .player-details {
            font-size: 0.9rem;
            color: #666;
        }
        .drag-handle {
            color: #999;
            font-size: 20px;
            cursor: move;
        }
        
        /* Ê≠¶Âô®Â∏åÊúõÈñ¢ÈÄ£ */
        .weapon-wishes {
            margin: 10px 0;
        }
        .wish-priority {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wish-priority label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #555;
        }
        .wish-priority select,
        .wish-priority input {
            flex: 1;
            min-width: 150px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tier-item.active {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .tier-item h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .tier-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .dashboard-layer-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }
        .nav-button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ */
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background-color: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        /* „Éá„Éº„ÇøÁßªË°åÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .migration-section {
            transition: all 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .migration-section:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .file-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-input-container input[type="file"] {
            transition: border-color 0.3s ease;
        }
        
        .file-input-container input[type="file"]:hover {
            border-color: #2980b9;
        }
        
        .csv-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }
        
        .csv-input-section {
            display: flex;
            flex-direction: column;
        }
        
        .csv-help-section {
            min-width: 200px;
        }
        
        .reset-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .reset-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .reset-warning {
            background-color: #fee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }
        
        .hints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .hint-card {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.2s ease;
        }
        
        .hint-card:hover {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        /* Ë£ÖÂÇôÂàÜÈÖçÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .layer-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .layer-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        .layer-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .layer-stats {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .allocation-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .allocation-choice {
            margin: 15px 0;
        }
        
        .allocation-choice select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .candidates-detail {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .candidate-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .no-candidates {
            color: #666;
            font-style: italic;
        }
        
        .weapon-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .weapon-selection h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .weapon-selection select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        .predicted-winner {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .judgment-details {
            margin-top: 15px;
        }
        
        .judgment-toggle {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .judgment-toggle:hover {
            background: #e9ecef;
        }
        
        .judgment-content {
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .need-section, .greed-section, .pass-section {
            margin: 10px 0;
        }
        
        .need-section h6 {
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .greed-section h6 {
            color: #f39c12;
            margin-bottom: 8px;
        }
        
        .pass-section h6 {
            color: #95a5a6;
            margin-bottom: 8px;
        }
        
        .candidate-item.need {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.greed {
            background: #fef9e7;
            border-left: 4px solid #f39c12;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.pass {
            background: #f8f9fa;
            border-left: 4px solid #95a5a6;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            color: #666;
        }
        
        .allocation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .confirm-btn {
            background: #27ae60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .confirm-btn:hover {
            background: #2ecc71;
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        /* Áµ±Ë®àÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .stat-details {
            margin-top: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slot-stats, .week-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .slot-stat-item, .week-stat-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .slot-name, .week-number {
            width: 100px;
            font-weight: 600;
        }
        
        .slot-count, .week-count {
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        
        .slot-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .slot-progress {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3498db;
            margin-top: 10px;
        }
        
        /* Â±•Ê≠¥Èñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-group select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .clear-filters-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .clear-filters-btn:hover {
            background: #c0392b;
        }
        
        .history-table {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .history-header {
            background: #3498db;
            color: white;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
        }
        
        .history-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-row:hover {
            background: #e8f4fd;
        }
        
        .history-cell {
            padding: 10px;
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        @media (max-width: 768px) {
            .csv-container {
                grid-template-columns: 1fr;
            }
            
            .reset-buttons-container {
                grid-template-columns: 1fr;
            }
            
            .file-input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .layer-grid {
                grid-template-columns: 1fr;
            }
            
            .allocation-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .history-header, .history-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .history-cell {
                border-bottom: 1px solid #e9ecef;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SupabaseË™çË®º„Éò„ÉÉ„ÉÄ„Éº -->
        <div class="supabase-header">
            <div class="supabase-status">
                <h1 style="margin: 0; font-size: 18px;">FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É† (SupabaseÁâà)</h1>
                <div id="connectionStatus" class="connection-indicator offline">
                    <span>‚ö´</span>
                    <span>„Ç™„Éï„É©„Ç§„É≥</span>
                </div>
                <div id="teamInfo" style="display: none;">
                    <span id="currentTeamName">„ÉÅ„Éº„É†Âêç</span>
                </div>
            </div>
            
            <div class="auth-controls" id="authControls">
                <input type="text" id="teamIdInput" class="auth-input" placeholder="„ÉÅ„Éº„É†ID" maxlength="20">
                <input type="password" id="passwordInput" class="auth-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="20">
                <button class="auth-btn" onclick="authenticateTeam()">„É≠„Ç∞„Ç§„É≥</button>
            </div>
            
            <div class="auth-controls" id="loggedInControls" style="display: none;">
                <span id="loggedInTeam">demo-team</span>
                <button class="auth-btn logout" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
        </div>
        
        <!-- „Ç®„É©„Éº„ÉªÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- Ë™çË®ºÁîªÈù¢ -->
        <div id="authScreen" class="auth-screen">
            <div class="auth-card">
                <h2>üõ°Ô∏è „ÉÅ„Éº„É†Ë™çË®º</h2>
                <p>8‰∫∫„Åß„ÅÆÂÖ±ÂêåÂà©Áî®„Å´„ÅØ<br>„ÉÅ„Éº„É†ID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô</p>
                
                <div class="auth-form">
                    <input type="text" id="mainTeamIdInput" placeholder="„ÉÅ„Éº„É†ID (‰æã: my-raid-team)" maxlength="20">
                    <input type="password" id="mainPasswordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="20">
                    <button onclick="authenticateTeam()">„É≠„Ç∞„Ç§„É≥</button>
                </div>
                
                <div class="demo-info">
                    <strong>üéÆ „Éá„É¢Áî®„Ç¢„Ç´„Ç¶„É≥„Éà</strong><br>
                    „ÉÅ„Éº„É†ID: <code>demo-team</code><br>
                    „Éë„Çπ„ÉØ„Éº„Éâ: <code>demo123</code>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p>Êñ∞„Åó„ÅÑ„ÉÅ„Éº„É†„ÅÆ‰ΩúÊàê„Çí„ÅîÂ∏åÊúõ„ÅÆÂ†¥Âêà„ÅØ<br>ÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ</p>
                </div>
            </div>
        </div>
        
        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàË™çË®ºÂæå„Å´Ë°®Á§∫Ôºâ -->
        <div id="mainContent" class="main-content">
            <div id="content">
                <!-- ÂàùÊúüË°®Á§∫„ÅØ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
            </div>
        </div>
    </div>

    <!-- SupabaseË™çË®ºÊÉÖÂ†±ÔºàGitHub SecretsÁµåÁî±„ÅßÊ≥®ÂÖ•Ôºâ -->
    <script>
        // GitHub Actions„Å´„Çà„Å£„Å¶„Éá„Éó„É≠„Ç§ÊôÇ„Å´Ë™çË®ºÊÉÖÂ†±„ÅåÊ≥®ÂÖ•„Åï„Çå„Åæ„Åô
        window.SUPABASE_CONFIG = {
            SUPABASE_URL: 'https://bpzvuwhnjvbfohopeoxr.supabase.co',
            SUPABASE_ANON_KEY: null, // GitHub Actions„ÅßÁΩÆÊèõ„Åï„Çå„Çã
            DEMO_TEAM_ID: 'demo-team',
            DEMO_PASSWORD: 'demo123'
        };
    </script>
    
    <!-- SupabaseË®≠ÂÆö„Å®„É°„Ç§„É≥Ê©üËÉΩ -->
    <script src="supabase_config.js"></script>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let isAuthenticated = false;
        let currentTeamId = null;
        
        // ÂàùÊúüÂåñ - „É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
        window.addEventListener('load', async function() {
            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Ç¢„Éó„É™ÂàùÊúüÂåñ
            setTimeout(async () => {
                await initializeApp();
            }, 100);
        });
        
        // „Ç¢„Éó„É™ÂàùÊúüÂåñ
        async function initializeApp() {
            try {
                console.log('„Ç¢„Éó„É™ÂàùÊúüÂåñÈñãÂßã');
                
                // Supabase„É©„Ç§„Éñ„É©„É™„ÅÆÁ¢∫Ë™ç
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase JavaScript„É©„Ç§„Éñ„É©„É™„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                console.log('Supabase„É©„Ç§„Éñ„É©„É™Á¢∫Ë™çÂÆå‰∫Ü');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà‰ΩúÊàêÔºàÊ©üÂØÜÊÉÖÂ†±„ÅØÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâÔºâ
                const supabaseUrl = window.SUPABASE_CONFIG?.SUPABASE_URL;
                const supabaseKey = window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('SupabaseË™çË®ºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇGitHub Secrets„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
                
                window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                console.log('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà‰ΩúÊàêÂÆå‰∫Ü');
                
                // Êé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞
                updateConnectionStatus(true);
                
                // Ëá™Âãï„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å
                await tryAutoLogin();
                
                console.log('„Ç¢„Éó„É™ÂàùÊúüÂåñÂÆå‰∫Ü');
                
            } catch (error) {
                console.error('„Ç¢„Éó„É™ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                showError('„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                updateConnectionStatus(false);
            }
        }
        
        // Ëá™Âãï„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å
        async function tryAutoLogin() {
            const savedTeamId = localStorage.getItem('ff14_team_id');
            if (savedTeamId) {
                currentTeamId = savedTeamId;
                supabaseConfig.currentTeamId = savedTeamId;
                await showAuthenticatedState();
            }
        }
        
        // „ÉÅ„Éº„É†Ë™çË®º
        async function authenticateTeam() {
            const teamId = document.getElementById('teamIdInput')?.value || 
                          document.getElementById('mainTeamIdInput')?.value;
            const password = document.getElementById('passwordInput')?.value || 
                           document.getElementById('mainPasswordInput')?.value;
            
            if (!teamId || !password) {
                showError('„ÉÅ„Éº„É†ID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                showMessage('Ë™çË®º‰∏≠...', 'info');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÁ¢∫Ë™ç
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                console.log('Ë™çË®ºË©¶Ë°å:', teamId);
                
                // SupabaseË™çË®º
                const { data, error } = await window.supabaseClient.rpc('authenticate_team', {
                    p_team_id: teamId,
                    p_password: password
                });
                
                console.log('Ë™çË®ºÁµêÊûú:', { data, error });
                
                if (error) {
                    throw new Error(`Ë™çË®º„Ç®„É©„Éº: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('„ÉÅ„Éº„É†ID„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                // Ë™çË®ºÊàêÂäü
                currentTeamId = teamId;
                localStorage.setItem('ff14_team_id', teamId);
                
                // „ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö
                console.log('„ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö‰∏≠...');
                const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                    team_id: teamId
                });
                
                if (contextError) {
                    console.error('„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö„Ç®„É©„Éº:', contextError);
                } else {
                    console.log('„ÉÅ„Éº„É†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆöÂÆå‰∫Ü');
                }
                
                await showAuthenticatedState();
                showSuccess('„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü');
                
                // „É°„Ç§„É≥Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
                await initializeMainFeatures();
                
            } catch (error) {
                console.error('Ë™çË®º„Ç®„É©„Éº:', error);
                showError('Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Ë™çË®ºÂæå„ÅÆÁä∂ÊÖãË°®Á§∫
        async function showAuthenticatedState() {
            isAuthenticated = true;
            
            // UIÂàá„ÇäÊõø„Åà
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('authenticated');
            document.getElementById('authControls').style.display = 'none';
            document.getElementById('loggedInControls').style.display = 'flex';
            document.getElementById('loggedInTeam').textContent = currentTeamId;
            
            // „ÉÅ„Éº„É†ÊÉÖÂ†±Ë°®Á§∫
            document.getElementById('teamInfo').style.display = 'block';
            document.getElementById('currentTeamName').textContent = `„ÉÅ„Éº„É†: ${currentTeamId}`;
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        function logout() {
            isAuthenticated = false;
            currentTeamId = null;
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇØ„É™„Ç¢
            localStorage.removeItem('ff14_team_id');
            supabaseConfig.currentTeamId = null;
            
            // UIÂàá„ÇäÊõø„Åà
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('authenticated');
            document.getElementById('authControls').style.display = 'flex';
            document.getElementById('loggedInControls').style.display = 'none';
            document.getElementById('teamInfo').style.display = 'none';
            
            // ÂÖ•ÂäõÊ¨Ñ„ÇØ„É™„Ç¢
            document.getElementById('teamIdInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('mainTeamIdInput').value = '';
            document.getElementById('mainPasswordInput').value = '';
            
            showSuccess('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
        }
        
        // „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÉÜ„Çπ„Éà
        async function testDatabaseConnection() {
            if (!isAuthenticated) {
                showError('ÂÖà„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                showMessage('„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Êé•Á∂ö‰∏≠...', 'info');
                
                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÁ¢∫Ë™ç
                if (!window.supabaseClient) {
                    throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
                
                // „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: '„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü'
                };
                
                console.log('„ÉÜ„Çπ„Éà„Éá„Éº„Çø‰øùÂ≠ò‰∏≠...');
                
                const { data: saveData, error: saveError } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: 'test-tier',
                        data_type: 'settings',
                        content: testData
                    });
                
                if (saveError) {
                    throw new Error(`‰øùÂ≠ò„Ç®„É©„Éº: ${saveError.message}`);
                }
                
                console.log('„ÉÜ„Çπ„Éà„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...');
                
                // „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
                const { data: loadData, error: loadError } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', 'test-tier')
                    .eq('data_type', 'settings');
                
                if (loadError) {
                    throw new Error(`Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${loadError.message}`);
                }
                
                console.log('Ë™≠„ÅøËæº„ÅøÁµêÊûú:', loadData);
                
                if (loadData && loadData.length > 0) {
                    showSuccess('„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅ„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                } else {
                    throw new Error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
            } catch (error) {
                console.error('„Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
                showError('„Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Êé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                indicator.innerHTML = '<span>üü¢</span><span>„Ç™„É≥„É©„Ç§„É≥</span>';
            } else {
                indicator.className = 'connection-indicator offline';
                indicator.innerHTML = '<span>‚ö´</span><span>„Ç™„Éï„É©„Ç§„É≥</span>';
            }
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showMessage(message, type) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // ÂÖ®„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈö†„Åô
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => successEl.style.display = 'none', 3000);
            }
        }
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Êú™Âá¶ÁêÜ„ÅÆ„Ç®„É©„Éº:', event.reason);
            showError('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        });
        
        // ======================
        // „É°„Ç§„É≥Ê©üËÉΩ„ÅÆÂÆüË£Ö
        // ======================
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentRaidTier = null;
        let appData = {
            raidTiers: {},
            players: {},
            allocations: {},
            settings: {}
        };
        
        // „É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñ
        async function initializeMainFeatures() {
            try {
                console.log('„É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñÈñãÂßã');
                
                // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                await loadAllData();
                
                // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâË°®Á§∫
                showMainDashboard();
                
                console.log('„É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('„É°„Ç§„É≥Ê©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                showError('„É°„Ç§„É≥Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÂÖ®„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadAllData() {
            try {
                // Supabase„Åã„Çâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                const { data: allData, error } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId);
                
                if (error) {
                    throw new Error(`„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`);
                }
                
                console.log('Ë™≠„ÅøËæº„Åø„Éá„Éº„Çø:', allData);
                
                // „Éá„Éº„ÇøÁ®ÆÂà•„Åî„Å®„Å´ÂàÜÈ°û
                if (allData && allData.length > 0) {
                    allData.forEach(item => {
                        const { tier_id, data_type, content } = item;
                        
                        if (data_type === 'settings') {
                            // Ë®≠ÂÆö„Éá„Éº„Çø„ÅÆÁâπÊÆäÂá¶ÁêÜ
                            if (content.raidTier) {
                                // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Éá„Éº„Çø
                                if (!appData.raidTiers) appData.raidTiers = {};
                                appData.raidTiers[tier_id] = content.raidTier;
                            } else {
                                // „Åù„ÅÆ‰ªñ„ÅÆË®≠ÂÆö
                                if (!appData.settings) appData.settings = {};
                                appData.settings = { ...appData.settings, ...content };
                            }
                        } else {
                            // „Åù„ÅÆ‰ªñ„ÅÆ„Éá„Éº„Çø„Çø„Ç§„Éó
                            if (!appData[data_type]) {
                                appData[data_type] = {};
                            }
                            appData[data_type][tier_id] = content;
                        }
                    });
                }
                
                console.log('Êï¥ÁêÜÊ∏à„Åø„Éá„Éº„Çø:', appData);
                
            } catch (error) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                // ÂàùÊúü„Éá„Éº„Çø„ÅßÁ∂ôÁ∂ö
                appData = {
                    raidTiers: {},
                    players: {},
                    allocations: {},
                    settings: {}
                };
            }
        }
        
        // „É°„Ç§„É≥„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâË°®Á§∫
        function showMainDashboard() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>FF14 Èõ∂ÂºèË£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†</h1>
                <h2>„ÉÅ„Éº„É†: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû</h3>
                    <div class="tier-list" id="tierList">
                        <!-- „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="createNewTier()">Êñ∞„Åó„ÅÑ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Çí‰ΩúÊàê</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ÁÆ°ÁêÜÊ©üËÉΩ</h3>
                    <div class="navigation">
                        <button class="nav-button" onclick="showSystemSettings()">„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö</button>
                        <button class="nav-button" onclick="exportAllData()">„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        <button class="nav-button" onclick="testDatabaseConnection()">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #e8f5e8; border-color: #27ae60;">
                    <h3>ÂÆüË£ÖÂÆå‰∫ÜÊ©üËÉΩ</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>SupabaseÈÄ£Êê∫„ÉªË™çË®º„Ç∑„Çπ„ÉÜ„É†</li>
                        <li>„ÉÅ„Éº„É†Âà•„Éá„Éº„ÇøÁÆ°ÁêÜ</li>
                        <li>„É™„Ç¢„É´„Çø„Ç§„É†„Éá„Éº„ÇøÂêåÊúü</li>
                        <li>„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÁÆ°ÁêÜ</li>
                        <li>„Éó„É¨„Ç§„É§„Éº„ÉªË£ÖÂÇôÁÆ°ÁêÜ</li>
                    </ul>
                </div>
            `;
            
            // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰∏ÄË¶ß„ÇíË°®Á§∫
            displayRaidTiers();
        }
        
        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰∏ÄË¶ßË°®Á§∫
        function displayRaidTiers() {
            const tierList = document.getElementById('tierList');
            const tiers = appData.raidTiers || {};
            
            if (Object.keys(tiers).length === 0) {
                tierList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>„Åæ„Å†„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
                        <p>„ÄåÊñ∞„Åó„ÅÑ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Çí‰ΩúÊàê„Äç„Éú„Çø„É≥„Åã„ÇâÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    </div>
                `;
                return;
            }
            
            tierList.innerHTML = Object.entries(tiers).map(([tierId, tier]) => `
                <div class="tier-item ${currentRaidTier?.id === tierId ? 'active' : ''}" 
                     onclick="selectRaidTier('${tierId}')">
                    <h3>${tier.name}</h3>
                    <p>${tier.description || 'Èõ∂Âºè„É¨„Ç§„Éâ'}</p>
                    <p style="font-size: 0.8rem; color: #888;">
                        „Éó„É¨„Ç§„É§„Éº: ${Object.keys(appData.players[tierId] || {}).length}‰∫∫
                    </p>
                </div>
            `).join('');
        }
        
        // „É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû
        async function selectRaidTier(tierId) {
            const tier = appData.raidTiers[tierId];
            if (!tier) {
                showError('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            currentRaidTier = { id: tierId, ...tier };
            showSuccess(`„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Äå${tier.name}„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`);
            
            // „ÉÜ„Ç£„Ç¢Âõ∫Êúâ„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíË°®Á§∫
            showTierDashboard();
        }
        
        // „ÉÜ„Ç£„Ç¢Âõ∫Êúâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        function showTierDashboard() {
            if (!currentRaidTier) return;
            
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showMainDashboard()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                </div>
                
                <h1>${currentRaidTier.name}</h1>
                <h2>„ÉÅ„Éº„É†: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>Ë£ÖÂÇôÂàÜÈÖç</h3>
                    <div class="dashboard-layer-grid">
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(1)">1Â±§</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(2)">2Â±§</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(3)">3Â±§</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(4)">4Â±§</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showPlayerManagement()">„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</button>
                        <button class="nav-button" onclick="showStatistics()">Áµ±Ë®àÊÉÖÂ†±</button>
                        <button class="nav-button" onclick="showAllocationHistory()">ÈÖçÂ∏ÉÂ±•Ê≠¥</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>„ÉÜ„Ç£„Ç¢ÊÉÖÂ†±</h3>
                    <p><strong>„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢:</strong> ${currentRaidTier.name}</p>
                    <p><strong>Ë™¨Êòé:</strong> ${currentRaidTier.description || 'Èõ∂Âºè„É¨„Ç§„Éâ'}</p>
                    <p><strong>ÁôªÈå≤„É°„É≥„Éê„Éº:</strong> ${Object.keys(appData.players[currentRaidTier.id] || {}).length}‰∫∫</p>
                    <p><strong>ÈÖçÂ∏ÉÂ±•Ê≠¥:</strong> ${(appData.allocations[currentRaidTier.id] || []).length}‰ª∂</p>
                </div>
            `;
        }
        
        // Êñ∞„Åó„ÅÑ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢‰ΩúÊàê
        async function createNewTier() {
            const name = prompt('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æãÔºö7.1 „Ç¢„Éº„ÇØ„Ç¨„Éº„Éá„Ç£„Ç¢„É≥Èõ∂ÂºèÔºâ:');
            if (!name) return;
            
            const description = prompt('Ë™¨Êòé„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁúÅÁï•ÂèØÔºâ:') || 'Èõ∂Âºè„É¨„Ç§„Éâ';
            
            try {
                const tierId = 'tier_' + Date.now();
                const tierData = {
                    name: name.trim(),
                    description: description.trim(),
                    createdAt: new Date().toISOString()
                };
                
                // Supabase„Å´‰øùÂ≠ò
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .insert({
                        team_id: currentTeamId,
                        tier_id: tierId,
                        data_type: 'settings',
                        content: { raidTier: tierData }
                    });
                
                if (error) {
                    throw new Error(`‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
                }
                
                // „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÊõ¥Êñ∞
                if (!appData.raidTiers) appData.raidTiers = {};
                appData.raidTiers[tierId] = tierData;
                
                showSuccess(`„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Äå${name}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`);
                
                // Ë°®Á§∫Êõ¥Êñ∞
                displayRaidTiers();
                
            } catch (error) {
                console.error('„ÉÜ„Ç£„Ç¢‰ΩúÊàê„Ç®„É©„Éº:', error);
                showError('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÁÆ°ÁêÜÊ©üËÉΩ
        function showPlayerManagement() {
            showPlayerSetup();
        }
        
        // „Éó„É¨„Ç§„É§„ÉºË®≠ÂÆöÁîªÈù¢Ôºà„Çø„ÉñÂΩ¢ÂºèÔºâ
        function showPlayerSetup() {
            showTabbedSetup('players');
        }
        
        // „Çø„ÉñÂΩ¢Âºè„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢
        function showTabbedSetup(activeTab = 'players') {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>„É°„É≥„Éê„Éº„ÉªË£ÖÂÇôË®≠ÂÆö</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button ${activeTab === 'players' ? 'active' : ''}" onclick="showTabbedSetup('players')">
                            „É°„É≥„Éê„ÉºÊÉÖÂ†±
                        </button>
                        <button class="tab-button ${activeTab === 'policy' ? 'active' : ''}" onclick="showTabbedSetup('policy')">
                            Ë£ÖÂÇôÊñπÈáù
                        </button>
                        <button class="tab-button ${activeTab === 'weapons' ? 'active' : ''}" onclick="showTabbedSetup('weapons')">
                            Ê≠¶Âô®Â∏åÊúõ
                        </button>
                        <button class="tab-button ${activeTab === 'migration' ? 'active' : ''}" onclick="showTabbedSetup('migration')">
                            „Éá„Éº„ÇøÁßªË°å
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        ${getTabContent(activeTab)}
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="saveCurrentTabAndContinue('${activeTab}')">
                            Ë®≠ÂÆöÂÆå‰∫Ü
                        </button>
                    </div>
                </div>
            `;
        }
        
        // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁîüÊàê
        function getTabContent(tabName) {
            const players = appData.players[currentRaidTier.id] || {};
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (tabName === 'players') {
                return `
                    <h3>8‰∫∫„ÅÆ„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position] || {};
                            const roleJobs = {
                                'MT': ['„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº'],
                                'ST': ['„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº'],
                                'H1': ['ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ£´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ'],
                                'H2': ['ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ£´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ'],
                                'D1': ['„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº'],
                                'D2': ['„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº'],
                                'D3': ['ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº', 'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê'],
                                'D4': ['ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº', 'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê']
                            };
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="position-badge">${position}</span>
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>„Éó„É¨„Ç§„É§„ÉºÂêçÔºàÂøÖÈ†àÔºâ:</label>
                                        <input type="text" id="${position}-name" value="${player.name || ''}" 
                                               placeholder="„Éó„É¨„Ç§„É§„ÉºÂêç„ÇíÂÖ•Âäõ" style="width: 100%;">
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç:</label>
                                        <input type="text" id="${position}-character" value="${player.characterName || ''}" 
                                               placeholder="„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêçÔºàÁúÅÁï•ÂèØÔºâ" style="width: 100%;">
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>„Ç∏„Éß„ÉñÔºàÂøÖÈ†àÔºâ:</label>
                                        <select id="${position}-job" class="job-select">
                                            <option value="">„Ç∏„Éß„Éñ„ÇíÈÅ∏Êäû</option>
                                            ${roleJobs[position].map(job => `
                                                <option value="${job}" ${player.job === job ? 'selected' : ''}>${job}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'policy') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>„Åæ„Åö„É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Åß„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        </div>
                    `;
                }
                
                const slots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
                
                return `
                    <h3>ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆË£ÖÂÇôÊñπÈáù„ÇíË®≠ÂÆö</h3>
                    <p>Èõ∂ÂºèÔºöÈõ∂ÂºèË£ÖÂÇô„ÇíÂÑ™ÂÖàÂèñÂæó„ÄÅ„Éà„Éº„É†„Çπ„Éà„Éº„É≥Ôºö„Éà„Éº„É†„Çπ„Éà„Éº„É≥Ë£ÖÂÇô„ÅßÂçÅÂàÜ</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="equipment-policy">
                                        <div class="policy-grid">
                                            ${slots.map(slot => `
                                                <div class="policy-item">
                                                    <label>${slot}</label>
                                                    <select id="${position}-${slot}-policy">
                                                        <option value="Èõ∂Âºè" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'Èõ∂Âºè') ? 'selected' : ''}>Èõ∂Âºè</option>
                                                        <option value="„Éà„Éº„É†„Çπ„Éà„Éº„É≥" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === '„Éà„Éº„É†„Çπ„Éà„Éº„É≥') ? 'selected' : ''}>„Éà„Éº„É†„Çπ„Éà„Éº„É≥</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'weapons') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>„Åæ„Åö„É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Åß„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        </div>
                    `;
                }
                
                const allWeapons = [
                    '„Éä„Ç§„Éà', 'Êà¶Â£´', 'ÊöóÈªíÈ®éÂ£´', '„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº',
                    'ÁôΩÈ≠îÈÅìÂ£´', 'Âç†ÊòüË°ìÂ£´', 'Â≠¶ËÄÖ', 'Ë≥¢ËÄÖ',
                    '„É¢„É≥„ÇØ', 'Á´úÈ®éÂ£´', 'ÂøçËÄÖ', '‰æç', '„É™„Éº„Éë„Éº', '„É¥„Ç°„Ç§„Éë„Éº',
                    'ÈªíÈ≠îÈÅìÂ£´', 'Âè¨ÂñöÂ£´', 'Ëµ§È≠îÈÅìÂ£´', '„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº',
                    'ÂêüÈÅäË©©‰∫∫', 'Ê©üÂ∑•Â£´', 'Ë∏ä„ÇäÂ≠ê'
                ];
                
                return `
                    <h3>4Â±§Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÂ∏åÊúõÈ†Ü‰Ωç„ÇíË®≠ÂÆö</h3>
                    <p>Á¨¨‰∏ÄÂ∏åÊúõ„ÅØËá™ÂãïÁöÑ„Å´„É°„Ç§„É≥„Ç∏„Éß„Éñ„Å´„Å™„Çä„Åæ„Åô„ÄÇÁ¨¨‰∫å„ÄúÁ¨¨ÂõõÂ∏åÊúõ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            const weaponWishes = player.weaponWishes || [];
                            const mainWeapon = player.job;
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge">${position} - ${player.job}</span>
                                    </div>
                                    <div class="weapon-wishes">
                                        <div class="wish-priority">
                                            <label>Á¨¨‰∏ÄÂ∏åÊúõ („É°„Ç§„É≥„Ç∏„Éß„Éñ):</label>
                                            <input type="text" value="${mainWeapon}" readonly style="background-color: #e9ecef;">
                                        </div>
                                        <div class="wish-priority">
                                            <label>Á¨¨‰∫åÂ∏åÊúõ:</label>
                                            <select id="${position}-weapon-wish-2">
                                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[1] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>Á¨¨‰∏âÂ∏åÊúõ:</label>
                                            <select id="${position}-weapon-wish-3">
                                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[2] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>Á¨¨ÂõõÂ∏åÊúõ:</label>
                                            <select id="${position}-weapon-wish-4">
                                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[3] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'migration') {
                return `
                    <h3>Êó¢Â≠ò„Éá„Éº„Çø„Åã„Çâ„ÅÆÁßªË°å</h3>
                    <p>‰ªñ„ÅÆ„Ç∑„Çπ„ÉÜ„É†„ÇÑ„Éï„Ç°„Ç§„É´„Åã„Çâ„Éá„Éº„Çø„ÇíÁßªË°å„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆÊ©üËÉΩ„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    
                    <div class="section" style="background-color: #f8f9fa; border: 2px solid #e9ecef;">
                        <h4>üìÑ JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„ÅÆ„Ç§„É≥„Éù„Éº„Éà</h4>
                        <div style="margin: 15px 0;">
                            <div style="display: flex; align-items: center; gap: 15px; margin: 10px 0;">
                                <input type="file" id="jsonFileInput" accept=".json" 
                                       style="flex: 1; padding: 12px; border: 2px dashed #3498db; border-radius: 8px; background-color: white;">
                                <button onclick="importFromJSON()" 
                                        style="padding: 12px 24px; background-color: #3498db; border-radius: 8px; font-weight: 600;">
                                    üìÇ JSON„Éï„Ç°„Ç§„É´„Çí„Ç§„É≥„Éù„Éº„Éà
                                </button>
                            </div>
                            <div id="jsonFileInfo" style="display: none; padding: 10px; background-color: #d4edda; border-left: 4px solid #28a745; margin: 10px 0;">
                                <strong>„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊ∏à„Åø:</strong> <span id="selectedFileName"></span><br>
                                <small id="fileDetails"></small>
                            </div>
                        </div>
                        <div style="background-color: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #27ae60;">
                            <strong>üìã ÂØæÂøúÂΩ¢Âºè:</strong><br>
                            ‚Ä¢ collaborative_index.html„Åß‰ΩúÊàê„Åï„Çå„Åü„Éá„Éº„Çø<br>
                            ‚Ä¢ ÂæìÊù•„ÅÆFF14Ë£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éá„Éº„Çø<br>
                            ‚Ä¢ „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÄÅË£ÖÂÇôÊñπÈáù„ÄÅÊ≠¶Âô®Â∏åÊúõ„ÇíÂê´„ÇÄJSON„Éï„Ç°„Ç§„É´<br>
                            ‚Ä¢ „Ç´„Çπ„Çø„É†JSON„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàËá™ÂãïÂà§Âà•Ôºâ
                        </div>
                    </div>
                    
                    <div class="section" style="background-color: #fff9e6; border: 2px solid #f39c12;">
                        <h4>üìã CSVÂΩ¢Âºè„Åß„ÅÆ‰∏ÄÊã¨ÁôªÈå≤</h4>
                        <div style="margin: 15px 0;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: start;">
                                <div style="display: flex; flex-direction: column;">
                                    <label for="csvTextArea" style="font-weight: 600; margin-bottom: 8px; color: #8b4513;">
                                        CSV„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà„Éò„ÉÉ„ÉÄ„ÉºË°åÂê´„ÇÄÔºâ:
                                    </label>
                                    <textarea id="csvTextArea" 
                                             placeholder="„Éù„Ç∏„Ç∑„Éß„É≥,„Éó„É¨„Ç§„É§„ÉºÂêç,„Ç∏„Éß„Éñ,„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç&#10;MT,Áî∞‰∏≠Â§™ÈÉé,„Éä„Ç§„Éà,Taro Tanaka&#10;ST,‰ΩêËó§Ê¨°ÈÉé,Êà¶Â£´,Jiro Sato&#10;H1,‰ΩêËó§Ëä±Â≠ê,ÁôΩÈ≠îÈÅìÂ£´,Hanako Sato&#10;H2,Áî∞‰∏≠ÁæéÂí≤,Â≠¶ËÄÖ,Misaki Tanaka&#10;D1,Â±±Áî∞‰∏ÄÈÉé,Á´úÈ®éÂ£´,Ichiro Yamada&#10;D2,Èà¥Êú®‰∏âÈÉé,ÂøçËÄÖ,Saburo Suzuki&#10;D3,È´òÊ©ãÁæéÈáå,ÈªíÈ≠îÈÅìÂ£´,Misato Takahashi&#10;D4,Ê∏°Ëæ∫ÂÅ•Â§™,ÂêüÈÅäË©©‰∫∫,Kenta Watanabe" 
                                             style="width: 100%; height: 160px; font-family: 'Courier New', monospace; font-size: 12px; padding: 12px; border: 2px solid #f39c12; border-radius: 8px; resize: vertical;"></textarea>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button onclick="importFromCSV()" 
                                                style="flex: 1; padding: 12px 24px; background-color: #f39c12; color: white; border-radius: 8px; font-weight: 600;">
                                            üìä CSV„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
                                        </button>
                                        <button onclick="clearCSVData()" 
                                                style="padding: 12px 20px; background-color: #95a5a6; color: white; border-radius: 8px;">
                                            üóëÔ∏è „ÇØ„É™„Ç¢
                                        </button>
                                    </div>
                                </div>
                                <div style="min-width: 200px;">
                                    <div style="background-color: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #f39c12;">
                                        <strong>CSVÂΩ¢Âºè‰æã:</strong><br>
                                        <code style="font-size: 11px; display: block; margin: 5px 0;">
                                        „Éù„Ç∏„Ç∑„Éß„É≥,„Éó„É¨„Ç§„É§„ÉºÂêç,„Ç∏„Éß„Éñ,„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç<br>
                                        MT,Áî∞‰∏≠Â§™ÈÉé,„Éä„Ç§„Éà,Taro Tanaka<br>
                                        ST,‰ΩêËó§Ê¨°ÈÉé,Êà¶Â£´,Jiro Sato
                                        </code><br>
                                        <strong>„Éù„Ç∏„Ç∑„Éß„É≥:</strong><br>
                                        MT, ST, H1, H2, D1, D2, D3, D4<br><br>
                                        <strong>‚ö†Ô∏è Ê≥®ÊÑè:</strong><br>
                                        Êó¢Â≠ò„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section" style="background-color: #fdf2f2; border: 2px solid #e74c3c;">
                        <h4>üîÑ „Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà</h4>
                        <div style="margin: 15px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <button onclick="resetCurrentTierData()" 
                                            style="width: 100%; padding: 15px; background-color: #e74c3c; color: white; border-radius: 8px; font-weight: 600; margin-bottom: 10px;">
                                        üóëÔ∏è ÁèæÂú®„ÅÆ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà
                                    </button>
                                    <button onclick="resetAllPlayersData()" 
                                            style="width: 100%; padding: 15px; background-color: #d86a5a; color: white; border-radius: 8px; font-weight: 600;">
                                        üë• „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„Åø„É™„Çª„ÉÉ„Éà
                                    </button>
                                </div>
                                <div style="background-color: #fee; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; color: #721c24;">
                                    <strong>‚ö†Ô∏è ÈáçË¶Å„Å™Ê≥®ÊÑè‰∫ãÈ†Ö:</strong><br><br>
                                    <strong>ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà:</strong><br>
                                    ‚Ä¢ „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±<br>
                                    ‚Ä¢ Ë£ÖÂÇôÊñπÈáùË®≠ÂÆö<br>
                                    ‚Ä¢ Ê≠¶Âô®Â∏åÊúõ„É™„Çπ„Éà<br>
                                    ‚Ä¢ ÂàÜÈÖçÂ±•Ê≠¥<br><br>
                                    <strong>„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„Åø:</strong><br>
                                    ‚Ä¢ „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅÆ„ÅøÂâäÈô§<br>
                                    ‚Ä¢ Ë®≠ÂÆö„Å®„É≠„Ç∞„ÅØ‰øùÊåÅ<br><br>
                                    <strong>üö® „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section" style="background-color: #f0f8ff; border: 2px solid #3498db;">
                        <h4>üí° „Éá„Éº„ÇøÁßªË°å„ÅÆ„Éí„É≥„Éà</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0;">
                            <div style="background-color: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                                <strong>üìã CSV„Éï„Ç°„Ç§„É´„Åã„ÇâË≤º„Çä‰ªò„Åë„ÇãÂ†¥Âêà:</strong><br>
                                1. Excel„ÇÑ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åß„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè<br>
                                2. „Éá„Éº„ÇøÁØÑÂõ≤„ÇíÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº<br>
                                3. CSV„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´Ë≤º„Çä‰ªò„Åë<br>
                                4. „Ç§„É≥„Éù„Éº„Éà„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
                            </div>
                            <div style="background-color: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                                <strong>üìÑ JSON„Éá„Éº„Çø„ÅÆÊ∫ñÂÇô:</strong><br>
                                1. Êó¢Â≠ò„Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„Ç®„ÇØ„Çπ„Éù„Éº„Éà<br>
                                2. „Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åå.json„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç<br>
                                3. „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÈÅ©Âàá„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç<br>
                                4. „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂâç„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return '';
        }
        
        // ÁèæÂú®„ÅÆ„Çø„Éñ„Çí‰øùÂ≠ò„Åó„Å¶Ê¨°„Å∏ÈÄ≤„ÇÄ
        async function saveCurrentTabAndContinue(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                }
                
                showSuccess('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                
                // ÂÖ®„Å¶Ë®≠ÂÆöÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏
                if (Object.keys(appData.players[currentRaidTier.id] || {}).length > 0) {
                    showTierDashboard();
                } else {
                    showError('„É°„É≥„Éê„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                }
            } catch (error) {
                console.error('Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showError('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±‰øùÂ≠ò
        async function savePlayersData() {
            const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
            
            if (!appData.players[currentRaidTier.id]) {
                appData.players[currentRaidTier.id] = {};
            }
            
            for (const position of positions) {
                const nameInput = document.getElementById(`${position}-name`);
                const characterInput = document.getElementById(`${position}-character`);
                const jobSelect = document.getElementById(`${position}-job`);
                
                if (!nameInput || !jobSelect) continue;
                
                const name = nameInput.value.trim();
                const characterName = characterInput.value.trim();
                const job = jobSelect.value;
                
                if (!name || !job) {
                    throw new Error(`${position}„ÅÆ„Éó„É¨„Ç§„É§„ÉºÂêç„Å®„Ç∏„Éß„Éñ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                }
                
                // Êó¢Â≠ò„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰øùÊåÅ
                const existingPlayer = appData.players[currentRaidTier.id][position] || {};
                
                appData.players[currentRaidTier.id][position] = {
                    name: name,
                    characterName: characterName,
                    job: job,
                    position: position,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    weaponWishes: existingPlayer.weaponWishes || [],
                    currentEquipment: existingPlayer.currentEquipment || {},
                    dynamicPriority: existingPlayer.dynamicPriority || 0,
                    allocationHistory: existingPlayer.allocationHistory || []
                };
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Ë£ÖÂÇôÊñπÈáù‰øùÂ≠ò
        async function saveEquipmentPolicyData() {
            const players = appData.players[currentRaidTier.id];
            const slots = ['Ê≠¶Âô®', 'È†≠', 'ËÉ¥', 'Êâã', 'ËÑö', 'Ë∂≥', 'ËÄ≥', 'È¶ñ', 'ËÖï', 'Êåá'];
            
            for (const [position, player] of Object.entries(players)) {
                for (const slot of slots) {
                    const policyElement = document.getElementById(`${position}-${slot}-policy`);
                    if (policyElement) {
                        const policy = policyElement.value;
                        player.equipmentPolicy[slot] = policy;
                    }
                }
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Ê≠¶Âô®Â∏åÊúõ‰øùÂ≠ò
        async function saveWeaponWishesData() {
            const players = appData.players[currentRaidTier.id];
            
            for (const [position, player] of Object.entries(players)) {
                const mainJob = player.job;
                const wish2Element = document.getElementById(`${position}-weapon-wish-2`);
                const wish3Element = document.getElementById(`${position}-weapon-wish-3`);
                const wish4Element = document.getElementById(`${position}-weapon-wish-4`);
                
                // Á¨¨‰∏ÄÂ∏åÊúõ„ÅØ„É°„Ç§„É≥„Ç∏„Éß„Éñ„ÄÅÁ¨¨‰∫å„ÄúÁ¨¨ÂõõÂ∏åÊúõ„ÅØÈÅ∏Êäû„Åï„Çå„ÅüÂÄ§
                player.weaponWishes = [
                    mainJob,
                    wish2Element ? wish2Element.value : '',
                    wish3Element ? wish3Element.value : '',
                    wish4Element ? wish4Element.value : ''
                ].filter(wish => wish !== ''); // Á©∫„ÅÆÂÄ§„ÇíÈô§Â§ñ
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // „Éá„Éº„ÇøÁßªË°åÊ©üËÉΩ
        
        // JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        async function importFromJSON() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('JSON„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            try {
                showMessage('„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...', 'info');
                
                const text = await file.text();
                const importData = JSON.parse(text);
                
                // „Éá„Éº„ÇøÂΩ¢Âºè„ÅÆÊ§úË®º„Å®Â§âÊèõ
                const convertedData = await convertImportData(importData);
                
                if (!convertedData) {
                    showError('ÂØæÂøú„Åó„Å¶„ÅÑ„Å™„ÅÑ„Éá„Éº„ÇøÂΩ¢Âºè„Åß„Åô„ÄÇ');
                    return;
                }
                
                // Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆË°®Á§∫
                let playerCount = 0;
                let tierCount = 0;
                
                if (convertedData.type === 'collaborative') {
                    tierCount = Object.keys(convertedData.players || {}).length;
                    playerCount = Object.values(convertedData.players || {}).reduce((total, tierPlayers) => {
                        return total + Object.keys(tierPlayers || {}).length;
                    }, 0);
                } else if (convertedData.type === 'simple') {
                    playerCount = Object.keys(convertedData.players || {}).length;
                    tierCount = 1;
                }
                
                // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
                const confirmMessage = `‰ª•‰∏ã„ÅÆ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„ÅôÔºö
                
„Éó„É¨„Ç§„É§„ÉºÊï∞: ${playerCount}‰∫∫
„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢Êï∞: ${tierCount}ÂÄã
„Éá„Éº„ÇøÂΩ¢Âºè: ${convertedData.type === 'collaborative' ? 'ÂÖ±ÂêåÂà©Áî®Áâà' : 'Á∞°ÊòìÁâà'}

ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // „Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
                await importConvertedData(convertedData);
                
                showSuccess(`„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÔºà${playerCount}‰∫∫„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÁôªÈå≤Ôºâ`);
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                if (error.name === 'SyntaxError') {
                    showError('JSON„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    showError('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
        }
        
        // JSON„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆÊÉÖÂ†±Ë°®Á§∫„ÇíË®≠ÂÆö
            document.addEventListener('change', function(event) {
                if (event.target.id === 'jsonFileInput') {
                    const file = event.target.files[0];
                    const fileInfo = document.getElementById('jsonFileInfo');
                    const fileName = document.getElementById('selectedFileName');
                    const fileDetails = document.getElementById('fileDetails');
                    
                    if (file && fileInfo && fileName && fileDetails) {
                        fileName.textContent = file.name;
                        fileDetails.textContent = `„Çµ„Ç§„Ç∫: ${(file.size / 1024).toFixed(2)} KB, ÊúÄÁµÇÊõ¥Êñ∞: ${new Date(file.lastModified).toLocaleString()}`;
                        fileInfo.style.display = 'block';
                    } else if (fileInfo) {
                        fileInfo.style.display = 'none';
                    }
                }
            });
        });
        
        // CSV„Åã„Çâ„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        async function importFromCSV() {
            const csvText = document.getElementById('csvTextArea').value.trim();
            
            if (!csvText) {
                showError('CSV„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const players = {};
                
                for (let i = 1; i < lines.length; i++) { // „Éò„ÉÉ„ÉÄ„ÉºË°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                    const columns = lines[i].split(',').map(col => col.trim());
                    
                    if (columns.length < 4) continue;
                    
                    const [position, name, job, characterName] = columns;
                    
                    players[position] = {
                        name: name,
                        characterName: characterName || '',
                        job: job,
                        position: position,
                        equipmentPolicy: {},
                        weaponWishes: [job],
                        currentEquipment: {},
                        dynamicPriority: 0,
                        allocationHistory: []
                    };
                }
                
                if (Object.keys(players).length === 0) {
                    showError('ÊúâÂäπ„Å™„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }
                
                // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
                if (!confirm(`${Object.keys(players).length}‰∫∫„ÅÆ„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)) {
                    return;
                }
                
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                appData.players[currentRaidTier.id] = players;
                await saveDataToSupabase('players', players);
                
                showSuccess('CSV„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('CSV„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                showError('CSV„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // CSV„Éá„Éº„Çø„ÇØ„É™„Ç¢
        function clearCSVData() {
            const csvTextArea = document.getElementById('csvTextArea');
            if (csvTextArea) {
                csvTextArea.value = '';
                showSuccess('CSV„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„Åø„É™„Çª„ÉÉ„Éà
        async function resetAllPlayersData() {
            if (!confirm('ÁèæÂú®„ÅÆ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                return;
            }
            
            if (!confirm('Êú¨ÂΩì„Å´„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÄÅË£ÖÂÇôÊñπÈáù„ÄÅÊ≠¶Âô®Â∏åÊúõ„Åå„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            try {
                // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„ÅøÂâäÈô§
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                
                // Supabase„Åã„Çâ„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„ÅøÂâäÈô§
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id)
                    .eq('data_type', 'players');
                
                showSuccess('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                showError('„Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÁèæÂú®„ÅÆ„ÉÜ„Ç£„Ç¢„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà
        async function resetCurrentTierData() {
            if (!confirm('ÁèæÂú®„ÅÆ„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                return;
            }
            
            if (!confirm('Êú¨ÂΩì„Å´„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü„Åô„Åπ„Å¶„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÄÅË£ÖÂÇôÊñπÈáù„ÄÅÂàÜÈÖçÂ±•Ê≠¥„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            try {
                // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÂâäÈô§
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                if (appData.allocations[currentRaidTier.id]) {
                    delete appData.allocations[currentRaidTier.id];
                }
                
                // Supabase„Åã„Çâ„ÇÇÂâäÈô§
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id);
                
                showSuccess('„É¨„Ç§„Éâ„ÉÜ„Ç£„Ç¢„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
                showTabbedSetup('players'); // „É°„É≥„Éê„ÉºÊÉÖÂ†±„Çø„Éñ„Å´ÁßªÂãï
                
            } catch (error) {
                console.error('„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                showError('„Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // „Ç§„É≥„Éù„Éº„Éà„Éá„Éº„Çø„ÅÆÂ§âÊèõ
        async function convertImportData(importData) {
            // collaborative_index.htmlÂΩ¢Âºè„ÅÆÂ†¥Âêà
            if (importData.raidTiers && importData.players && importData.allocations) {
                return {
                    type: 'collaborative',
                    players: importData.players,
                    allocations: importData.allocations
                };
            }
            
            // ÂçòÁ¥î„Å™„Éó„É¨„Ç§„É§„Éº„É™„Çπ„ÉàÂΩ¢Âºè„ÅÆÂ†¥Âêà
            if (Array.isArray(importData) && importData.length > 0 && importData[0].name) {
                const players = {};
                importData.forEach((player, index) => {
                    const positions = ['MT', 'ST', 'H1', 'H2', 'D1', 'D2', 'D3', 'D4'];
                    const position = positions[index] || `D${index - 3}`;
                    
                    players[position] = {
                        name: player.name,
                        characterName: player.characterName || '',
                        job: player.job,
                        position: position,
                        equipmentPolicy: player.equipmentPolicy || {},
                        weaponWishes: player.weaponWishes || [player.job],
                        currentEquipment: player.currentEquipment || {},
                        dynamicPriority: player.dynamicPriority || 0,
                        allocationHistory: player.allocationHistory || []
                    };
                });
                
                return {
                    type: 'simple',
                    players: players
                };
            }
            
            return null;
        }
        
        // Â§âÊèõÊ∏à„Åø„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        async function importConvertedData(convertedData) {
            if (convertedData.type === 'collaborative') {
                // ÁèæÂú®„ÅÆ„ÉÜ„Ç£„Ç¢„Å´ÂØæÂøú„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
                const tierData = Object.values(convertedData.players)[0] || {};
                appData.players[currentRaidTier.id] = tierData;
                
                // ÂàÜÈÖçÂ±•Ê≠¥„ÇÇÁßªË°å
                if (convertedData.allocations) {
                    const allocationData = Object.values(convertedData.allocations)[0] || {};
                    appData.allocations[currentRaidTier.id] = allocationData;
                    await saveDataToSupabase('allocations', allocationData);
                }
            } else if (convertedData.type === 'simple') {
                appData.players[currentRaidTier.id] = convertedData.players;
            }
            
            // Supabase„Å´‰øùÂ≠ò
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Supabase„Éá„Éº„Çø‰øùÂ≠ò„Éò„É´„Éë„Éº
        async function saveDataToSupabase(dataType, content) {
            const { error } = await window.supabaseClient
                .from('raid_data')
                .upsert({
                    team_id: currentTeamId,
                    tier_id: currentRaidTier.id,
                    data_type: dataType,
                    content: content
                });
                
            if (error) {
                throw new Error(`‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        }
        
        // Ë£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†
        function showEquipmentAllocation() {
            const content = document.getElementById('content');
            
            // „Éó„É¨„Ç§„É§„Éº„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„É°„É≥„Éê„ÉºË®≠ÂÆö„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                </div>
                
                <h1>Ë£ÖÂÇôÂàÜÈÖç„Ç∑„Çπ„ÉÜ„É†</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>Â±§„ÇíÈÅ∏Êäû„Åó„Å¶Ë£ÖÂÇôÂàÜÈÖç„ÇíÂÆüË°å</h3>
                    <div class="layer-grid">
                        <div class="layer-card" onclick="processLayerAllocation(1)">
                            <h4>1Â±§</h4>
                            <p>„Ç¢„ÇØ„Çª„Çµ„É™„ÉºÔºàËÄ≥„ÉªÈ¶ñ„ÉªËÖï„ÉªÊåáÔºâ</p>
                            <div class="layer-stats">
                                ÁôªÈå≤„Éó„É¨„Ç§„É§„Éº: ${playerCount}‰∫∫
                            </div>
                        </div>
                        
                        <div class="layer-card" onclick="processLayerAllocation(2)">
                            <h4>2Â±§</h4>
                            <p>Èò≤ÂÖ∑ÔºàÈ†≠„ÉªÊâã„ÉªË∂≥Ôºâ+ Ê≠¶Âô®Áü≥„ÉªÁ°¨ÂåñËñ¨</p>
                            <div class="layer-stats">
                                ÁôªÈå≤„Éó„É¨„Ç§„É§„Éº: ${playerCount}‰∫∫
                            </div>
                        </div>
                        
                        <div class="layer-card" onclick="processLayerAllocation(3)">
                            <h4>3Â±§</h4>
                            <p>Èò≤ÂÖ∑ÔºàËÉ¥„ÉªËÑöÔºâ+ Âº∑ÂåñËñ¨„ÉªÂº∑ÂåñÁπäÁ∂≠</p>
                            <div class="layer-stats">
                                ÁôªÈå≤„Éó„É¨„Ç§„É§„Éº: ${playerCount}‰∫∫
                            </div>
                        </div>
                        
                        <div class="layer-card" onclick="processLayerAllocation(4)">
                            <h4>4Â±§</h4>
                            <p>ËÉ¥Ë£ÖÂÇô + Ê≠¶Âô®ÁÆ±„ÉªÁõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®</p>
                            <div class="layer-stats">
                                ÁôªÈå≤„Éó„É¨„Ç§„É§„Éº: ${playerCount}‰∫∫
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section" id="allocationResults" style="display: none;">
                    <h3>ÂàÜÈÖçÁµêÊûú</h3>
                    <div id="allocationContent"></div>
                </div>
            `;
        }
        
        // Â±§Âà•Ë£ÖÂÇôÂàÜÈÖçÂá¶ÁêÜ
        async function processLayerAllocation(layer) {
            try {
                showMessage('ÂàÜÈÖçÂá¶ÁêÜ‰∏≠...', 'info');
                
                // Â±§Âà•„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó
                const drops = getLayerDrops(layer);
                
                // ÂàÜÈÖçÂÑ™ÂÖàÂ∫¶„ÇíË®àÁÆó
                const allocationResults = calculateAllocation(layer, drops);
                
                // ÁµêÊûú„ÇíË°®Á§∫
                displayAllocationResults(layer, allocationResults);
                
            } catch (error) {
                console.error('ÂàÜÈÖçÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                showError('ÂàÜÈÖçÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Â±§Âà•„Éâ„É≠„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†ÂÆöÁæ©
        function getLayerDrops(layer) {
            const drops = {
                1: [
                    { name: 'ËÄ≥Ë£ÖÂÇô', slot: 'ËÄ≥', type: 'equipment', itemLevel: '' },
                    { name: 'È¶ñË£ÖÂÇô', slot: 'È¶ñ', type: 'equipment', itemLevel: '' },
                    { name: 'ËÖïË£ÖÂÇô', slot: 'ËÖï', type: 'equipment', itemLevel: '' },
                    { name: 'ÊåáË£ÖÂÇô', slot: 'Êåá', type: 'equipment', itemLevel: '' }
                ],
                2: [
                    { name: 'È†≠Ë£ÖÂÇô', slot: 'È†≠', type: 'equipment', itemLevel: '' },
                    { name: 'ÊâãË£ÖÂÇô', slot: 'Êâã', type: 'equipment', itemLevel: '' },
                    { name: 'Ë∂≥Ë£ÖÂÇô', slot: 'Ë∂≥', type: 'equipment', itemLevel: '' },
                    { name: 'Ê≠¶Âô®Áü≥', slot: 'Ê≠¶Âô®Áü≥', type: 'material', itemLevel: '' },
                    { name: 'Á°¨ÂåñËñ¨', slot: 'Á°¨ÂåñËñ¨', type: 'material', itemLevel: '' }
                ],
                3: [
                    { name: 'ËÉ¥Ë£ÖÂÇô', slot: 'ËÉ¥', type: 'equipment', itemLevel: '' },
                    { name: 'ËÑöË£ÖÂÇô', slot: 'ËÑö', type: 'equipment', itemLevel: '' },
                    { name: 'Âº∑ÂåñËñ¨', slot: 'Âº∑ÂåñËñ¨', type: 'material', itemLevel: '' },
                    { name: 'Âº∑ÂåñÁπäÁ∂≠', slot: 'Âº∑ÂåñÁπäÁ∂≠', type: 'material', itemLevel: '' }
                ],
                4: [
                    { name: 'ËÉ¥Ë£ÖÂÇô', slot: 'ËÉ¥', type: 'equipment', itemLevel: '' },
                    { name: 'Ê≠¶Âô®ÁÆ±', slot: 'Ê≠¶Âô®ÁÆ±', type: 'weapon_box', itemLevel: '' },
                    { name: 'Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®', slot: 'Ê≠¶Âô®', type: 'direct_weapon', itemLevel: '', weapon: null }
                ]
            };
            
            return drops[layer] || [];
        }
        
        // ÂàÜÈÖçÂÑ™ÂÖàÂ∫¶Ë®àÁÆó
        function calculateAllocation(layer, drops) {
            const players = appData.players[currentRaidTier.id] || {};
            const results = {};
            
            drops.forEach(drop => {
                const allCandidates = [];
                
                Object.entries(players).forEach(([position, player]) => {
                    const priority = calculatePlayerPriority(player, drop);
                    allCandidates.push({
                        position,
                        player,
                        priority: priority.score,
                        reason: priority.reason,
                        type: priority.type,
                        canReceive: priority.canReceive
                    });
                });
                
                // ÂÑ™ÂÖàÂ∫¶È†Ü„Åß„ÇΩ„Éº„ÉàÔºàÂÖ®„Éó„É¨„Ç§„É§„ÉºÔºâ
                allCandidates.sort((a, b) => b.priority - a.priority);
                
                // ÂèñÂæóÂèØËÉΩ„Å™ÂÄôË£úËÄÖ„ÅÆ„ÅøÊäΩÂá∫
                const candidates = allCandidates.filter(c => c.canReceive);
                
                results[drop.slot] = {
                    drop,
                    candidates: allCandidates, // ÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆÂà§ÂÆöÁµêÊûú
                    recommended: candidates[0] || null // ÊúÄÂÑ™ÂÖà„ÅÆÂèñÂæóÂèØËÉΩËÄÖ
                };
            });
            
            return results;
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÂÑ™ÂÖàÂ∫¶Ë®àÁÆó
        function calculatePlayerPriority(player, drop) {
            let score = 0;
            let canReceive = false;
            let reason = 'Pass';
            let type = 'pass';
            
            if (drop.type === 'equipment') {
                // Ë£ÖÂÇô„ÅÆÂ†¥Âêà
                const policy = player.equipmentPolicy?.[drop.slot] || '„Éà„Éº„É†„Çπ„Éà„Éº„É≥';
                const hasEquipment = player.currentEquipment?.[drop.slot];
                
                if (policy === 'Èõ∂Âºè' && !hasEquipment) {
                    canReceive = true;
                    type = 'need';
                    score = 1000 - (player.dynamicPriority || 0);
                    reason = 'Need (Èõ∂Âºè)';
                } else if (!hasEquipment) {
                    canReceive = true;
                    type = 'greed';
                    score = 500 - (player.dynamicPriority || 0);
                    reason = 'Greed („Éà„Éº„É†ÂèØ)';
                } else {
                    type = 'pass';
                    reason = 'Pass (ÊâÄÊåÅÊ∏à„Åø)';
                }
            } else if (drop.type === 'material') {
                // Âº∑ÂåñÁ¥†Êùê„ÅÆÂ†¥ÂêàÔºàÂàÜÈÖçÂÑ™ÂÖàÂ∫¶Ë®≠ÂÆö„Å´Âü∫„Å•„ÅèÔºâ
                const materialAllocations = appData.allocations?.[currentRaidTier.id] || [];
                const hasThisMaterial = materialAllocations.some(alloc => 
                    alloc.position === player.position && alloc.slot === drop.slot
                );
                
                if (!hasThisMaterial) {
                    canReceive = true;
                    type = 'need';
                    score = getMaterialPriority(player.position, drop.slot) - (player.dynamicPriority || 0);
                    reason = 'Need (Á¥†Êùê)';
                } else {
                    type = 'pass';
                    reason = 'Pass (ÂèñÂæóÊ∏à„Åø)';
                }
            } else if (drop.type === 'weapon_box') {
                // Ê≠¶Âô®ÁÆ±„ÅÆÂ†¥Âêà
                const hasWeapon = player.currentEquipment?.['Ê≠¶Âô®'];
                if (!hasWeapon) {
                    canReceive = true;
                    type = 'need';
                    score = 2000 - (player.dynamicPriority || 0);
                    reason = 'Need (Ê≠¶Âô®ÁÆ±)';
                } else {
                    type = 'pass';
                    reason = 'Pass (Ê≠¶Âô®ÊâÄÊåÅÊ∏à„Åø)';
                }
            } else if (drop.type === 'direct_weapon') {
                // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÂ†¥ÂêàÔºàÊ≠¶Âô®Â∏åÊúõ„Å´Âü∫„Å•„ÅèÔºâ
                const weaponWishes = player.weaponWishes || [];
                const hasWeapon = player.currentEquipment?.['Ê≠¶Âô®'];
                const weaponType = drop.weapon; // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≠¶Âô®Á®Æ
                
                if (!hasWeapon && weaponType && weaponWishes.includes(weaponType)) {
                    canReceive = true;
                    type = 'need';
                    const wishIndex = weaponWishes.indexOf(weaponType);
                    score = 3000 - (wishIndex * 100) - (player.dynamicPriority || 0);
                    reason = `Need (Á¨¨${wishIndex + 1}Â∏åÊúõ)`;
                } else if (!hasWeapon) {
                    canReceive = true;
                    type = 'greed';
                    score = 100 - (player.dynamicPriority || 0);
                    reason = 'Greed (Ê≠¶Âô®)';
                } else {
                    type = 'pass';
                    reason = 'Pass (Ê≠¶Âô®ÊâÄÊåÅÊ∏à„Åø)';
                }
            }
            
            return { canReceive, score, reason, type };
        }
        
        // Âº∑ÂåñÁ¥†Êùê„ÅÆÂàÜÈÖçÂÑ™ÂÖàÂ∫¶ÂèñÂæó
        function getMaterialPriority(position, materialType) {
            // „Éá„Éï„Ç©„É´„Éà„ÅÆÂàÜÈÖçÂÑ™ÂÖàÂ∫¶È†ÜÂ∫èÔºàË®≠ÂÆöÂèØËÉΩ„Å´„Åô„Çã‰∫àÂÆöÔºâ
            const defaultOrder = ['D1', 'D2', 'D3', 'D4', 'H1', 'H2', 'MT', 'ST'];
            const positionIndex = defaultOrder.indexOf(position);
            return 800 - (positionIndex * 50); // È´ò„ÅÑÈ†Ü‰Ωç„Åª„Å©È´ò„Çπ„Ç≥„Ç¢
        }
        
        // ÂàÜÈÖçÁµêÊûúË°®Á§∫
        function displayAllocationResults(layer, results) {
            const allocationResults = document.getElementById('allocationResults');
            const allocationContent = document.getElementById('allocationContent');
            
            let html = `
                <div class="allocation-header">
                    <h4>${layer}Â±§ Ë£ÖÂÇôÂàÜÈÖçÁµêÊûú</h4>
                    <p>Êé®Â•®ÂàÜÈÖçËÄÖ„ÅåËá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åó„Åü„ÄÇÂøÖË¶Å„Å´Âøú„Åò„Å¶Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>
            `;
            
            // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®ÈÅ∏ÊäûÔºà4Â±§„ÅÆ„ÅøÔºâ
            if (layer === 4) {
                html += `
                    <div class="weapon-selection">
                        <h5>Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®ÈÅ∏Êäû:</h5>
                        <select id="directWeaponSelect" onchange="updateDirectWeapon()">
                            <option value="">Ê≠¶Âô®„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="„Éä„Ç§„Éà">„Éä„Ç§„ÉàÊ≠¶Âô®</option>
                            <option value="Êà¶Â£´">Êà¶Â£´Ê≠¶Âô®</option>
                            <option value="ÊöóÈªíÈ®éÂ£´">ÊöóÈªíÈ®éÂ£´Ê≠¶Âô®</option>
                            <option value="„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„Éº">„Ç¨„É≥„Éñ„É¨„Ç§„Ç´„ÉºÊ≠¶Âô®</option>
                            <option value="ÁôΩÈ≠îÈÅìÂ£´">ÁôΩÈ≠îÈÅìÂ£´Ê≠¶Âô®</option>
                            <option value="Â≠¶ËÄÖ">Â≠¶ËÄÖÊ≠¶Âô®</option>
                            <option value="Âç†ÊòüË°ìÂ£´">Âç†ÊòüË°ìÂ£´Ê≠¶Âô®</option>
                            <option value="Ë≥¢ËÄÖ">Ë≥¢ËÄÖÊ≠¶Âô®</option>
                            <option value="„É¢„É≥„ÇØ">„É¢„É≥„ÇØÊ≠¶Âô®</option>
                            <option value="Á´úÈ®éÂ£´">Á´úÈ®éÂ£´Ê≠¶Âô®</option>
                            <option value="ÂøçËÄÖ">ÂøçËÄÖÊ≠¶Âô®</option>
                            <option value="‰æç">‰æçÊ≠¶Âô®</option>
                            <option value="„É™„Éº„Éë„Éº">„É™„Éº„Éë„ÉºÊ≠¶Âô®</option>
                            <option value="„É¥„Ç°„Ç§„Éë„Éº">„É¥„Ç°„Ç§„Éë„ÉºÊ≠¶Âô®</option>
                            <option value="ÈªíÈ≠îÈÅìÂ£´">ÈªíÈ≠îÈÅìÂ£´Ê≠¶Âô®</option>
                            <option value="Âè¨ÂñöÂ£´">Âè¨ÂñöÂ£´Ê≠¶Âô®</option>
                            <option value="Ëµ§È≠îÈÅìÂ£´">Ëµ§È≠îÈÅìÂ£´Ê≠¶Âô®</option>
                            <option value="„Éî„ÇØ„Éà„Éû„É≥„Çµ„Éº">„Éî„ÇØ„Éà„Éû„É≥„Çµ„ÉºÊ≠¶Âô®</option>
                            <option value="ÂêüÈÅäË©©‰∫∫">ÂêüÈÅäË©©‰∫∫Ê≠¶Âô®</option>
                            <option value="Ê©üÂ∑•Â£´">Ê©üÂ∑•Â£´Ê≠¶Âô®</option>
                            <option value="Ë∏ä„ÇäÂ≠ê">Ë∏ä„ÇäÂ≠êÊ≠¶Âô®</option>
                        </select>
                    </div>
                `;
            }
            
            html += `<div class="allocation-grid">`;
            
            Object.entries(results).forEach(([itemKey, result]) => {
                const drop = result.drop;
                const needCandidates = result.candidates.filter(c => c.type === 'need');
                const greedCandidates = result.candidates.filter(c => c.type === 'greed');
                const passCandidates = result.candidates.filter(c => c.type === 'pass');
                
                html += `
                    <div class="allocation-item">
                        <div class="item-header">
                            <h5>${drop.name} ${drop.itemLevel}</h5>
                            <span class="item-type">${getItemTypeLabel(drop.type)}</span>
                        </div>
                        
                        <div class="predicted-winner">
                            <strong>‰∫àÊ∏¨ÂèñÂæóËÄÖ:</strong> 
                            ${result.recommended ? 
                                `${result.recommended.player.name} (${result.recommended.position}) - ${result.recommended.reason}` : 
                                'Ë©≤ÂΩìËÄÖ„Å™„Åó'
                            }
                        </div>
                        
                        <div class="allocation-choice">
                            <label>ÂÆüÈöõ„ÅÆÂèñÂæóËÄÖ:</label>
                            <select id="allocation-${itemKey}" onchange="updateAllocationChoice('${itemKey}')">
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                ${result.candidates.map(candidate => `
                                    <option value="${candidate.position}" 
                                            ${result.recommended?.position === candidate.position ? 'selected' : ''}>
                                        ${candidate.player.name} (${candidate.position}) - ${candidate.reason}
                                    </option>
                                `).join('')}
                                <option value="„Éï„É™„É≠">„Éï„É™„É≠</option>
                                <option value="discard">Á†¥Ê£Ñ</option>
                            </select>
                        </div>
                        
                        <div class="judgment-details">
                            <div class="judgment-section">
                                <button class="judgment-toggle" onclick="toggleJudgment('${itemKey}')">
                                    Âà§ÂÆöË©≥Á¥∞„ÇíË°®Á§∫ ‚ñº
                                </button>
                                <div id="judgment-${itemKey}" class="judgment-content" style="display: none;">
                                    ${needCandidates.length > 0 ? `
                                        <div class="need-section">
                                            <h6>Need (${needCandidates.length}‰∫∫)</h6>
                                            ${needCandidates.map(candidate => `
                                                <div class="candidate-item need">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${greedCandidates.length > 0 ? `
                                        <div class="greed-section">
                                            <h6>Greed (${greedCandidates.length}‰∫∫)</h6>
                                            ${greedCandidates.map(candidate => `
                                                <div class="candidate-item greed">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${passCandidates.length > 0 ? `
                                        <div class="pass-section">
                                            <h6>Pass (${passCandidates.length}‰∫∫)</h6>
                                            ${passCandidates.map(candidate => `
                                                <div class="candidate-item pass">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="allocation-actions">
                    <button onclick="confirmAllocation(${layer})" class="confirm-btn">
                        ÂàÜÈÖç„ÇíÁ¢∫ÂÆö
                    </button>
                    <button onclick="showEquipmentAllocation()" class="cancel-btn">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                </div>
            `;
            
            allocationContent.innerHTML = html;
            allocationResults.style.display = 'block';
            
            // ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            allocationResults.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®Êõ¥Êñ∞
        function updateDirectWeapon() {
            const weaponSelect = document.getElementById('directWeaponSelect');
            const selectedWeapon = weaponSelect.value;
            
            if (selectedWeapon) {
                // Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®„ÅÆÂàÜÈÖç„ÇíÂÜçË®àÁÆó
                const drops = getLayerDrops(4);
                const weaponDrop = drops.find(d => d.type === 'direct_weapon');
                if (weaponDrop) {
                    weaponDrop.weapon = selectedWeapon;
                    const allocationResults = calculateAllocation(4, drops);
                    displayAllocationResults(4, allocationResults);
                }
            }
        }
        
        // Âà§ÂÆöË©≥Á¥∞„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleJudgment(itemKey) {
            const content = document.getElementById(`judgment-${itemKey}`);
            const button = content.previousElementSibling;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'Âà§ÂÆöË©≥Á¥∞„ÇíÈö†„Åô ‚ñ≤';
            } else {
                content.style.display = 'none';
                button.textContent = 'Âà§ÂÆöË©≥Á¥∞„ÇíË°®Á§∫ ‚ñº';
            }
        }
        
        // „Ç¢„Ç§„ÉÜ„É†„Çø„Ç§„Éó„É©„Éô„É´
        function getItemTypeLabel(type) {
            const labels = {
                'equipment': 'Ë£ÖÂÇô',
                'material': 'Âº∑ÂåñÁ¥†Êùê',
                'weapon_box': 'Ê≠¶Âô®ÁÆ±',
                'direct_weapon': 'Áõ¥„Éâ„É≠„ÉÉ„ÉóÊ≠¶Âô®'
            };
            return labels[type] || type;
        }
        
        // ÂàÜÈÖçÈÅ∏ÊäûÊõ¥Êñ∞
        function updateAllocationChoice(slot) {
            // ÈÅ∏ÊäûÂ§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂÆüË£ÖÔºâ
            console.log(`${slot}„ÅÆÂàÜÈÖçÈÅ∏Êäû„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü`);
        }
        
        // ÂàÜÈÖçÁ¢∫ÂÆö
        async function confirmAllocation(layer) {
            try {
                const allocations = [];
                const selects = document.querySelectorAll('[id^="allocation-"]');
                const allocationId = Date.now().toString();
                
                selects.forEach(select => {
                    const itemKey = select.id.replace('allocation-', '');
                    const position = select.value;
                    
                    if (position && position !== 'discard' && position !== '„Éï„É™„É≠') {
                        const player = appData.players[currentRaidTier.id][position];
                        const drops = getLayerDrops(layer);
                        const drop = drops.find(d => d.slot === itemKey || d.name.includes(itemKey));
                        
                        if (drop && player) {
                            const allocation = {
                                id: `${allocationId}-${itemKey}`,
                                layer: layer,
                                slot: drop.slot,
                                position: position,
                                playerName: player.name,
                                characterName: player.characterName || '',
                                job: player.job,
                                equipment: {
                                    name: drop.name,
                                    slot: drop.slot,
                                    itemLevel: drop.itemLevel
                                },
                                timestamp: new Date().toISOString(),
                                week: getCurrentWeek(),
                                raidTier: currentRaidTier.name,
                                // Ë©≥Á¥∞ÊÉÖÂ†±
                                itemType: drop.type,
                                equipmentName: drop.name,
                                equipmentSlot: drop.slot,
                                winner: position,
                                winnerName: player.name
                            };
                            
                            allocations.push(allocation);
                        }
                    }
                });
                
                if (allocations.length === 0) {
                    showError('ÂàÜÈÖç„Åô„ÇãË£ÖÂÇô„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }
                
                // ÂàÜÈÖçÂ±•Ê≠¥„Å´Ë®òÈå≤
                if (!appData.allocations[currentRaidTier.id]) {
                    appData.allocations[currentRaidTier.id] = [];
                }
                
                allocations.forEach(allocation => {
                    appData.allocations[currentRaidTier.id].push(allocation);
                    
                    // „Éó„É¨„Ç§„É§„Éº„ÅÆË£ÖÂÇôÁä∂Ê≥ÅÊõ¥Êñ∞
                    const player = appData.players[currentRaidTier.id][allocation.position];
                    if (player) {
                        // ÁèæÂú®Ë£ÖÂÇô„ÅÆÊõ¥Êñ∞
                        if (!player.currentEquipment) player.currentEquipment = {};
                        player.currentEquipment[allocation.slot] = true;
                        
                        // ÂàÜÈÖçÂ±•Ê≠¥„ÅÆÊõ¥Êñ∞
                        if (!player.allocationHistory) player.allocationHistory = [];
                        player.allocationHistory.push({
                            equipment: allocation.equipment,
                            timestamp: allocation.timestamp,
                            week: allocation.week,
                            layer: allocation.layer
                        });
                        
                        // ÂãïÁöÑÂÑ™ÂÖàÂ∫¶Êõ¥Êñ∞
                        const itemPriority = getItemPriority(allocation.slot);
                        player.dynamicPriority = (player.dynamicPriority || 0) + itemPriority;
                    }
                });
                
                // Supabase„Å´‰øùÂ≠ò
                await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
                
                showSuccess(`${layer}Â±§„ÅÆË£ÖÂÇôÂàÜÈÖç„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åó„Åü„ÄÇ${allocations.length}‰ª∂„ÅÆË£ÖÂÇô„ÅåÂàÜÈÖç„Åï„Çå„Åæ„Åó„Åü„ÄÇ`);
                showEquipmentAllocation(); // Ë£ÖÂÇôÂàÜÈÖçÁîªÈù¢„Å´Êàª„Çã
                
            } catch (error) {
                console.error('ÂàÜÈÖçÁ¢∫ÂÆö„Ç®„É©„Éº:', error);
                showError('ÂàÜÈÖç„ÅÆÁ¢∫ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÁèæÂú®„ÅÆÈÄ±Áï™Âè∑ÂèñÂæó
        function getCurrentWeek() {
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const weekNumber = Math.ceil(((now - yearStart) / 86400000 + yearStart.getDay() + 1) / 7);
            return weekNumber;
        }
        
        // „Ç¢„Ç§„ÉÜ„É†ÂÑ™ÂÖàÂ∫¶ÂèñÂæó
        function getItemPriority(slot) {
            const priorities = {
                'Ê≠¶Âô®': 3,
                'ËÉ¥': 2,
                'ËÑö': 2,
                'È†≠': 1,
                'Êâã': 1,
                'Ë∂≥': 1,
                'ËÄ≥': 1,
                'È¶ñ': 1,
                'ËÖï': 1,
                'Êåá': 1,
                'Ê≠¶Âô®Áü≥': 1,
                'Á°¨ÂåñËñ¨': 1,
                'Âº∑ÂåñËñ¨': 1,
                'Âº∑ÂåñÁπäÁ∂≠': 1
            };
            return priorities[slot] || 1;
        }
        
        // Áµ±Ë®àÊÉÖÂ†±Ë°®Á§∫
        function showStatistics() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            const allocations = appData.allocations[currentRaidTier.id] || [];
            
            if (Object.keys(players).length === 0) {
                showError('„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            // Áµ±Ë®à„Éá„Éº„ÇøË®àÁÆó
            const stats = calculateStatistics(players, allocations);
            
            content.innerHTML = `
                <h1>Áµ±Ë®àÊÉÖÂ†±</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üìä „Éó„É¨„Ç§„É§„ÉºÂà•ÂèñÂæóÁä∂Ê≥Å</h3>
                    <div class="stats-grid">
                        ${Object.entries(stats.playerStats).map(([position, stat]) => `
                            <div class="stat-card">
                                <h4>${stat.name} (${position})</h4>
                                <div class="stat-details">
                                    <div class="stat-item">
                                        <span class="stat-label">Ë£ÖÂÇôÂèñÂæóÊï∞:</span>
                                        <span class="stat-value">${stat.equipmentCount}‰ª∂</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Á¥†ÊùêÂèñÂæóÊï∞:</span>
                                        <span class="stat-value">${stat.materialCount}‰ª∂</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Á∑èÂèñÂæóÊï∞:</span>
                                        <span class="stat-value">${stat.totalCount}‰ª∂</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">ÂãïÁöÑÂÑ™ÂÖàÂ∫¶:</span>
                                        <span class="stat-value">${stat.dynamicPriority}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>üìà ÈÉ®‰ΩçÂà•ÂàÜÈÖçÁä∂Ê≥Å</h3>
                    <div class="slot-stats">
                        ${Object.entries(stats.slotStats).map(([slot, count]) => `
                            <div class="slot-stat-item">
                                <span class="slot-name">${slot}:</span>
                                <span class="slot-count">${count}‰ª∂</span>
                                <div class="slot-bar">
                                    <div class="slot-progress" style="width: ${(count / Math.max(...Object.values(stats.slotStats))) * 100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>üìÖ ÈÄ±Âà•ÂàÜÈÖçÂ±•Ê≠¥</h3>
                    <div class="week-stats">
                        ${Object.entries(stats.weekStats).map(([week, count]) => `
                            <div class="week-stat-item">
                                <span class="week-number">Á¨¨${week}ÈÄ±:</span>
                                <span class="week-count">${count}‰ª∂</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="section">
                    <h3>üèÜ ÂàÜÈÖç„Çµ„Éû„É™„Éº</h3>
                    <div class="summary-stats">
                        <div class="summary-item">
                            <h4>Á∑èÂàÜÈÖçÊï∞</h4>
                            <div class="summary-value">${allocations.length}‰ª∂</div>
                        </div>
                        <div class="summary-item">
                            <h4>Âπ≥ÂùáÂèñÂæóÊï∞</h4>
                            <div class="summary-value">${(allocations.length / Object.keys(players).length).toFixed(1)}‰ª∂/‰∫∫</div>
                        </div>
                        <div class="summary-item">
                            <h4>Ê¥ªÂãïÈÄ±Êï∞</h4>
                            <div class="summary-value">${Object.keys(stats.weekStats).length}ÈÄ±</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Áµ±Ë®à„Éá„Éº„ÇøË®àÁÆó
        function calculateStatistics(players, allocations) {
            const playerStats = {};
            const slotStats = {};
            const weekStats = {};
            
            // „Éó„É¨„Ç§„É§„ÉºÁµ±Ë®àÂàùÊúüÂåñ
            Object.entries(players).forEach(([position, player]) => {
                playerStats[position] = {
                    name: player.name,
                    equipmentCount: 0,
                    materialCount: 0,
                    totalCount: 0,
                    dynamicPriority: player.dynamicPriority || 0
                };
            });
            
            // ÂàÜÈÖçÂ±•Ê≠¥„Åã„ÇâÁµ±Ë®àË®àÁÆó
            allocations.forEach(allocation => {
                const position = allocation.position;
                const slot = allocation.slot;
                const week = allocation.week;
                
                // „Éó„É¨„Ç§„É§„ÉºÁµ±Ë®àÊõ¥Êñ∞
                if (playerStats[position]) {
                    if (['Ê≠¶Âô®Áü≥', 'Á°¨ÂåñËñ¨', 'Âº∑ÂåñËñ¨', 'Âº∑ÂåñÁπäÁ∂≠'].includes(slot)) {
                        playerStats[position].materialCount++;
                    } else {
                        playerStats[position].equipmentCount++;
                    }
                    playerStats[position].totalCount++;
                }
                
                // ÈÉ®‰ΩçÁµ±Ë®àÊõ¥Êñ∞
                slotStats[slot] = (slotStats[slot] || 0) + 1;
                
                // ÈÄ±Áµ±Ë®àÊõ¥Êñ∞
                weekStats[week] = (weekStats[week] || 0) + 1;
            });
            
            return { playerStats, slotStats, weekStats };
        }
        
        // ÂàÜÈÖçÂ±•Ê≠¥Ë°®Á§∫
        function showAllocationHistory() {
            const content = document.getElementById('content');
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            content.innerHTML = `
                <h1>ÂàÜÈÖçÂ±•Ê≠¥</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">„É¨„Ç§„Éâ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>„Éï„Ç£„É´„Çø„Éº</h3>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>Â±§:</label>
                            <select id="layerFilter" onchange="filterAllocationHistory()">
                                <option value="">ÂÖ®„Å¶</option>
                                <option value="1">1Â±§</option>
                                <option value="2">2Â±§</option>
                                <option value="3">3Â±§</option>
                                <option value="4">4Â±§</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>ÂèñÂæóËÄÖ:</label>
                            <select id="playerFilter" onchange="filterAllocationHistory()">
                                <option value="">ÂÖ®„Å¶</option>
                                ${Object.entries(players).map(([position, player]) => `
                                    <option value="${position}">${player.name} (${position})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Ë£ÖÂÇôÈÉ®‰Ωç:</label>
                            <select id="slotFilter" onchange="filterAllocationHistory()">
                                <option value="">ÂÖ®„Å¶</option>
                                <option value="Ê≠¶Âô®">Ê≠¶Âô®</option>
                                <option value="È†≠">È†≠</option>
                                <option value="ËÉ¥">ËÉ¥</option>
                                <option value="Êâã">Êâã</option>
                                <option value="ËÑö">ËÑö</option>
                                <option value="Ë∂≥">Ë∂≥</option>
                                <option value="ËÄ≥">ËÄ≥</option>
                                <option value="È¶ñ">È¶ñ</option>
                                <option value="ËÖï">ËÖï</option>
                                <option value="Êåá">Êåá</option>
                                <option value="Ê≠¶Âô®Áü≥">Ê≠¶Âô®Áü≥</option>
                                <option value="Á°¨ÂåñËñ¨">Á°¨ÂåñËñ¨</option>
                                <option value="Âº∑ÂåñËñ¨">Âº∑ÂåñËñ¨</option>
                                <option value="Âº∑ÂåñÁπäÁ∂≠">Âº∑ÂåñÁπäÁ∂≠</option>
                            </select>
                        </div>
                        
                        <button onclick="clearAllFilters()" class="clear-filters-btn">
                            „Éï„Ç£„É´„Çø„Éº„ÇØ„É™„Ç¢
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ÂàÜÈÖçÂ±•Ê≠¥ (${allocations.length}‰ª∂)</h3>
                    <div id="historyTable">
                        ${generateHistoryTable(allocations, players)}
                    </div>
                </div>
            `;
        }
        
        // Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´ÁîüÊàê
        function generateHistoryTable(allocations, players) {
            if (allocations.length === 0) {
                return '<p class="no-data">ÂàÜÈÖçÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            }
            
            // Êó•‰ªòÈ†Ü„ÅßÈôçÈ†Ü„ÇΩ„Éº„Éà
            const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            return `
                <div class="history-table">
                    <div class="history-header">
                        <div class="history-cell">Êó•ÊôÇ</div>
                        <div class="history-cell">Â±§</div>
                        <div class="history-cell">Ë£ÖÂÇôÈÉ®‰Ωç</div>
                        <div class="history-cell">ÂèñÂæóËÄÖ</div>
                    </div>
                    ${sortedAllocations.map(allocation => {
                        const player = players[allocation.position];
                        const date = new Date(allocation.timestamp);
                        return `
                            <div class="history-row">
                                <div class="history-cell">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
                                <div class="history-cell">${allocation.layer}Â±§</div>
                                <div class="history-cell">${allocation.slot}</div>
                                <div class="history-cell">${player ? player.name : allocation.playerName} (${allocation.position})</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // Â±•Ê≠¥„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterAllocationHistory() {
            const layerFilter = document.getElementById('layerFilter').value;
            const playerFilter = document.getElementById('playerFilter').value;
            const slotFilter = document.getElementById('slotFilter').value;
            
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            let filteredAllocations = allocations.filter(allocation => {
                if (layerFilter && allocation.layer.toString() !== layerFilter) return false;
                if (playerFilter && allocation.position !== playerFilter) return false;
                if (slotFilter && allocation.slot !== slotFilter) return false;
                return true;
            });
            
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = generateHistoryTable(filteredAllocations, players);
            
            // „Éï„Ç£„É´„Çø„ÉºÁµêÊûú„ÅÆ‰ª∂Êï∞„ÇíÊõ¥Êñ∞
            const sectionTitle = document.querySelector('h3');
            sectionTitle.textContent = `ÂàÜÈÖçÂ±•Ê≠¥ (${filteredAllocations.length}‰ª∂)`;
        }
        
        // ÂÖ®„Éï„Ç£„É´„Çø„Éº„ÇØ„É™„Ç¢
        function clearAllFilters() {
            document.getElementById('layerFilter').value = '';
            document.getElementById('playerFilter').value = '';
            document.getElementById('slotFilter').value = '';
            filterAllocationHistory();
        }
        
        function showSystemSettings() {
            showMessage('„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆöÊ©üËÉΩ„ÅØÂÆüË£Ö‰∏≠„Åß„Åô', 'info');
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ff14_raid_data_${currentTeamId}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSuccess('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
        }
    </script>
</body>
</html>