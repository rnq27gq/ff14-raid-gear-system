<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://*.supabase.co https://supabase.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
    <title>FF14 零式装備分配システム (Supabase版)</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script>
        // Supabaseライブラリの読み込み確認
        window.addEventListener('load', function() {
            console.log('Supabase library loaded:', typeof window.supabase !== 'undefined');
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase version:', window.supabase.createClient ? 'OK' : 'No createClient method');
            }
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.4;
            height: 100vh;
            overflow-x: auto;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 20px);
            overflow-y: auto;
        }
        
        /* Supabase認証用のヘッダー */
        .supabase-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 10px 20px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ダッシュボード用スタイル */
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px;
            min-width: 120px;
        }
        
        .dashboard-layer-button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .supabase-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: white;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .connection-indicator.online {
            background-color: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }
        
        .connection-indicator.offline {
            background-color: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }
        
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-input {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .auth-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            background-color: #4a9d6b;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #3e8a57;
        }
        
        .auth-btn.logout {
            background-color: #d86a5a;
        }
        
        .auth-btn.logout:hover {
            background-color: #b85a4a;
        }
        
        /* 認証画面 */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
        }
        
        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-card h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .auth-form button {
            padding: 12px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .auth-form button:hover {
            background-color: #219a52;
        }
        
        .demo-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }
        
        /* メインコンテンツエリア */
        .main-content {
            display: none;
        }
        
        .main-content.authenticated {
            display: block;
        }
        
        /* 既存のcollaborative_index.htmlのスタイルを統合 */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .player-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        .position-badge {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .job-select {
            width: 100%;
            margin: 5px 0;
        }
        .equipment-policy {
            margin: 10px 0;
        }
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }
        .policy-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .policy-item label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        .policy-item select {
            width: 100%;
            padding: 6px;
            font-size: 0.8rem;
            margin: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* 装備方針の背景色 */
        .policy-item select option[value="零式"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select option[value="トームストーン"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        .policy-item select[value="零式"] {
            background-color: #e8f5e8;
            color: #2d5b2d;
        }
        .policy-item select[value="トームストーン"] {
            background-color: #fff3e0;
            color: #8b4513;
        }
        
        /* タブ関連スタイル */
        .tab-container {
            margin: 20px 0;
        }
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }
        .tab-content {
            min-height: 400px;
        }
        
        /* 層選択関連 */
        .layer-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .layer-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .layer-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .layer-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-align: center;
        }
        .layer-content {
            padding: 15px;
        }
        
        /* 優先度設定関連 */
        .priority-container {
            max-width: 600px;
            margin: 20px auto;
        }
        .priority-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: move;
            transition: all 0.2s ease;
        }
        .priority-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        .priority-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .priority-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .position-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .player-details {
            font-size: 0.9rem;
            color: #666;
        }
        .drag-handle {
            color: #999;
            font-size: 20px;
            cursor: move;
        }
        
        /* 武器希望関連 */
        .weapon-wishes {
            margin: 10px 0;
        }
        .wish-priority {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wish-priority label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #555;
        }
        .wish-priority select,
        .wish-priority input {
            flex: 1;
            min-width: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .wish-priority select option {
            font-size: 0.85rem;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        h2 {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }
        .section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        input, select {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            color: #333;
            width: 200px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 12px 0;
        }
        .tier-item {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tier-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .tier-item.active {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }
        .tier-item h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .tier-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .navigation-top-left {
            display: flex;
            justify-content: flex-start;
            margin: 10px 0 20px 0;
        }
        
        .dashboard-layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .dashboard-layer-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .dashboard-layer-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }
        
        /* 統計情報用スタイル */
        .player-stats-table {
            display: grid;
            grid-template-columns: 150px repeat(14, 1fr);
            gap: 1px;
            background-color: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .stats-header {
            display: contents;
        }
        
        .stats-header > div {
            background-color: #4a9d6b;
            color: white;
            padding: 10px 5px;
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .stats-row {
            display: contents;
        }
        
        .player-name-col {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            border-right: 2px solid #dee2e6;
        }
        
        .slot-col {
            background-color: white;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .slot-col.acquired {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .slot-col.not-acquired {
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .slot-col.tome-exchange {
            background-color: #fff3cd;
            color: #856404;
            font-weight: bold;
        }
        
        .slot-col.tome-exchange-completed {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        
        /* 編集モード用スタイル */
        .editable-slot {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .editable-slot:hover {
            opacity: 0.8;
        }
        
        .checkbox-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 100%;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin: 0 0 4px 0;
            transform: scale(1.2);
            cursor: pointer;
        }
        
        .checkbox-container .status-text {
            font-size: 0.7rem;
            text-align: center;
        }
        
        .checkmark {
            display: none;
        }
        
        .edit-button, .save-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }
        
        .edit-button:hover, .save-button:hover {
            background-color: #218838;
        }
        
        .save-button {
            background-color: #007bff;
        }
        
        .save-button:hover {
            background-color: #0056b3;
        }
        
        /* フォーム用スタイル */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .primary-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        
        .secondary-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .secondary-btn:hover {
            background-color: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(149, 165, 166, 0.3);
        }
        
        /* 優先順位設定用スタイル */
        .priority-container {
            max-width: 100%;
            margin: 15px 0;
            width: 100%;
            display: block;
        }
        
        .priority-list {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 8px;
            justify-content: flex-start;
            align-items: center;
            min-height: auto;
            overflow-x: auto;
            width: 100%;
        }
        
        .priority-item {
            background-color: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            margin: 0;
            padding: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
            min-width: 70px;
            width: 70px;
            height: 70px;
            text-align: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .priority-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            border-color: #007bff;
        }
        
        .priority-item:active {
            cursor: grabbing;
        }
        
        .priority-item.dragging {
            opacity: 0.7;
            transform: rotate(5deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            z-index: 1000;
        }
        
        .priority-item.drag-over {
            border-color: #28a745;
            background-color: #f8fff8;
            transform: scale(1.02);
        }
        
        .priority-rank {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 9px;
            position: absolute;
            top: 1px;
            left: 1px;
        }
        
        .priority-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            margin-top: 12px;
        }
        
        .priority-info .position-badge {
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 11px;
        }
        
        /* ロール別色分け - 共通定義 */
        .position-badge.tank, .role-tank, .priority-info .position-badge.tank {
            background-color: #3498db; /* タンク: 青 */
            color: white;
        }
        
        .position-badge.healer, .role-healer, .priority-info .position-badge.healer {
            background-color: #27ae60; /* ヒーラー: 緑 */
            color: white;
        }
        
        .position-badge.dps, .role-dps, .priority-info .position-badge.dps {
            background-color: #e67e22; /* DPS: 柔らかい赤（オレンジ寄り） */
            color: white;
        }
        
        .priority-info .player-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 11px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }
        
        .priority-info .player-job {
            color: #6c757d;
            font-size: 10px;
            font-weight: 500;
            line-height: 1.1;
        }
        
        .drag-handle {
            color: #007bff;
            font-size: 10px;
            cursor: grab;
            transition: all 0.2s ease;
            padding: 1px;
            border-radius: 3px;
            position: absolute;
            bottom: 1px;
            right: 1px;
        }
        
        .drag-handle:hover {
            color: #0056b3;
            background-color: rgba(0, 123, 255, 0.1);
            transform: scale(1.1);
        }
        
        .drag-handle:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        .priority-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .nav-button {
            background-color: #5a9fd4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #4a8bb8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* エラーメッセージ */
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .success-message {
            background-color: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        /* データ移行関連のスタイル */
        .migration-section {
            transition: all 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .migration-section:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .file-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-input-container input[type="file"] {
            transition: border-color 0.3s ease;
        }
        
        .file-input-container input[type="file"]:hover {
            border-color: #2980b9;
        }
        
        .csv-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }
        
        .csv-input-section {
            display: flex;
            flex-direction: column;
        }
        
        .csv-help-section {
            min-width: 200px;
        }
        
        .reset-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .reset-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .reset-warning {
            background-color: #fee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }
        
        .hints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .hint-card {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.2s ease;
        }
        
        .hint-card:hover {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        /* 装備分配関連のスタイル */
        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .layer-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .layer-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }
        
        .layer-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .layer-stats {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .allocation-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .allocation-choice {
            margin: 15px 0;
        }
        
        .allocation-choice select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .candidates-detail {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .candidate-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .no-candidates {
            color: #666;
            font-style: italic;
        }
        
        .weapon-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .weapon-selection h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .weapon-selection select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        .predicted-winner {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .judgment-details {
            margin-top: 15px;
        }
        
        .judgment-toggle {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            color: #000;
        }
        
        .judgment-toggle:hover {
            background: #e9ecef;
        }
        
        .judgment-content {
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .need-section, .greed-section, .pass-section {
            margin: 10px 0;
        }
        
        .need-section h6 {
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .greed-section h6 {
            color: #f39c12;
            margin-bottom: 8px;
        }
        
        .pass-section h6 {
            color: #95a5a6;
            margin-bottom: 8px;
        }
        
        .candidate-item.need {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.greed {
            background: #fef9e7;
            border-left: 4px solid #f39c12;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        
        .candidate-item.pass {
            background: #f8f9fa;
            border-left: 4px solid #95a5a6;
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
            color: #666;
        }
        
        .allocation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .confirm-btn {
            background: #27ae60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .confirm-btn:hover {
            background: #2ecc71;
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        /* 統計関連のスタイル */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
        }
        
        .stat-details {
            margin-top: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slot-stats, .week-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .slot-stat-item, .week-stat-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .slot-name, .week-number {
            width: 100px;
            font-weight: 600;
        }
        
        .slot-count, .week-count {
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        
        .slot-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .slot-progress {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3498db;
            margin-top: 10px;
        }
        
        /* 履歴関連のスタイル */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-group select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .clear-filters-btn {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
        }
        
        /* タブ保存ボタン */
        .tab-save-button {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .save-btn:hover {
            background: #218838;
        }
        
        .history-table {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .history-header {
            background: #3498db;
            color: white;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
        }
        
        .history-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 1px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .history-row:hover {
            background: #e8f4fd;
        }
        
        .history-cell {
            padding: 10px;
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        @media (max-width: 768px) {
            .csv-container {
                grid-template-columns: 1fr;
            }
            
            .reset-buttons-container {
                grid-template-columns: 1fr;
            }
            
            .file-input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .layer-grid {
                grid-template-columns: 1fr;
            }
            
            .allocation-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .history-header, .history-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .history-cell {
                border-bottom: 1px solid #e9ecef;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Supabase認証ヘッダー -->
        <div class="supabase-header">
            <div class="supabase-status">
                <h1 style="margin: 0; font-size: 18px;">FF14 零式装備分配システム</h1>
                <div id="connectionStatus" class="connection-indicator offline">
                    <span>⚫</span>
                    <span>オフライン</span>
                </div>
                <div id="teamInfo" style="display: none;">
                    <span id="currentTeamName">チーム名</span>
                </div>
            </div>
            
            
            <div class="auth-controls" id="loggedInControls" style="display: none;">
                <span id="loggedInTeam">demo-team</span>
                <button class="auth-btn logout" onclick="logout()">ログアウト</button>
            </div>
        </div>
        
        <!-- エラー・成功メッセージ -->
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- 認証画面 -->
        <div id="authScreen" class="auth-screen">
            <div class="auth-card">
                <h2>🛡️ チーム認証</h2>
                <p>8人での共同利用には<br>チームIDとパスワードが必要です</p>
                
                <div class="auth-form">
                    <input type="text" id="mainTeamIdInput" placeholder="チームID (例: my-raid-team)" maxlength="20">
                    <input type="password" id="mainPasswordInput" placeholder="パスワード" maxlength="20">
                    <button onclick="authenticateTeam()">ログイン</button>
                </div>
                
                <div class="demo-info">
                    <strong>🎮 デモ用アカウント</strong><br>
                    チームID: <code>demo-team</code><br>
                    パスワード: <code>demo123</code>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p><a href="#" onclick="showSignupForm()" style="color: #3498db; text-decoration: none;">新しいチームを作成</a> | 
                    <a href="#" onclick="showPasswordResetForm()" style="color: #e74c3c; text-decoration: none;">パスワードを忘れた場合</a></p>
                </div>
            </div>
        </div>
        
        <!-- 新規登録画面 -->
        <div id="signupScreen" class="auth-screen" style="display: none;">
            <div class="auth-container">
                <h1>🛡️ 新しいチーム作成</h1>
                <p style="margin-bottom: 30px; color: #666;">
                    FF14零式装備分配システム用の<br>新しいチームを作成します
                </p>
                
                <div class="auth-form">
                    <input type="text" id="signupTeamIdInput" placeholder="チームID (英数字、3-20文字)" maxlength="20">
                    <input type="text" id="signupCreatedByInput" placeholder="作成者名 (パスワードリセット時に使用)" maxlength="50">
                    <input type="password" id="signupPasswordInput" placeholder="パスワード (6文字以上)" maxlength="20">
                    <input type="password" id="signupPasswordConfirmInput" placeholder="パスワード確認" maxlength="20">
                    
                    <div style="margin: 15px 0; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem;">セキュリティ質問 (パスワードリセット用)</label>
                        <select id="signupSecurityQuestionSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="">セキュリティ質問を選択してください</option>
                            <option value="favorite_job">好きなジョブは何ですか？</option>
                            <option value="first_datacenter">最初にプレイしたデータセンターは？</option>
                            <option value="main_character">メインキャラクターの名前は？</option>
                            <option value="favorite_raid">好きな零式レイドは？</option>
                            <option value="fc_name">所属FCの名前は？</option>
                            <option value="custom">カスタム質問を入力</option>
                        </select>
                    </div>
                    
                    <input type="text" id="signupCustomQuestionInput" placeholder="カスタム質問を入力してください" style="display: none;" maxlength="100">
                    <input type="text" id="signupSecurityAnswerInput" placeholder="セキュリティ質問の答え" maxlength="50">
                    
                    <button onclick="createNewTeam()">チーム作成</button>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p><a href="#" onclick="showLoginForm()" style="color: #3498db; text-decoration: none;">既存チームでログイン</a></p>
                </div>
                
                <div style="margin-top: 20px; font-size: 11px; color: #999; line-height: 1.4;">
                    <p>・チームIDは他のチームと重複できません<br>
                    ・パスワードは安全に管理してください<br>
                    ・作成後は8人で共有してご利用ください</p>
                </div>
            </div>
        </div>
        
        <!-- パスワードリセット画面 -->
        <div id="passwordResetScreen" class="auth-screen" style="display: none;">
            <div class="auth-container">
                <h1>🔑 パスワードリセット</h1>
                <p style="margin-bottom: 30px; color: #666;">
                    セキュリティ質問に答えて<br>パスワードをリセットします
                </p>
                
                <!-- ステップ1: チームIDとセキュリティ質問確認 -->
                <div id="resetStep1" class="auth-form">
                    <input type="text" id="resetTeamIdInput" placeholder="チームID" maxlength="20">
                    <button onclick="getSecurityQuestion()">セキュリティ質問を取得</button>
                </div>
                
                <!-- ステップ2: セキュリティ質問回答 -->
                <div id="resetStep2" class="auth-form" style="display: none;">
                    <div id="teamInfoDisplay" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; text-align: left;">
                        <!-- チーム情報がここに表示される -->
                    </div>
                    <div id="securityQuestionDisplay" style="margin-bottom: 15px; color: #666; font-weight: bold;">
                        <!-- セキュリティ質問がここに表示される -->
                    </div>
                    <input type="text" id="resetSecurityAnswerInput" placeholder="セキュリティ質問の答え" maxlength="50">
                    <button onclick="verifySecurityAnswer()">答えを確認</button>
                </div>
                
                <!-- ステップ3: 新しいパスワード設定 -->
                <div id="resetStep3" class="auth-form" style="display: none;">
                    <div style="margin-bottom: 20px; color: #27ae60; font-weight: bold;">
                        ✅ セキュリティ質問の確認が完了しました
                    </div>
                    <input type="password" id="resetNewPasswordInput" placeholder="新しいパスワード (6文字以上)" maxlength="20">
                    <input type="password" id="resetNewPasswordConfirmInput" placeholder="新しいパスワード確認" maxlength="20">
                    <button onclick="executePasswordReset()">パスワードを変更</button>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: #888;">
                    <p><a href="#" onclick="showLoginForm()" style="color: #3498db; text-decoration: none;">ログイン画面に戻る</a></p>
                </div>
                
                <div style="margin-top: 20px; font-size: 11px; color: #999; line-height: 1.4;">
                    <p>・チーム作成時に設定したセキュリティ質問が必要です<br>
                    ・セキュリティ質問の答えを忘れた場合は、チーム作成者に相談してください<br>
                    ・パスワードリセット後は新しいパスワードでログインしてください</p>
                </div>
            </div>
        </div>
        
        <!-- メインコンテンツ（認証後に表示） -->
        <div id="mainContent" class="main-content">
            <div id="content">
                <!-- 初期表示はダッシュボード -->
            </div>
        </div>
    </div>

    <!-- Supabase認証情報（GitHub Secrets経由で注入） -->
    <script>
        // GitHub Actionsによってデプロイ時に認証情報が注入されます
        window.SUPABASE_CONFIG = {
            SUPABASE_URL: 'https://bpzvuwhnjvbfohopeoxr.supabase.co',
            SUPABASE_ANON_KEY: null, // GitHub Actionsで置換される
            DEMO_TEAM_ID: 'demo-team',
            DEMO_PASSWORD: 'demo123'
        };
    </script>
    
    <!-- Supabase設定とメイン機能 -->
    <script>
        // グローバル変数
        let isAuthenticated = false;
        let currentTeamId = null;
        let isInitializing = false;
        let isInitialized = false;
        let selectedDirectWeapon = ''; // 直ドロップ武器の選択状態を保持
        
        // ロール判定用共通関数
        function getPositionRoleClass(position) {
            if (position === 'MT' || position === 'ST') {
                return 'tank';
            } else if (position === 'H1' || position === 'H2') {
                return 'healer';
            } else if (position.startsWith('D')) {
                return 'dps';
            }
            return '';
        }
        
        // 初期化 - ライブラリ読み込み完了を待つ
        window.addEventListener('load', async function() {
            if (!isInitialized && !isInitializing) {
                // ローディング表示
                showMessage('システム初期化中...', 'info');
                
                // 少し待ってからアプリ初期化
                setTimeout(async () => {
                    await initializeApp();
                }, 100);
            }
        });
        
        // DOMContentLoadedでも初期化を試行（ハードリロード対策）
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded: DOM準備完了');
            if (!isInitialized && !isInitializing && !window.supabaseClient) {
                showMessage('システム初期化中...', 'info');
                // DOM要素の存在確認
                setTimeout(async () => {
                    console.log('DOM要素確認後の初期化開始');
                    await initializeApp();
                }, 300);
            }
        });
        
        // アプリ初期化
        async function initializeApp() {
            // 重複初期化防止
            if (isInitializing || isInitialized) {
                console.log('初期化スキップ: 既に初期化済みまたは初期化中');
                return;
            }
            
            isInitializing = true;
            
            try {
                console.log('アプリ初期化開始');
                
                // Supabaseクライアントが既に存在する場合はスキップ
                if (window.supabaseClient) {
                    console.log('Supabaseクライアント既存のため初期化スキップ');
                    isInitialized = true;
                    isInitializing = false;
                    await tryAutoLogin();
                    return;
                }
                
                // Supabaseライブラリの確認
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase JavaScriptライブラリが読み込まれていません');
                }
                
                console.log('Supabaseライブラリ確認完了');
                
                // Supabaseクライアント作成（機密情報は外部ファイルから）
                const supabaseUrl = window.SUPABASE_CONFIG?.SUPABASE_URL;
                const supabaseKey = window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Supabase認証情報が設定されていません。GitHub Secretsの設定を確認してください。');
                }
                
                window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントの作成に失敗しました');
                }
                
                console.log('Supabaseクライアント作成完了');
                
                // 接続状態更新
                updateConnectionStatus(true);
                
                // 自動ログイン試行
                await tryAutoLogin();
                
                console.log('アプリ初期化完了');
                
                // 初期化完了フラグ設定
                isInitialized = true;
                isInitializing = false;
                
            } catch (error) {
                console.error('アプリ初期化エラー:', error);
                showError('システムの初期化に失敗しました: ' + error.message);
                updateConnectionStatus(false);
                
                // 初期化失敗時はフラグをリセット
                isInitializing = false;
            }
        }
        
        // 自動ログイン試行
        async function tryAutoLogin() {
            const savedTeamId = localStorage.getItem('ff14_team_id');
            if (savedTeamId) {
                console.log('自動ログイン開始:', savedTeamId);
                currentTeamId = savedTeamId;
                
                // チームコンテキスト設定
                try {
                    const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                        team_id: savedTeamId
                    });
                    
                    if (contextError) {
                        console.error('コンテキスト設定エラー:', contextError);
                    } else {
                        console.log('チームコンテキスト設定完了');
                    }
                } catch (error) {
                    console.error('自動ログイン中のコンテキスト設定エラー:', error);
                }
                
                await showAuthenticatedState();
                
                // メイン機能の初期化
                await initializeMainFeatures();
                
                console.log('自動ログイン完了');
            }
        }
        
        // チーム認証
        async function authenticateTeam() {
            const teamId = document.getElementById('mainTeamIdInput')?.value;
            const password = document.getElementById('mainPasswordInput')?.value;
            
            if (!teamId || !password) {
                showError('チームIDとパスワードを入力してください');
                return;
            }
            
            try {
                showMessage('認証中...', 'info');
                
                // Supabaseクライアント確認
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントが初期化されていません');
                }
                
                console.log('認証試行:', teamId);
                
                // Supabase認証
                const { data, error } = await window.supabaseClient.rpc('authenticate_team', {
                    p_team_id: teamId,
                    p_password: password
                });
                
                console.log('認証結果:', { data, error });
                
                if (error) {
                    throw new Error(`認証エラー: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('チームIDまたはパスワードが正しくありません');
                }
                
                // 認証成功
                currentTeamId = teamId;
                localStorage.setItem('ff14_team_id', teamId);
                
                // チームコンテキスト設定
                console.log('チームコンテキスト設定中...');
                const { data: contextData, error: contextError } = await window.supabaseClient.rpc('set_team_context', {
                    team_id: teamId
                });
                
                if (contextError) {
                    console.error('コンテキスト設定エラー:', contextError);
                } else {
                    console.log('チームコンテキスト設定完了');
                }
                
                await showAuthenticatedState();
                showSuccess('ログインしました');
                
                // メイン機能の初期化
                await initializeMainFeatures();
                
            } catch (error) {
                console.error('認証エラー:', error);
                showError('認証に失敗しました: ' + error.message);
            }
        }
        
        // 新規チーム作成
        async function createNewTeam() {
            const teamId = document.getElementById('signupTeamIdInput').value;
            const createdBy = document.getElementById('signupCreatedByInput').value;
            const password = document.getElementById('signupPasswordInput').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirmInput').value;
            const securityQuestionSelect = document.getElementById('signupSecurityQuestionSelect').value;
            const customQuestion = document.getElementById('signupCustomQuestionInput').value;
            const securityAnswer = document.getElementById('signupSecurityAnswerInput').value;
            
            // バリデーション
            if (!teamId || !createdBy || !password || !passwordConfirm || !securityQuestionSelect || !securityAnswer) {
                showError('すべての項目を入力してください');
                return;
            }
            
            if (teamId.length < 3) {
                showError('チームIDは3文字以上で入力してください');
                return;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(teamId)) {
                showError('チームIDは英数字、ハイフン、アンダースコアのみ使用可能です');
                return;
            }
            
            if (password.length < 6) {
                showError('パスワードは6文字以上で入力してください');
                return;
            }
            
            if (password !== passwordConfirm) {
                showError('パスワードが一致しません');
                return;
            }
            
            // セキュリティ質問の検証
            let finalSecurityQuestion;
            if (securityQuestionSelect === 'custom') {
                if (!customQuestion.trim()) {
                    showError('カスタム質問を入力してください');
                    return;
                }
                finalSecurityQuestion = customQuestion.trim();
            } else {
                const questionTexts = {
                    'favorite_job': '好きなジョブは何ですか？',
                    'first_datacenter': '最初にプレイしたデータセンターは？',
                    'main_character': 'メインキャラクターの名前は？',
                    'favorite_raid': '好きな零式レイドは？',
                    'fc_name': '所属FCの名前は？'
                };
                finalSecurityQuestion = questionTexts[securityQuestionSelect];
            }
            
            try {
                showMessage('チーム作成中...', 'info');
                
                // Supabaseクライアント確認
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントが初期化されていません');
                }
                
                console.log('チーム作成試行:', teamId);
                
                // Supabaseでセキュリティ質問付きチーム作成
                const { data, error } = await window.supabaseClient.rpc('create_team_with_security', {
                    p_team_id: teamId,
                    p_team_name: teamId, // チーム名はチームIDと同じに設定
                    p_password: password,
                    p_created_by: createdBy,
                    p_security_question: finalSecurityQuestion,
                    p_security_answer: securityAnswer
                });
                
                console.log('チーム作成結果:', { data, error });
                
                if (error) {
                    if (error.message.includes('already exists') || error.message.includes('duplicate')) {
                        throw new Error('このチームIDは既に使用されています');
                    }
                    throw new Error(`チーム作成エラー: ${error.message}`);
                }
                
                if (!data) {
                    throw new Error('チーム作成に失敗しました');
                }
                
                // 作成成功 - 自動ログイン
                showSuccess('チームが作成されました！自動ログインします...');
                
                // 少し待ってから自動ログイン
                setTimeout(async () => {
                    // 入力フィールドに値を設定
                    document.getElementById('mainTeamIdInput').value = teamId;
                    document.getElementById('mainPasswordInput').value = password;
                    
                    // ログイン画面に戻る
                    showLoginForm();
                    
                    // 自動ログイン
                    await authenticateTeam();
                }, 1000);
                
            } catch (error) {
                console.error('チーム作成エラー:', error);
                showError('チーム作成に失敗しました: ' + error.message);
            }
        }
        
        // 新規登録画面表示
        function showSignupForm() {
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'none';
            
            const signupScreen = document.getElementById('signupScreen');
            if (signupScreen) signupScreen.style.display = 'block';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'none';
            
            // 入力フィールドをクリア
            const signupTeamIdInput = document.getElementById('signupTeamIdInput');
            if (signupTeamIdInput) signupTeamIdInput.value = '';
            
            const signupPasswordInput = document.getElementById('signupPasswordInput');
            if (signupPasswordInput) signupPasswordInput.value = '';
            
            const signupPasswordConfirmInput = document.getElementById('signupPasswordConfirmInput');
            if (signupPasswordConfirmInput) signupPasswordConfirmInput.value = '';
        }
        
        // ログイン画面表示
        function showLoginForm() {
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'block';
            
            const signupScreen = document.getElementById('signupScreen');
            if (signupScreen) signupScreen.style.display = 'none';
            
            const passwordResetScreen = document.getElementById('passwordResetScreen');
            if (passwordResetScreen) passwordResetScreen.style.display = 'none';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'none';
        }
        
        // パスワードリセット画面表示
        function showPasswordResetForm() {
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'none';
            
            const signupScreen = document.getElementById('signupScreen');
            if (signupScreen) signupScreen.style.display = 'none';
            
            const passwordResetScreen = document.getElementById('passwordResetScreen');
            if (passwordResetScreen) passwordResetScreen.style.display = 'block';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.style.display = 'none';
            
            // リセット画面の初期化
            resetPasswordResetForm();
        }
        
        // 認証後の状態表示
        async function showAuthenticatedState() {
            isAuthenticated = true;
            
            // UI切り替え（安全な要素アクセス）
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'none';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.classList.add('authenticated');
                mainContent.style.display = 'block'; // Override inline style from showLoginForm
            }
            
            const loggedInControls = document.getElementById('loggedInControls');
            if (loggedInControls) loggedInControls.style.display = 'flex';
            
            const loggedInTeam = document.getElementById('loggedInTeam');
            if (loggedInTeam) loggedInTeam.textContent = currentTeamId;
            
            // チーム情報表示
            const teamInfo = document.getElementById('teamInfo');
            if (teamInfo) teamInfo.style.display = 'block';
            
            const currentTeamName = document.getElementById('currentTeamName');
            if (currentTeamName) currentTeamName.textContent = `チーム: ${currentTeamId}`;
        }
        
        // ログアウト
        function logout() {
            isAuthenticated = false;
            currentTeamId = null;
            
            // ローカルストレージクリア
            localStorage.removeItem('ff14_team_id');
            
            // UI切り替え（安全な要素アクセス）
            const authScreen = document.getElementById('authScreen');
            if (authScreen) authScreen.style.display = 'flex';
            
            const mainContent = document.getElementById('mainContent');
            if (mainContent) mainContent.classList.remove('authenticated');
            
            const loggedInControls = document.getElementById('loggedInControls');
            if (loggedInControls) loggedInControls.style.display = 'none';
            
            const teamInfo = document.getElementById('teamInfo');
            if (teamInfo) teamInfo.style.display = 'none';
            
            // 入力欄クリア（メイン認証フォームのみ）
            const mainTeamIdInput = document.getElementById('mainTeamIdInput');
            if (mainTeamIdInput) mainTeamIdInput.value = '';
            
            const mainPasswordInput = document.getElementById('mainPasswordInput');
            if (mainPasswordInput) mainPasswordInput.value = '';
            
            showSuccess('ログアウトしました');
        }
        
        // パスワードリセット関連関数
        
        // パスワードリセットフォームの初期化
        function resetPasswordResetForm() {
            // 全ステップを非表示にしてステップ1のみ表示
            document.getElementById('resetStep1').style.display = 'block';
            document.getElementById('resetStep2').style.display = 'none';
            document.getElementById('resetStep3').style.display = 'none';
            
            // 入力欄をクリア
            document.getElementById('resetTeamIdInput').value = '';
            document.getElementById('resetSecurityAnswerInput').value = '';
            document.getElementById('resetNewPasswordInput').value = '';
            document.getElementById('resetNewPasswordConfirmInput').value = '';
            
            // グローバル変数をクリア
            window.resetToken = null;
            window.resetTeamId = null;
        }
        
        // セキュリティ質問取得
        async function getSecurityQuestion() {
            const teamId = document.getElementById('resetTeamIdInput').value.trim();
            
            if (!teamId) {
                showError('チームIDを入力してください');
                return;
            }
            
            try {
                showMessage('チーム情報を取得中...', 'info');
                
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントが初期化されていません');
                }
                
                const { data, error } = await window.supabaseClient.rpc('get_team_reset_info', {
                    p_team_id: teamId
                });
                
                if (error) {
                    throw new Error(`チーム情報取得エラー: ${error.message}`);
                }
                
                if (!data || data.length === 0) {
                    showError('指定されたチームIDが見つかりません');
                    return;
                }
                
                const teamInfo = data[0];
                
                if (!teamInfo.security_question) {
                    showError('このチームにはセキュリティ質問が設定されていません。チーム作成者に相談してください。');
                    return;
                }
                
                // チーム情報とセキュリティ質問を表示
                const teamInfoDisplay = document.getElementById('teamInfoDisplay');
                teamInfoDisplay.innerHTML = `
                    <strong>チーム名:</strong> ${teamInfo.team_name}<br>
                    <strong>作成者:</strong> ${teamInfo.created_by || '未設定'}<br>
                    <strong>作成日:</strong> ${new Date(teamInfo.created_at).toLocaleDateString('ja-JP')}
                `;
                
                const securityQuestionDisplay = document.getElementById('securityQuestionDisplay');
                securityQuestionDisplay.textContent = `Q: ${teamInfo.security_question}`;
                
                // ステップ2を表示
                document.getElementById('resetStep1').style.display = 'none';
                document.getElementById('resetStep2').style.display = 'block';
                
                window.resetTeamId = teamId;
                showSuccess('セキュリティ質問を取得しました');
                
            } catch (error) {
                console.error('セキュリティ質問取得エラー:', error);
                showError('セキュリティ質問の取得に失敗しました: ' + error.message);
            }
        }
        
        // セキュリティ質問の答え確認
        async function verifySecurityAnswer() {
            const answer = document.getElementById('resetSecurityAnswerInput').value.trim();
            
            if (!answer) {
                showError('セキュリティ質問の答えを入力してください');
                return;
            }
            
            try {
                showMessage('セキュリティ質問を確認中...', 'info');
                
                if (!window.supabaseClient || !window.resetTeamId) {
                    throw new Error('システムエラーが発生しました');
                }
                
                const { data, error } = await window.supabaseClient.rpc('verify_security_answer', {
                    p_team_id: window.resetTeamId,
                    p_answer: answer
                });
                
                if (error) {
                    throw new Error(`セキュリティ質問確認エラー: ${error.message}`);
                }
                
                if (!data) {
                    showError('セキュリティ質問の答えが正しくありません');
                    return;
                }
                
                // リセットトークンを生成
                const tokenResult = await window.supabaseClient.rpc('generate_reset_token', {
                    p_team_id: window.resetTeamId
                });
                
                if (tokenResult.error) {
                    throw new Error(`トークン生成エラー: ${tokenResult.error.message}`);
                }
                
                window.resetToken = tokenResult.data;
                
                // ステップ3を表示
                document.getElementById('resetStep2').style.display = 'none';
                document.getElementById('resetStep3').style.display = 'block';
                
                showSuccess('セキュリティ質問の確認が完了しました');
                
            } catch (error) {
                console.error('セキュリティ質問確認エラー:', error);
                showError('セキュリティ質問の確認に失敗しました: ' + error.message);
            }
        }
        
        // パスワードリセット実行
        async function executePasswordReset() {
            const newPassword = document.getElementById('resetNewPasswordInput').value;
            const newPasswordConfirm = document.getElementById('resetNewPasswordConfirmInput').value;
            
            if (!newPassword || !newPasswordConfirm) {
                showError('新しいパスワードを入力してください');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('パスワードは6文字以上で入力してください');
                return;
            }
            
            if (newPassword !== newPasswordConfirm) {
                showError('パスワードが一致しません');
                return;
            }
            
            try {
                showMessage('パスワードをリセット中...', 'info');
                
                if (!window.supabaseClient || !window.resetTeamId || !window.resetToken) {
                    throw new Error('システムエラーが発生しました');
                }
                
                const { data, error } = await window.supabaseClient.rpc('reset_password', {
                    p_team_id: window.resetTeamId,
                    p_token: window.resetToken,
                    p_new_password: newPassword
                });
                
                if (error) {
                    throw new Error(`パスワードリセットエラー: ${error.message}`);
                }
                
                if (!data) {
                    showError('パスワードリセットに失敗しました。トークンの有効期限が切れている可能性があります。');
                    return;
                }
                
                showSuccess('パスワードが正常にリセットされました！新しいパスワードでログインしてください。');
                
                // ログイン画面に戻る
                setTimeout(() => {
                    showLoginForm();
                    // ログインフォームに新しい値を設定
                    document.getElementById('mainTeamIdInput').value = window.resetTeamId;
                }, 2000);
                
            } catch (error) {
                console.error('パスワードリセットエラー:', error);
                showError('パスワードリセットに失敗しました: ' + error.message);
            }
        }
        
        // データベース接続テスト
        async function testDatabaseConnection() {
            if (!isAuthenticated) {
                showError('先にログインしてください');
                return;
            }
            
            try {
                showMessage('データベースに接続中...', 'info');
                
                // Supabaseクライアント確認
                if (!window.supabaseClient) {
                    throw new Error('Supabaseクライアントが初期化されていません');
                }
                
                // テストデータの保存
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'データベース接続テスト成功'
                };
                
                console.log('テストデータ保存中...');
                
                const { data: saveData, error: saveError } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: 'test-tier',
                        data_type: 'settings',
                        content: testData
                    });
                
                if (saveError) {
                    throw new Error(`保存エラー: ${saveError.message}`);
                }
                
                console.log('テストデータ読み込み中...');
                
                // テストデータの読み込み
                const { data: loadData, error: loadError } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', 'test-tier')
                    .eq('data_type', 'settings');
                
                if (loadError) {
                    throw new Error(`読み込みエラー: ${loadError.message}`);
                }
                
                console.log('読み込み結果:', loadData);
                
                if (loadData && loadData.length > 0) {
                    showSuccess('データベース接続テスト成功！データの保存・読み込みが正常に動作しています。');
                } else {
                    throw new Error('データの読み込みに失敗しました');
                }
                
            } catch (error) {
                console.error('データベーステストエラー:', error);
                showError('データベーステストに失敗しました: ' + error.message);
            }
        }
        
        // 接続状態更新
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                indicator.innerHTML = '<span>🟢</span><span>オンライン</span>';
            } else {
                indicator.className = 'connection-indicator offline';
                indicator.innerHTML = '<span>⚫</span><span>オフライン</span>';
            }
        }
        
        // メッセージ表示関数
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showMessage(message, type) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            // 全メッセージを隠す
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            if (type === 'error') {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            } else if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => successEl.style.display = 'none', 3000);
            }
        }
        
        // エラーハンドリング
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未処理のエラー:', event.reason);
            showError('予期しないエラーが発生しました');
        });
        
        // ======================
        // メイン機能の実装
        // ======================
        
        // グローバル変数
        let currentRaidTier = null;
        let appData = {
            raidTiers: {},
            players: {},
            allocations: {},
            settings: {}
        };
        
        // メイン機能初期化
        async function initializeMainFeatures() {
            try {
                console.log('メイン機能初期化開始');
                
                // データ読み込み
                await loadAllData();
                
                // ダッシュボード表示
                showMainDashboard();
                
                console.log('メイン機能初期化完了');
            } catch (error) {
                console.error('メイン機能初期化エラー:', error);
                showError('メイン機能の初期化に失敗しました: ' + error.message);
                
                // エラーが発生してもダッシュボードを表示（空のデータで）
                try {
                    console.log('フォールバック: 空のデータでダッシュボード表示');
                    showMainDashboard();
                } catch (fallbackError) {
                    console.error('フォールバック処理エラー:', fallbackError);
                }
            }
        }
        
        // 全データ読み込み
        async function loadAllData() {
            try {
                // Supabaseからデータ読み込み
                const { data: allData, error } = await window.supabaseClient
                    .from('raid_data')
                    .select('*')
                    .eq('team_id', currentTeamId);
                
                if (error) {
                    throw new Error(`データ読み込みエラー: ${error.message}`);
                }
                
                console.log('読み込みデータ:', allData);
                
                // データ種別ごとに分類
                if (allData && allData.length > 0) {
                    allData.forEach(item => {
                        const { tier_id, data_type, content } = item;
                        
                        if (data_type === 'settings') {
                            // 設定データの特殊処理
                            if (content.raidTier) {
                                // レイドティアデータ
                                if (!appData.raidTiers) appData.raidTiers = {};
                                appData.raidTiers[tier_id] = content.raidTier;
                            } else {
                                // その他の設定
                                if (!appData.settings) appData.settings = {};
                                appData.settings = { ...appData.settings, ...content };
                            }
                        } else {
                            // その他のデータタイプ
                            if (!appData[data_type]) {
                                appData[data_type] = {};
                            }
                            appData[data_type][tier_id] = content;
                        }
                    });
                }
                
                console.log('整理済みデータ:', appData);
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                // 初期データで継続
                appData = {
                    raidTiers: {},
                    players: {},
                    allocations: {},
                    settings: {}
                };
            }
        }
        
        // メインダッシュボード表示
        function showMainDashboard() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>FF14 零式装備分配システム</h1>
                <h2>チーム: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>レイド選択</h3>
                    <div class="tier-list" id="tierList">
                        <!-- レイドティア一覧がここに表示されます -->
                    </div>
                    
                    <div class="navigation">
                        <button class="nav-button" onclick="createNewTier()">新しいレイドティアを作成</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>管理機能</h3>
                    <div class="navigation">
                        <button class="nav-button" onclick="showSystemSettings()">システム設定</button>
                        <button class="nav-button" onclick="exportAllData()">データエクスポート</button>
                        <button class="nav-button" onclick="testDatabaseConnection()">接続テスト</button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #e8f5e8; border-color: #27ae60;">
                    <h3>実装完了機能</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Supabase連携・認証システム</li>
                        <li>チーム別データ管理</li>
                        <li>リアルタイムデータ同期</li>
                        <li>レイドティア管理</li>
                        <li>プレイヤー・装備管理</li>
                    </ul>
                </div>
            `;
            
            // レイドティア一覧を表示
            displayRaidTiers();
        }
        
        // レイドティア一覧表示
        function displayRaidTiers() {
            const tierList = document.getElementById('tierList');
            const tiers = appData.raidTiers || {};
            
            if (Object.keys(tiers).length === 0) {
                tierList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>まだレイドティアが作成されていません。</p>
                        <p>「新しいレイドティアを作成」ボタンから始めてください。</p>
                    </div>
                `;
                return;
            }
            
            tierList.innerHTML = Object.entries(tiers).map(([tierId, tier]) => `
                <div class="tier-item ${currentRaidTier?.id === tierId ? 'active' : ''}" 
                     onclick="selectRaidTier('${tierId}')">
                    <h3>${tier.name}</h3>
                    <p>${tier.description || '零式レイド'}</p>
                </div>
            `).join('');
        }
        
        // レイドティア選択
        async function selectRaidTier(tierId) {
            const tier = appData.raidTiers[tierId];
            if (!tier) {
                showError('レイドティアが見つかりません');
                return;
            }
            
            currentRaidTier = { id: tierId, ...tier };
            showSuccess(`レイドティア「${tier.name}」を選択しました`);
            
            // ティア固有のダッシュボードを表示
            showTierDashboard();
        }
        
        // ティア固有ダッシュボード
        function showTierDashboard() {
            if (!currentRaidTier) return;
            
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showMainDashboard()">レイド選択画面に戻る</button>
                </div>
                
                <h1>${currentRaidTier.name}</h1>
                <h2>チーム: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>装備分配</h3>
                    <div class="dashboard-layer-grid">
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(1)">1層</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(2)">2層</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(3)">3層</button>
                        <button class="dashboard-layer-button" onclick="showLayerAllocation(4)">4層</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showPlayerManagement()">メンバー管理</button>
                        <button class="nav-button" onclick="showPriorityManagement()">優先順位設定</button>
                        <button class="nav-button" onclick="showStatistics()">統計情報</button>
                        <button class="nav-button" onclick="showAllocationHistory()">配布履歴</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>レイド情報</h3>
                    <p><strong>レイド名:</strong> ${currentRaidTier.name}</p>
                    <p><strong>説明:</strong> ${currentRaidTier.description || '零式レイド'}</p>
                </div>
            `;
        }
        
        // 新しいレイド作成画面を表示
        function createNewTier() {
            showCreateTierForm();
        }
        
        // レイド作成フォーム表示
        function showCreateTierForm() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showMainDashboard()">レイド選択画面に戻る</button>
                </div>
                
                <h1>新しいレイドを作成</h1>
                <h2>チーム: ${currentTeamId}</h2>
                
                <div class="section">
                    <h3>レイド情報を入力してください</h3>
                    
                    <div class="form-grid" style="max-width: 600px;">
                        <div class="form-group">
                            <label for="tierName">レイド名（必須）:</label>
                            <input type="text" id="tierName" 
                                   placeholder="例：7.1 アークガーディアン零式" 
                                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                            <small style="color: #666; margin-top: 5px; display: block;">
                                パッチ番号やボス名を含めると分かりやすくなります
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="tierDescription">説明（省略可）:</label>
                            <textarea id="tierDescription" 
                                      placeholder="例：新パッチの零式コンテンツ、IL730装備がドロップ" 
                                      style="width: 100%; height: 80px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                空欄の場合は「零式レイド」が設定されます
                            </small>
                        </div>
                        
                        <div class="form-actions" style="margin-top: 30px;">
                            <button onclick="submitCreateTier()" class="primary-btn" style="margin-right: 15px;">
                                レイドを作成
                            </button>
                            <button onclick="showMainDashboard()" class="secondary-btn">
                                キャンセル
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="section" style="background-color: #f8f9fa; border-left: 4px solid #17a2b8;">
                    <h4>💡 作成後の流れ</h4>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>レイドを作成すると、そのレイド専用のダッシュボードに移動します</li>
                        <li>まずは「メンバー管理」から8人のメンバー情報を登録してください</li>
                        <li>装備方針や武器希望を設定して、装備分配を開始できます</li>
                    </ol>
                </div>
            `;
            
            // フォーカスを名前入力欄に設定
            setTimeout(() => {
                const nameInput = document.getElementById('tierName');
                if (nameInput) nameInput.focus();
            }, 100);
        }
        
        // レイド作成実行
        async function submitCreateTier() {
            const nameInput = document.getElementById('tierName');
            const descriptionInput = document.getElementById('tierDescription');
            
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim() || '零式レイド';
            
            if (!name) {
                showError('レイド名を入力してください。');
                nameInput.focus();
                return;
            }
            
            try {
                showMessage('レイドを作成中...', 'info');
                
                const tierId = 'tier_' + Date.now();
                const tierData = {
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString()
                };
                
                // Supabaseに保存
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .insert({
                        team_id: currentTeamId,
                        tier_id: tierId,
                        data_type: 'settings',
                        content: { raidTier: tierData }
                    });
                
                if (error) {
                    throw new Error(`保存エラー: ${error.message}`);
                }
                
                // ローカルデータ更新
                if (!appData.raidTiers) appData.raidTiers = {};
                appData.raidTiers[tierId] = tierData;
                
                showSuccess(`レイド「${name}」を作成しました`);
                
                // 作成したレイドを選択してダッシュボードに移動
                currentRaidTier = { id: tierId, ...tierData };
                showTierDashboard();
                
            } catch (error) {
                console.error('レイド作成エラー:', error);
                showError('レイドの作成に失敗しました: ' + error.message);
            }
        }
        
        // 優先順位管理画面
        function showPriorityManagement() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            
            if (Object.keys(players).length === 0) {
                showError('プレイヤー情報が設定されていません。まずメンバー管理から設定してください。');
                return;
            }
            
            // 現在の優先順位を取得（デフォルト: D1→D2→D3→D4→MT→ST→H1→H2）
            const defaultPriority = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            const currentPriority = appData.settings?.positionPriority || defaultPriority;
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                </div>
                
                <h1>ポジション間優先順位設定</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>ポジション間優先順位設定</h3>
                    <p>装備・素材すべての判定ロジックに作用する優先順位です。ドラッグ&ドロップで順序を変更できます。</p>
                    
                    <div class="priority-container">
                        <div class="priority-list" id="priorityList">
                            ${currentPriority.map((position, index) => {
                                const player = players[position];
                                if (!player) return '';
                                
                                // ロール別クラス判定
                                const roleClass = getPositionRoleClass(position);
                                
                                return `
                                    <div class="priority-item" data-position="${position}" draggable="true">
                                        <div class="priority-rank">${index + 1}</div>
                                        <div class="priority-info">
                                            <span class="position-badge ${roleClass}">${position}</span>
                                            <span class="player-name">${player.name}</span>
                                            <span class="player-job">[${player.job}]</span>
                                        </div>
                                        <div class="drag-handle">⋮⋮</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="priority-actions">
                        <button onclick="savePrioritySettings()" class="primary-btn">
                            優先順位を保存
                        </button>
                        <button onclick="resetPrioritySettings()" class="secondary-btn">
                            デフォルトに戻す
                        </button>
                    </div>
                </div>
                
                <div class="section" style="background-color: #f8f9fa; border-left: 4px solid #17a2b8;">
                    <h4>💡 優先順位の仕組み</h4>
                    <p><strong>装備分配：</strong> 装備方針（零式/トームストーン）とポジション優先順位の組み合わせで取得者を決定</p>
                    <p><strong>素材分配：</strong> ポジション優先順位に基づいて武器石、硬化薬、強化薬、強化繊維の取得者を決定</p>
                    <p><strong>武器分配：</strong> 武器希望順位とポジション優先順位の組み合わせで取得者を決定</p>
                    <p><strong>Note：</strong> 優先順位は装備・素材すべての判定ロジックに作用します。ドラッグ&ドロップで順序を調整できます。</p>
                </div>
            `;
            
            // ドラッグ&ドロップ機能を初期化
            initializeDragAndDrop();
        }
        
        // ドラッグ&ドロップ機能初期化
        function initializeDragAndDrop() {
            const priorityList = document.getElementById('priorityList');
            if (!priorityList) return;
            
            let draggedElement = null;
            
            priorityList.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('priority-item')) {
                    draggedElement = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });
            
            priorityList.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('priority-item')) {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                    // 全ての drag-over クラスを削除
                    document.querySelectorAll('.priority-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                }
            });
            
            priorityList.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // ドラッグされている要素以外にホバー効果を適用
                const closestItem = e.target.closest('.priority-item');
                if (closestItem && closestItem !== draggedElement) {
                    // 全ての drag-over クラスを削除
                    document.querySelectorAll('.priority-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                    // 現在の要素に drag-over クラスを追加
                    closestItem.classList.add('drag-over');
                }
            });
            
            priorityList.addEventListener('dragleave', function(e) {
                const closestItem = e.target.closest('.priority-item');
                if (closestItem && !priorityList.contains(e.relatedTarget)) {
                    closestItem.classList.remove('drag-over');
                }
            });
            
            priorityList.addEventListener('drop', function(e) {
                e.preventDefault();
                
                const closestItem = e.target.closest('.priority-item');
                if (draggedElement && closestItem && draggedElement !== closestItem) {
                    // ドロップ位置を計算
                    const rect = closestItem.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    
                    if (e.clientY < midpoint) {
                        // 上半分にドロップ - 前に挿入
                        priorityList.insertBefore(draggedElement, closestItem);
                    } else {
                        // 下半分にドロップ - 後に挿入
                        priorityList.insertBefore(draggedElement, closestItem.nextSibling);
                    }
                    
                    updatePriorityNumbers();
                }
                
                // 全ての drag-over クラスを削除
                document.querySelectorAll('.priority-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
            });
        }
        
        // 優先順位番号更新
        function updatePriorityNumbers() {
            const items = document.querySelectorAll('.priority-item');
            items.forEach((item, index) => {
                const rankElement = item.querySelector('.priority-rank');
                if (rankElement) {
                    rankElement.textContent = index + 1;
                }
            });
        }
        
        // 優先順位設定保存
        async function savePrioritySettings() {
            try {
                const items = document.querySelectorAll('.priority-item');
                const newPriority = Array.from(items).map(item => item.dataset.position);
                
                // 設定を保存
                if (!appData.settings) appData.settings = {};
                appData.settings.positionPriority = newPriority;
                
                // Supabaseに保存
                const { error } = await window.supabaseClient
                    .from('raid_data')
                    .upsert({
                        team_id: currentTeamId,
                        tier_id: currentRaidTier.id,
                        data_type: 'settings',
                        content: { positionPriority: newPriority }
                    });
                
                if (error) {
                    throw new Error(`保存エラー: ${error.message}`);
                }
                
                showSuccess('優先順位設定を保存しました');
                
            } catch (error) {
                console.error('優先順位保存エラー:', error);
                showError('優先順位設定の保存に失敗しました: ' + error.message);
            }
        }
        
        // 優先順位設定リセット
        async function resetPrioritySettings() {
            if (confirm('優先順位をデフォルト（D1→D2→D3→D4→MT→ST→H1→H2）に戻しますか？')) {
                const defaultPriority = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
                
                // 設定をリセット
                if (!appData.settings) {
                    appData.settings = {};
                }
                appData.settings.positionPriority = defaultPriority;
                
                // Supabaseに保存
                try {
                    await saveDataToSupabase('settings', { positionPriority: defaultPriority });
                    showSuccess('優先順位をデフォルトに戻しました');
                } catch (error) {
                    console.error('設定保存エラー:', error);
                    showError('設定の保存に失敗しました');
                }
                
                // 画面を再読み込み
                showPriorityManagement();
            }
        }
        
        // プレイヤー管理機能
        function showPlayerManagement() {
            showPlayerSetup();
        }
        
        // プレイヤー設定画面（タブ形式）
        function showPlayerSetup() {
            showTabbedSetup('players');
        }
        
        // タブ形式のセットアップ画面
        function showTabbedSetup(activeTab = 'players') {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <h1>メンバー・装備設定</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <div class="navigation">
                        <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button ${activeTab === 'players' ? 'active' : ''}" onclick="showTabbedSetup('players')">
                            メンバー情報
                        </button>
                        <button class="tab-button ${activeTab === 'policy' ? 'active' : ''}" onclick="showTabbedSetup('policy')">
                            装備方針
                        </button>
                        <button class="tab-button ${activeTab === 'weapons' ? 'active' : ''}" onclick="showTabbedSetup('weapons')">
                            武器希望
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        ${getTabContent(activeTab)}
                    </div>
                    
                    <div class="navigation" style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                        <button class="save-btn" onclick="saveCurrentTab('${activeTab}')">
                            ${activeTab === 'players' ? 'メンバー情報を保存' : activeTab === 'policy' ? '装備方針を保存' : '武器希望を保存'}
                        </button>
                        <button class="nav-button" onclick="saveCurrentTabAndContinue('${activeTab}')">
                            設定完了
                        </button>
                    </div>
                </div>
            `;
        }
        
        // タブコンテンツ生成
        function getTabContent(tabName) {
            const players = appData.players[currentRaidTier.id] || {};
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            
            if (tabName === 'players') {
                return `
                    <h3>8人のメンバー情報を入力してください</h3>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position] || {};
                            const roleJobs = {
                                'MT': ['ナイト', '戦士', '暗黒騎士', 'ガンブレイカー'],
                                'ST': ['ナイト', '戦士', '暗黒騎士', 'ガンブレイカー'],
                                'H1': ['白魔道士', '占星術士'],
                                'H2': ['学者', '賢者'],
                                'D1': ['モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー'],
                                'D2': ['モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー'],
                                'D3': ['吟遊詩人', '機工士', '踊り子'],
                                'D4': ['黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー']
                            };
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="position-badge ${getPositionRoleClass(position)}">${position}</span>
                                    </div>
                                    
                                    <div style="margin: 10px 0;">
                                        <label>プレイヤー名（必須）:</label>
                                        <input type="text" id="${position}-name" value="${player.name || ''}" 
                                               placeholder="プレイヤー名を入力" class="job-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;">
                                    </div>
                                    
                                    
                                    <div style="margin: 10px 0;">
                                        <label>ジョブ（必須）:</label>
                                        <select id="${position}-job" class="job-select">
                                            <option value="">ジョブを選択</option>
                                            ${roleJobs[position].map(job => `
                                                <option value="${job}" ${player.job === job ? 'selected' : ''}>${job}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'policy') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>まずメンバー情報タブでプレイヤー情報を設定してください。</p>
                        </div>
                    `;
                }
                
                const slots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
                
                return `
                    <h3>各プレイヤーの装備方針を設定</h3>
                    <p>零式：零式装備を優先取得、トームストーン：トームストーン装備で十分</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge ${getPositionRoleClass(position)}">${position} - ${player.job}</span>
                                    </div>
                                    <div class="equipment-policy">
                                        <div class="policy-grid">
                                            ${slots.map(slot => `
                                                <div class="policy-item">
                                                    <label>${slot}</label>
                                                    <select id="${position}-${slot}-policy">
                                                        <option value="零式" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === '零式') ? 'selected' : ''}>零式</option>
                                                        <option value="トームストーン" ${(player.equipmentPolicy && player.equipmentPolicy[slot] === 'トームストーン') ? 'selected' : ''}>トームストーン</option>
                                                    </select>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (tabName === 'weapons') {
                if (Object.keys(players).length === 0) {
                    return `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>まずメンバー情報タブでプレイヤー情報を設定してください。</p>
                        </div>
                    `;
                }
                
                const allWeapons = [
                    'ナイト', '戦士', '暗黒騎士', 'ガンブレイカー',
                    '白魔道士', '占星術士', '学者', '賢者',
                    'モンク', '竜騎士', '忍者', '侍', 'リーパー', 'ヴァイパー',
                    '黒魔道士', '召喚士', '赤魔道士', 'ピクトマンサー',
                    '吟遊詩人', '機工士', '踊り子'
                ];
                
                return `
                    <h3>4層直ドロップ武器の希望順位を設定</h3>
                    <p>第一希望は自動的にメインジョブになります。第二〜第四希望を選択してください。</p>
                    <div class="player-grid">
                        ${positions.map(position => {
                            const player = players[position];
                            if (!player) return '';
                            
                            const weaponWishes = player.weaponWishes || [];
                            const mainWeapon = player.job;
                            
                            return `
                                <div class="player-card">
                                    <div class="player-header">
                                        <span class="player-name">${player.name}</span>
                                        <span class="position-badge ${getPositionRoleClass(position)}">${position} - ${player.job}</span>
                                    </div>
                                    <div class="weapon-wishes">
                                        <div class="wish-priority">
                                            <label>第一希望 (メインジョブ):</label>
                                            <input type="text" value="${mainWeapon}" readonly style="background-color: #e9ecef; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; min-width: 120px;">
                                        </div>
                                        <div class="wish-priority">
                                            <label>第二希望:</label>
                                            <select id="${position}-weapon-wish-2">
                                                <option value="">選択</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[1] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>第三希望:</label>
                                            <select id="${position}-weapon-wish-3">
                                                <option value="">選択</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[2] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="wish-priority">
                                            <label>第四希望:</label>
                                            <select id="${position}-weapon-wish-4">
                                                <option value="">選択</option>
                                                ${allWeapons.filter(w => w !== mainWeapon).map(job => `
                                                    <option value="${job}" ${weaponWishes[3] === job ? 'selected' : ''}>${job}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            return '';
        }
        
        // 現在のタブのみ保存
        async function saveCurrentTab(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                    showSuccess('メンバー情報を保存しました');
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                    showSuccess('装備方針を保存しました');
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                    showSuccess('武器希望を保存しました');
                }
            } catch (error) {
                console.error('保存エラー:', error);
                showError('保存に失敗しました: ' + error.message);
            }
        }

        // 現在のタブを保存して次へ進む
        async function saveCurrentTabAndContinue(currentTab) {
            try {
                if (currentTab === 'players') {
                    await savePlayersData();
                } else if (currentTab === 'policy') {
                    await saveEquipmentPolicyData();
                } else if (currentTab === 'weapons') {
                    await saveWeaponWishesData();
                }
                
                showSuccess('設定を保存しました');
                
                // 全て設定済みかチェックしてダッシュボードへ
                if (Object.keys(appData.players[currentRaidTier.id] || {}).length > 0) {
                    showTierDashboard();
                } else {
                    showError('メンバー情報が設定されていません。');
                }
            } catch (error) {
                console.error('設定保存エラー:', error);
                showError('設定の保存に失敗しました: ' + error.message);
            }
        }
        
        // プレイヤー情報保存
        async function savePlayersData() {
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            
            if (!appData.players[currentRaidTier.id]) {
                appData.players[currentRaidTier.id] = {};
            }
            
            for (const position of positions) {
                const nameInput = document.getElementById(`${position}-name`);
                const jobSelect = document.getElementById(`${position}-job`);
                
                if (!nameInput || !jobSelect) continue;
                
                const name = nameInput.value.trim();
                const job = jobSelect.value;
                
                if (!name || !job) {
                    throw new Error(`${position}のプレイヤー名とジョブを入力してください。`);
                }
                
                // 既存データがある場合は保持
                const existingPlayer = appData.players[currentRaidTier.id][position] || {};
                
                appData.players[currentRaidTier.id][position] = {
                    name: name,
                    job: job,
                    position: position,
                    equipmentPolicy: existingPlayer.equipmentPolicy || {},
                    weaponWishes: existingPlayer.weaponWishes || [],
                    currentEquipment: existingPlayer.currentEquipment || {},
                    dynamicPriority: existingPlayer.dynamicPriority || 0,
                    allocationHistory: existingPlayer.allocationHistory || []
                };
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // 装備方針保存
        async function saveEquipmentPolicyData() {
            const players = appData.players[currentRaidTier.id];
            const slots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
            
            for (const [position, player] of Object.entries(players)) {
                for (const slot of slots) {
                    const policyElement = document.getElementById(`${position}-${slot}-policy`);
                    if (policyElement) {
                        const policy = policyElement.value;
                        player.equipmentPolicy[slot] = policy;
                    }
                }
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // タブ専用保存関数
        async function savePlayersDataTab() {
            try {
                await savePlayersData();
                showSuccess('メンバー情報を保存しました');
            } catch (error) {
                console.error('メンバー情報保存エラー:', error);
                showError('メンバー情報の保存に失敗しました: ' + error.message);
            }
        }
        
        async function saveEquipmentPolicyDataTab() {
            try {
                await saveEquipmentPolicyData();
                showSuccess('装備方針を保存しました');
            } catch (error) {
                console.error('装備方針保存エラー:', error);
                showError('装備方針の保存に失敗しました: ' + error.message);
            }
        }
        
        async function saveWeaponWishesDataTab() {
            try {
                await saveWeaponWishesData();
                showSuccess('武器希望を保存しました');
            } catch (error) {
                console.error('武器希望保存エラー:', error);
                showError('武器希望の保存に失敗しました: ' + error.message);
            }
        }
        
        // 武器希望保存
        async function saveWeaponWishesData() {
            const players = appData.players[currentRaidTier.id];
            
            for (const [position, player] of Object.entries(players)) {
                const mainJob = player.job;
                const wish2Element = document.getElementById(`${position}-weapon-wish-2`);
                const wish3Element = document.getElementById(`${position}-weapon-wish-3`);
                const wish4Element = document.getElementById(`${position}-weapon-wish-4`);
                
                // 第一希望はメインジョブ、第二〜第四希望は選択された値
                player.weaponWishes = [
                    mainJob,
                    wish2Element ? wish2Element.value : '',
                    wish3Element ? wish3Element.value : '',
                    wish4Element ? wish4Element.value : ''
                ].filter(wish => wish !== ''); // 空の値を除外
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // データ移行機能
        
        // JSONファイルからのインポート
        async function importFromJSON() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('JSONファイルを選択してください。');
                return;
            }
            
            try {
                showMessage('ファイルを読み込み中...', 'info');
                
                const text = await file.text();
                const importData = JSON.parse(text);
                
                // データ形式の検証と変換
                const convertedData = await convertImportData(importData);
                
                if (!convertedData) {
                    showError('対応していないデータ形式です。');
                    return;
                }
                
                // 詳細情報の表示
                let playerCount = 0;
                let tierCount = 0;
                
                if (convertedData.type === 'collaborative') {
                    tierCount = Object.keys(convertedData.players || {}).length;
                    playerCount = Object.values(convertedData.players || {}).reduce((total, tierPlayers) => {
                        return total + Object.keys(tierPlayers || {}).length;
                    }, 0);
                } else if (convertedData.type === 'simple') {
                    playerCount = Object.keys(convertedData.players || {}).length;
                    tierCount = 1;
                }
                
                // 確認ダイアログ
                const confirmMessage = `以下のデータをインポートします：
                
プレイヤー数: ${playerCount}人
レイドティア数: ${tierCount}個
データ形式: ${convertedData.type === 'collaborative' ? '共同利用版' : '簡易版'}

現在のデータを上書きします。よろしいですか？`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // データをインポート
                await importConvertedData(convertedData);
                
                showSuccess(`データのインポートが完了しました。（${playerCount}人のプレイヤーを登録）`);
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('インポートエラー:', error);
                if (error.name === 'SyntaxError') {
                    showError('JSONファイルの形式が正しくありません。ファイルを確認してください。');
                } else {
                    showError('インポートに失敗しました: ' + error.message);
                }
            }
        }
        
        // JSONファイル選択時の処理
        document.addEventListener('DOMContentLoaded', function() {
            // ファイル選択時の情報表示を設定
            document.addEventListener('change', function(event) {
                if (event.target.id === 'jsonFileInput') {
                    const file = event.target.files[0];
                    const fileInfo = document.getElementById('jsonFileInfo');
                    const fileName = document.getElementById('selectedFileName');
                    const fileDetails = document.getElementById('fileDetails');
                    
                    if (file && fileInfo && fileName && fileDetails) {
                        fileName.textContent = file.name;
                        fileDetails.textContent = `サイズ: ${(file.size / 1024).toFixed(2)} KB, 最終更新: ${new Date(file.lastModified).toLocaleString()}`;
                        fileInfo.style.display = 'block';
                    } else if (fileInfo) {
                        fileInfo.style.display = 'none';
                    }
                }
            });
        });
        
        // CSVからのインポート
        async function importFromCSV() {
            const csvText = document.getElementById('csvTextArea').value.trim();
            
            if (!csvText) {
                showError('CSVデータを入力してください。');
                return;
            }
            
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const players = {};
                
                for (let i = 1; i < lines.length; i++) { // ヘッダー行をスキップ
                    const columns = lines[i].split(',').map(col => col.trim());
                    
                    if (columns.length < 4) continue;
                    
                    const [position, name, job] = columns;
                    
                    players[position] = {
                        name: name,
                        job: job,
                        position: position,
                        equipmentPolicy: {},
                        weaponWishes: [job],
                        currentEquipment: {},
                        dynamicPriority: 0,
                        allocationHistory: []
                    };
                }
                
                if (Object.keys(players).length === 0) {
                    showError('有効なプレイヤーデータが見つかりません。');
                    return;
                }
                
                // 確認ダイアログ
                if (!confirm(`${Object.keys(players).length}人のプレイヤーデータをインポートします。よろしいですか？`)) {
                    return;
                }
                
                // データを保存
                appData.players[currentRaidTier.id] = players;
                await saveDataToSupabase('players', players);
                
                showSuccess('CSVデータのインポートが完了しました。');
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('CSVインポートエラー:', error);
                showError('CSVインポートに失敗しました: ' + error.message);
            }
        }
        
        // CSVデータクリア
        function clearCSVData() {
            const csvTextArea = document.getElementById('csvTextArea');
            if (csvTextArea) {
                csvTextArea.value = '';
                showSuccess('CSVデータをクリアしました。');
            }
        }
        
        // プレイヤーデータのみリセット
        async function resetAllPlayersData() {
            if (!confirm('現在のレイドティアのプレイヤー情報をすべて削除します。よろしいですか？')) {
                return;
            }
            
            if (!confirm('本当によろしいですか？プレイヤー情報、装備方針、武器希望がすべて削除されます。')) {
                return;
            }
            
            try {
                // プレイヤーデータのみ削除
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                
                // Supabaseからプレイヤーデータのみ削除
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id)
                    .eq('data_type', 'players');
                
                showSuccess('プレイヤーデータをリセットしました。');
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('プレイヤーデータリセットエラー:', error);
                showError('プレイヤーデータのリセットに失敗しました: ' + error.message);
            }
        }
        
        // 現在のティアデータをリセット
        async function resetCurrentTierData() {
            if (!confirm('現在のレイドティアのすべてのデータを削除します。この操作は取り消せません。よろしいですか？')) {
                return;
            }
            
            if (!confirm('本当によろしいですか？すべてのプレイヤー情報、装備方針、分配履歴が削除されます。')) {
                return;
            }
            
            try {
                // ローカルデータを削除
                if (appData.players[currentRaidTier.id]) {
                    delete appData.players[currentRaidTier.id];
                }
                if (appData.allocations[currentRaidTier.id]) {
                    delete appData.allocations[currentRaidTier.id];
                }
                
                // Supabaseからも削除
                await window.supabaseClient
                    .from('raid_data')
                    .delete()
                    .eq('team_id', currentTeamId)
                    .eq('tier_id', currentRaidTier.id);
                
                showSuccess('レイドティアデータをリセットしました。');
                showTabbedSetup('players'); // メンバー情報タブに移動
                
            } catch (error) {
                console.error('リセットエラー:', error);
                showError('データのリセットに失敗しました: ' + error.message);
            }
        }
        
        // インポートデータの変換
        async function convertImportData(importData) {
            // collaborative_index.html形式の場合
            if (importData.raidTiers && importData.players && importData.allocations) {
                return {
                    type: 'collaborative',
                    players: importData.players,
                    allocations: importData.allocations
                };
            }
            
            // 単純なプレイヤーリスト形式の場合
            if (Array.isArray(importData) && importData.length > 0 && importData[0].name) {
                const players = {};
                importData.forEach((player, index) => {
                    const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
                    const position = positions[index] || `D${index - 3}`;
                    
                    players[position] = {
                        name: player.name,
                        characterName: player.characterName || '',
                        job: player.job,
                        position: position,
                        equipmentPolicy: player.equipmentPolicy || {},
                        weaponWishes: player.weaponWishes || [player.job],
                        currentEquipment: player.currentEquipment || {},
                        dynamicPriority: player.dynamicPriority || 0,
                        allocationHistory: player.allocationHistory || []
                    };
                });
                
                return {
                    type: 'simple',
                    players: players
                };
            }
            
            return null;
        }
        
        // 変換済みデータのインポート
        async function importConvertedData(convertedData) {
            if (convertedData.type === 'collaborative') {
                // 現在のティアに対応するデータがある場合はそれを使用
                const tierData = Object.values(convertedData.players)[0] || {};
                appData.players[currentRaidTier.id] = tierData;
                
                // 分配履歴も移行
                if (convertedData.allocations) {
                    const allocationData = Object.values(convertedData.allocations)[0] || {};
                    appData.allocations[currentRaidTier.id] = allocationData;
                    await saveDataToSupabase('allocations', allocationData);
                }
            } else if (convertedData.type === 'simple') {
                appData.players[currentRaidTier.id] = convertedData.players;
            }
            
            // Supabaseに保存
            await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
        }
        
        // Supabaseデータ保存ヘルパー
        async function saveDataToSupabase(dataType, content) {
            const { error } = await window.supabaseClient
                .from('raid_data')
                .upsert({
                    team_id: currentTeamId,
                    tier_id: currentRaidTier.id,
                    data_type: dataType,
                    content: content
                });
                
            if (error) {
                throw new Error(`保存エラー: ${error.message}`);
            }
        }
        
        // 装備分配システム
        function showEquipmentAllocation() {
            const content = document.getElementById('content');
            
            // プレイヤーデータの確認
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('プレイヤー情報が設定されていません。メンバー設定を完了してください。');
                return;
            }
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                </div>
                
                <h1>装備分配システム</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section" id="allocationResults" style="display: none;">
                    <h3>分配結果</h3>
                    <div id="allocationContent"></div>
                </div>
            `;
        }
        
        // 直接層別分配を実行（ダッシュボードから呼び出し）
        async function showLayerAllocation(layer) {
            // プレイヤーデータの確認
            const players = appData.players[currentRaidTier.id] || {};
            const playerCount = Object.keys(players).length;
            
            if (playerCount === 0) {
                showError('メンバー情報が登録されていません。まずメンバー管理から設定してください。');
                return;
            }
            
            if (playerCount < 8) {
                if (!confirm(`メンバーが${playerCount}人しか登録されていません。分配を続行しますか？`)) {
                    return;
                }
            }
            
            // 装備分配画面を表示してから該当層の処理を実行
            showEquipmentAllocation();
            
            // 少し待ってから分配処理を実行（DOM更新のため）
            setTimeout(() => {
                processLayerAllocation(layer);
            }, 100);
        }
        
        // 層別装備分配処理
        async function processLayerAllocation(layer) {
            try {
                showMessage('分配処理中...', 'info');
                
                // 層別ドロップアイテムを取得
                const drops = getLayerDrops(layer);
                
                // 分配優先度を計算
                const allocationResults = calculateAllocation(layer, drops);
                
                // 結果を表示
                displayAllocationResults(layer, allocationResults);
                
            } catch (error) {
                console.error('分配処理エラー:', error);
                showError('分配処理に失敗しました: ' + error.message);
            }
        }
        
        // 層別ドロップアイテム定義
        function getLayerDrops(layer) {
            const drops = {
                1: [
                    { name: '耳装備', slot: '耳', type: 'equipment', itemLevel: '' },
                    { name: '首装備', slot: '首', type: 'equipment', itemLevel: '' },
                    { name: '腕装備', slot: '腕', type: 'equipment', itemLevel: '' },
                    { name: '指装備', slot: '指', type: 'equipment', itemLevel: '' }
                ],
                2: [
                    { name: '頭装備', slot: '頭', type: 'equipment', itemLevel: '' },
                    { name: '手装備', slot: '手', type: 'equipment', itemLevel: '' },
                    { name: '足装備', slot: '足', type: 'equipment', itemLevel: '' },
                    { name: '武器石', slot: '武器石', type: 'material', itemLevel: '' },
                    { name: '硬化薬', slot: '硬化薬', type: 'material', itemLevel: '' }
                ],
                3: [
                    { name: '胴装備', slot: '胴', type: 'equipment', itemLevel: '' },
                    { name: '脚装備', slot: '脚', type: 'equipment', itemLevel: '' },
                    { name: '強化薬', slot: '強化薬', type: 'material', itemLevel: '' },
                    { name: '強化繊維', slot: '強化繊維', type: 'material', itemLevel: '' }
                ],
                4: [
                    { name: '胴装備', slot: '胴', type: 'equipment', itemLevel: '' },
                    { name: '武器箱', slot: '武器箱', type: 'weapon_box', itemLevel: '' },
                    { name: '直ドロップ武器', slot: '武器', type: 'direct_weapon', itemLevel: '', weapon: null }
                ]
            };
            
            return drops[layer] || [];
        }
        
        // 分配優先度計算
        function calculateAllocation(layer, drops) {
            const players = appData.players[currentRaidTier.id] || {};
            const results = {};
            
            drops.forEach(drop => {
                const allCandidates = [];
                
                Object.entries(players).forEach(([position, player]) => {
                    const priority = calculatePlayerPriority(player, drop);
                    allCandidates.push({
                        position,
                        player,
                        priority: priority.score,
                        reason: priority.reason,
                        type: priority.type,
                        canReceive: priority.canReceive
                    });
                });
                
                // 優先度順でソート（全プレイヤー）
                allCandidates.sort((a, b) => b.priority - a.priority);
                
                // 取得可能な候補者のみ抽出
                const candidates = allCandidates.filter(c => c.canReceive);
                
                results[drop.slot] = {
                    drop,
                    candidates: allCandidates, // 全プレイヤーの判定結果
                    recommended: candidates[0] || null // 最優先の取得可能者
                };
            });
            
            return results;
        }
        
        // プレイヤー優先度計算
        function calculatePlayerPriority(player, drop) {
            let score = 0;
            let canReceive = false;
            let reason = 'Pass';
            let type = 'pass';
            
            if (drop.type === 'equipment') {
                // 装備の場合
                const policy = player.equipmentPolicy?.[drop.slot] || 'トームストーン';
                
                // 現在の装備状況を取得（分配履歴から）
                const equipmentStatus = getPlayerEquipmentStatus(player.position, drop.slot);
                
                // 断章交換者の特別処理
                if (equipmentStatus === '断章交換') {
                    // 未取得者がいるかチェック
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers(drop.slot, player.position);
                    
                    if (hasUnacquiredRaidPlayer) {
                        // 未取得者がいる場合は分配対象外
                        type = 'pass';
                        reason = 'Pass (断章交換 - 他に未取得者あり)';
                    } else {
                        // 未取得者がいない場合は復活
                        canReceive = true;
                        type = 'need';
                        score = 1000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                        reason = 'Need (断章交換 - 復活)';
                    }
                } else if (equipmentStatus === '断章交換・箱取得済') {
                    // 断章交換・箱取得済は完全に分配対象外
                    type = 'pass';
                    reason = 'Pass (断章交換・箱取得済)';
                } else if (policy === '零式' && equipmentStatus === '未取得') {
                    canReceive = true;
                    type = 'need';
                    score = 1000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Need (零式)';
                } else if (equipmentStatus === '未取得') {
                    canReceive = true;
                    type = 'greed';
                    score = 500 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Greed (トーム可)';
                } else {
                    type = 'pass';
                    reason = 'Pass (所持済み)';
                }
            } else if (drop.type === 'material') {
                // 強化素材の場合（分配優先度設定に基づく）
                const materialStatus = getPlayerEquipmentStatus(player.position, drop.slot);
                
                // 断章交換素材の特別処理
                if (materialStatus === '断章交換') {
                    type = 'pass';
                    reason = 'Pass (断章交換)';
                } else if (materialStatus === '断章交換・箱取得済') {
                    type = 'pass';
                    reason = 'Pass (断章交換・箱取得済)';
                } else if (materialStatus === '未取得') {
                    canReceive = true;
                    type = 'need';
                    score = getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Need (素材)';
                } else {
                    type = 'pass';
                    reason = 'Pass (取得済み)';
                }
            } else if (drop.type === 'weapon_box') {
                // 武器箱の場合
                const weaponStatus = getPlayerEquipmentStatus(player.position, '武器');
                
                if (weaponStatus === '断章交換') {
                    // 未取得者がいるかチェック
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers('武器', player.position);
                    
                    if (hasUnacquiredRaidPlayer) {
                        type = 'pass';
                        reason = 'Pass (断章交換 - 他に未取得者あり)';
                    } else {
                        canReceive = true;
                        type = 'need';
                        score = 2000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                        reason = 'Need (断章交換 - 復活)';
                    }
                } else if (weaponStatus === '断章交換・箱取得済') {
                    type = 'pass';
                    reason = 'Pass (断章交換・箱取得済)';
                } else if (weaponStatus === '未取得') {
                    canReceive = true;
                    type = 'need';
                    score = 2000 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Need (武器箱)';
                } else {
                    type = 'pass';
                    reason = 'Pass (武器所持済み)';
                }
            } else if (drop.type === 'direct_weapon') {
                // 直ドロップ武器の場合（武器希望に基づく）
                const weaponWishes = player.weaponWishes || [];
                const weaponStatus = getPlayerEquipmentStatus(player.position, '武器');
                const weaponType = drop.weapon; // 選択された武器種
                
                if (weaponStatus === '断章交換') {
                    // 未取得者がいるかチェック
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers('武器', player.position);
                    
                    if (hasUnacquiredRaidPlayer) {
                        type = 'pass';
                        reason = 'Pass (断章交換 - 他に未取得者あり)';
                    } else if (weaponType && weaponWishes.includes(weaponType)) {
                        canReceive = true;
                        type = 'need';
                        const wishIndex = weaponWishes.indexOf(weaponType);
                        score = 3000 + getPositionPriority(player.position) - (wishIndex * 100) - (player.dynamicPriority || 0);
                        reason = `Need (断章交換 - 復活・第${wishIndex + 1}希望)`;
                    } else {
                        canReceive = true;
                        type = 'greed';
                        score = 100 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                        reason = 'Greed (断章交換 - 復活)';
                    }
                } else if (weaponStatus === '断章交換・箱取得済') {
                    type = 'pass';
                    reason = 'Pass (断章交換・箱取得済)';
                } else if (weaponStatus === '未取得' && weaponType && weaponWishes.includes(weaponType)) {
                    canReceive = true;
                    type = 'need';
                    const wishIndex = weaponWishes.indexOf(weaponType);
                    score = 3000 + getPositionPriority(player.position) - (wishIndex * 100) - (player.dynamicPriority || 0);
                    reason = `Need (第${wishIndex + 1}希望)`;
                } else if (weaponStatus === '未取得') {
                    canReceive = true;
                    type = 'greed';
                    score = 100 + getPositionPriority(player.position) - (player.dynamicPriority || 0);
                    reason = 'Greed (武器)';
                } else {
                    type = 'pass';
                    reason = 'Pass (武器所持済み)';
                }
            }
            
            return { canReceive, score, reason, type };
        }
        
        // プレイヤーの装備状況取得
        function getPlayerEquipmentStatus(position, slot) {
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const allocation = allocations.find(alloc => 
                alloc.position === position && alloc.slot === slot
            );
            
            if (allocation && allocation.status) {
                return allocation.status;
            }
            
            // 既存のデータでstatusがない場合は「取得済み」とみなす
            if (allocation) {
                return '取得済み';
            }
            
            return '未取得';
        }
        
        // 同じスロットで零式方針の未取得者がいるかチェック
        function hasUnacquiredRaidPlayers(slot, excludePosition) {
            const players = appData.players[currentRaidTier.id] || {};
            
            for (const [position, player] of Object.entries(players)) {
                if (position === excludePosition) continue;
                
                const policy = player.equipmentPolicy?.[slot] || 'トームストーン';
                const equipmentStatus = getPlayerEquipmentStatus(position, slot);
                
                // 零式方針で未取得のプレイヤーがいるか
                if (policy === '零式' && equipmentStatus === '未取得') {
                    return true;
                }
            }
            
            return false;
        }
        
        // 分配対象の全員が取得済みまたは断章交換・箱取得済かを判定
        function isAllEligiblePlayersObtained(drop, candidates) {
            const players = appData.players[currentRaidTier.id] || {};
            
            // 4層直ドロ武器の特別処理
            if (drop.type === 'direct_weapon') {
                const weaponType = drop.weapon;
                
                // 武器が選択されていない場合はフリロ
                if (!weaponType) {
                    return true;
                }
                
                let hasEligiblePlayer = false;
                
                for (const [position, player] of Object.entries(players)) {
                    const weaponWishes = player.weaponWishes || [];
                    const weaponStatus = getPlayerEquipmentStatus(position, '武器');
                    
                    // この武器を希望していて未取得のプレイヤーがいるかチェック
                    if (weaponStatus === '未取得' && weaponWishes.includes(weaponType)) {
                        hasEligiblePlayer = true;
                        break;
                    }
                    
                    // 断章交換で復活可能かつこの武器を希望している場合
                    if (weaponStatus === '断章交換') {
                        const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers('武器', position);
                        if (!hasUnacquiredRaidPlayer && weaponWishes.includes(weaponType)) {
                            hasEligiblePlayer = true;
                            break;
                        }
                    }
                }
                
                // 希望者がいない、または希望者全員が取得済み = フリロ
                return !hasEligiblePlayer;
            }
            
            // 通常装備の処理
            for (const [position, player] of Object.entries(players)) {
                const policy = player.equipmentPolicy?.[drop.slot] || 'トームストーン';
                const equipmentStatus = getPlayerEquipmentStatus(position, drop.slot);
                
                // 零式方針で未取得のプレイヤーがいる場合はフリロ対象外
                if (policy === '零式' && equipmentStatus === '未取得') {
                    return false;
                }
                
                // 断章交換で未取得者がいない場合は復活対象も考慮
                if (equipmentStatus === '断章交換') {
                    const hasUnacquiredRaidPlayer = hasUnacquiredRaidPlayers(drop.slot, position);
                    if (!hasUnacquiredRaidPlayer) {
                        return false; // 断章交換者が復活可能 = フリロ対象外
                    }
                }
            }
            
            // 全員が取得済み、トーム方針、または断章交換・箱取得済 = フリロ
            return true;
        }
        
        // ポジション間優先順位取得（装備・素材共通）
        function getPositionPriority(position) {
            // 設定された優先順位を取得（デフォルト: D1D2D3D4MTSTH1H2）
            const savedPriority = appData.settings?.positionPriority || ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            const positionIndex = savedPriority.indexOf(position);
            return 800 - (positionIndex * 50); // 高い順位ほど高スコア
        }
        
        // 強化素材の分配優先度取得（互換性のため残す）
        function getMaterialPriority(position, materialType) {
            return getPositionPriority(position);
        }
        
        // 分配結果表示
        function displayAllocationResults(layer, results) {
            const allocationResults = document.getElementById('allocationResults');
            const allocationContent = document.getElementById('allocationContent');
            
            let html = `
                <div class="allocation-header">
                    <h4>${layer}層 装備分配結果</h4>
                    <p>推奨分配者が自動計算されました。必要に応じて変更してください。</p>
                </div>
            `;
            
            // 直ドロップ武器選択（4層のみ）
            if (layer === 4) {
                html += `
                    <div class="weapon-selection">
                        <h5>直ドロップ武器選択:</h5>
                        <select id="directWeaponSelect" onchange="updateDirectWeapon()" style="width: 100%; padding: 5px;">
                            <option value="" ${selectedDirectWeapon === '' ? 'selected' : ''}>武器を選択してください</option>
                            <option value="ナイト" ${selectedDirectWeapon === 'ナイト' ? 'selected' : ''}>ナイト武器</option>
                            <option value="戦士" ${selectedDirectWeapon === '戦士' ? 'selected' : ''}>戦士武器</option>
                            <option value="暗黒騎士" ${selectedDirectWeapon === '暗黒騎士' ? 'selected' : ''}>暗黒騎士武器</option>
                            <option value="ガンブレイカー" ${selectedDirectWeapon === 'ガンブレイカー' ? 'selected' : ''}>ガンブレイカー武器</option>
                            <option value="白魔道士" ${selectedDirectWeapon === '白魔道士' ? 'selected' : ''}>白魔道士武器</option>
                            <option value="学者" ${selectedDirectWeapon === '学者' ? 'selected' : ''}>学者武器</option>
                            <option value="占星術士" ${selectedDirectWeapon === '占星術士' ? 'selected' : ''}>占星術士武器</option>
                            <option value="賢者" ${selectedDirectWeapon === '賢者' ? 'selected' : ''}>賢者武器</option>
                            <option value="モンク" ${selectedDirectWeapon === 'モンク' ? 'selected' : ''}>モンク武器</option>
                            <option value="竜騎士" ${selectedDirectWeapon === '竜騎士' ? 'selected' : ''}>竜騎士武器</option>
                            <option value="忍者" ${selectedDirectWeapon === '忍者' ? 'selected' : ''}>忍者武器</option>
                            <option value="侍" ${selectedDirectWeapon === '侍' ? 'selected' : ''}>侍武器</option>
                            <option value="リーパー" ${selectedDirectWeapon === 'リーパー' ? 'selected' : ''}>リーパー武器</option>
                            <option value="ヴァイパー" ${selectedDirectWeapon === 'ヴァイパー' ? 'selected' : ''}>ヴァイパー武器</option>
                            <option value="黒魔道士" ${selectedDirectWeapon === '黒魔道士' ? 'selected' : ''}>黒魔道士武器</option>
                            <option value="召喚士" ${selectedDirectWeapon === '召喚士' ? 'selected' : ''}>召喚士武器</option>
                            <option value="赤魔道士" ${selectedDirectWeapon === '赤魔道士' ? 'selected' : ''}>赤魔道士武器</option>
                            <option value="ピクトマンサー" ${selectedDirectWeapon === 'ピクトマンサー' ? 'selected' : ''}>ピクトマンサー武器</option>
                            <option value="吟遊詩人" ${selectedDirectWeapon === '吟遊詩人' ? 'selected' : ''}>吟遊詩人武器</option>
                            <option value="機工士" ${selectedDirectWeapon === '機工士' ? 'selected' : ''}>機工士武器</option>
                            <option value="踊り子" ${selectedDirectWeapon === '踊り子' ? 'selected' : ''}>踊り子武器</option>
                        </select>
                    </div>
                `;
            }
            
            html += `<div class="allocation-grid">`;
            
            Object.entries(results).forEach(([itemKey, result]) => {
                const drop = result.drop;
                const needCandidates = result.candidates.filter(c => c.type === 'need');
                const greedCandidates = result.candidates.filter(c => c.type === 'greed');
                const passCandidates = result.candidates.filter(c => c.type === 'pass');
                
                html += `
                    <div class="allocation-item">
                        <div class="item-header">
                            <h5>${drop.name} ${drop.itemLevel}</h5>
                            <span class="item-type">${getItemTypeLabel(drop.type)}</span>
                        </div>
                        
                        <div class="predicted-winner">
                            <strong>予測取得者:</strong> 
                            ${result.recommended ? 
                                `${result.recommended.player.name} (${result.recommended.position}) [${result.recommended.player.job}]` : 
                                (isAllEligiblePlayersObtained(drop, result.candidates) ? 'フリロ' : '該当者なし')
                            }
                        </div>
                        
                        <div class="allocation-choice">
                            <label>実際の取得者:</label>
                            <select id="allocation-${itemKey}" onchange="updateAllocationChoice('${itemKey}')">
                                <option value="">選択してください</option>
                                ${result.candidates.map(candidate => `
                                    <option value="${candidate.position}" 
                                            ${result.recommended?.position === candidate.position ? 'selected' : ''}>
                                        ${candidate.player.name} (${candidate.position}) [${candidate.player.job}]
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="judgment-details">
                            <div class="judgment-section">
                                <button class="judgment-toggle" onclick="toggleJudgment('${itemKey}')">
                                    判定詳細を表示 ▼
                                </button>
                                <div id="judgment-${itemKey}" class="judgment-content" style="display: none;">
                                    ${needCandidates.length > 0 ? `
                                        <div class="need-section">
                                            <h6>Need (${needCandidates.length}人)</h6>
                                            ${needCandidates.map(candidate => `
                                                <div class="candidate-item need">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${greedCandidates.length > 0 ? `
                                        <div class="greed-section">
                                            <h6>Greed (${greedCandidates.length}人)</h6>
                                            ${greedCandidates.map(candidate => `
                                                <div class="candidate-item greed">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason} (${candidate.priority})
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${passCandidates.length > 0 ? `
                                        <div class="pass-section">
                                            <h6>Pass (${passCandidates.length}人)</h6>
                                            ${passCandidates.map(candidate => `
                                                <div class="candidate-item pass">
                                                    ${candidate.player.name} (${candidate.position}): ${candidate.reason}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="allocation-actions">
                    <button onclick="confirmAllocation(${layer})" class="confirm-btn">
                        分配を確定
                    </button>
                    <button onclick="showTierDashboard()" class="cancel-btn">
                        キャンセル
                    </button>
                </div>
            `;
            
            allocationContent.innerHTML = html;
            allocationResults.style.display = 'block';
            
            // 結果表示エリアまでスクロール
            allocationResults.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 直ドロップ武器更新
        function updateDirectWeapon() {
            console.log('updateDirectWeapon関数が呼び出されました');
            
            const weaponSelect = document.getElementById('directWeaponSelect');
            if (!weaponSelect) {
                console.error('武器選択プルダウンが見つかりません');
                showError('武器選択プルダウンが見つかりません');
                return;
            }
            
            const selectedWeapon = weaponSelect.value;
            console.log('選択された武器:', selectedWeapon);
            console.log('プルダウンの全選択肢:', weaponSelect.options.length);
            
            // グローバル変数に選択状態を保存
            selectedDirectWeapon = selectedWeapon;
            console.log('選択状態を保存:', selectedDirectWeapon);
            
            if (selectedWeapon) {
                try {
                    // 直ドロップ武器の分配を再計算
                    const drops = getLayerDrops(4);
                    console.log('4層のドロップアイテム:', drops);
                    
                    const weaponDrop = drops.find(d => d.type === 'direct_weapon');
                    if (weaponDrop) {
                        weaponDrop.weapon = selectedWeapon;
                        console.log('武器ドロップ更新:', weaponDrop);
                        
                        const allocationResults = calculateAllocation(4, drops);
                        displayAllocationResults(4, allocationResults);
                        showSuccess(`${selectedWeapon}を選択しました`);
                    } else {
                        console.error('直ドロップ武器アイテムが見つかりません');
                        console.log('利用可能なドロップタイプ:', drops.map(d => d.type));
                        showError('直ドロップ武器アイテムが見つかりません');
                    }
                } catch (error) {
                    console.error('武器選択処理エラー:', error);
                    showError('武器選択処理でエラーが発生しました: ' + error.message);
                }
            } else {
                console.log('武器選択がクリアされました');
                // 選択がクリアされた場合も画面を更新
                const drops = getLayerDrops(4);
                const allocationResults = calculateAllocation(4, drops);
                displayAllocationResults(4, allocationResults);
            }
        }
        
        // 判定詳細の表示切り替え
        function toggleJudgment(itemKey) {
            const content = document.getElementById(`judgment-${itemKey}`);
            const button = content.previousElementSibling;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = '判定詳細を隠す ▲';
            } else {
                content.style.display = 'none';
                button.textContent = '判定詳細を表示 ▼';
            }
        }
        
        // アイテムタイプラベル
        function getItemTypeLabel(type) {
            const labels = {
                'equipment': '装備',
                'material': '強化素材',
                'weapon_box': '武器箱',
                'direct_weapon': '直ドロップ武器'
            };
            return labels[type] || type;
        }
        
        // 分配選択更新
        function updateAllocationChoice(slot) {
            // 選択変更時の処理（必要に応じて実装）
            console.log(`${slot}の分配選択が変更されました`);
        }
        
        // 分配確定
        async function confirmAllocation(layer) {
            try {
                const allocations = [];
                const selects = document.querySelectorAll('[id^="allocation-"]');
                const allocationId = Date.now().toString();
                
                selects.forEach(select => {
                    const itemKey = select.id.replace('allocation-', '');
                    const position = select.value;
                    
                    if (position && position !== 'discard' && position !== 'フリロ') {
                        const player = appData.players[currentRaidTier.id][position];
                        const drops = getLayerDrops(layer);
                        const drop = drops.find(d => d.slot === itemKey || d.name.includes(itemKey));
                        
                        if (drop && player) {
                            const allocation = {
                                id: `${allocationId}-${itemKey}`,
                                layer: layer,
                                slot: drop.slot,
                                position: position,
                                playerName: player.name,
                                characterName: player.characterName || '',
                                job: player.job,
                                equipment: {
                                    name: drop.name,
                                    slot: drop.slot,
                                    itemLevel: drop.itemLevel
                                },
                                timestamp: new Date().toISOString(),
                                week: getCurrentWeek(),
                                raidTier: currentRaidTier.name,
                                // 詳細情報
                                itemType: drop.type,
                                equipmentName: drop.name,
                                equipmentSlot: drop.slot,
                                winner: position,
                                winnerName: player.name
                            };
                            
                            allocations.push(allocation);
                        }
                    }
                });
                
                if (allocations.length === 0) {
                    showError('分配する装備が選択されていません。');
                    return;
                }
                
                // 分配履歴に記録
                if (!appData.allocations[currentRaidTier.id]) {
                    appData.allocations[currentRaidTier.id] = [];
                }
                
                allocations.forEach(allocation => {
                    appData.allocations[currentRaidTier.id].push(allocation);
                    
                    // プレイヤーの装備状況更新
                    const player = appData.players[currentRaidTier.id][allocation.position];
                    if (player) {
                        // 現在装備の更新
                        if (!player.currentEquipment) player.currentEquipment = {};
                        player.currentEquipment[allocation.slot] = true;
                        
                        // 分配履歴の更新
                        if (!player.allocationHistory) player.allocationHistory = [];
                        player.allocationHistory.push({
                            equipment: allocation.equipment,
                            timestamp: allocation.timestamp,
                            week: allocation.week,
                            layer: allocation.layer
                        });
                        
                        // 動的優先度更新
                        const itemPriority = getItemPriority(allocation.slot);
                        player.dynamicPriority = (player.dynamicPriority || 0) + itemPriority;
                    }
                });
                
                // 断章交換者の自動ステータス更新
                await updateTomeExchangeStatus(allocations);
                
                // Supabaseに保存
                await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                await saveDataToSupabase('players', appData.players[currentRaidTier.id]);
                
                showSuccess(`${layer}層の装備分配を確定しました。${allocations.length}件の装備が分配されました。`);
                showEquipmentAllocation(); // 装備分配画面に戻る
                
            } catch (error) {
                console.error('分配確定エラー:', error);
                showError('分配の確定に失敗しました: ' + error.message);
            }
        }
        
        // 現在の週番号取得
        function getCurrentWeek() {
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const weekNumber = Math.ceil(((now - yearStart) / 86400000 + yearStart.getDay() + 1) / 7);
            return weekNumber;
        }
        
        // アイテム優先度取得
        function getItemPriority(slot) {
            const priorities = {
                '武器': 3,
                '胴': 2,
                '脚': 2,
                '頭': 1,
                '手': 1,
                '足': 1,
                '耳': 1,
                '首': 1,
                '腕': 1,
                '指': 1,
                '武器石': 1,
                '硬化薬': 1,
                '強化薬': 1,
                '強化繊維': 1
            };
            return priorities[slot] || 1;
        }
        
        // 断章交換者の自動ステータス更新
        async function updateTomeExchangeStatus(allocations) {
            try {
                const currentAllocations = appData.allocations[currentRaidTier.id] || [];
                let hasUpdates = false;
                
                // 各装備スロットについて断章交換者をチェック
                const equipmentSlots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
                
                for (const slot of equipmentSlots) {
                    // 今回のアロケーションでこのスロットの装備が分配されたかチェック
                    const slotAllocations = allocations.filter(alloc => alloc.slot === slot);
                    
                    if (slotAllocations.length > 0) {
                        // このスロットで断章交換ステータスの人をチェック
                        const players = appData.players[currentRaidTier.id] || {};
                        
                        for (const [position, player] of Object.entries(players)) {
                            const currentStatus = getPlayerEquipmentStatus(position, slot);
                            
                            // 断章交換ステータスの人が装備を取得した場合
                            if (currentStatus === '断章交換') {
                                const receivedAllocation = slotAllocations.find(alloc => alloc.position === position);
                                
                                if (receivedAllocation) {
                                    // ステータスを「断章交換・箱取得済」に更新
                                    const existingAllocation = currentAllocations.find(alloc => 
                                        alloc.position === position && alloc.slot === slot
                                    );
                                    
                                    if (existingAllocation) {
                                        existingAllocation.status = '断章交換・箱取得済';
                                        hasUpdates = true;
                                        console.log(`${player.name}(${position})の${slot}ステータスを「断章交換・箱取得済」に更新`);
                                    }
                                }
                            }
                        }
                    }
                }
                
                if (hasUpdates) {
                    // 更新があった場合は再保存
                    await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                    console.log('断章交換ステータスの自動更新が完了しました');
                }
                
            } catch (error) {
                console.error('断章交換ステータス更新エラー:', error);
                // エラーが発生しても分配処理自体は続行
            }
        }
        
        // 統計情報表示
        function showStatistics() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            const allocations = appData.allocations[currentRaidTier.id] || [];
            
            if (Object.keys(players).length === 0) {
                showError('プレイヤー情報が設定されていません。');
                return;
            }
            
            // 統計データ計算
            const stats = calculateStatistics(players, allocations);
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                </div>
                
                <h1>統計情報</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>プレイヤー別取得状況
                        <button class="edit-button" onclick="showStatisticsEditMode()" style="margin-left: 20px;">編集開始</button>
                    </h3>
                    ${generatePlayerStatistics(players, allocations)}
                </div>
            `;
        }
        
        // プレイヤー別統計情報生成
        function generatePlayerStatistics(players, allocations) {
            // ポジション順序を固定化 (D1→D2→D3→D4→MT→ST→H1→H2)
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            
            // 装備部位順序を固定化 (頭→胴→手→脚→足→耳→首→腕→指→武器)
            const equipmentSlots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
            const materialSlots = ['武器石', '硬化薬', '強化薬', '強化繊維'];
            
            let html = '<div class="player-stats-table">';
            
            // ヘッダー
            html += `
                <div class="stats-header">
                    <div class="player-name-col">プレイヤー</div>
                    ${equipmentSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                    ${materialSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                </div>
            `;
            
            // 各プレイヤーの行
            positions.forEach(position => {
                const player = players[position];
                if (!player) return;
                
                // 該当プレイヤーの取得履歴を取得
                const playerAllocations = allocations.filter(alloc => alloc.position === position);
                const acquiredSlots = new Set(playerAllocations.map(alloc => alloc.slot));
                
                html += `
                    <div class="stats-row">
                        <div class="player-name-col">
                            <strong>${player.name}</strong><br>
                            <span class="position-badge ${getPositionRoleClass(position)}" style="font-size: 11px; padding: 2px 6px;">${position}</span>
                        </div>
                `;
                
                // 装備部位の取得状況
                equipmentSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || '取得済み') : '未取得';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col ${statusClass}">
                            ${status}
                        </div>
                    `;
                });
                
                // 素材の取得状況
                materialSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || '取得済み') : '未取得';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col ${statusClass}">
                            ${status}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }
        
        // 統計データ計算
        function calculateStatistics(players, allocations) {
            const playerStats = {};
            const slotStats = {};
            const weekStats = {};
            
            // プレイヤー統計初期化
            Object.entries(players).forEach(([position, player]) => {
                playerStats[position] = {
                    name: player.name,
                    equipmentCount: 0,
                    materialCount: 0,
                    totalCount: 0,
                    dynamicPriority: player.dynamicPriority || 0
                };
            });
            
            // 分配履歴から統計計算
            allocations.forEach(allocation => {
                const position = allocation.position;
                const slot = allocation.slot;
                const week = allocation.week;
                
                // プレイヤー統計更新
                if (playerStats[position]) {
                    if (['武器石', '硬化薬', '強化薬', '強化繊維'].includes(slot)) {
                        playerStats[position].materialCount++;
                    } else {
                        playerStats[position].equipmentCount++;
                    }
                    playerStats[position].totalCount++;
                }
                
                // 部位統計更新
                slotStats[slot] = (slotStats[slot] || 0) + 1;
                
                // 週統計更新
                weekStats[week] = (weekStats[week] || 0) + 1;
            });
            
            return { playerStats, slotStats, weekStats };
        }
        
        // 統計情報編集モード表示
        function showStatisticsEditMode() {
            const content = document.getElementById('content');
            const players = appData.players[currentRaidTier.id] || {};
            const allocations = appData.allocations[currentRaidTier.id] || [];
            
            if (Object.keys(players).length === 0) {
                showError('プレイヤー情報が設定されていません。');
                return;
            }
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                    <button class="nav-button" onclick="showStatistics()">編集終了</button>
                </div>
                
                <h1>統計情報編集</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>プレイヤー別取得状況編集
                        <button class="save-button" onclick="saveStatisticsChanges()" style="margin-left: 20px;">変更を保存</button>
                    </h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                        チェックボックスをクリックして取得状況を変更できます。変更後は「変更を保存」ボタンを押してください。
                    </p>
                    ${generateEditablePlayerStatistics(players, allocations)}
                </div>
            `;
        }
        
        // 編集可能なプレイヤー別統計情報生成
        function generateEditablePlayerStatistics(players, allocations) {
            const positions = ['D1', 'D2', 'D3', 'D4', 'MT', 'ST', 'H1', 'H2'];
            const equipmentSlots = ['武器', '頭', '胴', '手', '脚', '足', '耳', '首', '腕', '指'];
            const materialSlots = ['武器石', '硬化薬', '強化薬', '強化繊維'];
            
            let html = '<div class="player-stats-table">';
            
            // ヘッダー
            html += `
                <div class="stats-header">
                    <div class="player-name-col">プレイヤー</div>
                    ${equipmentSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                    ${materialSlots.map(slot => `<div class="slot-col">${slot}</div>`).join('')}
                </div>
            `;
            
            // 各プレイヤーの行
            positions.forEach(position => {
                const player = players[position];
                if (!player) return;
                
                // 該当プレイヤーの取得履歴を取得
                const playerAllocations = allocations.filter(alloc => alloc.position === position);
                
                html += `
                    <div class="stats-row">
                        <div class="player-name-col">
                            <strong>${player.name}</strong><br>
                            <span class="position-badge ${getPositionRoleClass(position)}" style="font-size: 11px; padding: 2px 6px;">${position}</span>
                        </div>
                `;
                
                // 装備部位の取得状況（編集可能）
                equipmentSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || '取得済み') : '未取得';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col editable-slot ${statusClass}">
                            <select data-position="${position}" 
                                    data-slot="${slot}" 
                                    onchange="updateEquipmentStatus(this)"
                                    style="width: 100%; font-size: 0.8rem; padding: 2px;">
                                <option value="未取得" ${status === '未取得' ? 'selected' : ''}>未取得</option>
                                <option value="取得済み" ${status === '取得済み' ? 'selected' : ''}>取得済み</option>
                                <option value="断章交換" ${status === '断章交換' ? 'selected' : ''}>断章交換</option>
                                <option value="断章交換・箱取得済" ${status === '断章交換・箱取得済' ? 'selected' : ''}>断章交換・箱取得済</option>
                            </select>
                        </div>
                    `;
                });
                
                // 素材の取得状況（編集可能）
                materialSlots.forEach(slot => {
                    const allocation = playerAllocations.find(alloc => alloc.slot === slot);
                    const status = allocation ? (allocation.status || '取得済み') : '未取得';
                    const statusClass = getEquipmentStatusClass(status);
                    
                    html += `
                        <div class="slot-col editable-slot ${statusClass}">
                            <select data-position="${position}" 
                                    data-slot="${slot}" 
                                    onchange="updateEquipmentStatus(this)"
                                    style="width: 100%; font-size: 0.8rem; padding: 2px;">
                                <option value="未取得" ${status === '未取得' ? 'selected' : ''}>未取得</option>
                                <option value="取得済み" ${status === '取得済み' ? 'selected' : ''}>取得済み</option>
                                <option value="断章交換" ${status === '断章交換' ? 'selected' : ''}>断章交換</option>
                                <option value="断章交換・箱取得済" ${status === '断章交換・箱取得済' ? 'selected' : ''}>断章交換・箱取得済</option>
                            </select>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }
        
        // 装備状況のCSSクラス取得
        function getEquipmentStatusClass(status) {
            switch (status) {
                case '未取得': return 'not-acquired';
                case '取得済み': return 'acquired';
                case '断章交換': return 'tome-exchange';
                case '断章交換・箱取得済': return 'tome-exchange-completed';
                default: return 'not-acquired';
            }
        }
        
        // 装備状況の更新
        function updateEquipmentStatus(selectElement) {
            const position = selectElement.dataset.position;
            const slot = selectElement.dataset.slot;
            const status = selectElement.value;
            const slotDiv = selectElement.closest('.slot-col');
            
            // 既存のクラスを削除
            slotDiv.classList.remove('not-acquired', 'acquired', 'tome-exchange', 'tome-exchange-completed');
            
            // 新しいクラスを追加
            const statusClass = getEquipmentStatusClass(status);
            slotDiv.classList.add(statusClass);
        }
        
        // 統計情報の変更を保存
        async function saveStatisticsChanges() {
            const selectors = document.querySelectorAll('select[data-position][data-slot]');
            const currentAllocations = appData.allocations[currentRaidTier.id] || [];
            const newAllocations = [];
            
            // 既存の分配データから編集対象以外のデータを保持
            const editedSlots = new Set();
            selectors.forEach(selector => {
                const key = `${selector.dataset.position}-${selector.dataset.slot}`;
                editedSlots.add(key);
            });
            
            // 編集対象外の分配データを保持
            currentAllocations.forEach(allocation => {
                const key = `${allocation.position}-${allocation.slot}`;
                if (!editedSlots.has(key)) {
                    newAllocations.push(allocation);
                }
            });
            
            // 選択された項目を分配データとして追加
            selectors.forEach(selector => {
                const position = selector.dataset.position;
                const slot = selector.dataset.slot;
                const status = selector.value;
                
                // 「未取得」以外の場合のみ分配データとして追加
                if (status !== '未取得') {
                    // 既存の分配データがない場合のみ追加
                    const existingAllocation = newAllocations.find(alloc => 
                        alloc.position === position && alloc.slot === slot
                    );
                    
                    if (!existingAllocation) {
                        newAllocations.push({
                            position: position,
                            slot: slot,
                            status: status, // 装備状況を追加
                            week: 'Manual', // 手動編集であることを示す
                            layer: 'Manual', // 手動編集であることを示す
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            });
            
            // データを保存
            appData.allocations[currentRaidTier.id] = newAllocations;
            
            try {
                await saveDataToSupabase('allocations', appData.allocations[currentRaidTier.id]);
                showSuccess('統計情報の変更を保存しました。');
                
                // 統計画面に戻る
                setTimeout(() => {
                    showStatistics();
                }, 1500);
            } catch (error) {
                console.error('統計情報保存エラー:', error);
                showError('統計情報の保存に失敗しました: ' + error.message);
            }
        }
        
        // 分配履歴表示
        function showAllocationHistory() {
            const content = document.getElementById('content');
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            content.innerHTML = `
                <div class="navigation-top-left">
                    <button class="nav-button" onclick="showTierDashboard()">レイドダッシュボードに戻る</button>
                </div>
                
                <h1>分配履歴</h1>
                <h2>${currentRaidTier.name}</h2>
                
                <div class="section">
                    <h3>フィルター</h3>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>層:</label>
                            <select id="layerFilter" onchange="filterAllocationHistory()">
                                <option value="">全て</option>
                                <option value="1">1層</option>
                                <option value="2">2層</option>
                                <option value="3">3層</option>
                                <option value="4">4層</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>取得者:</label>
                            <select id="playerFilter" onchange="filterAllocationHistory()">
                                <option value="">全て</option>
                                ${Object.entries(players).map(([position, player]) => `
                                    <option value="${position}">${player.name} (${position})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>装備部位:</label>
                            <select id="slotFilter" onchange="filterAllocationHistory()">
                                <option value="">全て</option>
                                <option value="武器">武器</option>
                                <option value="頭">頭</option>
                                <option value="胴">胴</option>
                                <option value="手">手</option>
                                <option value="脚">脚</option>
                                <option value="足">足</option>
                                <option value="耳">耳</option>
                                <option value="首">首</option>
                                <option value="腕">腕</option>
                                <option value="指">指</option>
                                <option value="武器石">武器石</option>
                                <option value="硬化薬">硬化薬</option>
                                <option value="強化薬">強化薬</option>
                                <option value="強化繊維">強化繊維</option>
                            </select>
                        </div>
                        
                        <button onclick="clearAllFilters()" class="clear-filters-btn">
                            フィルタークリア
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>分配履歴 (${allocations.length}件)</h3>
                    <div id="historyTable">
                        ${generateHistoryTable(allocations, players)}
                    </div>
                </div>
            `;
        }
        
        // 履歴テーブル生成
        function generateHistoryTable(allocations, players) {
            if (allocations.length === 0) {
                return '<p class="no-data">分配履歴がありません。</p>';
            }
            
            // 日付順で降順ソート
            const sortedAllocations = allocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            return `
                <div class="history-table">
                    <div class="history-header">
                        <div class="history-cell">日時</div>
                        <div class="history-cell">層</div>
                        <div class="history-cell">装備部位</div>
                        <div class="history-cell">取得者</div>
                    </div>
                    ${sortedAllocations.map(allocation => {
                        const player = players[allocation.position];
                        const date = new Date(allocation.timestamp);
                        return `
                            <div class="history-row">
                                <div class="history-cell">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
                                <div class="history-cell">${allocation.layer}層</div>
                                <div class="history-cell">${allocation.slot}</div>
                                <div class="history-cell">${player ? player.name : allocation.playerName} (${allocation.position})</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // 履歴フィルタリング
        function filterAllocationHistory() {
            const layerFilter = document.getElementById('layerFilter').value;
            const playerFilter = document.getElementById('playerFilter').value;
            const slotFilter = document.getElementById('slotFilter').value;
            
            const allocations = appData.allocations[currentRaidTier.id] || [];
            const players = appData.players[currentRaidTier.id] || {};
            
            let filteredAllocations = allocations.filter(allocation => {
                if (layerFilter && allocation.layer.toString() !== layerFilter) return false;
                if (playerFilter && allocation.position !== playerFilter) return false;
                if (slotFilter && allocation.slot !== slotFilter) return false;
                return true;
            });
            
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = generateHistoryTable(filteredAllocations, players);
            
            // フィルター結果の件数を更新
            const sectionTitle = document.querySelector('h3');
            sectionTitle.textContent = `分配履歴 (${filteredAllocations.length}件)`;
        }
        
        // 全フィルタークリア
        function clearAllFilters() {
            document.getElementById('layerFilter').value = '';
            document.getElementById('playerFilter').value = '';
            document.getElementById('slotFilter').value = '';
            filterAllocationHistory();
        }
        
        function showSystemSettings() {
            showMessage('システム設定機能は実装中です', 'info');
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ff14_raid_data_${currentTeamId}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSuccess('データをエクスポートしました');
        }
        
        // セキュリティ質問選択時の動作
        document.addEventListener('DOMContentLoaded', function() {
            const securityQuestionSelect = document.getElementById('signupSecurityQuestionSelect');
            const customQuestionInput = document.getElementById('signupCustomQuestionInput');
            
            if (securityQuestionSelect && customQuestionInput) {
                securityQuestionSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customQuestionInput.style.display = 'block';
                        customQuestionInput.focus();
                    } else {
                        customQuestionInput.style.display = 'none';
                        customQuestionInput.value = '';
                    }
                });
            }
        });
    </script>
</body>
</html>アップデート確認用のコメント
